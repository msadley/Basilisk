let Jl=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},J8=class extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}},Ex=class extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};class Cn extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){const t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let s=this.#e.get(e);s==null&&(s=[],this.#e.set(e,s)),s.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let s=this.#e.get(e);s!=null&&(s=s.filter(({callback:i})=>i!==t),this.#e.set(e,s))}dispatchEvent(e){const t=super.dispatchEvent(e);let n=this.#e.get(e.type);return n==null||(n=n.filter(({once:s})=>!s),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}}function vx(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function yh(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function xx(r){return new TextEncoder().encode(r)}function Sx(r){return new TextDecoder().decode(r)}function Ax(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),h=Math.log(256)/Math.log(a);function f(_){if(_ instanceof Uint8Array||(ArrayBuffer.isView(_)?_=new Uint8Array(_.buffer,_.byteOffset,_.byteLength):Array.isArray(_)&&(_=Uint8Array.from(_))),!(_ instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(_.length===0)return"";for(var R=0,T=0,A=0,D=_.length;A!==D&&_[A]===0;)A++,R++;for(var I=(D-A)*h+1>>>0,q=new Uint8Array(I);A!==D;){for(var L=_[A],z=0,Y=I-1;(L!==0||z<T)&&Y!==-1;Y--,z++)L+=256*q[Y]>>>0,q[Y]=L%a>>>0,L=L/a>>>0;if(L!==0)throw new Error("Non-zero carry");T=z,A++}for(var k=I-T;k!==I&&q[k]===0;)k++;for(var x=c.repeat(R);k<I;++k)x+=r.charAt(q[k]);return x}function p(_){if(typeof _!="string")throw new TypeError("Expected String");if(_.length===0)return new Uint8Array;var R=0;if(_[R]!==" "){for(var T=0,A=0;_[R]===c;)T++,R++;for(var D=(_.length-R)*l+1>>>0,I=new Uint8Array(D);_[R];){var q=t[_.charCodeAt(R)];if(q===255)return;for(var L=0,z=D-1;(q!==0||L<A)&&z!==-1;z--,L++)q+=a*I[z]>>>0,I[z]=q%256>>>0,q=q/256>>>0;if(q!==0)throw new Error("Non-zero carry");A=L,R++}if(_[R]!==" "){for(var Y=D-A;Y!==D&&I[Y]===0;)Y++;for(var k=new Uint8Array(T+(D-Y)),x=T;Y!==D;)k[x++]=I[Y++];return k}}}function m(_){var R=p(_);if(R)return R;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:p,decode:m}}var Ix=Ax,Tx=Ix;class kx{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}let Cx=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){this.name=e,this.prefix=t;const s=t.codePointAt(0);if(s===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return ey(this,e)}};class Rx{decoders;constructor(e){this.decoders=e}or(e){return ey(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function ey(r,e){return new Rx({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}class Px{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new kx(e,t,n),this.decoder=new Cx(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function bh({name:r,prefix:e,encode:t,decode:n}){return new Px(r,e,t,n)}function eu({name:r,prefix:e,alphabet:t}){const{encode:n,decode:s}=Tx(t,r);return bh({prefix:e,name:r,encode:n,decode:i=>yh(s(i))})}function Dx(r,e,t,n){let s=r.length;for(;r[s-1]==="=";)--s;const i=new Uint8Array(s*t/8|0);let o=0,a=0,c=0;for(let l=0;l<s;++l){const h=e[r[l]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);a=a<<t|h,o+=t,o>=8&&(o-=8,i[c++]=255&a>>o)}if(o>=t||(255&a<<8-o)!==0)throw new SyntaxError("Unexpected end of data");return i}function qx(r,e,t){const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o!==0&&(i+=e[s&a<<t-o]),n)for(;(i.length*t&7)!==0;)i+="=";return i}function Bx(r){const e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function Pn({name:r,prefix:e,bitsPerChar:t,alphabet:n}){const s=Bx(n);return bh({prefix:e,name:r,encode(i){return qx(i,n,t)},decode(i){return Dx(i,s,t,r)}})}const dt=eu({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Lx=eu({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Ox=Object.freeze({__proto__:null,base58btc:dt,base58flickr:Lx});const Ci=Pn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),$x=Pn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Mx=Pn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Nx=Pn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Ux=Pn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Fx=Pn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Hx=Pn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Vx=Pn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Kx=Pn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var zx=Object.freeze({__proto__:null,base32:Ci,base32hex:Ux,base32hexpad:Hx,base32hexpadupper:Vx,base32hexupper:Fx,base32pad:Mx,base32padupper:Nx,base32upper:$x,base32z:Kx});const Hf=eu({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Wx=eu({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var Gx=Object.freeze({__proto__:null,base36:Hf,base36upper:Wx}),Zx=ty,Am=128,jx=-128,Yx=Math.pow(2,31);function ty(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Yx;)e[t++]=r&255|Am,r/=128;for(;r&jx;)e[t++]=r&255|Am,r>>>=7;return e[t]=r|0,ty.bytes=t-n+1,e}var Qx=k2,Xx=128,Im=127;function k2(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw k2.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Im)<<s:(o&Im)*Math.pow(2,s),s+=7}while(o>=Xx);return k2.bytes=i-n,t}var Jx=Math.pow(2,7),eS=Math.pow(2,14),tS=Math.pow(2,21),nS=Math.pow(2,28),rS=Math.pow(2,35),sS=Math.pow(2,42),iS=Math.pow(2,49),oS=Math.pow(2,56),aS=Math.pow(2,63),cS=function(r){return r<Jx?1:r<eS?2:r<tS?3:r<nS?4:r<rS?5:r<sS?6:r<iS?7:r<oS?8:r<aS?9:10},lS={encode:Zx,decode:Qx,encodingLength:cS},Jf=lS;function C2(r,e=0){return[Jf.decode(r,e),Jf.decode.bytes]}function ed(r,e,t=0){return Jf.encode(r,e,t),e}function td(r){return Jf.encodingLength(r)}function Ms(r,e){const t=e.byteLength,n=td(r),s=n+td(t),i=new Uint8Array(s+t);return ed(r,i,0),ed(t,i,n),i.set(e,s),new bp(r,t,e,i)}function Gn(r){const e=yh(r),[t,n]=C2(e),[s,i]=C2(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new bp(t,s,o,e)}function uS(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&vx(r.bytes,t.bytes)}}class bp{code;size;digest;bytes;constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}}function Tm(r,e){const{bytes:t,version:n}=r;return n===0?dS(t,R2(r),e??dt.encoder):hS(t,R2(r),e??Ci.encoder)}const km=new WeakMap;function R2(r){const e=km.get(r);if(e==null){const t=new Map;return km.set(r,t),t}return e}class nt{code;version;multihash;bytes;"/";constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Ic)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==pS)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return nt.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Ms(e,t);return nt.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return nt.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&uS(e.multihash,n.multihash)}toString(e){return Tm(this,e)}toJSON(){return{"/":Tm(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof nt)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new nt(n,s,i,o??Cm(n,s,i.bytes))}else if(t[gS]===!0){const{version:n,multihash:s,code:i}=t,o=Gn(s);return nt.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Ic)throw new Error(`Version 0 CID must use dag-pb (code: ${Ic}) block encoding`);return new nt(e,t,n,n.bytes)}case 1:{const s=Cm(e,t,n.bytes);return new nt(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return nt.create(0,Ic,e)}static createV1(e,t){return nt.create(1,e,t)}static decode(e){const[t,n]=nt.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=nt.inspectBytes(e),n=t.size-t.multihashSize,s=yh(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new bp(t.multihashCode,t.digestSize,i,s);return[t.version===0?nt.createV0(o):nt.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[f,p]=C2(e.subarray(t));return t+=p,f};let s=n(),i=Ic;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),l=t+c,h=l-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:h,size:l}}static parse(e,t){const[n,s]=fS(e,t),i=nt.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return R2(i).set(n,e),i}}function fS(r,e){switch(r[0]){case"Q":{const t=e??dt;return[dt.prefix,t.decode(`${dt.prefix}${r}`)]}case dt.prefix:{const t=e??dt;return[dt.prefix,t.decode(r)]}case Ci.prefix:{const t=e??Ci;return[Ci.prefix,t.decode(r)]}case Hf.prefix:{const t=e??Hf;return[Hf.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function dS(r,e,t){const{prefix:n}=t;if(n!==dt.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s}function hS(r,e,t){const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s}const Ic=112,pS=18;function Cm(r,e,t){const n=td(r),s=n+td(e),i=new Uint8Array(s+t.byteLength);return ed(r,i,0),ed(e,i,n),i.set(t,s),i}const gS=Symbol.for("@ipld/js-cid/CID"),ny=0,mS="identity",ry=yh;function yS(r,e){if(e?.truncate!=null&&e.truncate!==r.byteLength){if(e.truncate<0||e.truncate>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,e.truncate)}return Ms(ny,ry(r))}const Kt={code:ny,name:mS,encode:ry,digest:yS};function at(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function St(r=0){return new Uint8Array(r)}function Tr(r=0){return new Uint8Array(r)}function is(r,e){e==null&&(e=r.reduce((s,i)=>s+i.length,0));const t=Tr(e);let n=0;for(const s of r)t.set(s,n),n+=s.length;return t}const sy=Symbol.for("@achingbrain/uint8arraylist");function Rm(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(const n of r){const s=t+n.byteLength;if(e<s)return{buf:n,index:e-t};t=s}throw new RangeError("index is out of bounds")}function Nu(r){return!!r?.[sy]}class Ue{bufs;length;[sy]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(Nu(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(Nu(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){const t=Rm(this.bufs,e);return t.buf[t.index]}set(e,t){const n=Rm(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(Nu(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){const{bufs:n,length:s}=this._subList(e,t);return is(n,s)}subarray(e,t){const{bufs:n,length:s}=this._subList(e,t);return n.length===1?n[0]:is(n,s)}sublist(e,t){const{bufs:n,length:s}=this._subList(e,t),i=new Ue;return i.length=s,i.bufs=[...n],i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};const n=[];let s=0;for(let i=0;i<this.bufs.length;i++){const o=this.bufs[i],a=s,c=a+o.byteLength;if(s=c,e>=c)continue;const l=e>=a&&e<c,h=t>a&&t<=c;if(l&&h){if(e===a&&t===c){n.push(o);break}const f=e-a;n.push(o.subarray(f,f+(t-e)));break}if(l){if(e===0){n.push(o);continue}n.push(o.subarray(e-a));continue}if(h){if(t===c){n.push(o);break}n.push(o.subarray(0,t-a));break}n.push(o)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!Nu(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const s=n.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");const i=256,o=new Int32Array(i);for(let f=0;f<i;f++)o[f]=-1;for(let f=0;f<s;f++)o[n[f]]=f;const a=o,c=this.byteLength-n.byteLength,l=n.byteLength-1;let h;for(let f=t;f<=c;f+=h){h=0;for(let p=l;p>=0;p--){const m=this.get(f+p);if(n[p]!==m){h=Math.max(1,p-a[m]);break}}if(h===0)return f}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const n=Tr(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){const s=St(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,n),this.write(s,e)}getInt32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){const s=St(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,n),this.write(s,e)}getBigInt64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){const s=St(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,n),this.write(s,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const n=Tr(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){const s=St(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,n),this.write(s,e)}getUint32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){const s=St(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,n),this.write(s,e)}getBigUint64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){const s=St(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,n),this.write(s,e)}getFloat32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){const s=St(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,n),this.write(s,e)}getFloat64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){const s=St(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,n),this.write(s,e)}equals(e){if(e==null||!(e instanceof Ue)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!at(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const n=new Ue;return n.bufs=e,t==null&&(t=e.reduce((s,i)=>s+i.byteLength,0)),n.length=t,n}}const bS=eu({prefix:"9",name:"base10",alphabet:"0123456789"});var wS=Object.freeze({__proto__:null,base10:bS});const _S=Pn({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),ES=Pn({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var vS=Object.freeze({__proto__:null,base16:_S,base16upper:ES});const xS=Pn({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var SS=Object.freeze({__proto__:null,base2:xS});const iy=Array.from("ðŸš€ðŸªâ˜„ðŸ›°ðŸŒŒðŸŒ‘ðŸŒ’ðŸŒ“ðŸŒ”ðŸŒ•ðŸŒ–ðŸŒ—ðŸŒ˜ðŸŒðŸŒðŸŒŽðŸ‰â˜€ðŸ’»ðŸ–¥ðŸ’¾ðŸ’¿ðŸ˜‚â¤ðŸ˜ðŸ¤£ðŸ˜ŠðŸ™ðŸ’•ðŸ˜­ðŸ˜˜ðŸ‘ðŸ˜…ðŸ‘ðŸ˜ðŸ”¥ðŸ¥°ðŸ’”ðŸ’–ðŸ’™ðŸ˜¢ðŸ¤”ðŸ˜†ðŸ™„ðŸ’ªðŸ˜‰â˜ºðŸ‘ŒðŸ¤—ðŸ’œðŸ˜”ðŸ˜ŽðŸ˜‡ðŸŒ¹ðŸ¤¦ðŸŽ‰ðŸ’žâœŒâœ¨ðŸ¤·ðŸ˜±ðŸ˜ŒðŸŒ¸ðŸ™ŒðŸ˜‹ðŸ’—ðŸ’šðŸ˜ðŸ’›ðŸ™‚ðŸ’“ðŸ¤©ðŸ˜„ðŸ˜€ðŸ–¤ðŸ˜ƒðŸ’¯ðŸ™ˆðŸ‘‡ðŸŽ¶ðŸ˜’ðŸ¤­â£ðŸ˜œðŸ’‹ðŸ‘€ðŸ˜ªðŸ˜‘ðŸ’¥ðŸ™‹ðŸ˜žðŸ˜©ðŸ˜¡ðŸ¤ªðŸ‘ŠðŸ¥³ðŸ˜¥ðŸ¤¤ðŸ‘‰ðŸ’ƒðŸ˜³âœ‹ðŸ˜šðŸ˜ðŸ˜´ðŸŒŸðŸ˜¬ðŸ™ƒðŸ€ðŸŒ·ðŸ˜»ðŸ˜“â­âœ…ðŸ¥ºðŸŒˆðŸ˜ˆðŸ¤˜ðŸ’¦âœ”ðŸ˜£ðŸƒðŸ’â˜¹ðŸŽŠðŸ’˜ðŸ˜ â˜ðŸ˜•ðŸŒºðŸŽ‚ðŸŒ»ðŸ˜ðŸ–•ðŸ’ðŸ™ŠðŸ˜¹ðŸ—£ðŸ’«ðŸ’€ðŸ‘‘ðŸŽµðŸ¤žðŸ˜›ðŸ”´ðŸ˜¤ðŸŒ¼ðŸ˜«âš½ðŸ¤™â˜•ðŸ†ðŸ¤«ðŸ‘ˆðŸ˜®ðŸ™†ðŸ»ðŸƒðŸ¶ðŸ’ðŸ˜²ðŸŒ¿ðŸ§¡ðŸŽâš¡ðŸŒžðŸŽˆâŒâœŠðŸ‘‹ðŸ˜°ðŸ¤¨ðŸ˜¶ðŸ¤ðŸš¶ðŸ’°ðŸ“ðŸ’¢ðŸ¤ŸðŸ™ðŸš¨ðŸ’¨ðŸ¤¬âœˆðŸŽ€ðŸºðŸ¤“ðŸ˜™ðŸ’ŸðŸŒ±ðŸ˜–ðŸ‘¶ðŸ¥´â–¶âž¡â“ðŸ’ŽðŸ’¸â¬‡ðŸ˜¨ðŸŒšðŸ¦‹ðŸ˜·ðŸ•ºâš ðŸ™…ðŸ˜ŸðŸ˜µðŸ‘ŽðŸ¤²ðŸ¤ ðŸ¤§ðŸ“ŒðŸ”µðŸ’…ðŸ§ðŸ¾ðŸ’ðŸ˜—ðŸ¤‘ðŸŒŠðŸ¤¯ðŸ·â˜ŽðŸ’§ðŸ˜¯ðŸ’†ðŸ‘†ðŸŽ¤ðŸ™‡ðŸ‘â„ðŸŒ´ðŸ’£ðŸ¸ðŸ’ŒðŸ“ðŸ¥€ðŸ¤¢ðŸ‘…ðŸ’¡ðŸ’©ðŸ‘ðŸ“¸ðŸ‘»ðŸ¤ðŸ¤®ðŸŽ¼ðŸ¥µðŸš©ðŸŽðŸŠðŸ‘¼ðŸ’ðŸ“£ðŸ¥‚"),AS=iy.reduce((r,e,t)=>(r[t]=e,r),[]),IS=iy.reduce((r,e,t)=>{const n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function TS(r){return r.reduce((e,t)=>(e+=AS[t],e),"")}function kS(r){const e=[];for(const t of r){const n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);const s=IS[n];if(s==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(s)}return new Uint8Array(e)}const CS=bh({prefix:"ðŸš€",name:"base256emoji",encode:TS,decode:kS});var RS=Object.freeze({__proto__:null,base256emoji:CS});const oy=Pn({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),PS=Pn({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),ay=Pn({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),DS=Pn({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var qS=Object.freeze({__proto__:null,base64:oy,base64pad:PS,base64url:ay,base64urlpad:DS});const BS=Pn({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var LS=Object.freeze({__proto__:null,base8:BS});const OS=bh({prefix:"\0",name:"identity",encode:r=>Sx(r),decode:r=>xx(r)});var $S=Object.freeze({__proto__:null,identity:OS});new TextEncoder;new TextDecoder;const MS=85,NS=20;function US({name:r,code:e,encode:t,minDigestLength:n,maxDigestLength:s}){return new FS(r,e,t,n,s)}class FS{name;code;encode;minDigestLength;maxDigestLength;constructor(e,t,n,s,i){this.name=e,this.code=t,this.encode=n,this.minDigestLength=s??NS,this.maxDigestLength=i}digest(e,t){if(t?.truncate!=null){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(this.maxDigestLength!=null&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){const n=this.encode(e);return n instanceof Uint8Array?Pm(n,this.code,t?.truncate):n.then(s=>Pm(s,this.code,t?.truncate))}else throw Error("Unknown type, must be binary type")}}function Pm(r,e,t){if(t!=null&&t!==r.byteLength){if(t>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,t)}return Ms(e,r)}function HS(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const $r=US({name:"sha2-256",code:18,encode:HS("SHA-256")}),P2={...$S,...SS,...LS,...wS,...vS,...zx,...Gx,...Ox,...qS,...RS};function cy(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}const Dm=cy("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),E1=cy("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);const e=Tr(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),ly={utf8:Dm,"utf-8":Dm,hex:P2.base16,latin1:E1,ascii:E1,binary:E1,...P2};function Ge(r,e="utf8"){const t=ly[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}function Le(r,e="utf8"){const t=ly[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}const VS=parseInt("11111",2),D2=parseInt("10000000",2),KS=parseInt("01111111",2),qm={0:Tc,1:Tc,2:zS,3:ZS,4:jS,5:GS,6:WS,16:Tc,22:Tc,48:Tc};function wh(r,e={offset:0}){const t=r[e.offset]&VS;if(e.offset++,qm[t]!=null)return qm[t](r,e);throw new Error("No decoder for tag "+t)}function tu(r,e){let t=0;if((r[e.offset]&D2)===D2){const n=r[e.offset]&KS;let s="0x";e.offset++;for(let i=0;i<n;i++,e.offset++)s+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=r[e.offset],e.offset++;return t}function Tc(r,e){tu(r,e);const t=[];for(;!(e.offset>=r.byteLength);){const n=wh(r,e);if(n===null)break;t.push(n)}return t}function zS(r,e){const t=tu(r,e),n=e.offset,s=e.offset+t,i=[];for(let o=n;o<s;o++)o===n&&r[o]===0||i.push(r[o]);return e.offset+=t,Uint8Array.from(i)}function WS(r,e){const t=tu(r,e),n=e.offset+t,s=r[e.offset];e.offset++;let i=0,o=0;s<40?(i=0,o=s):s<80?(i=1,o=s-40):(i=2,o=s-80);let a=`${i}.${o}`,c=[];for(;e.offset<n;){const l=r[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let h=0;for(let f=0;f<c.length;f++)h+=c[f]<<f*7;a+=`.${h}`,c=[]}}return a}function GS(r,e){return e.offset++,null}function ZS(r,e){const t=tu(r,e),n=r[e.offset];e.offset++;const s=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function jS(r,e){const t=tu(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function YS(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);const t=new Ue;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function wp(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);const e=YS(r.byteLength);return new Ue(Uint8Array.from([e.byteLength|D2]),e)}function q2(r){const e=new Ue,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Ue(Uint8Array.from([2]),wp(e),e)}function uy(r){const e=Uint8Array.from([0]),t=new Ue(e,r);return new Ue(Uint8Array.from([3]),wp(t),t)}function zc(r,e=48){const t=new Ue;for(const n of r)t.append(n);return new Ue(Uint8Array.from([e]),wp(t),t)}async function QS(r,e,t,n){const s=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();const i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return n?.signal?.throwIfAborted(),i}const XS=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),JS=Uint8Array.from([6,5,43,129,4,0,34]),eA=Uint8Array.from([6,5,43,129,4,0,35]),tA={ext:!0,kty:"EC",crv:"P-256"},nA={ext:!0,kty:"EC",crv:"P-384"},rA={ext:!0,kty:"EC",crv:"P-521"},v1=32,x1=48,S1=66;function sA(r){const e=wh(r);return iA(e)}function iA(r){const e=r[1][1][0],t=1;let n,s;if(e.byteLength===v1*2+1)return n=Le(e.subarray(t,t+v1),"base64url"),s=Le(e.subarray(t+v1),"base64url"),new A1({...tA,key_ops:["verify"],x:n,y:s});if(e.byteLength===x1*2+1)return n=Le(e.subarray(t,t+x1),"base64url"),s=Le(e.subarray(t+x1),"base64url"),new A1({...nA,key_ops:["verify"],x:n,y:s});if(e.byteLength===S1*2+1)return n=Le(e.subarray(t,t+S1),"base64url"),s=Le(e.subarray(t+S1),"base64url"),new A1({...rA,key_ops:["verify"],x:n,y:s});throw new Jl(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function oA(r){return zc([q2(Uint8Array.from([1])),zc([aA(r.crv)],160),zc([uy(new Ue(Uint8Array.from([4]),Ge(r.x??"","base64url"),Ge(r.y??"","base64url")))],161)]).subarray()}function aA(r){if(r==="P-256")return XS;if(r==="P-384")return JS;if(r==="P-521")return eA;throw new Jl(`Invalid curve ${r}`)}let A1=class{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=oA(this.jwk)),this._raw}toMultihash(){return Kt.digest(Lp(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}async verify(e,t,n){return QS(this.jwk,t,e,n)}};function _h(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function go(r,e=""){if(!Number.isSafeInteger(r)||r<0){const t=e&&`"${e}" `;throw new Error(`${t}expected integer >= 0, got ${r}`)}}function bt(r,e,t=""){const n=_h(r),s=r?.length,i=e!==void 0;if(!n||i&&s!==e){const o=t&&`"${t}" `,a=i?` of length ${e}`:"",c=n?`length=${s}`:`type=${typeof r}`;throw new Error(o+"expected Uint8Array"+a+", got "+c)}return r}function fy(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash must wrapped by utils.createHasher");go(r.outputLen),go(r.blockLen)}function nd(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function cA(r,e){bt(r,void 0,"digestInto() output");const t=e.outputLen;if(r.length<t)throw new Error('"digestInto() output" expected to be of length >='+t)}function Oa(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function I1(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function Nr(r,e){return r<<32-e|r>>>e}const dy=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",lA=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function nu(r){if(bt(r),dy)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=lA[r[t]];return e}const cs={_0:48,_9:57,A:65,F:70,a:97,f:102};function Bm(r){if(r>=cs._0&&r<=cs._9)return r-cs._0;if(r>=cs.A&&r<=cs.F)return r-(cs.A-10);if(r>=cs.a&&r<=cs.f)return r-(cs.a-10)}function hl(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(dy)return Uint8Array.fromHex(r);const e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(t);for(let s=0,i=0;s<t;s++,i+=2){const o=Bm(r.charCodeAt(i)),a=Bm(r.charCodeAt(i+1));if(o===void 0||a===void 0){const c=r[i]+r[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[s]=o*16+a}return n}function Yr(...r){let e=0;for(let n=0;n<r.length;n++){const s=r[n];bt(s),e+=s.length}const t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){const i=r[n];t.set(i,s),s+=i.length}return t}function hy(r,e={}){const t=(s,i)=>r(i).update(s).digest(),n=r(void 0);return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=s=>r(s),Object.assign(t,e),Object.freeze(t)}function Eh(r=32){const e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}const py=r=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,r])});function uA(r,e,t){return r&e^~r&t}function fA(r,e,t){return r&e^r&t^e&t}let gy=class{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(e,t,n,s){this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=I1(this.buffer)}update(e){nd(this),bt(e);const{view:t,buffer:n,blockLen:s}=this,i=e.length;for(let o=0;o<i;){const a=Math.min(s-this.pos,i-o);if(a===s){const c=I1(e);for(;s<=i-o;o+=s)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){nd(this),cA(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:s,isLE:i}=this;let{pos:o}=this;t[o++]=128,Oa(this.buffer.subarray(o)),this.padOffset>s-o&&(this.process(n,0),o=0);for(let f=o;f<s;f++)t[f]=0;n.setBigUint64(s-8,BigInt(this.length*8),i),this.process(n,0);const a=I1(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");const l=c/4,h=this.get();if(l>h.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<l;f++)a.setUint32(4*f,h[f],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||=new this.constructor,e.set(...this.get());const{blockLen:t,buffer:n,length:s,finished:i,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=i,e.length=s,e.pos=a,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}};const Us=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Dn=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),Uu=BigInt(2**32-1),Lm=BigInt(32);function dA(r,e=!1){return e?{h:Number(r&Uu),l:Number(r>>Lm&Uu)}:{h:Number(r>>Lm&Uu)|0,l:Number(r&Uu)|0}}function hA(r,e=!1){const t=r.length;let n=new Uint32Array(t),s=new Uint32Array(t);for(let i=0;i<t;i++){const{h:o,l:a}=dA(r[i],e);[n[i],s[i]]=[o,a]}return[n,s]}const Om=(r,e,t)=>r>>>t,$m=(r,e,t)=>r<<32-t|e>>>t,Zo=(r,e,t)=>r>>>t|e<<32-t,jo=(r,e,t)=>r<<32-t|e>>>t,Fu=(r,e,t)=>r<<64-t|e>>>t-32,Hu=(r,e,t)=>r>>>t-32|e<<64-t;function ls(r,e,t,n){const s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}const pA=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),gA=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,mA=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),yA=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,bA=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),wA=(r,e,t,n,s,i)=>e+t+n+s+i+(r/2**32|0)|0,_A=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Fs=new Uint32Array(64);let EA=class extends gy{constructor(e){super(64,e,8,!1)}get(){const{A:e,B:t,C:n,D:s,E:i,F:o,G:a,H:c}=this;return[e,t,n,s,i,o,a,c]}set(e,t,n,s,i,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let f=0;f<16;f++,t+=4)Fs[f]=e.getUint32(t,!1);for(let f=16;f<64;f++){const p=Fs[f-15],m=Fs[f-2],_=Nr(p,7)^Nr(p,18)^p>>>3,R=Nr(m,17)^Nr(m,19)^m>>>10;Fs[f]=R+Fs[f-7]+_+Fs[f-16]|0}let{A:n,B:s,C:i,D:o,E:a,F:c,G:l,H:h}=this;for(let f=0;f<64;f++){const p=Nr(a,6)^Nr(a,11)^Nr(a,25),m=h+p+uA(a,c,l)+_A[f]+Fs[f]|0,R=(Nr(n,2)^Nr(n,13)^Nr(n,22))+fA(n,s,i)|0;h=l,l=c,c=a,a=o+m|0,o=i,i=s,s=n,n=m+R|0}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,h=h+this.H|0,this.set(n,s,i,o,a,c,l,h)}roundClean(){Oa(Fs)}destroy(){this.set(0,0,0,0,0,0,0,0),Oa(this.buffer)}},vA=class extends EA{A=Us[0]|0;B=Us[1]|0;C=Us[2]|0;D=Us[3]|0;E=Us[4]|0;F=Us[5]|0;G=Us[6]|0;H=Us[7]|0;constructor(){super(32)}};const my=hA(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),xA=my[0],SA=my[1],Hs=new Uint32Array(80),Vs=new Uint32Array(80);let AA=class extends gy{constructor(e){super(128,e,16,!1)}get(){const{Ah:e,Al:t,Bh:n,Bl:s,Ch:i,Cl:o,Dh:a,Dl:c,Eh:l,El:h,Fh:f,Fl:p,Gh:m,Gl:_,Hh:R,Hl:T}=this;return[e,t,n,s,i,o,a,c,l,h,f,p,m,_,R,T]}set(e,t,n,s,i,o,a,c,l,h,f,p,m,_,R,T){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=h|0,this.Fh=f|0,this.Fl=p|0,this.Gh=m|0,this.Gl=_|0,this.Hh=R|0,this.Hl=T|0}process(e,t){for(let I=0;I<16;I++,t+=4)Hs[I]=e.getUint32(t),Vs[I]=e.getUint32(t+=4);for(let I=16;I<80;I++){const q=Hs[I-15]|0,L=Vs[I-15]|0,z=Zo(q,L,1)^Zo(q,L,8)^Om(q,L,7),Y=jo(q,L,1)^jo(q,L,8)^$m(q,L,7),k=Hs[I-2]|0,x=Vs[I-2]|0,F=Zo(k,x,19)^Fu(k,x,61)^Om(k,x,6),j=jo(k,x,19)^Hu(k,x,61)^$m(k,x,6),U=mA(Y,j,Vs[I-7],Vs[I-16]),y=yA(U,z,F,Hs[I-7],Hs[I-16]);Hs[I]=y|0,Vs[I]=U|0}let{Ah:n,Al:s,Bh:i,Bl:o,Ch:a,Cl:c,Dh:l,Dl:h,Eh:f,El:p,Fh:m,Fl:_,Gh:R,Gl:T,Hh:A,Hl:D}=this;for(let I=0;I<80;I++){const q=Zo(f,p,14)^Zo(f,p,18)^Fu(f,p,41),L=jo(f,p,14)^jo(f,p,18)^Hu(f,p,41),z=f&m^~f&R,Y=p&_^~p&T,k=bA(D,L,Y,SA[I],Vs[I]),x=wA(k,A,q,z,xA[I],Hs[I]),F=k|0,j=Zo(n,s,28)^Fu(n,s,34)^Fu(n,s,39),U=jo(n,s,28)^Hu(n,s,34)^Hu(n,s,39),y=n&i^n&a^i&a,b=s&o^s&c^o&c;A=R|0,D=T|0,R=m|0,T=_|0,m=f|0,_=p|0,{h:f,l:p}=ls(l|0,h|0,x|0,F|0),l=a|0,h=c|0,a=i|0,c=o|0,i=n|0,o=s|0;const g=pA(F,U,b);n=gA(g,x,j,y),s=g|0}({h:n,l:s}=ls(this.Ah|0,this.Al|0,n|0,s|0)),{h:i,l:o}=ls(this.Bh|0,this.Bl|0,i|0,o|0),{h:a,l:c}=ls(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:h}=ls(this.Dh|0,this.Dl|0,l|0,h|0),{h:f,l:p}=ls(this.Eh|0,this.El|0,f|0,p|0),{h:m,l:_}=ls(this.Fh|0,this.Fl|0,m|0,_|0),{h:R,l:T}=ls(this.Gh|0,this.Gl|0,R|0,T|0),{h:A,l:D}=ls(this.Hh|0,this.Hl|0,A|0,D|0),this.set(n,s,i,o,a,c,l,h,f,p,m,_,R,T,A,D)}roundClean(){Oa(Hs,Vs)}destroy(){Oa(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},IA=class extends AA{Ah=Dn[0]|0;Al=Dn[1]|0;Bh=Dn[2]|0;Bl=Dn[3]|0;Ch=Dn[4]|0;Cl=Dn[5]|0;Dh=Dn[6]|0;Dl=Dn[7]|0;Eh=Dn[8]|0;El=Dn[9]|0;Fh=Dn[10]|0;Fl=Dn[11]|0;Gh=Dn[12]|0;Gl=Dn[13]|0;Hh=Dn[14]|0;Hl=Dn[15]|0;constructor(){super(64)}};const yy=hy(()=>new vA,py(1)),TA=hy(()=>new IA,py(3));const _p=BigInt(0),B2=BigInt(1);function mo(r,e=""){if(typeof r!="boolean"){const t=e&&`"${e}" `;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function by(r){if(typeof r=="bigint"){if(!Vf(r))throw new Error("positive bigint expected, got "+r)}else go(r);return r}function Vu(r){const e=by(r).toString(16);return e.length&1?"0"+e:e}function wy(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?_p:BigInt("0x"+r)}function vh(r){return wy(nu(r))}function pl(r){return wy(nu(L2(bt(r)).reverse()))}function Ep(r,e){go(e),r=by(r);const t=hl(r.toString(16).padStart(e*2,"0"));if(t.length!==e)throw new Error("number too large");return t}function _y(r,e){return Ep(r,e).reverse()}function L2(r){return Uint8Array.from(r)}const Vf=r=>typeof r=="bigint"&&_p<=r;function kA(r,e,t){return Vf(r)&&Vf(e)&&Vf(t)&&e<=r&&r<t}function O2(r,e,t,n){if(!kA(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function CA(r){let e;for(e=0;r>_p;r>>=B2,e+=1);return e}const vp=r=>(B2<<BigInt(r))-B2;function RA(r,e,t){if(go(r,"hashLen"),go(e,"qByteLen"),typeof t!="function")throw new Error("hmacFn must be a function");const n=T=>new Uint8Array(T),s=Uint8Array.of(),i=Uint8Array.of(0),o=Uint8Array.of(1),a=1e3;let c=n(r),l=n(r),h=0;const f=()=>{c.fill(1),l.fill(0),h=0},p=(...T)=>t(l,Yr(c,...T)),m=(T=s)=>{l=p(i,T),c=p(),T.length!==0&&(l=p(o,T),c=p())},_=()=>{if(h++>=a)throw new Error("drbg: tried max amount of iterations");let T=0;const A=[];for(;T<e;){c=p();const D=c.slice();A.push(D),T+=c.length}return Yr(...A)};return(T,A)=>{f(),m(T);let D;for(;!(D=A(_()));)m();return f(),D}}function ru(r,e={},t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(i,o,a){const c=r[i];if(a&&c===void 0)return;const l=typeof c;if(l!==o||c===null)throw new Error(`param "${i}" is invalid: expected ${o}, got ${l}`)}const s=(i,o)=>Object.entries(i).forEach(([a,c])=>n(a,c,o));s(e,!1),s(t,!0)}function rd(r){const e=new WeakMap;return(t,...n)=>{const s=e.get(t);if(s!==void 0)return s;const i=r(t,...n);return e.set(t,i),i}}const er=BigInt(0),vn=BigInt(1),Ki=BigInt(2),Ey=BigInt(3),vy=BigInt(4),xy=BigInt(5),PA=BigInt(7),Sy=BigInt(8),DA=BigInt(9),Ay=BigInt(16);function rn(r,e){const t=r%e;return t>=er?t:e+t}function zt(r,e,t){let n=r;for(;e-- >er;)n*=n,n%=t;return n}function Mm(r,e){if(r===er)throw new Error("invert: expected non-zero number");if(e<=er)throw new Error("invert: expected positive modulus, got "+e);let t=rn(r,e),n=e,s=er,i=vn;for(;t!==er;){const a=n/t,c=n%t,l=s-i*a;n=t,t=c,s=i,i=l}if(n!==vn)throw new Error("invert: does not exist");return rn(s,e)}function xp(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function Iy(r,e){const t=(r.ORDER+vn)/vy,n=r.pow(e,t);return xp(r,n,e),n}function qA(r,e){const t=(r.ORDER-xy)/Sy,n=r.mul(e,Ki),s=r.pow(n,t),i=r.mul(e,s),o=r.mul(r.mul(i,Ki),s),a=r.mul(i,r.sub(o,r.ONE));return xp(r,a,e),a}function BA(r){const e=xh(r),t=Ty(r),n=t(e,e.neg(e.ONE)),s=t(e,n),i=t(e,e.neg(n)),o=(r+PA)/Ay;return(a,c)=>{let l=a.pow(c,o),h=a.mul(l,n);const f=a.mul(l,s),p=a.mul(l,i),m=a.eql(a.sqr(h),c),_=a.eql(a.sqr(f),c);l=a.cmov(l,h,m),h=a.cmov(p,f,_);const R=a.eql(a.sqr(h),c),T=a.cmov(l,h,R);return xp(a,T,c),T}}function Ty(r){if(r<Ey)throw new Error("sqrt is not defined for small field");let e=r-vn,t=0;for(;e%Ki===er;)e/=Ki,t++;let n=Ki;const s=xh(r);for(;Nm(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return Iy;let i=s.pow(n,e);const o=(e+vn)/Ki;return function(c,l){if(c.is0(l))return l;if(Nm(c,l)!==1)throw new Error("Cannot find square root");let h=t,f=c.mul(c.ONE,i),p=c.pow(l,e),m=c.pow(l,o);for(;!c.eql(p,c.ONE);){if(c.is0(p))return c.ZERO;let _=1,R=c.sqr(p);for(;!c.eql(R,c.ONE);)if(_++,R=c.sqr(R),_===h)throw new Error("Cannot find square root");const T=vn<<BigInt(h-_-1),A=c.pow(f,T);h=_,f=c.sqr(A),p=c.mul(p,f),m=c.mul(m,A)}return m}}function LA(r){return r%vy===Ey?Iy:r%Sy===xy?qA:r%Ay===DA?BA(r):Ty(r)}const OA=(r,e)=>(rn(r,e)&vn)===vn,$A=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function MA(r){const e={ORDER:"bigint",BYTES:"number",BITS:"number"},t=$A.reduce((n,s)=>(n[s]="function",n),e);return ru(r,t),r}function NA(r,e,t){if(t<er)throw new Error("invalid exponent, negatives unsupported");if(t===er)return r.ONE;if(t===vn)return e;let n=r.ONE,s=e;for(;t>er;)t&vn&&(n=r.mul(n,s)),s=r.sqr(s),t>>=vn;return n}function ky(r,e,t=!1){const n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((o,a,c)=>r.is0(a)?o:(n[c]=o,r.mul(o,a)),r.ONE),i=r.inv(s);return e.reduceRight((o,a,c)=>r.is0(a)?o:(n[c]=r.mul(o,n[c]),r.mul(o,a)),i),n}function Nm(r,e){const t=(r.ORDER-vn)/Ki,n=r.pow(e,t),s=r.eql(n,r.ONE),i=r.eql(n,r.ZERO),o=r.eql(n,r.neg(r.ONE));if(!s&&!i&&!o)throw new Error("invalid Legendre symbol result");return s?1:i?0:-1}function UA(r,e){e!==void 0&&go(e);const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}let FA=class{ORDER;BITS;BYTES;isLE;ZERO=er;ONE=vn;_lengths;_sqrt;_mod;constructor(e,t={}){if(e<=er)throw new Error("invalid field: expected ORDER > 0, got "+e);let n;this.isLE=!1,t!=null&&typeof t=="object"&&(typeof t.BITS=="number"&&(n=t.BITS),typeof t.sqrt=="function"&&(this.sqrt=t.sqrt),typeof t.isLE=="boolean"&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),typeof t.modFromBytes=="boolean"&&(this._mod=t.modFromBytes));const{nBitLength:s,nByteLength:i}=UA(e,n);if(i>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=s,this.BYTES=i,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return rn(e,this.ORDER)}isValid(e){if(typeof e!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof e);return er<=e&&e<this.ORDER}is0(e){return e===er}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&vn)===vn}neg(e){return rn(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return rn(e*e,this.ORDER)}add(e,t){return rn(e+t,this.ORDER)}sub(e,t){return rn(e-t,this.ORDER)}mul(e,t){return rn(e*t,this.ORDER)}pow(e,t){return NA(this,e,t)}div(e,t){return rn(e*Mm(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return Mm(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=LA(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?_y(e,this.BYTES):Ep(e,this.BYTES)}fromBytes(e,t=!1){bt(e);const{_lengths:n,BYTES:s,isLE:i,ORDER:o,_mod:a}=this;if(n){if(!n.includes(e.length)||e.length>s)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+e.length);const l=new Uint8Array(s);l.set(e,i?0:l.length-e.length),e=l}if(e.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+e.length);let c=i?pl(e):vh(e);if(a&&(c=rn(c,o)),!t&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(e){return ky(this,e)}cmov(e,t,n){return n?t:e}};function xh(r,e={}){return new FA(r,e)}function Cy(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function Ry(r){const e=Cy(r);return e+Math.ceil(e/2)}function HA(r,e,t=!1){bt(r);const n=r.length,s=Cy(e),i=Ry(e);if(n<16||n<i||n>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+n);const o=t?pl(r):vh(r),a=rn(o,e-vn)+vn;return t?_y(a,s):Ep(a,s)}const $a=BigInt(0),zi=BigInt(1);function sd(r,e){const t=e.negate();return r?t:e}function Wc(r,e){const t=ky(r.Fp,e.map(n=>n.Z));return e.map((n,s)=>r.fromAffine(n.toAffine(t[s])))}function Py(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function T1(r,e){Py(r,e);const t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,i=vp(r),o=BigInt(r);return{windows:t,windowSize:n,mask:i,maxNumber:s,shiftBy:o}}function Um(r,e,t){const{windowSize:n,mask:s,maxNumber:i,shiftBy:o}=t;let a=Number(r&s),c=r>>o;a>n&&(a-=i,c+=zi);const l=e*n,h=l+Math.abs(a)-1,f=a===0,p=a<0,m=e%2!==0;return{nextN:c,offset:h,isZero:f,isNeg:p,isNegF:m,offsetF:l}}const k1=new WeakMap,Dy=new WeakMap;function C1(r){return Dy.get(r)||1}function Fm(r){if(r!==$a)throw new Error("invalid wNAF")}let qy=class{BASE;ZERO;Fn;bits;constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let s=e;for(;t>$a;)t&zi&&(n=n.add(s)),s=s.double(),t>>=zi;return n}precomputeWindow(e,t){const{windows:n,windowSize:s}=T1(t,this.bits),i=[];let o=e,a=o;for(let c=0;c<n;c++){a=o,i.push(a);for(let l=1;l<s;l++)a=a.add(o),i.push(a);o=a.double()}return i}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,i=this.BASE;const o=T1(e,this.bits);for(let a=0;a<o.windows;a++){const{nextN:c,offset:l,isZero:h,isNeg:f,isNegF:p,offsetF:m}=Um(n,a,o);n=c,h?i=i.add(sd(p,t[m])):s=s.add(sd(f,t[l]))}return Fm(n),{p:s,f:i}}wNAFUnsafe(e,t,n,s=this.ZERO){const i=T1(e,this.bits);for(let o=0;o<i.windows&&n!==$a;o++){const{nextN:a,offset:c,isZero:l,isNeg:h}=Um(n,o,i);if(n=a,!l){const f=t[c];s=s.add(h?f.negate():f)}}return Fm(n),s}getPrecomputes(e,t,n){let s=k1.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(s=n(s)),k1.set(t,s))),s}cached(e,t,n){const s=C1(e);return this.wNAF(s,this.getPrecomputes(s,e,n),t)}unsafe(e,t,n,s){const i=C1(e);return i===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(i,this.getPrecomputes(i,e,n),t,s)}createCache(e,t){Py(t,this.bits),Dy.set(e,t),k1.delete(e)}hasCache(e){return C1(e)!==1}};function VA(r,e,t,n){let s=e,i=r.ZERO,o=r.ZERO;for(;t>$a||n>$a;)t&zi&&(i=i.add(s)),n&zi&&(o=o.add(s)),s=s.double(),t>>=zi,n>>=zi;return{p1:i,p2:o}}function Hm(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return MA(e),e}else return xh(r,{isLE:t})}function By(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(const c of["p","n","h"]){const l=e[c];if(!(typeof l=="bigint"&&l>$a))throw new Error(`CURVE.${c} must be positive bigint`)}const s=Hm(e.p,t.Fp,n),i=Hm(e.n,t.Fn,n),a=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(const c of a)if(!s.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:i}}function Ly(r,e){return function(n){const s=r(n);return{secretKey:s,publicKey:e(s)}}}const Ks=BigInt(0),dn=BigInt(1),R1=BigInt(2),KA=BigInt(8);function zA(r,e,t,n){const s=r.sqr(t),i=r.sqr(n),o=r.add(r.mul(e.a,s),i),a=r.add(r.ONE,r.mul(e.d,r.mul(s,i)));return r.eql(o,a)}function WA(r,e={}){const t=By("edwards",r,e,e.FpFnLE),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o}=i;ru(e,{},{uvRatio:"function"});const a=R1<<BigInt(s.BYTES*8)-dn,c=T=>n.create(T),l=e.uvRatio||((T,A)=>{try{return{isValid:!0,value:n.sqrt(n.div(T,A))}}catch{return{isValid:!1,value:Ks}}});if(!zA(n,i,i.Gx,i.Gy))throw new Error("bad curve params: generator point");function h(T,A,D=!1){const I=D?dn:Ks;return O2("coordinate "+T,A,I,a),A}function f(T){if(!(T instanceof _))throw new Error("EdwardsPoint expected")}const p=rd((T,A)=>{const{X:D,Y:I,Z:q}=T,L=T.is0();A==null&&(A=L?KA:n.inv(q));const z=c(D*A),Y=c(I*A),k=n.mul(q,A);if(L)return{x:Ks,y:dn};if(k!==dn)throw new Error("invZ was invalid");return{x:z,y:Y}}),m=rd(T=>{const{a:A,d:D}=i;if(T.is0())throw new Error("bad point: ZERO");const{X:I,Y:q,Z:L,T:z}=T,Y=c(I*I),k=c(q*q),x=c(L*L),F=c(x*x),j=c(Y*A),U=c(x*c(j+k)),y=c(F+c(D*c(Y*k)));if(U!==y)throw new Error("bad point: equation left != right (1)");const b=c(I*q),g=c(L*z);if(b!==g)throw new Error("bad point: equation left != right (2)");return!0});class _{static BASE=new _(i.Gx,i.Gy,dn,c(i.Gx*i.Gy));static ZERO=new _(Ks,dn,dn,Ks);static Fp=n;static Fn=s;X;Y;Z;T;constructor(A,D,I,q){this.X=h("x",A),this.Y=h("y",D),this.Z=h("z",I,!0),this.T=h("t",q),Object.freeze(this)}static CURVE(){return i}static fromAffine(A){if(A instanceof _)throw new Error("extended point not allowed");const{x:D,y:I}=A||{};return h("x",D),h("y",I),new _(D,I,dn,c(D*I))}static fromBytes(A,D=!1){const I=n.BYTES,{a:q,d:L}=i;A=L2(bt(A,I,"point")),mo(D,"zip215");const z=L2(A),Y=A[I-1];z[I-1]=Y&-129;const k=pl(z),x=D?a:n.ORDER;O2("point.y",k,Ks,x);const F=c(k*k),j=c(F-dn),U=c(L*F-q);let{isValid:y,value:b}=l(j,U);if(!y)throw new Error("bad point: invalid y coordinate");const g=(b&dn)===dn,C=(Y&128)!==0;if(!D&&b===Ks&&C)throw new Error("bad point: x=0 and x_0=1");return C!==g&&(b=c(-b)),_.fromAffine({x:b,y:k})}static fromHex(A,D=!1){return _.fromBytes(hl(A),D)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(A=8,D=!0){return R.createCache(this,A),D||this.multiply(R1),this}assertValidity(){m(this)}equals(A){f(A);const{X:D,Y:I,Z:q}=this,{X:L,Y:z,Z:Y}=A,k=c(D*Y),x=c(L*q),F=c(I*Y),j=c(z*q);return k===x&&F===j}is0(){return this.equals(_.ZERO)}negate(){return new _(c(-this.X),this.Y,this.Z,c(-this.T))}double(){const{a:A}=i,{X:D,Y:I,Z:q}=this,L=c(D*D),z=c(I*I),Y=c(R1*c(q*q)),k=c(A*L),x=D+I,F=c(c(x*x)-L-z),j=k+z,U=j-Y,y=k-z,b=c(F*U),g=c(j*y),C=c(F*y),B=c(U*j);return new _(b,g,B,C)}add(A){f(A);const{a:D,d:I}=i,{X:q,Y:L,Z:z,T:Y}=this,{X:k,Y:x,Z:F,T:j}=A,U=c(q*k),y=c(L*x),b=c(Y*I*j),g=c(z*F),C=c((q+L)*(k+x)-U-y),B=g-b,M=g+b,O=c(y-D*U),$=c(C*B),V=c(M*O),G=c(C*O),de=c(B*M);return new _($,V,de,G)}subtract(A){return this.add(A.negate())}multiply(A){if(!s.isValidNot0(A))throw new Error("invalid scalar: expected 1 <= sc < curve.n");const{p:D,f:I}=R.cached(this,A,q=>Wc(_,q));return Wc(_,[D,I])[0]}multiplyUnsafe(A,D=_.ZERO){if(!s.isValid(A))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return A===Ks?_.ZERO:this.is0()||A===dn?this:R.unsafe(this,A,I=>Wc(_,I),D)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}isTorsionFree(){return R.unsafe(this,i.n).is0()}toAffine(A){return p(this,A)}clearCofactor(){return o===dn?this:this.multiplyUnsafe(o)}toBytes(){const{x:A,y:D}=this.toAffine(),I=n.toBytes(D);return I[I.length-1]|=A&dn?128:0,I}toHex(){return nu(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const R=new qy(_,s.BITS);return _.BASE.precompute(8),_}function GA(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');ru(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:n}=t,{BASE:s,Fp:i,Fn:o}=r,a=t.randomBytes||Eh,c=t.adjustScalarBytes||(k=>k),l=t.domain||((k,x,F)=>{if(mo(F,"phflag"),x.length||F)throw new Error("Contexts/pre-hash are not supported");return k});function h(k){return o.create(pl(k))}function f(k){const x=I.secretKey;bt(k,I.secretKey,"secretKey");const F=bt(e(k),2*x,"hashedSecretKey"),j=c(F.slice(0,x)),U=F.slice(x,2*x),y=h(j);return{head:j,prefix:U,scalar:y}}function p(k){const{head:x,prefix:F,scalar:j}=f(k),U=s.multiply(j),y=U.toBytes();return{head:x,prefix:F,scalar:j,point:U,pointBytes:y}}function m(k){return p(k).pointBytes}function _(k=Uint8Array.of(),...x){const F=Yr(...x);return h(e(l(F,bt(k,void 0,"context"),!!n)))}function R(k,x,F={}){k=bt(k,void 0,"message"),n&&(k=n(k));const{prefix:j,scalar:U,pointBytes:y}=p(x),b=_(F.context,j,k),g=s.multiply(b).toBytes(),C=_(F.context,g,y,k),B=o.create(b+C*U);if(!o.isValid(B))throw new Error("sign failed: invalid s");const M=Yr(g,o.toBytes(B));return bt(M,I.signature,"result")}const T={zip215:!0};function A(k,x,F,j=T){const{context:U,zip215:y}=j,b=I.signature;k=bt(k,b,"signature"),x=bt(x,void 0,"message"),F=bt(F,I.publicKey,"publicKey"),y!==void 0&&mo(y,"zip215"),n&&(x=n(x));const g=b/2,C=k.subarray(0,g),B=pl(k.subarray(g,b));let M,O,$;try{M=r.fromBytes(F,y),O=r.fromBytes(C,y),$=s.multiplyUnsafe(B)}catch{return!1}if(!y&&M.isSmallOrder())return!1;const V=_(U,O.toBytes(),M.toBytes(),x);return O.add(M.multiplyUnsafe(V)).subtract($).clearCofactor().is0()}const D=i.BYTES,I={secretKey:D,publicKey:D,signature:2*D,seed:D};function q(k=a(I.seed)){return bt(k,I.seed,"seed")}function L(k){return _h(k)&&k.length===o.BYTES}function z(k,x){try{return!!r.fromBytes(k,x)}catch{return!1}}const Y={getExtendedPublicKey:p,randomSecretKey:q,isValidSecretKey:L,isValidPublicKey:z,toMontgomery(k){const{y:x}=r.fromBytes(k),F=I.publicKey,j=F===32;if(!j&&F!==57)throw new Error("only defined for 25519 and 448");const U=j?i.div(dn+x,dn-x):i.div(x-dn,x+dn);return i.toBytes(U)},toMontgomerySecret(k){const x=I.secretKey;bt(k,x);const F=e(k.subarray(0,x));return c(F).subarray(0,x)}};return Object.freeze({keygen:Ly(q,m),getPublicKey:m,sign:R,verify:A,utils:Y,Point:r,lengths:I})}const ZA=BigInt(1),Vm=BigInt(2),jA=BigInt(5),YA=BigInt(8),Sp=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),QA={p:Sp,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:YA,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function XA(r){const e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),i=Sp,a=r*r%i*r%i,c=zt(a,Vm,i)*a%i,l=zt(c,ZA,i)*r%i,h=zt(l,jA,i)*l%i,f=zt(h,e,i)*h%i,p=zt(f,t,i)*f%i,m=zt(p,n,i)*p%i,_=zt(m,s,i)*m%i,R=zt(_,s,i)*m%i,T=zt(R,e,i)*h%i;return{pow_p_5_8:zt(T,Vm,i)*r%i,b2:a}}function JA(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}const Km=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function eI(r,e){const t=Sp,n=rn(e*e*e,t),s=rn(n*n*e,t),i=XA(r*s).pow_p_5_8;let o=rn(r*n*i,t);const a=rn(e*o*o,t),c=o,l=rn(o*Km,t),h=a===r,f=a===rn(-r,t),p=a===rn(-r*Km,t);return h&&(o=c),(f||p)&&(o=l),OA(o,t)&&(o=rn(-o,t)),{isValid:h||f,value:o}}const tI=WA(QA,{uvRatio:eI});function nI(r){return GA(tI,TA,Object.assign({adjustScalarBytes:JA},r))}const id=nI({});let zm=class extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}},rI=class extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}};var yo={get(r=globalThis){const e=r.crypto;if(e?.subtle==null)throw new rI("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};const Oy=32,Ap=64,$2=32;let Ea;const $y=(async()=>{try{return await yo.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function sI(){const r=id.utils.randomSecretKey(),e=id.getPublicKey(r);return{privateKey:fI(r,e),publicKey:e}}async function iI(r,e){let t;r.length===Ap?t=r.subarray(0,32):t=r;const n={crv:"Ed25519",kty:"OKP",x:Le(r.subarray(32),"base64url"),d:Le(t,"base64url"),ext:!0,key_ops:["sign"]},s=await yo.get().subtle.importKey("jwk",n,{name:"Ed25519"},!0,["sign"]),i=await yo.get().subtle.sign({name:"Ed25519"},s,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(i,0,i.byteLength)}function oI(r,e){const t=r.subarray(0,$2);return id.sign(e instanceof Uint8Array?e:e.subarray(),t)}async function aI(r,e){return Ea==null&&(Ea=await $y),Ea?iI(r,e):oI(r,e)}async function cI(r,e,t){if(r.buffer instanceof ArrayBuffer){const n=await yo.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await yo.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function lI(r,e,t){return id.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function uI(r,e,t){return Ea==null&&(Ea=await $y),Ea?cI(r,e,t):lI(r,e,t)}function fI(r,e){const t=new Uint8Array(Ap);for(let n=0;n<$2;n++)t[n]=r[n],t[$2+n]=e[n];return t}function Ip(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}let My=class{type="Ed25519";raw;constructor(e){this.raw=Tp(e,Oy)}toMultihash(){return Kt.digest(Lp(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();const s=uI(this.raw,t,e);return Ip(s)?s.then(i=>(n?.signal?.throwIfAborted(),i)):s}},dI=class{type="Ed25519";raw;publicKey;constructor(e,t){this.raw=Tp(e,Ap),this.publicKey=new My(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}sign(e,t){t?.signal?.throwIfAborted();const n=aI(this.raw,e);return Ip(n)?n.then(s=>(t?.signal?.throwIfAborted(),s)):(t?.signal?.throwIfAborted(),n)}};function hI(r){return r=Tp(r,Oy),new My(r)}async function pI(){const{privateKey:r,publicKey:e}=sI();return new dI(r,e)}function Tp(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new Jl(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}const gI=Math.pow(2,7),mI=Math.pow(2,14),yI=Math.pow(2,21),kp=Math.pow(2,28),Cp=Math.pow(2,35),Rp=Math.pow(2,42),Pp=Math.pow(2,49),It=128,Un=127;function hr(r){if(r<gI)return 1;if(r<mI)return 2;if(r<yI)return 3;if(r<kp)return 4;if(r<Cp)return 5;if(r<Rp)return 6;if(r<Pp)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function od(r,e,t=0){switch(hr(r)){case 8:e[t++]=r&255|It,r/=128;case 7:e[t++]=r&255|It,r/=128;case 6:e[t++]=r&255|It,r/=128;case 5:e[t++]=r&255|It,r/=128;case 4:e[t++]=r&255|It,r>>>=7;case 3:e[t++]=r&255|It,r>>>=7;case 2:e[t++]=r&255|It,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function bI(r,e,t=0){switch(hr(r)){case 8:e.set(t++,r&255|It),r/=128;case 7:e.set(t++,r&255|It),r/=128;case 6:e.set(t++,r&255|It),r/=128;case 5:e.set(t++,r&255|It),r/=128;case 4:e.set(t++,r&255|It),r>>>=7;case 3:e.set(t++,r&255|It),r>>>=7;case 2:e.set(t++,r&255|It),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function Ny(r,e){let t=r[e],n=0;if(n+=t&Un,t<It||(t=r[e+1],n+=(t&Un)<<7,t<It)||(t=r[e+2],n+=(t&Un)<<14,t<It)||(t=r[e+3],n+=(t&Un)<<21,t<It)||(t=r[e+4],n+=(t&Un)*kp,t<It)||(t=r[e+5],n+=(t&Un)*Cp,t<It)||(t=r[e+6],n+=(t&Un)*Rp,t<It)||(t=r[e+7],n+=(t&Un)*Pp,t<It))return n;throw new RangeError("Could not decode varint")}function wI(r,e){let t=r.get(e),n=0;if(n+=t&Un,t<It||(t=r.get(e+1),n+=(t&Un)<<7,t<It)||(t=r.get(e+2),n+=(t&Un)<<14,t<It)||(t=r.get(e+3),n+=(t&Un)<<21,t<It)||(t=r.get(e+4),n+=(t&Un)*kp,t<It)||(t=r.get(e+5),n+=(t&Un)*Cp,t<It)||(t=r.get(e+6),n+=(t&Un)*Rp,t<It)||(t=r.get(e+7),n+=(t&Un)*Pp,t<It))return n;throw new RangeError("Could not decode varint")}function Ri(r,e,t=0){return e==null&&(e=Tr(hr(r))),e instanceof Uint8Array?od(r,e,t):bI(r,e,t)}function mc(r,e=0){return r instanceof Uint8Array?Ny(r,e):wI(r,e)}const Dp=new Float32Array([-0]),Ti=new Uint8Array(Dp.buffer);function _I(r,e,t){Dp[0]=r,e[t]=Ti[0],e[t+1]=Ti[1],e[t+2]=Ti[2],e[t+3]=Ti[3]}function EI(r,e){return Ti[0]=r[e],Ti[1]=r[e+1],Ti[2]=r[e+2],Ti[3]=r[e+3],Dp[0]}const qp=new Float64Array([-0]),Fn=new Uint8Array(qp.buffer);function vI(r,e,t){qp[0]=r,e[t]=Fn[0],e[t+1]=Fn[1],e[t+2]=Fn[2],e[t+3]=Fn[3],e[t+4]=Fn[4],e[t+5]=Fn[5],e[t+6]=Fn[6],e[t+7]=Fn[7]}function xI(r,e){return Fn[0]=r[e],Fn[1]=r[e+1],Fn[2]=r[e+2],Fn[3]=r[e+3],Fn[4]=r[e+4],Fn[5]=r[e+5],Fn[6]=r[e+6],Fn[7]=r[e+7],qp[0]}const SI=BigInt(Number.MAX_SAFE_INTEGER),AI=BigInt(Number.MIN_SAFE_INTEGER);class Hn{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return lo;if(e<SI&&e>AI)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let n=e>>32n,s=e-(n<<32n);return t&&(n=~n|0n,s=~s|0n,++s>Wm&&(s=0n,++n>Wm&&(n=0n))),new Hn(Number(s),Number(n))}static fromNumber(e){if(e===0)return lo;const t=e<0;t&&(e=-e);let n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new Hn(n,s)}static from(e){return typeof e=="number"?Hn.fromNumber(e):typeof e=="bigint"?Hn.fromBigInt(e):typeof e=="string"?Hn.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new Hn(e.low>>>0,e.high>>>0):lo}}const lo=new Hn(0,0);lo.toBigInt=function(){return 0n};lo.zzEncode=lo.zzDecode=function(){return this};lo.length=function(){return 1};const Wm=4294967296n;function II(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function TI(r,e,t){if(t-e<1)return"";let s;const i=[];let o=0,a;for(;e<t;)a=r[e++],a<128?i[o++]=a:a>191&&a<224?i[o++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,i[o++]=55296+(a>>10),i[o++]=56320+(a&1023)):i[o++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,o>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,i)),o=0);return s!=null?(o>0&&s.push(String.fromCharCode.apply(String,i.slice(0,o))),s.join("")):String.fromCharCode.apply(String,i.slice(0,o))}function Uy(r,e,t){const n=t;let s,i;for(let o=0;o<r.length;++o)s=r.charCodeAt(o),s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&((i=r.charCodeAt(o+1))&64512)===56320?(s=65536+((s&1023)<<10)+(i&1023),++o,e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128);return t-n}function kr(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function Ku(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}class kI{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,kr(this,10);return e}int32(){return this.uint32()|0}sint32(){const e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw kr(this,4);return Ku(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw kr(this,4);return Ku(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw kr(this,4);const e=EI(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw kr(this,4);const e=xI(this.buf,this.pos);return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw kr(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){const e=this.bytes();return TI(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw kr(this,e);this.pos+=e}else do if(this.pos>=this.len)throw kr(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new Hn(0,0);let t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw kr(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw kr(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw kr(this,8);const e=Ku(this.buf,this.pos+=4),t=Ku(this.buf,this.pos+=4);return new Hn(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const e=Ny(this.buf,this.pos);return this.pos+=hr(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function CI(r){return new kI(r instanceof Uint8Array?r:r.subarray())}function Je(r,e,t){const n=CI(r);return e.decode(n,void 0,t)}function RI(r){let n,s=8192;return function(o){if(o<1||o>4096)return Tr(o);s+o>8192&&(n=Tr(8192),s=0);const a=n.subarray(s,s+=o);return(s&7)!==0&&(s=(s|7)+1),a}}class Fc{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}}function P1(){}class PI{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const DI=RI();function qI(r){return globalThis.Buffer!=null?Tr(r):DI(r)}class M2{len;head;tail;states;constructor(){this.len=0,this.head=new Fc(P1,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new Fc(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new LI((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(zu,10,Hn.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=Hn.fromBigInt(e);return this._push(zu,t.length(),t)}uint64Number(e){return this._push(od,hr(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=Hn.fromBigInt(e).zzEncode();return this._push(zu,t.length(),t)}sint64Number(e){const t=Hn.fromNumber(e).zzEncode();return this._push(zu,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(D1,1,e?1:0)}fixed32(e){return this._push(kc,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=Hn.fromBigInt(e);return this._push(kc,4,t.lo)._push(kc,4,t.hi)}fixed64Number(e){const t=Hn.fromNumber(e);return this._push(kc,4,t.lo)._push(kc,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(_I,4,e)}double(e){return this._push(vI,8,e)}bytes(e){const t=e.length>>>0;return t===0?this._push(D1,1,0):this.uint32(t)._push(OI,t,e)}string(e){const t=II(e);return t!==0?this.uint32(t)._push(Uy,t,e):this._push(D1,1,0)}fork(){return this.states=new PI(this),this.head=this.tail=new Fc(P1,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Fc(P1,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next;const t=qI(this.len);let n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}}function D1(r,e,t){e[t]=r&255}function BI(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}class LI extends Fc{next;constructor(e,t){super(BI,e,t),this.next=void 0}}function zu(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function kc(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function OI(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(M2.prototype.bytes=function(r){const e=r.length>>>0;return this.uint32(e),e>0&&this._push($I,e,r),this},M2.prototype.string=function(r){const e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(MI,e,r),this});function $I(r,e,t){e.set(r,t)}function MI(r,e,t){r.length<40?Uy(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(Ge(r),t)}function NI(){return new M2}function et(r,e){const t=NI();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var ad;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(ad||(ad={}));function Fy(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function Rn(r){function e(s){if(r[s.toString()]==null)throw new Error("Invalid enum value");return r[s]}const t=function(i,o){const a=e(i);o.int32(a)},n=function(i){const o=i.int32();return e(o)};return Fy("enum",ad.VARINT,t,n)}function tt(r,e){return Fy("message",ad.LENGTH_DELIMITED,r,e)}class Mt extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"}class Gm extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"}var tr;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(tr||(tr={}));var N2;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(N2||(N2={}));(function(r){r.codec=()=>Rn(N2)})(tr||(tr={}));var gl;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),tr.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=tr.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(gl||(gl={}));var Zm;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),tr.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=tr.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(Zm||(Zm={}));function Hy(r){if(isNaN(r)||r<=0)throw new Jl("random bytes length must be a Number bigger than 0");return Eh(r)}let UI=class{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=zI(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return nt.createV1(114,this._multihash)}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){return ZI(this.jwk,t,e,n)}};const FI=18,HI=1062,VI=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function KI(r){const e=wh(r[1],{offset:0});return{kty:"RSA",n:Le(e[0],"base64url"),e:Le(e[1],"base64url")}}function zI(r){if(r.n==null||r.e==null)throw new Jl("JWK was missing components");return zc([VI,uy(zc([q2(Ge(r.n,"base64url")),q2(Ge(r.e,"base64url"))]))]).subarray()}function WI(r,e){if(r.byteLength>=HI)throw new J8("Key size is too large");const t=wh(r,{offset:0});return GI(t,r,e)}function GI(r,e,t){const n=KI(r);if(t==null){const s=yy(gl.encode({Type:tr.RSA,Data:e}));t=Ms(FI,s)}return new UI(n,t)}async function ZI(r,e,t,n){const s=await yo.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();const i=await yo.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),i}let Vy=class{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(e,t){if(fy(e),bt(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const n=this.blockLen,s=new Uint8Array(n);s.set(t.length>n?e.create().update(t).digest():t);for(let i=0;i<s.length;i++)s[i]^=54;this.iHash.update(s),this.oHash=e.create();for(let i=0;i<s.length;i++)s[i]^=106;this.oHash.update(s),Oa(s)}update(e){return nd(this),this.iHash.update(e),this}digestInto(e){nd(this),bt(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||=Object.create(Object.getPrototypeOf(this),{});const{oHash:t,iHash:n,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const Ky=(r,e,t)=>new Vy(r,e).update(t).digest();Ky.create=(r,e)=>new Vy(r,e);const jm=(r,e)=>(r+(r>=0?e:-e)/zy)/e;function jI(r,e,t){const[[n,s],[i,o]]=e,a=jm(o*r,t),c=jm(-s*r,t);let l=r-a*n-c*i,h=-a*s-c*o;const f=l<Ts,p=h<Ts;f&&(l=-l),p&&(h=-h);const m=vp(Math.ceil(CA(t)/2))+va;if(l<Ts||l>=m||h<Ts||h>=m)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:f,k1:l,k2neg:p,k2:h}}function U2(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function q1(r,e){const t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return mo(t.lowS,"lowS"),mo(t.prehash,"prehash"),t.format!==void 0&&U2(t.format),t}let YI=class extends Error{constructor(e=""){super(e)}};const Ei={Err:YI,_tlv:{encode:(r,e)=>{const{Err:t}=Ei;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const n=e.length/2,s=Vu(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");const i=n>127?Vu(s.length/2|128):"";return Vu(r)+i+s+e},decode(r,e){const{Err:t}=Ei;let n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");const s=e[n++],i=!!(s&128);let o=0;if(!i)o=s;else{const c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const l=e.subarray(n,n+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const h of l)o=o<<8|h;if(n+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const a=e.subarray(n,n+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+o)}}},_int:{encode(r){const{Err:e}=Ei;if(r<Ts)throw new e("integer: negative integers are not allowed");let t=Vu(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){const{Err:e}=Ei;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return vh(r)}},toSig(r){const{Err:e,_int:t,_tlv:n}=Ei,s=bt(r,void 0,"signature"),{v:i,l:o}=n.decode(48,s);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=n.decode(2,i),{v:l,l:h}=n.decode(2,c);if(h.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(r){const{_tlv:e,_int:t}=Ei,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),i=n+s;return e.encode(48,i)}},Ts=BigInt(0),va=BigInt(1),zy=BigInt(2),Wu=BigInt(3),QI=BigInt(4);function XI(r,e={}){const t=By("weierstrass",r,e),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o,n:a}=i;ru(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});const{endo:c}=e;if(c&&(!n.is0(i.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const l=Gy(n,s);function h(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function f(U,y,b){const{x:g,y:C}=y.toAffine(),B=n.toBytes(g);if(mo(b,"isCompressed"),b){h();const M=!n.isOdd(C);return Yr(Wy(M),B)}else return Yr(Uint8Array.of(4),B,n.toBytes(C))}function p(U){bt(U,void 0,"Point");const{publicKey:y,publicKeyUncompressed:b}=l,g=U.length,C=U[0],B=U.subarray(1);if(g===y&&(C===2||C===3)){const M=n.fromBytes(B);if(!n.isValid(M))throw new Error("bad point: is not on curve, wrong x");const O=R(M);let $;try{$=n.sqrt(O)}catch(de){const ce=de instanceof Error?": "+de.message:"";throw new Error("bad point: is not on curve, sqrt error"+ce)}h();const V=n.isOdd($);return(C&1)===1!==V&&($=n.neg($)),{x:M,y:$}}else if(g===b&&C===4){const M=n.BYTES,O=n.fromBytes(B.subarray(0,M)),$=n.fromBytes(B.subarray(M,M*2));if(!T(O,$))throw new Error("bad point: is not on curve");return{x:O,y:$}}else throw new Error(`bad point: got length ${g}, expected compressed=${y} or uncompressed=${b}`)}const m=e.toBytes||f,_=e.fromBytes||p;function R(U){const y=n.sqr(U),b=n.mul(y,U);return n.add(n.add(b,n.mul(U,i.a)),i.b)}function T(U,y){const b=n.sqr(y),g=R(U);return n.eql(b,g)}if(!T(i.Gx,i.Gy))throw new Error("bad curve params: generator point");const A=n.mul(n.pow(i.a,Wu),QI),D=n.mul(n.sqr(i.b),BigInt(27));if(n.is0(n.add(A,D)))throw new Error("bad curve params: a or b");function I(U,y,b=!1){if(!n.isValid(y)||b&&n.is0(y))throw new Error(`bad point coordinate ${U}`);return y}function q(U){if(!(U instanceof x))throw new Error("Weierstrass Point expected")}function L(U){if(!c||!c.basises)throw new Error("no endo");return jI(U,c.basises,s.ORDER)}const z=rd((U,y)=>{const{X:b,Y:g,Z:C}=U;if(n.eql(C,n.ONE))return{x:b,y:g};const B=U.is0();y==null&&(y=B?n.ONE:n.inv(C));const M=n.mul(b,y),O=n.mul(g,y),$=n.mul(C,y);if(B)return{x:n.ZERO,y:n.ZERO};if(!n.eql($,n.ONE))throw new Error("invZ was invalid");return{x:M,y:O}}),Y=rd(U=>{if(U.is0()){if(e.allowInfinityPoint&&!n.is0(U.Y))return;throw new Error("bad point: ZERO")}const{x:y,y:b}=U.toAffine();if(!n.isValid(y)||!n.isValid(b))throw new Error("bad point: x or y not field elements");if(!T(y,b))throw new Error("bad point: equation left != right");if(!U.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function k(U,y,b,g,C){return b=new x(n.mul(b.X,U),b.Y,b.Z),y=sd(g,y),b=sd(C,b),y.add(b)}class x{static BASE=new x(i.Gx,i.Gy,n.ONE);static ZERO=new x(n.ZERO,n.ONE,n.ZERO);static Fp=n;static Fn=s;X;Y;Z;constructor(y,b,g){this.X=I("x",y),this.Y=I("y",b,!0),this.Z=I("z",g),Object.freeze(this)}static CURVE(){return i}static fromAffine(y){const{x:b,y:g}=y||{};if(!y||!n.isValid(b)||!n.isValid(g))throw new Error("invalid affine point");if(y instanceof x)throw new Error("projective point not allowed");return n.is0(b)&&n.is0(g)?x.ZERO:new x(b,g,n.ONE)}static fromBytes(y){const b=x.fromAffine(_(bt(y,void 0,"point")));return b.assertValidity(),b}static fromHex(y){return x.fromBytes(hl(y))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(y=8,b=!0){return j.createCache(this,y),b||this.multiply(Wu),this}assertValidity(){Y(this)}hasEvenY(){const{y}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(y)}equals(y){q(y);const{X:b,Y:g,Z:C}=this,{X:B,Y:M,Z:O}=y,$=n.eql(n.mul(b,O),n.mul(B,C)),V=n.eql(n.mul(g,O),n.mul(M,C));return $&&V}negate(){return new x(this.X,n.neg(this.Y),this.Z)}double(){const{a:y,b}=i,g=n.mul(b,Wu),{X:C,Y:B,Z:M}=this;let O=n.ZERO,$=n.ZERO,V=n.ZERO,G=n.mul(C,C),de=n.mul(B,B),ce=n.mul(M,M),re=n.mul(C,B);return re=n.add(re,re),V=n.mul(C,M),V=n.add(V,V),O=n.mul(y,V),$=n.mul(g,ce),$=n.add(O,$),O=n.sub(de,$),$=n.add(de,$),$=n.mul(O,$),O=n.mul(re,O),V=n.mul(g,V),ce=n.mul(y,ce),re=n.sub(G,ce),re=n.mul(y,re),re=n.add(re,V),V=n.add(G,G),G=n.add(V,G),G=n.add(G,ce),G=n.mul(G,re),$=n.add($,G),ce=n.mul(B,M),ce=n.add(ce,ce),G=n.mul(ce,re),O=n.sub(O,G),V=n.mul(ce,de),V=n.add(V,V),V=n.add(V,V),new x(O,$,V)}add(y){q(y);const{X:b,Y:g,Z:C}=this,{X:B,Y:M,Z:O}=y;let $=n.ZERO,V=n.ZERO,G=n.ZERO;const de=i.a,ce=n.mul(i.b,Wu);let re=n.mul(b,B),pe=n.mul(g,M),_e=n.mul(C,O),$e=n.add(b,g),ge=n.add(B,M);$e=n.mul($e,ge),ge=n.add(re,pe),$e=n.sub($e,ge),ge=n.add(b,C);let ke=n.add(B,O);return ge=n.mul(ge,ke),ke=n.add(re,_e),ge=n.sub(ge,ke),ke=n.add(g,C),$=n.add(M,O),ke=n.mul(ke,$),$=n.add(pe,_e),ke=n.sub(ke,$),G=n.mul(de,ge),$=n.mul(ce,_e),G=n.add($,G),$=n.sub(pe,G),G=n.add(pe,G),V=n.mul($,G),pe=n.add(re,re),pe=n.add(pe,re),_e=n.mul(de,_e),ge=n.mul(ce,ge),pe=n.add(pe,_e),_e=n.sub(re,_e),_e=n.mul(de,_e),ge=n.add(ge,_e),re=n.mul(pe,ge),V=n.add(V,re),re=n.mul(ke,ge),$=n.mul($e,$),$=n.sub($,re),re=n.mul($e,pe),G=n.mul(ke,G),G=n.add(G,re),new x($,V,G)}subtract(y){return this.add(y.negate())}is0(){return this.equals(x.ZERO)}multiply(y){const{endo:b}=e;if(!s.isValidNot0(y))throw new Error("invalid scalar: out of range");let g,C;const B=M=>j.cached(this,M,O=>Wc(x,O));if(b){const{k1neg:M,k1:O,k2neg:$,k2:V}=L(y),{p:G,f:de}=B(O),{p:ce,f:re}=B(V);C=de.add(re),g=k(b.beta,G,ce,M,$)}else{const{p:M,f:O}=B(y);g=M,C=O}return Wc(x,[g,C])[0]}multiplyUnsafe(y){const{endo:b}=e,g=this;if(!s.isValid(y))throw new Error("invalid scalar: out of range");if(y===Ts||g.is0())return x.ZERO;if(y===va)return g;if(j.hasCache(this))return this.multiply(y);if(b){const{k1neg:C,k1:B,k2neg:M,k2:O}=L(y),{p1:$,p2:V}=VA(x,g,B,O);return k(b.beta,$,V,C,M)}else return j.unsafe(g,y)}toAffine(y){return z(this,y)}isTorsionFree(){const{isTorsionFree:y}=e;return o===va?!0:y?y(x,this):j.unsafe(this,a).is0()}clearCofactor(){const{clearCofactor:y}=e;return o===va?this:y?y(x,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(y=!0){return mo(y,"isCompressed"),this.assertValidity(),m(x,this,y)}toHex(y=!0){return nu(this.toBytes(y))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const F=s.BITS,j=new qy(x,e.endo?Math.ceil(F/2):F);return x.BASE.precompute(8),x}function Wy(r){return Uint8Array.of(r?2:3)}function Gy(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function JI(r,e={}){const{Fn:t}=r,n=e.randomBytes||Eh,s=Object.assign(Gy(r.Fp,t),{seed:Ry(t.ORDER)});function i(m){try{const _=t.fromBytes(m);return t.isValidNot0(_)}catch{return!1}}function o(m,_){const{publicKey:R,publicKeyUncompressed:T}=s;try{const A=m.length;return _===!0&&A!==R||_===!1&&A!==T?!1:!!r.fromBytes(m)}catch{return!1}}function a(m=n(s.seed)){return HA(bt(m,s.seed,"seed"),t.ORDER)}function c(m,_=!0){return r.BASE.multiply(t.fromBytes(m)).toBytes(_)}function l(m){const{secretKey:_,publicKey:R,publicKeyUncompressed:T}=s;if(!_h(m)||"_lengths"in t&&t._lengths||_===R)return;const A=bt(m,void 0,"key").length;return A===R||A===T}function h(m,_,R=!0){if(l(m)===!0)throw new Error("first arg must be private key");if(l(_)===!1)throw new Error("second arg must be public key");const T=t.fromBytes(m);return r.fromBytes(_).multiply(T).toBytes(R)}const f={isValidSecretKey:i,isValidPublicKey:o,randomSecretKey:a},p=Ly(a,c);return Object.freeze({getPublicKey:c,getSharedSecret:h,keygen:p,Point:r,utils:f,lengths:s})}function eT(r,e,t={}){fy(e),ru(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),t=Object.assign({},t);const n=t.randomBytes||Eh,s=t.hmac||((b,g)=>Ky(e,b,g)),{Fp:i,Fn:o}=r,{ORDER:a,BITS:c}=o,{keygen:l,getPublicKey:h,getSharedSecret:f,utils:p,lengths:m}=JI(r,t),_={prehash:!0,lowS:typeof t.lowS=="boolean"?t.lowS:!0,format:"compact",extraEntropy:!1},R=a*zy<i.ORDER;function T(b){const g=a>>va;return b>g}function A(b,g){if(!o.isValidNot0(g))throw new Error(`invalid signature ${b}: out of range 1..Point.Fn.ORDER`);return g}function D(){if(R)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function I(b,g){U2(g);const C=m.signature,B=g==="compact"?C:g==="recovered"?C+1:void 0;return bt(b,B)}class q{r;s;recovery;constructor(g,C,B){if(this.r=A("r",g),this.s=A("s",C),B!=null){if(D(),![0,1,2,3].includes(B))throw new Error("invalid recovery id");this.recovery=B}Object.freeze(this)}static fromBytes(g,C=_.format){I(g,C);let B;if(C==="der"){const{r:V,s:G}=Ei.toSig(bt(g));return new q(V,G)}C==="recovered"&&(B=g[0],C="compact",g=g.subarray(1));const M=m.signature/2,O=g.subarray(0,M),$=g.subarray(M,M*2);return new q(o.fromBytes(O),o.fromBytes($),B)}static fromHex(g,C){return this.fromBytes(hl(g),C)}assertRecovery(){const{recovery:g}=this;if(g==null)throw new Error("invalid recovery id: must be present");return g}addRecoveryBit(g){return new q(this.r,this.s,g)}recoverPublicKey(g){const{r:C,s:B}=this,M=this.assertRecovery(),O=M===2||M===3?C+a:C;if(!i.isValid(O))throw new Error("invalid recovery id: sig.r+curve.n != R.x");const $=i.toBytes(O),V=r.fromBytes(Yr(Wy((M&1)===0),$)),G=o.inv(O),de=z(bt(g,void 0,"msgHash")),ce=o.create(-de*G),re=o.create(B*G),pe=r.BASE.multiplyUnsafe(ce).add(V.multiplyUnsafe(re));if(pe.is0())throw new Error("invalid recovery: point at infinify");return pe.assertValidity(),pe}hasHighS(){return T(this.s)}toBytes(g=_.format){if(U2(g),g==="der")return hl(Ei.hexFromSig(this));const{r:C,s:B}=this,M=o.toBytes(C),O=o.toBytes(B);return g==="recovered"?(D(),Yr(Uint8Array.of(this.assertRecovery()),M,O)):Yr(M,O)}toHex(g){return nu(this.toBytes(g))}}const L=t.bits2int||function(g){if(g.length>8192)throw new Error("input is too large");const C=vh(g),B=g.length*8-c;return B>0?C>>BigInt(B):C},z=t.bits2int_modN||function(g){return o.create(L(g))},Y=vp(c);function k(b){return O2("num < 2^"+c,b,Ts,Y),o.toBytes(b)}function x(b,g){return bt(b,void 0,"message"),g?bt(e(b),void 0,"prehashed message"):b}function F(b,g,C){const{lowS:B,prehash:M,extraEntropy:O}=q1(C,_);b=x(b,M);const $=z(b),V=o.fromBytes(g);if(!o.isValidNot0(V))throw new Error("invalid private key");const G=[k(V),k($)];if(O!=null&&O!==!1){const pe=O===!0?n(m.secretKey):O;G.push(bt(pe,void 0,"extraEntropy"))}const de=Yr(...G),ce=$;function re(pe){const _e=L(pe);if(!o.isValidNot0(_e))return;const $e=o.inv(_e),ge=r.BASE.multiply(_e).toAffine(),ke=o.create(ge.x);if(ke===Ts)return;const ht=o.create($e*o.create(ce+ke*V));if(ht===Ts)return;let qt=(ge.x===ke?0:2)|Number(ge.y&va),$t=ht;return B&&T(ht)&&($t=o.neg(ht),qt^=1),new q(ke,$t,R?void 0:qt)}return{seed:de,k2sig:re}}function j(b,g,C={}){const{seed:B,k2sig:M}=F(b,g,C);return RA(e.outputLen,o.BYTES,s)(B,M).toBytes(C.format)}function U(b,g,C,B={}){const{lowS:M,prehash:O,format:$}=q1(B,_);if(C=bt(C,void 0,"publicKey"),g=x(g,O),!_h(b)){const V=b instanceof q?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+V)}I(b,$);try{const V=q.fromBytes(b,$),G=r.fromBytes(C);if(M&&V.hasHighS())return!1;const{r:de,s:ce}=V,re=z(g),pe=o.inv(ce),_e=o.create(re*pe),$e=o.create(de*pe),ge=r.BASE.multiplyUnsafe(_e).add(G.multiplyUnsafe($e));return ge.is0()?!1:o.create(ge.x)===de}catch{return!1}}function y(b,g,C={}){const{prehash:B}=q1(C,_);return g=x(g,B),q.fromBytes(b,"recovered").recoverPublicKey(g).toBytes()}return Object.freeze({keygen:l,getPublicKey:h,getSharedSecret:f,utils:p,lengths:m,Point:r,sign:j,verify:U,recoverPublicKey:y,Signature:q,hash:e})}const Bp={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},tT={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},Ym=BigInt(2);function nT(r){const e=Bp.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,h=l*l*r%e,f=zt(h,t,e)*h%e,p=zt(f,t,e)*h%e,m=zt(p,Ym,e)*l%e,_=zt(m,s,e)*m%e,R=zt(_,i,e)*_%e,T=zt(R,a,e)*R%e,A=zt(T,c,e)*T%e,D=zt(A,a,e)*R%e,I=zt(D,t,e)*h%e,q=zt(I,o,e)*_%e,L=zt(q,n,e)*l%e,z=zt(L,Ym,e);if(!F2.eql(F2.sqr(z),r))throw new Error("Cannot find square root");return z}const F2=xh(Bp.p,{sqrt:nT}),rT=XI(Bp,{Fp:F2,endo:tT}),cd=eT(rT,yy);function sT(r,e,t,n){const s=$r.digest(t instanceof Uint8Array?t:t.subarray());if(Ip(s))return s.then(({digest:i})=>(n?.signal?.throwIfAborted(),cd.verify(e,i,r,{prehash:!1,format:"der"}))).catch(i=>{throw i.name==="AbortError"?i:new zm(String(i))});try{return n?.signal?.throwIfAborted(),cd.verify(e,s.digest,r,{prehash:!1,format:"der"})}catch(i){throw new zm(String(i))}}let iT=class{type="secp256k1";raw;_key;constructor(e){this._key=cT(e),this.raw=aT(this._key)}toMultihash(){return Kt.digest(Lp(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){return sT(this._key,t,e,n)}};function oT(r){return new iT(r)}function aT(r){return cd.Point.fromBytes(r).toBytes()}function cT(r){try{return cd.Point.fromBytes(r),r}catch(e){throw new J8(String(e))}}async function lT(r,e){return pI()}function uT(r,e){const{Type:t,Data:n}=gl.decode(r),s=n??new Uint8Array;switch(t){case tr.RSA:return WI(s,e);case tr.Ed25519:return hI(s);case tr.secp256k1:return oT(s);case tr.ECDSA:return sA(s);default:throw new Ex}}function Lp(r){return gl.encode({Type:tr[r.type],Data:r.raw})}let Op=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},fT=class extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}},dT=class extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};const hT=parseInt("11111",2),H2=parseInt("10000000",2),pT=parseInt("01111111",2),Qm={0:Cc,1:Cc,2:gT,3:bT,4:wT,5:yT,6:mT,16:Cc,22:Cc,48:Cc};function Zy(r,e={offset:0}){const t=r[e.offset]&hT;if(e.offset++,Qm[t]!=null)return Qm[t](r,e);throw new Error("No decoder for tag "+t)}function su(r,e){let t=0;if((r[e.offset]&H2)===H2){const n=r[e.offset]&pT;let s="0x";e.offset++;for(let i=0;i<n;i++,e.offset++)s+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=r[e.offset],e.offset++;return t}function Cc(r,e){su(r,e);const t=[];for(;!(e.offset>=r.byteLength);){const n=Zy(r,e);if(n===null)break;t.push(n)}return t}function gT(r,e){const t=su(r,e),n=e.offset,s=e.offset+t,i=[];for(let o=n;o<s;o++)o===n&&r[o]===0||i.push(r[o]);return e.offset+=t,Uint8Array.from(i)}function mT(r,e){const t=su(r,e),n=e.offset+t,s=r[e.offset];e.offset++;let i=0,o=0;s<40?(i=0,o=s):s<80?(i=1,o=s-40):(i=2,o=s-80);let a=`${i}.${o}`,c=[];for(;e.offset<n;){const l=r[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let h=0;for(let f=0;f<c.length;f++)h+=c[f]<<f*7;a+=`.${h}`,c=[]}}return a}function yT(r,e){return e.offset++,null}function bT(r,e){const t=su(r,e),n=r[e.offset];e.offset++;const s=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function wT(r,e){const t=su(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function _T(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);const t=new Ue;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function $p(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);const e=_T(r.byteLength);return new Ue(Uint8Array.from([e.byteLength|H2]),e)}function ET(r){const e=new Ue,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Ue(Uint8Array.from([2]),$p(e),e)}function vT(r){const e=Uint8Array.from([0]),t=new Ue(e,r);return new Ue(Uint8Array.from([3]),$p(t),t)}function B1(r,e=48){const t=new Ue;for(const n of r)t.append(n);return new Ue(Uint8Array.from([e]),$p(t),t)}async function xT(r,e,t,n){const s=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();const i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return n?.signal?.throwIfAborted(),i}const ST=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),AT=Uint8Array.from([6,5,43,129,4,0,34]),IT=Uint8Array.from([6,5,43,129,4,0,35]),TT={ext:!0,kty:"EC",crv:"P-256"},kT={ext:!0,kty:"EC",crv:"P-384"},CT={ext:!0,kty:"EC",crv:"P-521"},L1=32,O1=48,$1=66;function RT(r){const e=Zy(r);return PT(e)}function PT(r){const e=r[1][1][0],t=1;let n,s;if(e.byteLength===L1*2+1)return n=Le(e.subarray(t,t+L1),"base64url"),s=Le(e.subarray(t+L1),"base64url"),new M1({...TT,key_ops:["verify"],x:n,y:s});if(e.byteLength===O1*2+1)return n=Le(e.subarray(t,t+O1),"base64url"),s=Le(e.subarray(t+O1),"base64url"),new M1({...kT,key_ops:["verify"],x:n,y:s});if(e.byteLength===$1*2+1)return n=Le(e.subarray(t,t+$1),"base64url"),s=Le(e.subarray(t+$1),"base64url"),new M1({...CT,key_ops:["verify"],x:n,y:s});throw new Op(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function DT(r){return B1([ET(Uint8Array.from([1])),B1([qT(r.crv)],160),B1([vT(new Ue(Uint8Array.from([4]),Ge(r.x??"","base64url"),Ge(r.y??"","base64url")))],161)]).subarray()}function qT(r){if(r==="P-256")return ST;if(r==="P-384")return AT;if(r==="P-521")return IT;throw new Op(`Invalid curve ${r}`)}let M1=class{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=DT(this.jwk)),this._raw}toMultihash(){return Kt.digest(zp(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}async verify(e,t,n){return xT(this.jwk,t,e,n)}};function Sh(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function bo(r,e=""){if(!Number.isSafeInteger(r)||r<0){const t=e&&`"${e}" `;throw new Error(`${t}expected integer >= 0, got ${r}`)}}function wt(r,e,t=""){const n=Sh(r),s=r?.length,i=e!==void 0;if(!n||i&&s!==e){const o=t&&`"${t}" `,a=i?` of length ${e}`:"",c=n?`length=${s}`:`type=${typeof r}`;throw new Error(o+"expected Uint8Array"+a+", got "+c)}return r}function jy(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash must wrapped by utils.createHasher");bo(r.outputLen),bo(r.blockLen)}function ld(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function BT(r,e){wt(r,void 0,"digestInto() output");const t=e.outputLen;if(r.length<t)throw new Error('"digestInto() output" expected to be of length >='+t)}function Ma(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function N1(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function Ur(r,e){return r<<32-e|r>>>e}const Yy=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",LT=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function iu(r){if(wt(r),Yy)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=LT[r[t]];return e}const us={_0:48,_9:57,A:65,F:70,a:97,f:102};function Xm(r){if(r>=us._0&&r<=us._9)return r-us._0;if(r>=us.A&&r<=us.F)return r-(us.A-10);if(r>=us.a&&r<=us.f)return r-(us.a-10)}function ml(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(Yy)return Uint8Array.fromHex(r);const e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(t);for(let s=0,i=0;s<t;s++,i+=2){const o=Xm(r.charCodeAt(i)),a=Xm(r.charCodeAt(i+1));if(o===void 0||a===void 0){const c=r[i]+r[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[s]=o*16+a}return n}function Qr(...r){let e=0;for(let n=0;n<r.length;n++){const s=r[n];wt(s),e+=s.length}const t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){const i=r[n];t.set(i,s),s+=i.length}return t}function Qy(r,e={}){const t=(s,i)=>r(i).update(s).digest(),n=r(void 0);return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=s=>r(s),Object.assign(t,e),Object.freeze(t)}function Mp(r=32){const e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}const Xy=r=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,r])});function OT(r,e,t){return r&e^~r&t}function $T(r,e,t){return r&e^r&t^e&t}let Jy=class{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(e,t,n,s){this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=N1(this.buffer)}update(e){ld(this),wt(e);const{view:t,buffer:n,blockLen:s}=this,i=e.length;for(let o=0;o<i;){const a=Math.min(s-this.pos,i-o);if(a===s){const c=N1(e);for(;s<=i-o;o+=s)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){ld(this),BT(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:s,isLE:i}=this;let{pos:o}=this;t[o++]=128,Ma(this.buffer.subarray(o)),this.padOffset>s-o&&(this.process(n,0),o=0);for(let f=o;f<s;f++)t[f]=0;n.setBigUint64(s-8,BigInt(this.length*8),i),this.process(n,0);const a=N1(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");const l=c/4,h=this.get();if(l>h.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<l;f++)a.setUint32(4*f,h[f],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||=new this.constructor,e.set(...this.get());const{blockLen:t,buffer:n,length:s,finished:i,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=i,e.length=s,e.pos=a,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}};const zs=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),qn=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),Gu=BigInt(2**32-1),Jm=BigInt(32);function MT(r,e=!1){return e?{h:Number(r&Gu),l:Number(r>>Jm&Gu)}:{h:Number(r>>Jm&Gu)|0,l:Number(r&Gu)|0}}function NT(r,e=!1){const t=r.length;let n=new Uint32Array(t),s=new Uint32Array(t);for(let i=0;i<t;i++){const{h:o,l:a}=MT(r[i],e);[n[i],s[i]]=[o,a]}return[n,s]}const e6=(r,e,t)=>r>>>t,t6=(r,e,t)=>r<<32-t|e>>>t,Yo=(r,e,t)=>r>>>t|e<<32-t,Qo=(r,e,t)=>r<<32-t|e>>>t,Zu=(r,e,t)=>r<<64-t|e>>>t-32,ju=(r,e,t)=>r>>>t-32|e<<64-t;function fs(r,e,t,n){const s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}const UT=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),FT=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,HT=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),VT=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,KT=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),zT=(r,e,t,n,s,i)=>e+t+n+s+i+(r/2**32|0)|0,WT=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Ws=new Uint32Array(64);let GT=class extends Jy{constructor(e){super(64,e,8,!1)}get(){const{A:e,B:t,C:n,D:s,E:i,F:o,G:a,H:c}=this;return[e,t,n,s,i,o,a,c]}set(e,t,n,s,i,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let f=0;f<16;f++,t+=4)Ws[f]=e.getUint32(t,!1);for(let f=16;f<64;f++){const p=Ws[f-15],m=Ws[f-2],_=Ur(p,7)^Ur(p,18)^p>>>3,R=Ur(m,17)^Ur(m,19)^m>>>10;Ws[f]=R+Ws[f-7]+_+Ws[f-16]|0}let{A:n,B:s,C:i,D:o,E:a,F:c,G:l,H:h}=this;for(let f=0;f<64;f++){const p=Ur(a,6)^Ur(a,11)^Ur(a,25),m=h+p+OT(a,c,l)+WT[f]+Ws[f]|0,R=(Ur(n,2)^Ur(n,13)^Ur(n,22))+$T(n,s,i)|0;h=l,l=c,c=a,a=o+m|0,o=i,i=s,s=n,n=m+R|0}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,h=h+this.H|0,this.set(n,s,i,o,a,c,l,h)}roundClean(){Ma(Ws)}destroy(){this.set(0,0,0,0,0,0,0,0),Ma(this.buffer)}},ZT=class extends GT{A=zs[0]|0;B=zs[1]|0;C=zs[2]|0;D=zs[3]|0;E=zs[4]|0;F=zs[5]|0;G=zs[6]|0;H=zs[7]|0;constructor(){super(32)}};const eb=NT(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),jT=eb[0],YT=eb[1],Gs=new Uint32Array(80),Zs=new Uint32Array(80);let QT=class extends Jy{constructor(e){super(128,e,16,!1)}get(){const{Ah:e,Al:t,Bh:n,Bl:s,Ch:i,Cl:o,Dh:a,Dl:c,Eh:l,El:h,Fh:f,Fl:p,Gh:m,Gl:_,Hh:R,Hl:T}=this;return[e,t,n,s,i,o,a,c,l,h,f,p,m,_,R,T]}set(e,t,n,s,i,o,a,c,l,h,f,p,m,_,R,T){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=h|0,this.Fh=f|0,this.Fl=p|0,this.Gh=m|0,this.Gl=_|0,this.Hh=R|0,this.Hl=T|0}process(e,t){for(let I=0;I<16;I++,t+=4)Gs[I]=e.getUint32(t),Zs[I]=e.getUint32(t+=4);for(let I=16;I<80;I++){const q=Gs[I-15]|0,L=Zs[I-15]|0,z=Yo(q,L,1)^Yo(q,L,8)^e6(q,L,7),Y=Qo(q,L,1)^Qo(q,L,8)^t6(q,L,7),k=Gs[I-2]|0,x=Zs[I-2]|0,F=Yo(k,x,19)^Zu(k,x,61)^e6(k,x,6),j=Qo(k,x,19)^ju(k,x,61)^t6(k,x,6),U=HT(Y,j,Zs[I-7],Zs[I-16]),y=VT(U,z,F,Gs[I-7],Gs[I-16]);Gs[I]=y|0,Zs[I]=U|0}let{Ah:n,Al:s,Bh:i,Bl:o,Ch:a,Cl:c,Dh:l,Dl:h,Eh:f,El:p,Fh:m,Fl:_,Gh:R,Gl:T,Hh:A,Hl:D}=this;for(let I=0;I<80;I++){const q=Yo(f,p,14)^Yo(f,p,18)^Zu(f,p,41),L=Qo(f,p,14)^Qo(f,p,18)^ju(f,p,41),z=f&m^~f&R,Y=p&_^~p&T,k=KT(D,L,Y,YT[I],Zs[I]),x=zT(k,A,q,z,jT[I],Gs[I]),F=k|0,j=Yo(n,s,28)^Zu(n,s,34)^Zu(n,s,39),U=Qo(n,s,28)^ju(n,s,34)^ju(n,s,39),y=n&i^n&a^i&a,b=s&o^s&c^o&c;A=R|0,D=T|0,R=m|0,T=_|0,m=f|0,_=p|0,{h:f,l:p}=fs(l|0,h|0,x|0,F|0),l=a|0,h=c|0,a=i|0,c=o|0,i=n|0,o=s|0;const g=UT(F,U,b);n=FT(g,x,j,y),s=g|0}({h:n,l:s}=fs(this.Ah|0,this.Al|0,n|0,s|0)),{h:i,l:o}=fs(this.Bh|0,this.Bl|0,i|0,o|0),{h:a,l:c}=fs(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:h}=fs(this.Dh|0,this.Dl|0,l|0,h|0),{h:f,l:p}=fs(this.Eh|0,this.El|0,f|0,p|0),{h:m,l:_}=fs(this.Fh|0,this.Fl|0,m|0,_|0),{h:R,l:T}=fs(this.Gh|0,this.Gl|0,R|0,T|0),{h:A,l:D}=fs(this.Hh|0,this.Hl|0,A|0,D|0),this.set(n,s,i,o,a,c,l,h,f,p,m,_,R,T,A,D)}roundClean(){Ma(Gs,Zs)}destroy(){Ma(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},XT=class extends QT{Ah=qn[0]|0;Al=qn[1]|0;Bh=qn[2]|0;Bl=qn[3]|0;Ch=qn[4]|0;Cl=qn[5]|0;Dh=qn[6]|0;Dl=qn[7]|0;Eh=qn[8]|0;El=qn[9]|0;Fh=qn[10]|0;Fl=qn[11]|0;Gh=qn[12]|0;Gl=qn[13]|0;Hh=qn[14]|0;Hl=qn[15]|0;constructor(){super(64)}};const JT=Qy(()=>new ZT,Xy(1)),ek=Qy(()=>new XT,Xy(3));const Np=BigInt(0),V2=BigInt(1);function wo(r,e=""){if(typeof r!="boolean"){const t=e&&`"${e}" `;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function tb(r){if(typeof r=="bigint"){if(!Kf(r))throw new Error("positive bigint expected, got "+r)}else bo(r);return r}function Yu(r){const e=tb(r).toString(16);return e.length&1?"0"+e:e}function nb(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?Np:BigInt("0x"+r)}function Ah(r){return nb(iu(r))}function yl(r){return nb(iu(K2(wt(r)).reverse()))}function Up(r,e){bo(e),r=tb(r);const t=ml(r.toString(16).padStart(e*2,"0"));if(t.length!==e)throw new Error("number too large");return t}function rb(r,e){return Up(r,e).reverse()}function K2(r){return Uint8Array.from(r)}const Kf=r=>typeof r=="bigint"&&Np<=r;function tk(r,e,t){return Kf(r)&&Kf(e)&&Kf(t)&&e<=r&&r<t}function z2(r,e,t,n){if(!tk(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function nk(r){let e;for(e=0;r>Np;r>>=V2,e+=1);return e}const Fp=r=>(V2<<BigInt(r))-V2;function rk(r,e,t){if(bo(r,"hashLen"),bo(e,"qByteLen"),typeof t!="function")throw new Error("hmacFn must be a function");const n=T=>new Uint8Array(T),s=Uint8Array.of(),i=Uint8Array.of(0),o=Uint8Array.of(1),a=1e3;let c=n(r),l=n(r),h=0;const f=()=>{c.fill(1),l.fill(0),h=0},p=(...T)=>t(l,Qr(c,...T)),m=(T=s)=>{l=p(i,T),c=p(),T.length!==0&&(l=p(o,T),c=p())},_=()=>{if(h++>=a)throw new Error("drbg: tried max amount of iterations");let T=0;const A=[];for(;T<e;){c=p();const D=c.slice();A.push(D),T+=c.length}return Qr(...A)};return(T,A)=>{f(),m(T);let D;for(;!(D=A(_()));)m();return f(),D}}function ou(r,e={},t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(i,o,a){const c=r[i];if(a&&c===void 0)return;const l=typeof c;if(l!==o||c===null)throw new Error(`param "${i}" is invalid: expected ${o}, got ${l}`)}const s=(i,o)=>Object.entries(i).forEach(([a,c])=>n(a,c,o));s(e,!1),s(t,!0)}function ud(r){const e=new WeakMap;return(t,...n)=>{const s=e.get(t);if(s!==void 0)return s;const i=r(t,...n);return e.set(t,i),i}}const nr=BigInt(0),xn=BigInt(1),Wi=BigInt(2),sb=BigInt(3),ib=BigInt(4),ob=BigInt(5),sk=BigInt(7),ab=BigInt(8),ik=BigInt(9),cb=BigInt(16);function sn(r,e){const t=r%e;return t>=nr?t:e+t}function Wt(r,e,t){let n=r;for(;e-- >nr;)n*=n,n%=t;return n}function n6(r,e){if(r===nr)throw new Error("invert: expected non-zero number");if(e<=nr)throw new Error("invert: expected positive modulus, got "+e);let t=sn(r,e),n=e,s=nr,i=xn;for(;t!==nr;){const a=n/t,c=n%t,l=s-i*a;n=t,t=c,s=i,i=l}if(n!==xn)throw new Error("invert: does not exist");return sn(s,e)}function Hp(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function lb(r,e){const t=(r.ORDER+xn)/ib,n=r.pow(e,t);return Hp(r,n,e),n}function ok(r,e){const t=(r.ORDER-ob)/ab,n=r.mul(e,Wi),s=r.pow(n,t),i=r.mul(e,s),o=r.mul(r.mul(i,Wi),s),a=r.mul(i,r.sub(o,r.ONE));return Hp(r,a,e),a}function ak(r){const e=Ih(r),t=ub(r),n=t(e,e.neg(e.ONE)),s=t(e,n),i=t(e,e.neg(n)),o=(r+sk)/cb;return(a,c)=>{let l=a.pow(c,o),h=a.mul(l,n);const f=a.mul(l,s),p=a.mul(l,i),m=a.eql(a.sqr(h),c),_=a.eql(a.sqr(f),c);l=a.cmov(l,h,m),h=a.cmov(p,f,_);const R=a.eql(a.sqr(h),c),T=a.cmov(l,h,R);return Hp(a,T,c),T}}function ub(r){if(r<sb)throw new Error("sqrt is not defined for small field");let e=r-xn,t=0;for(;e%Wi===nr;)e/=Wi,t++;let n=Wi;const s=Ih(r);for(;r6(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return lb;let i=s.pow(n,e);const o=(e+xn)/Wi;return function(c,l){if(c.is0(l))return l;if(r6(c,l)!==1)throw new Error("Cannot find square root");let h=t,f=c.mul(c.ONE,i),p=c.pow(l,e),m=c.pow(l,o);for(;!c.eql(p,c.ONE);){if(c.is0(p))return c.ZERO;let _=1,R=c.sqr(p);for(;!c.eql(R,c.ONE);)if(_++,R=c.sqr(R),_===h)throw new Error("Cannot find square root");const T=xn<<BigInt(h-_-1),A=c.pow(f,T);h=_,f=c.sqr(A),p=c.mul(p,f),m=c.mul(m,A)}return m}}function ck(r){return r%ib===sb?lb:r%ab===ob?ok:r%cb===ik?ak(r):ub(r)}const lk=(r,e)=>(sn(r,e)&xn)===xn,uk=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function fk(r){const e={ORDER:"bigint",BYTES:"number",BITS:"number"},t=uk.reduce((n,s)=>(n[s]="function",n),e);return ou(r,t),r}function dk(r,e,t){if(t<nr)throw new Error("invalid exponent, negatives unsupported");if(t===nr)return r.ONE;if(t===xn)return e;let n=r.ONE,s=e;for(;t>nr;)t&xn&&(n=r.mul(n,s)),s=r.sqr(s),t>>=xn;return n}function fb(r,e,t=!1){const n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((o,a,c)=>r.is0(a)?o:(n[c]=o,r.mul(o,a)),r.ONE),i=r.inv(s);return e.reduceRight((o,a,c)=>r.is0(a)?o:(n[c]=r.mul(o,n[c]),r.mul(o,a)),i),n}function r6(r,e){const t=(r.ORDER-xn)/Wi,n=r.pow(e,t),s=r.eql(n,r.ONE),i=r.eql(n,r.ZERO),o=r.eql(n,r.neg(r.ONE));if(!s&&!i&&!o)throw new Error("invalid Legendre symbol result");return s?1:i?0:-1}function hk(r,e){e!==void 0&&bo(e);const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}let pk=class{ORDER;BITS;BYTES;isLE;ZERO=nr;ONE=xn;_lengths;_sqrt;_mod;constructor(e,t={}){if(e<=nr)throw new Error("invalid field: expected ORDER > 0, got "+e);let n;this.isLE=!1,t!=null&&typeof t=="object"&&(typeof t.BITS=="number"&&(n=t.BITS),typeof t.sqrt=="function"&&(this.sqrt=t.sqrt),typeof t.isLE=="boolean"&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),typeof t.modFromBytes=="boolean"&&(this._mod=t.modFromBytes));const{nBitLength:s,nByteLength:i}=hk(e,n);if(i>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=s,this.BYTES=i,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return sn(e,this.ORDER)}isValid(e){if(typeof e!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof e);return nr<=e&&e<this.ORDER}is0(e){return e===nr}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&xn)===xn}neg(e){return sn(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return sn(e*e,this.ORDER)}add(e,t){return sn(e+t,this.ORDER)}sub(e,t){return sn(e-t,this.ORDER)}mul(e,t){return sn(e*t,this.ORDER)}pow(e,t){return dk(this,e,t)}div(e,t){return sn(e*n6(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return n6(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=ck(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?rb(e,this.BYTES):Up(e,this.BYTES)}fromBytes(e,t=!1){wt(e);const{_lengths:n,BYTES:s,isLE:i,ORDER:o,_mod:a}=this;if(n){if(!n.includes(e.length)||e.length>s)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+e.length);const l=new Uint8Array(s);l.set(e,i?0:l.length-e.length),e=l}if(e.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+e.length);let c=i?yl(e):Ah(e);if(a&&(c=sn(c,o)),!t&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(e){return fb(this,e)}cmov(e,t,n){return n?t:e}};function Ih(r,e={}){return new pk(r,e)}function db(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function hb(r){const e=db(r);return e+Math.ceil(e/2)}function gk(r,e,t=!1){wt(r);const n=r.length,s=db(e),i=hb(e);if(n<16||n<i||n>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+n);const o=t?yl(r):Ah(r),a=sn(o,e-xn)+xn;return t?rb(a,s):Up(a,s)}const Na=BigInt(0),Gi=BigInt(1);function fd(r,e){const t=e.negate();return r?t:e}function Gc(r,e){const t=fb(r.Fp,e.map(n=>n.Z));return e.map((n,s)=>r.fromAffine(n.toAffine(t[s])))}function pb(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function U1(r,e){pb(r,e);const t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,i=Fp(r),o=BigInt(r);return{windows:t,windowSize:n,mask:i,maxNumber:s,shiftBy:o}}function s6(r,e,t){const{windowSize:n,mask:s,maxNumber:i,shiftBy:o}=t;let a=Number(r&s),c=r>>o;a>n&&(a-=i,c+=Gi);const l=e*n,h=l+Math.abs(a)-1,f=a===0,p=a<0,m=e%2!==0;return{nextN:c,offset:h,isZero:f,isNeg:p,isNegF:m,offsetF:l}}const F1=new WeakMap,gb=new WeakMap;function H1(r){return gb.get(r)||1}function i6(r){if(r!==Na)throw new Error("invalid wNAF")}let mb=class{BASE;ZERO;Fn;bits;constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let s=e;for(;t>Na;)t&Gi&&(n=n.add(s)),s=s.double(),t>>=Gi;return n}precomputeWindow(e,t){const{windows:n,windowSize:s}=U1(t,this.bits),i=[];let o=e,a=o;for(let c=0;c<n;c++){a=o,i.push(a);for(let l=1;l<s;l++)a=a.add(o),i.push(a);o=a.double()}return i}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,i=this.BASE;const o=U1(e,this.bits);for(let a=0;a<o.windows;a++){const{nextN:c,offset:l,isZero:h,isNeg:f,isNegF:p,offsetF:m}=s6(n,a,o);n=c,h?i=i.add(fd(p,t[m])):s=s.add(fd(f,t[l]))}return i6(n),{p:s,f:i}}wNAFUnsafe(e,t,n,s=this.ZERO){const i=U1(e,this.bits);for(let o=0;o<i.windows&&n!==Na;o++){const{nextN:a,offset:c,isZero:l,isNeg:h}=s6(n,o,i);if(n=a,!l){const f=t[c];s=s.add(h?f.negate():f)}}return i6(n),s}getPrecomputes(e,t,n){let s=F1.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(s=n(s)),F1.set(t,s))),s}cached(e,t,n){const s=H1(e);return this.wNAF(s,this.getPrecomputes(s,e,n),t)}unsafe(e,t,n,s){const i=H1(e);return i===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(i,this.getPrecomputes(i,e,n),t,s)}createCache(e,t){pb(t,this.bits),gb.set(e,t),F1.delete(e)}hasCache(e){return H1(e)!==1}};function mk(r,e,t,n){let s=e,i=r.ZERO,o=r.ZERO;for(;t>Na||n>Na;)t&Gi&&(i=i.add(s)),n&Gi&&(o=o.add(s)),s=s.double(),t>>=Gi,n>>=Gi;return{p1:i,p2:o}}function o6(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return fk(e),e}else return Ih(r,{isLE:t})}function yb(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(const c of["p","n","h"]){const l=e[c];if(!(typeof l=="bigint"&&l>Na))throw new Error(`CURVE.${c} must be positive bigint`)}const s=o6(e.p,t.Fp,n),i=o6(e.n,t.Fn,n),a=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(const c of a)if(!s.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:i}}function bb(r,e){return function(n){const s=r(n);return{secretKey:s,publicKey:e(s)}}}const js=BigInt(0),hn=BigInt(1),V1=BigInt(2),yk=BigInt(8);function bk(r,e,t,n){const s=r.sqr(t),i=r.sqr(n),o=r.add(r.mul(e.a,s),i),a=r.add(r.ONE,r.mul(e.d,r.mul(s,i)));return r.eql(o,a)}function wk(r,e={}){const t=yb("edwards",r,e,e.FpFnLE),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o}=i;ou(e,{},{uvRatio:"function"});const a=V1<<BigInt(s.BYTES*8)-hn,c=T=>n.create(T),l=e.uvRatio||((T,A)=>{try{return{isValid:!0,value:n.sqrt(n.div(T,A))}}catch{return{isValid:!1,value:js}}});if(!bk(n,i,i.Gx,i.Gy))throw new Error("bad curve params: generator point");function h(T,A,D=!1){const I=D?hn:js;return z2("coordinate "+T,A,I,a),A}function f(T){if(!(T instanceof _))throw new Error("EdwardsPoint expected")}const p=ud((T,A)=>{const{X:D,Y:I,Z:q}=T,L=T.is0();A==null&&(A=L?yk:n.inv(q));const z=c(D*A),Y=c(I*A),k=n.mul(q,A);if(L)return{x:js,y:hn};if(k!==hn)throw new Error("invZ was invalid");return{x:z,y:Y}}),m=ud(T=>{const{a:A,d:D}=i;if(T.is0())throw new Error("bad point: ZERO");const{X:I,Y:q,Z:L,T:z}=T,Y=c(I*I),k=c(q*q),x=c(L*L),F=c(x*x),j=c(Y*A),U=c(x*c(j+k)),y=c(F+c(D*c(Y*k)));if(U!==y)throw new Error("bad point: equation left != right (1)");const b=c(I*q),g=c(L*z);if(b!==g)throw new Error("bad point: equation left != right (2)");return!0});class _{static BASE=new _(i.Gx,i.Gy,hn,c(i.Gx*i.Gy));static ZERO=new _(js,hn,hn,js);static Fp=n;static Fn=s;X;Y;Z;T;constructor(A,D,I,q){this.X=h("x",A),this.Y=h("y",D),this.Z=h("z",I,!0),this.T=h("t",q),Object.freeze(this)}static CURVE(){return i}static fromAffine(A){if(A instanceof _)throw new Error("extended point not allowed");const{x:D,y:I}=A||{};return h("x",D),h("y",I),new _(D,I,hn,c(D*I))}static fromBytes(A,D=!1){const I=n.BYTES,{a:q,d:L}=i;A=K2(wt(A,I,"point")),wo(D,"zip215");const z=K2(A),Y=A[I-1];z[I-1]=Y&-129;const k=yl(z),x=D?a:n.ORDER;z2("point.y",k,js,x);const F=c(k*k),j=c(F-hn),U=c(L*F-q);let{isValid:y,value:b}=l(j,U);if(!y)throw new Error("bad point: invalid y coordinate");const g=(b&hn)===hn,C=(Y&128)!==0;if(!D&&b===js&&C)throw new Error("bad point: x=0 and x_0=1");return C!==g&&(b=c(-b)),_.fromAffine({x:b,y:k})}static fromHex(A,D=!1){return _.fromBytes(ml(A),D)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(A=8,D=!0){return R.createCache(this,A),D||this.multiply(V1),this}assertValidity(){m(this)}equals(A){f(A);const{X:D,Y:I,Z:q}=this,{X:L,Y:z,Z:Y}=A,k=c(D*Y),x=c(L*q),F=c(I*Y),j=c(z*q);return k===x&&F===j}is0(){return this.equals(_.ZERO)}negate(){return new _(c(-this.X),this.Y,this.Z,c(-this.T))}double(){const{a:A}=i,{X:D,Y:I,Z:q}=this,L=c(D*D),z=c(I*I),Y=c(V1*c(q*q)),k=c(A*L),x=D+I,F=c(c(x*x)-L-z),j=k+z,U=j-Y,y=k-z,b=c(F*U),g=c(j*y),C=c(F*y),B=c(U*j);return new _(b,g,B,C)}add(A){f(A);const{a:D,d:I}=i,{X:q,Y:L,Z:z,T:Y}=this,{X:k,Y:x,Z:F,T:j}=A,U=c(q*k),y=c(L*x),b=c(Y*I*j),g=c(z*F),C=c((q+L)*(k+x)-U-y),B=g-b,M=g+b,O=c(y-D*U),$=c(C*B),V=c(M*O),G=c(C*O),de=c(B*M);return new _($,V,de,G)}subtract(A){return this.add(A.negate())}multiply(A){if(!s.isValidNot0(A))throw new Error("invalid scalar: expected 1 <= sc < curve.n");const{p:D,f:I}=R.cached(this,A,q=>Gc(_,q));return Gc(_,[D,I])[0]}multiplyUnsafe(A,D=_.ZERO){if(!s.isValid(A))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return A===js?_.ZERO:this.is0()||A===hn?this:R.unsafe(this,A,I=>Gc(_,I),D)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}isTorsionFree(){return R.unsafe(this,i.n).is0()}toAffine(A){return p(this,A)}clearCofactor(){return o===hn?this:this.multiplyUnsafe(o)}toBytes(){const{x:A,y:D}=this.toAffine(),I=n.toBytes(D);return I[I.length-1]|=A&hn?128:0,I}toHex(){return iu(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const R=new mb(_,s.BITS);return _.BASE.precompute(8),_}function _k(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');ou(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:n}=t,{BASE:s,Fp:i,Fn:o}=r,a=t.randomBytes||Mp,c=t.adjustScalarBytes||(k=>k),l=t.domain||((k,x,F)=>{if(wo(F,"phflag"),x.length||F)throw new Error("Contexts/pre-hash are not supported");return k});function h(k){return o.create(yl(k))}function f(k){const x=I.secretKey;wt(k,I.secretKey,"secretKey");const F=wt(e(k),2*x,"hashedSecretKey"),j=c(F.slice(0,x)),U=F.slice(x,2*x),y=h(j);return{head:j,prefix:U,scalar:y}}function p(k){const{head:x,prefix:F,scalar:j}=f(k),U=s.multiply(j),y=U.toBytes();return{head:x,prefix:F,scalar:j,point:U,pointBytes:y}}function m(k){return p(k).pointBytes}function _(k=Uint8Array.of(),...x){const F=Qr(...x);return h(e(l(F,wt(k,void 0,"context"),!!n)))}function R(k,x,F={}){k=wt(k,void 0,"message"),n&&(k=n(k));const{prefix:j,scalar:U,pointBytes:y}=p(x),b=_(F.context,j,k),g=s.multiply(b).toBytes(),C=_(F.context,g,y,k),B=o.create(b+C*U);if(!o.isValid(B))throw new Error("sign failed: invalid s");const M=Qr(g,o.toBytes(B));return wt(M,I.signature,"result")}const T={zip215:!0};function A(k,x,F,j=T){const{context:U,zip215:y}=j,b=I.signature;k=wt(k,b,"signature"),x=wt(x,void 0,"message"),F=wt(F,I.publicKey,"publicKey"),y!==void 0&&wo(y,"zip215"),n&&(x=n(x));const g=b/2,C=k.subarray(0,g),B=yl(k.subarray(g,b));let M,O,$;try{M=r.fromBytes(F,y),O=r.fromBytes(C,y),$=s.multiplyUnsafe(B)}catch{return!1}if(!y&&M.isSmallOrder())return!1;const V=_(U,O.toBytes(),M.toBytes(),x);return O.add(M.multiplyUnsafe(V)).subtract($).clearCofactor().is0()}const D=i.BYTES,I={secretKey:D,publicKey:D,signature:2*D,seed:D};function q(k=a(I.seed)){return wt(k,I.seed,"seed")}function L(k){return Sh(k)&&k.length===o.BYTES}function z(k,x){try{return!!r.fromBytes(k,x)}catch{return!1}}const Y={getExtendedPublicKey:p,randomSecretKey:q,isValidSecretKey:L,isValidPublicKey:z,toMontgomery(k){const{y:x}=r.fromBytes(k),F=I.publicKey,j=F===32;if(!j&&F!==57)throw new Error("only defined for 25519 and 448");const U=j?i.div(hn+x,hn-x):i.div(x-hn,x+hn);return i.toBytes(U)},toMontgomerySecret(k){const x=I.secretKey;wt(k,x);const F=e(k.subarray(0,x));return c(F).subarray(0,x)}};return Object.freeze({keygen:bb(q,m),getPublicKey:m,sign:R,verify:A,utils:Y,Point:r,lengths:I})}const Ek=BigInt(1),a6=BigInt(2),vk=BigInt(5),xk=BigInt(8),Vp=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),Sk={p:Vp,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:xk,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function Ak(r){const e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),i=Vp,a=r*r%i*r%i,c=Wt(a,a6,i)*a%i,l=Wt(c,Ek,i)*r%i,h=Wt(l,vk,i)*l%i,f=Wt(h,e,i)*h%i,p=Wt(f,t,i)*f%i,m=Wt(p,n,i)*p%i,_=Wt(m,s,i)*m%i,R=Wt(_,s,i)*m%i,T=Wt(R,e,i)*h%i;return{pow_p_5_8:Wt(T,a6,i)*r%i,b2:a}}function Ik(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}const c6=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function Tk(r,e){const t=Vp,n=sn(e*e*e,t),s=sn(n*n*e,t),i=Ak(r*s).pow_p_5_8;let o=sn(r*n*i,t);const a=sn(e*o*o,t),c=o,l=sn(o*c6,t),h=a===r,f=a===sn(-r,t),p=a===sn(-r*c6,t);return h&&(o=c),(f||p)&&(o=l),lk(o,t)&&(o=sn(-o,t)),{isValid:h||f,value:o}}const kk=wk(Sk,{uvRatio:Tk});function Ck(r){return _k(kk,ek,Object.assign({adjustScalarBytes:Ik},r))}const Rk=Ck({});let l6=class extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}},Pk=class extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}};var W2={get(r=globalThis){const e=r.crypto;if(e?.subtle==null)throw new Pk("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};const wb=32;let K1;const Dk=(async()=>{try{return await W2.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();async function qk(r,e,t){if(r.buffer instanceof ArrayBuffer){const n=await W2.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await W2.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function Bk(r,e,t){return Rk.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function Lk(r,e,t){return K1==null&&(K1=await Dk),K1?qk(r,e,t):Bk(r,e,t)}function _b(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}let Ok=class{type="Ed25519";raw;constructor(e){this.raw=Eb(e,wb)}toMultihash(){return Kt.digest(zp(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();const s=Lk(this.raw,t,e);return _b(s)?s.then(i=>(n?.signal?.throwIfAborted(),i)):s}};function $k(r){return r=Eb(r,wb),new Ok(r)}function Eb(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new Op(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}var xr;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(xr||(xr={}));var G2;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(G2||(G2={}));(function(r){r.codec=()=>Rn(G2)})(xr||(xr={}));var dd;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),xr.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=xr.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(dd||(dd={}));var u6;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),xr.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=xr.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(u6||(u6={}));let vb=class{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(e,t){if(jy(e),wt(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const n=this.blockLen,s=new Uint8Array(n);s.set(t.length>n?e.create().update(t).digest():t);for(let i=0;i<s.length;i++)s[i]^=54;this.iHash.update(s),this.oHash=e.create();for(let i=0;i<s.length;i++)s[i]^=106;this.oHash.update(s),Ma(s)}update(e){return ld(this),this.iHash.update(e),this}digestInto(e){ld(this),wt(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||=Object.create(Object.getPrototypeOf(this),{});const{oHash:t,iHash:n,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const xb=(r,e,t)=>new vb(r,e).update(t).digest();xb.create=(r,e)=>new vb(r,e);const f6=(r,e)=>(r+(r>=0?e:-e)/Sb)/e;function Mk(r,e,t){const[[n,s],[i,o]]=e,a=f6(o*r,t),c=f6(-s*r,t);let l=r-a*n-c*i,h=-a*s-c*o;const f=l<ks,p=h<ks;f&&(l=-l),p&&(h=-h);const m=Fp(Math.ceil(nk(t)/2))+xa;if(l<ks||l>=m||h<ks||h>=m)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:f,k1:l,k2neg:p,k2:h}}function Z2(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function z1(r,e){const t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return wo(t.lowS,"lowS"),wo(t.prehash,"prehash"),t.format!==void 0&&Z2(t.format),t}let Nk=class extends Error{constructor(e=""){super(e)}};const vi={Err:Nk,_tlv:{encode:(r,e)=>{const{Err:t}=vi;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const n=e.length/2,s=Yu(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");const i=n>127?Yu(s.length/2|128):"";return Yu(r)+i+s+e},decode(r,e){const{Err:t}=vi;let n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");const s=e[n++],i=!!(s&128);let o=0;if(!i)o=s;else{const c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const l=e.subarray(n,n+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const h of l)o=o<<8|h;if(n+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const a=e.subarray(n,n+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+o)}}},_int:{encode(r){const{Err:e}=vi;if(r<ks)throw new e("integer: negative integers are not allowed");let t=Yu(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){const{Err:e}=vi;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Ah(r)}},toSig(r){const{Err:e,_int:t,_tlv:n}=vi,s=wt(r,void 0,"signature"),{v:i,l:o}=n.decode(48,s);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=n.decode(2,i),{v:l,l:h}=n.decode(2,c);if(h.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(r){const{_tlv:e,_int:t}=vi,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),i=n+s;return e.encode(48,i)}},ks=BigInt(0),xa=BigInt(1),Sb=BigInt(2),Qu=BigInt(3),Uk=BigInt(4);function Fk(r,e={}){const t=yb("weierstrass",r,e),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o,n:a}=i;ou(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});const{endo:c}=e;if(c&&(!n.is0(i.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const l=Ib(n,s);function h(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function f(U,y,b){const{x:g,y:C}=y.toAffine(),B=n.toBytes(g);if(wo(b,"isCompressed"),b){h();const M=!n.isOdd(C);return Qr(Ab(M),B)}else return Qr(Uint8Array.of(4),B,n.toBytes(C))}function p(U){wt(U,void 0,"Point");const{publicKey:y,publicKeyUncompressed:b}=l,g=U.length,C=U[0],B=U.subarray(1);if(g===y&&(C===2||C===3)){const M=n.fromBytes(B);if(!n.isValid(M))throw new Error("bad point: is not on curve, wrong x");const O=R(M);let $;try{$=n.sqrt(O)}catch(de){const ce=de instanceof Error?": "+de.message:"";throw new Error("bad point: is not on curve, sqrt error"+ce)}h();const V=n.isOdd($);return(C&1)===1!==V&&($=n.neg($)),{x:M,y:$}}else if(g===b&&C===4){const M=n.BYTES,O=n.fromBytes(B.subarray(0,M)),$=n.fromBytes(B.subarray(M,M*2));if(!T(O,$))throw new Error("bad point: is not on curve");return{x:O,y:$}}else throw new Error(`bad point: got length ${g}, expected compressed=${y} or uncompressed=${b}`)}const m=e.toBytes||f,_=e.fromBytes||p;function R(U){const y=n.sqr(U),b=n.mul(y,U);return n.add(n.add(b,n.mul(U,i.a)),i.b)}function T(U,y){const b=n.sqr(y),g=R(U);return n.eql(b,g)}if(!T(i.Gx,i.Gy))throw new Error("bad curve params: generator point");const A=n.mul(n.pow(i.a,Qu),Uk),D=n.mul(n.sqr(i.b),BigInt(27));if(n.is0(n.add(A,D)))throw new Error("bad curve params: a or b");function I(U,y,b=!1){if(!n.isValid(y)||b&&n.is0(y))throw new Error(`bad point coordinate ${U}`);return y}function q(U){if(!(U instanceof x))throw new Error("Weierstrass Point expected")}function L(U){if(!c||!c.basises)throw new Error("no endo");return Mk(U,c.basises,s.ORDER)}const z=ud((U,y)=>{const{X:b,Y:g,Z:C}=U;if(n.eql(C,n.ONE))return{x:b,y:g};const B=U.is0();y==null&&(y=B?n.ONE:n.inv(C));const M=n.mul(b,y),O=n.mul(g,y),$=n.mul(C,y);if(B)return{x:n.ZERO,y:n.ZERO};if(!n.eql($,n.ONE))throw new Error("invZ was invalid");return{x:M,y:O}}),Y=ud(U=>{if(U.is0()){if(e.allowInfinityPoint&&!n.is0(U.Y))return;throw new Error("bad point: ZERO")}const{x:y,y:b}=U.toAffine();if(!n.isValid(y)||!n.isValid(b))throw new Error("bad point: x or y not field elements");if(!T(y,b))throw new Error("bad point: equation left != right");if(!U.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function k(U,y,b,g,C){return b=new x(n.mul(b.X,U),b.Y,b.Z),y=fd(g,y),b=fd(C,b),y.add(b)}class x{static BASE=new x(i.Gx,i.Gy,n.ONE);static ZERO=new x(n.ZERO,n.ONE,n.ZERO);static Fp=n;static Fn=s;X;Y;Z;constructor(y,b,g){this.X=I("x",y),this.Y=I("y",b,!0),this.Z=I("z",g),Object.freeze(this)}static CURVE(){return i}static fromAffine(y){const{x:b,y:g}=y||{};if(!y||!n.isValid(b)||!n.isValid(g))throw new Error("invalid affine point");if(y instanceof x)throw new Error("projective point not allowed");return n.is0(b)&&n.is0(g)?x.ZERO:new x(b,g,n.ONE)}static fromBytes(y){const b=x.fromAffine(_(wt(y,void 0,"point")));return b.assertValidity(),b}static fromHex(y){return x.fromBytes(ml(y))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(y=8,b=!0){return j.createCache(this,y),b||this.multiply(Qu),this}assertValidity(){Y(this)}hasEvenY(){const{y}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(y)}equals(y){q(y);const{X:b,Y:g,Z:C}=this,{X:B,Y:M,Z:O}=y,$=n.eql(n.mul(b,O),n.mul(B,C)),V=n.eql(n.mul(g,O),n.mul(M,C));return $&&V}negate(){return new x(this.X,n.neg(this.Y),this.Z)}double(){const{a:y,b}=i,g=n.mul(b,Qu),{X:C,Y:B,Z:M}=this;let O=n.ZERO,$=n.ZERO,V=n.ZERO,G=n.mul(C,C),de=n.mul(B,B),ce=n.mul(M,M),re=n.mul(C,B);return re=n.add(re,re),V=n.mul(C,M),V=n.add(V,V),O=n.mul(y,V),$=n.mul(g,ce),$=n.add(O,$),O=n.sub(de,$),$=n.add(de,$),$=n.mul(O,$),O=n.mul(re,O),V=n.mul(g,V),ce=n.mul(y,ce),re=n.sub(G,ce),re=n.mul(y,re),re=n.add(re,V),V=n.add(G,G),G=n.add(V,G),G=n.add(G,ce),G=n.mul(G,re),$=n.add($,G),ce=n.mul(B,M),ce=n.add(ce,ce),G=n.mul(ce,re),O=n.sub(O,G),V=n.mul(ce,de),V=n.add(V,V),V=n.add(V,V),new x(O,$,V)}add(y){q(y);const{X:b,Y:g,Z:C}=this,{X:B,Y:M,Z:O}=y;let $=n.ZERO,V=n.ZERO,G=n.ZERO;const de=i.a,ce=n.mul(i.b,Qu);let re=n.mul(b,B),pe=n.mul(g,M),_e=n.mul(C,O),$e=n.add(b,g),ge=n.add(B,M);$e=n.mul($e,ge),ge=n.add(re,pe),$e=n.sub($e,ge),ge=n.add(b,C);let ke=n.add(B,O);return ge=n.mul(ge,ke),ke=n.add(re,_e),ge=n.sub(ge,ke),ke=n.add(g,C),$=n.add(M,O),ke=n.mul(ke,$),$=n.add(pe,_e),ke=n.sub(ke,$),G=n.mul(de,ge),$=n.mul(ce,_e),G=n.add($,G),$=n.sub(pe,G),G=n.add(pe,G),V=n.mul($,G),pe=n.add(re,re),pe=n.add(pe,re),_e=n.mul(de,_e),ge=n.mul(ce,ge),pe=n.add(pe,_e),_e=n.sub(re,_e),_e=n.mul(de,_e),ge=n.add(ge,_e),re=n.mul(pe,ge),V=n.add(V,re),re=n.mul(ke,ge),$=n.mul($e,$),$=n.sub($,re),re=n.mul($e,pe),G=n.mul(ke,G),G=n.add(G,re),new x($,V,G)}subtract(y){return this.add(y.negate())}is0(){return this.equals(x.ZERO)}multiply(y){const{endo:b}=e;if(!s.isValidNot0(y))throw new Error("invalid scalar: out of range");let g,C;const B=M=>j.cached(this,M,O=>Gc(x,O));if(b){const{k1neg:M,k1:O,k2neg:$,k2:V}=L(y),{p:G,f:de}=B(O),{p:ce,f:re}=B(V);C=de.add(re),g=k(b.beta,G,ce,M,$)}else{const{p:M,f:O}=B(y);g=M,C=O}return Gc(x,[g,C])[0]}multiplyUnsafe(y){const{endo:b}=e,g=this;if(!s.isValid(y))throw new Error("invalid scalar: out of range");if(y===ks||g.is0())return x.ZERO;if(y===xa)return g;if(j.hasCache(this))return this.multiply(y);if(b){const{k1neg:C,k1:B,k2neg:M,k2:O}=L(y),{p1:$,p2:V}=mk(x,g,B,O);return k(b.beta,$,V,C,M)}else return j.unsafe(g,y)}toAffine(y){return z(this,y)}isTorsionFree(){const{isTorsionFree:y}=e;return o===xa?!0:y?y(x,this):j.unsafe(this,a).is0()}clearCofactor(){const{clearCofactor:y}=e;return o===xa?this:y?y(x,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(y=!0){return wo(y,"isCompressed"),this.assertValidity(),m(x,this,y)}toHex(y=!0){return iu(this.toBytes(y))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const F=s.BITS,j=new mb(x,e.endo?Math.ceil(F/2):F);return x.BASE.precompute(8),x}function Ab(r){return Uint8Array.of(r?2:3)}function Ib(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function Hk(r,e={}){const{Fn:t}=r,n=e.randomBytes||Mp,s=Object.assign(Ib(r.Fp,t),{seed:hb(t.ORDER)});function i(m){try{const _=t.fromBytes(m);return t.isValidNot0(_)}catch{return!1}}function o(m,_){const{publicKey:R,publicKeyUncompressed:T}=s;try{const A=m.length;return _===!0&&A!==R||_===!1&&A!==T?!1:!!r.fromBytes(m)}catch{return!1}}function a(m=n(s.seed)){return gk(wt(m,s.seed,"seed"),t.ORDER)}function c(m,_=!0){return r.BASE.multiply(t.fromBytes(m)).toBytes(_)}function l(m){const{secretKey:_,publicKey:R,publicKeyUncompressed:T}=s;if(!Sh(m)||"_lengths"in t&&t._lengths||_===R)return;const A=wt(m,void 0,"key").length;return A===R||A===T}function h(m,_,R=!0){if(l(m)===!0)throw new Error("first arg must be private key");if(l(_)===!1)throw new Error("second arg must be public key");const T=t.fromBytes(m);return r.fromBytes(_).multiply(T).toBytes(R)}const f={isValidSecretKey:i,isValidPublicKey:o,randomSecretKey:a},p=bb(a,c);return Object.freeze({getPublicKey:c,getSharedSecret:h,keygen:p,Point:r,utils:f,lengths:s})}function Vk(r,e,t={}){jy(e),ou(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),t=Object.assign({},t);const n=t.randomBytes||Mp,s=t.hmac||((b,g)=>xb(e,b,g)),{Fp:i,Fn:o}=r,{ORDER:a,BITS:c}=o,{keygen:l,getPublicKey:h,getSharedSecret:f,utils:p,lengths:m}=Hk(r,t),_={prehash:!0,lowS:typeof t.lowS=="boolean"?t.lowS:!0,format:"compact",extraEntropy:!1},R=a*Sb<i.ORDER;function T(b){const g=a>>xa;return b>g}function A(b,g){if(!o.isValidNot0(g))throw new Error(`invalid signature ${b}: out of range 1..Point.Fn.ORDER`);return g}function D(){if(R)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function I(b,g){Z2(g);const C=m.signature,B=g==="compact"?C:g==="recovered"?C+1:void 0;return wt(b,B)}class q{r;s;recovery;constructor(g,C,B){if(this.r=A("r",g),this.s=A("s",C),B!=null){if(D(),![0,1,2,3].includes(B))throw new Error("invalid recovery id");this.recovery=B}Object.freeze(this)}static fromBytes(g,C=_.format){I(g,C);let B;if(C==="der"){const{r:V,s:G}=vi.toSig(wt(g));return new q(V,G)}C==="recovered"&&(B=g[0],C="compact",g=g.subarray(1));const M=m.signature/2,O=g.subarray(0,M),$=g.subarray(M,M*2);return new q(o.fromBytes(O),o.fromBytes($),B)}static fromHex(g,C){return this.fromBytes(ml(g),C)}assertRecovery(){const{recovery:g}=this;if(g==null)throw new Error("invalid recovery id: must be present");return g}addRecoveryBit(g){return new q(this.r,this.s,g)}recoverPublicKey(g){const{r:C,s:B}=this,M=this.assertRecovery(),O=M===2||M===3?C+a:C;if(!i.isValid(O))throw new Error("invalid recovery id: sig.r+curve.n != R.x");const $=i.toBytes(O),V=r.fromBytes(Qr(Ab((M&1)===0),$)),G=o.inv(O),de=z(wt(g,void 0,"msgHash")),ce=o.create(-de*G),re=o.create(B*G),pe=r.BASE.multiplyUnsafe(ce).add(V.multiplyUnsafe(re));if(pe.is0())throw new Error("invalid recovery: point at infinify");return pe.assertValidity(),pe}hasHighS(){return T(this.s)}toBytes(g=_.format){if(Z2(g),g==="der")return ml(vi.hexFromSig(this));const{r:C,s:B}=this,M=o.toBytes(C),O=o.toBytes(B);return g==="recovered"?(D(),Qr(Uint8Array.of(this.assertRecovery()),M,O)):Qr(M,O)}toHex(g){return iu(this.toBytes(g))}}const L=t.bits2int||function(g){if(g.length>8192)throw new Error("input is too large");const C=Ah(g),B=g.length*8-c;return B>0?C>>BigInt(B):C},z=t.bits2int_modN||function(g){return o.create(L(g))},Y=Fp(c);function k(b){return z2("num < 2^"+c,b,ks,Y),o.toBytes(b)}function x(b,g){return wt(b,void 0,"message"),g?wt(e(b),void 0,"prehashed message"):b}function F(b,g,C){const{lowS:B,prehash:M,extraEntropy:O}=z1(C,_);b=x(b,M);const $=z(b),V=o.fromBytes(g);if(!o.isValidNot0(V))throw new Error("invalid private key");const G=[k(V),k($)];if(O!=null&&O!==!1){const pe=O===!0?n(m.secretKey):O;G.push(wt(pe,void 0,"extraEntropy"))}const de=Qr(...G),ce=$;function re(pe){const _e=L(pe);if(!o.isValidNot0(_e))return;const $e=o.inv(_e),ge=r.BASE.multiply(_e).toAffine(),ke=o.create(ge.x);if(ke===ks)return;const ht=o.create($e*o.create(ce+ke*V));if(ht===ks)return;let qt=(ge.x===ke?0:2)|Number(ge.y&xa),$t=ht;return B&&T(ht)&&($t=o.neg(ht),qt^=1),new q(ke,$t,R?void 0:qt)}return{seed:de,k2sig:re}}function j(b,g,C={}){const{seed:B,k2sig:M}=F(b,g,C);return rk(e.outputLen,o.BYTES,s)(B,M).toBytes(C.format)}function U(b,g,C,B={}){const{lowS:M,prehash:O,format:$}=z1(B,_);if(C=wt(C,void 0,"publicKey"),g=x(g,O),!Sh(b)){const V=b instanceof q?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+V)}I(b,$);try{const V=q.fromBytes(b,$),G=r.fromBytes(C);if(M&&V.hasHighS())return!1;const{r:de,s:ce}=V,re=z(g),pe=o.inv(ce),_e=o.create(re*pe),$e=o.create(de*pe),ge=r.BASE.multiplyUnsafe(_e).add(G.multiplyUnsafe($e));return ge.is0()?!1:o.create(ge.x)===de}catch{return!1}}function y(b,g,C={}){const{prehash:B}=z1(C,_);return g=x(g,B),q.fromBytes(b,"recovered").recoverPublicKey(g).toBytes()}return Object.freeze({keygen:l,getPublicKey:h,getSharedSecret:f,utils:p,lengths:m,Point:r,sign:j,verify:U,recoverPublicKey:y,Signature:q,hash:e})}const Kp={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},Kk={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},d6=BigInt(2);function zk(r){const e=Kp.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,h=l*l*r%e,f=Wt(h,t,e)*h%e,p=Wt(f,t,e)*h%e,m=Wt(p,d6,e)*l%e,_=Wt(m,s,e)*m%e,R=Wt(_,i,e)*_%e,T=Wt(R,a,e)*R%e,A=Wt(T,c,e)*T%e,D=Wt(A,a,e)*R%e,I=Wt(D,t,e)*h%e,q=Wt(I,o,e)*_%e,L=Wt(q,n,e)*l%e,z=Wt(L,d6,e);if(!j2.eql(j2.sqr(z),r))throw new Error("Cannot find square root");return z}const j2=Ih(Kp.p,{sqrt:zk}),Wk=Fk(Kp,{Fp:j2,endo:Kk}),hd=Vk(Wk,JT);function Gk(r,e,t,n){const s=$r.digest(t instanceof Uint8Array?t:t.subarray());if(_b(s))return s.then(({digest:i})=>(n?.signal?.throwIfAborted(),hd.verify(e,i,r,{prehash:!1,format:"der"}))).catch(i=>{throw i.name==="AbortError"?i:new l6(String(i))});try{return n?.signal?.throwIfAborted(),hd.verify(e,s.digest,r,{prehash:!1,format:"der"})}catch(i){throw new l6(String(i))}}let Zk=class{type="secp256k1";raw;_key;constructor(e){this._key=Qk(e),this.raw=Yk(this._key)}toMultihash(){return Kt.digest(zp(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){return Gk(this._key,t,e,n)}};function jk(r){return new Zk(r)}function Yk(r){return hd.Point.fromBytes(r).toBytes()}function Qk(r){try{return hd.Point.fromBytes(r),r}catch(e){throw new fT(String(e))}}function Xk(r){const{Type:e,Data:t}=dd.decode(r.digest),n=t??new Uint8Array;switch(e){case xr.Ed25519:return $k(n);case xr.secp256k1:return jk(n);case xr.ECDSA:return RT(n);default:throw new dT}}function zp(r){return dd.encode({Type:xr[r.type],Data:r.raw})}const Jk=Symbol.for("@libp2p/connection"),Y2=Symbol.for("@libp2p/content-routing"),pd=Symbol.for("@libp2p/peer-discovery"),Wp=Symbol.for("@libp2p/peer-id");function Zc(r){return!!r?.[Wp]}const Q2=Symbol.for("@libp2p/peer-routing"),au="keep-alive",gd="StrictSign",Gp="StrictNoSign";var _r;(function(r){r.Accept="accept",r.Ignore="ignore",r.Reject="reject"})(_r||(_r={}));const Zp=Symbol.for("@libp2p/transport");var bl;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(bl||(bl={}));let Di=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};class eC extends Error{static name="UnexpectedPeerError";constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}}let tC=class extends Error{static name="InvalidCryptoExchangeError";constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}},ot=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},md=class extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}};class nC extends Error{static name="ConnectionClosingError";constructor(e="The connection is closing"){super(e),this.name="ConnectionClosingError"}}class Tb extends Error{static name="ConnectionClosedError";constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}}class kb extends Error{static name="ConnectionFailedError";constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}}class Rc extends Error{static name="MuxerClosedError";constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}}class rC extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}}class sC extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}}let qi=class extends Error{static name="NotFoundError";constructor(e="Not found"){super(e),this.name="NotFoundError"}};class Cb extends Error{static name="InvalidPeerIdError";constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}}let jp=class extends Error{static name="InvalidMultiaddrError";constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}};class iC extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}}class oC extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}}class Yp extends Error{static name="UnsupportedProtocolError";constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}}class Jt extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}}class aC extends Error{static name="ProtocolError";constructor(e="Protocol error"){super(e),this.name="ProtocolError"}}let Qp=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}};class yd extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}}class jc extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}}class X2 extends Error{static name="ListenError";constructor(e="Listen error"){super(e),this.name="ListenError"}}class h6 extends Error{static name="LimitedConnectionError";constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}}class cC extends Error{static name="TooManyInboundProtocolStreamsError";constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}}class Rb extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}}let Pb=class extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};function Xp(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function wl(...r){const e=[];for(const t of r)Xp(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function Th(...r){const e=[];for(const t of r)Xp(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}const pr=Symbol.for("@libp2p/service-capabilities"),_o=Symbol.for("@libp2p/service-dependencies"),Db=Symbol.for("nodejs.util.inspect.custom"),lC=114;class Jp{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[Wp]=!0;toString(){return this.string==null&&(this.string=dt.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return nt.createV1(lC,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return at(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return at(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[Db](){return`PeerId(${this.toString()})`}}class qb extends Jp{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}}class Bb extends Jp{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}}class Lb extends Jp{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}}const uC=2336;class Ob{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=Kt.digest(Ge(this.url))}[Db](){return`PeerId(${this.url})`}[Wp]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return nt.createV1(uC,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=Le(e)),e.toString()===this.toString())}}const fC=114,p6=2336;function Vn(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=Gn(dt.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return cu(nt.parse(r));throw new ot('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return mr(t)}function Ua(r){if(r.type==="Ed25519")return new Bb({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new Lb({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new qb({multihash:r.toCID().multihash,publicKey:r});throw new Pb}function dC(r){return Ua(r.publicKey)}function mr(r){if(pC(r))return new qb({multihash:r});if(hC(r))try{const e=Xk(r);if(e.type==="Ed25519")return new Bb({multihash:r,publicKey:e});if(e.type==="secp256k1")return new Lb({multihash:r,publicKey:e})}catch{const t=Le(r.digest);return new Ob(new URL(t))}throw new oC("Supplied PeerID Multihash is invalid")}function cu(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==fC&&r.code!==p6)throw new iC("Supplied PeerID CID is invalid");if(r.code===p6){const e=Le(r.multihash.digest);return new Ob(new URL(e))}return mr(r.multihash)}function hC(r){return r.code===Kt.code}function pC(r){return r.code===$r.code}function bd(r){if(typeof r!="object"||r===null)return!1;const e=Object.getPrototypeOf(r);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)}const{hasOwnProperty:$b}=Object.prototype,{propertyIsEnumerable:gC}=Object,Fa=(r,e,t)=>{Object.defineProperty(r,e,{value:t,writable:!0,enumerable:!0,configurable:!0})},mC=void 0,g6={concatArrays:!1,ignoreUndefined:!1},kh=r=>{const e=[];for(const t in r)$b.call(r,t)&&e.push(t);if(Object.getOwnPropertySymbols){const t=Object.getOwnPropertySymbols(r);for(const n of t)gC.call(r,n)&&e.push(n)}return e};function yc(r){return Array.isArray(r)?yC(r):bd(r)?bC(r):r}function yC(r){const e=r.slice(0,0);return kh(r).forEach(t=>{Fa(e,t,yc(r[t]))}),e}function bC(r){const e=Object.getPrototypeOf(r)===null?Object.create(null):{};return kh(r).forEach(t=>{Fa(e,t,yc(r[t]))}),e}const Mb=(r,e,t,n)=>(t.forEach(s=>{typeof e[s]>"u"&&n.ignoreUndefined||(s in r&&r[s]!==Object.getPrototypeOf(r)?Fa(r,s,J2(r[s],e[s],n)):Fa(r,s,yc(e[s])))}),r),wC=(r,e,t)=>{let n=r.slice(0,0),s=0;return[r,e].forEach(i=>{const o=[];for(let a=0;a<i.length;a++)$b.call(i,a)&&(o.push(String(a)),i===r?Fa(n,s++,i[a]):Fa(n,s++,yc(i[a])));n=Mb(n,i,kh(i).filter(a=>!o.includes(a)),t)}),n};function J2(r,e,t){return t.concatArrays&&Array.isArray(r)&&Array.isArray(e)?wC(r,e,t):!bd(e)||!bd(r)?yc(e):Mb(r,e,kh(e),t)}function Nb(...r){const e=J2(yc(g6),this!==mC&&this||{},g6);let t={_:{}};for(const n of r)if(n!==void 0){if(!bd(n))throw new TypeError("`"+n+"` is not an Option Object");t=J2(t,{_:n},e)}return t._}class fn extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}}class _C extends AggregateError{static name="DNSQueryFailedError";name="DNSQueryFailedError"}function Ch(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var W1={exports:{}},m6;function EC(){return m6||(m6=1,(function(r){var e=Object.prototype.hasOwnProperty,t="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(t=!1));function s(c,l,h){this.fn=c,this.context=l,this.once=h||!1}function i(c,l,h,f,p){if(typeof h!="function")throw new TypeError("The listener must be a function");var m=new s(h,f||c,p),_=t?t+l:l;return c._events[_]?c._events[_].fn?c._events[_]=[c._events[_],m]:c._events[_].push(m):(c._events[_]=m,c._eventsCount++),c}function o(c,l){--c._eventsCount===0?c._events=new n:delete c._events[l]}function a(){this._events=new n,this._eventsCount=0}a.prototype.eventNames=function(){var l=[],h,f;if(this._eventsCount===0)return l;for(f in h=this._events)e.call(h,f)&&l.push(t?f.slice(1):f);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(h)):l},a.prototype.listeners=function(l){var h=t?t+l:l,f=this._events[h];if(!f)return[];if(f.fn)return[f.fn];for(var p=0,m=f.length,_=new Array(m);p<m;p++)_[p]=f[p].fn;return _},a.prototype.listenerCount=function(l){var h=t?t+l:l,f=this._events[h];return f?f.fn?1:f.length:0},a.prototype.emit=function(l,h,f,p,m,_){var R=t?t+l:l;if(!this._events[R])return!1;var T=this._events[R],A=arguments.length,D,I;if(T.fn){switch(T.once&&this.removeListener(l,T.fn,void 0,!0),A){case 1:return T.fn.call(T.context),!0;case 2:return T.fn.call(T.context,h),!0;case 3:return T.fn.call(T.context,h,f),!0;case 4:return T.fn.call(T.context,h,f,p),!0;case 5:return T.fn.call(T.context,h,f,p,m),!0;case 6:return T.fn.call(T.context,h,f,p,m,_),!0}for(I=1,D=new Array(A-1);I<A;I++)D[I-1]=arguments[I];T.fn.apply(T.context,D)}else{var q=T.length,L;for(I=0;I<q;I++)switch(T[I].once&&this.removeListener(l,T[I].fn,void 0,!0),A){case 1:T[I].fn.call(T[I].context);break;case 2:T[I].fn.call(T[I].context,h);break;case 3:T[I].fn.call(T[I].context,h,f);break;case 4:T[I].fn.call(T[I].context,h,f,p);break;default:if(!D)for(L=1,D=new Array(A-1);L<A;L++)D[L-1]=arguments[L];T[I].fn.apply(T[I].context,D)}}return!0},a.prototype.on=function(l,h,f){return i(this,l,h,f,!1)},a.prototype.once=function(l,h,f){return i(this,l,h,f,!0)},a.prototype.removeListener=function(l,h,f,p){var m=t?t+l:l;if(!this._events[m])return this;if(!h)return o(this,m),this;var _=this._events[m];if(_.fn)_.fn===h&&(!p||_.once)&&(!f||_.context===f)&&o(this,m);else{for(var R=0,T=[],A=_.length;R<A;R++)(_[R].fn!==h||p&&!_[R].once||f&&_[R].context!==f)&&T.push(_[R]);T.length?this._events[m]=T.length===1?T[0]:T:o(this,m)}return this},a.prototype.removeAllListeners=function(l){var h;return l?(h=t?t+l:l,this._events[h]&&o(this,h)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,r.exports=a})(W1)),W1.exports}var vC=EC(),xC=Ch(vC);let SC=class Ub extends Error{name="TimeoutError";constructor(e,t){super(e,t),Error.captureStackTrace?.(this,Ub)}};const y6=r=>r.reason??new DOMException("This operation was aborted.","AbortError");function AC(r,e){const{milliseconds:t,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout},signal:o}=e;let a,c;const h=new Promise((f,p)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(o?.aborted){p(y6(o));return}if(o&&(c=()=>{p(y6(o))},o.addEventListener("abort",c,{once:!0})),r.then(f,p),t===Number.POSITIVE_INFINITY)return;const m=new SC;a=i.setTimeout.call(void 0,()=>{if(n){try{f(n())}catch(_){p(_)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?f():s instanceof Error?p(s):(m.message=s??`Promise timed out after ${t} milliseconds`,p(m))},t)}).finally(()=>{h.clear(),c&&o&&o.removeEventListener("abort",c)});return h.clear=()=>{i.clearTimeout.call(void 0,a),a=void 0},h}function IC(r,e,t){let n=0,s=r.length;for(;s>0;){const i=Math.trunc(s/2);let o=n+i;t(r[o],e)<=0?(n=++o,s-=i+1):s=i}return n}let TC=class{#e=[];enqueue(e,t){const{priority:n=0,id:s}=t??{},i={priority:n,id:s,run:e};if(this.size===0||this.#e[this.size-1].priority>=n){this.#e.push(i);return}const o=IC(this.#e,i,(a,c)=>c.priority-a.priority);this.#e.splice(o,0,i)}setPriority(e,t){const n=this.#e.findIndex(i=>i.id===e);if(n===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[s]=this.#e.splice(n,1);this.enqueue(s.run,{priority:t,id:e})}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}};class kC extends xC{#e;#t;#n=0;#i;#r=!1;#d=!1;#u;#o=0;#g=0;#a;#p;#l;#h=[];#f=0;#s;#T;#c=0;#w;#m;#D=1n;#_=new Map;timeout;constructor(e){if(super(),e={carryoverIntervalCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:TC,strict:!1,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);if(e.strict&&e.interval===0)throw new TypeError("The `strict` option requires a non-zero `interval`");if(e.strict&&e.intervalCap===Number.POSITIVE_INFINITY)throw new TypeError("The `strict` option requires a finite `intervalCap`");if(this.#e=e.carryoverIntervalCount??e.carryoverConcurrencyCount??!1,this.#t=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#i=e.intervalCap,this.#u=e.interval,this.#l=e.strict,this.#s=new e.queueClass,this.#T=e.queueClass,this.concurrency=e.concurrency,e.timeout!==void 0&&!(Number.isFinite(e.timeout)&&e.timeout>0))throw new TypeError(`Expected \`timeout\` to be a positive finite number, got \`${e.timeout}\` (${typeof e.timeout})`);this.timeout=e.timeout,this.#m=e.autoStart===!1,this.#U()}#E(e){for(;this.#f<this.#h.length;){const n=this.#h[this.#f];if(n!==void 0&&e-n>=this.#u)this.#f++;else break}(this.#f>100&&this.#f>this.#h.length/2||this.#f===this.#h.length)&&(this.#h=this.#h.slice(this.#f),this.#f=0)}#q(e){this.#l?this.#h.push(e):this.#n++}#B(){this.#l?this.#h.length>this.#f&&this.#h.pop():this.#n>0&&this.#n--}#v(){return this.#h.length-this.#f}get#L(){return this.#t?!0:this.#l?this.#v()<this.#i:this.#n<this.#i}get#O(){return this.#c<this.#w}#$(){this.#c--,this.#c===0&&this.emit("pendingZero"),this.#A(),this.emit("next")}#M(){this.#p=void 0,this.#R(),this.#C()}#N(e){if(this.#l){if(this.#E(e),this.#v()>=this.#i){const n=this.#h[this.#f],s=this.#u-(e-n);return this.#x(s),!0}return!1}if(this.#a===void 0){const t=this.#o-e;if(t<0){if(this.#g>0){const n=e-this.#g;if(n<this.#u)return this.#x(this.#u-n),!0}this.#n=this.#e?this.#c:0}else return this.#x(t),!0}return!1}#x(e){this.#p===void 0&&(this.#p=setTimeout(()=>{this.#M()},e))}#S(){this.#a&&(clearInterval(this.#a),this.#a=void 0)}#k(){this.#p&&(clearTimeout(this.#p),this.#p=void 0)}#A(){if(this.#s.size===0){if(this.#S(),this.emit("empty"),this.#c===0){if(this.#k(),this.#l&&this.#f>0){const t=Date.now();this.#E(t)}this.emit("idle")}return!1}let e=!1;if(!this.#m){const t=Date.now(),n=!this.#N(t);if(this.#L&&this.#O){const s=this.#s.dequeue();this.#t||(this.#q(t),this.#b()),this.emit("active"),s(),n&&this.#C(),e=!0}}return e}#C(){this.#t||this.#a!==void 0||this.#l||(this.#a=setInterval(()=>{this.#R()},this.#u),this.#o=Date.now()+this.#u)}#R(){this.#l||(this.#n===0&&this.#c===0&&this.#a&&this.#S(),this.#n=this.#e?this.#c:0),this.#I(),this.#b()}#I(){for(;this.#A(););}get concurrency(){return this.#w}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#w=e,this.#I()}setPriority(e,t){if(typeof t!="number"||!Number.isFinite(t))throw new TypeError(`Expected \`priority\` to be a finite number, got \`${t}\` (${typeof t})`);this.#s.setPriority(e,t)}async add(e,t={}){return t={timeout:this.timeout,...t,id:t.id??(this.#D++).toString()},new Promise((n,s)=>{const i=Symbol(`task-${t.id}`);this.#s.enqueue(async()=>{this.#c++,this.#_.set(i,{id:t.id,priority:t.priority??0,startTime:Date.now(),timeout:t.timeout});let o;try{try{t.signal?.throwIfAborted()}catch(l){throw this.#F(),this.#_.delete(i),l}this.#g=Date.now();let a=e({signal:t.signal});if(t.timeout&&(a=AC(Promise.resolve(a),{milliseconds:t.timeout,message:`Task timed out after ${t.timeout}ms (queue has ${this.#c} running, ${this.#s.size} waiting)`})),t.signal){const{signal:l}=t;a=Promise.race([a,new Promise((h,f)=>{o=()=>{f(l.reason)},l.addEventListener("abort",o,{once:!0})})])}const c=await a;n(c),this.emit("completed",c)}catch(a){s(a),this.emit("error",a)}finally{o&&t.signal?.removeEventListener("abort",o),this.#_.delete(i),queueMicrotask(()=>{this.#$()})}},t),this.emit("add"),this.#A()})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this.#m?(this.#m=!1,this.#I(),this):this}pause(){this.#m=!0}clear(){this.#s=new this.#T,this.#S(),this.#P(),this.emit("empty"),this.#c===0&&(this.#k(),this.emit("idle")),this.emit("next")}async onEmpty(){this.#s.size!==0&&await this.#y("empty")}async onSizeLessThan(e){this.#s.size<e||await this.#y("next",()=>this.#s.size<e)}async onIdle(){this.#c===0&&this.#s.size===0||await this.#y("idle")}async onPendingZero(){this.#c!==0&&await this.#y("pendingZero")}async onRateLimit(){this.isRateLimited||await this.#y("rateLimit")}async onRateLimitCleared(){this.isRateLimited&&await this.#y("rateLimitCleared")}onError(){return new Promise((e,t)=>{const n=s=>{this.off("error",n),t(s)};this.on("error",n)})}async#y(e,t){return new Promise(n=>{const s=()=>{t&&!t()||(this.off(e,s),n())};this.on(e,s)})}get size(){return this.#s.size}sizeBy(e){return this.#s.filter(e).length}get pending(){return this.#c}get isPaused(){return this.#m}#U(){this.#t||(this.on("add",()=>{this.#s.size>0&&this.#b()}),this.on("next",()=>{this.#b()}))}#b(){this.#t||this.#d||(this.#d=!0,queueMicrotask(()=>{this.#d=!1,this.#P()}))}#F(){this.#t||(this.#B(),this.#b())}#P(){const e=this.#r;if(this.#t||this.#s.size===0){e&&(this.#r=!1,this.emit("rateLimitCleared"));return}let t;if(this.#l){const s=Date.now();this.#E(s),t=this.#v()}else t=this.#n;const n=t>=this.#i;n!==e&&(this.#r=n,this.emit(n?"rateLimit":"rateLimitCleared"))}get isRateLimited(){return this.#r}get isSaturated(){return this.#c===this.#w&&this.#s.size>0||this.isRateLimited&&this.#s.size>0}get runningTasks(){return[...this.#_.values()].map(e=>({...e}))}}function Fb(r){const e=[Bi.A];return r==null?e:Array.isArray(r)?r.length===0?e:r:[r]}const Hb=60;function Vb(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(e=>({name:e.name,type:Bi[e.type]})),Answer:(r.Answer??r.answers??[]).map(e=>({name:e.name,type:Bi[e.type],TTL:e.TTL??e.ttl??Hb,data:e.data instanceof Uint8Array?Le(e.data):e.data}))}}const CC=4;function b6(r,e={}){const t=new kC({concurrency:e.queryConcurrency??CC});return async(n,s={})=>{const i=s?.logger?.forComponent("dns:dns-json-over-https"),o=new URLSearchParams;o.set("name",n),Fb(s.types).forEach(c=>{o.append("type",Bi[c])}),s.onProgress?.(new fn("dns:query",n)),i?.("GET %s",`${r}?${o}`);const a=await t.add(async()=>{const c=await fetch(`${r}?${o}`,{headers:{accept:"application/dns-json"},signal:s?.signal});if(i?.("GET %s %d",c.url,c.status),c.status!==200)throw new Error(`Unexpected HTTP status: ${c.status} - ${c.statusText}`);const l=Vb(await c.json());return s.onProgress?.(new fn("dns:response",l)),l},{signal:s.signal});if(a==null)throw new Error("No DNS response received");return a}}function RC(){return[b6("https://cloudflare-dns.com/dns-query"),b6("https://dns.google/resolve")]}var G1,w6;function PC(){return w6||(w6=1,G1=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function s(i,o){t[i]=o,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(i){return t[i]!==void 0||n[i]!==void 0},remove:function(i){t[i]!==void 0&&(t[i]=void 0),n[i]!==void 0&&(n[i]=void 0)},get:function(i){var o=t[i];if(o!==void 0)return o;if((o=n[i])!==void 0)return s(i,o),o},set:function(i,o){t[i]!==void 0?t[i]=o:s(i,o)},clear:function(){t=Object.create(null),n=Object.create(null)}}}),G1}var DC=PC(),qC=Ch(DC);class BC{lru;constructor(e){this.lru=qC(e)}get(e,t){let n=!0;const s=[];for(const i of t){const o=this.getAnswers(e,i);if(o.length===0){n=!1;break}s.push(...o)}if(n)return Vb({answers:s})}getAnswers(e,t){const n=`${e.toLowerCase()}-${t}`,s=this.lru.get(n);if(s!=null){const i=s.filter(o=>o.expires>Date.now()).map(({expires:o,value:a})=>({...a,TTL:Math.round((o-Date.now())/1e3),type:Bi[a.type]}));return i.length===0&&this.lru.remove(n),i}return[]}add(e,t){const n=`${e.toLowerCase()}-${t.type}`,s=this.lru.get(n)??[];s.push({expires:Date.now()+(t.TTL??Hb)*1e3,value:t}),this.lru.set(n,s)}remove(e,t){const n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}}function LC(r){return new BC(r)}const OC=1e3;let $C=class{resolvers;cache;logger;constructor(e){this.resolvers={},this.cache=LC(e.cacheSize??OC),this.logger=e.logger,Object.entries(e.resolvers??{}).forEach(([t,n])=>{Array.isArray(n)||(n=[n]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=n}),this.resolvers["."]==null&&(this.resolvers["."]=RC())}async query(e,t={}){const n=Fb(t.types),s=t.cached!==!1?this.cache.get(e,n):void 0;if(s!=null)return t.onProgress?.(new fn("dns:cache",s)),s;const i=`${e.split(".").pop()}.`,o=(this.resolvers[i]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(const c of o){if(t.signal?.aborted===!0)break;try{const l=await c(e,{...t,logger:this.logger,types:n});for(const h of l.Answer)this.cache.add(e,h);return l}catch(l){a.push(l),t.onProgress?.(new fn("dns:error",l))}}throw new _C(a,`DNS lookup of ${e} ${n} failed`)}};var Bi;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})(Bi||(Bi={}));function MC(r={}){return new $C(r)}class Er extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"}class _l extends Error{static name="ValidationError";name="ValidationError"}let NC=class extends Error{static name="InvalidParametersError";name="InvalidParametersError"};class UC extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"}class FC{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{const t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,s){return this.readAtomically(()=>{let i=0,o=0;const a=this.peekChar();if(a===void 0)return;const c=a==="0",l=2**(8*s)-1;for(;;){const h=this.readAtomically(()=>{const f=this.readChar();if(f===void 0)return;const p=Number.parseInt(f,e);if(!Number.isNaN(p))return p});if(h===void 0)break;if(i*=e,i+=h,i>l||(o+=1,t!==void 0&&o>t))return}if(o!==0)return!n&&c&&o>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){const e=t=>{for(let n=0;n<t.length/2;n++){const s=n*2;if(n<t.length-3){const o=this.readSeparator(":",n,()=>this.readIPv4Addr());if(o!==void 0)return t[s]=o[0],t[s+1]=o[1],t[s+2]=o[2],t[s+3]=o[3],[s+4,!0]}const i=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[s,!1];t[s]=i>>8,t[s+1]=i&255}return[t.length,!1]};return this.readAtomically(()=>{const t=new Uint8Array(16),[n,s]=e(t);if(n===16)return t;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const i=new Uint8Array(14),o=16-(n+2),[a]=e(i.subarray(0,o));return t.set(i.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const Kb=45,HC=15,Ha=new FC;function zb(r){if(!(r.length>HC))return Ha.new(r).parseWith(()=>Ha.readIPv4Addr())}function Wb(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>Kb))return Ha.new(r).parseWith(()=>Ha.readIPv6Addr())}function e3(r,e=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>Kb)return;const t=Ha.new(r).parseWith(()=>Ha.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function Va(r){return!!zb(r)}function Gb(r){return!!Wb(r)}const Eo=4,Bs=6,wd=273,VC=33,Sr=41,Uo=42,eg=43,lu=53,uu=54,bc=55,fu=56,KC=132,zC=301,WC=302,Zb=400,kt=421,GC=444,ZC=445,jC=446,YC=447,Sa=448,jb=449,QC=454,Yb=460,Qb=461,Xb=465,El=466,Aa=480,XC=481,t3=443,tg=477,Jb=478,JC=479,eR=277,tR=275,nR=276,e7=280,zf=281,wc=290,t7=777;function _6(r){return e=>Le(e,r)}function E6(r){return e=>Ge(e,r)}function Hc(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function ga(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(e)}function rR(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=Ge(e[0],"base32"),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=ga(n);return is([t,s],t.length+s.length)}function sR(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=Ci.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=ga(n);return is([t,s],t.length+s.length)}function v6(r){const e=r.subarray(0,r.length-2),t=r.subarray(r.length-2),n=Le(e,"base32"),s=Hc(t);return`${n}:${s}`}const n7=function(r){r=r.toString().trim();const e=new Uint8Array(4);return r.split(/\./g).forEach((t,n)=>{const s=parseInt(t,10);if(isNaN(s)||s<0||s>255)throw new Er("Invalid byte value in IP address");e[n]=s}),e},iR=function(r){let e=0;r=r.toString().trim();const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=Va(t[n]);let o;i&&(o=n7(t[n]),t[n]=Le(o.subarray(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,Le(o.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){t[n]===""&&(t[n]="0");const i=parseInt(t[n],16);if(isNaN(i)||i<0||i>65535)throw new Er("Invalid byte value in IP address");s[e++]=i>>8&255,s[e++]=i&255}return s},oR=function(r){if(r.byteLength!==4)throw new Er("IPv4 address was incorrect length");const e=[];for(let t=0;t<r.byteLength;t++)e.push(r[t]);return e.join(".")},aR=function(r){if(r.byteLength!==16)throw new Er("IPv6 address was incorrect length");const e=[];for(let n=0;n<r.byteLength;n+=2){const s=r[n],i=r[n+1],o=`${s.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`;e.push(o)}const t=e.join(":");try{const n=new URL(`http://[${t}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new Er(`Invalid IPv6 address "${t}"`)}};function cR(r){try{const e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new Er(`Invalid IPv6 address "${r}"`)}}const Z1=Object.values(P2).map(r=>r.decoder),lR=(function(){let r=Z1[0].or(Z1[1]);return Z1.slice(2).forEach(e=>r=r.or(e)),r})();function uR(r){return lR.decode(r)}function fR(r){return e=>r.encoder.encode(e)}function dR(r){if(parseInt(r).toString()!==r)throw new _l("Value must be an integer")}function hR(r){if(r<0)throw new _l("Value must be a positive integer, or zero")}function pR(r){return e=>{if(e>r)throw new _l(`Value must be smaller than or equal to ${r}`)}}function gR(...r){return e=>{for(const t of r)t(e)}}const Xu=gR(dR,hR,pR(65535)),Nn=-1;class mR{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new UC(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}}const Br=new mR,yR=[{code:Eo,name:"ip4",size:32,valueToBytes:n7,bytesToValue:oR,validate:r=>{if(!Va(r))throw new _l(`Invalid IPv4 address "${r}"`)}},{code:Bs,name:"tcp",size:16,valueToBytes:ga,bytesToValue:Hc,validate:Xu},{code:wd,name:"udp",size:16,valueToBytes:ga,bytesToValue:Hc,validate:Xu},{code:VC,name:"dccp",size:16,valueToBytes:ga,bytesToValue:Hc,validate:Xu},{code:Sr,name:"ip6",size:128,valueToBytes:iR,bytesToValue:aR,stringToValue:cR,validate:r=>{if(!Gb(r))throw new _l(`Invalid IPv6 address "${r}"`)}},{code:Uo,name:"ip6zone",size:Nn},{code:eg,name:"ipcidr",size:8,bytesToValue:_6("base10"),valueToBytes:E6("base10")},{code:lu,name:"dns",size:Nn,resolvable:!0},{code:uu,name:"dns4",size:Nn,resolvable:!0},{code:bc,name:"dns6",size:Nn,resolvable:!0},{code:fu,name:"dnsaddr",size:Nn,resolvable:!0},{code:KC,name:"sctp",size:16,valueToBytes:ga,bytesToValue:Hc,validate:Xu},{code:zC,name:"udt"},{code:WC,name:"utp"},{code:Zb,name:"unix",size:Nn,path:!0,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:kt,name:"p2p",aliases:["ipfs"],size:Nn,bytesToValue:_6("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?E6("base58btc")(r):nt.parse(r).multihash.bytes},{code:GC,name:"onion",size:96,bytesToValue:v6,valueToBytes:rR},{code:ZC,name:"onion3",size:296,bytesToValue:v6,valueToBytes:sR},{code:jC,name:"garlic64",size:Nn},{code:YC,name:"garlic32",size:Nn},{code:Sa,name:"tls"},{code:jb,name:"sni",size:Nn},{code:QC,name:"noise"},{code:Yb,name:"quic"},{code:Qb,name:"quic-v1"},{code:Xb,name:"webtransport"},{code:El,name:"certhash",size:Nn,bytesToValue:fR(ay),valueToBytes:uR},{code:Aa,name:"http"},{code:XC,name:"http-path",size:Nn,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:t3,name:"https"},{code:tg,name:"ws"},{code:Jb,name:"wss"},{code:JC,name:"p2p-websocket-star"},{code:eR,name:"p2p-stardust"},{code:tR,name:"p2p-webrtc-star"},{code:nR,name:"p2p-webrtc-direct"},{code:e7,name:"webrtc-direct"},{code:zf,name:"webrtc"},{code:wc,name:"p2p-circuit"},{code:t7,name:"memory",size:Nn}];yR.forEach(r=>{Br.addProtocol(r)});function bR(r){const e=[];let t=0;for(;t<r.length;){const n=mc(r,t),s=Br.getProtocol(n),i=hr(n),o=vR(s,r,t+i);let a=0;o>0&&s.size===Nn&&(a=hr(o));const c=i+a+o,l={code:n,name:s.name,bytes:r.subarray(t,t+c)};if(o>0){const h=t+i+a,f=r.subarray(h,h+o);l.value=s.bytesToValue?.(f)??Le(f)}e.push(l),t+=c}return e}function wR(r){let e=0;const t=[];for(const n of r){if(n.bytes==null){const s=Br.getProtocol(n.code),i=hr(n.code);let o,a=0,c=0;n.value!=null&&(o=s.valueToBytes?.(n.value)??Ge(n.value),a=o.byteLength,s.size===Nn&&(c=hr(a)));const l=new Uint8Array(i+c+a);let h=0;od(n.code,l,h),h+=i,o!=null&&(s.size===Nn&&(od(a,l,h),h+=c),l.set(o,h)),n.bytes=l}t.push(n.bytes),e+=n.bytes.byteLength}return is(t,e)}function _R(r){if(r.charAt(0)!=="/")throw new Er('String multiaddr must start with "/"');const e=[];let t="protocol",n="",s="";for(let i=1;i<r.length;i++){const o=r.charAt(i);o!=="/"&&(t==="protocol"?s+=r.charAt(i):n+=r.charAt(i));const a=i===r.length-1;if(o==="/"||a){const c=Br.getProtocol(s);if(t==="protocol"){if(c.size==null||c.size===0){e.push({code:c.code,name:c.name}),n="",s="",t="protocol";continue}else if(a)throw new Er(`Component ${s} was missing value`);t="value"}else if(t==="value"){const l={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new Er(`Component ${s} was missing value`);l.value=c.stringToValue?.(n)??n}e.push(l),n="",s="",t="protocol"}}}if(s!==""&&n!=="")throw new Er("Incomplete multiaddr");return e}function ER(r){return`/${r.flatMap(e=>{if(e.value==null)return e.name;const t=Br.getProtocol(e.code);if(t==null)throw new Er(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function vR(r,e,t){return r.size==null||r.size===0?0:r.size>0?r.size/8:mc(e,t)}const xR=Symbol.for("nodejs.util.inspect.custom"),r7=Symbol.for("@multiformats/multiaddr"),SR=[lu,uu,bc,fu];class AR extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}}function IR(r){if(r==null&&(r="/"),Rh(r))return r.getComponents();if(r instanceof Uint8Array)return bR(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),_R(r);if(Array.isArray(r))return r;throw new Er("Must be a string, Uint8Array, Component[], or another Multiaddr")}class ma{[r7]=!0;#e;#t;#n;constructor(e="/",t={}){this.#e=IR(e),t.validate!==!1&&TR(this)}get bytes(){return this.#n==null&&(this.#n=wR(this.#e)),this.#n}toString(){return this.#t==null&&(this.#t=ER(this.#e)),this.#t}toJSON(){return this.toString()}toOptions(){let e,t,n,s,i="";for(const{code:a,name:c,value:l}of this.#e)a===Uo&&(i=`%${l??""}`),SR.includes(a)&&(t="tcp",s=443,n=`${l??""}${i}`,e=a===bc?6:4),(a===Bs||a===wd)&&(t=c==="tcp"?"tcp":"udp",s=parseInt(l??"")),(a===Eo||a===Sr)&&(t="tcp",n=`${l??""}${i}`,e=a===Sr?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}getComponents(){return[...this.#e]}protos(){return this.#e.map(({code:e,value:t})=>{const n=Br.getProtocol(e);return{code:e,size:n.size??0,name:n.name,resolvable:!!n.resolvable,path:!!n.path}})}protoCodes(){return this.#e.map(({code:e})=>e)}protoNames(){return this.#e.map(({name:e})=>e)}tuples(){return this.#e.map(({code:e,value:t})=>{if(t==null)return[e];const n=Br.getProtocol(e),s=[e];return t!=null&&s.push(n.valueToBytes?.(t)??Ge(t)),s})}stringTuples(){return this.#e.map(({code:e,value:t})=>t==null?[e]:[e,t])}encapsulate(e){const t=new ma(e);return new ma([...this.#e,...t.getComponents()],{validate:!1})}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new NC(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new ma(n.slice(0,s),{validate:!1})}decapsulateCode(e){let t;for(let n=this.#e.length-1;n>-1;n--)if(this.#e[n].code===e){t=n;break}return new ma(this.#e.slice(0,t),{validate:!1})}getPeerId(){try{let e=[];this.#e.forEach(({code:n,value:s})=>{n===kt&&e.push([n,s]),n===wc&&(e=[])});const t=e.pop();if(t?.[1]!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?Le(dt.decode(`z${n}`),"base58btc"):Le(nt.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){for(const e of this.#e)if(Br.getProtocol(e.code).path)return e.value??null;return null}equals(e){return at(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const n=NR.get(t.name);if(n==null)throw new AR(`no available resolver for ${t.name}`);return(await n(this,e)).map(i=>lt(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(){return!(this.#e.length!==2||this.#e[0].code!==Eo&&this.#e[0].code!==Sr||this.#e[1].code!==Bs&&this.#e[1].code!==wd)}[xR](){return`Multiaddr(${this.toString()})`}}function TR(r){r.getComponents().forEach(e=>{const t=Br.getProtocol(e.code);e.value!=null&&t.validate?.(e.value)})}function kR(r,e,t){let n=0;for(const s of r)if(!(n<e)){if(n>t)break;if(s!==255)return!1;n++}return!0}function CR(r,e,t,n){let s=0;for(const i of r)if(!(s<t)){if(s>n)break;if(i!==e[s])return!1;s++}return!0}function RR(r){switch(r.length){case vl:return r.join(".");case xl:{const e=[];for(let t=0;t<r.length;t++)t%2===0&&e.push(r[t].toString(16).padStart(2,"0")+r[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function PR(r){let e=0;for(let[t,n]of r.entries()){if(n===255){e+=8;continue}for(;(n&128)!=0;)e++,n=n<<1;if((n&128)!=0)return-1;for(let s=t+1;s<r.length;s++)if(r[s]!=0)return-1;break}return e}function DR(r){let e="0x";for(const t of r)e+=(t>>4).toString(16)+(t&15).toString(16);return e}const vl=4,xl=16,qR=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function s7(r,e){e.length===xl&&r.length===vl&&kR(e,0,11)&&(e=e.slice(12)),e.length===vl&&r.length===xl&&CR(r,qR,0,11)&&(r=r.slice(12));const t=r.length;if(t!=e.length)throw new Error("Failed to mask ip");const n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=r[s]&e[s];return n}function BR(r,e){if(typeof e=="string"&&(e=e3(e)),e==null)throw new Error("Invalid ip");if(e.length!==r.network.length)return!1;for(let t=0;t<e.length;t++)if((r.network[t]&r.mask[t])!==(e[t]&r.mask[t]))return!1;return!0}function LR(r){const[e,t]=r.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+r);let n=vl,s=zb(e);if(s==null&&(n=xl,s=Wb(e),s==null))throw new Error("Failed to parse given CIDR: "+r);const i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>n*8)throw new Error("Failed to parse given CIDR: "+r);const o=i7(i,8*n);return{network:s7(s,o),mask:o}}function i7(r,e){if(e!==8*vl&&e!==8*xl)throw new Error("Invalid CIDR mask");if(r<0||r>e)throw new Error("Invalid CIDR mask");const t=e/8,n=new Uint8Array(t);for(let s=0;s<t;s++){if(r>=8){n[s]=255,r-=8;continue}n[s]=255-(255>>r),r=0}return n}class o7{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=LR(e));else{const n=e3(e);if(n==null)throw new Error("Failed to parse network");t=String(t);const s=parseInt(t,10);if(Number.isNaN(s)||String(s).length!==t.length||s<0||s>n.length*8){const i=e3(t);if(i==null)throw new Error("Failed to parse mask");this.mask=i}else this.mask=i7(s,8*n.length);this.network=s7(n,this.mask)}}contains(e){return BR({network:this.network,mask:this.mask},e)}toString(){const e=PR(this.mask),t=e!==-1?String(e):DR(this.mask);return RR(this.network)+"/"+t}}function OR(r,e){return new o7(r).contains(e)}function $R(r){let e,t;if(r.getComponents().forEach(n=>{(n.name==="ip4"||n.name==="ip6")&&(t=n.value),n.name==="ipcidr"&&(e=n.value)}),e==null||t==null)throw new Error("Invalid multiaddr");return new o7(t,e)}function MR(r,e){return Br.getProtocol(r).bytesToValue?.(e)??Le(e,"base16")}const NR=new Map;function Rh(r){return!!r?.[r7]}function lt(r){return new ma(r)}function du(r){const e=Br.getProtocol(r);return{code:e.code,size:e.size??0,name:e.name,resolvable:!!e.resolvable,path:!!e.path}}class UR{dns;canResolve(e){return e.getComponents().some(({name:t})=>t==="dnsaddr")}async resolve(e,t){const n=e.getComponents().find(c=>c.name==="dnsaddr")?.value;if(n==null)return[e];const i=await this.getDNS(t).query(`_dnsaddr.${n}`,{signal:t?.signal,types:[Bi.TXT]}),o=e.getComponents().find(c=>c.name==="p2p")?.value,a=[];for(const c of i.Answer){const l=c.data.replace(/["']/g,"").trim().split("=")[1];l!=null&&(o!=null&&!l.includes(o)||a.push(lt(l)))}return a}getDNS(e){return e.dns!=null?e.dns:(this.dns==null&&(this.dns=MC()),this.dns)}}const ng=new UR;var FR={};const HR={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{resolvers:{dnsaddr:ng}},transportManager:{faultTolerance:bl.FATAL_ALL}};async function VR(r){const e=Nb(HR,r);if(e.connectionProtector===null&&FR?.LIBP2P_FORCE_PNET!=null)throw new ot("Private network is enforced, but no protector was provided");return e}const Ka=1e3,za=Ka*60,Wa=za*60,vo=Wa*24,Sl=vo*7,Ga=vo*365.25,Al=Ga/12;function KR(r,e){if(typeof r=="string")return zR(r);if(typeof r=="number")return ZR(r,e);throw Error(`Value provided to ms() must be a string or number. value=${JSON.stringify(r)}`)}var a7=KR;function zR(r){if(typeof r!="string"||r.length===0||r.length>100)throw Error(`Value provided to ms.parse() must be a string with length between 1 and 99. value=${JSON.stringify(r)}`);let e=/^(?<value>-?\d*\.?\d+) *(?<unit>milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|months?|mo|years?|yrs?|y)?$/i.exec(r);if(!e?.groups)return NaN;let{value:t,unit:n="ms"}=e.groups,s=parseFloat(t),i=n.toLowerCase();switch(i){case"years":case"year":case"yrs":case"yr":case"y":return s*Ga;case"months":case"month":case"mo":return s*Al;case"weeks":case"week":case"w":return s*Sl;case"days":case"day":case"d":return s*vo;case"hours":case"hour":case"hrs":case"hr":case"h":return s*Wa;case"minutes":case"minute":case"mins":case"min":case"m":return s*za;case"seconds":case"second":case"secs":case"sec":case"s":return s*Ka;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return s;default:throw Error(`Unknown unit "${i}" provided to ms.parse(). value=${JSON.stringify(r)}`)}}function WR(r){let e=Math.abs(r);return e>=Ga?`${Math.round(r/Ga)}y`:e>=Al?`${Math.round(r/Al)}mo`:e>=Sl?`${Math.round(r/Sl)}w`:e>=vo?`${Math.round(r/vo)}d`:e>=Wa?`${Math.round(r/Wa)}h`:e>=za?`${Math.round(r/za)}m`:e>=Ka?`${Math.round(r/Ka)}s`:`${r}ms`}function GR(r){let e=Math.abs(r);return e>=Ga?Mi(r,e,Ga,"year"):e>=Al?Mi(r,e,Al,"month"):e>=Sl?Mi(r,e,Sl,"week"):e>=vo?Mi(r,e,vo,"day"):e>=Wa?Mi(r,e,Wa,"hour"):e>=za?Mi(r,e,za,"minute"):e>=Ka?Mi(r,e,Ka,"second"):`${r} ms`}function ZR(r,e){if(typeof r!="number"||!Number.isFinite(r))throw Error("Value provided to ms.format() must be of type number.");return e?.long?GR(r):WR(r)}function Mi(r,e,t,n){let s=e>=t*1.5;return`${Math.round(r/t)} ${n}${s?"s":""}`}function jR(r){t.debug=t,t.default=t,t.coerce=c,t.disable=i,t.enable=s,t.enabled=o,t.humanize=a7,t.destroy=l,Object.keys(r).forEach(h=>{t[h]=r[h]}),t.names=[],t.skips=[],t.formatters={};function e(h){let f=0;for(let p=0;p<h.length;p++)f=(f<<5)-f+h.charCodeAt(p),f|=0;return t.colors[Math.abs(f)%t.colors.length]}t.selectColor=e;function t(h,f){let p,m=null,_,R;function T(...A){if(!T.enabled)return;const D=T,I=Number(new Date),q=I-(p||I);D.diff=q,D.prev=p,D.curr=I,p=I,A[0]=t.coerce(A[0]),typeof A[0]!="string"&&A.unshift("%O");let L=0;A[0]=A[0].replace(/%([a-zA-Z%])/g,(Y,k)=>{if(Y==="%%")return"%";L++;const x=t.formatters[k];if(typeof x=="function"){const F=A[L];Y=x.call(D,F),A.splice(L,1),L--}return Y}),t.formatArgs.call(D,A),f?.onLog!=null&&f.onLog(...A),(D.log||t.log).apply(D,A)}return T.namespace=h,T.useColors=t.useColors(),T.color=t.selectColor(h),T.extend=n,T.destroy=t.destroy,Object.defineProperty(T,"enabled",{enumerable:!0,configurable:!1,get:()=>m!==null?m:(_!==t.namespaces&&(_=t.namespaces,R=t.enabled(h)),R),set:A=>{m=A}}),typeof t.init=="function"&&t.init(T),T}function n(h,f){const p=t(this.namespace+(typeof f>"u"?":":f)+h);return p.log=this.log,p}function s(h){t.save(h),t.namespaces=h,t.names=[],t.skips=[];let f;const p=(typeof h=="string"?h:"").split(/[\s,]+/),m=p.length;for(f=0;f<m;f++)p[f]&&(h=p[f].replace(/\*/g,".*?"),h[0]==="-"?t.skips.push(new RegExp("^"+h.substr(1)+"$")):t.names.push(new RegExp("^"+h+"$")))}function i(){const h=[...t.names.map(a),...t.skips.map(a).map(f=>"-"+f)].join(",");return t.enable(""),h}function o(h){if(h[h.length-1]==="*")return!0;let f,p;for(f=0,p=t.skips.length;f<p;f++)if(t.skips[f].test(h))return!1;for(f=0,p=t.names.length;f<p;f++)if(t.names[f].test(h))return!0;return!1}function a(h){return h.toString().substring(2,h.toString().length-2).replace(/\.\*\?$/,"*")}function c(h){return h instanceof Error?h.stack??h.message:h}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var YR={};const _d=rP(),QR=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function XR(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function JR(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+a7(this.diff),!this.useColors)return;const e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(n=t))}),r.splice(n,0,e)}const eP=console.debug??console.log??(()=>{});function tP(r){try{r?_d?.setItem("debug",r):_d?.removeItem("debug")}catch{}}function nP(){let r;try{r=_d?.getItem("debug")}catch{}return!r&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(r=YR.DEBUG),r}function rP(){try{return localStorage}catch{}}function sP(r){r.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}var br=jR({formatArgs:JR,save:tP,load:nP,useColors:XR,setupFormatters:sP,colors:QR,storage:_d,log:eP});br.formatters.b=r=>r==null?"undefined":dt.baseEncode(r);br.formatters.t=r=>r==null?"undefined":Ci.baseEncode(r);br.formatters.m=r=>r==null?"undefined":oy.baseEncode(r);br.formatters.p=r=>r==null?"undefined":r.toString();br.formatters.c=r=>r==null?"undefined":r.toString();br.formatters.k=r=>r==null?"undefined":r.toString();br.formatters.a=r=>r==null?"undefined":r.toString();br.formatters.e=r=>r==null?"undefined":x6(r.stack)??x6(r.message)??r.toString();function iP(r){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function c7(){return{forComponent(r){return l7(r)}}}function l7(r){let e=iP(`${r}:trace`);return br.enabled(`${r}:trace`)&&br.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=br(`${r}:trace`)),Object.assign(br(r),{error:br(`${r}:error`),trace:e,newScope:t=>l7(`${r}:${t}`)})}function x6(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}function Yc(r,e){const t={[Symbol.iterator]:()=>t,next:()=>{const n=r.next(),s=n.value;return n.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}function j1(r){const e=Gn(dt.decode(`z${r}`));return mr(e)}class Fo{map;constructor(e){if(this.map=new Map,e!=null)for(const[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return Yc(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return Yc(this.map.values(),e=>e.key)}values(){return Yc(this.map.values(),e=>e.value)}get size(){return this.map.size}}class rs{set;constructor(e){if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return Yc(this.set.entries(),e=>{const t=j1(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const n=j1(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return Yc(this.set.values(),e=>j1(e))}intersection(e){const t=new rs;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new rs;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new rs;for(const n of e)t.add(n);for(const n of this)t.add(n);return t}}function oP(){return new rs}const rg={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},u7={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},f7=new globalThis.TextEncoder;function aP(r,e){const t=rg[e];let n=u7[e];for(let s=0;s<r.length;s++)n^=BigInt(r[s]),n=BigInt.asUintN(e,n*t);return n}function cP(r,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const n=rg[e];let s=u7[e],i=r;for(;i.length>0;){const o=f7.encodeInto(i,t);i=i.slice(o.read);for(let a=0;a<o.written;a++)s^=BigInt(t[a]),s=BigInt.asUintN(e,s*n)}return s}function lP(r,{size:e=32,utf8Buffer:t}={}){if(!rg[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(t)return cP(r,e,t);r=f7.encode(r)}return aP(r,e)}const sg={hash:r=>Number(lP(r,{size:32})),hashV:(r,e)=>uP(sg.hash(r,e))};function uP(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),Ge(e,"base16")}const d7=64;class Zi{fp;h;seed;constructor(e,t,n,s=2){if(s>d7)throw new TypeError("Invalid Fingerprint Size");const i=t.hashV(e,n),o=St(s);for(let a=0;a<o.length;a++)o[a]=i[a];o.length===0&&(o[0]=7),this.fp=o,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?at(this.fp,e.fp):!1}}function Ed(r,e){return Math.floor(Math.random()*(e-r))+r}class Ju{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof Zi))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof Zi))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof Zi))throw new TypeError("Invalid Fingerprint");const t=Ed(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof Zi))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}}const fP=500;class S6{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??sg,this.seed=e.seed??Ed(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=Ge(e));const t=new Zi(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new Ju(this.bucketSize)),this.buckets[s]==null&&(this.buckets[s]=new Ju(this.bucketSize)),this.buckets[n].add(t)||this.buckets[s].add(t))return this.count++,!0;const i=[n,s];let o=i[Ed(0,i.length-1)];this.buckets[o]==null&&(this.buckets[o]=new Ju(this.bucketSize));for(let a=0;a<fP;a++){const c=this.buckets[o].swap(t);if(c!=null&&(o=(o^c.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new Ju(this.bucketSize)),this.buckets[o].add(c)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=Ge(e));const t=new Zi(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.has(t)??!1;if(s)return s;const i=(n^t.hash())%this.filterSize;return this.buckets[i]?.has(t)??!1}remove(e){typeof e=="string"&&(e=Ge(e));const t=new Zi(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.remove(t)??!1;if(s)return this.count--,s;const i=(n^t.hash())%this.filterSize,o=this.buckets[i]?.remove(t)??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}const dP={1:.5,2:.84,4:.95,8:.98};function hP(r=.001){return r>.002?2:r>1e-5?4:8}function pP(r,e=.001){const t=hP(e),n=dP[t],s=Math.round(r/n),i=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),d7);return{filterSize:s,bucketSize:t,fingerprintSize:i}}class gP{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??sg,this.seed=e.seed??Ed(0,Math.pow(2,10)),this.filterSeries=[new S6({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=Ge(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){const n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new S6({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=Ge(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=Ge(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}}function xo(r,e=.001,t){return new gP({...pP(r,e)})}class mP{filter;constructor(e,t){this.filter=xo(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}}function yP(r,e=.001){return new mP(r,e)}class bP extends Fo{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function ig(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new bP({name:e,metrics:t}):n=new Fo,n}let Ph=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},h7=class extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}},wP=class extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};const _P=parseInt("11111",2),n3=parseInt("10000000",2),EP=parseInt("01111111",2),A6={0:Pc,1:Pc,2:vP,3:AP,4:IP,5:SP,6:xP,16:Pc,22:Pc,48:Pc};function Dh(r,e={offset:0}){const t=r[e.offset]&_P;if(e.offset++,A6[t]!=null)return A6[t](r,e);throw new Error("No decoder for tag "+t)}function hu(r,e){let t=0;if((r[e.offset]&n3)===n3){const n=r[e.offset]&EP;let s="0x";e.offset++;for(let i=0;i<n;i++,e.offset++)s+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=r[e.offset],e.offset++;return t}function Pc(r,e){hu(r,e);const t=[];for(;!(e.offset>=r.byteLength);){const n=Dh(r,e);if(n===null)break;t.push(n)}return t}function vP(r,e){const t=hu(r,e),n=e.offset,s=e.offset+t,i=[];for(let o=n;o<s;o++)o===n&&r[o]===0||i.push(r[o]);return e.offset+=t,Uint8Array.from(i)}function xP(r,e){const t=hu(r,e),n=e.offset+t,s=r[e.offset];e.offset++;let i=0,o=0;s<40?(i=0,o=s):s<80?(i=1,o=s-40):(i=2,o=s-80);let a=`${i}.${o}`,c=[];for(;e.offset<n;){const l=r[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let h=0;for(let f=0;f<c.length;f++)h+=c[f]<<f*7;a+=`.${h}`,c=[]}}return a}function SP(r,e){return e.offset++,null}function AP(r,e){const t=hu(r,e),n=r[e.offset];e.offset++;const s=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function IP(r,e){const t=hu(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function TP(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);const t=new Ue;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function og(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);const e=TP(r.byteLength);return new Ue(Uint8Array.from([e.byteLength|n3]),e)}function r3(r){const e=new Ue,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Ue(Uint8Array.from([2]),og(e),e)}function p7(r){const e=Uint8Array.from([0]),t=new Ue(e,r);return new Ue(Uint8Array.from([3]),og(t),t)}function Qc(r,e=48){const t=new Ue;for(const n of r)t.append(n);return new Ue(Uint8Array.from([e]),og(t),t)}async function kP(r,e,t,n){const s=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();const i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return n?.signal?.throwIfAborted(),i}const CP=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),RP=Uint8Array.from([6,5,43,129,4,0,34]),PP=Uint8Array.from([6,5,43,129,4,0,35]),DP={ext:!0,kty:"EC",crv:"P-256"},qP={ext:!0,kty:"EC",crv:"P-384"},BP={ext:!0,kty:"EC",crv:"P-521"},Y1=32,Q1=48,X1=66;function LP(r){const e=Dh(r);return OP(e)}function OP(r){const e=r[1][1][0],t=1;let n,s;if(e.byteLength===Y1*2+1)return n=Le(e.subarray(t,t+Y1),"base64url"),s=Le(e.subarray(t+Y1),"base64url"),new J1({...DP,key_ops:["verify"],x:n,y:s});if(e.byteLength===Q1*2+1)return n=Le(e.subarray(t,t+Q1),"base64url"),s=Le(e.subarray(t+Q1),"base64url"),new J1({...qP,key_ops:["verify"],x:n,y:s});if(e.byteLength===X1*2+1)return n=Le(e.subarray(t,t+X1),"base64url"),s=Le(e.subarray(t+X1),"base64url"),new J1({...BP,key_ops:["verify"],x:n,y:s});throw new Ph(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function $P(r){return Qc([r3(Uint8Array.from([1])),Qc([MP(r.crv)],160),Qc([p7(new Ue(Uint8Array.from([4]),Ge(r.x??"","base64url"),Ge(r.y??"","base64url")))],161)]).subarray()}function MP(r){if(r==="P-256")return CP;if(r==="P-384")return RP;if(r==="P-521")return PP;throw new Ph(`Invalid curve ${r}`)}let J1=class{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=$P(this.jwk)),this._raw}toMultihash(){return Kt.digest(Oh(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}async verify(e,t,n){return kP(this.jwk,t,e,n)}};function qh(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function So(r,e=""){if(!Number.isSafeInteger(r)||r<0){const t=e&&`"${e}" `;throw new Error(`${t}expected integer >= 0, got ${r}`)}}function _t(r,e,t=""){const n=qh(r),s=r?.length,i=e!==void 0;if(!n||i&&s!==e){const o=t&&`"${t}" `,a=i?` of length ${e}`:"",c=n?`length=${s}`:`type=${typeof r}`;throw new Error(o+"expected Uint8Array"+a+", got "+c)}return r}function g7(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash must wrapped by utils.createHasher");So(r.outputLen),So(r.blockLen)}function vd(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function NP(r,e){_t(r,void 0,"digestInto() output");const t=e.outputLen;if(r.length<t)throw new Error('"digestInto() output" expected to be of length >='+t)}function Za(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function e0(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function Fr(r,e){return r<<32-e|r>>>e}const m7=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",UP=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function pu(r){if(_t(r),m7)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=UP[r[t]];return e}const ds={_0:48,_9:57,A:65,F:70,a:97,f:102};function I6(r){if(r>=ds._0&&r<=ds._9)return r-ds._0;if(r>=ds.A&&r<=ds.F)return r-(ds.A-10);if(r>=ds.a&&r<=ds.f)return r-(ds.a-10)}function Il(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(m7)return Uint8Array.fromHex(r);const e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(t);for(let s=0,i=0;s<t;s++,i+=2){const o=I6(r.charCodeAt(i)),a=I6(r.charCodeAt(i+1));if(o===void 0||a===void 0){const c=r[i]+r[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[s]=o*16+a}return n}function Xr(...r){let e=0;for(let n=0;n<r.length;n++){const s=r[n];_t(s),e+=s.length}const t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){const i=r[n];t.set(i,s),s+=i.length}return t}function y7(r,e={}){const t=(s,i)=>r(i).update(s).digest(),n=r(void 0);return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=s=>r(s),Object.assign(t,e),Object.freeze(t)}function ag(r=32){const e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}const b7=r=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,r])});function FP(r,e,t){return r&e^~r&t}function HP(r,e,t){return r&e^r&t^e&t}let w7=class{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(e,t,n,s){this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=e0(this.buffer)}update(e){vd(this),_t(e);const{view:t,buffer:n,blockLen:s}=this,i=e.length;for(let o=0;o<i;){const a=Math.min(s-this.pos,i-o);if(a===s){const c=e0(e);for(;s<=i-o;o+=s)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){vd(this),NP(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:s,isLE:i}=this;let{pos:o}=this;t[o++]=128,Za(this.buffer.subarray(o)),this.padOffset>s-o&&(this.process(n,0),o=0);for(let f=o;f<s;f++)t[f]=0;n.setBigUint64(s-8,BigInt(this.length*8),i),this.process(n,0);const a=e0(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");const l=c/4,h=this.get();if(l>h.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<l;f++)a.setUint32(4*f,h[f],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||=new this.constructor,e.set(...this.get());const{blockLen:t,buffer:n,length:s,finished:i,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=i,e.length=s,e.pos=a,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}};const Ys=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Bn=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),ef=BigInt(2**32-1),T6=BigInt(32);function VP(r,e=!1){return e?{h:Number(r&ef),l:Number(r>>T6&ef)}:{h:Number(r>>T6&ef)|0,l:Number(r&ef)|0}}function KP(r,e=!1){const t=r.length;let n=new Uint32Array(t),s=new Uint32Array(t);for(let i=0;i<t;i++){const{h:o,l:a}=VP(r[i],e);[n[i],s[i]]=[o,a]}return[n,s]}const k6=(r,e,t)=>r>>>t,C6=(r,e,t)=>r<<32-t|e>>>t,Xo=(r,e,t)=>r>>>t|e<<32-t,Jo=(r,e,t)=>r<<32-t|e>>>t,tf=(r,e,t)=>r<<64-t|e>>>t-32,nf=(r,e,t)=>r>>>t-32|e<<64-t;function hs(r,e,t,n){const s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}const zP=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),WP=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,GP=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),ZP=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,jP=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),YP=(r,e,t,n,s,i)=>e+t+n+s+i+(r/2**32|0)|0,QP=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Qs=new Uint32Array(64);let XP=class extends w7{constructor(e){super(64,e,8,!1)}get(){const{A:e,B:t,C:n,D:s,E:i,F:o,G:a,H:c}=this;return[e,t,n,s,i,o,a,c]}set(e,t,n,s,i,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let f=0;f<16;f++,t+=4)Qs[f]=e.getUint32(t,!1);for(let f=16;f<64;f++){const p=Qs[f-15],m=Qs[f-2],_=Fr(p,7)^Fr(p,18)^p>>>3,R=Fr(m,17)^Fr(m,19)^m>>>10;Qs[f]=R+Qs[f-7]+_+Qs[f-16]|0}let{A:n,B:s,C:i,D:o,E:a,F:c,G:l,H:h}=this;for(let f=0;f<64;f++){const p=Fr(a,6)^Fr(a,11)^Fr(a,25),m=h+p+FP(a,c,l)+QP[f]+Qs[f]|0,R=(Fr(n,2)^Fr(n,13)^Fr(n,22))+HP(n,s,i)|0;h=l,l=c,c=a,a=o+m|0,o=i,i=s,s=n,n=m+R|0}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,h=h+this.H|0,this.set(n,s,i,o,a,c,l,h)}roundClean(){Za(Qs)}destroy(){this.set(0,0,0,0,0,0,0,0),Za(this.buffer)}},JP=class extends XP{A=Ys[0]|0;B=Ys[1]|0;C=Ys[2]|0;D=Ys[3]|0;E=Ys[4]|0;F=Ys[5]|0;G=Ys[6]|0;H=Ys[7]|0;constructor(){super(32)}};const _7=KP(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),eD=_7[0],tD=_7[1],Xs=new Uint32Array(80),Js=new Uint32Array(80);let nD=class extends w7{constructor(e){super(128,e,16,!1)}get(){const{Ah:e,Al:t,Bh:n,Bl:s,Ch:i,Cl:o,Dh:a,Dl:c,Eh:l,El:h,Fh:f,Fl:p,Gh:m,Gl:_,Hh:R,Hl:T}=this;return[e,t,n,s,i,o,a,c,l,h,f,p,m,_,R,T]}set(e,t,n,s,i,o,a,c,l,h,f,p,m,_,R,T){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=h|0,this.Fh=f|0,this.Fl=p|0,this.Gh=m|0,this.Gl=_|0,this.Hh=R|0,this.Hl=T|0}process(e,t){for(let I=0;I<16;I++,t+=4)Xs[I]=e.getUint32(t),Js[I]=e.getUint32(t+=4);for(let I=16;I<80;I++){const q=Xs[I-15]|0,L=Js[I-15]|0,z=Xo(q,L,1)^Xo(q,L,8)^k6(q,L,7),Y=Jo(q,L,1)^Jo(q,L,8)^C6(q,L,7),k=Xs[I-2]|0,x=Js[I-2]|0,F=Xo(k,x,19)^tf(k,x,61)^k6(k,x,6),j=Jo(k,x,19)^nf(k,x,61)^C6(k,x,6),U=GP(Y,j,Js[I-7],Js[I-16]),y=ZP(U,z,F,Xs[I-7],Xs[I-16]);Xs[I]=y|0,Js[I]=U|0}let{Ah:n,Al:s,Bh:i,Bl:o,Ch:a,Cl:c,Dh:l,Dl:h,Eh:f,El:p,Fh:m,Fl:_,Gh:R,Gl:T,Hh:A,Hl:D}=this;for(let I=0;I<80;I++){const q=Xo(f,p,14)^Xo(f,p,18)^tf(f,p,41),L=Jo(f,p,14)^Jo(f,p,18)^nf(f,p,41),z=f&m^~f&R,Y=p&_^~p&T,k=jP(D,L,Y,tD[I],Js[I]),x=YP(k,A,q,z,eD[I],Xs[I]),F=k|0,j=Xo(n,s,28)^tf(n,s,34)^tf(n,s,39),U=Jo(n,s,28)^nf(n,s,34)^nf(n,s,39),y=n&i^n&a^i&a,b=s&o^s&c^o&c;A=R|0,D=T|0,R=m|0,T=_|0,m=f|0,_=p|0,{h:f,l:p}=hs(l|0,h|0,x|0,F|0),l=a|0,h=c|0,a=i|0,c=o|0,i=n|0,o=s|0;const g=zP(F,U,b);n=WP(g,x,j,y),s=g|0}({h:n,l:s}=hs(this.Ah|0,this.Al|0,n|0,s|0)),{h:i,l:o}=hs(this.Bh|0,this.Bl|0,i|0,o|0),{h:a,l:c}=hs(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:h}=hs(this.Dh|0,this.Dl|0,l|0,h|0),{h:f,l:p}=hs(this.Eh|0,this.El|0,f|0,p|0),{h:m,l:_}=hs(this.Fh|0,this.Fl|0,m|0,_|0),{h:R,l:T}=hs(this.Gh|0,this.Gl|0,R|0,T|0),{h:A,l:D}=hs(this.Hh|0,this.Hl|0,A|0,D|0),this.set(n,s,i,o,a,c,l,h,f,p,m,_,R,T,A,D)}roundClean(){Za(Xs,Js)}destroy(){Za(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},rD=class extends nD{Ah=Bn[0]|0;Al=Bn[1]|0;Bh=Bn[2]|0;Bl=Bn[3]|0;Ch=Bn[4]|0;Cl=Bn[5]|0;Dh=Bn[6]|0;Dl=Bn[7]|0;Eh=Bn[8]|0;El=Bn[9]|0;Fh=Bn[10]|0;Fl=Bn[11]|0;Gh=Bn[12]|0;Gl=Bn[13]|0;Hh=Bn[14]|0;Hl=Bn[15]|0;constructor(){super(64)}};const E7=y7(()=>new JP,b7(1)),sD=y7(()=>new rD,b7(3));const cg=BigInt(0),s3=BigInt(1);function Ao(r,e=""){if(typeof r!="boolean"){const t=e&&`"${e}" `;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function v7(r){if(typeof r=="bigint"){if(!Wf(r))throw new Error("positive bigint expected, got "+r)}else So(r);return r}function rf(r){const e=v7(r).toString(16);return e.length&1?"0"+e:e}function x7(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?cg:BigInt("0x"+r)}function Bh(r){return x7(pu(r))}function Tl(r){return x7(pu(i3(_t(r)).reverse()))}function lg(r,e){So(e),r=v7(r);const t=Il(r.toString(16).padStart(e*2,"0"));if(t.length!==e)throw new Error("number too large");return t}function S7(r,e){return lg(r,e).reverse()}function i3(r){return Uint8Array.from(r)}const Wf=r=>typeof r=="bigint"&&cg<=r;function iD(r,e,t){return Wf(r)&&Wf(e)&&Wf(t)&&e<=r&&r<t}function o3(r,e,t,n){if(!iD(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function oD(r){let e;for(e=0;r>cg;r>>=s3,e+=1);return e}const ug=r=>(s3<<BigInt(r))-s3;function aD(r,e,t){if(So(r,"hashLen"),So(e,"qByteLen"),typeof t!="function")throw new Error("hmacFn must be a function");const n=T=>new Uint8Array(T),s=Uint8Array.of(),i=Uint8Array.of(0),o=Uint8Array.of(1),a=1e3;let c=n(r),l=n(r),h=0;const f=()=>{c.fill(1),l.fill(0),h=0},p=(...T)=>t(l,Xr(c,...T)),m=(T=s)=>{l=p(i,T),c=p(),T.length!==0&&(l=p(o,T),c=p())},_=()=>{if(h++>=a)throw new Error("drbg: tried max amount of iterations");let T=0;const A=[];for(;T<e;){c=p();const D=c.slice();A.push(D),T+=c.length}return Xr(...A)};return(T,A)=>{f(),m(T);let D;for(;!(D=A(_()));)m();return f(),D}}function gu(r,e={},t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(i,o,a){const c=r[i];if(a&&c===void 0)return;const l=typeof c;if(l!==o||c===null)throw new Error(`param "${i}" is invalid: expected ${o}, got ${l}`)}const s=(i,o)=>Object.entries(i).forEach(([a,c])=>n(a,c,o));s(e,!1),s(t,!0)}function xd(r){const e=new WeakMap;return(t,...n)=>{const s=e.get(t);if(s!==void 0)return s;const i=r(t,...n);return e.set(t,i),i}}const rr=BigInt(0),Sn=BigInt(1),ji=BigInt(2),A7=BigInt(3),I7=BigInt(4),T7=BigInt(5),cD=BigInt(7),k7=BigInt(8),lD=BigInt(9),C7=BigInt(16);function on(r,e){const t=r%e;return t>=rr?t:e+t}function Gt(r,e,t){let n=r;for(;e-- >rr;)n*=n,n%=t;return n}function R6(r,e){if(r===rr)throw new Error("invert: expected non-zero number");if(e<=rr)throw new Error("invert: expected positive modulus, got "+e);let t=on(r,e),n=e,s=rr,i=Sn;for(;t!==rr;){const a=n/t,c=n%t,l=s-i*a;n=t,t=c,s=i,i=l}if(n!==Sn)throw new Error("invert: does not exist");return on(s,e)}function fg(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function R7(r,e){const t=(r.ORDER+Sn)/I7,n=r.pow(e,t);return fg(r,n,e),n}function uD(r,e){const t=(r.ORDER-T7)/k7,n=r.mul(e,ji),s=r.pow(n,t),i=r.mul(e,s),o=r.mul(r.mul(i,ji),s),a=r.mul(i,r.sub(o,r.ONE));return fg(r,a,e),a}function fD(r){const e=Lh(r),t=P7(r),n=t(e,e.neg(e.ONE)),s=t(e,n),i=t(e,e.neg(n)),o=(r+cD)/C7;return(a,c)=>{let l=a.pow(c,o),h=a.mul(l,n);const f=a.mul(l,s),p=a.mul(l,i),m=a.eql(a.sqr(h),c),_=a.eql(a.sqr(f),c);l=a.cmov(l,h,m),h=a.cmov(p,f,_);const R=a.eql(a.sqr(h),c),T=a.cmov(l,h,R);return fg(a,T,c),T}}function P7(r){if(r<A7)throw new Error("sqrt is not defined for small field");let e=r-Sn,t=0;for(;e%ji===rr;)e/=ji,t++;let n=ji;const s=Lh(r);for(;P6(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return R7;let i=s.pow(n,e);const o=(e+Sn)/ji;return function(c,l){if(c.is0(l))return l;if(P6(c,l)!==1)throw new Error("Cannot find square root");let h=t,f=c.mul(c.ONE,i),p=c.pow(l,e),m=c.pow(l,o);for(;!c.eql(p,c.ONE);){if(c.is0(p))return c.ZERO;let _=1,R=c.sqr(p);for(;!c.eql(R,c.ONE);)if(_++,R=c.sqr(R),_===h)throw new Error("Cannot find square root");const T=Sn<<BigInt(h-_-1),A=c.pow(f,T);h=_,f=c.sqr(A),p=c.mul(p,f),m=c.mul(m,A)}return m}}function dD(r){return r%I7===A7?R7:r%k7===T7?uD:r%C7===lD?fD(r):P7(r)}const hD=(r,e)=>(on(r,e)&Sn)===Sn,pD=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function gD(r){const e={ORDER:"bigint",BYTES:"number",BITS:"number"},t=pD.reduce((n,s)=>(n[s]="function",n),e);return gu(r,t),r}function mD(r,e,t){if(t<rr)throw new Error("invalid exponent, negatives unsupported");if(t===rr)return r.ONE;if(t===Sn)return e;let n=r.ONE,s=e;for(;t>rr;)t&Sn&&(n=r.mul(n,s)),s=r.sqr(s),t>>=Sn;return n}function D7(r,e,t=!1){const n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((o,a,c)=>r.is0(a)?o:(n[c]=o,r.mul(o,a)),r.ONE),i=r.inv(s);return e.reduceRight((o,a,c)=>r.is0(a)?o:(n[c]=r.mul(o,n[c]),r.mul(o,a)),i),n}function P6(r,e){const t=(r.ORDER-Sn)/ji,n=r.pow(e,t),s=r.eql(n,r.ONE),i=r.eql(n,r.ZERO),o=r.eql(n,r.neg(r.ONE));if(!s&&!i&&!o)throw new Error("invalid Legendre symbol result");return s?1:i?0:-1}function yD(r,e){e!==void 0&&So(e);const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}let bD=class{ORDER;BITS;BYTES;isLE;ZERO=rr;ONE=Sn;_lengths;_sqrt;_mod;constructor(e,t={}){if(e<=rr)throw new Error("invalid field: expected ORDER > 0, got "+e);let n;this.isLE=!1,t!=null&&typeof t=="object"&&(typeof t.BITS=="number"&&(n=t.BITS),typeof t.sqrt=="function"&&(this.sqrt=t.sqrt),typeof t.isLE=="boolean"&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),typeof t.modFromBytes=="boolean"&&(this._mod=t.modFromBytes));const{nBitLength:s,nByteLength:i}=yD(e,n);if(i>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=s,this.BYTES=i,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return on(e,this.ORDER)}isValid(e){if(typeof e!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof e);return rr<=e&&e<this.ORDER}is0(e){return e===rr}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&Sn)===Sn}neg(e){return on(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return on(e*e,this.ORDER)}add(e,t){return on(e+t,this.ORDER)}sub(e,t){return on(e-t,this.ORDER)}mul(e,t){return on(e*t,this.ORDER)}pow(e,t){return mD(this,e,t)}div(e,t){return on(e*R6(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return R6(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=dD(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?S7(e,this.BYTES):lg(e,this.BYTES)}fromBytes(e,t=!1){_t(e);const{_lengths:n,BYTES:s,isLE:i,ORDER:o,_mod:a}=this;if(n){if(!n.includes(e.length)||e.length>s)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+e.length);const l=new Uint8Array(s);l.set(e,i?0:l.length-e.length),e=l}if(e.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+e.length);let c=i?Tl(e):Bh(e);if(a&&(c=on(c,o)),!t&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(e){return D7(this,e)}cmov(e,t,n){return n?t:e}};function Lh(r,e={}){return new bD(r,e)}function q7(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function B7(r){const e=q7(r);return e+Math.ceil(e/2)}function wD(r,e,t=!1){_t(r);const n=r.length,s=q7(e),i=B7(e);if(n<16||n<i||n>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+n);const o=t?Tl(r):Bh(r),a=on(o,e-Sn)+Sn;return t?S7(a,s):lg(a,s)}const ja=BigInt(0),Yi=BigInt(1);function Sd(r,e){const t=e.negate();return r?t:e}function Xc(r,e){const t=D7(r.Fp,e.map(n=>n.Z));return e.map((n,s)=>r.fromAffine(n.toAffine(t[s])))}function L7(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function t0(r,e){L7(r,e);const t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,i=ug(r),o=BigInt(r);return{windows:t,windowSize:n,mask:i,maxNumber:s,shiftBy:o}}function D6(r,e,t){const{windowSize:n,mask:s,maxNumber:i,shiftBy:o}=t;let a=Number(r&s),c=r>>o;a>n&&(a-=i,c+=Yi);const l=e*n,h=l+Math.abs(a)-1,f=a===0,p=a<0,m=e%2!==0;return{nextN:c,offset:h,isZero:f,isNeg:p,isNegF:m,offsetF:l}}const n0=new WeakMap,O7=new WeakMap;function r0(r){return O7.get(r)||1}function q6(r){if(r!==ja)throw new Error("invalid wNAF")}let $7=class{BASE;ZERO;Fn;bits;constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let s=e;for(;t>ja;)t&Yi&&(n=n.add(s)),s=s.double(),t>>=Yi;return n}precomputeWindow(e,t){const{windows:n,windowSize:s}=t0(t,this.bits),i=[];let o=e,a=o;for(let c=0;c<n;c++){a=o,i.push(a);for(let l=1;l<s;l++)a=a.add(o),i.push(a);o=a.double()}return i}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,i=this.BASE;const o=t0(e,this.bits);for(let a=0;a<o.windows;a++){const{nextN:c,offset:l,isZero:h,isNeg:f,isNegF:p,offsetF:m}=D6(n,a,o);n=c,h?i=i.add(Sd(p,t[m])):s=s.add(Sd(f,t[l]))}return q6(n),{p:s,f:i}}wNAFUnsafe(e,t,n,s=this.ZERO){const i=t0(e,this.bits);for(let o=0;o<i.windows&&n!==ja;o++){const{nextN:a,offset:c,isZero:l,isNeg:h}=D6(n,o,i);if(n=a,!l){const f=t[c];s=s.add(h?f.negate():f)}}return q6(n),s}getPrecomputes(e,t,n){let s=n0.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(s=n(s)),n0.set(t,s))),s}cached(e,t,n){const s=r0(e);return this.wNAF(s,this.getPrecomputes(s,e,n),t)}unsafe(e,t,n,s){const i=r0(e);return i===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(i,this.getPrecomputes(i,e,n),t,s)}createCache(e,t){L7(t,this.bits),O7.set(e,t),n0.delete(e)}hasCache(e){return r0(e)!==1}};function _D(r,e,t,n){let s=e,i=r.ZERO,o=r.ZERO;for(;t>ja||n>ja;)t&Yi&&(i=i.add(s)),n&Yi&&(o=o.add(s)),s=s.double(),t>>=Yi,n>>=Yi;return{p1:i,p2:o}}function B6(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return gD(e),e}else return Lh(r,{isLE:t})}function M7(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(const c of["p","n","h"]){const l=e[c];if(!(typeof l=="bigint"&&l>ja))throw new Error(`CURVE.${c} must be positive bigint`)}const s=B6(e.p,t.Fp,n),i=B6(e.n,t.Fn,n),a=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(const c of a)if(!s.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:i}}function N7(r,e){return function(n){const s=r(n);return{secretKey:s,publicKey:e(s)}}}const ei=BigInt(0),pn=BigInt(1),s0=BigInt(2),ED=BigInt(8);function vD(r,e,t,n){const s=r.sqr(t),i=r.sqr(n),o=r.add(r.mul(e.a,s),i),a=r.add(r.ONE,r.mul(e.d,r.mul(s,i)));return r.eql(o,a)}function xD(r,e={}){const t=M7("edwards",r,e,e.FpFnLE),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o}=i;gu(e,{},{uvRatio:"function"});const a=s0<<BigInt(s.BYTES*8)-pn,c=T=>n.create(T),l=e.uvRatio||((T,A)=>{try{return{isValid:!0,value:n.sqrt(n.div(T,A))}}catch{return{isValid:!1,value:ei}}});if(!vD(n,i,i.Gx,i.Gy))throw new Error("bad curve params: generator point");function h(T,A,D=!1){const I=D?pn:ei;return o3("coordinate "+T,A,I,a),A}function f(T){if(!(T instanceof _))throw new Error("EdwardsPoint expected")}const p=xd((T,A)=>{const{X:D,Y:I,Z:q}=T,L=T.is0();A==null&&(A=L?ED:n.inv(q));const z=c(D*A),Y=c(I*A),k=n.mul(q,A);if(L)return{x:ei,y:pn};if(k!==pn)throw new Error("invZ was invalid");return{x:z,y:Y}}),m=xd(T=>{const{a:A,d:D}=i;if(T.is0())throw new Error("bad point: ZERO");const{X:I,Y:q,Z:L,T:z}=T,Y=c(I*I),k=c(q*q),x=c(L*L),F=c(x*x),j=c(Y*A),U=c(x*c(j+k)),y=c(F+c(D*c(Y*k)));if(U!==y)throw new Error("bad point: equation left != right (1)");const b=c(I*q),g=c(L*z);if(b!==g)throw new Error("bad point: equation left != right (2)");return!0});class _{static BASE=new _(i.Gx,i.Gy,pn,c(i.Gx*i.Gy));static ZERO=new _(ei,pn,pn,ei);static Fp=n;static Fn=s;X;Y;Z;T;constructor(A,D,I,q){this.X=h("x",A),this.Y=h("y",D),this.Z=h("z",I,!0),this.T=h("t",q),Object.freeze(this)}static CURVE(){return i}static fromAffine(A){if(A instanceof _)throw new Error("extended point not allowed");const{x:D,y:I}=A||{};return h("x",D),h("y",I),new _(D,I,pn,c(D*I))}static fromBytes(A,D=!1){const I=n.BYTES,{a:q,d:L}=i;A=i3(_t(A,I,"point")),Ao(D,"zip215");const z=i3(A),Y=A[I-1];z[I-1]=Y&-129;const k=Tl(z),x=D?a:n.ORDER;o3("point.y",k,ei,x);const F=c(k*k),j=c(F-pn),U=c(L*F-q);let{isValid:y,value:b}=l(j,U);if(!y)throw new Error("bad point: invalid y coordinate");const g=(b&pn)===pn,C=(Y&128)!==0;if(!D&&b===ei&&C)throw new Error("bad point: x=0 and x_0=1");return C!==g&&(b=c(-b)),_.fromAffine({x:b,y:k})}static fromHex(A,D=!1){return _.fromBytes(Il(A),D)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(A=8,D=!0){return R.createCache(this,A),D||this.multiply(s0),this}assertValidity(){m(this)}equals(A){f(A);const{X:D,Y:I,Z:q}=this,{X:L,Y:z,Z:Y}=A,k=c(D*Y),x=c(L*q),F=c(I*Y),j=c(z*q);return k===x&&F===j}is0(){return this.equals(_.ZERO)}negate(){return new _(c(-this.X),this.Y,this.Z,c(-this.T))}double(){const{a:A}=i,{X:D,Y:I,Z:q}=this,L=c(D*D),z=c(I*I),Y=c(s0*c(q*q)),k=c(A*L),x=D+I,F=c(c(x*x)-L-z),j=k+z,U=j-Y,y=k-z,b=c(F*U),g=c(j*y),C=c(F*y),B=c(U*j);return new _(b,g,B,C)}add(A){f(A);const{a:D,d:I}=i,{X:q,Y:L,Z:z,T:Y}=this,{X:k,Y:x,Z:F,T:j}=A,U=c(q*k),y=c(L*x),b=c(Y*I*j),g=c(z*F),C=c((q+L)*(k+x)-U-y),B=g-b,M=g+b,O=c(y-D*U),$=c(C*B),V=c(M*O),G=c(C*O),de=c(B*M);return new _($,V,de,G)}subtract(A){return this.add(A.negate())}multiply(A){if(!s.isValidNot0(A))throw new Error("invalid scalar: expected 1 <= sc < curve.n");const{p:D,f:I}=R.cached(this,A,q=>Xc(_,q));return Xc(_,[D,I])[0]}multiplyUnsafe(A,D=_.ZERO){if(!s.isValid(A))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return A===ei?_.ZERO:this.is0()||A===pn?this:R.unsafe(this,A,I=>Xc(_,I),D)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}isTorsionFree(){return R.unsafe(this,i.n).is0()}toAffine(A){return p(this,A)}clearCofactor(){return o===pn?this:this.multiplyUnsafe(o)}toBytes(){const{x:A,y:D}=this.toAffine(),I=n.toBytes(D);return I[I.length-1]|=A&pn?128:0,I}toHex(){return pu(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const R=new $7(_,s.BITS);return _.BASE.precompute(8),_}function SD(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');gu(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:n}=t,{BASE:s,Fp:i,Fn:o}=r,a=t.randomBytes||ag,c=t.adjustScalarBytes||(k=>k),l=t.domain||((k,x,F)=>{if(Ao(F,"phflag"),x.length||F)throw new Error("Contexts/pre-hash are not supported");return k});function h(k){return o.create(Tl(k))}function f(k){const x=I.secretKey;_t(k,I.secretKey,"secretKey");const F=_t(e(k),2*x,"hashedSecretKey"),j=c(F.slice(0,x)),U=F.slice(x,2*x),y=h(j);return{head:j,prefix:U,scalar:y}}function p(k){const{head:x,prefix:F,scalar:j}=f(k),U=s.multiply(j),y=U.toBytes();return{head:x,prefix:F,scalar:j,point:U,pointBytes:y}}function m(k){return p(k).pointBytes}function _(k=Uint8Array.of(),...x){const F=Xr(...x);return h(e(l(F,_t(k,void 0,"context"),!!n)))}function R(k,x,F={}){k=_t(k,void 0,"message"),n&&(k=n(k));const{prefix:j,scalar:U,pointBytes:y}=p(x),b=_(F.context,j,k),g=s.multiply(b).toBytes(),C=_(F.context,g,y,k),B=o.create(b+C*U);if(!o.isValid(B))throw new Error("sign failed: invalid s");const M=Xr(g,o.toBytes(B));return _t(M,I.signature,"result")}const T={zip215:!0};function A(k,x,F,j=T){const{context:U,zip215:y}=j,b=I.signature;k=_t(k,b,"signature"),x=_t(x,void 0,"message"),F=_t(F,I.publicKey,"publicKey"),y!==void 0&&Ao(y,"zip215"),n&&(x=n(x));const g=b/2,C=k.subarray(0,g),B=Tl(k.subarray(g,b));let M,O,$;try{M=r.fromBytes(F,y),O=r.fromBytes(C,y),$=s.multiplyUnsafe(B)}catch{return!1}if(!y&&M.isSmallOrder())return!1;const V=_(U,O.toBytes(),M.toBytes(),x);return O.add(M.multiplyUnsafe(V)).subtract($).clearCofactor().is0()}const D=i.BYTES,I={secretKey:D,publicKey:D,signature:2*D,seed:D};function q(k=a(I.seed)){return _t(k,I.seed,"seed")}function L(k){return qh(k)&&k.length===o.BYTES}function z(k,x){try{return!!r.fromBytes(k,x)}catch{return!1}}const Y={getExtendedPublicKey:p,randomSecretKey:q,isValidSecretKey:L,isValidPublicKey:z,toMontgomery(k){const{y:x}=r.fromBytes(k),F=I.publicKey,j=F===32;if(!j&&F!==57)throw new Error("only defined for 25519 and 448");const U=j?i.div(pn+x,pn-x):i.div(x-pn,x+pn);return i.toBytes(U)},toMontgomerySecret(k){const x=I.secretKey;_t(k,x);const F=e(k.subarray(0,x));return c(F).subarray(0,x)}};return Object.freeze({keygen:N7(q,m),getPublicKey:m,sign:R,verify:A,utils:Y,Point:r,lengths:I})}const AD=BigInt(1),L6=BigInt(2),ID=BigInt(5),TD=BigInt(8),dg=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),kD={p:dg,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:TD,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function CD(r){const e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),i=dg,a=r*r%i*r%i,c=Gt(a,L6,i)*a%i,l=Gt(c,AD,i)*r%i,h=Gt(l,ID,i)*l%i,f=Gt(h,e,i)*h%i,p=Gt(f,t,i)*f%i,m=Gt(p,n,i)*p%i,_=Gt(m,s,i)*m%i,R=Gt(_,s,i)*m%i,T=Gt(R,e,i)*h%i;return{pow_p_5_8:Gt(T,L6,i)*r%i,b2:a}}function RD(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}const O6=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function PD(r,e){const t=dg,n=on(e*e*e,t),s=on(n*n*e,t),i=CD(r*s).pow_p_5_8;let o=on(r*n*i,t);const a=on(e*o*o,t),c=o,l=on(o*O6,t),h=a===r,f=a===on(-r,t),p=a===on(-r*O6,t);return h&&(o=c),(f||p)&&(o=l),hD(o,t)&&(o=on(-o,t)),{isValid:h||f,value:o}}const DD=xD(kD,{uvRatio:PD});function qD(r){return SD(DD,sD,Object.assign({adjustScalarBytes:RD},r))}const BD=qD({});let $6=class extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}},LD=class extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}};var kl={get(r=globalThis){const e=r.crypto;if(e?.subtle==null)throw new LD("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};const U7=32;let i0;const OD=(async()=>{try{return await kl.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();async function $D(r,e,t){if(r.buffer instanceof ArrayBuffer){const n=await kl.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await kl.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function MD(r,e,t){return BD.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function ND(r,e,t){return i0==null&&(i0=await OD),i0?$D(r,e,t):MD(r,e,t)}function F7(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}let UD=class{type="Ed25519";raw;constructor(e){this.raw=H7(e,U7)}toMultihash(){return Kt.digest(Oh(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();const s=ND(this.raw,t,e);return F7(s)?s.then(i=>(n?.signal?.throwIfAborted(),i)):s}};function FD(r){return r=H7(r,U7),new UD(r)}function H7(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new Ph(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}var sr;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(sr||(sr={}));var a3;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(a3||(a3={}));(function(r){r.codec=()=>Rn(a3)})(sr||(sr={}));var Cl;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),sr.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=sr.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(Cl||(Cl={}));var M6;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),sr.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=sr.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(M6||(M6={}));let HD=class{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=GD(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return nt.createV1(114,this._multihash)}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){return YD(this.jwk,t,e,n)}};const VD=18,KD=1062,zD=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function WD(r){const e=Dh(r[1],{offset:0});return{kty:"RSA",n:Le(e[0],"base64url"),e:Le(e[1],"base64url")}}function GD(r){if(r.n==null||r.e==null)throw new Ph("JWK was missing components");return Qc([zD,p7(Qc([r3(Ge(r.n,"base64url")),r3(Ge(r.e,"base64url"))]))]).subarray()}function ZD(r,e){if(r.byteLength>=KD)throw new h7("Key size is too large");const t=Dh(r,{offset:0});return jD(t,r,e)}function jD(r,e,t){const n=WD(r);if(t==null){const s=E7(Cl.encode({Type:sr.RSA,Data:e}));t=Ms(VD,s)}return new HD(n,t)}async function YD(r,e,t,n){const s=await kl.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();const i=await kl.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),i}let V7=class{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(e,t){if(g7(e),_t(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const n=this.blockLen,s=new Uint8Array(n);s.set(t.length>n?e.create().update(t).digest():t);for(let i=0;i<s.length;i++)s[i]^=54;this.iHash.update(s),this.oHash=e.create();for(let i=0;i<s.length;i++)s[i]^=106;this.oHash.update(s),Za(s)}update(e){return vd(this),this.iHash.update(e),this}digestInto(e){vd(this),_t(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||=Object.create(Object.getPrototypeOf(this),{});const{oHash:t,iHash:n,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const K7=(r,e,t)=>new V7(r,e).update(t).digest();K7.create=(r,e)=>new V7(r,e);const N6=(r,e)=>(r+(r>=0?e:-e)/z7)/e;function QD(r,e,t){const[[n,s],[i,o]]=e,a=N6(o*r,t),c=N6(-s*r,t);let l=r-a*n-c*i,h=-a*s-c*o;const f=l<Cs,p=h<Cs;f&&(l=-l),p&&(h=-h);const m=ug(Math.ceil(oD(t)/2))+Ia;if(l<Cs||l>=m||h<Cs||h>=m)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:f,k1:l,k2neg:p,k2:h}}function c3(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function o0(r,e){const t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return Ao(t.lowS,"lowS"),Ao(t.prehash,"prehash"),t.format!==void 0&&c3(t.format),t}let XD=class extends Error{constructor(e=""){super(e)}};const xi={Err:XD,_tlv:{encode:(r,e)=>{const{Err:t}=xi;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const n=e.length/2,s=rf(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");const i=n>127?rf(s.length/2|128):"";return rf(r)+i+s+e},decode(r,e){const{Err:t}=xi;let n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");const s=e[n++],i=!!(s&128);let o=0;if(!i)o=s;else{const c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const l=e.subarray(n,n+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const h of l)o=o<<8|h;if(n+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const a=e.subarray(n,n+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+o)}}},_int:{encode(r){const{Err:e}=xi;if(r<Cs)throw new e("integer: negative integers are not allowed");let t=rf(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){const{Err:e}=xi;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Bh(r)}},toSig(r){const{Err:e,_int:t,_tlv:n}=xi,s=_t(r,void 0,"signature"),{v:i,l:o}=n.decode(48,s);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=n.decode(2,i),{v:l,l:h}=n.decode(2,c);if(h.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(r){const{_tlv:e,_int:t}=xi,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),i=n+s;return e.encode(48,i)}},Cs=BigInt(0),Ia=BigInt(1),z7=BigInt(2),sf=BigInt(3),JD=BigInt(4);function eq(r,e={}){const t=M7("weierstrass",r,e),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o,n:a}=i;gu(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});const{endo:c}=e;if(c&&(!n.is0(i.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const l=G7(n,s);function h(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function f(U,y,b){const{x:g,y:C}=y.toAffine(),B=n.toBytes(g);if(Ao(b,"isCompressed"),b){h();const M=!n.isOdd(C);return Xr(W7(M),B)}else return Xr(Uint8Array.of(4),B,n.toBytes(C))}function p(U){_t(U,void 0,"Point");const{publicKey:y,publicKeyUncompressed:b}=l,g=U.length,C=U[0],B=U.subarray(1);if(g===y&&(C===2||C===3)){const M=n.fromBytes(B);if(!n.isValid(M))throw new Error("bad point: is not on curve, wrong x");const O=R(M);let $;try{$=n.sqrt(O)}catch(de){const ce=de instanceof Error?": "+de.message:"";throw new Error("bad point: is not on curve, sqrt error"+ce)}h();const V=n.isOdd($);return(C&1)===1!==V&&($=n.neg($)),{x:M,y:$}}else if(g===b&&C===4){const M=n.BYTES,O=n.fromBytes(B.subarray(0,M)),$=n.fromBytes(B.subarray(M,M*2));if(!T(O,$))throw new Error("bad point: is not on curve");return{x:O,y:$}}else throw new Error(`bad point: got length ${g}, expected compressed=${y} or uncompressed=${b}`)}const m=e.toBytes||f,_=e.fromBytes||p;function R(U){const y=n.sqr(U),b=n.mul(y,U);return n.add(n.add(b,n.mul(U,i.a)),i.b)}function T(U,y){const b=n.sqr(y),g=R(U);return n.eql(b,g)}if(!T(i.Gx,i.Gy))throw new Error("bad curve params: generator point");const A=n.mul(n.pow(i.a,sf),JD),D=n.mul(n.sqr(i.b),BigInt(27));if(n.is0(n.add(A,D)))throw new Error("bad curve params: a or b");function I(U,y,b=!1){if(!n.isValid(y)||b&&n.is0(y))throw new Error(`bad point coordinate ${U}`);return y}function q(U){if(!(U instanceof x))throw new Error("Weierstrass Point expected")}function L(U){if(!c||!c.basises)throw new Error("no endo");return QD(U,c.basises,s.ORDER)}const z=xd((U,y)=>{const{X:b,Y:g,Z:C}=U;if(n.eql(C,n.ONE))return{x:b,y:g};const B=U.is0();y==null&&(y=B?n.ONE:n.inv(C));const M=n.mul(b,y),O=n.mul(g,y),$=n.mul(C,y);if(B)return{x:n.ZERO,y:n.ZERO};if(!n.eql($,n.ONE))throw new Error("invZ was invalid");return{x:M,y:O}}),Y=xd(U=>{if(U.is0()){if(e.allowInfinityPoint&&!n.is0(U.Y))return;throw new Error("bad point: ZERO")}const{x:y,y:b}=U.toAffine();if(!n.isValid(y)||!n.isValid(b))throw new Error("bad point: x or y not field elements");if(!T(y,b))throw new Error("bad point: equation left != right");if(!U.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function k(U,y,b,g,C){return b=new x(n.mul(b.X,U),b.Y,b.Z),y=Sd(g,y),b=Sd(C,b),y.add(b)}class x{static BASE=new x(i.Gx,i.Gy,n.ONE);static ZERO=new x(n.ZERO,n.ONE,n.ZERO);static Fp=n;static Fn=s;X;Y;Z;constructor(y,b,g){this.X=I("x",y),this.Y=I("y",b,!0),this.Z=I("z",g),Object.freeze(this)}static CURVE(){return i}static fromAffine(y){const{x:b,y:g}=y||{};if(!y||!n.isValid(b)||!n.isValid(g))throw new Error("invalid affine point");if(y instanceof x)throw new Error("projective point not allowed");return n.is0(b)&&n.is0(g)?x.ZERO:new x(b,g,n.ONE)}static fromBytes(y){const b=x.fromAffine(_(_t(y,void 0,"point")));return b.assertValidity(),b}static fromHex(y){return x.fromBytes(Il(y))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(y=8,b=!0){return j.createCache(this,y),b||this.multiply(sf),this}assertValidity(){Y(this)}hasEvenY(){const{y}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(y)}equals(y){q(y);const{X:b,Y:g,Z:C}=this,{X:B,Y:M,Z:O}=y,$=n.eql(n.mul(b,O),n.mul(B,C)),V=n.eql(n.mul(g,O),n.mul(M,C));return $&&V}negate(){return new x(this.X,n.neg(this.Y),this.Z)}double(){const{a:y,b}=i,g=n.mul(b,sf),{X:C,Y:B,Z:M}=this;let O=n.ZERO,$=n.ZERO,V=n.ZERO,G=n.mul(C,C),de=n.mul(B,B),ce=n.mul(M,M),re=n.mul(C,B);return re=n.add(re,re),V=n.mul(C,M),V=n.add(V,V),O=n.mul(y,V),$=n.mul(g,ce),$=n.add(O,$),O=n.sub(de,$),$=n.add(de,$),$=n.mul(O,$),O=n.mul(re,O),V=n.mul(g,V),ce=n.mul(y,ce),re=n.sub(G,ce),re=n.mul(y,re),re=n.add(re,V),V=n.add(G,G),G=n.add(V,G),G=n.add(G,ce),G=n.mul(G,re),$=n.add($,G),ce=n.mul(B,M),ce=n.add(ce,ce),G=n.mul(ce,re),O=n.sub(O,G),V=n.mul(ce,de),V=n.add(V,V),V=n.add(V,V),new x(O,$,V)}add(y){q(y);const{X:b,Y:g,Z:C}=this,{X:B,Y:M,Z:O}=y;let $=n.ZERO,V=n.ZERO,G=n.ZERO;const de=i.a,ce=n.mul(i.b,sf);let re=n.mul(b,B),pe=n.mul(g,M),_e=n.mul(C,O),$e=n.add(b,g),ge=n.add(B,M);$e=n.mul($e,ge),ge=n.add(re,pe),$e=n.sub($e,ge),ge=n.add(b,C);let ke=n.add(B,O);return ge=n.mul(ge,ke),ke=n.add(re,_e),ge=n.sub(ge,ke),ke=n.add(g,C),$=n.add(M,O),ke=n.mul(ke,$),$=n.add(pe,_e),ke=n.sub(ke,$),G=n.mul(de,ge),$=n.mul(ce,_e),G=n.add($,G),$=n.sub(pe,G),G=n.add(pe,G),V=n.mul($,G),pe=n.add(re,re),pe=n.add(pe,re),_e=n.mul(de,_e),ge=n.mul(ce,ge),pe=n.add(pe,_e),_e=n.sub(re,_e),_e=n.mul(de,_e),ge=n.add(ge,_e),re=n.mul(pe,ge),V=n.add(V,re),re=n.mul(ke,ge),$=n.mul($e,$),$=n.sub($,re),re=n.mul($e,pe),G=n.mul(ke,G),G=n.add(G,re),new x($,V,G)}subtract(y){return this.add(y.negate())}is0(){return this.equals(x.ZERO)}multiply(y){const{endo:b}=e;if(!s.isValidNot0(y))throw new Error("invalid scalar: out of range");let g,C;const B=M=>j.cached(this,M,O=>Xc(x,O));if(b){const{k1neg:M,k1:O,k2neg:$,k2:V}=L(y),{p:G,f:de}=B(O),{p:ce,f:re}=B(V);C=de.add(re),g=k(b.beta,G,ce,M,$)}else{const{p:M,f:O}=B(y);g=M,C=O}return Xc(x,[g,C])[0]}multiplyUnsafe(y){const{endo:b}=e,g=this;if(!s.isValid(y))throw new Error("invalid scalar: out of range");if(y===Cs||g.is0())return x.ZERO;if(y===Ia)return g;if(j.hasCache(this))return this.multiply(y);if(b){const{k1neg:C,k1:B,k2neg:M,k2:O}=L(y),{p1:$,p2:V}=_D(x,g,B,O);return k(b.beta,$,V,C,M)}else return j.unsafe(g,y)}toAffine(y){return z(this,y)}isTorsionFree(){const{isTorsionFree:y}=e;return o===Ia?!0:y?y(x,this):j.unsafe(this,a).is0()}clearCofactor(){const{clearCofactor:y}=e;return o===Ia?this:y?y(x,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(y=!0){return Ao(y,"isCompressed"),this.assertValidity(),m(x,this,y)}toHex(y=!0){return pu(this.toBytes(y))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const F=s.BITS,j=new $7(x,e.endo?Math.ceil(F/2):F);return x.BASE.precompute(8),x}function W7(r){return Uint8Array.of(r?2:3)}function G7(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function tq(r,e={}){const{Fn:t}=r,n=e.randomBytes||ag,s=Object.assign(G7(r.Fp,t),{seed:B7(t.ORDER)});function i(m){try{const _=t.fromBytes(m);return t.isValidNot0(_)}catch{return!1}}function o(m,_){const{publicKey:R,publicKeyUncompressed:T}=s;try{const A=m.length;return _===!0&&A!==R||_===!1&&A!==T?!1:!!r.fromBytes(m)}catch{return!1}}function a(m=n(s.seed)){return wD(_t(m,s.seed,"seed"),t.ORDER)}function c(m,_=!0){return r.BASE.multiply(t.fromBytes(m)).toBytes(_)}function l(m){const{secretKey:_,publicKey:R,publicKeyUncompressed:T}=s;if(!qh(m)||"_lengths"in t&&t._lengths||_===R)return;const A=_t(m,void 0,"key").length;return A===R||A===T}function h(m,_,R=!0){if(l(m)===!0)throw new Error("first arg must be private key");if(l(_)===!1)throw new Error("second arg must be public key");const T=t.fromBytes(m);return r.fromBytes(_).multiply(T).toBytes(R)}const f={isValidSecretKey:i,isValidPublicKey:o,randomSecretKey:a},p=N7(a,c);return Object.freeze({getPublicKey:c,getSharedSecret:h,keygen:p,Point:r,utils:f,lengths:s})}function nq(r,e,t={}){g7(e),gu(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),t=Object.assign({},t);const n=t.randomBytes||ag,s=t.hmac||((b,g)=>K7(e,b,g)),{Fp:i,Fn:o}=r,{ORDER:a,BITS:c}=o,{keygen:l,getPublicKey:h,getSharedSecret:f,utils:p,lengths:m}=tq(r,t),_={prehash:!0,lowS:typeof t.lowS=="boolean"?t.lowS:!0,format:"compact",extraEntropy:!1},R=a*z7<i.ORDER;function T(b){const g=a>>Ia;return b>g}function A(b,g){if(!o.isValidNot0(g))throw new Error(`invalid signature ${b}: out of range 1..Point.Fn.ORDER`);return g}function D(){if(R)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function I(b,g){c3(g);const C=m.signature,B=g==="compact"?C:g==="recovered"?C+1:void 0;return _t(b,B)}class q{r;s;recovery;constructor(g,C,B){if(this.r=A("r",g),this.s=A("s",C),B!=null){if(D(),![0,1,2,3].includes(B))throw new Error("invalid recovery id");this.recovery=B}Object.freeze(this)}static fromBytes(g,C=_.format){I(g,C);let B;if(C==="der"){const{r:V,s:G}=xi.toSig(_t(g));return new q(V,G)}C==="recovered"&&(B=g[0],C="compact",g=g.subarray(1));const M=m.signature/2,O=g.subarray(0,M),$=g.subarray(M,M*2);return new q(o.fromBytes(O),o.fromBytes($),B)}static fromHex(g,C){return this.fromBytes(Il(g),C)}assertRecovery(){const{recovery:g}=this;if(g==null)throw new Error("invalid recovery id: must be present");return g}addRecoveryBit(g){return new q(this.r,this.s,g)}recoverPublicKey(g){const{r:C,s:B}=this,M=this.assertRecovery(),O=M===2||M===3?C+a:C;if(!i.isValid(O))throw new Error("invalid recovery id: sig.r+curve.n != R.x");const $=i.toBytes(O),V=r.fromBytes(Xr(W7((M&1)===0),$)),G=o.inv(O),de=z(_t(g,void 0,"msgHash")),ce=o.create(-de*G),re=o.create(B*G),pe=r.BASE.multiplyUnsafe(ce).add(V.multiplyUnsafe(re));if(pe.is0())throw new Error("invalid recovery: point at infinify");return pe.assertValidity(),pe}hasHighS(){return T(this.s)}toBytes(g=_.format){if(c3(g),g==="der")return Il(xi.hexFromSig(this));const{r:C,s:B}=this,M=o.toBytes(C),O=o.toBytes(B);return g==="recovered"?(D(),Xr(Uint8Array.of(this.assertRecovery()),M,O)):Xr(M,O)}toHex(g){return pu(this.toBytes(g))}}const L=t.bits2int||function(g){if(g.length>8192)throw new Error("input is too large");const C=Bh(g),B=g.length*8-c;return B>0?C>>BigInt(B):C},z=t.bits2int_modN||function(g){return o.create(L(g))},Y=ug(c);function k(b){return o3("num < 2^"+c,b,Cs,Y),o.toBytes(b)}function x(b,g){return _t(b,void 0,"message"),g?_t(e(b),void 0,"prehashed message"):b}function F(b,g,C){const{lowS:B,prehash:M,extraEntropy:O}=o0(C,_);b=x(b,M);const $=z(b),V=o.fromBytes(g);if(!o.isValidNot0(V))throw new Error("invalid private key");const G=[k(V),k($)];if(O!=null&&O!==!1){const pe=O===!0?n(m.secretKey):O;G.push(_t(pe,void 0,"extraEntropy"))}const de=Xr(...G),ce=$;function re(pe){const _e=L(pe);if(!o.isValidNot0(_e))return;const $e=o.inv(_e),ge=r.BASE.multiply(_e).toAffine(),ke=o.create(ge.x);if(ke===Cs)return;const ht=o.create($e*o.create(ce+ke*V));if(ht===Cs)return;let qt=(ge.x===ke?0:2)|Number(ge.y&Ia),$t=ht;return B&&T(ht)&&($t=o.neg(ht),qt^=1),new q(ke,$t,R?void 0:qt)}return{seed:de,k2sig:re}}function j(b,g,C={}){const{seed:B,k2sig:M}=F(b,g,C);return aD(e.outputLen,o.BYTES,s)(B,M).toBytes(C.format)}function U(b,g,C,B={}){const{lowS:M,prehash:O,format:$}=o0(B,_);if(C=_t(C,void 0,"publicKey"),g=x(g,O),!qh(b)){const V=b instanceof q?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+V)}I(b,$);try{const V=q.fromBytes(b,$),G=r.fromBytes(C);if(M&&V.hasHighS())return!1;const{r:de,s:ce}=V,re=z(g),pe=o.inv(ce),_e=o.create(re*pe),$e=o.create(de*pe),ge=r.BASE.multiplyUnsafe(_e).add(G.multiplyUnsafe($e));return ge.is0()?!1:o.create(ge.x)===de}catch{return!1}}function y(b,g,C={}){const{prehash:B}=o0(C,_);return g=x(g,B),q.fromBytes(b,"recovered").recoverPublicKey(g).toBytes()}return Object.freeze({keygen:l,getPublicKey:h,getSharedSecret:f,utils:p,lengths:m,Point:r,sign:j,verify:U,recoverPublicKey:y,Signature:q,hash:e})}const hg={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},rq={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},U6=BigInt(2);function sq(r){const e=hg.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,h=l*l*r%e,f=Gt(h,t,e)*h%e,p=Gt(f,t,e)*h%e,m=Gt(p,U6,e)*l%e,_=Gt(m,s,e)*m%e,R=Gt(_,i,e)*_%e,T=Gt(R,a,e)*R%e,A=Gt(T,c,e)*T%e,D=Gt(A,a,e)*R%e,I=Gt(D,t,e)*h%e,q=Gt(I,o,e)*_%e,L=Gt(q,n,e)*l%e,z=Gt(L,U6,e);if(!l3.eql(l3.sqr(z),r))throw new Error("Cannot find square root");return z}const l3=Lh(hg.p,{sqrt:sq}),iq=eq(hg,{Fp:l3,endo:rq}),Ad=nq(iq,E7);function oq(r,e,t,n){const s=$r.digest(t instanceof Uint8Array?t:t.subarray());if(F7(s))return s.then(({digest:i})=>(n?.signal?.throwIfAborted(),Ad.verify(e,i,r,{prehash:!1,format:"der"}))).catch(i=>{throw i.name==="AbortError"?i:new $6(String(i))});try{return n?.signal?.throwIfAborted(),Ad.verify(e,s.digest,r,{prehash:!1,format:"der"})}catch(i){throw new $6(String(i))}}let aq=class{type="secp256k1";raw;_key;constructor(e){this._key=uq(e),this.raw=lq(this._key)}toMultihash(){return Kt.digest(Oh(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){return oq(this._key,t,e,n)}};function cq(r){return new aq(r)}function lq(r){return Ad.Point.fromBytes(r).toBytes()}function uq(r){try{return Ad.Point.fromBytes(r),r}catch(e){throw new h7(String(e))}}function fq(r,e){const{Type:t,Data:n}=Cl.decode(r),s=n??new Uint8Array;switch(t){case sr.RSA:return ZD(s,e);case sr.Ed25519:return FD(s);case sr.secp256k1:return cq(s);case sr.ECDSA:return LP(s);default:throw new wP}}function Oh(r){return Cl.encode({Type:sr[r.type],Data:r.raw})}var Id;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:St(0),payloadType:St(0),payload:St(0),signature:St(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=t.bytes();break}case 5:{i.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(Id||(Id={}));class dq extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}}class ss{static createFromProtobuf=e=>{const t=Id.decode(e),n=fq(t.publicKey);return new ss({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t,n)=>{if(t==null)throw new Error("Missing private key");const s=e.domain,i=e.codec,o=e.marshal(),a=F6(s,i,o),c=await t.sign(a.subarray(),n);return new ss({publicKey:t.publicKey,payloadType:i,payload:o,signature:c})};static openAndCertify=async(e,t,n)=>{const s=ss.createFromProtobuf(e);if(!await s.validate(t,n))throw new dq("Envelope signature is not valid for the given domain");return s};publicKey;payloadType;payload;signature;marshaled;constructor(e){const{publicKey:t,payloadType:n,payload:s,signature:i}=e;this.publicKey=t,this.payloadType=n,this.payload=s,this.signature=i}marshal(){return this.marshaled==null&&(this.marshaled=Id.encode({publicKey:Oh(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:at(this.marshal(),e.marshal())}async validate(e,t){const n=F6(e,this.payloadType,this.payload);return this.publicKey.verify(n.subarray(),this.signature,t)}}const F6=(r,e,t)=>{const n=Ge(r),s=Ri(n.byteLength),i=Ri(e.length),o=Ri(t.length);return new Ue(s,n,i,e,o,t)};function hq(r,e){const t=(n,s)=>n.toString().localeCompare(s.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,s)=>e[s].equals(n)))}const pq="libp2p-peer-record",gq=Uint8Array.from([3,1]);var Td;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=tt((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.multiaddr!=null&&s.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(s.multiaddr)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={multiaddr:St(0)},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();l>>>3===1?a.multiaddr=s.bytes():s.skipType(l&7)}return a})),n),t.encode=s=>et(s,t.codec()),t.decode=(s,i)=>Je(s,t.codec(),i)})(r.AddressInfo||(r.AddressInfo={}));let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.peerId!=null&&t.peerId.byteLength>0&&(n.uint32(10),n.bytes(t.peerId)),t.seq!=null&&t.seq!==0n&&(n.uint32(16),n.uint64(t.seq)),t.addresses!=null)for(const i of t.addresses)n.uint32(26),r.AddressInfo.codec().encode(i,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={peerId:St(0),seq:0n,addresses:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.peerId=t.bytes();break}case 2:{i.seq=t.uint64();break}case 3:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new Mt('Decode error - map field "addresses" had too many elements');i.addresses.push(r.AddressInfo.codec().decode(t,t.uint32(),{limits:s.limits?.addresses$}));break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(Td||(Td={}));class vr{static createFromProtobuf=e=>{const t=Td.decode(e),n=mr(Gn(t.peerId)),s=(t.addresses??[]).map(o=>lt(o.multiaddr)),i=t.seq;return new vr({peerId:n,multiaddrs:s,seqNumber:i})};static DOMAIN=pq;static CODEC=gq;peerId;multiaddrs;seqNumber;domain=vr.DOMAIN;codec=vr.CODEC;marshaled;constructor(e){const{peerId:t,multiaddrs:n,seqNumber:s}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=Td.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof vr)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!hq(this.multiaddrs,e.multiaddrs))}}function mq(r){return r[Symbol.asyncIterator]!=null}function kd(r){if(mq(r))return(async()=>{const t=[];for await(const n of r)t.push(n);return t})();const e=[];for(const t of r)e.push(t);return e}let Ya=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};function en(){const r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}class H6{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}class a0{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new H6(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new H6(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let yq=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function Or(r={}){return bq(t=>{const n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function bq(r,e){e=e??{};let t=e.onEnd,n=new a0,s,i,o,a=en();const c=async()=>{try{return n.isEmpty()?o?{done:!0}:await new Promise((T,A)=>{i=D=>{i=null,n.push(D);try{T(r(n))}catch(I){A(I)}return s}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=en()})}},l=T=>i!=null?i(T):(n.push(T),s),h=T=>(n=new a0,i!=null?i({error:T}):(n.push({error:T}),s)),f=T=>{if(o)return s;if(e?.objectMode!==!0&&T?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:T})},p=T=>o?s:(o=!0,T!=null?h(T):l({done:!0})),m=()=>(n=new a0,p(),{done:!0}),_=T=>(p(T),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:m,throw:_,push:f,end:p,get readableLength(){return n.size},onEmpty:async T=>{const A=T?.signal;if(A?.throwIfAborted(),n.isEmpty())return;let D,I;A!=null&&(D=new Promise((q,L)=>{I=()=>{L(new yq)},A.addEventListener("abort",I)}));try{await Promise.race([a.promise,D])}finally{I!=null&&A!=null&&A?.removeEventListener("abort",I)}}},t==null)return s;const R=s;return s={[Symbol.asyncIterator](){return this},next(){return R.next()},throw(T){return R.throw(T),t!=null&&(t(T),t=void 0),{done:!0}},return(){return R.return(),t!=null&&(t(),t=void 0),{done:!0}},push:f,end(T){return R.end(T),t!=null&&(t(T),t=void 0),s},get readableLength(){return R.readableLength},onEmpty:T=>R.onEmpty(T)},s}async function uo(r,e,t,n){const s=new Ya(n?.errorMessage);n?.errorCode!=null&&(s.code=n.errorCode);const i=n?.errorEvent??"error";return t?.aborted===!0?Promise.reject(s):new Promise((o,a)=>{function c(){l0(t,"abort",f),l0(r,e,l),l0(r,i,h)}const l=p=>{try{if(n?.filter?.(p)===!1)return}catch(m){c(),a(m);return}c(),o(p)},h=p=>{if(c(),p instanceof Error){a(p);return}a(p.detail??n?.error??new Error(`The "${n?.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},f=()=>{c(),a(s)};c0(t,"abort",f),c0(r,e,l),c0(r,i,h)})}function c0(r,e,t){r!=null&&(Z7(r)?r.addEventListener(e,t):r.addListener(e,t))}function l0(r,e,t){r!=null&&(Z7(r)?r.removeEventListener(e,t):r.removeListener(e,t))}function Z7(r){return typeof r.addEventListener=="function"&&typeof r.removeEventListener=="function"}let wq=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};function _q(r){return r.reason}async function Eq(r,e,t){if(e==null)return r;const n=_q;if(e.aborted)return r.catch(()=>{}),Promise.reject(n(e));let s;try{return await Promise.race([r,new Promise((i,o)=>{s=()=>{o(n(e))},e.addEventListener("abort",s)})])}finally{s!=null&&e.removeEventListener("abort",s)}}let vq=class{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Ya)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function xq(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}let Sq=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=xq(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new Ya),this.cleanup())}async join(e={}){const t=new vq(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Eq(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};function V6(r,e){let t;const n=function(){const s=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(s,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}let K6=class extends Cn{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=V6(this.emitEmpty.bind(this),1),this.emitIdle=V6(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new wq;const n=new Sq(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),n.join(t).then(s=>(this.safeDispatchEvent("success",{detail:{job:n,result:s}}),s)).catch(s=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:s}}),s})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new Ya)}),this.clear()}async onEmpty(e){this.size!==0&&await uo(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await uo(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await uo(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=Or({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},s=c=>{c.detail!=null&&t.push(c.detail.result)},i=c=>{n(c.detail.error)},o=()=>{n()},a=()=>{n(new Ya("Queue aborted"))};this.addEventListener("success",s),this.addEventListener("failure",i),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("success",s),this.removeEventListener("failure",i),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",a),n()}}};const j7="lock:worker:request-read",Y7="lock:worker:abort-read-request",Q7="lock:worker:release-read",X7="lock:master:grant-read",J7="lock:master:error-read",e9="lock:worker:request-write",t9="lock:worker:abort-write-request",n9="lock:worker:release-write",r9="lock:master:grant-write",s9="lock:master:error-write",i9="lock:worker:finalize",o9="mortice",Aq={singleProcess:!1},z6=(r,e,t,n,s,i,o,a,c)=>l=>{if(l.data==null)return;const h={type:l.data.type,name:l.data.name,identifier:l.data.identifier};h.type===s&&r.safeDispatchEvent(t,{detail:{name:h.name,identifier:h.identifier,handler:async()=>{e.postMessage({type:c,name:h.name,identifier:h.identifier}),await new Promise(f=>{const p=m=>{if(m?.data==null)return;const _={type:m.data.type,name:m.data.name,identifier:m.data.identifier};_.type===a&&_.identifier===h.identifier&&(e.removeEventListener("message",p),f())};e.addEventListener("message",p)})},onError:f=>{e.postMessage({type:o,name:h.name,identifier:h.identifier,error:{message:f.message,name:f.name,stack:f.stack}})}}}),h.type===i&&r.safeDispatchEvent(n,{detail:{name:h.name,identifier:h.identifier}}),h.type===i9&&r.safeDispatchEvent("finalizeRequest",{detail:{name:h.name}})},Iq=(r=10)=>Math.random().toString().substring(2,r+2);class Tq{name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel(o9)}readLock(e){return this.sendRequest(j7,Y7,X7,J7,Q7,e)}writeLock(e){return this.sendRequest(e9,t9,r9,s9,n9,e)}finalize(){this.channel.postMessage({type:i9,name:this.name}),this.channel.close()}async sendRequest(e,t,n,s,i,o){o?.signal?.throwIfAborted();const a=Iq();return this.channel.postMessage({type:e,identifier:a,name:this.name}),new Promise((c,l)=>{const h=()=>{this.channel.postMessage({type:t,identifier:a,name:this.name})};o?.signal?.addEventListener("abort",h,{once:!0});const f=p=>{if(p.data?.identifier===a&&(p.data?.type===n&&(this.channel.removeEventListener("message",f),o?.signal?.removeEventListener("abort",h),c(()=>{this.channel.postMessage({type:i,identifier:a,name:this.name})})),p.data.type===s)){this.channel.removeEventListener("message",f),o?.signal?.removeEventListener("abort",h);const m=new Error;p.data.error!=null&&(m.message=p.data.error.message,m.name=p.data.error.name,m.stack=p.data.error.stack),l(m)}};this.channel.addEventListener("message",f)})}}var kq=r=>{if(r=Object.assign({},Aq,r),!!globalThis.document||r.singleProcess){const t=new BroadcastChannel(o9),n=new Cn;return t.addEventListener("message",z6(n,t,"requestReadLock","abortReadLockRequest",j7,Y7,J7,Q7,X7)),t.addEventListener("message",z6(n,t,"requestWriteLock","abortWriteLockRequest",e9,t9,s9,n9,r9)),n}return new Tq(r.name)};const Qi=new Map;let Dc;function a9(r){return typeof r?.readLock=="function"&&typeof r?.writeLock=="function"}function Cq(r){if(Dc==null&&(Dc=kq(r),!a9(Dc))){const e=Dc;e.addEventListener("requestReadLock",t=>{const n=t.detail.name,s=t.detail.identifier,i=Qi.get(n);if(i==null)return;const o=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==s||o.abort()};e.addEventListener("abortReadLockRequest",a),i.readLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortReadLockRequest",a)})}),e.addEventListener("requestWriteLock",t=>{const n=t.detail.name,s=t.detail.identifier,i=Qi.get(n);if(i==null)return;const o=new AbortController,a=c=>{c.detail.name!==n||c.detail.identifier!==s||o.abort()};e.addEventListener("abortWriteLockRequest",a),i.writeLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",a)})}),e.addEventListener("finalizeRequest",t=>{const n=t.detail.name,s=Qi.get(n);s?.finalize()})}return Dc}async function u0(r,e){let t,n;const s=new Promise((o,a)=>{t=o,n=a}),i=()=>{n(new Ya)};return e?.signal?.addEventListener("abort",i,{once:!0}),r.add(async()=>{await new Promise(o=>{t(()=>{e?.signal?.removeEventListener("abort",i),o()})})},{signal:e?.signal}).catch(o=>{n(o)}),s}const Rq=(r,e)=>{let t=Qi.get(r);if(t!=null)return t;const n=Cq(e);if(a9(n))return t=n,Qi.set(r,t),t;const s=new K6({concurrency:1});let i;return t={async readLock(o){if(i!=null)return u0(i,o);i=new K6({concurrency:e.concurrency,autoStart:!1});const a=i,c=u0(i,o);return s.add(async()=>{a.start(),await a.onIdle().then(()=>{i===a&&(i=null)})}),c},async writeLock(o){return i=null,u0(s,o)},finalize:()=>{Qi.delete(r)},queue:s},Qi.set(r,t),e.autoFinalize===!0&&s.addEventListener("idle",()=>{t.finalize()},{once:!0}),t},Pq={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function Dq(r){const e=Object.assign({},Pq,r);return Rq(e.name,e)}const qq=36e5,Bq=216e5;var Xi;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=tt((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&s.value.byteLength>0&&(i.uint32(18),i.bytes(s.value)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={key:"",value:St(0)},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.key=s.string();break}case 2:{a.value=s.bytes();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>et(s,t.codec()),t.decode=(s,i)=>Je(s,t.codec(),i)})(r.Peer$metadataEntry||(r.Peer$metadataEntry={})),(function(t){let n;t.codec=()=>(n==null&&(n=tt((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&(i.uint32(18),Rd.codec().encode(s.value,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={key:""},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.key=s.string();break}case 2:{a.value=Rd.codec().decode(s,s.uint32(),{limits:o.limits?.value});break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>et(s,t.codec()),t.decode=(s,i)=>Je(s,t.codec(),i)})(r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.addresses!=null)for(const i of t.addresses)n.uint32(10),Cd.codec().encode(i,n);if(t.protocols!=null)for(const i of t.protocols)n.uint32(18),n.string(i);if(t.publicKey!=null&&(n.uint32(34),n.bytes(t.publicKey)),t.peerRecordEnvelope!=null&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),t.metadata!=null&&t.metadata.size!==0)for(const[i,o]of t.metadata.entries())n.uint32(50),r.Peer$metadataEntry.codec().encode({key:i,value:o},n);if(t.tags!=null&&t.tags.size!==0)for(const[i,o]of t.tags.entries())n.uint32(58),r.Peer$tagsEntry.codec().encode({key:i,value:o},n);t.updated!=null&&(n.uint32(64),n.uint64Number(t.updated)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={addresses:[],protocols:[],metadata:new Map,tags:new Map},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new Mt('Decode error - map field "addresses" had too many elements');i.addresses.push(Cd.codec().decode(t,t.uint32(),{limits:s.limits?.addresses$}));break}case 2:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new Mt('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 4:{i.publicKey=t.bytes();break}case 5:{i.peerRecordEnvelope=t.bytes();break}case 6:{if(s.limits?.metadata!=null&&i.metadata.size===s.limits.metadata)throw new Gm('Decode error - map field "metadata" had too many elements');const c=r.Peer$metadataEntry.codec().decode(t,t.uint32());i.metadata.set(c.key,c.value);break}case 7:{if(s.limits?.tags!=null&&i.tags.size===s.limits.tags)throw new Gm('Decode error - map field "tags" had too many elements');const c=r.Peer$tagsEntry.codec().decode(t,t.uint32(),{limits:{value:s.limits?.tags$value}});i.tags.set(c.key,c.value);break}case 8:{i.updated=t.uint64Number();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(Xi||(Xi={}));var Cd;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),t.observed!=null&&(n.uint32(24),n.uint64Number(t.observed)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={multiaddr:St(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.multiaddr=t.bytes();break}case 2:{i.isCertified=t.bool();break}case 3:{i.observed=t.uint64Number();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(Cd||(Cd={}));var Rd;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={value:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.value=t.uint32();break}case 2:{i.expiry=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(Rd||(Rd={}));let $h=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},c9=class extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}},Lq=class extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};const Oq=parseInt("11111",2),u3=parseInt("10000000",2),$q=parseInt("01111111",2),W6={0:qc,1:qc,2:Mq,3:Fq,4:Hq,5:Uq,6:Nq,16:qc,22:qc,48:qc};function Mh(r,e={offset:0}){const t=r[e.offset]&Oq;if(e.offset++,W6[t]!=null)return W6[t](r,e);throw new Error("No decoder for tag "+t)}function mu(r,e){let t=0;if((r[e.offset]&u3)===u3){const n=r[e.offset]&$q;let s="0x";e.offset++;for(let i=0;i<n;i++,e.offset++)s+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=r[e.offset],e.offset++;return t}function qc(r,e){mu(r,e);const t=[];for(;!(e.offset>=r.byteLength);){const n=Mh(r,e);if(n===null)break;t.push(n)}return t}function Mq(r,e){const t=mu(r,e),n=e.offset,s=e.offset+t,i=[];for(let o=n;o<s;o++)o===n&&r[o]===0||i.push(r[o]);return e.offset+=t,Uint8Array.from(i)}function Nq(r,e){const t=mu(r,e),n=e.offset+t,s=r[e.offset];e.offset++;let i=0,o=0;s<40?(i=0,o=s):s<80?(i=1,o=s-40):(i=2,o=s-80);let a=`${i}.${o}`,c=[];for(;e.offset<n;){const l=r[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let h=0;for(let f=0;f<c.length;f++)h+=c[f]<<f*7;a+=`.${h}`,c=[]}}return a}function Uq(r,e){return e.offset++,null}function Fq(r,e){const t=mu(r,e),n=r[e.offset];e.offset++;const s=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function Hq(r,e){const t=mu(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function Vq(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);const t=new Ue;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function pg(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);const e=Vq(r.byteLength);return new Ue(Uint8Array.from([e.byteLength|u3]),e)}function f3(r){const e=new Ue,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Ue(Uint8Array.from([2]),pg(e),e)}function l9(r){const e=Uint8Array.from([0]),t=new Ue(e,r);return new Ue(Uint8Array.from([3]),pg(t),t)}function Jc(r,e=48){const t=new Ue;for(const n of r)t.append(n);return new Ue(Uint8Array.from([e]),pg(t),t)}async function Kq(r,e,t,n){const s=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();const i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return n?.signal?.throwIfAborted(),i}const zq=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),Wq=Uint8Array.from([6,5,43,129,4,0,34]),Gq=Uint8Array.from([6,5,43,129,4,0,35]),Zq={ext:!0,kty:"EC",crv:"P-256"},jq={ext:!0,kty:"EC",crv:"P-384"},Yq={ext:!0,kty:"EC",crv:"P-521"},f0=32,d0=48,h0=66;function Qq(r){const e=Mh(r);return Xq(e)}function Xq(r){const e=r[1][1][0],t=1;let n,s;if(e.byteLength===f0*2+1)return n=Le(e.subarray(t,t+f0),"base64url"),s=Le(e.subarray(t+f0),"base64url"),new p0({...Zq,key_ops:["verify"],x:n,y:s});if(e.byteLength===d0*2+1)return n=Le(e.subarray(t,t+d0),"base64url"),s=Le(e.subarray(t+d0),"base64url"),new p0({...jq,key_ops:["verify"],x:n,y:s});if(e.byteLength===h0*2+1)return n=Le(e.subarray(t,t+h0),"base64url"),s=Le(e.subarray(t+h0),"base64url"),new p0({...Yq,key_ops:["verify"],x:n,y:s});throw new $h(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function Jq(r){return Jc([f3(Uint8Array.from([1])),Jc([eB(r.crv)],160),Jc([l9(new Ue(Uint8Array.from([4]),Ge(r.x??"","base64url"),Ge(r.y??"","base64url")))],161)]).subarray()}function eB(r){if(r==="P-256")return zq;if(r==="P-384")return Wq;if(r==="P-521")return Gq;throw new $h(`Invalid curve ${r}`)}let p0=class{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=Jq(this.jwk)),this._raw}toMultihash(){return Kt.digest(ka(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}async verify(e,t,n){return Kq(this.jwk,t,e,n)}};function Nh(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Io(r,e=""){if(!Number.isSafeInteger(r)||r<0){const t=e&&`"${e}" `;throw new Error(`${t}expected integer >= 0, got ${r}`)}}function Et(r,e,t=""){const n=Nh(r),s=r?.length,i=e!==void 0;if(!n||i&&s!==e){const o=t&&`"${t}" `,a=i?` of length ${e}`:"",c=n?`length=${s}`:`type=${typeof r}`;throw new Error(o+"expected Uint8Array"+a+", got "+c)}return r}function u9(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash must wrapped by utils.createHasher");Io(r.outputLen),Io(r.blockLen)}function Pd(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function tB(r,e){Et(r,void 0,"digestInto() output");const t=e.outputLen;if(r.length<t)throw new Error('"digestInto() output" expected to be of length >='+t)}function Qa(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function g0(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function Hr(r,e){return r<<32-e|r>>>e}const f9=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",nB=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function yu(r){if(Et(r),f9)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=nB[r[t]];return e}const ps={_0:48,_9:57,A:65,F:70,a:97,f:102};function G6(r){if(r>=ps._0&&r<=ps._9)return r-ps._0;if(r>=ps.A&&r<=ps.F)return r-(ps.A-10);if(r>=ps.a&&r<=ps.f)return r-(ps.a-10)}function Rl(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(f9)return Uint8Array.fromHex(r);const e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(t);for(let s=0,i=0;s<t;s++,i+=2){const o=G6(r.charCodeAt(i)),a=G6(r.charCodeAt(i+1));if(o===void 0||a===void 0){const c=r[i]+r[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[s]=o*16+a}return n}function Jr(...r){let e=0;for(let n=0;n<r.length;n++){const s=r[n];Et(s),e+=s.length}const t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){const i=r[n];t.set(i,s),s+=i.length}return t}function d9(r,e={}){const t=(s,i)=>r(i).update(s).digest(),n=r(void 0);return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=s=>r(s),Object.assign(t,e),Object.freeze(t)}function gg(r=32){const e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}const h9=r=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,r])});function rB(r,e,t){return r&e^~r&t}function sB(r,e,t){return r&e^r&t^e&t}let p9=class{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(e,t,n,s){this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=g0(this.buffer)}update(e){Pd(this),Et(e);const{view:t,buffer:n,blockLen:s}=this,i=e.length;for(let o=0;o<i;){const a=Math.min(s-this.pos,i-o);if(a===s){const c=g0(e);for(;s<=i-o;o+=s)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Pd(this),tB(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:s,isLE:i}=this;let{pos:o}=this;t[o++]=128,Qa(this.buffer.subarray(o)),this.padOffset>s-o&&(this.process(n,0),o=0);for(let f=o;f<s;f++)t[f]=0;n.setBigUint64(s-8,BigInt(this.length*8),i),this.process(n,0);const a=g0(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");const l=c/4,h=this.get();if(l>h.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<l;f++)a.setUint32(4*f,h[f],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||=new this.constructor,e.set(...this.get());const{blockLen:t,buffer:n,length:s,finished:i,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=i,e.length=s,e.pos=a,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}};const ti=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Ln=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),of=BigInt(2**32-1),Z6=BigInt(32);function iB(r,e=!1){return e?{h:Number(r&of),l:Number(r>>Z6&of)}:{h:Number(r>>Z6&of)|0,l:Number(r&of)|0}}function oB(r,e=!1){const t=r.length;let n=new Uint32Array(t),s=new Uint32Array(t);for(let i=0;i<t;i++){const{h:o,l:a}=iB(r[i],e);[n[i],s[i]]=[o,a]}return[n,s]}const j6=(r,e,t)=>r>>>t,Y6=(r,e,t)=>r<<32-t|e>>>t,ea=(r,e,t)=>r>>>t|e<<32-t,ta=(r,e,t)=>r<<32-t|e>>>t,af=(r,e,t)=>r<<64-t|e>>>t-32,cf=(r,e,t)=>r>>>t-32|e<<64-t;function gs(r,e,t,n){const s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}const aB=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),cB=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,lB=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),uB=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,fB=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),dB=(r,e,t,n,s,i)=>e+t+n+s+i+(r/2**32|0)|0,hB=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),ni=new Uint32Array(64);let pB=class extends p9{constructor(e){super(64,e,8,!1)}get(){const{A:e,B:t,C:n,D:s,E:i,F:o,G:a,H:c}=this;return[e,t,n,s,i,o,a,c]}set(e,t,n,s,i,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let f=0;f<16;f++,t+=4)ni[f]=e.getUint32(t,!1);for(let f=16;f<64;f++){const p=ni[f-15],m=ni[f-2],_=Hr(p,7)^Hr(p,18)^p>>>3,R=Hr(m,17)^Hr(m,19)^m>>>10;ni[f]=R+ni[f-7]+_+ni[f-16]|0}let{A:n,B:s,C:i,D:o,E:a,F:c,G:l,H:h}=this;for(let f=0;f<64;f++){const p=Hr(a,6)^Hr(a,11)^Hr(a,25),m=h+p+rB(a,c,l)+hB[f]+ni[f]|0,R=(Hr(n,2)^Hr(n,13)^Hr(n,22))+sB(n,s,i)|0;h=l,l=c,c=a,a=o+m|0,o=i,i=s,s=n,n=m+R|0}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,h=h+this.H|0,this.set(n,s,i,o,a,c,l,h)}roundClean(){Qa(ni)}destroy(){this.set(0,0,0,0,0,0,0,0),Qa(this.buffer)}},gB=class extends pB{A=ti[0]|0;B=ti[1]|0;C=ti[2]|0;D=ti[3]|0;E=ti[4]|0;F=ti[5]|0;G=ti[6]|0;H=ti[7]|0;constructor(){super(32)}};const g9=oB(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),mB=g9[0],yB=g9[1],ri=new Uint32Array(80),si=new Uint32Array(80);let bB=class extends p9{constructor(e){super(128,e,16,!1)}get(){const{Ah:e,Al:t,Bh:n,Bl:s,Ch:i,Cl:o,Dh:a,Dl:c,Eh:l,El:h,Fh:f,Fl:p,Gh:m,Gl:_,Hh:R,Hl:T}=this;return[e,t,n,s,i,o,a,c,l,h,f,p,m,_,R,T]}set(e,t,n,s,i,o,a,c,l,h,f,p,m,_,R,T){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=h|0,this.Fh=f|0,this.Fl=p|0,this.Gh=m|0,this.Gl=_|0,this.Hh=R|0,this.Hl=T|0}process(e,t){for(let I=0;I<16;I++,t+=4)ri[I]=e.getUint32(t),si[I]=e.getUint32(t+=4);for(let I=16;I<80;I++){const q=ri[I-15]|0,L=si[I-15]|0,z=ea(q,L,1)^ea(q,L,8)^j6(q,L,7),Y=ta(q,L,1)^ta(q,L,8)^Y6(q,L,7),k=ri[I-2]|0,x=si[I-2]|0,F=ea(k,x,19)^af(k,x,61)^j6(k,x,6),j=ta(k,x,19)^cf(k,x,61)^Y6(k,x,6),U=lB(Y,j,si[I-7],si[I-16]),y=uB(U,z,F,ri[I-7],ri[I-16]);ri[I]=y|0,si[I]=U|0}let{Ah:n,Al:s,Bh:i,Bl:o,Ch:a,Cl:c,Dh:l,Dl:h,Eh:f,El:p,Fh:m,Fl:_,Gh:R,Gl:T,Hh:A,Hl:D}=this;for(let I=0;I<80;I++){const q=ea(f,p,14)^ea(f,p,18)^af(f,p,41),L=ta(f,p,14)^ta(f,p,18)^cf(f,p,41),z=f&m^~f&R,Y=p&_^~p&T,k=fB(D,L,Y,yB[I],si[I]),x=dB(k,A,q,z,mB[I],ri[I]),F=k|0,j=ea(n,s,28)^af(n,s,34)^af(n,s,39),U=ta(n,s,28)^cf(n,s,34)^cf(n,s,39),y=n&i^n&a^i&a,b=s&o^s&c^o&c;A=R|0,D=T|0,R=m|0,T=_|0,m=f|0,_=p|0,{h:f,l:p}=gs(l|0,h|0,x|0,F|0),l=a|0,h=c|0,a=i|0,c=o|0,i=n|0,o=s|0;const g=aB(F,U,b);n=cB(g,x,j,y),s=g|0}({h:n,l:s}=gs(this.Ah|0,this.Al|0,n|0,s|0)),{h:i,l:o}=gs(this.Bh|0,this.Bl|0,i|0,o|0),{h:a,l:c}=gs(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:h}=gs(this.Dh|0,this.Dl|0,l|0,h|0),{h:f,l:p}=gs(this.Eh|0,this.El|0,f|0,p|0),{h:m,l:_}=gs(this.Fh|0,this.Fl|0,m|0,_|0),{h:R,l:T}=gs(this.Gh|0,this.Gl|0,R|0,T|0),{h:A,l:D}=gs(this.Hh|0,this.Hl|0,A|0,D|0),this.set(n,s,i,o,a,c,l,h,f,p,m,_,R,T,A,D)}roundClean(){Qa(ri,si)}destroy(){Qa(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},wB=class extends bB{Ah=Ln[0]|0;Al=Ln[1]|0;Bh=Ln[2]|0;Bl=Ln[3]|0;Ch=Ln[4]|0;Cl=Ln[5]|0;Dh=Ln[6]|0;Dl=Ln[7]|0;Eh=Ln[8]|0;El=Ln[9]|0;Fh=Ln[10]|0;Fl=Ln[11]|0;Gh=Ln[12]|0;Gl=Ln[13]|0;Hh=Ln[14]|0;Hl=Ln[15]|0;constructor(){super(64)}};const m9=d9(()=>new gB,h9(1)),_B=d9(()=>new wB,h9(3));const mg=BigInt(0),d3=BigInt(1);function To(r,e=""){if(typeof r!="boolean"){const t=e&&`"${e}" `;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function y9(r){if(typeof r=="bigint"){if(!Gf(r))throw new Error("positive bigint expected, got "+r)}else Io(r);return r}function lf(r){const e=y9(r).toString(16);return e.length&1?"0"+e:e}function b9(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?mg:BigInt("0x"+r)}function Uh(r){return b9(yu(r))}function Pl(r){return b9(yu(h3(Et(r)).reverse()))}function yg(r,e){Io(e),r=y9(r);const t=Rl(r.toString(16).padStart(e*2,"0"));if(t.length!==e)throw new Error("number too large");return t}function w9(r,e){return yg(r,e).reverse()}function h3(r){return Uint8Array.from(r)}const Gf=r=>typeof r=="bigint"&&mg<=r;function EB(r,e,t){return Gf(r)&&Gf(e)&&Gf(t)&&e<=r&&r<t}function p3(r,e,t,n){if(!EB(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function vB(r){let e;for(e=0;r>mg;r>>=d3,e+=1);return e}const bg=r=>(d3<<BigInt(r))-d3;function xB(r,e,t){if(Io(r,"hashLen"),Io(e,"qByteLen"),typeof t!="function")throw new Error("hmacFn must be a function");const n=T=>new Uint8Array(T),s=Uint8Array.of(),i=Uint8Array.of(0),o=Uint8Array.of(1),a=1e3;let c=n(r),l=n(r),h=0;const f=()=>{c.fill(1),l.fill(0),h=0},p=(...T)=>t(l,Jr(c,...T)),m=(T=s)=>{l=p(i,T),c=p(),T.length!==0&&(l=p(o,T),c=p())},_=()=>{if(h++>=a)throw new Error("drbg: tried max amount of iterations");let T=0;const A=[];for(;T<e;){c=p();const D=c.slice();A.push(D),T+=c.length}return Jr(...A)};return(T,A)=>{f(),m(T);let D;for(;!(D=A(_()));)m();return f(),D}}function bu(r,e={},t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(i,o,a){const c=r[i];if(a&&c===void 0)return;const l=typeof c;if(l!==o||c===null)throw new Error(`param "${i}" is invalid: expected ${o}, got ${l}`)}const s=(i,o)=>Object.entries(i).forEach(([a,c])=>n(a,c,o));s(e,!1),s(t,!0)}function Dd(r){const e=new WeakMap;return(t,...n)=>{const s=e.get(t);if(s!==void 0)return s;const i=r(t,...n);return e.set(t,i),i}}const ir=BigInt(0),An=BigInt(1),Ji=BigInt(2),_9=BigInt(3),E9=BigInt(4),v9=BigInt(5),SB=BigInt(7),x9=BigInt(8),AB=BigInt(9),S9=BigInt(16);function an(r,e){const t=r%e;return t>=ir?t:e+t}function Zt(r,e,t){let n=r;for(;e-- >ir;)n*=n,n%=t;return n}function Q6(r,e){if(r===ir)throw new Error("invert: expected non-zero number");if(e<=ir)throw new Error("invert: expected positive modulus, got "+e);let t=an(r,e),n=e,s=ir,i=An;for(;t!==ir;){const a=n/t,c=n%t,l=s-i*a;n=t,t=c,s=i,i=l}if(n!==An)throw new Error("invert: does not exist");return an(s,e)}function wg(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function A9(r,e){const t=(r.ORDER+An)/E9,n=r.pow(e,t);return wg(r,n,e),n}function IB(r,e){const t=(r.ORDER-v9)/x9,n=r.mul(e,Ji),s=r.pow(n,t),i=r.mul(e,s),o=r.mul(r.mul(i,Ji),s),a=r.mul(i,r.sub(o,r.ONE));return wg(r,a,e),a}function TB(r){const e=Fh(r),t=I9(r),n=t(e,e.neg(e.ONE)),s=t(e,n),i=t(e,e.neg(n)),o=(r+SB)/S9;return(a,c)=>{let l=a.pow(c,o),h=a.mul(l,n);const f=a.mul(l,s),p=a.mul(l,i),m=a.eql(a.sqr(h),c),_=a.eql(a.sqr(f),c);l=a.cmov(l,h,m),h=a.cmov(p,f,_);const R=a.eql(a.sqr(h),c),T=a.cmov(l,h,R);return wg(a,T,c),T}}function I9(r){if(r<_9)throw new Error("sqrt is not defined for small field");let e=r-An,t=0;for(;e%Ji===ir;)e/=Ji,t++;let n=Ji;const s=Fh(r);for(;X6(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return A9;let i=s.pow(n,e);const o=(e+An)/Ji;return function(c,l){if(c.is0(l))return l;if(X6(c,l)!==1)throw new Error("Cannot find square root");let h=t,f=c.mul(c.ONE,i),p=c.pow(l,e),m=c.pow(l,o);for(;!c.eql(p,c.ONE);){if(c.is0(p))return c.ZERO;let _=1,R=c.sqr(p);for(;!c.eql(R,c.ONE);)if(_++,R=c.sqr(R),_===h)throw new Error("Cannot find square root");const T=An<<BigInt(h-_-1),A=c.pow(f,T);h=_,f=c.sqr(A),p=c.mul(p,f),m=c.mul(m,A)}return m}}function kB(r){return r%E9===_9?A9:r%x9===v9?IB:r%S9===AB?TB(r):I9(r)}const CB=(r,e)=>(an(r,e)&An)===An,RB=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function PB(r){const e={ORDER:"bigint",BYTES:"number",BITS:"number"},t=RB.reduce((n,s)=>(n[s]="function",n),e);return bu(r,t),r}function DB(r,e,t){if(t<ir)throw new Error("invalid exponent, negatives unsupported");if(t===ir)return r.ONE;if(t===An)return e;let n=r.ONE,s=e;for(;t>ir;)t&An&&(n=r.mul(n,s)),s=r.sqr(s),t>>=An;return n}function T9(r,e,t=!1){const n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((o,a,c)=>r.is0(a)?o:(n[c]=o,r.mul(o,a)),r.ONE),i=r.inv(s);return e.reduceRight((o,a,c)=>r.is0(a)?o:(n[c]=r.mul(o,n[c]),r.mul(o,a)),i),n}function X6(r,e){const t=(r.ORDER-An)/Ji,n=r.pow(e,t),s=r.eql(n,r.ONE),i=r.eql(n,r.ZERO),o=r.eql(n,r.neg(r.ONE));if(!s&&!i&&!o)throw new Error("invalid Legendre symbol result");return s?1:i?0:-1}function qB(r,e){e!==void 0&&Io(e);const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}let BB=class{ORDER;BITS;BYTES;isLE;ZERO=ir;ONE=An;_lengths;_sqrt;_mod;constructor(e,t={}){if(e<=ir)throw new Error("invalid field: expected ORDER > 0, got "+e);let n;this.isLE=!1,t!=null&&typeof t=="object"&&(typeof t.BITS=="number"&&(n=t.BITS),typeof t.sqrt=="function"&&(this.sqrt=t.sqrt),typeof t.isLE=="boolean"&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),typeof t.modFromBytes=="boolean"&&(this._mod=t.modFromBytes));const{nBitLength:s,nByteLength:i}=qB(e,n);if(i>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=s,this.BYTES=i,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return an(e,this.ORDER)}isValid(e){if(typeof e!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof e);return ir<=e&&e<this.ORDER}is0(e){return e===ir}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&An)===An}neg(e){return an(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return an(e*e,this.ORDER)}add(e,t){return an(e+t,this.ORDER)}sub(e,t){return an(e-t,this.ORDER)}mul(e,t){return an(e*t,this.ORDER)}pow(e,t){return DB(this,e,t)}div(e,t){return an(e*Q6(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return Q6(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=kB(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?w9(e,this.BYTES):yg(e,this.BYTES)}fromBytes(e,t=!1){Et(e);const{_lengths:n,BYTES:s,isLE:i,ORDER:o,_mod:a}=this;if(n){if(!n.includes(e.length)||e.length>s)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+e.length);const l=new Uint8Array(s);l.set(e,i?0:l.length-e.length),e=l}if(e.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+e.length);let c=i?Pl(e):Uh(e);if(a&&(c=an(c,o)),!t&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(e){return T9(this,e)}cmov(e,t,n){return n?t:e}};function Fh(r,e={}){return new BB(r,e)}function k9(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function C9(r){const e=k9(r);return e+Math.ceil(e/2)}function LB(r,e,t=!1){Et(r);const n=r.length,s=k9(e),i=C9(e);if(n<16||n<i||n>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+n);const o=t?Pl(r):Uh(r),a=an(o,e-An)+An;return t?w9(a,s):yg(a,s)}const Xa=BigInt(0),eo=BigInt(1);function qd(r,e){const t=e.negate();return r?t:e}function el(r,e){const t=T9(r.Fp,e.map(n=>n.Z));return e.map((n,s)=>r.fromAffine(n.toAffine(t[s])))}function R9(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function m0(r,e){R9(r,e);const t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,i=bg(r),o=BigInt(r);return{windows:t,windowSize:n,mask:i,maxNumber:s,shiftBy:o}}function J6(r,e,t){const{windowSize:n,mask:s,maxNumber:i,shiftBy:o}=t;let a=Number(r&s),c=r>>o;a>n&&(a-=i,c+=eo);const l=e*n,h=l+Math.abs(a)-1,f=a===0,p=a<0,m=e%2!==0;return{nextN:c,offset:h,isZero:f,isNeg:p,isNegF:m,offsetF:l}}const y0=new WeakMap,P9=new WeakMap;function b0(r){return P9.get(r)||1}function e4(r){if(r!==Xa)throw new Error("invalid wNAF")}let D9=class{BASE;ZERO;Fn;bits;constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let s=e;for(;t>Xa;)t&eo&&(n=n.add(s)),s=s.double(),t>>=eo;return n}precomputeWindow(e,t){const{windows:n,windowSize:s}=m0(t,this.bits),i=[];let o=e,a=o;for(let c=0;c<n;c++){a=o,i.push(a);for(let l=1;l<s;l++)a=a.add(o),i.push(a);o=a.double()}return i}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,i=this.BASE;const o=m0(e,this.bits);for(let a=0;a<o.windows;a++){const{nextN:c,offset:l,isZero:h,isNeg:f,isNegF:p,offsetF:m}=J6(n,a,o);n=c,h?i=i.add(qd(p,t[m])):s=s.add(qd(f,t[l]))}return e4(n),{p:s,f:i}}wNAFUnsafe(e,t,n,s=this.ZERO){const i=m0(e,this.bits);for(let o=0;o<i.windows&&n!==Xa;o++){const{nextN:a,offset:c,isZero:l,isNeg:h}=J6(n,o,i);if(n=a,!l){const f=t[c];s=s.add(h?f.negate():f)}}return e4(n),s}getPrecomputes(e,t,n){let s=y0.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(s=n(s)),y0.set(t,s))),s}cached(e,t,n){const s=b0(e);return this.wNAF(s,this.getPrecomputes(s,e,n),t)}unsafe(e,t,n,s){const i=b0(e);return i===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(i,this.getPrecomputes(i,e,n),t,s)}createCache(e,t){R9(t,this.bits),P9.set(e,t),y0.delete(e)}hasCache(e){return b0(e)!==1}};function OB(r,e,t,n){let s=e,i=r.ZERO,o=r.ZERO;for(;t>Xa||n>Xa;)t&eo&&(i=i.add(s)),n&eo&&(o=o.add(s)),s=s.double(),t>>=eo,n>>=eo;return{p1:i,p2:o}}function t4(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return PB(e),e}else return Fh(r,{isLE:t})}function q9(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(const c of["p","n","h"]){const l=e[c];if(!(typeof l=="bigint"&&l>Xa))throw new Error(`CURVE.${c} must be positive bigint`)}const s=t4(e.p,t.Fp,n),i=t4(e.n,t.Fn,n),a=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(const c of a)if(!s.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:i}}function B9(r,e){return function(n){const s=r(n);return{secretKey:s,publicKey:e(s)}}}const ii=BigInt(0),gn=BigInt(1),w0=BigInt(2),$B=BigInt(8);function MB(r,e,t,n){const s=r.sqr(t),i=r.sqr(n),o=r.add(r.mul(e.a,s),i),a=r.add(r.ONE,r.mul(e.d,r.mul(s,i)));return r.eql(o,a)}function NB(r,e={}){const t=q9("edwards",r,e,e.FpFnLE),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o}=i;bu(e,{},{uvRatio:"function"});const a=w0<<BigInt(s.BYTES*8)-gn,c=T=>n.create(T),l=e.uvRatio||((T,A)=>{try{return{isValid:!0,value:n.sqrt(n.div(T,A))}}catch{return{isValid:!1,value:ii}}});if(!MB(n,i,i.Gx,i.Gy))throw new Error("bad curve params: generator point");function h(T,A,D=!1){const I=D?gn:ii;return p3("coordinate "+T,A,I,a),A}function f(T){if(!(T instanceof _))throw new Error("EdwardsPoint expected")}const p=Dd((T,A)=>{const{X:D,Y:I,Z:q}=T,L=T.is0();A==null&&(A=L?$B:n.inv(q));const z=c(D*A),Y=c(I*A),k=n.mul(q,A);if(L)return{x:ii,y:gn};if(k!==gn)throw new Error("invZ was invalid");return{x:z,y:Y}}),m=Dd(T=>{const{a:A,d:D}=i;if(T.is0())throw new Error("bad point: ZERO");const{X:I,Y:q,Z:L,T:z}=T,Y=c(I*I),k=c(q*q),x=c(L*L),F=c(x*x),j=c(Y*A),U=c(x*c(j+k)),y=c(F+c(D*c(Y*k)));if(U!==y)throw new Error("bad point: equation left != right (1)");const b=c(I*q),g=c(L*z);if(b!==g)throw new Error("bad point: equation left != right (2)");return!0});class _{static BASE=new _(i.Gx,i.Gy,gn,c(i.Gx*i.Gy));static ZERO=new _(ii,gn,gn,ii);static Fp=n;static Fn=s;X;Y;Z;T;constructor(A,D,I,q){this.X=h("x",A),this.Y=h("y",D),this.Z=h("z",I,!0),this.T=h("t",q),Object.freeze(this)}static CURVE(){return i}static fromAffine(A){if(A instanceof _)throw new Error("extended point not allowed");const{x:D,y:I}=A||{};return h("x",D),h("y",I),new _(D,I,gn,c(D*I))}static fromBytes(A,D=!1){const I=n.BYTES,{a:q,d:L}=i;A=h3(Et(A,I,"point")),To(D,"zip215");const z=h3(A),Y=A[I-1];z[I-1]=Y&-129;const k=Pl(z),x=D?a:n.ORDER;p3("point.y",k,ii,x);const F=c(k*k),j=c(F-gn),U=c(L*F-q);let{isValid:y,value:b}=l(j,U);if(!y)throw new Error("bad point: invalid y coordinate");const g=(b&gn)===gn,C=(Y&128)!==0;if(!D&&b===ii&&C)throw new Error("bad point: x=0 and x_0=1");return C!==g&&(b=c(-b)),_.fromAffine({x:b,y:k})}static fromHex(A,D=!1){return _.fromBytes(Rl(A),D)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(A=8,D=!0){return R.createCache(this,A),D||this.multiply(w0),this}assertValidity(){m(this)}equals(A){f(A);const{X:D,Y:I,Z:q}=this,{X:L,Y:z,Z:Y}=A,k=c(D*Y),x=c(L*q),F=c(I*Y),j=c(z*q);return k===x&&F===j}is0(){return this.equals(_.ZERO)}negate(){return new _(c(-this.X),this.Y,this.Z,c(-this.T))}double(){const{a:A}=i,{X:D,Y:I,Z:q}=this,L=c(D*D),z=c(I*I),Y=c(w0*c(q*q)),k=c(A*L),x=D+I,F=c(c(x*x)-L-z),j=k+z,U=j-Y,y=k-z,b=c(F*U),g=c(j*y),C=c(F*y),B=c(U*j);return new _(b,g,B,C)}add(A){f(A);const{a:D,d:I}=i,{X:q,Y:L,Z:z,T:Y}=this,{X:k,Y:x,Z:F,T:j}=A,U=c(q*k),y=c(L*x),b=c(Y*I*j),g=c(z*F),C=c((q+L)*(k+x)-U-y),B=g-b,M=g+b,O=c(y-D*U),$=c(C*B),V=c(M*O),G=c(C*O),de=c(B*M);return new _($,V,de,G)}subtract(A){return this.add(A.negate())}multiply(A){if(!s.isValidNot0(A))throw new Error("invalid scalar: expected 1 <= sc < curve.n");const{p:D,f:I}=R.cached(this,A,q=>el(_,q));return el(_,[D,I])[0]}multiplyUnsafe(A,D=_.ZERO){if(!s.isValid(A))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return A===ii?_.ZERO:this.is0()||A===gn?this:R.unsafe(this,A,I=>el(_,I),D)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}isTorsionFree(){return R.unsafe(this,i.n).is0()}toAffine(A){return p(this,A)}clearCofactor(){return o===gn?this:this.multiplyUnsafe(o)}toBytes(){const{x:A,y:D}=this.toAffine(),I=n.toBytes(D);return I[I.length-1]|=A&gn?128:0,I}toHex(){return yu(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const R=new D9(_,s.BITS);return _.BASE.precompute(8),_}function UB(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');bu(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:n}=t,{BASE:s,Fp:i,Fn:o}=r,a=t.randomBytes||gg,c=t.adjustScalarBytes||(k=>k),l=t.domain||((k,x,F)=>{if(To(F,"phflag"),x.length||F)throw new Error("Contexts/pre-hash are not supported");return k});function h(k){return o.create(Pl(k))}function f(k){const x=I.secretKey;Et(k,I.secretKey,"secretKey");const F=Et(e(k),2*x,"hashedSecretKey"),j=c(F.slice(0,x)),U=F.slice(x,2*x),y=h(j);return{head:j,prefix:U,scalar:y}}function p(k){const{head:x,prefix:F,scalar:j}=f(k),U=s.multiply(j),y=U.toBytes();return{head:x,prefix:F,scalar:j,point:U,pointBytes:y}}function m(k){return p(k).pointBytes}function _(k=Uint8Array.of(),...x){const F=Jr(...x);return h(e(l(F,Et(k,void 0,"context"),!!n)))}function R(k,x,F={}){k=Et(k,void 0,"message"),n&&(k=n(k));const{prefix:j,scalar:U,pointBytes:y}=p(x),b=_(F.context,j,k),g=s.multiply(b).toBytes(),C=_(F.context,g,y,k),B=o.create(b+C*U);if(!o.isValid(B))throw new Error("sign failed: invalid s");const M=Jr(g,o.toBytes(B));return Et(M,I.signature,"result")}const T={zip215:!0};function A(k,x,F,j=T){const{context:U,zip215:y}=j,b=I.signature;k=Et(k,b,"signature"),x=Et(x,void 0,"message"),F=Et(F,I.publicKey,"publicKey"),y!==void 0&&To(y,"zip215"),n&&(x=n(x));const g=b/2,C=k.subarray(0,g),B=Pl(k.subarray(g,b));let M,O,$;try{M=r.fromBytes(F,y),O=r.fromBytes(C,y),$=s.multiplyUnsafe(B)}catch{return!1}if(!y&&M.isSmallOrder())return!1;const V=_(U,O.toBytes(),M.toBytes(),x);return O.add(M.multiplyUnsafe(V)).subtract($).clearCofactor().is0()}const D=i.BYTES,I={secretKey:D,publicKey:D,signature:2*D,seed:D};function q(k=a(I.seed)){return Et(k,I.seed,"seed")}function L(k){return Nh(k)&&k.length===o.BYTES}function z(k,x){try{return!!r.fromBytes(k,x)}catch{return!1}}const Y={getExtendedPublicKey:p,randomSecretKey:q,isValidSecretKey:L,isValidPublicKey:z,toMontgomery(k){const{y:x}=r.fromBytes(k),F=I.publicKey,j=F===32;if(!j&&F!==57)throw new Error("only defined for 25519 and 448");const U=j?i.div(gn+x,gn-x):i.div(x-gn,x+gn);return i.toBytes(U)},toMontgomerySecret(k){const x=I.secretKey;Et(k,x);const F=e(k.subarray(0,x));return c(F).subarray(0,x)}};return Object.freeze({keygen:B9(q,m),getPublicKey:m,sign:R,verify:A,utils:Y,Point:r,lengths:I})}const FB=BigInt(1),n4=BigInt(2),HB=BigInt(5),VB=BigInt(8),_g=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),KB={p:_g,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:VB,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function zB(r){const e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),i=_g,a=r*r%i*r%i,c=Zt(a,n4,i)*a%i,l=Zt(c,FB,i)*r%i,h=Zt(l,HB,i)*l%i,f=Zt(h,e,i)*h%i,p=Zt(f,t,i)*f%i,m=Zt(p,n,i)*p%i,_=Zt(m,s,i)*m%i,R=Zt(_,s,i)*m%i,T=Zt(R,e,i)*h%i;return{pow_p_5_8:Zt(T,n4,i)*r%i,b2:a}}function WB(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}const r4=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function GB(r,e){const t=_g,n=an(e*e*e,t),s=an(n*n*e,t),i=zB(r*s).pow_p_5_8;let o=an(r*n*i,t);const a=an(e*o*o,t),c=o,l=an(o*r4,t),h=a===r,f=a===an(-r,t),p=a===an(-r*r4,t);return h&&(o=c),(f||p)&&(o=l),CB(o,t)&&(o=an(-o,t)),{isValid:h||f,value:o}}const ZB=NB(KB,{uvRatio:GB});function jB(r){return UB(ZB,_B,Object.assign({adjustScalarBytes:WB},r))}const YB=jB({});let s4=class extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}},QB=class extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}};var Dl={get(r=globalThis){const e=r.crypto;if(e?.subtle==null)throw new QB("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};const L9=32;let _0;const XB=(async()=>{try{return await Dl.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();async function JB(r,e,t){if(r.buffer instanceof ArrayBuffer){const n=await Dl.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await Dl.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function eL(r,e,t){return YB.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function tL(r,e,t){return _0==null&&(_0=await XB),_0?JB(r,e,t):eL(r,e,t)}function O9(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}let nL=class{type="Ed25519";raw;constructor(e){this.raw=$9(e,L9)}toMultihash(){return Kt.digest(ka(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();const s=tL(this.raw,t,e);return O9(s)?s.then(i=>(n?.signal?.throwIfAborted(),i)):s}};function rL(r){return r=$9(r,L9),new nL(r)}function $9(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new $h(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}var or;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(or||(or={}));var g3;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(g3||(g3={}));(function(r){r.codec=()=>Rn(g3)})(or||(or={}));var ql;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),or.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=or.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(ql||(ql={}));var i4;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),or.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=or.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(i4||(i4={}));let sL=class{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=lL(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return nt.createV1(114,this._multihash)}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){return dL(this.jwk,t,e,n)}};const iL=18,oL=1062,aL=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function cL(r){const e=Mh(r[1],{offset:0});return{kty:"RSA",n:Le(e[0],"base64url"),e:Le(e[1],"base64url")}}function lL(r){if(r.n==null||r.e==null)throw new $h("JWK was missing components");return Jc([aL,l9(Jc([f3(Ge(r.n,"base64url")),f3(Ge(r.e,"base64url"))]))]).subarray()}function uL(r,e){if(r.byteLength>=oL)throw new c9("Key size is too large");const t=Mh(r,{offset:0});return fL(t,r,e)}function fL(r,e,t){const n=cL(r);if(t==null){const s=m9(ql.encode({Type:or.RSA,Data:e}));t=Ms(iL,s)}return new sL(n,t)}async function dL(r,e,t,n){const s=await Dl.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();const i=await Dl.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),i}let M9=class{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(e,t){if(u9(e),Et(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const n=this.blockLen,s=new Uint8Array(n);s.set(t.length>n?e.create().update(t).digest():t);for(let i=0;i<s.length;i++)s[i]^=54;this.iHash.update(s),this.oHash=e.create();for(let i=0;i<s.length;i++)s[i]^=106;this.oHash.update(s),Qa(s)}update(e){return Pd(this),this.iHash.update(e),this}digestInto(e){Pd(this),Et(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||=Object.create(Object.getPrototypeOf(this),{});const{oHash:t,iHash:n,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const N9=(r,e,t)=>new M9(r,e).update(t).digest();N9.create=(r,e)=>new M9(r,e);const o4=(r,e)=>(r+(r>=0?e:-e)/U9)/e;function hL(r,e,t){const[[n,s],[i,o]]=e,a=o4(o*r,t),c=o4(-s*r,t);let l=r-a*n-c*i,h=-a*s-c*o;const f=l<Rs,p=h<Rs;f&&(l=-l),p&&(h=-h);const m=bg(Math.ceil(vB(t)/2))+Ta;if(l<Rs||l>=m||h<Rs||h>=m)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:f,k1:l,k2neg:p,k2:h}}function m3(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function E0(r,e){const t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return To(t.lowS,"lowS"),To(t.prehash,"prehash"),t.format!==void 0&&m3(t.format),t}let pL=class extends Error{constructor(e=""){super(e)}};const Si={Err:pL,_tlv:{encode:(r,e)=>{const{Err:t}=Si;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const n=e.length/2,s=lf(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");const i=n>127?lf(s.length/2|128):"";return lf(r)+i+s+e},decode(r,e){const{Err:t}=Si;let n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");const s=e[n++],i=!!(s&128);let o=0;if(!i)o=s;else{const c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const l=e.subarray(n,n+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const h of l)o=o<<8|h;if(n+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const a=e.subarray(n,n+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+o)}}},_int:{encode(r){const{Err:e}=Si;if(r<Rs)throw new e("integer: negative integers are not allowed");let t=lf(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){const{Err:e}=Si;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Uh(r)}},toSig(r){const{Err:e,_int:t,_tlv:n}=Si,s=Et(r,void 0,"signature"),{v:i,l:o}=n.decode(48,s);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=n.decode(2,i),{v:l,l:h}=n.decode(2,c);if(h.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(r){const{_tlv:e,_int:t}=Si,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),i=n+s;return e.encode(48,i)}},Rs=BigInt(0),Ta=BigInt(1),U9=BigInt(2),uf=BigInt(3),gL=BigInt(4);function mL(r,e={}){const t=q9("weierstrass",r,e),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o,n:a}=i;bu(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});const{endo:c}=e;if(c&&(!n.is0(i.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const l=H9(n,s);function h(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function f(U,y,b){const{x:g,y:C}=y.toAffine(),B=n.toBytes(g);if(To(b,"isCompressed"),b){h();const M=!n.isOdd(C);return Jr(F9(M),B)}else return Jr(Uint8Array.of(4),B,n.toBytes(C))}function p(U){Et(U,void 0,"Point");const{publicKey:y,publicKeyUncompressed:b}=l,g=U.length,C=U[0],B=U.subarray(1);if(g===y&&(C===2||C===3)){const M=n.fromBytes(B);if(!n.isValid(M))throw new Error("bad point: is not on curve, wrong x");const O=R(M);let $;try{$=n.sqrt(O)}catch(de){const ce=de instanceof Error?": "+de.message:"";throw new Error("bad point: is not on curve, sqrt error"+ce)}h();const V=n.isOdd($);return(C&1)===1!==V&&($=n.neg($)),{x:M,y:$}}else if(g===b&&C===4){const M=n.BYTES,O=n.fromBytes(B.subarray(0,M)),$=n.fromBytes(B.subarray(M,M*2));if(!T(O,$))throw new Error("bad point: is not on curve");return{x:O,y:$}}else throw new Error(`bad point: got length ${g}, expected compressed=${y} or uncompressed=${b}`)}const m=e.toBytes||f,_=e.fromBytes||p;function R(U){const y=n.sqr(U),b=n.mul(y,U);return n.add(n.add(b,n.mul(U,i.a)),i.b)}function T(U,y){const b=n.sqr(y),g=R(U);return n.eql(b,g)}if(!T(i.Gx,i.Gy))throw new Error("bad curve params: generator point");const A=n.mul(n.pow(i.a,uf),gL),D=n.mul(n.sqr(i.b),BigInt(27));if(n.is0(n.add(A,D)))throw new Error("bad curve params: a or b");function I(U,y,b=!1){if(!n.isValid(y)||b&&n.is0(y))throw new Error(`bad point coordinate ${U}`);return y}function q(U){if(!(U instanceof x))throw new Error("Weierstrass Point expected")}function L(U){if(!c||!c.basises)throw new Error("no endo");return hL(U,c.basises,s.ORDER)}const z=Dd((U,y)=>{const{X:b,Y:g,Z:C}=U;if(n.eql(C,n.ONE))return{x:b,y:g};const B=U.is0();y==null&&(y=B?n.ONE:n.inv(C));const M=n.mul(b,y),O=n.mul(g,y),$=n.mul(C,y);if(B)return{x:n.ZERO,y:n.ZERO};if(!n.eql($,n.ONE))throw new Error("invZ was invalid");return{x:M,y:O}}),Y=Dd(U=>{if(U.is0()){if(e.allowInfinityPoint&&!n.is0(U.Y))return;throw new Error("bad point: ZERO")}const{x:y,y:b}=U.toAffine();if(!n.isValid(y)||!n.isValid(b))throw new Error("bad point: x or y not field elements");if(!T(y,b))throw new Error("bad point: equation left != right");if(!U.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function k(U,y,b,g,C){return b=new x(n.mul(b.X,U),b.Y,b.Z),y=qd(g,y),b=qd(C,b),y.add(b)}class x{static BASE=new x(i.Gx,i.Gy,n.ONE);static ZERO=new x(n.ZERO,n.ONE,n.ZERO);static Fp=n;static Fn=s;X;Y;Z;constructor(y,b,g){this.X=I("x",y),this.Y=I("y",b,!0),this.Z=I("z",g),Object.freeze(this)}static CURVE(){return i}static fromAffine(y){const{x:b,y:g}=y||{};if(!y||!n.isValid(b)||!n.isValid(g))throw new Error("invalid affine point");if(y instanceof x)throw new Error("projective point not allowed");return n.is0(b)&&n.is0(g)?x.ZERO:new x(b,g,n.ONE)}static fromBytes(y){const b=x.fromAffine(_(Et(y,void 0,"point")));return b.assertValidity(),b}static fromHex(y){return x.fromBytes(Rl(y))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(y=8,b=!0){return j.createCache(this,y),b||this.multiply(uf),this}assertValidity(){Y(this)}hasEvenY(){const{y}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(y)}equals(y){q(y);const{X:b,Y:g,Z:C}=this,{X:B,Y:M,Z:O}=y,$=n.eql(n.mul(b,O),n.mul(B,C)),V=n.eql(n.mul(g,O),n.mul(M,C));return $&&V}negate(){return new x(this.X,n.neg(this.Y),this.Z)}double(){const{a:y,b}=i,g=n.mul(b,uf),{X:C,Y:B,Z:M}=this;let O=n.ZERO,$=n.ZERO,V=n.ZERO,G=n.mul(C,C),de=n.mul(B,B),ce=n.mul(M,M),re=n.mul(C,B);return re=n.add(re,re),V=n.mul(C,M),V=n.add(V,V),O=n.mul(y,V),$=n.mul(g,ce),$=n.add(O,$),O=n.sub(de,$),$=n.add(de,$),$=n.mul(O,$),O=n.mul(re,O),V=n.mul(g,V),ce=n.mul(y,ce),re=n.sub(G,ce),re=n.mul(y,re),re=n.add(re,V),V=n.add(G,G),G=n.add(V,G),G=n.add(G,ce),G=n.mul(G,re),$=n.add($,G),ce=n.mul(B,M),ce=n.add(ce,ce),G=n.mul(ce,re),O=n.sub(O,G),V=n.mul(ce,de),V=n.add(V,V),V=n.add(V,V),new x(O,$,V)}add(y){q(y);const{X:b,Y:g,Z:C}=this,{X:B,Y:M,Z:O}=y;let $=n.ZERO,V=n.ZERO,G=n.ZERO;const de=i.a,ce=n.mul(i.b,uf);let re=n.mul(b,B),pe=n.mul(g,M),_e=n.mul(C,O),$e=n.add(b,g),ge=n.add(B,M);$e=n.mul($e,ge),ge=n.add(re,pe),$e=n.sub($e,ge),ge=n.add(b,C);let ke=n.add(B,O);return ge=n.mul(ge,ke),ke=n.add(re,_e),ge=n.sub(ge,ke),ke=n.add(g,C),$=n.add(M,O),ke=n.mul(ke,$),$=n.add(pe,_e),ke=n.sub(ke,$),G=n.mul(de,ge),$=n.mul(ce,_e),G=n.add($,G),$=n.sub(pe,G),G=n.add(pe,G),V=n.mul($,G),pe=n.add(re,re),pe=n.add(pe,re),_e=n.mul(de,_e),ge=n.mul(ce,ge),pe=n.add(pe,_e),_e=n.sub(re,_e),_e=n.mul(de,_e),ge=n.add(ge,_e),re=n.mul(pe,ge),V=n.add(V,re),re=n.mul(ke,ge),$=n.mul($e,$),$=n.sub($,re),re=n.mul($e,pe),G=n.mul(ke,G),G=n.add(G,re),new x($,V,G)}subtract(y){return this.add(y.negate())}is0(){return this.equals(x.ZERO)}multiply(y){const{endo:b}=e;if(!s.isValidNot0(y))throw new Error("invalid scalar: out of range");let g,C;const B=M=>j.cached(this,M,O=>el(x,O));if(b){const{k1neg:M,k1:O,k2neg:$,k2:V}=L(y),{p:G,f:de}=B(O),{p:ce,f:re}=B(V);C=de.add(re),g=k(b.beta,G,ce,M,$)}else{const{p:M,f:O}=B(y);g=M,C=O}return el(x,[g,C])[0]}multiplyUnsafe(y){const{endo:b}=e,g=this;if(!s.isValid(y))throw new Error("invalid scalar: out of range");if(y===Rs||g.is0())return x.ZERO;if(y===Ta)return g;if(j.hasCache(this))return this.multiply(y);if(b){const{k1neg:C,k1:B,k2neg:M,k2:O}=L(y),{p1:$,p2:V}=OB(x,g,B,O);return k(b.beta,$,V,C,M)}else return j.unsafe(g,y)}toAffine(y){return z(this,y)}isTorsionFree(){const{isTorsionFree:y}=e;return o===Ta?!0:y?y(x,this):j.unsafe(this,a).is0()}clearCofactor(){const{clearCofactor:y}=e;return o===Ta?this:y?y(x,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(y=!0){return To(y,"isCompressed"),this.assertValidity(),m(x,this,y)}toHex(y=!0){return yu(this.toBytes(y))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const F=s.BITS,j=new D9(x,e.endo?Math.ceil(F/2):F);return x.BASE.precompute(8),x}function F9(r){return Uint8Array.of(r?2:3)}function H9(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function yL(r,e={}){const{Fn:t}=r,n=e.randomBytes||gg,s=Object.assign(H9(r.Fp,t),{seed:C9(t.ORDER)});function i(m){try{const _=t.fromBytes(m);return t.isValidNot0(_)}catch{return!1}}function o(m,_){const{publicKey:R,publicKeyUncompressed:T}=s;try{const A=m.length;return _===!0&&A!==R||_===!1&&A!==T?!1:!!r.fromBytes(m)}catch{return!1}}function a(m=n(s.seed)){return LB(Et(m,s.seed,"seed"),t.ORDER)}function c(m,_=!0){return r.BASE.multiply(t.fromBytes(m)).toBytes(_)}function l(m){const{secretKey:_,publicKey:R,publicKeyUncompressed:T}=s;if(!Nh(m)||"_lengths"in t&&t._lengths||_===R)return;const A=Et(m,void 0,"key").length;return A===R||A===T}function h(m,_,R=!0){if(l(m)===!0)throw new Error("first arg must be private key");if(l(_)===!1)throw new Error("second arg must be public key");const T=t.fromBytes(m);return r.fromBytes(_).multiply(T).toBytes(R)}const f={isValidSecretKey:i,isValidPublicKey:o,randomSecretKey:a},p=B9(a,c);return Object.freeze({getPublicKey:c,getSharedSecret:h,keygen:p,Point:r,utils:f,lengths:s})}function bL(r,e,t={}){u9(e),bu(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),t=Object.assign({},t);const n=t.randomBytes||gg,s=t.hmac||((b,g)=>N9(e,b,g)),{Fp:i,Fn:o}=r,{ORDER:a,BITS:c}=o,{keygen:l,getPublicKey:h,getSharedSecret:f,utils:p,lengths:m}=yL(r,t),_={prehash:!0,lowS:typeof t.lowS=="boolean"?t.lowS:!0,format:"compact",extraEntropy:!1},R=a*U9<i.ORDER;function T(b){const g=a>>Ta;return b>g}function A(b,g){if(!o.isValidNot0(g))throw new Error(`invalid signature ${b}: out of range 1..Point.Fn.ORDER`);return g}function D(){if(R)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function I(b,g){m3(g);const C=m.signature,B=g==="compact"?C:g==="recovered"?C+1:void 0;return Et(b,B)}class q{r;s;recovery;constructor(g,C,B){if(this.r=A("r",g),this.s=A("s",C),B!=null){if(D(),![0,1,2,3].includes(B))throw new Error("invalid recovery id");this.recovery=B}Object.freeze(this)}static fromBytes(g,C=_.format){I(g,C);let B;if(C==="der"){const{r:V,s:G}=Si.toSig(Et(g));return new q(V,G)}C==="recovered"&&(B=g[0],C="compact",g=g.subarray(1));const M=m.signature/2,O=g.subarray(0,M),$=g.subarray(M,M*2);return new q(o.fromBytes(O),o.fromBytes($),B)}static fromHex(g,C){return this.fromBytes(Rl(g),C)}assertRecovery(){const{recovery:g}=this;if(g==null)throw new Error("invalid recovery id: must be present");return g}addRecoveryBit(g){return new q(this.r,this.s,g)}recoverPublicKey(g){const{r:C,s:B}=this,M=this.assertRecovery(),O=M===2||M===3?C+a:C;if(!i.isValid(O))throw new Error("invalid recovery id: sig.r+curve.n != R.x");const $=i.toBytes(O),V=r.fromBytes(Jr(F9((M&1)===0),$)),G=o.inv(O),de=z(Et(g,void 0,"msgHash")),ce=o.create(-de*G),re=o.create(B*G),pe=r.BASE.multiplyUnsafe(ce).add(V.multiplyUnsafe(re));if(pe.is0())throw new Error("invalid recovery: point at infinify");return pe.assertValidity(),pe}hasHighS(){return T(this.s)}toBytes(g=_.format){if(m3(g),g==="der")return Rl(Si.hexFromSig(this));const{r:C,s:B}=this,M=o.toBytes(C),O=o.toBytes(B);return g==="recovered"?(D(),Jr(Uint8Array.of(this.assertRecovery()),M,O)):Jr(M,O)}toHex(g){return yu(this.toBytes(g))}}const L=t.bits2int||function(g){if(g.length>8192)throw new Error("input is too large");const C=Uh(g),B=g.length*8-c;return B>0?C>>BigInt(B):C},z=t.bits2int_modN||function(g){return o.create(L(g))},Y=bg(c);function k(b){return p3("num < 2^"+c,b,Rs,Y),o.toBytes(b)}function x(b,g){return Et(b,void 0,"message"),g?Et(e(b),void 0,"prehashed message"):b}function F(b,g,C){const{lowS:B,prehash:M,extraEntropy:O}=E0(C,_);b=x(b,M);const $=z(b),V=o.fromBytes(g);if(!o.isValidNot0(V))throw new Error("invalid private key");const G=[k(V),k($)];if(O!=null&&O!==!1){const pe=O===!0?n(m.secretKey):O;G.push(Et(pe,void 0,"extraEntropy"))}const de=Jr(...G),ce=$;function re(pe){const _e=L(pe);if(!o.isValidNot0(_e))return;const $e=o.inv(_e),ge=r.BASE.multiply(_e).toAffine(),ke=o.create(ge.x);if(ke===Rs)return;const ht=o.create($e*o.create(ce+ke*V));if(ht===Rs)return;let qt=(ge.x===ke?0:2)|Number(ge.y&Ta),$t=ht;return B&&T(ht)&&($t=o.neg(ht),qt^=1),new q(ke,$t,R?void 0:qt)}return{seed:de,k2sig:re}}function j(b,g,C={}){const{seed:B,k2sig:M}=F(b,g,C);return xB(e.outputLen,o.BYTES,s)(B,M).toBytes(C.format)}function U(b,g,C,B={}){const{lowS:M,prehash:O,format:$}=E0(B,_);if(C=Et(C,void 0,"publicKey"),g=x(g,O),!Nh(b)){const V=b instanceof q?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+V)}I(b,$);try{const V=q.fromBytes(b,$),G=r.fromBytes(C);if(M&&V.hasHighS())return!1;const{r:de,s:ce}=V,re=z(g),pe=o.inv(ce),_e=o.create(re*pe),$e=o.create(de*pe),ge=r.BASE.multiplyUnsafe(_e).add(G.multiplyUnsafe($e));return ge.is0()?!1:o.create(ge.x)===de}catch{return!1}}function y(b,g,C={}){const{prehash:B}=E0(C,_);return g=x(g,B),q.fromBytes(b,"recovered").recoverPublicKey(g).toBytes()}return Object.freeze({keygen:l,getPublicKey:h,getSharedSecret:f,utils:p,lengths:m,Point:r,sign:j,verify:U,recoverPublicKey:y,Signature:q,hash:e})}const Eg={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},wL={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},a4=BigInt(2);function _L(r){const e=Eg.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,h=l*l*r%e,f=Zt(h,t,e)*h%e,p=Zt(f,t,e)*h%e,m=Zt(p,a4,e)*l%e,_=Zt(m,s,e)*m%e,R=Zt(_,i,e)*_%e,T=Zt(R,a,e)*R%e,A=Zt(T,c,e)*T%e,D=Zt(A,a,e)*R%e,I=Zt(D,t,e)*h%e,q=Zt(I,o,e)*_%e,L=Zt(q,n,e)*l%e,z=Zt(L,a4,e);if(!y3.eql(y3.sqr(z),r))throw new Error("Cannot find square root");return z}const y3=Fh(Eg.p,{sqrt:_L}),EL=mL(Eg,{Fp:y3,endo:wL}),Bd=bL(EL,m9);function vL(r,e,t,n){const s=$r.digest(t instanceof Uint8Array?t:t.subarray());if(O9(s))return s.then(({digest:i})=>(n?.signal?.throwIfAborted(),Bd.verify(e,i,r,{prehash:!1,format:"der"}))).catch(i=>{throw i.name==="AbortError"?i:new s4(String(i))});try{return n?.signal?.throwIfAborted(),Bd.verify(e,s.digest,r,{prehash:!1,format:"der"})}catch(i){throw new s4(String(i))}}let xL=class{type="secp256k1";raw;_key;constructor(e){this._key=IL(e),this.raw=AL(this._key)}toMultihash(){return Kt.digest(ka(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){return vL(this._key,t,e,n)}};function SL(r){return new xL(r)}function AL(r){return Bd.Point.fromBytes(r).toBytes()}function IL(r){try{return Bd.Point.fromBytes(r),r}catch(e){throw new c9(String(e))}}function TL(r,e){const{Type:t,Data:n}=ql.decode(r),s=n??new Uint8Array;switch(t){case or.RSA:return uL(s,e);case or.Ed25519:return rL(s);case or.secp256k1:return SL(s);case or.ECDSA:return Qq(s);default:throw new Lq}}function ka(r){return ql.encode({Type:or[r.type],Data:r.raw})}function kL(r,e){if(r.publicKey!=null||e.publicKey==null)return r;let t;r.type==="RSA"&&(t=r.toMultihash());const n=TL(e.publicKey,t);return Ua(n)}function CL(r,e,t){const n=Xi.decode(e);return Vc(r,n,t)}function Vc(r,e,t){const n=new Map,s=BigInt(Date.now());for(const[i,o]of e.tags.entries())o.expiry!=null&&o.expiry<s||n.set(i,o);return{...e,id:kL(r,e),addresses:e.addresses.filter(({observed:i})=>i!=null&&i>Date.now()-t).map(({multiaddr:i,isCertified:o})=>({multiaddr:lt(i),isCertified:o??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:n}}function RL(r,e){return PL(r.addresses,e.addresses)&&DL(r.protocols,e.protocols)&&qL(r.publicKey,e.publicKey)&&BL(r.peerRecordEnvelope,e.peerRecordEnvelope)&&LL(r.metadata,e.metadata)&&OL(r.tags,e.tags)}function PL(r,e){return K9(r,e,(t,n)=>!(t.isCertified!==n.isCertified||!at(t.multiaddr,n.multiaddr)))}function DL(r,e){return K9(r,e,(t,n)=>t===n)}function qL(r,e){return V9(r,e)}function BL(r,e){return V9(r,e)}function LL(r,e){return z9(r,e,(t,n)=>at(t,n))}function OL(r,e){return z9(r,e,(t,n)=>t.value===n.value&&t.expiry===n.expiry)}function V9(r,e){return r==null&&e==null?!0:r!=null&&e!=null?at(r,e):!1}function K9(r,e,t){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!t(r[n],e[n]))return!1;return!0}function z9(r,e,t){if(r.size!==e.size)return!1;for(const[n,s]of r.entries()){const i=e.get(n);if(i==null||!t(s,i))return!1}return!0}const xs="/",W9=new TextEncoder().encode(xs),ff=W9[0];class En{_buf;constructor(e,t){if(typeof e=="string")this._buf=Ge(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==ff)throw new Error("Invalid key")}toString(e="utf8"){return Le(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new En(e.join(xs))}static random(){return new En(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new En(e):typeof e.uint8Array=="function"?new En(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=W9),this._buf[0]!==ff){const e=new Uint8Array(this._buf.byteLength+1);e.fill(ff,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===ff;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let s=0;s<t.length;s++){if(n.length<s+1)return!1;const i=t[s],o=n[s];if(i<o)return!0;if(i>o)return!1}return t.length<n.length}reverse(){return En.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(xs).slice(1)}type(){return $L(this.baseNamespace())}name(){return ML(this.baseNamespace())}instance(e){return new En(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(xs)||(e+=xs),e+=this.type(),new En(e)}parent(){const e=this.list();return e.length===1?new En(xs):new En(e.slice(0,-1).join(xs))}child(e){return this.toString()===xs?e:e.toString()===xs?this:new En(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return En.withNamespaces([...this.namespaces(),...NL(e.map(t=>t.namespaces()))])}}function $L(r){const e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function ML(r){const e=r.split(":");return e[e.length-1]}function NL(r){return[].concat(...r)}const G9="/peers/";function df(r){if(!Zc(r)||r.type==null)throw new ot("Invalid PeerId");const e=r.toCID().toString();return new En(`${G9}${e}`)}async function UL(r,e,t,n,s){const i=new Map;for(const o of t){if(o==null)continue;if(o.multiaddr instanceof Uint8Array&&(o.multiaddr=lt(o.multiaddr)),!Rh(o.multiaddr))throw new ot("Multiaddr was invalid");if(!await e(r,o.multiaddr,s))continue;const a=o.isCertified??!1,c=o.multiaddr.toString(),l=i.get(c);l!=null?o.isCertified=l.isCertified||a:i.set(c,{multiaddr:o.multiaddr,isCertified:a})}return[...i.values()].sort((o,a)=>o.multiaddr.toString().localeCompare(a.multiaddr.toString())).map(({isCertified:o,multiaddr:a})=>{const c=a.getPeerId();return r.equals(c)&&(a=a.decapsulate(lt(`/p2p/${r}`))),{isCertified:o,multiaddr:a.bytes}})}async function v0(r,e,t,n){if(e==null)throw new ot("Invalid PeerData");if(e.publicKey!=null&&r.publicKey!=null&&!e.publicKey.equals(r.publicKey))throw new ot("publicKey bytes do not match peer id publicKey bytes");const s=n.existingPeer?.peer;if(s!=null&&!r.equals(s.id))throw new ot("peer id did not match existing peer id");let i=s?.addresses??[],o=new Set(s?.protocols??[]),a=s?.metadata??new Map,c=s?.tags??new Map,l=s?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(i=[],e.multiaddrs!=null&&i.push(...e.multiaddrs.map(p=>({isCertified:!1,multiaddr:p}))),e.addresses!=null&&i.push(...e.addresses)),e.protocols!=null&&(o=new Set(e.protocols)),e.metadata!=null){const p=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=hf(p,{validate:c4})}if(e.tags!=null){const p=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=hf(p,{validate:l4,map:u4})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&i.push(...e.multiaddrs.map(p=>({isCertified:!1,multiaddr:p}))),e.addresses!=null&&i.push(...e.addresses),e.protocols!=null&&(o=new Set([...o,...e.protocols])),e.metadata!=null){const p=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(const[m,_]of p)_==null?a.delete(m):a.set(m,_);a=hf([...a.entries()],{validate:c4})}if(e.tags!=null){const p=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),m=new Map(c);for(const[_,R]of p)R==null?m.delete(_):m.set(_,R);c=hf([...m.entries()],{validate:l4,map:u4})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}let h;s?.id.publicKey!=null?h=ka(s.id.publicKey):e.publicKey!=null?h=ka(e.publicKey):r.publicKey!=null&&(h=ka(r.publicKey));const f={addresses:await UL(r,n.addressFilter??(async()=>!0),i,n.existingPeer?.peerPB.addresses,n),protocols:[...o.values()].sort((p,m)=>p.localeCompare(m)),metadata:a,tags:c,publicKey:h,peerRecordEnvelope:l};return f.addresses.forEach(p=>{p.observed=n.existingPeer?.peerPB.addresses?.find(m=>at(m.multiaddr,m.multiaddr))?.observed??Date.now()}),r.type!=="RSA"&&delete f.publicKey,f}function hf(r,e){const t=new Map;for(const[n,s]of r)s!=null&&e.validate(n,s);for(const[n,s]of r.sort(([i],[o])=>i.localeCompare(o)))s!=null&&t.set(n,e.map?.(n,s)??s);return t}function c4(r,e){if(typeof r!="string")throw new ot("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new ot("Metadata value must be a Uint8Array")}function l4(r,e){if(typeof r!="string")throw new ot("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new ot("Tag value must be an integer");if(e.value<0||e.value>100)throw new ot("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new ot("Tag ttl must be an integer");if(e.ttl<0)throw new ot("Tag ttl must be between greater than 0")}}function u4(r,e){let t;e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl)));const n={value:e.value??0};return t!=null&&(n.expiry=t),n}function Z9(r){const e=r.toString().split("/")[2],t=nt.parse(e,Ci);return cu(t)}function x0(r,e,t){const n=Z9(r);return CL(n,e,t)}function FL(r,e){return{prefix:G9,filters:(r.filters??[]).map(t=>({key:n,value:s})=>t(x0(n,s,e))),orders:(r.orders??[]).map(t=>(n,s)=>t(x0(n.key,n.value,e),x0(s.key,s.value,e)))}}class HL{peerId;datastore;locks;addressFilter;log;maxAddressAge;maxPeerAge;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=ig({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??qq,this.maxPeerAge=t.maxPeerAge??Bq}getLock(e){let t=this.locks.get(e);return t==null&&(t={refs:0,lock:Dq({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,t.refs===0&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){const n=this.getLock(e);try{const s=await n.lock.readLock(t);return()=>{s(),this.maybeRemoveLock(e,n)}}catch(s){throw this.maybeRemoveLock(e,n),s}}async getWriteLock(e,t){const n=this.getLock(e);try{const s=await n.lock.writeLock(t);return()=>{s(),this.maybeRemoveLock(e,n)}}catch(s){throw this.maybeRemoveLock(e,n),s}}async has(e,t){try{return await this.load(e,t),!0}catch(n){if(n.name!=="NotFoundError")throw n}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(df(e),t)}async load(e,t){const n=df(e),s=await this.datastore.get(n,t),i=Xi.decode(s);if(this.#n(e,i))throw await this.datastore.delete(n,t),new qi;return Vc(e,i,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,n){const s=await this.#e(e,n),i=await v0(e,t,"patch",{...n,addressFilter:this.addressFilter});return this.#t(e,i,s)}async patch(e,t,n){const s=await this.#e(e,n),i=await v0(e,t,"patch",{...n,addressFilter:this.addressFilter,existingPeer:s});return this.#t(e,i,s)}async merge(e,t,n){const s=await this.#e(e,n),i=await v0(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:s});return this.#t(e,i,s)}async*all(e){for await(const{key:t,value:n}of this.datastore.query(FL(e??{},this.maxAddressAge),e)){const s=Z9(t);if(s.equals(this.peerId))continue;const i=Xi.decode(n);if(this.#n(s,i)){await this.datastore.delete(t,e);continue}yield Vc(s,i,this.peerId.equals(s)?1/0:this.maxAddressAge)}}async#e(e,t){try{const n=df(e),s=await this.datastore.get(n,t),i=Xi.decode(s);if(this.#n(e,i))throw await this.datastore.delete(n,t),new qi;return{peerPB:i,peer:Vc(e,i,this.maxAddressAge)}}catch(n){n.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",n)}}async#t(e,t,n,s){t.updated=Date.now();const i=Xi.encode(t);return await this.datastore.put(df(e),i,s),{peer:Vc(e,t,this.maxAddressAge),previous:n?.peer,updated:n==null||!RL(t,n.peerPB)}}#n(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;const n=t.updated<Date.now()-this.maxPeerAge,s=Date.now()-this.maxAddressAge,i=t.addresses.filter(o=>o.observed!=null&&o.observed>s);return n&&i.length===0}}class VL{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new HL(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){for await(const n of this.store.all(t))e(n)}async all(e){return kd(this.store.all(e))}async delete(e,t){const n=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{n()}}async has(e,t){const n=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),n?.()}}async get(e,t){const n=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{n?.()}}async getInfo(e,t){const n=await this.get(e,t);return{id:n.id,multiaddrs:n.addresses.map(({multiaddr:s})=>s)}}async save(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.save(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async patch(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.patch(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async merge(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.merge(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async consumePeerRecord(e,t,n){const s=Zc(t)?t:Zc(t?.expectedPeer)?t.expectedPeer:void 0,i=Zc(t)||t===void 0?n:t,o=await ss.openAndCertify(e,vr.DOMAIN,i),a=cu(o.publicKey.toCID());if(s?.equals(a)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",s,a),!1;const c=vr.createFromProtobuf(o.payload);let l;try{l=await this.get(a,i)}catch(h){if(h.name!=="NotFoundError")throw h}if(l?.peerRecordEnvelope!=null){const h=ss.createFromProtobuf(l.peerRecordEnvelope),f=vr.createFromProtobuf(h.payload);if(f.seqNumber>=c.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",f.seqNumber,c.seqNumber),!1}return await this.patch(c.peerId,{peerRecordEnvelope:e,addresses:c.multiaddrs.map(h=>({isCertified:!0,multiaddr:h}))},i),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}}function KL(r,e={}){return new VL(r,e)}class Ld extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=Ld.name;code=Ld.code;constructor(e="Not Found"){super(e)}}function zL(r){return r[Symbol.asyncIterator]!=null}function Ja(r){if(zL(r))return(async()=>{for await(const e of r);})();for(const e of r);}function vg(r){const[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:s=>{n.push(s)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}function WL(r){return r[Symbol.asyncIterator]!=null}function na(r,e){let t=0;if(WL(r))return(async function*(){for await(const c of r)await e(c,t++)&&(yield c)})();const n=vg(r),{value:s,done:i}=n.next();if(i===!0)return(function*(){})();const o=e(s,t++);if(typeof o.then=="function")return(async function*(){await o&&(yield s);for(const c of n)await e(c,t++)&&(yield c)})();const a=e;return(function*(){o===!0&&(yield s);for(const c of n)a(c,t++)&&(yield c)})()}function GL(r){return r[Symbol.asyncIterator]!=null}function f4(r,e){return GL(r)?(async function*(){yield*(await kd(r)).sort(e)})():(function*(){yield*kd(r).sort(e)})()}function ZL(r){return r[Symbol.asyncIterator]!=null}function b3(r,e){return ZL(r)?(async function*(){let t=0;if(!(e<1)){for await(const n of r)if(yield n,t++,t===e)return}})():(function*(){let t=0;if(!(e<1)){for(const n of r)if(yield n,t++,t===e)return}})()}class jL{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:s}of e)await this.put(n,s,t),yield n}async*getMany(e,t={}){for await(const n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{await Ja(this.putMany(e,n)),e=[],await Ja(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){const s=e.prefix;n=na(n,i=>i.key.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>na(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>f4(s,i),n)),e.offset!=null){let s=0;const i=e.offset;n=na(n,()=>s++>=i)}return e.limit!=null&&(n=b3(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){const s=e.prefix;n=na(n,i=>i.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>na(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>f4(s,i),n)),e.offset!=null){const s=e.offset;let i=0;n=na(n,()=>i++>=s)}return e.limit!=null&&(n=b3(n,e.limit)),n}}class YL extends jL{data;constructor(){super(),this.data=new Map}put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(e.toString(),t),e}get(e,t){t?.signal?.throwIfAborted();const n=this.data.get(e.toString());if(n==null)throw new Ld;return n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(e.toString())}delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(e.toString())}*_all(e,t){t?.signal?.throwIfAborted();for(const[n,s]of this.data.entries())yield{key:new En(n),value:s},t?.signal?.throwIfAborted()}*_allKeys(e,t){t?.signal?.throwIfAborted();for(const n of this.data.keys())yield new En(n),t?.signal?.throwIfAborted()}}function Od(r,e){let t;const n=function(){const s=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(s,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}var ra={},d4;function QL(){return d4||(d4=1,(function(){var r,e,t,n,s,i,o,a;a=function(c){var l,h,f,p;return l=(c&255<<24)>>>24,h=(c&255<<16)>>>16,f=(c&65280)>>>8,p=c&255,[l,h,f,p].join(".")},o=function(c){var l,h,f,p,m,_;for(l=[],f=p=0;p<=3&&c.length!==0;f=++p){if(f>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}_=e(c),m=_[0],h=_[1],c=c.substring(h),l.push(m)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),i=t("a"),s=t("A"),e=function(c){var l,h,f,p,m;for(p=0,l=10,h="9",f=0,c.length>1&&c[f]==="0"&&(c[f+1]==="x"||c[f+1]==="X"?(f+=2,l=16):"0"<=c[f+1]&&c[f+1]<="9"&&(f++,l=8,h="7")),m=f;f<c.length;){if("0"<=c[f]&&c[f]<=h)p=p*l+(t(c[f])-n)>>>0;else if(l===16)if("a"<=c[f]&&c[f]<="f")p=p*l+(10+t(c[f])-i)>>>0;else if("A"<=c[f]&&c[f]<="F")p=p*l+(10+t(c[f])-s)>>>0;else break;else break;if(p>4294967295)throw new Error("too large");f++}if(f===m)throw new Error("empty octet");return[p,f]},r=(function(){function c(l,h){var f,p,m;if(typeof l!="string")throw new Error("Missing `net' parameter");if(h||(m=l.split("/",2),l=m[0],h=m[1]),h||(h=32),typeof h=="string"&&h.indexOf(".")>-1){try{this.maskLong=o(h)}catch{throw new Error("Invalid mask: "+h)}for(f=p=32;p>=0;f=--p)if(this.maskLong===4294967295<<32-f>>>0){this.bitmask=f;break}}else if(h||h===0)this.bitmask=parseInt(h,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(l)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+h);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(o(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var h,f,p;for(p=o(this.first),f=o(this.last),h=0;p<=f;)l(a(p),p,h),h++,p++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c})(),ra.ip2long=o,ra.long2ip=a,ra.Netmask=r}).call(ra)),ra}var XL=QL();const JL=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],eO=JL.map(r=>new XL.Netmask(r));function xg(r){for(const e of eO)if(e.contains(r))return!0;return!1}function tO(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function nO(r){const e=r.split(":");if(e.length<2)return!1;const t=e[e.length-1].padStart(4,"0"),n=e[e.length-2].padStart(4,"0"),s=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return xg(s)}function rO(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function sO(r){const e=r.split(":"),t=e[e.length-1];return xg(t)}function iO(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function Ho(r){if(Va(r))return xg(r);if(tO(r))return nO(r);if(rO(r))return sO(r);if(Gb(r))return iO(r)}const Nt=r=>({match:e=>{const t=e[0];return t==null||t.code!==r||t.value!=null?!1:e.slice(1)}}),st=(r,e)=>({match:t=>{const n=t[0];return n?.code!==r||n.value==null||e!=null&&n.value!==e?!1:t.slice(1)}}),At=r=>({match:e=>{const t=r.match(e);return t===!1?e:t}}),Wn=(...r)=>({match:e=>{let t;for(const n of r){const s=n.match(e);s!==!1&&(t==null||s.length<t.length)&&(t=s)}return t??!1}}),Tt=(...r)=>({match:e=>{for(const t of r){const n=t.match(e);if(n===!1)return!1;e=n}return e}});function Ot(...r){function e(s){if(s==null)return!1;let i=s.getComponents();for(const o of r){const a=o.match(i);if(a===!1)return!1;i=a}return i}function t(s){return e(s)!==!1}function n(s){const i=e(s);return i===!1?!1:i.length===0}return{matchers:r,matches:t,exactMatch:n}}const oO=st(kt),aO=Ot(oO),Hh=st(uu),Vh=st(bc),Kh=st(fu),Sg=st(lu);Ot(Hh,At(st(kt)));Ot(Vh,At(st(kt)));Ot(Kh,At(st(kt)));const cO=Ot(Wn(Sg,Kh,Hh,Vh),At(st(kt))),j9=Tt(st(Eo),At(st(eg))),Y9=Tt(At(st(Uo)),st(Sr),At(st(eg))),Ag=Wn(j9,Y9),ko=Wn(Ag,Sg,Hh,Vh,Kh),lO=Ot(Wn(Ag,Tt(Wn(Sg,Kh,Hh,Vh),At(st(kt))))),h4=Ot(j9),p4=Ot(Y9),uO=Ot(Ag),Ig=Tt(ko,st(Bs)),wu=Tt(ko,st(wd)),$d=Ot(Tt(Ig,At(st(kt))));Ot(wu);const Tg=Tt(wu,Nt(Yb),At(st(kt))),zh=Tt(wu,Nt(Qb),At(st(kt))),fO=Wn(Tg,zh);Ot(Tg);const dO=Ot(zh),w3=Wn(ko,Ig,wu,Tg,zh),Q9=Wn(Tt(w3,Nt(tg),At(st(kt)))),Bl=Ot(Q9),X9=Wn(Tt(w3,Nt(Jb),At(st(kt))),Tt(w3,Nt(Sa),At(st(jb)),Nt(tg),At(st(kt)))),Md=Ot(X9),J9=Tt(wu,Nt(e7),At(st(El)),At(st(El)),At(st(kt))),g4=Ot(J9),ew=Tt(zh,Nt(Xb),At(st(El)),At(st(El)),At(st(kt))),m4=Ot(ew),Nd=Wn(Q9,X9,Tt(Ig,At(st(kt))),Tt(fO,At(st(kt))),Tt(ko,At(st(kt))),J9,ew,st(kt)),hO=Ot(Nd),pO=Tt(Nd,Nt(wc),st(kt)),Li=Ot(pO),gO=Wn(Tt(Nd,Nt(wc),Nt(zf),At(st(kt))),Tt(Nd,Nt(zf),At(st(kt))),Tt(Nt(zf),At(st(kt)))),y4=Ot(gO),mO=Wn(Tt(ko,st(Bs),Nt(Aa),At(st(kt))),Tt(ko,Nt(Aa),At(st(kt))));Ot(mO);const yO=Tt(ko,Wn(Tt(st(Bs,"443"),Nt(Aa)),Tt(st(Bs),Nt(t3)),Tt(st(Bs),Nt(Sa),Nt(Aa)),Tt(Nt(Sa),Nt(Aa)),Nt(Sa),Nt(t3)),At(st(kt)));Ot(yO);const bO=Wn(Tt(st(t7),At(st(kt))));Ot(bO);const wO=Wn(Tt(st(Zb),At(st(kt))));Ot(wO);class _O extends Map{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function os(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new _O({name:e,metrics:t}):n=new Map,n}const b4=864e13,EO=448,S0=449,vO=53,xO=54,SO=55,AO=56;class IO{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=os({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){const t=this.findHost(e);for(const n of this.mappings.values())if(n.domain===t)return!0;return!1}add(e,t){t.forEach(n=>{this.log("add DNS mapping %s to %s",n,e);const s=Ho(n)===!0;this.mappings.set(n,{domain:e,verified:s,expires:s?b4-Date.now():0,lastVerified:s?b4-Date.now():void 0})})}remove(e){const t=this.findHost(e);let n=!1;for(const[s,i]of this.mappings.entries())i.domain===t&&(this.log("removing %s to %s DNS mapping %e",s,i.domain),this.mappings.delete(s),n=n||i.verified);return n}getAll(e){const t=[];for(let n=0;n<e.length;n++){const i=e[n].multiaddr.stringTuples(),o=i[0][1];if(o!=null)for(const[a,c]of this.mappings.entries()){if(o!==a)continue;this.maybeAddSNITuple(i,c.domain)&&(e.splice(n,1),n--,t.push({multiaddr:lt(`/${i.map(h=>[du(h[0]).name,h[1]].join("/")).join("/")}`),verified:c.verified,type:"dns-mapping",expires:c.expires,lastVerified:c.lastVerified}))}}return t}maybeAddSNITuple(e,t){for(let n=0;n<e.length;n++)if(e[n][0]===EO&&e[n+1]?.[0]!==S0)return e.splice(n+1,0,[S0,t]),!0;return!1}confirm(e,t){const n=this.findHost(e);let s=!1;for(const[i,o]of this.mappings.entries())o.domain===n&&(this.log("marking %s to %s DNS mapping as verified",i,o.domain),s=o.verified,o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now());return s}unconfirm(e,t){const n=this.findHost(e);let s=!1;for(const[i,o]of this.mappings.entries())o.domain===n&&(this.log("removing verification of %s to %s DNS mapping",i,o.domain),s=s||o.verified,o.verified=!1,o.expires=Date.now()+t);return s}findHost(e){for(const t of e.stringTuples())if(t[0]===S0||t[0]===vO||t[0]===xO||t[0]===SO||t[0]===AO)return t[1]}}const A0=4,I0=41,T0=6,TO=273;class kO{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=os({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){const t=e.stringTuples();for(const n of this.mappings.values())for(const s of n)if(s.externalIp===t[0][1])return!0;return!1}add(e,t,n,s=t,i="tcp"){const o=`${e}-${t}-${i}`,a=this.mappings.get(o)??[],c={internalIp:e,internalPort:t,externalIp:n,externalPort:s,externalFamily:Va(n)?4:6,protocol:i,verified:!1,expires:0};a.push(c),this.mappings.set(o,a)}remove(e){const t=e.stringTuples(),n=t[0][1]??"",s=t[1][0]===T0?"tcp":"udp",i=parseInt(t[1][1]??"0");let o=!1;for(const[a,c]of this.mappings.entries()){for(let l=0;l<c.length;l++){const h=c[l];h.externalIp===n&&h.externalPort===i&&h.protocol===s&&(this.log("removing %s:%s to %s:%s %s IP mapping",h.externalIp,h.externalPort,n,i,s),o=o||h.verified,c.splice(l,1),l--)}c.length===0&&this.mappings.delete(a)}return o}getAll(e){const t=[];for(const{multiaddr:n}of e){const s=n.stringTuples();let i;if((s[0][0]===A0||s[0][0]===I0)&&s[1][0]===T0?i=`${s[0][1]}-${s[1][1]}-tcp`:(s[0][0]===A0||s[0][0]===I0)&&s[1][0]===TO&&(i=`${s[0][1]}-${s[1][1]}-udp`),i==null)continue;const o=this.mappings.get(i);if(o!=null)for(const a of o)s[0][0]=a.externalFamily===4?A0:I0,s[0][1]=a.externalIp,s[1][1]=`${a.externalPort}`,t.push({multiaddr:lt(`/${s.map(c=>[du(c[0]).name,c[1]].join("/")).join("/")}`),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return t}confirm(e,t){const s=e.stringTuples()[0][1];let i=!1;for(const o of this.mappings.values())for(const a of o)a.externalIp===s&&(this.log("marking %s to %s IP mapping as verified",a.internalIp,a.externalIp),i=a.verified,a.verified=!0,a.expires=Date.now()+t,a.lastVerified=Date.now());return i}unconfirm(e,t){const n=e.stringTuples(),s=n[0][1]??"",i=n[1][0]===T0?"tcp":"udp",o=parseInt(n[1][1]??"0");let a=!1;for(const c of this.mappings.values())for(let l=0;l<c.length;l++){const h=c[l];h.externalIp===s&&h.externalPort===o&&h.protocol===i&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",h.externalIp,h.externalPort,s,o,i),a=a||h.verified,h.verified=!1,h.expires=Date.now()+t)}return a}}function CO(r){try{for(const{code:e,value:t}of r.getComponents())if(e!==Uo&&t!=null){if(e===Eo)return t.startsWith("169.254.");if(e===Sr)return t.toLowerCase().startsWith("fe80")}}catch{}return!1}function tw(r){try{for(const{code:e}of r.getComponents())if(e!==Uo)return e===Eo||e===Sr}catch{}return!1}function Co(r){try{if(!tw(r))return!1;const[[,e]]=r.stringTuples();return e==null?!1:Ho(e)??!1}catch{}return!0}const RO={maxObservedAddresses:10};class PO{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=os({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??RO.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(const t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(Co(e)||CO(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:lt(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){const t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){const n=e.toString(),s=this.addresses.get(n)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,s),i}}const DO=[Eo,Sr,lu,uu,bc,fu];function w4(r){try{for(const{code:e}of r.getComponents())if(e!==Uo)return DO.includes(e)}catch{}return!1}const qO={maxObservedAddresses:10};class BO{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=os({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??qO.maxObservedAddresses}get(e,t){if(Co(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};const n=this.toKey(e);let s=this.addresses.get(n);return s==null&&(s={verified:!w4(e),expires:0},this.addresses.set(n,s)),{multiaddr:e,verified:s.verified,type:"transport",expires:s.expires,lastVerified:s.lastVerified}}has(e){const t=this.toKey(e);return this.addresses.has(t)}remove(e){const t=this.toKey(e),n=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),n}confirm(e,t){const n=this.toKey(e),s=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.addresses.set(n,s),i}unconfirm(e,t){const n=this.toKey(e),s=this.addresses.get(n)??{verified:!1,expires:0},i=s.verified;return s.verified=!1,s.expires=Date.now()+t,this.addresses.set(n,s),i}toKey(e){if(w4(e)){const t=e.toOptions();return`${t.host}-${t.port}-${t.transport}`}return e.toString()}}const _4=6e4,E4={addressVerificationTTL:_4*10,addressVerificationRetry:_4*5},LO=r=>r;function k0(r,e){const t=r.getPeerId();return t!=null&&Vn(t).equals(e)&&(r=r.decapsulate(lt(`/p2p/${e.toString()}`))),r}class OO{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(e,t={}){const{listen:n=[],announce:s=[],appendAnnounce:i=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(o=>o.toString()),this.announce=new Set(s.map(o=>o.toString())),this.appendAnnounce=new Set(i.map(o=>o.toString())),this.observed=new PO(e,t),this.dnsMappings=new IO(e,t),this.ipMappings=new kO(e,t),this.transportAddresses=new BO(e,t),this.announceFilter=t.announceFilter??LO,this.observedAddressFilter=xo(1024),this.addressVerificationTTL=t.addressVerificationTTL??E4.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??E4.addressVerificationRetry,this._updatePeerStoreAddresses=Od(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){const e=this.getAddresses().map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>lt(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>lt(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>lt(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){const t=e.stringTuples(),n=`${t[0][1]}:${t[1][1]}`;this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),e=k0(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=k0(e,this.components.peerId);let n=!0;(t?.type==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),n=!1):!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=k0(e,this.components.peerId),this.observed.has(e)&&this.observed.remove(e),this.transportAddresses.has(e)&&this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.dnsMappings.has(e)&&this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.ipMappings.has(e)&&this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)}getAddresses(){const e=new Set,t=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;const s=n.multiaddr.toString();return e.has(s)?!1:(e.add(s),!0)}).map(n=>n.multiaddr);return this.announceFilter(t.map(n=>{const s=lt(n);return s.getComponents().pop()?.value===this.components.peerId.toString()?s:s.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){const e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(e)}),e.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(s=>this.transportAddresses.get(s,this.addressVerificationTTL)));const n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(n)}),t=t.concat(n.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(lt(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,n,s=t,i="tcp"){this.ipMappings.add(e,t,n,s,i),this.observed.removePrefixed(`/ip${Va(n)?4:6}/${n}/${i}/${s}`)}removePublicAddressMapping(e,t,n,s=t,i="tcp"){this.ipMappings.remove(lt(`/ip${Va(n)?4:6}/${n}/${i}/${s}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e))return!1;const t=e.toOptions();if(t.family===6||t.host==="127.0.0.1"||Ho(t.host)===!0)return!1;const n=this.components.transportManager.getListeners(),s=[i=>Bl.exactMatch(i)||Md.exactMatch(i),i=>$d.exactMatch(i),i=>dO.exactMatch(i)];for(const i of s){if(!i(e))continue;const o=n.filter(l=>l.getAddrs().filter(h=>h.toOptions().family===4&&i(h)).length>0);if(o.length!==1)continue;const a=o[0].getAddrs().filter(l=>l.toOptions().host!=="127.0.0.1").pop();if(a==null)continue;const c=a.toOptions();return this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.transport),!0}return!1}}var v4;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(v4||(v4={}));class $O extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}}class MO extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}}class C0 extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}}class x4 extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}}class NO extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}}class UO extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}}class FO extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}}class S4 extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}}class HO extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}}class VO extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}}class KO extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}}class zO extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}}class WO extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}}class _3 extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}}class pf extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}}class GO extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}}class ZO extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}class jO{components={};_started=!1;constructor(e={}){this.components={};for(const[t,n]of Object.entries(e))this.components[t]=n;this.components.logger==null&&(this.components.logger=c7())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>Xp(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const YO=["metrics","connectionProtector","dns"],QO=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function XO(r={}){const e=new jO(r);return new Proxy(e,{get(n,s,i){if(typeof s=="string"&&!QO.includes(s)){const o=e.components[s];if(o==null&&!YO.includes(s))throw new $O(`${s} not set`);return o}return Reflect.get(n,s,i)},set(n,s,i){return typeof s=="string"?e.components[s]=i:Reflect.set(n,s,i),!0}})}function JO(r){const e={};for(const t of Object.values(r.components))for(const n of e$(t))e[n]=!0;for(const t of Object.values(r.components))for(const n of t$(t))if(e[n]!==!0)throw new MO(`Service "${n$(t)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function e$(r){return Array.isArray(r?.[pr])?r[pr]:[]}function t$(r){return Array.isArray(r?.[_o])?r[_o]:[]}function n$(r){return r?.[Symbol.toStringTag]??r?.toString()??"unknown"}const r$=4,s$=41;function i$(r={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{if(Bl.matches(e))return!1;const t=e.stringTuples();return t[0][0]===r$||t[0][0]===s$?!!Ho(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...r}}const A4=()=>{const r=new Error("Delay aborted");return r.name="AbortError",r},o$=new WeakMap;function a$({clearTimeout:r,setTimeout:e}={}){return(t,{value:n,signal:s}={})=>{if(s?.aborted)return Promise.reject(A4());let i,o,a;const c=r??clearTimeout,l=()=>{c(i),a(A4())},h=()=>{s&&s.removeEventListener("abort",l)},f=new Promise((p,m)=>{o=()=>{h(),p(n)},a=m,i=(e??setTimeout)(o,t)});return s&&s.addEventListener("abort",l,{once:!0}),o$.set(f,()=>{c(i),i=null,o()}),f}}const nw=a$();class c$ extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(e="Rate limit exceeded",t){super(e),this.name="RateLimitError",this.remainingPoints=t.remainingPoints,this.msBeforeNext=t.msBeforeNext,this.consumedPoints=t.consumedPoints,this.isFirstInDuration=t.isFirstInDuration}}class l$ extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}class u${memoryStorage;points;duration;blockDuration;execEvenly;execEvenlyMinDelayMs;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new f$}async consume(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n);let o=this.memoryStorage.incrby(s,t,i);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+t&&(o=this.memoryStorage.set(s,o.consumedPoints,this.blockDuration)),new c$("Rate limit exceeded",o);if(this.execEvenly&&o.msBeforeNext>0&&!o.isFirstInDuration){let a=Math.ceil(o.msBeforeNext/(o.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=o.consumedPoints*this.execEvenlyMinDelayMs),await nw(a)}return o}penalty(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n),o=this.memoryStorage.incrby(s,t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n),o=this.memoryStorage.incrby(s,-t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(e,t){const n=t*1e3,s=this.points+1;return this.memoryStorage.set(this.getKey(e),s,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:s,isFirstInDuration:!1}}set(e,t,n=0){const s=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}class f${storage;constructor(){this.storage=new Map}incrby(e,t,n){const s=this.storage.get(e);if(s!=null){const i=s.expiresAt!=null?s.expiresAt.getTime()-new Date().getTime():-1;return s.expiresAt==null||i>0?(s.value+=t,{remainingPoints:0,msBeforeNext:i,consumedPoints:s.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){const s=n*1e3,i=this.storage.get(e);i!=null&&clearTimeout(i.timeoutId);const o={value:t,expiresAt:s>0?new Date(Date.now()+s):void 0};return this.storage.set(e,o),s>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(e)},s),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:o.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){const t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}}function rw(r){if(Zc(r))return{peerId:r,multiaddrs:[]};let e=Array.isArray(r)?r:[r],t;if(e.length>0){const n=e[0].getPeerId();t=n==null?void 0:Vn(n),e.forEach(s=>{if(!Rh(s))throw new jp("Invalid multiaddr");const i=s.getPeerId();if(i==null){if(t!=null)throw new ot("Multiaddrs must all have the same peer id or have no peer id")}else{const o=Vn(i);if(t?.equals(o)!==!0)throw new ot("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(n=>!aO.exactMatch(n)),{peerId:t,multiaddrs:e}}const d$=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function h$(r,e){const t=r?.streams?.map(s=>s.protocol)??[],n=e?.closableProtocols??d$;if(!(t.filter(s=>s!=null&&!n.includes(s)).length>0))try{await r?.close(e)}catch(s){r?.abort(s)}}function E3(r){try{let e;typeof r=="string"?e=lt(r):e=r;const t=new Set([...e.getComponents().map(n=>n.name)]);if(!t.has("ipcidr")){const s=t.has("ip6")?"/ipcidr/128":"/ipcidr/32";e=e.encapsulate(s)}return $R(e)}catch{throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${r}`)}}class p${connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.allow=(t.allow??[]).map(n=>E3(n)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections %e",e)})}async _maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length,n=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,n),t<=n)return;const s=new Fo;for(const c of e){const l=c.remotePeer;if(!s.has(l)){s.set(l,0);try{const h=await this.peerStore.get(l);s.set(l,[...h.tags.values()].reduce((f,p)=>f+p.value,0))}catch(h){h.name!=="NotFoundError"&&this.log.error("error loading peer tags",h)}}}const i=this.sortConnections(e,s),o=Math.max(t-n,0),a=[];for(const c of i)if(this.log("too many connections open - closing a connection to %p",c.remotePeer),this.allow.some(h=>h.contains(c.remoteAddr.nodeAddress().address))||a.push(c),a.length===o)break;await Promise.all(a.map(async c=>{await h$(c,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:a})}sortConnections(e,t){return e.sort((n,s)=>{const i=n.timeline.open,o=s.timeline.open;return i<o?1:i>o?-1:0}).sort((n,s)=>n.direction==="outbound"&&s.direction==="inbound"?1:n.direction==="inbound"&&s.direction==="outbound"?-1:0).sort((n,s)=>n.streams.length>s.streams.length?1:n.streams.length<s.streams.length?-1:0).sort((n,s)=>{const i=t.get(n.remotePeer)??0,o=t.get(s.remotePeer)??0;return i>o?1:i<o?-1:0})}}const sw=1e4,g$=1e4,Ud=1e4,iw=25,m$=5,y$=10,b$=5,w$="last-dial-failure",_$="last-dial-success",ow=500,E$=32,v$=100,aw=50;let I4=class extends Error{type;code;constructor(e,t,n){super(e??"The operation was aborted"),this.type="aborted",this.name=n??"AbortError",this.code=t??"ABORT_ERR"}};async function wr(r,e,t){if(e==null)return r;if(e.aborted)return r.catch(()=>{}),Promise.reject(new I4(t?.errorMessage,t?.errorCode,t?.errorName));let n;const s=new I4(t?.errorMessage,t?.errorCode,t?.errorName);try{return await Promise.race([r,new Promise((i,o)=>{n=()=>{o(s)},e.addEventListener("abort",n)})])}finally{n!=null&&e.removeEventListener("abort",n)}}class x${deferred;signal;constructor(e){this.signal=e,this.deferred=en(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Di)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}}function S$(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class A${id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=S$(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new Di),this.cleanup())}async join(e={}){const t=new x$(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await wr(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}}class _u extends Cn{concurrency;maxSize;queue;pending;sort;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=Od(this.emitEmpty.bind(this),1),this.emitIdle=Od(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new l$;const n=new A$(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(t).then(s=>(this.safeDispatchEvent("completed",{detail:s}),this.safeDispatchEvent("success",{detail:{job:n,result:s}}),s)).catch(s=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:s}}),s})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new Di)}),this.clear()}async onEmpty(e){this.size!==0&&await uo(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await uo(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await uo(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=Or({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},s=c=>{c.detail!=null&&t.push(c.detail)},i=c=>{n(c.detail.error)},o=()=>{n()},a=()=>{n(new Di("Queue aborted"))};this.addEventListener("completed",s),this.addEventListener("failure",i),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",a);try{yield*t}finally{this.removeEventListener("completed",s),this.removeEventListener("failure",i),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",a),n()}}}class I$ extends _u{constructor(e={}){super({...e,sort:(t,n)=>t.options.priority>n.options.priority?-1:t.options.priority<n.options.priority?1:0})}}function zn(r){const e=new globalThis.AbortController;function t(){const i=r.filter(o=>o?.aborted===!0).map(o=>o?.reason).pop();e.abort(i);for(const o of r)o?.removeEventListener!=null&&o.removeEventListener("abort",t)}for(const i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}const s=e.signal;return s.clear=n,s}function T$(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function T4(r){if(!tw(r))return!1;const{address:e}=r.nodeAddress();return T$(e)}function k$(r,e){const t=$d.exactMatch(r.multiaddr),n=$d.exactMatch(e.multiaddr);if(t&&!n)return-1;if(!t&&n)return 1;const s=Md.exactMatch(r.multiaddr),i=Md.exactMatch(e.multiaddr);if(s&&!i)return-1;if(!s&&i)return 1;const o=Bl.exactMatch(r.multiaddr),a=Bl.exactMatch(e.multiaddr);if(o&&!a)return-1;if(!o&&a)return 1;const c=y4.exactMatch(r.multiaddr),l=y4.exactMatch(e.multiaddr);if(c&&!l)return-1;if(!c&&l)return 1;const h=g4.exactMatch(r.multiaddr),f=g4.exactMatch(e.multiaddr);if(h&&!f)return-1;if(!h&&f)return 1;const p=m4.exactMatch(r.multiaddr),m=m4.exactMatch(e.multiaddr);return p&&!m?-1:!p&&m?1:0}function C$(r,e){const t=T4(r.multiaddr),n=T4(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function R$(r,e){const t=Co(r.multiaddr),n=Co(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function P$(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function D$(r,e){const t=Li.exactMatch(r.multiaddr),n=Li.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function q$(r){return r.sort(k$).sort(P$).sort(D$).sort(R$).sort(C$)}async function cw(r,e,t){const n=t.depth??0;if(n>(t.maxRecursiveDepth??E$))throw new ZO("Max recursive depth reached");let s=!1;const i=[];for(const o of Object.values(e))if(o.canResolve(r)){s=!0;const a=await o.resolve(r,t);for(const c of a)i.push(...await cw(c,e,{...t,depth:n+1}))}return s===!1&&i.push(r),i}const Bc={maxParallelDials:aw,maxDialQueueLength:ow,maxPeerAddrsToDial:iw,dialTimeout:sw,resolvers:{dnsaddr:ng}};class B${queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;resolvers;constructor(e,t={}){this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Bc.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??Bc.maxDialQueueLength,this.dialTimeout=t.dialTimeout??Bc.dialTimeout,this.connections=t.connections??new Fo,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.resolvers=t.resolvers??Bc.resolvers,this.shutDownController=new AbortController,this.shutDownController.signal,this.queue=new I$({concurrency:t.maxParallelDials??Bc.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("failure",n=>{n.detail?.error.name!==Di.name&&this.log.error("error in dial queue - %e",n.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){const{peerId:n,multiaddrs:s}=rw(e),i=Array.from(this.connections.values()).flat().find(a=>t.force===!0||a.limits!=null?!1:a.remotePeer.equals(n)?!0:s.find(c=>c.equals(a.remoteAddr)));if(i?.status==="open")return this.log("already connected to %a",i.remoteAddr),t.onProgress?.(new fn("dial-queue:already-connected")),i;const o=this.queue.queue.find(a=>{if(n?.equals(a.options.peerId)===!0)return!0;const c=a.options.multiaddrs;if(c==null)return!1;for(const l of s)if(c.has(l.toString()))return!0;return!1});if(o!=null){this.log("joining existing dial target for %p",n);for(const a of s)o.options.multiaddrs.add(a.toString());return t.onProgress?.(new fn("dial-queue:already-in-dial-queue")),o.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new jc("Dial queue is full");return this.log("creating dial target for %p",n,s.map(a=>a.toString())),t.onProgress?.(new fn("dial-queue:add-to-dial-queue")),this.queue.add(async a=>{a.onProgress?.(new fn("dial-queue:start-dial"));const c=zn([this.shutDownController.signal,a.signal]);try{return await this.dialPeer(a,c)}finally{c.clear()}},{peerId:n,priority:t.priority??lw,multiaddrs:new Set(s.map(a=>a.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){const n=e.peerId,s=e.multiaddrs,i=new Set;let o=e.multiaddrs.size===0,a=0,c=0;const l=[];for(this.log("starting dial to %p",n);o||s.size>0;){c++,o=!1;const h=[],f=new Set(e.multiaddrs);s.clear(),this.log("calculating addrs to dial %p from %s",n,[...f]);const p=await this.calculateMultiaddrs(n,f,{...e,signal:t});for(const m of p){if(i.has(m.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",m.multiaddr,n);continue}h.push(m)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,h.map(m=>m.multiaddr.toString())),e?.onProgress?.(new fn("dial-queue:calculated-addresses",h));for(const m of h){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,e.peerId),new jc("Peer had more than maxPeerAddrsToDial");a++;try{const _=await this.components.transportManager.dial(m.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",m.multiaddr);try{await this.components.peerStore.merge(_.remotePeer,{multiaddrs:[_.remoteAddr],metadata:{[_$]:Ge(Date.now().toString())}})}catch(R){this.log.error("could not update last dial failure key for %p",n,R)}return _}catch(_){if(this.log.error("dial failed to %a",m.multiaddr,_),i.add(m.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[w$]:Ge(Date.now().toString())}})}catch(R){this.log.error("could not update last dial failure key for %p",n,R)}if(t.aborted)throw new Qp(_.message);l.push(_)}}}throw l.length===1?l[0]:new AggregateError(l,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,n={}){const s=[...t].map(f=>({multiaddr:lt(f),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new jc("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(e)===!0)throw new S4("The dial request is blocked by gater.allowDialPeer");if(s.length===0){this.log("loading multiaddrs for %p",e);try{const f=await this.components.peerStore.get(e);s.push(...f.addresses),this.log("loaded multiaddrs for %p",e,s.map(({multiaddr:p})=>p.toString()))}catch(f){if(f.name!=="NotFoundError")throw f}}if(s.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{const f=await this.components.peerRouting.findPeer(e,n);this.log("found multiaddrs for %p in the peer routing",e,s.map(({multiaddr:p})=>p.toString())),s.push(...f.multiaddrs.map(p=>({multiaddr:p,isCertified:!1})))}catch(f){f.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,f)}}}let i=(await Promise.all(s.map(async f=>{const p=await cw(f.multiaddr,this.resolvers,{dns:this.components.dns,log:this.log,...n});return p.length===1&&p[0].equals(f.multiaddr)?f:p.map(m=>({multiaddr:m,isCertified:!1}))}))).flat();if(e!=null){const f=`/p2p/${e.toString()}`;i=i.map(p=>p.multiaddr.getComponents().pop()?.name!=="p2p"?{multiaddr:p.multiaddr.encapsulate(f),isCertified:p.isCertified}:p)}const o=i.filter(f=>{if(this.components.transportManager.dialTransportForMultiaddr(f.multiaddr)==null)return!1;const p=f.multiaddr.getPeerId();return e!=null&&p!=null?e.equals(p):!0}),a=new Map;for(const f of o){const p=f.multiaddr.toString(),m=a.get(p);if(m!=null){m.isCertified=m.isCertified||f.isCertified||!1;continue}a.set(p,f)}const c=[...a.values()];if(c.length===0)throw new KO("The dial request has no valid addresses");const l=[];for(const f of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(f.multiaddr)||l.push(f);const h=this.addressSorter==null?q$(l):l.sort(this.addressSorter);if(h.length===0)throw new S4("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",i.map(({multiaddr:f})=>f.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",h.map(({multiaddr:f})=>f.toString())),h}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const n=await this.calculateMultiaddrs(void 0,new Set(e.map(s=>s.toString())),t);return t.runOnLimitedConnection===!1?n.find(s=>!Li.matches(s.multiaddr))!=null:!0}catch(n){this.log.trace("error calculating if multiaddr(s) were dialable",n)}return!1}}class ec extends _u{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}}var R0={},P0,k4;function L$(){if(k4)return P0;k4=1;function r(e,t){typeof t=="boolean"&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return P0=r,r.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},r.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},r.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=new Date().getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var n=this._timeouts.shift();if(n===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1);else return!1;var s=this;return this._timer=setTimeout(function(){s._attempts++,s._operationTimeoutCb&&(s._timeout=setTimeout(function(){s._operationTimeoutCb(s._attempts)},s._operationTimeout),s._options.unref&&s._timeout.unref()),s._fn(s._attempts)},n),this._options.unref&&this._timer.unref(),!0},r.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){n._operationTimeoutCb()},n._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},r.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},r.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},r.prototype.start=r.prototype.try,r.prototype.errors=function(){return this._errors},r.prototype.attempts=function(){return this._attempts},r.prototype.mainError=function(){if(this._errors.length===0)return null;for(var e={},t=null,n=0,s=0;s<this._errors.length;s++){var i=this._errors[s],o=i.message,a=(e[o]||0)+1;e[o]=a,a>=n&&(t=i,n=a)}return t},P0}var C4;function O$(){return C4||(C4=1,(function(r){var e=L$();r.operation=function(t){var n=r.timeouts(t);return new e(n,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},r.timeouts=function(t){if(t instanceof Array)return[].concat(t);var n={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in t)n[s]=t[s];if(n.minTimeout>n.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],o=0;o<n.retries;o++)i.push(this.createTimeout(o,n));return t&&t.forever&&!i.length&&i.push(this.createTimeout(o,n)),i.sort(function(a,c){return a-c}),i},r.createTimeout=function(t,n){var s=n.randomize?Math.random()+1:1,i=Math.round(s*Math.max(n.minTimeout,1)*Math.pow(n.factor,t));return i=Math.min(i,n.maxTimeout),i},r.wrap=function(t,n,s){if(n instanceof Array&&(s=n,n=null),!s){s=[];for(var i in t)typeof t[i]=="function"&&s.push(i)}for(var o=0;o<s.length;o++){var a=s[o],c=t[a];t[a]=(function(h){var f=r.operation(n),p=Array.prototype.slice.call(arguments,1),m=p.pop();p.push(function(_){f.retry(_)||(_&&(arguments[0]=f.mainError()),m.apply(this,arguments))}),f.attempt(function(){h.apply(t,p)})}).bind(t,c),t[a].options=n}}})(R0)),R0}var D0,R4;function $$(){return R4||(R4=1,D0=O$()),D0}var M$=$$(),N$=Ch(M$);const U$=Object.prototype.toString,F$=r=>U$.call(r)==="[object Error]",H$=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function V$(r){if(!(r&&F$(r)&&r.name==="TypeError"&&typeof r.message=="string"))return!1;const{message:t,stack:n}=r;return t==="Load failed"?n===void 0||"__sentry_captured__"in r:t.startsWith("error sending request for url")?!0:H$.has(t)}let K$=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}};const P4=(r,e,t)=>{const n=t.retries-(e-1);return r.attemptNumber=e,r.retriesLeft=n,r};async function z$(r,e){return new Promise((t,n)=>{e={...e},e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.retries??=10;const s=N$.operation(e),i=()=>{s.stop(),n(e.signal?.reason)};e.signal&&!e.signal.aborted&&e.signal.addEventListener("abort",i,{once:!0});const o=()=>{e.signal?.removeEventListener("abort",i),s.stop()};s.attempt(async a=>{try{const c=await r(a);o(),t(c)}catch(c){try{if(!(c instanceof Error))throw new TypeError(`Non-error was thrown: "${c}". You should only throw errors.`);if(c instanceof K$)throw c.originalError;if(c instanceof TypeError&&!V$(c))throw c;if(P4(c,a,e),await e.shouldRetry(c)||(s.stop(),n(c)),await e.onFailedAttempt(c),!s.retry(c))throw s.mainError()}catch(l){P4(l,a,e),o(),n(l)}}})})}class W${log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new ec({concurrency:t.maxParallelReconnects??b$,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(s=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,s)})})}async maybeReconnect(e){if(!this.started)return;const t=await this.peerStore.get(e);D4(t)&&(this.queue.has(e)||this.queue.add(async n=>{await z$(async s=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:n?.signal})}catch(i){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,s,this.retries,i),i}},{signal:n?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",e,n);const s={};[...t.tags.keys()].forEach(i=>{i.startsWith(au)&&(s[i]=void 0)}),await this.peerStore.merge(e,{tags:s}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>D4(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(n=>{this.log.error(n)})}))}).catch(e=>{this.log.error(e)})}stop(){this.started=!1,this.queue.abort()}}function D4(r){for(const e of r.tags.keys())if(e.startsWith(au))return!0;return!1}const lw=50,q0={maxConnections:v$,inboundConnectionThreshold:m$,maxIncomingPendingConnections:y$};class G${started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(e,t={}){if(this.maxConnections=t.maxConnections??q0.maxConnections,this.maxConnections<1)throw new ot("Connection Manager maxConnections must be greater than 0");this.connections=new Fo,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(n=>E3(n)),this.deny=(t.deny??[]).map(n=>E3(n)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??q0.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new u$({points:t.inboundConnectionThreshold??q0.inboundConnectionThreshold,duration:1}),this.connectionPruner=new p$({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:t.allow?.map(n=>lt(n))}),this.dialQueue=new B$(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??aw,maxDialQueueLength:t.maxDialQueueLength??ow,maxPeerAddrsToDial:t.maxPeerAddrsToDial??iw,dialTimeout:t.dialTimeout??sw,resolvers:t.resolvers??{dnsaddr:ng},connections:this.connections}),this.reconnectQueue=new W$({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const t of this.connections.values())for(const n of t)e[n.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const n of t)for(const s of n.streams){const i=`${s.direction} ${s.protocol??"unnegotiated"}`;e[i]=(e[i]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const n of this.connections.values())for(const s of n){const i={};for(const o of s.streams){const a=`${o.direction} ${o.protocol??"unnegotiated"}`;i[a]=(i[a]??0)+1}for(const[o,a]of Object.entries(i))e[o]=e[o]??[],e[o].push(a)}const t={};for(let[n,s]of Object.entries(e)){s=s.sort((o,a)=>o-a);const i=Math.floor(s.length*.9);t[n]=s[i]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await wl(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await Th(this.reconnectQueue,this.dialQueue,this.connectionPruner);const e=[];for(const t of this.connections.values())for(const n of t)e.push((async()=>{try{await n.close()}catch(s){this.log.error(s)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new ot("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch(t=>{this.log.error(t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;const n=t.remotePeer,s=!this.connections.has(n),i=this.connections.get(n)??[];i.push(t),this.connections.set(n,i),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),s&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e,n=t.remotePeer,i=(this.connections.get(n)??[]).filter(o=>o.id!==t.id);this.connections.set(n,i),i.length===0&&(this.log.trace("peer %p disconnected, removing connection map entry",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(const n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new yd("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();const{peerId:n}=rw(e);if(this.peerId.equals(n))throw new Cb("Can not dial self");if(n!=null&&t.force!==!0){this.log("dial %p",n);const a=this.getConnections(n).find(c=>c.limits==null);if(a!=null)return this.log("had an existing non-limited connection to %p as %a",n,a.remoteAddr),t.onProgress?.(new fn("dial-queue:already-connected")),a}const s=await this.dialQueue.dial(e,{...t,priority:t.priority??lw});if(s.status!=="open")throw new Tb("Remote closed connection during opening");let i=this.connections.get(s.remotePeer);i==null&&(i=[],this.connections.set(s.remotePeer,i));let o=!1;for(const a of i)if(a.id===s.id&&(o=!0),t.force!==!0&&a.id!==s.id&&a.remoteAddr.equals(s.remoteAddr))return s.abort(new jp("Duplicate multiaddr connection")),a;return o||i.push(s),s}finally{this.outboundPendingConnections--}}async closeConnections(e,t={}){const n=this.connections.get(e)??[];await Promise.all(n.map(async s=>{try{await s.close(t)}catch(i){s.abort(i)}}))}async acceptIncomingConnection(e){if(this.deny.some(s=>s.contains(e.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(s=>s.contains(e.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const s=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(s,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,s),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(n=>lt(n))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}class B0{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){const n=this.alpha(t,this.previousTime),s=e-this.movingAverage,i=n*s;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+s*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*s}else this.movingAverage=e;this.previousTime=t}}const Z$=1.2,j$=2,Y$=5e3,Q$=6e4,X$=5e3;class Ll{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(e={}){const t=e.interval??X$;this.success=new B0(t),this.failure=new B0(t),this.next=new B0(t),this.failureMultiplier=e.failureMultiplier??j$,this.timeoutMultiplier=e.timeoutMultiplier??Z$,this.minTimeout=e.minTimeout??Y$,this.maxTimeout=e.maxTimeout??Q$,e.metricName!=null&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);const n=AbortSignal.timeout(t),s=zn([e.signal,n]);return s.start=Date.now(),s.timeout=t,s}cleanUp(e){const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}function J$(r){return r.reason}async function eM(r,e,t){if(e==null)return r;const n=t?.translateError??J$;if(e.aborted)return r.catch(()=>{}),Promise.reject(n(e));let s;try{return await Promise.race([r,new Promise((i,o)=>{s=()=>{o(n(e))},e.addEventListener("abort",s)})])}finally{s!=null&&e.removeEventListener("abort",s)}}class tM{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=en(),this.haveNext=en()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=en(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=en(),await eM(this.readNext.promise,t?.signal,t)}}function uw(){return new tM}function nM(r){return r.reason}async function q4(r,e,t){if(e==null)return r;const n=nM;if(e.aborted)return r.catch(()=>{}),Promise.reject(n(e));let s;try{return await Promise.race([r,new Promise((i,o)=>{s=()=>{o(n(e))},e.addEventListener("abort",s)})])}finally{s!=null&&e.removeEventListener("abort",s)}}let rM=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function Fd(r,e){const t=uw();r.sink(t).catch(async o=>{await t.end(o)}),r.sink=async o=>{for await(const a of o)await t.push(a);await t.end()};let n=r.source;r.source[Symbol.iterator]!=null?n=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(n=r.source[Symbol.asyncIterator]());const s=new Ue;return{read:async o=>{if(o?.signal?.throwIfAborted(),o?.bytes==null){const{done:c,value:l}=await q4(n.next(),o?.signal);return c===!0?null:l}for(;s.byteLength<o.bytes;){const{value:c,done:l}=await q4(n.next(),o?.signal);if(l===!0)throw new rM("unexpected end of input");s.append(c)}const a=s.sublist(0,o.bytes);return s.consume(o.bytes),a},write:async(o,a)=>{a?.signal?.throwIfAborted(),o instanceof Uint8Array?await t.push(o,a):await t.push(o.subarray(),a)},unwrap:()=>{if(s.byteLength>0){const o=r.source;r.source=(async function*(){e?.yieldBytes===!1?yield s:yield*s,yield*o})()}return r}}}const sM=1e4,iM="1.0.0",oM="ping",aM="ipfs",B4=32,cM=!0;class lM{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??aM}/${oM}/${iM}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??sM,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??cM,this.timeout=new Ll({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[pr]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{const n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),s=await e.newStream(this.protocol,{signal:n,runOnLimitedConnection:!0}),i=Fd(s);t=Date.now(),await Promise.all([i.write(Hy(B4),{signal:n}),i.read({bytes:B4,signal:n})]),e.rtt=Date.now()-t,await i.unwrap().close({signal:n})}catch(n){if(n.name!=="UnsupportedProtocolError")throw n;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}function uM(r){return r[Symbol.asyncIterator]!=null}async function fM(r,e,t){try{await Promise.all(r.map(async n=>{for await(const s of n)await e.push(s,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(n){await e.end(n,{signal:t}).catch(()=>{})}}async function*dM(r){const e=new AbortController,t=uw();fM(r,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*hM(r){for(const e of r)yield*e}function Ol(...r){const e=[];for(const t of r)uM(t)||e.push(t);return e.length===r.length?hM(e):dM(r)}class pM{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()}),getAttributesFromYieldedValue:(n,s)=>({...s,providers:[...Array.isArray(s.providers)?s.providers:[],n.id.toString()]})})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()})})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()})})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([n])=>({key:Le(n,"base36")})})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([n])=>({key:Le(n,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new C0("No content routers available");const n=this,s=new rs;for await(const i of Ol(...n.routers.filter(o=>o.findProviders instanceof Function).map(o=>o.findProviders(e,t))))i!=null&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!s.has(i.id)&&(s.add(i.id),yield i))}async provide(e,t={}){if(this.routers.length===0)throw new C0("No content routers available");await Promise.all(this.routers.filter(n=>n.provide instanceof Function).map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new C0("No content routers available");await Promise.all(this.routers.filter(n=>n.cancelReprovide instanceof Function).map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new yd;await Promise.all(this.routers.filter(s=>s.put instanceof Function).map(async s=>{await s.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new yd;return Promise.any(this.routers.filter(n=>n.get instanceof Function).map(async n=>n.get(e,t)))}}const gf=globalThis.CustomEvent??Event;async function*kg(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const n=e.ordered??!1,s=new EventTarget,i=[];let o=en(),a=en(),c=!1,l,h=!1;s.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const _ of r){if(i.length===t&&(o=en(),await o.promise),h)break;const R={done:!1};i.push(R),_().then(T=>{R.done=!0,R.ok=!0,R.value=T,s.dispatchEvent(new gf("task-complete"))},T=>{R.done=!0,R.err=T,s.dispatchEvent(new gf("task-complete"))})}c=!0,s.dispatchEvent(new gf("task-complete"))}catch(_){l=_,s.dispatchEvent(new gf("task-complete"))}});function f(){return n?i[0]?.done:!!i.find(_=>_.done)}function*p(){for(;i.length>0&&i[0].done;){const _=i[0];if(i.shift(),_.ok)yield _.value;else throw h=!0,o.resolve(),_.err;o.resolve()}}function*m(){for(;f();)for(let _=0;_<i.length;_++)if(i[_].done){const R=i[_];if(i.splice(_,1),_--,R.ok)yield R.value;else throw h=!0,o.resolve(),R.err;o.resolve()}}for(;;){if(f()||(a=en(),await a.promise),l!=null||(n?yield*p():yield*m(),l!=null))throw l;if(c&&i.length===0)break}}class gM{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,peer:n.toString()})})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,key:Le(n,"base36")}),getAttributesFromYieldedValue:(n,s)=>({...s,peers:[...Array.isArray(s.peers)?s.peers:[],n.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(this.routers.length===0)throw new x4("No peer routers available");if(e.toString()===this.peerId.toString())throw new NO("Should not try to find self");const n=this,s=Ol(...this.routers.filter(i=>i.findPeer instanceof Function).map(i=>(async function*(){try{yield await i.findPeer(e,t)}catch(o){n.log.error(o)}})()));for await(const i of s)if(i!=null)return i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),i;throw new qi}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new x4("No peer routers available");const n=this,s=xo(1024);for await(const i of kg((async function*(){const o=Ol(...n.routers.filter(a=>a.getClosestPeers instanceof Function).map(a=>a.getClosestPeers(e,t)));for await(let a of o)yield async()=>{if(a.multiaddrs.length===0)try{a=await n.findPeer(a.id,{...t,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs",c);return}return a}})()))i!=null&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!s.has(i.id.toMultihash().bytes)&&(s.add(i.id.toMultihash().bytes),yield i))}}class mM extends Cn{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;const t=zn([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=en(),yield(await uo(this,"walk:peer",t,{errorEvent:"walk:error"})).detail}finally{t.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const e=zn([this.walkController.signal,this.shutdownController.signal]),t=Date.now();let n=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const s=Hy(32);let i=Date.now();for await(const o of this.peerRouting.getClosestPeers(s,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",o.id,Date.now()-i,this.walkers),n++,this.safeDispatchEvent("walk:peer",{detail:o}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await wr(this.needNext.promise,e)),i=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",s,this.walkers,n)}catch(s){this.log.error("random walk errored",s),this.safeDispatchEvent("walk:error",{detail:s})}this.log("no walkers left, ended walk")}).catch(s=>{this.log.error("random walk errored",s)}).finally(()=>{this.log("finished walk, found %d peers after %dms",n,Date.now()-t),this.walking=!1})}}const fw=32,dw=64;class yM{log;topologies;handlers;components;constructor(e){this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,e.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{const t={};for(const[n,s]of this.topologies)t[n]=s.size;return t}}),this.handlers=os({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw new UO(`No handler registered for protocol ${e}`);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e)&&n?.force!==!0)throw new FO(`Handler already registered for protocol ${e}`);const s=Nb.bind({ignoreUndefined:!0})({maxInboundStreams:fw,maxOutboundStreams:dw},n);this.handlers.set(e,{handler:t,options:s}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},n)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach(s=>{this.handlers.delete(s)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(t==null)throw new ot("invalid topology");const n=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let s=this.topologies.get(e);return s==null&&(s=new Map,this.topologies.set(e,s)),s.set(n,t),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail,n={signal:AbortSignal.timeout(5e3)};this.components.peerStore.get(t,n).then(s=>{for(const i of s.protocols){const o=this.topologies.get(i);if(o!=null)for(const a of o.values())a.filter?.has(t)!==!1&&(a.filter?.remove(t),a.onDisconnect?.(t))}}).catch(s=>{s.name!=="NotFoundError"&&this.log.error("could not inform topologies of disconnecting peer %p",t,s)})}_onPeerUpdate(e){const{peer:t,previous:n}=e.detail,s=(n?.protocols??[]).filter(i=>!t.protocols.includes(i));for(const i of s){const o=this.topologies.get(i);if(o!=null)for(const a of o.values())a.filter?.has(t.id)!==!1&&(a.filter?.remove(t.id),a.onDisconnect?.(t.id))}}_onPeerIdentify(e){const t=e.detail.protocols,n=e.detail.connection,s=e.detail.peerId;for(const i of t){const o=this.topologies.get(i);if(o!=null)for(const a of o.values())n.limits!=null&&a.notifyOnLimitedConnection!==!0||a.filter?.has(s)!==!0&&(a.filter?.add(s),a.onConnect?.(s,n))}}}class bM{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=os({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=os({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??bl.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){const t=e[Symbol.toStringTag];if(t==null)throw new ot("Transport must have a valid tag");if(this.transports.has(t))throw new ot(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){const s=n.pop();s!=null&&e.push(s.close())}await Promise.all(e),this.log("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){const n=this.dialTransportForMultiaddr(e);if(n==null)throw new GO(`No transport available for address ${String(e)}`);return t?.onProgress?.(new fn("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(const t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new yd("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(i=>{t.errors.set(i.toString(),new HO)});const n=[];for(const[i,o]of this.transports.entries()){const a=o.listenFilter(e);for(const c of a){this.log("creating listener for %s on %a",i,c);const l=o.createListener({upgrader:this.components.upgrader});let h=this.listeners.get(i)??[];h==null&&(h=[],this.listeners.set(i,h)),h.push(l),l.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:l})}),l.addEventListener("close",()=>{const f=h.findIndex(p=>p===l);h.splice(f,1),this.components.events.safeDispatchEvent("transport:close",{detail:l})}),h4.matches(c)?t.ipv4.attempts++:p4.matches(c)&&t.ipv6.attempts++,n.push(l.listen(c).then(()=>{t.errors.delete(c.toString()),h4.matches(c)&&t.ipv4.success++,p4.matches(c)&&t.ipv6.success++},f=>{throw this.log.error("transport %s could not listen on address %a - %e",i,c,f),t.errors.set(c.toString(),f),f}))}}const s=await Promise.allSettled(n);if(!(s.length>0&&s.every(i=>i.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===bl.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new VO(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([i,o])=>`
  ${i}: ${`${o.stack??o}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;const t=e.ipv4.attempts===e.ipv4.success,n=e.ipv6.success===0;return t&&n}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const s=t.pop();s!=null&&n.push(s.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const Qn="/multistream/1.0.0",Cg=1024;let wM=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},_M=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},EM=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function tc(r,e={}){const t=Fd(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=hr(e.maxDataLength));const n=e?.lengthDecoder??mc,s=e?.lengthEncoder??Ri;return{read:async o=>{let a=-1;const c=new Ue;for(;;){c.append(await t.read({...o,bytes:1}));try{a=n(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new wM("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new EM("message length length too long");if(a>-1)break}if(e?.maxDataLength!=null&&a>e.maxDataLength)throw new _M("message length too long");return t.read({...o,bytes:a})},write:async(o,a)=>{await t.write(new Ue(s(o.byteLength),o),a)},writeV:async(o,a)=>{const c=new Ue(...o.flatMap(l=>[s(l.byteLength),l]));await t.write(c,a)},unwrap:()=>t.unwrap()}}const vM=Ge(`
`);async function Kc(r,e,t){await r.write(e,t)}async function xM(r,e,t){await r.writeV(e,t)}async function SM(r,e){const t=await r.read(e);if(t.byteLength===0||t.get(t.byteLength-1)!==vM[0])throw e.log.error("Invalid mss message - missing newline",t),new Jt("Missing newline");return t.sublist(0,-1)}async function Ca(r,e){const t=await SM(r,e);return Le(t.subarray())}async function v3(r,e,t){if(e=Array.isArray(e)?[...e]:[e],e.length===1&&t.negotiateFully===!1)return AM(r,e[0],t);const n=tc(r,{...t,maxDataLength:Cg}),s=e.shift();if(s==null)throw new Error("At least one protocol must be specified");t.log.trace('select: write ["%s", "%s"]',Qn,s);const i=Ge(`${Qn}
`),o=Ge(`${s}
`);await xM(n,[i,o],t),t.log.trace("select: reading multistream-select header");let a=await Ca(n,t);if(t.log.trace('select: read "%s"',a),a===Qn&&(t.log.trace("select: reading protocol response"),a=await Ca(n,t),t.log.trace('select: read "%s"',a)),a===s)return{stream:n.unwrap(),protocol:s};for(const c of e){t.log.trace('select: write "%s"',c),await Kc(n,Ge(`${c}
`),t),t.log.trace("select: reading protocol response");const l=await Ca(n,t);if(t.log.trace('select: read "%s" for "%s"',l,c),l===c)return{stream:n.unwrap(),protocol:c}}throw new Yp("protocol selection failed")}function AM(r,e,t){const n=r.sink.bind(r),s=r.source;let i=!1,o=!1;const a=en();let c=!1,l=!1;const h=en();let f=!1,p=!1;const m=en(),_=tc({sink:n,source:s},{...t,maxDataLength:Cg});r.sink=async D=>{const{sink:I}=_.unwrap();await I((async function*(){let q=!1;for await(const L of D){if(l&&await h.promise,c)yield L;else{l=!0,t.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',Qn,e,L.byteLength);const z=`${e}
`;yield new Ue(Uint8Array.from([19]),Ge(`${Qn}
`),Ri(z.length),Ge(z),L).subarray(),t.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',Qn,e,L.byteLength),c=!0,l=!1,h.resolve(),R().catch(Y=>{t.log.error("could not finish optimistic protocol negotiation of %s",e,Y)})}q=!0}q||await R()})())};async function R(){if(o){t.log.trace("optimistic: already negotiating %s stream",e),await a.promise;return}o=!0;try{c||(t.log.trace("optimistic: doing send protocol for %s stream",e),await T()),f||(t.log.trace("optimistic: doing read protocol for %s stream",e),await A())}finally{o=!1,i=!0,a.resolve()}}async function T(){if(l){await h.promise;return}l=!0;try{t.log.trace('optimistic: write ["%s", "%s", data] in source',Qn,e),await _.writeV([Ge(`${Qn}
`),Ge(`${e}
`)]),t.log.trace('optimistic: wrote ["%s", "%s", data] in source',Qn,e)}finally{c=!0,l=!1,h.resolve()}}async function A(){if(p){await m.promise;return}p=!0;try{t.log.trace("optimistic: reading multistream select header");let D=await Ca(_,t);if(t.log.trace('optimistic: read multistream select header "%s"',D),D===Qn&&(D=await Ca(_,t)),t.log.trace('optimistic: read protocol "%s", expecting "%s"',D,e),D!==e)throw new Yp("protocol selection failed")}finally{f=!0,p=!1,m.resolve()}}if(r.source=(async function*(){await R(),t.log.trace('optimistic: reading data from "%s" stream',e),yield*_.unwrap().source})(),r.closeRead!=null){const D=r.closeRead.bind(r);r.closeRead=async I=>{i||await R().catch(q=>{t.log.error("could not negotiate protocol before close read",q)}),await D(I)}}if(r.closeWrite!=null){const D=r.closeWrite.bind(r);r.closeWrite=async I=>{i||await R().catch(q=>{t.log.error("could not negotiate protocol before close write",q)}),await D(I)}}if(r.close!=null){const D=r.close.bind(r);r.close=async I=>{const q=[];l&&q.push(h.promise),p&&q.push(m.promise),q.length>0?await wr(Promise.all(q),I?.signal):(i=!0,o=!1,a.resolve()),await D(I)}}return{stream:r,protocol:e}}const hw=1024*1024*4;let IM=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"};function TM(r){return r[Symbol.asyncIterator]!=null}function pw(r,e){if(r.byteLength>e)throw new IM("Message length too long")}const Wh=r=>{const e=hr(r),t=Tr(e);return Ri(r,t),Wh.bytes=e,t};Wh.bytes=0;function gw(r,e){e=e??{};const t=e.lengthEncoder??Wh,n=e?.maxDataLength??hw;function*s(i){pw(i,n);const o=t(i.byteLength);o instanceof Uint8Array?yield o:yield*o,i instanceof Uint8Array?yield i:yield*i}return TM(r)?(async function*(){for await(const i of r)yield*s(i)})():(function*(){for(const i of r)yield*s(i)})()}gw.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??Wh,n=e?.maxDataLength??hw;return pw(r,n),new Ue(t(r.byteLength),r)};var L4;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(L4||(L4={}));async function x3(r,e,t){e=Array.isArray(e)?e:[e],t.log.trace("handle: available protocols %s",e);const n=tc(r,{...t,maxDataLength:Cg,maxLengthLength:2});for(;;){t.log.trace("handle: reading incoming string");const s=await Ca(n,t);if(t.log.trace('handle: read "%s"',s),s===Qn){t.log.trace('handle: respond with "%s" for "%s"',Qn,s),await Kc(n,Ge(`${Qn}
`),t),t.log.trace('handle: responded with "%s" for "%s"',Qn,s);continue}if(e.includes(s))return t.log.trace('handle: respond with "%s" for "%s"',s,s),await Kc(n,Ge(`${s}
`),t),t.log.trace('handle: responded with "%s" for "%s"',s,s),{stream:n.unwrap(),protocol:s};if(s==="ls"){const i=new Ue(...e.map(o=>gw.single(Ge(`${o}
`))),Ge(`
`));t.log.trace('handle: respond with "%s" for %s',e,s),await Kc(n,i,t),t.log.trace('handle: responded with "%s" for %s',e,s);continue}t.log.trace('handle: respond with "na" for "%s"',s),await Kc(n,Ge(`na
`),t),t.log('handle: responded with "na" for "%s"',s)}}const kM=500;let CM=class{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;limits;log;tags;maConn;muxer;components;outboundStreamProtocolNegotiationTimeout;inboundStreamProtocolNegotiationTimeout;constructor(e,t){this.components=e,this.id=t.id,this.remoteAddr=t.maConn.remoteAddr,this.remotePeer=t.remotePeer,this.direction=t.direction??"outbound",this.status="open",this.timeline=t.maConn.timeline,this.encryption=t.encryption,this.limits=t.limits,this.maConn=t.maConn,this.log=t.maConn.log,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??Ud,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??Ud,this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this.tags=[],t.muxerFactory!=null&&(this.multiplexer=t.muxerFactory.protocol,this.muxer=t.muxerFactory.createStreamMuxer({direction:this.direction,log:this.log,onIncomingStream:n=>{this.onIncomingStream(n)}}),Promise.all([this.muxer.sink(this.maConn.source),this.maConn.sink(this.muxer.source)]).catch(n=>{this.log.error("error piping data through muxer - %e",n)}))}[Symbol.toStringTag]="Connection";[Jk]=!0;get streams(){return this.muxer?.streams??[]}newStream=async(e,t={})=>{if(this.status==="closing")throw new nC("the connection is being closed");if(this.status==="closed")throw new Tb("the connection is closed");if(Array.isArray(e)||(e=[e]),this.limits!=null&&t?.runOnLimitedConnection!==!0)throw new h6("Cannot open protocol stream on limited connection");if(this.muxer==null)throw new _3("Connection is not multiplexed");this.log.trace("starting new stream for protocols %s",e);const n=await this.muxer.newStream();this.log.trace("started new stream %s for protocols %s",n.id,e);try{if(t.signal==null){n.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",e);const c=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);t={...t,signal:c}}n.log.trace("selecting protocol from protocols %s",e);const{stream:s,protocol:i}=await v3(n,e,{...t,log:n.log,yieldBytes:!0});n.log("selected protocol %s",i);const o=DM(i,this.components.registrar,t),a=O4(i,"outbound",this);if(a>=o){const c=new Rb(`Too many outbound protocol streams for protocol "${i}" - ${a}/${o}`);throw n.abort(c),c}return await this.components.peerStore.merge(this.remotePeer,{protocols:[i]}),n.source=s.source,n.sink=s.sink,n.protocol=i,s.closeWrite!=null&&(n.closeWrite=s.closeWrite),s.closeRead!=null&&(n.closeRead=s.closeRead),s.close!=null&&(n.close=s.close),this.components.metrics?.trackProtocolStream(n,this),n.direction="outbound",n}catch(s){throw this.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",this.direction==="inbound"?"from":"to",this.remoteAddr,e,s),n.timeline.close==null&&n.abort(s),s}};onIncomingStream(e){const t=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);Promise.resolve().then(async()=>{const n=this.components.registrar.getProtocols(),{stream:s,protocol:i}=await x3(e,n,{signal:t,log:e.log,yieldBytes:!1});this.log("incoming %s stream opened",i);const o=PM(i,this.components.registrar);if(O4(i,"inbound",this)===o){const h=new cC(`Too many inbound protocol streams for protocol "${i}" - limit ${o}`);throw e.abort(h),h}e.source=s.source,e.sink=s.sink,e.protocol=i,s.closeWrite!=null&&(e.closeWrite=s.closeWrite),s.closeRead!=null&&(e.closeRead=s.closeRead),s.close!=null&&(e.close=s.close),await this.components.peerStore.merge(this.remotePeer,{protocols:[i]},{signal:t}),this.components.metrics?.trackProtocolStream(e,this);const{handler:c,options:l}=this.components.registrar.getHandler(i);if(this.limits!=null&&l.runOnLimitedConnection!==!0)throw new h6("Cannot open protocol stream on limited connection");await c({connection:this,stream:e})}).catch(async n=>{this.log.error("error handling incoming stream id %s - %e",e.id,n),e.abort(n)})}async close(e={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",e.signal==null){const t=AbortSignal.timeout(kM);e={...e,signal:t}}try{this.log.trace("closing underlying transport"),await this.muxer?.close(e),await this.maConn.close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){this.status!=="closed"&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this.muxer?.abort(e),this.maConn.abort(e),this.status="closed",this.timeline.close=Date.now())}};function RM(r,e){return new CM(r,e)}function PM(r,e){try{const{options:t}=e.getHandler(r);return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return fw}function DM(r,e,t={}){try{const{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return t.maxOutboundStreams??dw}function O4(r,e,t){let n=0;return t.streams.forEach(s=>{s.direction===e&&s.protocol===r&&n++}),n}class qM{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;constructor(e,t){this.components=e,this.connectionEncrypters=os({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach(n=>{this.connectionEncrypters.set(n.protocol,n)}),this.streamMuxers=os({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach(n=>{this.streamMuxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??g$,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??Ud,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??Ud,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,...t){const n=this.components.connectionGater[e];if(n==null)return;if(await n.apply(this.components.connectionGater,t)===!0)throw new zO(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){return zn([AbortSignal.timeout(this.inboundUpgradeTimeout),e])}async upgradeInbound(e,t){let n=!1;const s=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),n=await wr(this.components.connectionManager.acceptIncomingConnection(e),s),!n)throw new WO("Connection denied");await wr(this.shouldBlockConnection("denyInboundConnection",e),s),await this._performUpgrade(e,"inbound",{...t,signal:s})}catch(i){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[i.name??"Error"]:!0}),i}finally{s.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});const n=e.remoteAddr.getPeerId();let s;n!=null&&(s=Vn(n),await wr(this.shouldBlockConnection("denyOutboundConnection",s,e),t.signal));let i="outbound";return t.initiator===!1&&(i="inbound"),await this._performUpgrade(e,i,t)}catch(n){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[n.name??"Error"]:!0}),n}}async _performUpgrade(e,t,n){let s,i,o,a,c;const l=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`;e.log=e.log.newScope(`${t}:${l}`),this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t);let h=e;if(n?.skipProtection!==!0){const p=this.components.connectionProtector;p!=null&&(e.log("protecting the %s connection",t),h=await p.protect(e,n))}try{if(s=h,n?.skipEncryption!==!0){n?.onProgress?.(new fn(`upgrader:encrypt-${t}-connection`)),{conn:s,remotePeer:i,protocol:c,streamMuxer:a}=await(t==="inbound"?this._encryptInbound(h,n):this._encryptOutbound(h,n));const p={...h,...s};await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",i,p)}else{const p=e.remoteAddr.getPeerId();if(p==null)throw new jp(`${t} connection that skipped encryption must have a peer id`);const m=Vn(p);c="native",i=m}if(i.equals(this.components.peerId)){const p=new Cb("Can not dial self");throw e.abort(p),p}if(o=s,n?.muxerFactory!=null)a=n.muxerFactory;else if(a==null&&this.streamMuxers.size>0){n?.onProgress?.(new fn(`upgrader:multiplex-${t}-connection`));const p=await(t==="inbound"?this._multiplexInbound({...h,...s},this.streamMuxers,n):this._multiplexOutbound({...h,...s},this.streamMuxers,n));a=p.muxerFactory,o=p.stream}}catch(p){throw e.log.error("failed to upgrade inbound connection %s %a - %e",t==="inbound"?"from":"to",e.remoteAddr,p),p}await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",i,e);const f=this._createConnection({id:l,cryptoProtocol:c,direction:t,maConn:e,upgradedConn:o,muxerFactory:a,remotePeer:i,limits:n?.limits});return f.log("successfully upgraded %s connection",t),f}_createConnection(e){const{id:t,cryptoProtocol:n,direction:s,maConn:i,upgradedConn:o,remotePeer:a,muxerFactory:c,limits:l}=e;let h;const f=i.timeline;return i.timeline=new Proxy(f,{set:(...p)=>(p[1]==="close"&&p[2]!=null&&f.close==null&&(async()=>{try{h.status==="open"&&await h.close()}catch(m){h.log.error("error closing connection after timeline close %e",m)}finally{this.events.safeDispatchEvent("connection:close",{detail:h})}})().catch(m=>{h.log.error("error thrown while dispatching connection:close event %e",m)}),Reflect.set(...p))}),i.timeline.upgraded=Date.now(),h=RM(this.components,{id:t,maConn:o,remotePeer:a,direction:s,muxerFactory:c,encryption:n,limits:l,outboundStreamProtocolNegotiationTimeout:this.outboundStreamProtocolNegotiationTimeout,inboundStreamProtocolNegotiationTimeout:this.inboundStreamProtocolNegotiationTimeout}),this.events.safeDispatchEvent("connection:open",{detail:h}),h}async _encryptInbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{const{stream:s,protocol:i}=await x3(e,n,{...t,log:e.log}),o=this.connectionEncrypters.get(i);if(o==null)throw new pf(`no crypto module found for ${i}`);return e.log("encrypting inbound connection to %a using %s",e.remoteAddr,i),{...await o.secureInbound(s,t),protocol:i}}catch(s){throw e.log.error("encrypting inbound connection from %a failed",e.remoteAddr,s),new pf(s.message)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",n);const{stream:s,protocol:i}=await v3(e,n,{...t,log:e.log,yieldBytes:!0}),o=this.connectionEncrypters.get(i);if(o==null)throw new pf(`no crypto module found for ${i}`);return e.log("encrypting outbound connection to %a using %s",e.remoteAddr,i),{...await o.secureOutbound(s,t),protocol:i}}catch(s){throw e.log.error("encrypting outbound connection to %a failed",e.remoteAddr,s),new pf(s.message)}}async _multiplexOutbound(e,t,n){const s=Array.from(t.keys());e.log("outbound selecting muxer %s",s);try{e.log.trace("selecting stream muxer from %s",s);const{stream:i,protocol:o}=await v3(e,s,{...n,log:e.log,yieldBytes:!0});e.log("selected %s as muxer protocol",o);const a=t.get(o);return{stream:i,muxerFactory:a}}catch(i){throw e.log.error("error multiplexing outbound connection",i),new _3(String(i))}}async _multiplexInbound(e,t,n){const s=Array.from(t.keys());e.log("inbound handling muxers %s",s);try{const{stream:i,protocol:o}=await x3(e,s,{...n,log:e.log}),a=t.get(o);return{stream:i,muxerFactory:a}}catch(i){throw e.log.error("error multiplexing inbound connection",i),new _3(String(i))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}const mw="2.10.0",yw="js-libp2p";function BM(r,e){return`${r??yw}/${e??mw} browser/${globalThis.navigator.userAgent}`}class LM extends Cn{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";const t=new Cn,n=t.dispatchEvent.bind(t);t.dispatchEvent=l=>{const h=n(l),f=this.dispatchEvent(new CustomEvent(l.type,{detail:l.detail}));return h||f},this.peerId=e.peerId,this.logger=e.logger??c7(),this.log=this.logger.forComponent("libp2p"),this.services={};const s=e.nodeInfo?.name??yw,i=e.nodeInfo?.version??mw,o=this.components=XO({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:s,version:i,userAgent:e.nodeInfo?.userAgent??BM(s,i)},logger:this.logger,events:t,datastore:e.datastore??new YL,connectionGater:i$(e.connectionGater),dns:e.dns});e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",KL(o,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),o.events.addEventListener("peer:update",l=>{if(l.detail.previous==null){const h={id:l.detail.peer.id,multiaddrs:l.detail.peer.addresses.map(f=>f.multiaddr)};o.events.safeDispatchEvent("peer:discovery",{detail:h})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(o)),this.components.upgrader=new qM(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((l,h)=>this.configureComponent(`connection-encryption-${h}`,l(this.components))),streamMuxers:(e.streamMuxers??[]).map((l,h)=>this.configureComponent(`stream-muxers-${h}`,l(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout}),this.configureComponent("transportManager",new bM(this.components,e.transportManager)),this.configureComponent("connectionManager",new G$(this.components,e.connectionManager)),e.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new lM(this.components,e.connectionMonitor)),this.configureComponent("registrar",new yM(this.components)),this.configureComponent("addressManager",new OO(this.components,e.addresses));const a=(e.peerRouters??[]).map((l,h)=>this.configureComponent(`peer-router-${h}`,l(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new gM(this.components,{routers:a}));const c=(e.contentRouters??[]).map((l,h)=>this.configureComponent(`content-router-${h}`,l(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new pM(this.components,{routers:c})),this.configureComponent("randomWalk",new mM(this.components)),(e.peerDiscovery??[]).forEach((l,h)=>{this.configureComponent(`peer-discovery-${h}`,l(this.components)).addEventListener("peer",p=>{this.#e(p)})}),e.transports?.forEach((l,h)=>{this.components.transportManager.add(this.configureComponent(`transport-${h}`,l(this.components)))}),e.services!=null)for(const l of Object.keys(e.services)){const h=e.services[l],f=h(this.components);if(f==null){this.log.error("service factory %s returned null or undefined instance",l);continue}this.services[l]=f,this.configureComponent(l,f),f[Y2]!=null&&(this.log("registering service %s for content routing",l),c.push(f[Y2])),f[Q2]!=null&&(this.log("registering service %s for peer routing",l),a.push(f[Q2])),f[pd]!=null&&(this.log("registering service %s for peer discovery",l),f[pd].addEventListener?.("peer",p=>{this.#e(p)}))}JO(o)}configureComponent(e,t){return t==null&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(e){throw this.log.error("An error occurred starting libp2p",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new rs;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,n={}){if(t==null)throw new ot("no protocols were provided to open a stream");if(t=Array.isArray(t)?t:[t],t.length===0)throw new ot("no protocols were provided to open a stream");return(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){Rh(e)&&(e=Vn(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{const o=await this.peerStore.get(e,t);if(o.id.publicKey!=null)return o.id.publicKey}catch(o){if(o.name!=="NotFoundError")throw o}const n=is([Ge("/pk/"),e.toMultihash().bytes]),s=await this.contentRouting.get(n,t),i=uT(s);return await this.peerStore.patch(e,{publicKey:i},t),i}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async s=>{await this.components.registrar.handle(s,t,n)}))}async unhandle(e,t){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async n=>{await this.components.registrar.unhandle(n,t)}))}async register(e,t,n){return this.components.registrar.register(e,t,n)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#e(e){const{detail:t}=e;if(t.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(n=>{this.log.error(n)})}}async function $4(r={}){r.privateKey??=await lT();const e=new LM({...await VR(r),peerId:dC(r.privateKey)});return r.start!==!1&&await e.start(),e}var mf={exports:{}},M4;function OM(){if(M4)return mf.exports;M4=1;var r=typeof Reflect=="object"?Reflect:null,e=r&&typeof r.apply=="function"?r.apply:function(L,z,Y){return Function.prototype.apply.call(L,z,Y)},t;r&&typeof r.ownKeys=="function"?t=r.ownKeys:Object.getOwnPropertySymbols?t=function(L){return Object.getOwnPropertyNames(L).concat(Object.getOwnPropertySymbols(L))}:t=function(L){return Object.getOwnPropertyNames(L)};function n(q){console&&console.warn&&console.warn(q)}var s=Number.isNaN||function(L){return L!==L};function i(){i.init.call(this)}mf.exports=i,mf.exports.once=A,i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var o=10;function a(q){if(typeof q!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof q)}Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(q){if(typeof q!="number"||q<0||s(q))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+q+".");o=q}}),i.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(L){if(typeof L!="number"||L<0||s(L))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+L+".");return this._maxListeners=L,this};function c(q){return q._maxListeners===void 0?i.defaultMaxListeners:q._maxListeners}i.prototype.getMaxListeners=function(){return c(this)},i.prototype.emit=function(L){for(var z=[],Y=1;Y<arguments.length;Y++)z.push(arguments[Y]);var k=L==="error",x=this._events;if(x!==void 0)k=k&&x.error===void 0;else if(!k)return!1;if(k){var F;if(z.length>0&&(F=z[0]),F instanceof Error)throw F;var j=new Error("Unhandled error."+(F?" ("+F.message+")":""));throw j.context=F,j}var U=x[L];if(U===void 0)return!1;if(typeof U=="function")e(U,this,z);else for(var y=U.length,b=_(U,y),Y=0;Y<y;++Y)e(b[Y],this,z);return!0};function l(q,L,z,Y){var k,x,F;if(a(z),x=q._events,x===void 0?(x=q._events=Object.create(null),q._eventsCount=0):(x.newListener!==void 0&&(q.emit("newListener",L,z.listener?z.listener:z),x=q._events),F=x[L]),F===void 0)F=x[L]=z,++q._eventsCount;else if(typeof F=="function"?F=x[L]=Y?[z,F]:[F,z]:Y?F.unshift(z):F.push(z),k=c(q),k>0&&F.length>k&&!F.warned){F.warned=!0;var j=new Error("Possible EventEmitter memory leak detected. "+F.length+" "+String(L)+" listeners added. Use emitter.setMaxListeners() to increase limit");j.name="MaxListenersExceededWarning",j.emitter=q,j.type=L,j.count=F.length,n(j)}return q}i.prototype.addListener=function(L,z){return l(this,L,z,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(L,z){return l(this,L,z,!0)};function h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function f(q,L,z){var Y={fired:!1,wrapFn:void 0,target:q,type:L,listener:z},k=h.bind(Y);return k.listener=z,Y.wrapFn=k,k}i.prototype.once=function(L,z){return a(z),this.on(L,f(this,L,z)),this},i.prototype.prependOnceListener=function(L,z){return a(z),this.prependListener(L,f(this,L,z)),this},i.prototype.removeListener=function(L,z){var Y,k,x,F,j;if(a(z),k=this._events,k===void 0)return this;if(Y=k[L],Y===void 0)return this;if(Y===z||Y.listener===z)--this._eventsCount===0?this._events=Object.create(null):(delete k[L],k.removeListener&&this.emit("removeListener",L,Y.listener||z));else if(typeof Y!="function"){for(x=-1,F=Y.length-1;F>=0;F--)if(Y[F]===z||Y[F].listener===z){j=Y[F].listener,x=F;break}if(x<0)return this;x===0?Y.shift():R(Y,x),Y.length===1&&(k[L]=Y[0]),k.removeListener!==void 0&&this.emit("removeListener",L,j||z)}return this},i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=function(L){var z,Y,k;if(Y=this._events,Y===void 0)return this;if(Y.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):Y[L]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete Y[L]),this;if(arguments.length===0){var x=Object.keys(Y),F;for(k=0;k<x.length;++k)F=x[k],F!=="removeListener"&&this.removeAllListeners(F);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(z=Y[L],typeof z=="function")this.removeListener(L,z);else if(z!==void 0)for(k=z.length-1;k>=0;k--)this.removeListener(L,z[k]);return this};function p(q,L,z){var Y=q._events;if(Y===void 0)return[];var k=Y[L];return k===void 0?[]:typeof k=="function"?z?[k.listener||k]:[k]:z?T(k):_(k,k.length)}i.prototype.listeners=function(L){return p(this,L,!0)},i.prototype.rawListeners=function(L){return p(this,L,!1)},i.listenerCount=function(q,L){return typeof q.listenerCount=="function"?q.listenerCount(L):m.call(q,L)},i.prototype.listenerCount=m;function m(q){var L=this._events;if(L!==void 0){var z=L[q];if(typeof z=="function")return 1;if(z!==void 0)return z.length}return 0}i.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function _(q,L){for(var z=new Array(L),Y=0;Y<L;++Y)z[Y]=q[Y];return z}function R(q,L){for(;L+1<q.length;L++)q[L]=q[L+1];q.pop()}function T(q){for(var L=new Array(q.length),z=0;z<L.length;++z)L[z]=q[z].listener||q[z];return L}function A(q,L){return new Promise(function(z,Y){function k(F){q.removeListener(L,x),Y(F)}function x(){typeof q.removeListener=="function"&&q.removeListener("error",k),z([].slice.call(arguments))}I(q,L,x,{once:!0}),L!=="error"&&D(q,k,{once:!0})})}function D(q,L,z){typeof q.on=="function"&&I(q,"error",L,z)}function I(q,L,z,Y){if(typeof q.on=="function")Y.once?q.once(L,z):q.on(L,z);else if(typeof q.addEventListener=="function")q.addEventListener(L,function k(x){Y.once&&q.removeEventListener(L,k),z(x)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof q)}return mf.exports}var bw=OM();function $M(r){return r[Symbol.asyncIterator]!=null}function to(r,e){let t=0;if($M(r))return(async function*(){for await(const c of r)yield e(c,t++)})();const n=vg(r),{value:s,done:i}=n.next();if(i===!0)return(function*(){})();const o=e(s,t++);if(typeof o.then=="function")return(async function*(){yield await o;for(const c of n)yield e(c,t++)})();const a=e;return(function*(){yield o;for(const c of n)yield a(c,t++)})()}function Ar(r,...e){if(r==null)throw new Error("Empty pipeline");if(L0(r)){const n=r;r=()=>n.source}else if(_w(r)||ww(r)){const n=r;r=()=>n}const t=[r,...e];if(t.length>1&&L0(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)L0(t[n])&&(t[n]=NM(t[n]));return MM(...t)}const MM=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},ww=r=>r?.[Symbol.asyncIterator]!=null,_w=r=>r?.[Symbol.iterator]!=null,L0=r=>r==null?!1:r.sink!=null&&r.source!=null,NM=r=>e=>{const t=r.sink(e);if(t?.then!=null){const n=Or({objectMode:!0});t.then(()=>{n.end()},o=>{n.end(o)});let s;const i=r.source;if(ww(i))s=async function*(){yield*i,n.end()};else if(_w(i))s=function*(){yield*i,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Ol(n,s())}return r.source};function Ew(r){return r[Symbol.asyncIterator]!=null}const Gh=r=>{const e=hr(r),t=Tr(e);return Ri(r,t),Gh.bytes=e,t};Gh.bytes=0;function Eu(r,e){e=e??{};const t=e.lengthEncoder??Gh;function*n(s){const i=t(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}return Ew(r)?(async function*(){for await(const s of r)yield*n(s)})():(function*(){for(const s of r)yield*n(s)})()}Eu.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??Gh;return new Ue(t(r.byteLength),r)};let UM=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},FM=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},HM=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},N4=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};const VM=8,KM=1024*1024*4;var Fi;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(Fi||(Fi={}));const Rg=r=>{const e=mc(r);return Rg.bytes=hr(e),e};Rg.bytes=0;function $l(r,e){const t=new Ue;let n=Fi.LENGTH,s=-1;const i=e?.lengthDecoder??Rg,o=e?.maxLengthLength??VM,a=e?.maxDataLength??KM;function*c(){for(;t.byteLength>0;){if(n===Fi.LENGTH)try{if(s=i(t),s<0)throw new UM("Invalid message length");if(s>a)throw new FM("Message length too long");const l=i.bytes;t.consume(l),e?.onLength!=null&&e.onLength(s),n=Fi.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>o)throw new HM("Message length length too long");break}throw l}if(n===Fi.DATA){if(t.byteLength<s)break;const l=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(l),yield l,n=Fi.LENGTH}}}return Ew(r)?(async function*(){for await(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new N4("Unexpected end of input")})():(function*(){for(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new N4("Unexpected end of input")})()}$l.fromReader=(r,e)=>{let t=1;const n=(async function*(){for(;;)try{const{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}})();return $l(n,{...e??{},onLength:i=>{t=i}})};function yf(r){const e=r.split("/");let t=-1;for(let s=e.length-1;s>=0;s--)if(e[s]==="p2p"){t=s;break}if(t===-1)throw new Error("Error when parsing peerId from multiaddr.");const n=e[t+1];if(!n)throw new Error(`Error when parsing peerId from multiaddr: ${r}`);return n}function U4(r,e){const t=`${r}/p2p-circuit/p2p/${e}`;return lt(t)}let zM=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};function WM(r=32){const e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}function GM(r){if(isNaN(r)||r<=0)throw new zM("random bytes length must be a Number bigger than 0");return WM(r)}const O0=32,ZM="1.0.0",jM="ping",YM="ipfs",QM=1e4,XM=2,JM=1;class eN{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;constructor(e,t={}){this.components=e,this.started=!1,this.protocol=`/${t.protocolPrefix??YM}/${jM}/${ZM}`,this.timeout=t.timeout??QM,this.maxInboundStreams=t.maxInboundStreams??XM,this.maxOutboundStreams=t.maxOutboundStreams??JM,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handleMessage=this.handleMessage.bind(this)}[Symbol.toStringTag]="@libp2p/ping";[pr]=["@libp2p/ping"];async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){const t=e.connection.log.newScope("ping");t.trace("ping from %p",e.connection.remotePeer);const{stream:n}=e,s=Date.now(),i=Fd(n);let o=!1;Promise.resolve().then(async()=>{for(;;){const a=AbortSignal.timeout(this.timeout);a.addEventListener("abort",()=>{n?.abort(new Qp("ping timeout"))});const c=await i.read({bytes:O0,signal:a});await i.write(c,{signal:a}),o=!0}}).catch(a=>{o&&a.name==="UnexpectedEOFError"&&n.readStatus!=="ready"||(t.error("ping from %p failed with error - %e",e.connection.remotePeer,a),n?.abort(a))}).finally(()=>{const a=Date.now()-s;t("ping from %p complete in %dms",e.connection.remotePeer,a);const c=AbortSignal.timeout(this.timeout);n.close({signal:c}).catch(l=>{t.error("error closing ping stream from %p - %e",e.connection.remotePeer,l),n?.abort(l)})})}async ping(e,t={}){const n=Date.now(),s=GM(O0),i=await this.components.connectionManager.openConnection(e,t),o=i.log.newScope("ping");let a;if(t.signal==null){const c=AbortSignal.timeout(this.timeout);t={...t,signal:c}}try{a=await i.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const c=Fd(a),[,l]=await Promise.all([c.write(s,t),c.read({...t,bytes:O0})]),h=Date.now()-n;if(!at(s,l.subarray()))throw new aC(`Received wrong ping ack after ${h}ms`);return o("ping %p complete in %dms",i.remotePeer,h),h}catch(c){throw o.error("error while pinging %p",i.remotePeer,c),a?.abort(c),c}finally{a!=null&&await a.close(t)}}}function tN(r={}){return e=>new eN(e,r)}const nN=[Bs,lu,fu,uu,bc];function F4(r){return vw("sni",r)?.value}function H4(r){const e=vw("tcp",r)?.value;return e==null?"":`:${e}`}function vw(r,e){return e.find(t=>t.name===r)}function V4(r){return r.some(({code:e})=>e===Sa)}function Cr(r,e){const t=xw[r.name];if(t==null)throw new Error(`Can't interpret protocol ${r.name}`);const n=t(r,e);return r.code===Sr?`[${n}]`:n}const xw={ip4:(r,e)=>r.value,ip6:(r,e)=>e.length===0?r.value:`[${r.value}]`,tcp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${Cr(t,e)}:${r.value}`},udp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${Cr(t,e)}:${r.value}`},dnsaddr:(r,e)=>r.value,dns4:(r,e)=>r.value,dns6:(r,e)=>r.value,dns:(r,e)=>r.value,ipfs:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${Cr(t,e)}`},p2p:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${Cr(t,e)}`},http:(r,e)=>{const t=V4(e),n=F4(e),s=H4(e);if(t&&n!=null)return`https://${n}${s}`;const i=t?"https://":"http://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=Cr(o,e);return a=a?.replace("tcp://",""),`${i}${a}`},"http-path":(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");const n=Cr(t,e),s=decodeURIComponent(r.value??"");return`${n}${s}`},tls:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return Cr(t,e)},sni:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return Cr(t,e)},https:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=Cr(t,e);return n=n?.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{const t=V4(e),n=F4(e),s=H4(e);if(t&&n!=null)return`wss://${n}${s}`;const i=t?"wss://":"ws://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=Cr(o,e);return a=a?.replace("tcp://",""),`${i}${a}`},wss:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=Cr(t,e);return n=n?.replace("tcp://",""),`wss://${n}`}};function rN(r,e){const n=lt(r).getComponents(),s=n.pop();if(s==null)throw new Error("Unexpected end of multiaddr");const i=xw[s.name];if(i==null)throw new Error(`No interpreter found for ${s.name}`);let o=i(s,n)??"";return nN.includes(s.code)&&(o=o.replace(/^.*:\/\//,""),s.value==="443"?o=`https://${o}`:o=`http://${o}`),(o.startsWith("http://")||o.startsWith("https://")||o.startsWith("ws://")||o.startsWith("wss://"))&&(o=new URL(o).toString(),o.endsWith("/")&&(o=o.substring(0,o.length-1))),o}var sN=async r=>{if(r.readyState>=2)throw new Error("socket closed");r.readyState!==1&&await new Promise((e,t)=>{function n(){r.removeEventListener("open",s),r.removeEventListener("error",i)}function s(){n(),e()}function i(o){n(),t(o.error??new Error(`connect ECONNREFUSED ${r.url}`))}r.addEventListener("open",s),r.addEventListener("error",i)})},iN=(r,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async n=>{for await(const s of n){try{await sN(r)}catch(i){if(i.message==="socket closed")break;throw i}if(r.readyState===r.CLOSING||r.readyState===r.CLOSED)break;r.send(s)}e.closeOnEnd!=null&&r.readyState<=1&&await new Promise((s,i)=>{r.addEventListener("close",o=>{if(o.wasClean||o.code===1006)s();else{const a=Object.assign(new Error("ws error"),{event:o});i(a)}}),setTimeout(()=>{r.close()})})}),sa={},Lc={},K4;function oN(){if(K4)return Lc;K4=1,Object.defineProperty(Lc,"__esModule",{value:!0});class r{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(n){if(this.isStopped)return;const s={value:n,done:!1};if(this.pullQueue.length){const i=this.pullQueue.shift();i&&i.resolve(s)}else this.pushQueue.push(Promise.resolve(s)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const n of this.pullQueue)n.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(n){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const s of this.pullQueue)s.reject(n);this.pullQueue.length=0}else{const s=Promise.reject(n);s.catch(()=>{}),this.pushQueue.push(s)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:n=>{const s=this.pushQueue.shift();return s?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),s):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((i,o)=>{this.pullQueue.push({resolve:i,reject:o})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}class e{constructor(n,{highWaterMark:s=100,lowWaterMark:i=1}={}){const o=new r;o.highWaterMark=s,o.lowWaterMark=i,o.removeCallback=n({push:a=>o.push(a),stop:()=>o.stop(),fail:a=>o.fail(a),on:(a,c)=>{o.eventHandlers[a]=c}})||(()=>{}),this[Symbol.asyncIterator]=()=>o[Symbol.asyncIterator](),Object.freeze(this)}}return Lc.EventIterator=e,Lc.default=e,Lc}var z4;function aN(){if(z4)return sa;z4=1,Object.defineProperty(sa,"__esModule",{value:!0});const r=oN();sa.EventIterator=r.EventIterator;function e(t,n,s){return new r.EventIterator(({push:i})=>(this.addEventListener(t,i,n),()=>this.removeEventListener(t,i,n)),s)}return sa.subscribe=e,sa.default=r.EventIterator,sa}var cN=aN();function W4(r){return r instanceof ArrayBuffer||r?.constructor?.name==="ArrayBuffer"&&typeof r?.byteLength=="number"}var lN=r=>{r.binaryType="arraybuffer";const e=async()=>{await new Promise((i,o)=>{if(n){i();return}if(s!=null){o(s);return}const a=h=>{r.removeEventListener("open",c),r.removeEventListener("error",l),h()},c=()=>{a(i)},l=h=>{a(()=>{o(h.error??new Error(`connect ECONNREFUSED ${r.url}`))})};r.addEventListener("open",c),r.addEventListener("error",l)})},t=(async function*(){const i=new cN.EventIterator(({push:o,stop:a,fail:c})=>{const l=f=>{let p=null;typeof f.data=="string"&&(p=Ge(f.data)),W4(f.data)&&(p=new Uint8Array(f.data)),f.data instanceof Uint8Array&&(p=f.data),p!=null&&o(p)},h=f=>{c(f.error??new Error("Socket error"))};return r.addEventListener("message",l),r.addEventListener("error",h),r.addEventListener("close",a),()=>{r.removeEventListener("message",l),r.removeEventListener("error",h),r.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(const o of i)yield W4(o)?new Uint8Array(o):o})();let n=r.readyState===1,s;return r.addEventListener("open",()=>{n=!0,s=null}),r.addEventListener("close",()=>{n=!1,s=null}),r.addEventListener("error",i=>{n||(s=i.error??new Error(`connect ECONNREFUSED ${r.url}`))}),Object.assign(t,{connected:e})},uN=(r,e)=>{e=e??{};const t=lN(r);let n=e.remoteAddress,s=e.remotePort;if(r.url!=null)try{const o=new URL(r.url);n=o.hostname,s=parseInt(o.port,10)}catch{}if(n==null||s==null)throw new Error("Remote connection did not have address and/or port");return{sink:iN(r,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(r.readyState===r.CONNECTING||r.readyState===r.OPEN)&&await new Promise(o=>{r.addEventListener("close",()=>{o()}),r.close()})},destroy:()=>{r.terminate!=null?r.terminate():r.close()},remoteAddress:n,remotePort:s,socket:r}},fN=WebSocket;const dN={"http:":"ws:","https:":"wss:"},G4="ws:";var hN=(r,e)=>{if(r.startsWith("//")&&(r=`${e?.protocol??G4}${r}`),r.startsWith("/")&&e!=null){const n=e.protocol??G4,s=e.host,i=e.port!=null&&s?.endsWith(`:${e.port}`)!==!0?`:${e.port}`:"";r=`${n}//${s}${i}${r}`}const t=new URL(r);for(const[n,s]of Object.entries(dN))t.protocol===n&&(t.protocol=s);return t};function pN(r,e){const t=typeof window>"u"?void 0:window.location;e=e??{};const n=hN(r,t),s=new fN(n.toString(),e.websocket);return uN(s,e)}function gN(r){return r.filter(e=>Md.exactMatch(e)||Bl.exactMatch(e))}function mN(){throw new Error("WebSocket Servers can not be created in the browser!")}const yN=500;function bN(r,e,t){const n=t.metrics,s=t.metricPrefix??"",i={log:t.logger.forComponent("libp2p:websockets:connection"),async sink(c){try{await r.sink((async function*(){for await(const l of c)l instanceof Uint8Array?yield l:yield l.subarray()})())}catch(l){l.type!=="aborted"&&i.log.error(l)}},source:r.source,remoteAddr:e,timeline:{open:Date.now()},async close(c={}){const l=Date.now();if(c.signal==null){const f=AbortSignal.timeout(yN);c={...c,signal:f}}const h=()=>{const{host:f,port:p}=i.remoteAddr.toOptions();i.log("timeout closing stream to %s:%s after %dms, destroying it manually",f,p,Date.now()-l),this.abort(new Di("Socket close timeout"))};c.signal?.addEventListener("abort",h);try{await r.close()}catch(f){i.log.error("error closing WebSocket gracefully - %e",f),this.abort(f)}finally{c.signal?.removeEventListener("abort",h),i.timeline.close=Date.now()}},abort(c){i.log.error("destroying WebSocket after error - %e",c),r.destroy(),i.timeline.close=Date.now(),n?.increment({[`${s}error`]:!0})}};let o=!1;const a=r.socket.close.bind(r.socket);return r.socket.close=(...c)=>(o=!0,a(...c)),r.socket.addEventListener("close",c=>{if(i.log('closed %s, code %d, reason "%s", wasClean %s',o?"locally":"by remote",c.code,c.reason,c.wasClean),!c.wasClean){i.abort(new kb(`${o?"Local":"Remote"} did not close WebSocket cleanly`));return}n?.increment({[`${s}close`]:!0}),i.timeline.close=Date.now()},{once:!0}),i}let wN=class{log;init;logger;metrics;components;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[Zp]=!0;[Symbol.toStringTag]="@libp2p/websockets";[pr]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};const n=await this._connect(e,t),s=bN(n,e,{logger:this.logger,metrics:this.metrics?.dialerEvents});this.log("new outbound connection %s",s.remoteAddr);const i=await t.upgrader.upgradeOutbound(s,t);return this.log("outbound connection %s upgraded",s.remoteAddr),i}async _connect(e,t){t?.signal?.throwIfAborted();const n=e.toOptions();this.log("dialing %s:%s",n.host,n.port);const s=en(),i=pN(rN(e),this.init);i.socket.addEventListener("error",()=>{const o=new kb(`Could not connect to ${e.toString()}`);this.log.error("connection error:",o),this.metrics?.dialerEvents.increment({error:!0}),s.reject(o)});try{t.onProgress?.(new fn("websockets:open-connection")),await wr(Promise.race([i.connected(),s.promise]),t.signal)}catch(o){throw t.signal?.aborted&&this.metrics?.dialerEvents.increment({abort:!0}),i.close().catch(a=>{this.log.error("error closing raw socket",a)}),o}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),i}createListener(e){return mN({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){return e=Array.isArray(e)?e:[e],this.init?.filter!=null?this.init?.filter(e):gN(e)}dialFilter(e){return this.listenFilter(e)}};function Sw(r={}){return e=>new wN(e,r)}function Aw(r){try{for(const{code:e,value:t}of r.getComponents())if(t!=null&&e===Sr)return OR("2000::/3",t)}catch{}return!1}function _N(r,e,t){let n,s,i=!1;function o(){const l={signal:s.signal};if(t?.timeout!=null){const h=zn([s.signal,AbortSignal.timeout(t.timeout)]);l.signal=h}i=!0,Promise.resolve().then(async()=>{await r(l)}).catch(()=>{}).finally(()=>{i=!1,!s.signal.aborted&&(n=setTimeout(o,e))})}const a=Od(o,t?.debounce??100);let c=!1;return{setInterval:l=>{e!==l&&(e=l,n!=null&&(clearTimeout(n),n=setTimeout(o,e)))},setTimeout:l=>{t??={},t.timeout=l},run:()=>{i||(clearTimeout(n),a())},start:()=>{c||(c=!0,s=new AbortController,s.signal,t?.runImmediately===!0?queueMicrotask(()=>{o()}):n=setTimeout(o,e))},stop:()=>{clearTimeout(n),s?.abort(),c=!1}}}function gr(r,e){const t=tc(r,e),n={read:async(s,i)=>{const o=await t.read(i);return s.decode(o)},write:async(s,i,o)=>{await t.write(i.encode(s),o)},writeV:async(s,i,o)=>{await t.writeV(s.map(a=>i.encode(a)),o)},pb:s=>({read:async i=>n.read(s,i),write:async(i,o)=>n.write(i,s,o),writeV:async(i,o)=>n.writeV(i,s,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}const EN="libp2p",vN="autonat",xN="1.0.0",SN=3e4,AN=2,IN=20,TN=80,kN=8192;var Ut;(function(r){(function(s){s.DIAL="DIAL",s.DIAL_RESPONSE="DIAL_RESPONSE"})(r.MessageType||(r.MessageType={}));let e;(function(s){s[s.DIAL=0]="DIAL",s[s.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(e||(e={})),(function(s){s.codec=()=>Rn(e)})(r.MessageType||(r.MessageType={})),(function(s){s.OK="OK",s.E_DIAL_ERROR="E_DIAL_ERROR",s.E_DIAL_REFUSED="E_DIAL_REFUSED",s.E_BAD_REQUEST="E_BAD_REQUEST",s.E_INTERNAL_ERROR="E_INTERNAL_ERROR"})(r.ResponseStatus||(r.ResponseStatus={}));let t;(function(s){s[s.OK=0]="OK",s[s.E_DIAL_ERROR=100]="E_DIAL_ERROR",s[s.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",s[s.E_BAD_REQUEST=200]="E_BAD_REQUEST",s[s.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(t||(t={})),(function(s){s.codec=()=>Rn(t)})(r.ResponseStatus||(r.ResponseStatus={})),(function(s){let i;s.codec=()=>(i==null&&(i=tt((o,a,c={})=>{if(c.lengthDelimited!==!1&&a.fork(),o.id!=null&&(a.uint32(10),a.bytes(o.id)),o.addrs!=null)for(const l of o.addrs)a.uint32(18),a.bytes(l);c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const l={addrs:[]},h=a==null?o.len:o.pos+a;for(;o.pos<h;){const f=o.uint32();switch(f>>>3){case 1:{l.id=o.bytes();break}case 2:{if(c.limits?.addrs!=null&&l.addrs.length===c.limits.addrs)throw new Mt('Decode error - map field "addrs" had too many elements');l.addrs.push(o.bytes());break}default:{o.skipType(f&7);break}}}return l})),i),s.encode=o=>et(o,s.codec()),s.decode=(o,a)=>Je(o,s.codec(),a)})(r.PeerInfo||(r.PeerInfo={})),(function(s){let i;s.codec=()=>(i==null&&(i=tt((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.peer!=null&&(a.uint32(10),r.PeerInfo.codec().encode(o.peer,a)),c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const l={},h=a==null?o.len:o.pos+a;for(;o.pos<h;){const f=o.uint32();f>>>3===1?l.peer=r.PeerInfo.codec().decode(o,o.uint32(),{limits:c.limits?.peer}):o.skipType(f&7)}return l})),i),s.encode=o=>et(o,s.codec()),s.decode=(o,a)=>Je(o,s.codec(),a)})(r.Dial||(r.Dial={})),(function(s){let i;s.codec=()=>(i==null&&(i=tt((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.status!=null&&(a.uint32(8),r.ResponseStatus.codec().encode(o.status,a)),o.statusText!=null&&(a.uint32(18),a.string(o.statusText)),o.addr!=null&&(a.uint32(26),a.bytes(o.addr)),c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const l={},h=a==null?o.len:o.pos+a;for(;o.pos<h;){const f=o.uint32();switch(f>>>3){case 1:{l.status=r.ResponseStatus.codec().decode(o);break}case 2:{l.statusText=o.string();break}case 3:{l.addr=o.bytes();break}default:{o.skipType(f&7);break}}}return l})),i),s.encode=o=>et(o,s.codec()),s.decode=(o,a)=>Je(o,s.codec(),a)})(r.DialResponse||(r.DialResponse={}));let n;r.codec=()=>(n==null&&(n=tt((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.type!=null&&(i.uint32(8),r.MessageType.codec().encode(s.type,i)),s.dial!=null&&(i.uint32(18),r.Dial.codec().encode(s.dial,i)),s.dialResponse!=null&&(i.uint32(26),r.DialResponse.codec().encode(s.dialResponse,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.type=r.MessageType.codec().decode(s);break}case 2:{a.dial=r.Dial.codec().decode(s,s.uint32(),{limits:o.limits?.dial});break}case 3:{a.dialResponse=r.DialResponse.codec().decode(s,s.uint32(),{limits:o.limits?.dialResponse});break}default:{s.skipType(l&7);break}}}return a})),n),r.encode=s=>et(s,r.codec()),r.decode=(s,i)=>Je(s,r.codec(),i)})(Ut||(Ut={}));const CN=4,RN=8;class PN{components;protocol;timeout;maxInboundStreams;maxOutboundStreams;maxMessageSize;started;log;topologyId;dialResults;findPeers;addressFilter;connectionThreshold;constructor(e,t){this.components=e,this.log=e.logger.forComponent("libp2p:auto-nat"),this.started=!1,this.protocol=`/${t.protocolPrefix??EN}/${vN}/${xN}`,this.timeout=t.timeout??SN,this.maxInboundStreams=t.maxInboundStreams??AN,this.maxOutboundStreams=t.maxOutboundStreams??IN,this.connectionThreshold=t.connectionThreshold??TN,this.maxMessageSize=t.maxMessageSize??kN,this.dialResults=os({name:"libp2p_autonat_dial_results",metrics:e.metrics}),this.findPeers=_N(this.findRandomPeers.bind(this),6e4),this.addressFilter=xo(1024)}[Symbol.toStringTag]="@libp2p/autonat";[pr]=["@libp2p/autonat"];get[_o](){return["@libp2p/identify"]}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,e=>{this.handleIncomingAutonatStream(e).catch(t=>{this.log.error("error handling incoming autonat stream - %e",t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.topologyId=await this.components.registrar.register(this.protocol,{onConnect:(e,t)=>{this.verifyExternalAddresses(t).catch(n=>{this.log.error("could not verify addresses - %e",n)})}}),this.findPeers.start(),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.topologyId!=null&&await this.components.registrar.unhandle(this.topologyId),this.dialResults.clear(),this.findPeers.stop(),this.started=!1}allAddressesAreVerified(){return this.components.addressManager.getAddressesWithMetadata().every(e=>e.expires>Date.now()?!0:e.verified)}async findRandomPeers(e){if(this.allAddressesAreVerified())return;const t=zn([AbortSignal.timeout(1e4),e?.signal]);try{this.log("starting random walk to find peers to run AutoNAT");for await(const n of this.components.randomWalk.walk({signal:t})){if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable %s",n.id,n.multiaddrs.map(s=>s.toString()).join(", "));continue}try{this.log.trace("dial random peer %p",n.id),await this.components.connectionManager.openConnection(n.multiaddrs,{signal:t})}catch{}if(this.allAddressesAreVerified()){this.log("stopping random walk, all addresses are verified");return}if(!this.hasConnectionCapacity()){this.log("stopping random walk, too close to max connections");return}}}catch{}}async handleIncomingAutonatStream(e){const t=AbortSignal.timeout(this.timeout),n=gr(e.stream,{maxDataLength:this.maxMessageSize}).pb(Ut);try{const s=await n.read({signal:t}),i=await this.handleAutonatMessage(s,e.connection,{signal:t});await n.write(i,{signal:t}),await n.unwrap().unwrap().close({signal:t})}catch(s){this.log.error("error handling incoming autonat stream - %e",s),e.stream.abort(s)}}async handleAutonatMessage(e,t,n){const s=this.components.addressManager.getAddresses().map(f=>f.toOptions().host),i=e.dial;if(i==null)return this.log.error("dial was missing from message"),{type:Ut.MessageType.DIAL_RESPONSE,dialResponse:{status:Ut.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let o;const a=i.peer;if(a?.id==null)return this.log.error("PeerId missing from message"),{type:Ut.MessageType.DIAL_RESPONSE,dialResponse:{status:Ut.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{const f=Gn(a.id);o=mr(f)}catch(f){return this.log.error("invalid PeerId - %e",f),{type:Ut.MessageType.DIAL_RESPONSE,dialResponse:{status:Ut.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",o),!t.remotePeer.equals(o))return this.log("target peer %p did not equal sending peer %p",o,t.remotePeer),{type:Ut.MessageType.DIAL_RESPONSE,dialResponse:{status:Ut.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};const c=a.addrs.map(f=>lt(f)).filter(f=>{try{const p=f.toOptions();return Co(f)?!1:p.host!==t.remoteAddr.toOptions().host?(this.log.trace("not dialing %a - target host did not match remote host %a",f,t.remoteAddr),!1):s.includes(p.host)?!1:this.components.transportManager.dialTransportForMultiaddr(f)==null?(this.log.trace("not dialing %a - transport unsupported",f),!1):!0}catch{return!1}}).map(f=>(f.getPeerId()==null&&(f=f.encapsulate(`/p2p/${o.toString()}`)),f));if(c.length===0)return this.log("refused to dial all multiaddrs for %p from message",o),{type:Ut.MessageType.DIAL_RESPONSE,dialResponse:{status:Ut.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",c.map(f=>f.toString()).join(", "),o);let l="",h=c[0];for(const f of c){let p;h=f;try{if(p=await this.components.connectionManager.openConnection(f,n),!p.remoteAddr.equals(f))throw this.log.error("tried to dial %a but dialed %a",f,p.remoteAddr),new Error("Unexpected remote address");return this.log("successfully dialed %p via %a",o,f),{type:Ut.MessageType.DIAL_RESPONSE,dialResponse:{status:Ut.ResponseStatus.OK,addr:p.remoteAddr.decapsulateCode(du("p2p").code).bytes}}}catch(m){this.log.error("could not dial %p - %e",o,m),l=m.message}finally{p!=null&&await p.close()}}return{type:Ut.MessageType.DIAL_RESPONSE,dialResponse:{status:Ut.ResponseStatus.E_DIAL_ERROR,statusText:l,addr:h.bytes}}}getFirstUnverifiedMultiaddr(e,t){const n=this.components.addressManager.getAddressesWithMetadata().sort((s,i)=>s.type==="observed"&&i.type!=="observed"?1:i.type==="observed"&&s.type!=="observed"?-1:0).filter(s=>!(!(s.expires<Date.now())||s.multiaddr.toOptions().family===6&&(!t||!Aw(s.multiaddr))||Co(s.multiaddr)));for(const s of n){const i=s.multiaddr.toString();let o=this.dialResults.get(i);if(o!=null){if(o.networkSegments.includes(e)){this.log.trace("%a already has a network segment result from %s",o.multiaddr,e);continue}if(o.queue.size>10){this.log.trace("%a already has enough peers queued",o.multiaddr);continue}}if(o==null){const a=s.expires<Date.now();if(a&&this.addressFilter.remove?.(i),this.addressFilter.has(i))continue;this.addressFilter.add(i),this.log.trace("creating dial result %s %s",a?"to revalidate":"for",i),o={multiaddr:s.multiaddr,success:0,failure:0,networkSegments:[],verifyingPeers:oP(),queue:new ec({concurrency:3,maxSize:50}),type:s.type,lastVerified:s.lastVerified},this.dialResults.set(i,o)}return o}}removeOutdatedMultiaddrResults(){const e=new Set(this.components.addressManager.getAddressesWithMetadata().filter(({expires:t})=>t<Date.now()).map(({multiaddr:t})=>t.toString()));for(const t of this.dialResults.keys())e.has(t)||(this.log.trace("remove results for %a",t),this.dialResults.delete(t))}async verifyExternalAddresses(e){if(!this.isStarted())return;this.removeOutdatedMultiaddrResults();const n=(await this.components.peerStore.get(e.remotePeer)).addresses.some(({multiaddr:o})=>o.toOptions().family===6),s=this.getNetworkSegment(e.remoteAddr),i=this.getFirstUnverifiedMultiaddr(s,n);if(i==null){this.log.trace("no unverified public addresses found for peer %p to verify, not requesting verification",e.remotePeer);return}if(!this.hasConnectionCapacity()){i.lastVerified!=null?(this.log("automatically re-verifying %a because we are too close to the connection limit",i.multiaddr),this.confirmAddress(i)):this.log("skipping verifying %a because we are too close to the connection limit",i.multiaddr);return}i.queue.add(async o=>{await this.askPeerToVerify(e,s,o)},{peerId:e.remotePeer,multiaddr:i.multiaddr}).catch(o=>{i?.result==null&&this.log.error("error from %p verifying address %a - %e",e.remotePeer,i?.multiaddr,o)})}async askPeerToVerify(e,t,n){let s=this.dialResults.get(n.multiaddr.toString());if(s==null){this.log("%a was verified while %p was queued",n.multiaddr,e.remotePeer);return}const i=AbortSignal.timeout(this.timeout);this.log.trace("asking %p to verify multiaddr %s",e.remotePeer,n.multiaddr);const o=await e.newStream(this.protocol,{signal:i});try{const a=gr(o).pb(Ut),[,c]=await Promise.all([a.write({type:Ut.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toMultihash().bytes,addrs:[n.multiaddr.bytes]}}},{signal:i}),a.read({signal:i})]);if(c.type!==Ut.MessageType.DIAL_RESPONSE||c.dialResponse==null){this.log("invalid autonat response from %p - %j",e.remotePeer,c);return}const l=c.dialResponse.status;if(this.log.trace("autonat response from %p for %a is %s",e.remotePeer,n.multiaddr,l),l!==Ut.ResponseStatus.OK&&l!==Ut.ResponseStatus.E_DIAL_ERROR)return;if(s=this.dialResults.get(n.multiaddr.toString()),s==null){this.log.trace("peer reported %a as %s but there is no result object",n.multiaddr,c.dialResponse.status);return}if(s.networkSegments.includes(t)){this.log.trace("%a results included network segment %s",n.multiaddr,t);return}if(s.result!=null){this.log.trace("already resolved result for %a, ignoring response from",n.multiaddr,e.remotePeer);return}if(s.verifyingPeers.has(e.remotePeer)){this.log.trace("peer %p has already verified %a, ignoring response",e.remotePeer,n.multiaddr);return}if(s.verifyingPeers.add(e.remotePeer),s.networkSegments.push(t),l===Ut.ResponseStatus.OK){if(s.success++,s.type!=="observed"){this.confirmAddress(s);return}}else l===Ut.ResponseStatus.E_DIAL_ERROR&&s.failure++;this.log("%a success %d failure %d",s.multiaddr,s.success,s.failure),s.success===CN&&this.confirmAddress(s),s.failure===RN&&this.unconfirmAddress(s)}finally{try{await o.close({signal:i})}catch(a){o.abort(a)}}}hasConnectionCapacity(){const t=this.components.connectionManager.getConnections().length,n=this.components.connectionManager.getMaxConnections();return t/n*100<this.connectionThreshold}confirmAddress(e){this.log("%s address %a is externally dialable",e.type,e.multiaddr),this.components.addressManager.confirmObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!0,e.queue.abort()}unconfirmAddress(e){this.log("%s address %a is not externally dialable",e.type,e.multiaddr),this.components.addressManager.removeObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!1,e.queue.abort()}getNetworkSegment(e){const t=e.toOptions();return t.family===4?t.host.split(".")[0].padStart(3,"0"):t.host.split(":")[0].padStart(4,"0")}}function DN(r={}){return e=>new PN(e,r)}var Gr;(function(r){(function(n){n.UNUSED="UNUSED",n.CONNECT="CONNECT",n.SYNC="SYNC"})(r.Type||(r.Type={}));let e;(function(n){n[n.UNUSED=0]="UNUSED",n[n.CONNECT=100]="CONNECT",n[n.SYNC=300]="SYNC"})(e||(e={})),(function(n){n.codec=()=>Rn(e)})(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=tt((n,s,i={})=>{if(i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.observedAddresses!=null)for(const o of n.observedAddresses)s.uint32(18),s.bytes(o);i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={observedAddresses:[]},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{if(i.limits?.observedAddresses!=null&&o.observedAddresses.length===i.limits.observedAddresses)throw new Mt('Decode error - map field "observedAddresses" had too many elements');o.observedAddresses.push(n.bytes());break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>et(n,r.codec()),r.decode=(n,s)=>Je(n,r.codec(),s)})(Gr||(Gr={}));function Z4(r,e){return Li.matches(r)||e.dialTransportForMultiaddr(r)==null?!1:cO.matches(r)?!0:uO.matches(r)?Ho(r.toOptions().host)===!1:!1}const j4=1024*4,Y4=100,bf={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1};class qN{started;timeout;retries;maxInboundStreams;maxOutboundStreams;peerStore;registrar;connectionManager;addressManager;transportManager;topologyId;log;constructor(e,t){this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??bf.timeout,this.retries=t.retries??bf.retries,this.maxInboundStreams=t.maxInboundStreams??bf.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??bf.maxOutboundStreams}[Symbol.toStringTag]="@libp2p/dcutr";[_o]=["@libp2p/identify"];isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(wf,{notifyOnLimitedConnection:!0,onConnect:(e,t)=>{Li.exactMatch(t.remoteAddr)&&t.direction==="inbound"&&this.upgradeInbound(t).catch(n=>{this.log.error("error during outgoing DCUtR attempt",n)})}}),await this.registrar.handle(wf,e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch(t=>{this.log.error("error during incoming DCUtR attempt",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(wf),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let n=0;n<this.retries;n++){const s={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([wf],{signal:s.signal,runOnLimitedConnection:!0});const i=gr(t,{maxDataLength:j4}).pb(Gr);this.log("B sending connect to %p",e.remotePeer);const o=Date.now();await i.write({type:Gr.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(f=>f.bytes)},s),this.log("B receiving connect from %p",e.remotePeer);const a=await i.read(s);if(a.type!==Gr.Type.CONNECT)throw this.log("A sent wrong message type"),new Jt("DCUtR message type was incorrect");const c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw this.log("A did not have any dialable multiaddrs"),new Jt("DCUtR connect message had no multiaddrs");const l=Date.now()-o;this.log("A sending sync, rtt %dms",l),await i.write({type:Gr.Type.SYNC,observedAddresses:[]},s),this.log("A waiting for half RTT"),await nw(l/2),this.log("B dialing",c);const h=await this.connectionManager.openConnection(c,{signal:s.signal,priority:Y4,force:!0,initiator:!1});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,h.remoteAddr),await e.close(s);break}catch(i){if(this.log.error("error while attempting DCUtR on attempt %d of %d",n+1,this.retries,i),t?.abort(i),n===this.retries)throw i}finally{t!=null&&await t.close(s)}}}async attemptUnilateralConnectionUpgrade(e){const n=(await this.peerStore.get(e.remotePeer)).addresses.map(s=>{const i=s.multiaddr;return i.getPeerId()==null?i.encapsulate(`/p2p/${e.remotePeer}`):i}).filter(s=>Z4(s,this.transportManager));if(n.length>0){const s=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",n);const i=await this.connectionManager.openConnection(n,{signal:s,force:!0});if(Li.exactMatch(i.remoteAddr))throw new Error("Could not open a new, non-limited, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,i.remoteAddr),await e.close({signal:s}),!0}catch(i){this.log.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,n,i)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){const n={signal:AbortSignal.timeout(this.timeout)};try{const s=gr(e,{maxDataLength:j4}).pb(Gr);this.log("A receiving connect");const i=await s.read(n);if(i.type!==Gr.Type.CONNECT)throw this.log("B sent wrong message type"),new Jt("DCUtR message type was incorrect");if(i.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new Jt("DCUtR connect message had no multiaddrs");const o=this.getDialableMultiaddrs(i.observedAddresses);if(o.length===0)throw this.log("B had no dialable multiaddrs"),new Jt("DCUtR connect message had no dialable multiaddrs");if(this.log("A sending connect"),await s.write({type:Gr.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(l=>l.bytes)}),this.log("A receiving sync"),(await s.read(n)).type!==Gr.Type.SYNC)throw new Jt("DCUtR message type was incorrect");this.log("A dialing",o);const c=await this.connectionManager.openConnection(o,{signal:n.signal,priority:Y4,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,c.remoteAddr),await t.close(n)}catch(s){this.log.error("incoming DCUtR from %p failed",t.remotePeer,s),e.abort(s)}finally{await e.close(n)}}getDialableMultiaddrs(e){const t=[];for(const n of e)if(!(n==null||n.length===0))try{const s=lt(n);if(!Z4(s,this.transportManager))continue;t.push(s)}catch{}return t}}const wf="/libp2p/dcutr";function BN(r={}){return e=>new qN(e,r)}const _c=1e3,Pg=60*_c,Zh=60*Pg,LN="/ipfs/kad/1.0.0",Iw=48*Zh,ON=24*Zh,$N=10,MN=16384,NN=Zh,Q4=Zh,UN=10*_c,Tw=20,jh=10,FN=5*Pg,HN=_c,VN=5*_c,KN=5*Pg,zN=30*_c,WN=180*_c,X4=`${au}-kad-dht`;var Hd;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key.byteLength>0&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={key:St(0),value:St(0),timeReceived:""},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(Hd||(Hd={}));function GN(r){const e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),s=String(r.getUTCHours()).padStart(2,"0"),i=String(r.getUTCMinutes()).padStart(2,"0"),o=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${s}:${i}:${o}.${c}Z`}function ZN(r){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");const n=parseInt(t[1],10),s=parseInt(t[2],10)-1,i=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,s,i,o,a,c,l))}class Ir{key;value;timeReceived;constructor(e,t,n){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return Hd.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:GN(this.timeReceived)}}static deserialize(e){const t=Hd.decode(e);return new Ir(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=ZN(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new Ir(e.key,e.value,t)}}class Vd extends Error{constructor(e="Query error"){super(e),this.name="QueryError"}}class jN extends Error{constructor(e="Invalid record"){super(e),this.name="InvalidRecordError"}}class YN extends Error{constructor(e="No selector function configured for prefix"){super(e),this.name="MissingSelectorError"}}var J4;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 3:{i.author=t.bytes();break}case 4:{i.signature=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(J4||(J4={}));var Ht;(function(r){r.PUT_VALUE="PUT_VALUE",r.GET_VALUE="GET_VALUE",r.ADD_PROVIDER="ADD_PROVIDER",r.GET_PROVIDERS="GET_PROVIDERS",r.FIND_NODE="FIND_NODE",r.PING="PING"})(Ht||(Ht={}));var Kd;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(Kd||(Kd={}));(function(r){r.codec=()=>Rn(Kd)})(Ht||(Ht={}));var nc;(function(r){r.NOT_CONNECTED="NOT_CONNECTED",r.CONNECTED="CONNECTED",r.CAN_CONNECT="CAN_CONNECT",r.CANNOT_CONNECT="CANNOT_CONNECT"})(nc||(nc={}));var S3;(function(r){r[r.NOT_CONNECTED=0]="NOT_CONNECTED",r[r.CONNECTED=1]="CONNECTED",r[r.CAN_CONNECT=2]="CAN_CONNECT",r[r.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(S3||(S3={}));(function(r){r.codec=()=>Rn(S3)})(nc||(nc={}));var ya;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.multiaddrs!=null)for(const i of t.multiaddrs)n.uint32(18),n.bytes(i);t.connection!=null&&(n.uint32(24),nc.codec().encode(t.connection,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={id:St(0),multiaddrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.id=t.bytes();break}case 2:{if(s.limits?.multiaddrs!=null&&i.multiaddrs.length===s.limits.multiaddrs)throw new Mt('Decode error - map field "multiaddrs" had too many elements');i.multiaddrs.push(t.bytes());break}case 3:{i.connection=nc.codec().decode(t);break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(ya||(ya={}));var Ra;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.type!=null&&Kd[t.type]!==0&&(n.uint32(8),Ht.codec().encode(t.type,n)),t.clusterLevel!=null&&(n.uint32(80),n.int32(t.clusterLevel)),t.key!=null&&(n.uint32(18),n.bytes(t.key)),t.record!=null&&(n.uint32(26),n.bytes(t.record)),t.closer!=null)for(const i of t.closer)n.uint32(66),ya.codec().encode(i,n);if(t.providers!=null)for(const i of t.providers)n.uint32(74),ya.codec().encode(i,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={type:Ht.PUT_VALUE,closer:[],providers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.type=Ht.codec().decode(t);break}case 10:{i.clusterLevel=t.int32();break}case 2:{i.key=t.bytes();break}case 3:{i.record=t.bytes();break}case 8:{if(s.limits?.closer!=null&&i.closer.length===s.limits.closer)throw new Mt('Decode error - map field "closer" had too many elements');i.closer.push(ya.codec().decode(t,t.uint32(),{limits:s.limits?.closer$}));break}case 9:{if(s.limits?.providers!=null&&i.providers.length===s.limits.providers)throw new Mt('Decode error - map field "providers" had too many elements');i.providers.push(ya.codec().decode(t,t.uint32(),{limits:s.limits?.providers$}));break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(Ra||(Ra={}));function e5(r,e={}){const t={...r,name:"SEND_QUERY",type:0,messageName:r.type,messageType:r.type};return e.onProgress?.(new CustomEvent("kad-dht:query:send-query",{detail:t})),t}function A3(r,e={}){const t={...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer??[],providers:r.providers??[]};return e.onProgress?.(new CustomEvent("kad-dht:query:peer-response",{detail:t})),t}function $0(r,e={}){const t={...r,name:"FINAL_PEER",type:2};return e.onProgress?.(new CustomEvent("kad-dht:query:final-peer",{detail:t})),t}function rc(r,e={}){const t={...r,name:"QUERY_ERROR",type:3};return e.onProgress?.(new CustomEvent("kad-dht:query:query-error",{detail:t})),t}function t5(r,e={}){const t={...r,name:"PROVIDER",type:4};return e.onProgress?.(new CustomEvent("kad-dht:query:provider",{detail:t})),t}function I3(r,e={}){const t={...r,name:"VALUE",type:5};return e.onProgress?.(new CustomEvent("kad-dht:query:value",{detail:t})),t}function n5(r,e={}){const t={...r,name:"DIAL_PEER",type:7};return e.onProgress?.(new CustomEvent("kad-dht:query:dial-peer",{detail:t})),t}function QN(r,e={}){const t={...r,name:"PATH_ENDED",type:8};return e.onProgress?.(new CustomEvent("kad-dht:query:path-ended",{detail:t})),t}function XN(r,e,t){if(t.length===0)throw new ot("No records given");const s=Le(e).split("/");if(s.length<3)throw new ot("Record key does not have a selector function");const i=r[s[1].toString()];if(i==null)throw new YN(`No selector function configured for key type "${s[1]}"`);return t.length===1?0:i(e,t)}function JN(r,e){return 0}const eU={pk:JN};let vu=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},kw=class extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}},tU=class extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};const nU=parseInt("11111",2),T3=parseInt("10000000",2),rU=parseInt("01111111",2),r5={0:Oc,1:Oc,2:sU,3:aU,4:cU,5:oU,6:iU,16:Oc,22:Oc,48:Oc};function Yh(r,e={offset:0}){const t=r[e.offset]&nU;if(e.offset++,r5[t]!=null)return r5[t](r,e);throw new Error("No decoder for tag "+t)}function xu(r,e){let t=0;if((r[e.offset]&T3)===T3){const n=r[e.offset]&rU;let s="0x";e.offset++;for(let i=0;i<n;i++,e.offset++)s+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=r[e.offset],e.offset++;return t}function Oc(r,e){xu(r,e);const t=[];for(;!(e.offset>=r.byteLength);){const n=Yh(r,e);if(n===null)break;t.push(n)}return t}function sU(r,e){const t=xu(r,e),n=e.offset,s=e.offset+t,i=[];for(let o=n;o<s;o++)o===n&&r[o]===0||i.push(r[o]);return e.offset+=t,Uint8Array.from(i)}function iU(r,e){const t=xu(r,e),n=e.offset+t,s=r[e.offset];e.offset++;let i=0,o=0;s<40?(i=0,o=s):s<80?(i=1,o=s-40):(i=2,o=s-80);let a=`${i}.${o}`,c=[];for(;e.offset<n;){const l=r[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let h=0;for(let f=0;f<c.length;f++)h+=c[f]<<f*7;a+=`.${h}`,c=[]}}return a}function oU(r,e){return e.offset++,null}function aU(r,e){const t=xu(r,e),n=r[e.offset];e.offset++;const s=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function cU(r,e){const t=xu(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function lU(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);const t=new Ue;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function Dg(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);const e=lU(r.byteLength);return new Ue(Uint8Array.from([e.byteLength|T3]),e)}function k3(r){const e=new Ue,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Ue(Uint8Array.from([2]),Dg(e),e)}function Cw(r){const e=Uint8Array.from([0]),t=new Ue(e,r);return new Ue(Uint8Array.from([3]),Dg(t),t)}function tl(r,e=48){const t=new Ue;for(const n of r)t.append(n);return new Ue(Uint8Array.from([e]),Dg(t),t)}async function uU(r,e,t,n){const s=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();const i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return n?.signal?.throwIfAborted(),i}const fU=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),dU=Uint8Array.from([6,5,43,129,4,0,34]),hU=Uint8Array.from([6,5,43,129,4,0,35]),pU={ext:!0,kty:"EC",crv:"P-256"},gU={ext:!0,kty:"EC",crv:"P-384"},mU={ext:!0,kty:"EC",crv:"P-521"},M0=32,N0=48,U0=66;function yU(r){const e=Yh(r);return bU(e)}function bU(r){const e=r[1][1][0],t=1;let n,s;if(e.byteLength===M0*2+1)return n=Le(e.subarray(t,t+M0),"base64url"),s=Le(e.subarray(t+M0),"base64url"),new F0({...pU,key_ops:["verify"],x:n,y:s});if(e.byteLength===N0*2+1)return n=Le(e.subarray(t,t+N0),"base64url"),s=Le(e.subarray(t+N0),"base64url"),new F0({...gU,key_ops:["verify"],x:n,y:s});if(e.byteLength===U0*2+1)return n=Le(e.subarray(t,t+U0),"base64url"),s=Le(e.subarray(t+U0),"base64url"),new F0({...mU,key_ops:["verify"],x:n,y:s});throw new vu(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function wU(r){return tl([k3(Uint8Array.from([1])),tl([_U(r.crv)],160),tl([Cw(new Ue(Uint8Array.from([4]),Ge(r.x??"","base64url"),Ge(r.y??"","base64url")))],161)]).subarray()}function _U(r){if(r==="P-256")return fU;if(r==="P-384")return dU;if(r==="P-521")return hU;throw new vu(`Invalid curve ${r}`)}let F0=class{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=wU(this.jwk)),this._raw}toMultihash(){return Kt.digest(t1(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}async verify(e,t,n){return uU(this.jwk,t,e,n)}};function Qh(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Ro(r,e=""){if(!Number.isSafeInteger(r)||r<0){const t=e&&`"${e}" `;throw new Error(`${t}expected integer >= 0, got ${r}`)}}function vt(r,e,t=""){const n=Qh(r),s=r?.length,i=e!==void 0;if(!n||i&&s!==e){const o=t&&`"${t}" `,a=i?` of length ${e}`:"",c=n?`length=${s}`:`type=${typeof r}`;throw new Error(o+"expected Uint8Array"+a+", got "+c)}return r}function Rw(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash must wrapped by utils.createHasher");Ro(r.outputLen),Ro(r.blockLen)}function zd(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function EU(r,e){vt(r,void 0,"digestInto() output");const t=e.outputLen;if(r.length<t)throw new Error('"digestInto() output" expected to be of length >='+t)}function sc(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function H0(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function Vr(r,e){return r<<32-e|r>>>e}const Pw=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",vU=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function Su(r){if(vt(r),Pw)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=vU[r[t]];return e}const ms={_0:48,_9:57,A:65,F:70,a:97,f:102};function s5(r){if(r>=ms._0&&r<=ms._9)return r-ms._0;if(r>=ms.A&&r<=ms.F)return r-(ms.A-10);if(r>=ms.a&&r<=ms.f)return r-(ms.a-10)}function Ml(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(Pw)return Uint8Array.fromHex(r);const e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(t);for(let s=0,i=0;s<t;s++,i+=2){const o=s5(r.charCodeAt(i)),a=s5(r.charCodeAt(i+1));if(o===void 0||a===void 0){const c=r[i]+r[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[s]=o*16+a}return n}function es(...r){let e=0;for(let n=0;n<r.length;n++){const s=r[n];vt(s),e+=s.length}const t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){const i=r[n];t.set(i,s),s+=i.length}return t}function Dw(r,e={}){const t=(s,i)=>r(i).update(s).digest(),n=r(void 0);return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=s=>r(s),Object.assign(t,e),Object.freeze(t)}function Xh(r=32){const e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}const qw=r=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,r])});function xU(r,e,t){return r&e^~r&t}function SU(r,e,t){return r&e^r&t^e&t}let Bw=class{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(e,t,n,s){this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=H0(this.buffer)}update(e){zd(this),vt(e);const{view:t,buffer:n,blockLen:s}=this,i=e.length;for(let o=0;o<i;){const a=Math.min(s-this.pos,i-o);if(a===s){const c=H0(e);for(;s<=i-o;o+=s)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){zd(this),EU(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:s,isLE:i}=this;let{pos:o}=this;t[o++]=128,sc(this.buffer.subarray(o)),this.padOffset>s-o&&(this.process(n,0),o=0);for(let f=o;f<s;f++)t[f]=0;n.setBigUint64(s-8,BigInt(this.length*8),i),this.process(n,0);const a=H0(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");const l=c/4,h=this.get();if(l>h.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<l;f++)a.setUint32(4*f,h[f],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||=new this.constructor,e.set(...this.get());const{blockLen:t,buffer:n,length:s,finished:i,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=i,e.length=s,e.pos=a,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}};const oi=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),On=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),_f=BigInt(2**32-1),i5=BigInt(32);function AU(r,e=!1){return e?{h:Number(r&_f),l:Number(r>>i5&_f)}:{h:Number(r>>i5&_f)|0,l:Number(r&_f)|0}}function IU(r,e=!1){const t=r.length;let n=new Uint32Array(t),s=new Uint32Array(t);for(let i=0;i<t;i++){const{h:o,l:a}=AU(r[i],e);[n[i],s[i]]=[o,a]}return[n,s]}const o5=(r,e,t)=>r>>>t,a5=(r,e,t)=>r<<32-t|e>>>t,ia=(r,e,t)=>r>>>t|e<<32-t,oa=(r,e,t)=>r<<32-t|e>>>t,Ef=(r,e,t)=>r<<64-t|e>>>t-32,vf=(r,e,t)=>r>>>t-32|e<<64-t;function ys(r,e,t,n){const s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}const TU=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),kU=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,CU=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),RU=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,PU=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),DU=(r,e,t,n,s,i)=>e+t+n+s+i+(r/2**32|0)|0,qU=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),ai=new Uint32Array(64);let BU=class extends Bw{constructor(e){super(64,e,8,!1)}get(){const{A:e,B:t,C:n,D:s,E:i,F:o,G:a,H:c}=this;return[e,t,n,s,i,o,a,c]}set(e,t,n,s,i,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let f=0;f<16;f++,t+=4)ai[f]=e.getUint32(t,!1);for(let f=16;f<64;f++){const p=ai[f-15],m=ai[f-2],_=Vr(p,7)^Vr(p,18)^p>>>3,R=Vr(m,17)^Vr(m,19)^m>>>10;ai[f]=R+ai[f-7]+_+ai[f-16]|0}let{A:n,B:s,C:i,D:o,E:a,F:c,G:l,H:h}=this;for(let f=0;f<64;f++){const p=Vr(a,6)^Vr(a,11)^Vr(a,25),m=h+p+xU(a,c,l)+qU[f]+ai[f]|0,R=(Vr(n,2)^Vr(n,13)^Vr(n,22))+SU(n,s,i)|0;h=l,l=c,c=a,a=o+m|0,o=i,i=s,s=n,n=m+R|0}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,h=h+this.H|0,this.set(n,s,i,o,a,c,l,h)}roundClean(){sc(ai)}destroy(){this.set(0,0,0,0,0,0,0,0),sc(this.buffer)}},LU=class extends BU{A=oi[0]|0;B=oi[1]|0;C=oi[2]|0;D=oi[3]|0;E=oi[4]|0;F=oi[5]|0;G=oi[6]|0;H=oi[7]|0;constructor(){super(32)}};const Lw=IU(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),OU=Lw[0],$U=Lw[1],ci=new Uint32Array(80),li=new Uint32Array(80);let MU=class extends Bw{constructor(e){super(128,e,16,!1)}get(){const{Ah:e,Al:t,Bh:n,Bl:s,Ch:i,Cl:o,Dh:a,Dl:c,Eh:l,El:h,Fh:f,Fl:p,Gh:m,Gl:_,Hh:R,Hl:T}=this;return[e,t,n,s,i,o,a,c,l,h,f,p,m,_,R,T]}set(e,t,n,s,i,o,a,c,l,h,f,p,m,_,R,T){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=h|0,this.Fh=f|0,this.Fl=p|0,this.Gh=m|0,this.Gl=_|0,this.Hh=R|0,this.Hl=T|0}process(e,t){for(let I=0;I<16;I++,t+=4)ci[I]=e.getUint32(t),li[I]=e.getUint32(t+=4);for(let I=16;I<80;I++){const q=ci[I-15]|0,L=li[I-15]|0,z=ia(q,L,1)^ia(q,L,8)^o5(q,L,7),Y=oa(q,L,1)^oa(q,L,8)^a5(q,L,7),k=ci[I-2]|0,x=li[I-2]|0,F=ia(k,x,19)^Ef(k,x,61)^o5(k,x,6),j=oa(k,x,19)^vf(k,x,61)^a5(k,x,6),U=CU(Y,j,li[I-7],li[I-16]),y=RU(U,z,F,ci[I-7],ci[I-16]);ci[I]=y|0,li[I]=U|0}let{Ah:n,Al:s,Bh:i,Bl:o,Ch:a,Cl:c,Dh:l,Dl:h,Eh:f,El:p,Fh:m,Fl:_,Gh:R,Gl:T,Hh:A,Hl:D}=this;for(let I=0;I<80;I++){const q=ia(f,p,14)^ia(f,p,18)^Ef(f,p,41),L=oa(f,p,14)^oa(f,p,18)^vf(f,p,41),z=f&m^~f&R,Y=p&_^~p&T,k=PU(D,L,Y,$U[I],li[I]),x=DU(k,A,q,z,OU[I],ci[I]),F=k|0,j=ia(n,s,28)^Ef(n,s,34)^Ef(n,s,39),U=oa(n,s,28)^vf(n,s,34)^vf(n,s,39),y=n&i^n&a^i&a,b=s&o^s&c^o&c;A=R|0,D=T|0,R=m|0,T=_|0,m=f|0,_=p|0,{h:f,l:p}=ys(l|0,h|0,x|0,F|0),l=a|0,h=c|0,a=i|0,c=o|0,i=n|0,o=s|0;const g=TU(F,U,b);n=kU(g,x,j,y),s=g|0}({h:n,l:s}=ys(this.Ah|0,this.Al|0,n|0,s|0)),{h:i,l:o}=ys(this.Bh|0,this.Bl|0,i|0,o|0),{h:a,l:c}=ys(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:h}=ys(this.Dh|0,this.Dl|0,l|0,h|0),{h:f,l:p}=ys(this.Eh|0,this.El|0,f|0,p|0),{h:m,l:_}=ys(this.Fh|0,this.Fl|0,m|0,_|0),{h:R,l:T}=ys(this.Gh|0,this.Gl|0,R|0,T|0),{h:A,l:D}=ys(this.Hh|0,this.Hl|0,A|0,D|0),this.set(n,s,i,o,a,c,l,h,f,p,m,_,R,T,A,D)}roundClean(){sc(ci,li)}destroy(){sc(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},NU=class extends MU{Ah=On[0]|0;Al=On[1]|0;Bh=On[2]|0;Bl=On[3]|0;Ch=On[4]|0;Cl=On[5]|0;Dh=On[6]|0;Dl=On[7]|0;Eh=On[8]|0;El=On[9]|0;Fh=On[10]|0;Fl=On[11]|0;Gh=On[12]|0;Gl=On[13]|0;Hh=On[14]|0;Hl=On[15]|0;constructor(){super(64)}};const Ow=Dw(()=>new LU,qw(1)),UU=Dw(()=>new NU,qw(3));const qg=BigInt(0),C3=BigInt(1);function Po(r,e=""){if(typeof r!="boolean"){const t=e&&`"${e}" `;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function $w(r){if(typeof r=="bigint"){if(!Zf(r))throw new Error("positive bigint expected, got "+r)}else Ro(r);return r}function xf(r){const e=$w(r).toString(16);return e.length&1?"0"+e:e}function Mw(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?qg:BigInt("0x"+r)}function Jh(r){return Mw(Su(r))}function Nl(r){return Mw(Su(R3(vt(r)).reverse()))}function Bg(r,e){Ro(e),r=$w(r);const t=Ml(r.toString(16).padStart(e*2,"0"));if(t.length!==e)throw new Error("number too large");return t}function Nw(r,e){return Bg(r,e).reverse()}function R3(r){return Uint8Array.from(r)}const Zf=r=>typeof r=="bigint"&&qg<=r;function FU(r,e,t){return Zf(r)&&Zf(e)&&Zf(t)&&e<=r&&r<t}function P3(r,e,t,n){if(!FU(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function HU(r){let e;for(e=0;r>qg;r>>=C3,e+=1);return e}const Lg=r=>(C3<<BigInt(r))-C3;function VU(r,e,t){if(Ro(r,"hashLen"),Ro(e,"qByteLen"),typeof t!="function")throw new Error("hmacFn must be a function");const n=T=>new Uint8Array(T),s=Uint8Array.of(),i=Uint8Array.of(0),o=Uint8Array.of(1),a=1e3;let c=n(r),l=n(r),h=0;const f=()=>{c.fill(1),l.fill(0),h=0},p=(...T)=>t(l,es(c,...T)),m=(T=s)=>{l=p(i,T),c=p(),T.length!==0&&(l=p(o,T),c=p())},_=()=>{if(h++>=a)throw new Error("drbg: tried max amount of iterations");let T=0;const A=[];for(;T<e;){c=p();const D=c.slice();A.push(D),T+=c.length}return es(...A)};return(T,A)=>{f(),m(T);let D;for(;!(D=A(_()));)m();return f(),D}}function Au(r,e={},t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(i,o,a){const c=r[i];if(a&&c===void 0)return;const l=typeof c;if(l!==o||c===null)throw new Error(`param "${i}" is invalid: expected ${o}, got ${l}`)}const s=(i,o)=>Object.entries(i).forEach(([a,c])=>n(a,c,o));s(e,!1),s(t,!0)}function Wd(r){const e=new WeakMap;return(t,...n)=>{const s=e.get(t);if(s!==void 0)return s;const i=r(t,...n);return e.set(t,i),i}}const ar=BigInt(0),In=BigInt(1),no=BigInt(2),Uw=BigInt(3),Fw=BigInt(4),Hw=BigInt(5),KU=BigInt(7),Vw=BigInt(8),zU=BigInt(9),Kw=BigInt(16);function cn(r,e){const t=r%e;return t>=ar?t:e+t}function jt(r,e,t){let n=r;for(;e-- >ar;)n*=n,n%=t;return n}function c5(r,e){if(r===ar)throw new Error("invert: expected non-zero number");if(e<=ar)throw new Error("invert: expected positive modulus, got "+e);let t=cn(r,e),n=e,s=ar,i=In;for(;t!==ar;){const a=n/t,c=n%t,l=s-i*a;n=t,t=c,s=i,i=l}if(n!==In)throw new Error("invert: does not exist");return cn(s,e)}function Og(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function zw(r,e){const t=(r.ORDER+In)/Fw,n=r.pow(e,t);return Og(r,n,e),n}function WU(r,e){const t=(r.ORDER-Hw)/Vw,n=r.mul(e,no),s=r.pow(n,t),i=r.mul(e,s),o=r.mul(r.mul(i,no),s),a=r.mul(i,r.sub(o,r.ONE));return Og(r,a,e),a}function GU(r){const e=e1(r),t=Ww(r),n=t(e,e.neg(e.ONE)),s=t(e,n),i=t(e,e.neg(n)),o=(r+KU)/Kw;return(a,c)=>{let l=a.pow(c,o),h=a.mul(l,n);const f=a.mul(l,s),p=a.mul(l,i),m=a.eql(a.sqr(h),c),_=a.eql(a.sqr(f),c);l=a.cmov(l,h,m),h=a.cmov(p,f,_);const R=a.eql(a.sqr(h),c),T=a.cmov(l,h,R);return Og(a,T,c),T}}function Ww(r){if(r<Uw)throw new Error("sqrt is not defined for small field");let e=r-In,t=0;for(;e%no===ar;)e/=no,t++;let n=no;const s=e1(r);for(;l5(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return zw;let i=s.pow(n,e);const o=(e+In)/no;return function(c,l){if(c.is0(l))return l;if(l5(c,l)!==1)throw new Error("Cannot find square root");let h=t,f=c.mul(c.ONE,i),p=c.pow(l,e),m=c.pow(l,o);for(;!c.eql(p,c.ONE);){if(c.is0(p))return c.ZERO;let _=1,R=c.sqr(p);for(;!c.eql(R,c.ONE);)if(_++,R=c.sqr(R),_===h)throw new Error("Cannot find square root");const T=In<<BigInt(h-_-1),A=c.pow(f,T);h=_,f=c.sqr(A),p=c.mul(p,f),m=c.mul(m,A)}return m}}function ZU(r){return r%Fw===Uw?zw:r%Vw===Hw?WU:r%Kw===zU?GU(r):Ww(r)}const jU=(r,e)=>(cn(r,e)&In)===In,YU=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function QU(r){const e={ORDER:"bigint",BYTES:"number",BITS:"number"},t=YU.reduce((n,s)=>(n[s]="function",n),e);return Au(r,t),r}function XU(r,e,t){if(t<ar)throw new Error("invalid exponent, negatives unsupported");if(t===ar)return r.ONE;if(t===In)return e;let n=r.ONE,s=e;for(;t>ar;)t&In&&(n=r.mul(n,s)),s=r.sqr(s),t>>=In;return n}function Gw(r,e,t=!1){const n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((o,a,c)=>r.is0(a)?o:(n[c]=o,r.mul(o,a)),r.ONE),i=r.inv(s);return e.reduceRight((o,a,c)=>r.is0(a)?o:(n[c]=r.mul(o,n[c]),r.mul(o,a)),i),n}function l5(r,e){const t=(r.ORDER-In)/no,n=r.pow(e,t),s=r.eql(n,r.ONE),i=r.eql(n,r.ZERO),o=r.eql(n,r.neg(r.ONE));if(!s&&!i&&!o)throw new Error("invalid Legendre symbol result");return s?1:i?0:-1}function JU(r,e){e!==void 0&&Ro(e);const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}let eF=class{ORDER;BITS;BYTES;isLE;ZERO=ar;ONE=In;_lengths;_sqrt;_mod;constructor(e,t={}){if(e<=ar)throw new Error("invalid field: expected ORDER > 0, got "+e);let n;this.isLE=!1,t!=null&&typeof t=="object"&&(typeof t.BITS=="number"&&(n=t.BITS),typeof t.sqrt=="function"&&(this.sqrt=t.sqrt),typeof t.isLE=="boolean"&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),typeof t.modFromBytes=="boolean"&&(this._mod=t.modFromBytes));const{nBitLength:s,nByteLength:i}=JU(e,n);if(i>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=s,this.BYTES=i,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return cn(e,this.ORDER)}isValid(e){if(typeof e!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof e);return ar<=e&&e<this.ORDER}is0(e){return e===ar}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&In)===In}neg(e){return cn(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return cn(e*e,this.ORDER)}add(e,t){return cn(e+t,this.ORDER)}sub(e,t){return cn(e-t,this.ORDER)}mul(e,t){return cn(e*t,this.ORDER)}pow(e,t){return XU(this,e,t)}div(e,t){return cn(e*c5(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return c5(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=ZU(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?Nw(e,this.BYTES):Bg(e,this.BYTES)}fromBytes(e,t=!1){vt(e);const{_lengths:n,BYTES:s,isLE:i,ORDER:o,_mod:a}=this;if(n){if(!n.includes(e.length)||e.length>s)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+e.length);const l=new Uint8Array(s);l.set(e,i?0:l.length-e.length),e=l}if(e.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+e.length);let c=i?Nl(e):Jh(e);if(a&&(c=cn(c,o)),!t&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(e){return Gw(this,e)}cmov(e,t,n){return n?t:e}};function e1(r,e={}){return new eF(r,e)}function Zw(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function jw(r){const e=Zw(r);return e+Math.ceil(e/2)}function tF(r,e,t=!1){vt(r);const n=r.length,s=Zw(e),i=jw(e);if(n<16||n<i||n>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+n);const o=t?Nl(r):Jh(r),a=cn(o,e-In)+In;return t?Nw(a,s):Bg(a,s)}const ic=BigInt(0),ro=BigInt(1);function Gd(r,e){const t=e.negate();return r?t:e}function nl(r,e){const t=Gw(r.Fp,e.map(n=>n.Z));return e.map((n,s)=>r.fromAffine(n.toAffine(t[s])))}function Yw(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function V0(r,e){Yw(r,e);const t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,i=Lg(r),o=BigInt(r);return{windows:t,windowSize:n,mask:i,maxNumber:s,shiftBy:o}}function u5(r,e,t){const{windowSize:n,mask:s,maxNumber:i,shiftBy:o}=t;let a=Number(r&s),c=r>>o;a>n&&(a-=i,c+=ro);const l=e*n,h=l+Math.abs(a)-1,f=a===0,p=a<0,m=e%2!==0;return{nextN:c,offset:h,isZero:f,isNeg:p,isNegF:m,offsetF:l}}const K0=new WeakMap,Qw=new WeakMap;function z0(r){return Qw.get(r)||1}function f5(r){if(r!==ic)throw new Error("invalid wNAF")}let Xw=class{BASE;ZERO;Fn;bits;constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let s=e;for(;t>ic;)t&ro&&(n=n.add(s)),s=s.double(),t>>=ro;return n}precomputeWindow(e,t){const{windows:n,windowSize:s}=V0(t,this.bits),i=[];let o=e,a=o;for(let c=0;c<n;c++){a=o,i.push(a);for(let l=1;l<s;l++)a=a.add(o),i.push(a);o=a.double()}return i}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,i=this.BASE;const o=V0(e,this.bits);for(let a=0;a<o.windows;a++){const{nextN:c,offset:l,isZero:h,isNeg:f,isNegF:p,offsetF:m}=u5(n,a,o);n=c,h?i=i.add(Gd(p,t[m])):s=s.add(Gd(f,t[l]))}return f5(n),{p:s,f:i}}wNAFUnsafe(e,t,n,s=this.ZERO){const i=V0(e,this.bits);for(let o=0;o<i.windows&&n!==ic;o++){const{nextN:a,offset:c,isZero:l,isNeg:h}=u5(n,o,i);if(n=a,!l){const f=t[c];s=s.add(h?f.negate():f)}}return f5(n),s}getPrecomputes(e,t,n){let s=K0.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(s=n(s)),K0.set(t,s))),s}cached(e,t,n){const s=z0(e);return this.wNAF(s,this.getPrecomputes(s,e,n),t)}unsafe(e,t,n,s){const i=z0(e);return i===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(i,this.getPrecomputes(i,e,n),t,s)}createCache(e,t){Yw(t,this.bits),Qw.set(e,t),K0.delete(e)}hasCache(e){return z0(e)!==1}};function nF(r,e,t,n){let s=e,i=r.ZERO,o=r.ZERO;for(;t>ic||n>ic;)t&ro&&(i=i.add(s)),n&ro&&(o=o.add(s)),s=s.double(),t>>=ro,n>>=ro;return{p1:i,p2:o}}function d5(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return QU(e),e}else return e1(r,{isLE:t})}function Jw(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(const c of["p","n","h"]){const l=e[c];if(!(typeof l=="bigint"&&l>ic))throw new Error(`CURVE.${c} must be positive bigint`)}const s=d5(e.p,t.Fp,n),i=d5(e.n,t.Fn,n),a=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(const c of a)if(!s.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:i}}function e_(r,e){return function(n){const s=r(n);return{secretKey:s,publicKey:e(s)}}}const ui=BigInt(0),mn=BigInt(1),W0=BigInt(2),rF=BigInt(8);function sF(r,e,t,n){const s=r.sqr(t),i=r.sqr(n),o=r.add(r.mul(e.a,s),i),a=r.add(r.ONE,r.mul(e.d,r.mul(s,i)));return r.eql(o,a)}function iF(r,e={}){const t=Jw("edwards",r,e,e.FpFnLE),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o}=i;Au(e,{},{uvRatio:"function"});const a=W0<<BigInt(s.BYTES*8)-mn,c=T=>n.create(T),l=e.uvRatio||((T,A)=>{try{return{isValid:!0,value:n.sqrt(n.div(T,A))}}catch{return{isValid:!1,value:ui}}});if(!sF(n,i,i.Gx,i.Gy))throw new Error("bad curve params: generator point");function h(T,A,D=!1){const I=D?mn:ui;return P3("coordinate "+T,A,I,a),A}function f(T){if(!(T instanceof _))throw new Error("EdwardsPoint expected")}const p=Wd((T,A)=>{const{X:D,Y:I,Z:q}=T,L=T.is0();A==null&&(A=L?rF:n.inv(q));const z=c(D*A),Y=c(I*A),k=n.mul(q,A);if(L)return{x:ui,y:mn};if(k!==mn)throw new Error("invZ was invalid");return{x:z,y:Y}}),m=Wd(T=>{const{a:A,d:D}=i;if(T.is0())throw new Error("bad point: ZERO");const{X:I,Y:q,Z:L,T:z}=T,Y=c(I*I),k=c(q*q),x=c(L*L),F=c(x*x),j=c(Y*A),U=c(x*c(j+k)),y=c(F+c(D*c(Y*k)));if(U!==y)throw new Error("bad point: equation left != right (1)");const b=c(I*q),g=c(L*z);if(b!==g)throw new Error("bad point: equation left != right (2)");return!0});class _{static BASE=new _(i.Gx,i.Gy,mn,c(i.Gx*i.Gy));static ZERO=new _(ui,mn,mn,ui);static Fp=n;static Fn=s;X;Y;Z;T;constructor(A,D,I,q){this.X=h("x",A),this.Y=h("y",D),this.Z=h("z",I,!0),this.T=h("t",q),Object.freeze(this)}static CURVE(){return i}static fromAffine(A){if(A instanceof _)throw new Error("extended point not allowed");const{x:D,y:I}=A||{};return h("x",D),h("y",I),new _(D,I,mn,c(D*I))}static fromBytes(A,D=!1){const I=n.BYTES,{a:q,d:L}=i;A=R3(vt(A,I,"point")),Po(D,"zip215");const z=R3(A),Y=A[I-1];z[I-1]=Y&-129;const k=Nl(z),x=D?a:n.ORDER;P3("point.y",k,ui,x);const F=c(k*k),j=c(F-mn),U=c(L*F-q);let{isValid:y,value:b}=l(j,U);if(!y)throw new Error("bad point: invalid y coordinate");const g=(b&mn)===mn,C=(Y&128)!==0;if(!D&&b===ui&&C)throw new Error("bad point: x=0 and x_0=1");return C!==g&&(b=c(-b)),_.fromAffine({x:b,y:k})}static fromHex(A,D=!1){return _.fromBytes(Ml(A),D)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(A=8,D=!0){return R.createCache(this,A),D||this.multiply(W0),this}assertValidity(){m(this)}equals(A){f(A);const{X:D,Y:I,Z:q}=this,{X:L,Y:z,Z:Y}=A,k=c(D*Y),x=c(L*q),F=c(I*Y),j=c(z*q);return k===x&&F===j}is0(){return this.equals(_.ZERO)}negate(){return new _(c(-this.X),this.Y,this.Z,c(-this.T))}double(){const{a:A}=i,{X:D,Y:I,Z:q}=this,L=c(D*D),z=c(I*I),Y=c(W0*c(q*q)),k=c(A*L),x=D+I,F=c(c(x*x)-L-z),j=k+z,U=j-Y,y=k-z,b=c(F*U),g=c(j*y),C=c(F*y),B=c(U*j);return new _(b,g,B,C)}add(A){f(A);const{a:D,d:I}=i,{X:q,Y:L,Z:z,T:Y}=this,{X:k,Y:x,Z:F,T:j}=A,U=c(q*k),y=c(L*x),b=c(Y*I*j),g=c(z*F),C=c((q+L)*(k+x)-U-y),B=g-b,M=g+b,O=c(y-D*U),$=c(C*B),V=c(M*O),G=c(C*O),de=c(B*M);return new _($,V,de,G)}subtract(A){return this.add(A.negate())}multiply(A){if(!s.isValidNot0(A))throw new Error("invalid scalar: expected 1 <= sc < curve.n");const{p:D,f:I}=R.cached(this,A,q=>nl(_,q));return nl(_,[D,I])[0]}multiplyUnsafe(A,D=_.ZERO){if(!s.isValid(A))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return A===ui?_.ZERO:this.is0()||A===mn?this:R.unsafe(this,A,I=>nl(_,I),D)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}isTorsionFree(){return R.unsafe(this,i.n).is0()}toAffine(A){return p(this,A)}clearCofactor(){return o===mn?this:this.multiplyUnsafe(o)}toBytes(){const{x:A,y:D}=this.toAffine(),I=n.toBytes(D);return I[I.length-1]|=A&mn?128:0,I}toHex(){return Su(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const R=new Xw(_,s.BITS);return _.BASE.precompute(8),_}function oF(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');Au(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:n}=t,{BASE:s,Fp:i,Fn:o}=r,a=t.randomBytes||Xh,c=t.adjustScalarBytes||(k=>k),l=t.domain||((k,x,F)=>{if(Po(F,"phflag"),x.length||F)throw new Error("Contexts/pre-hash are not supported");return k});function h(k){return o.create(Nl(k))}function f(k){const x=I.secretKey;vt(k,I.secretKey,"secretKey");const F=vt(e(k),2*x,"hashedSecretKey"),j=c(F.slice(0,x)),U=F.slice(x,2*x),y=h(j);return{head:j,prefix:U,scalar:y}}function p(k){const{head:x,prefix:F,scalar:j}=f(k),U=s.multiply(j),y=U.toBytes();return{head:x,prefix:F,scalar:j,point:U,pointBytes:y}}function m(k){return p(k).pointBytes}function _(k=Uint8Array.of(),...x){const F=es(...x);return h(e(l(F,vt(k,void 0,"context"),!!n)))}function R(k,x,F={}){k=vt(k,void 0,"message"),n&&(k=n(k));const{prefix:j,scalar:U,pointBytes:y}=p(x),b=_(F.context,j,k),g=s.multiply(b).toBytes(),C=_(F.context,g,y,k),B=o.create(b+C*U);if(!o.isValid(B))throw new Error("sign failed: invalid s");const M=es(g,o.toBytes(B));return vt(M,I.signature,"result")}const T={zip215:!0};function A(k,x,F,j=T){const{context:U,zip215:y}=j,b=I.signature;k=vt(k,b,"signature"),x=vt(x,void 0,"message"),F=vt(F,I.publicKey,"publicKey"),y!==void 0&&Po(y,"zip215"),n&&(x=n(x));const g=b/2,C=k.subarray(0,g),B=Nl(k.subarray(g,b));let M,O,$;try{M=r.fromBytes(F,y),O=r.fromBytes(C,y),$=s.multiplyUnsafe(B)}catch{return!1}if(!y&&M.isSmallOrder())return!1;const V=_(U,O.toBytes(),M.toBytes(),x);return O.add(M.multiplyUnsafe(V)).subtract($).clearCofactor().is0()}const D=i.BYTES,I={secretKey:D,publicKey:D,signature:2*D,seed:D};function q(k=a(I.seed)){return vt(k,I.seed,"seed")}function L(k){return Qh(k)&&k.length===o.BYTES}function z(k,x){try{return!!r.fromBytes(k,x)}catch{return!1}}const Y={getExtendedPublicKey:p,randomSecretKey:q,isValidSecretKey:L,isValidPublicKey:z,toMontgomery(k){const{y:x}=r.fromBytes(k),F=I.publicKey,j=F===32;if(!j&&F!==57)throw new Error("only defined for 25519 and 448");const U=j?i.div(mn+x,mn-x):i.div(x-mn,x+mn);return i.toBytes(U)},toMontgomerySecret(k){const x=I.secretKey;vt(k,x);const F=e(k.subarray(0,x));return c(F).subarray(0,x)}};return Object.freeze({keygen:e_(q,m),getPublicKey:m,sign:R,verify:A,utils:Y,Point:r,lengths:I})}const aF=BigInt(1),h5=BigInt(2),cF=BigInt(5),lF=BigInt(8),$g=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),uF={p:$g,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:lF,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function fF(r){const e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),i=$g,a=r*r%i*r%i,c=jt(a,h5,i)*a%i,l=jt(c,aF,i)*r%i,h=jt(l,cF,i)*l%i,f=jt(h,e,i)*h%i,p=jt(f,t,i)*f%i,m=jt(p,n,i)*p%i,_=jt(m,s,i)*m%i,R=jt(_,s,i)*m%i,T=jt(R,e,i)*h%i;return{pow_p_5_8:jt(T,h5,i)*r%i,b2:a}}function dF(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}const p5=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function hF(r,e){const t=$g,n=cn(e*e*e,t),s=cn(n*n*e,t),i=fF(r*s).pow_p_5_8;let o=cn(r*n*i,t);const a=cn(e*o*o,t),c=o,l=cn(o*p5,t),h=a===r,f=a===cn(-r,t),p=a===cn(-r*p5,t);return h&&(o=c),(f||p)&&(o=l),jU(o,t)&&(o=cn(-o,t)),{isValid:h||f,value:o}}const pF=iF(uF,{uvRatio:hF});function gF(r){return oF(pF,UU,Object.assign({adjustScalarBytes:dF},r))}const mF=gF({});let g5=class extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}},yF=class extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}};var Ul={get(r=globalThis){const e=r.crypto;if(e?.subtle==null)throw new yF("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};const t_=32;let G0;const bF=(async()=>{try{return await Ul.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();async function wF(r,e,t){if(r.buffer instanceof ArrayBuffer){const n=await Ul.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await Ul.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function _F(r,e,t){return mF.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function EF(r,e,t){return G0==null&&(G0=await bF),G0?wF(r,e,t):_F(r,e,t)}function n_(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}let vF=class{type="Ed25519";raw;constructor(e){this.raw=r_(e,t_)}toMultihash(){return Kt.digest(t1(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();const s=EF(this.raw,t,e);return n_(s)?s.then(i=>(n?.signal?.throwIfAborted(),i)):s}};function xF(r){return r=r_(r,t_),new vF(r)}function r_(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new vu(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}var cr;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(cr||(cr={}));var D3;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(D3||(D3={}));(function(r){r.codec=()=>Rn(D3)})(cr||(cr={}));var Fl;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),cr.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=cr.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(Fl||(Fl={}));var m5;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),cr.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=cr.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(m5||(m5={}));function SF(r){if(isNaN(r)||r<=0)throw new vu("random bytes length must be a Number bigger than 0");return Xh(r)}let AF=class{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=RF(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return nt.createV1(114,this._multihash)}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){return qF(this.jwk,t,e,n)}};const IF=18,TF=1062,kF=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function CF(r){const e=Yh(r[1],{offset:0});return{kty:"RSA",n:Le(e[0],"base64url"),e:Le(e[1],"base64url")}}function RF(r){if(r.n==null||r.e==null)throw new vu("JWK was missing components");return tl([kF,Cw(tl([k3(Ge(r.n,"base64url")),k3(Ge(r.e,"base64url"))]))]).subarray()}function PF(r,e){if(r.byteLength>=TF)throw new kw("Key size is too large");const t=Yh(r,{offset:0});return DF(t,r,e)}function DF(r,e,t){const n=CF(r);if(t==null){const s=Ow(Fl.encode({Type:cr.RSA,Data:e}));t=Ms(IF,s)}return new AF(n,t)}async function qF(r,e,t,n){const s=await Ul.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();const i=await Ul.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),i}let s_=class{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(e,t){if(Rw(e),vt(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const n=this.blockLen,s=new Uint8Array(n);s.set(t.length>n?e.create().update(t).digest():t);for(let i=0;i<s.length;i++)s[i]^=54;this.iHash.update(s),this.oHash=e.create();for(let i=0;i<s.length;i++)s[i]^=106;this.oHash.update(s),sc(s)}update(e){return zd(this),this.iHash.update(e),this}digestInto(e){zd(this),vt(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||=Object.create(Object.getPrototypeOf(this),{});const{oHash:t,iHash:n,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const i_=(r,e,t)=>new s_(r,e).update(t).digest();i_.create=(r,e)=>new s_(r,e);const y5=(r,e)=>(r+(r>=0?e:-e)/o_)/e;function BF(r,e,t){const[[n,s],[i,o]]=e,a=y5(o*r,t),c=y5(-s*r,t);let l=r-a*n-c*i,h=-a*s-c*o;const f=l<Ps,p=h<Ps;f&&(l=-l),p&&(h=-h);const m=Lg(Math.ceil(HU(t)/2))+Pa;if(l<Ps||l>=m||h<Ps||h>=m)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:f,k1:l,k2neg:p,k2:h}}function q3(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function Z0(r,e){const t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return Po(t.lowS,"lowS"),Po(t.prehash,"prehash"),t.format!==void 0&&q3(t.format),t}let LF=class extends Error{constructor(e=""){super(e)}};const Ai={Err:LF,_tlv:{encode:(r,e)=>{const{Err:t}=Ai;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const n=e.length/2,s=xf(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");const i=n>127?xf(s.length/2|128):"";return xf(r)+i+s+e},decode(r,e){const{Err:t}=Ai;let n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");const s=e[n++],i=!!(s&128);let o=0;if(!i)o=s;else{const c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const l=e.subarray(n,n+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const h of l)o=o<<8|h;if(n+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const a=e.subarray(n,n+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+o)}}},_int:{encode(r){const{Err:e}=Ai;if(r<Ps)throw new e("integer: negative integers are not allowed");let t=xf(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){const{Err:e}=Ai;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Jh(r)}},toSig(r){const{Err:e,_int:t,_tlv:n}=Ai,s=vt(r,void 0,"signature"),{v:i,l:o}=n.decode(48,s);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=n.decode(2,i),{v:l,l:h}=n.decode(2,c);if(h.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(r){const{_tlv:e,_int:t}=Ai,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),i=n+s;return e.encode(48,i)}},Ps=BigInt(0),Pa=BigInt(1),o_=BigInt(2),Sf=BigInt(3),OF=BigInt(4);function $F(r,e={}){const t=Jw("weierstrass",r,e),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o,n:a}=i;Au(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});const{endo:c}=e;if(c&&(!n.is0(i.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const l=c_(n,s);function h(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function f(U,y,b){const{x:g,y:C}=y.toAffine(),B=n.toBytes(g);if(Po(b,"isCompressed"),b){h();const M=!n.isOdd(C);return es(a_(M),B)}else return es(Uint8Array.of(4),B,n.toBytes(C))}function p(U){vt(U,void 0,"Point");const{publicKey:y,publicKeyUncompressed:b}=l,g=U.length,C=U[0],B=U.subarray(1);if(g===y&&(C===2||C===3)){const M=n.fromBytes(B);if(!n.isValid(M))throw new Error("bad point: is not on curve, wrong x");const O=R(M);let $;try{$=n.sqrt(O)}catch(de){const ce=de instanceof Error?": "+de.message:"";throw new Error("bad point: is not on curve, sqrt error"+ce)}h();const V=n.isOdd($);return(C&1)===1!==V&&($=n.neg($)),{x:M,y:$}}else if(g===b&&C===4){const M=n.BYTES,O=n.fromBytes(B.subarray(0,M)),$=n.fromBytes(B.subarray(M,M*2));if(!T(O,$))throw new Error("bad point: is not on curve");return{x:O,y:$}}else throw new Error(`bad point: got length ${g}, expected compressed=${y} or uncompressed=${b}`)}const m=e.toBytes||f,_=e.fromBytes||p;function R(U){const y=n.sqr(U),b=n.mul(y,U);return n.add(n.add(b,n.mul(U,i.a)),i.b)}function T(U,y){const b=n.sqr(y),g=R(U);return n.eql(b,g)}if(!T(i.Gx,i.Gy))throw new Error("bad curve params: generator point");const A=n.mul(n.pow(i.a,Sf),OF),D=n.mul(n.sqr(i.b),BigInt(27));if(n.is0(n.add(A,D)))throw new Error("bad curve params: a or b");function I(U,y,b=!1){if(!n.isValid(y)||b&&n.is0(y))throw new Error(`bad point coordinate ${U}`);return y}function q(U){if(!(U instanceof x))throw new Error("Weierstrass Point expected")}function L(U){if(!c||!c.basises)throw new Error("no endo");return BF(U,c.basises,s.ORDER)}const z=Wd((U,y)=>{const{X:b,Y:g,Z:C}=U;if(n.eql(C,n.ONE))return{x:b,y:g};const B=U.is0();y==null&&(y=B?n.ONE:n.inv(C));const M=n.mul(b,y),O=n.mul(g,y),$=n.mul(C,y);if(B)return{x:n.ZERO,y:n.ZERO};if(!n.eql($,n.ONE))throw new Error("invZ was invalid");return{x:M,y:O}}),Y=Wd(U=>{if(U.is0()){if(e.allowInfinityPoint&&!n.is0(U.Y))return;throw new Error("bad point: ZERO")}const{x:y,y:b}=U.toAffine();if(!n.isValid(y)||!n.isValid(b))throw new Error("bad point: x or y not field elements");if(!T(y,b))throw new Error("bad point: equation left != right");if(!U.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function k(U,y,b,g,C){return b=new x(n.mul(b.X,U),b.Y,b.Z),y=Gd(g,y),b=Gd(C,b),y.add(b)}class x{static BASE=new x(i.Gx,i.Gy,n.ONE);static ZERO=new x(n.ZERO,n.ONE,n.ZERO);static Fp=n;static Fn=s;X;Y;Z;constructor(y,b,g){this.X=I("x",y),this.Y=I("y",b,!0),this.Z=I("z",g),Object.freeze(this)}static CURVE(){return i}static fromAffine(y){const{x:b,y:g}=y||{};if(!y||!n.isValid(b)||!n.isValid(g))throw new Error("invalid affine point");if(y instanceof x)throw new Error("projective point not allowed");return n.is0(b)&&n.is0(g)?x.ZERO:new x(b,g,n.ONE)}static fromBytes(y){const b=x.fromAffine(_(vt(y,void 0,"point")));return b.assertValidity(),b}static fromHex(y){return x.fromBytes(Ml(y))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(y=8,b=!0){return j.createCache(this,y),b||this.multiply(Sf),this}assertValidity(){Y(this)}hasEvenY(){const{y}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(y)}equals(y){q(y);const{X:b,Y:g,Z:C}=this,{X:B,Y:M,Z:O}=y,$=n.eql(n.mul(b,O),n.mul(B,C)),V=n.eql(n.mul(g,O),n.mul(M,C));return $&&V}negate(){return new x(this.X,n.neg(this.Y),this.Z)}double(){const{a:y,b}=i,g=n.mul(b,Sf),{X:C,Y:B,Z:M}=this;let O=n.ZERO,$=n.ZERO,V=n.ZERO,G=n.mul(C,C),de=n.mul(B,B),ce=n.mul(M,M),re=n.mul(C,B);return re=n.add(re,re),V=n.mul(C,M),V=n.add(V,V),O=n.mul(y,V),$=n.mul(g,ce),$=n.add(O,$),O=n.sub(de,$),$=n.add(de,$),$=n.mul(O,$),O=n.mul(re,O),V=n.mul(g,V),ce=n.mul(y,ce),re=n.sub(G,ce),re=n.mul(y,re),re=n.add(re,V),V=n.add(G,G),G=n.add(V,G),G=n.add(G,ce),G=n.mul(G,re),$=n.add($,G),ce=n.mul(B,M),ce=n.add(ce,ce),G=n.mul(ce,re),O=n.sub(O,G),V=n.mul(ce,de),V=n.add(V,V),V=n.add(V,V),new x(O,$,V)}add(y){q(y);const{X:b,Y:g,Z:C}=this,{X:B,Y:M,Z:O}=y;let $=n.ZERO,V=n.ZERO,G=n.ZERO;const de=i.a,ce=n.mul(i.b,Sf);let re=n.mul(b,B),pe=n.mul(g,M),_e=n.mul(C,O),$e=n.add(b,g),ge=n.add(B,M);$e=n.mul($e,ge),ge=n.add(re,pe),$e=n.sub($e,ge),ge=n.add(b,C);let ke=n.add(B,O);return ge=n.mul(ge,ke),ke=n.add(re,_e),ge=n.sub(ge,ke),ke=n.add(g,C),$=n.add(M,O),ke=n.mul(ke,$),$=n.add(pe,_e),ke=n.sub(ke,$),G=n.mul(de,ge),$=n.mul(ce,_e),G=n.add($,G),$=n.sub(pe,G),G=n.add(pe,G),V=n.mul($,G),pe=n.add(re,re),pe=n.add(pe,re),_e=n.mul(de,_e),ge=n.mul(ce,ge),pe=n.add(pe,_e),_e=n.sub(re,_e),_e=n.mul(de,_e),ge=n.add(ge,_e),re=n.mul(pe,ge),V=n.add(V,re),re=n.mul(ke,ge),$=n.mul($e,$),$=n.sub($,re),re=n.mul($e,pe),G=n.mul(ke,G),G=n.add(G,re),new x($,V,G)}subtract(y){return this.add(y.negate())}is0(){return this.equals(x.ZERO)}multiply(y){const{endo:b}=e;if(!s.isValidNot0(y))throw new Error("invalid scalar: out of range");let g,C;const B=M=>j.cached(this,M,O=>nl(x,O));if(b){const{k1neg:M,k1:O,k2neg:$,k2:V}=L(y),{p:G,f:de}=B(O),{p:ce,f:re}=B(V);C=de.add(re),g=k(b.beta,G,ce,M,$)}else{const{p:M,f:O}=B(y);g=M,C=O}return nl(x,[g,C])[0]}multiplyUnsafe(y){const{endo:b}=e,g=this;if(!s.isValid(y))throw new Error("invalid scalar: out of range");if(y===Ps||g.is0())return x.ZERO;if(y===Pa)return g;if(j.hasCache(this))return this.multiply(y);if(b){const{k1neg:C,k1:B,k2neg:M,k2:O}=L(y),{p1:$,p2:V}=nF(x,g,B,O);return k(b.beta,$,V,C,M)}else return j.unsafe(g,y)}toAffine(y){return z(this,y)}isTorsionFree(){const{isTorsionFree:y}=e;return o===Pa?!0:y?y(x,this):j.unsafe(this,a).is0()}clearCofactor(){const{clearCofactor:y}=e;return o===Pa?this:y?y(x,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(y=!0){return Po(y,"isCompressed"),this.assertValidity(),m(x,this,y)}toHex(y=!0){return Su(this.toBytes(y))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const F=s.BITS,j=new Xw(x,e.endo?Math.ceil(F/2):F);return x.BASE.precompute(8),x}function a_(r){return Uint8Array.of(r?2:3)}function c_(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function MF(r,e={}){const{Fn:t}=r,n=e.randomBytes||Xh,s=Object.assign(c_(r.Fp,t),{seed:jw(t.ORDER)});function i(m){try{const _=t.fromBytes(m);return t.isValidNot0(_)}catch{return!1}}function o(m,_){const{publicKey:R,publicKeyUncompressed:T}=s;try{const A=m.length;return _===!0&&A!==R||_===!1&&A!==T?!1:!!r.fromBytes(m)}catch{return!1}}function a(m=n(s.seed)){return tF(vt(m,s.seed,"seed"),t.ORDER)}function c(m,_=!0){return r.BASE.multiply(t.fromBytes(m)).toBytes(_)}function l(m){const{secretKey:_,publicKey:R,publicKeyUncompressed:T}=s;if(!Qh(m)||"_lengths"in t&&t._lengths||_===R)return;const A=vt(m,void 0,"key").length;return A===R||A===T}function h(m,_,R=!0){if(l(m)===!0)throw new Error("first arg must be private key");if(l(_)===!1)throw new Error("second arg must be public key");const T=t.fromBytes(m);return r.fromBytes(_).multiply(T).toBytes(R)}const f={isValidSecretKey:i,isValidPublicKey:o,randomSecretKey:a},p=e_(a,c);return Object.freeze({getPublicKey:c,getSharedSecret:h,keygen:p,Point:r,utils:f,lengths:s})}function NF(r,e,t={}){Rw(e),Au(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),t=Object.assign({},t);const n=t.randomBytes||Xh,s=t.hmac||((b,g)=>i_(e,b,g)),{Fp:i,Fn:o}=r,{ORDER:a,BITS:c}=o,{keygen:l,getPublicKey:h,getSharedSecret:f,utils:p,lengths:m}=MF(r,t),_={prehash:!0,lowS:typeof t.lowS=="boolean"?t.lowS:!0,format:"compact",extraEntropy:!1},R=a*o_<i.ORDER;function T(b){const g=a>>Pa;return b>g}function A(b,g){if(!o.isValidNot0(g))throw new Error(`invalid signature ${b}: out of range 1..Point.Fn.ORDER`);return g}function D(){if(R)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function I(b,g){q3(g);const C=m.signature,B=g==="compact"?C:g==="recovered"?C+1:void 0;return vt(b,B)}class q{r;s;recovery;constructor(g,C,B){if(this.r=A("r",g),this.s=A("s",C),B!=null){if(D(),![0,1,2,3].includes(B))throw new Error("invalid recovery id");this.recovery=B}Object.freeze(this)}static fromBytes(g,C=_.format){I(g,C);let B;if(C==="der"){const{r:V,s:G}=Ai.toSig(vt(g));return new q(V,G)}C==="recovered"&&(B=g[0],C="compact",g=g.subarray(1));const M=m.signature/2,O=g.subarray(0,M),$=g.subarray(M,M*2);return new q(o.fromBytes(O),o.fromBytes($),B)}static fromHex(g,C){return this.fromBytes(Ml(g),C)}assertRecovery(){const{recovery:g}=this;if(g==null)throw new Error("invalid recovery id: must be present");return g}addRecoveryBit(g){return new q(this.r,this.s,g)}recoverPublicKey(g){const{r:C,s:B}=this,M=this.assertRecovery(),O=M===2||M===3?C+a:C;if(!i.isValid(O))throw new Error("invalid recovery id: sig.r+curve.n != R.x");const $=i.toBytes(O),V=r.fromBytes(es(a_((M&1)===0),$)),G=o.inv(O),de=z(vt(g,void 0,"msgHash")),ce=o.create(-de*G),re=o.create(B*G),pe=r.BASE.multiplyUnsafe(ce).add(V.multiplyUnsafe(re));if(pe.is0())throw new Error("invalid recovery: point at infinify");return pe.assertValidity(),pe}hasHighS(){return T(this.s)}toBytes(g=_.format){if(q3(g),g==="der")return Ml(Ai.hexFromSig(this));const{r:C,s:B}=this,M=o.toBytes(C),O=o.toBytes(B);return g==="recovered"?(D(),es(Uint8Array.of(this.assertRecovery()),M,O)):es(M,O)}toHex(g){return Su(this.toBytes(g))}}const L=t.bits2int||function(g){if(g.length>8192)throw new Error("input is too large");const C=Jh(g),B=g.length*8-c;return B>0?C>>BigInt(B):C},z=t.bits2int_modN||function(g){return o.create(L(g))},Y=Lg(c);function k(b){return P3("num < 2^"+c,b,Ps,Y),o.toBytes(b)}function x(b,g){return vt(b,void 0,"message"),g?vt(e(b),void 0,"prehashed message"):b}function F(b,g,C){const{lowS:B,prehash:M,extraEntropy:O}=Z0(C,_);b=x(b,M);const $=z(b),V=o.fromBytes(g);if(!o.isValidNot0(V))throw new Error("invalid private key");const G=[k(V),k($)];if(O!=null&&O!==!1){const pe=O===!0?n(m.secretKey):O;G.push(vt(pe,void 0,"extraEntropy"))}const de=es(...G),ce=$;function re(pe){const _e=L(pe);if(!o.isValidNot0(_e))return;const $e=o.inv(_e),ge=r.BASE.multiply(_e).toAffine(),ke=o.create(ge.x);if(ke===Ps)return;const ht=o.create($e*o.create(ce+ke*V));if(ht===Ps)return;let qt=(ge.x===ke?0:2)|Number(ge.y&Pa),$t=ht;return B&&T(ht)&&($t=o.neg(ht),qt^=1),new q(ke,$t,R?void 0:qt)}return{seed:de,k2sig:re}}function j(b,g,C={}){const{seed:B,k2sig:M}=F(b,g,C);return VU(e.outputLen,o.BYTES,s)(B,M).toBytes(C.format)}function U(b,g,C,B={}){const{lowS:M,prehash:O,format:$}=Z0(B,_);if(C=vt(C,void 0,"publicKey"),g=x(g,O),!Qh(b)){const V=b instanceof q?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+V)}I(b,$);try{const V=q.fromBytes(b,$),G=r.fromBytes(C);if(M&&V.hasHighS())return!1;const{r:de,s:ce}=V,re=z(g),pe=o.inv(ce),_e=o.create(re*pe),$e=o.create(de*pe),ge=r.BASE.multiplyUnsafe(_e).add(G.multiplyUnsafe($e));return ge.is0()?!1:o.create(ge.x)===de}catch{return!1}}function y(b,g,C={}){const{prehash:B}=Z0(C,_);return g=x(g,B),q.fromBytes(b,"recovered").recoverPublicKey(g).toBytes()}return Object.freeze({keygen:l,getPublicKey:h,getSharedSecret:f,utils:p,lengths:m,Point:r,sign:j,verify:U,recoverPublicKey:y,Signature:q,hash:e})}const Mg={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},UF={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},b5=BigInt(2);function FF(r){const e=Mg.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,h=l*l*r%e,f=jt(h,t,e)*h%e,p=jt(f,t,e)*h%e,m=jt(p,b5,e)*l%e,_=jt(m,s,e)*m%e,R=jt(_,i,e)*_%e,T=jt(R,a,e)*R%e,A=jt(T,c,e)*T%e,D=jt(A,a,e)*R%e,I=jt(D,t,e)*h%e,q=jt(I,o,e)*_%e,L=jt(q,n,e)*l%e,z=jt(L,b5,e);if(!B3.eql(B3.sqr(z),r))throw new Error("Cannot find square root");return z}const B3=e1(Mg.p,{sqrt:FF}),HF=$F(Mg,{Fp:B3,endo:UF}),Zd=NF(HF,Ow);function VF(r,e,t,n){const s=$r.digest(t instanceof Uint8Array?t:t.subarray());if(n_(s))return s.then(({digest:i})=>(n?.signal?.throwIfAborted(),Zd.verify(e,i,r,{prehash:!1,format:"der"}))).catch(i=>{throw i.name==="AbortError"?i:new g5(String(i))});try{return n?.signal?.throwIfAborted(),Zd.verify(e,s.digest,r,{prehash:!1,format:"der"})}catch(i){throw new g5(String(i))}}let KF=class{type="secp256k1";raw;_key;constructor(e){this._key=GF(e),this.raw=WF(this._key)}toMultihash(){return Kt.digest(t1(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){return VF(this._key,t,e,n)}};function zF(r){return new KF(r)}function WF(r){return Zd.Point.fromBytes(r).toBytes()}function GF(r){try{return Zd.Point.fromBytes(r),r}catch(e){throw new kw(String(e))}}function l_(r,e){const{Type:t,Data:n}=Fl.decode(r),s=n??new Uint8Array;switch(t){case cr.RSA:return PF(s,e);case cr.Ed25519:return xF(s);case cr.secp256k1:return zF(s);case cr.ECDSA:return yU(s);default:throw new tU}}function t1(r){return Fl.encode({Type:cr[r.type],Data:r.raw})}async function Ng(r,e,t){const n=e.key,i=Le(n).split("/");if(i.length<3)return;const o=r[i[1].toString()];if(o==null)throw new ot(`No validator available for key type "${i[1]}"`);await o(n,e.value,t)}const ZF=async(r,e,t)=>{if(!(r instanceof Uint8Array))throw new ot('"key" must be a Uint8Array');if(r.byteLength<5)throw new ot("Invalid public key record");if(Le(r.subarray(0,4))!=="/pk/")throw new ot("key was not prefixed with /pk/");const s=l_(e),i=r.slice(4);if(!at(i,s.toMultihash().bytes))throw new ot("public key does not match passed in key")},jF={pk:ZF},YF=Ge("/pk/");function QF(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{const[[t,n]]=e.stringTuples();if(t===53||t===54||t===55)return n!=="localhost";if(t!==4&&t!==6||n==null)return!1;const s=Ho(n);return s==null?!0:!s})}}async function Hl(r,e){const t=await $r.digest(r);return e?.signal?.throwIfAborted(),t.digest}async function Ls(r,e){return Hl(r.toMultihash().bytes,e)}function rl(r,e){return new En(`${r}/${Le(e,"base32")}`,!1)}function XF(r){return is([YF,r.toMultihash().bytes])}function JF(r){return Le(r.subarray(0,4))==="/pk/"}function eH(r){const e=Gn(r.subarray(4));return mr(e)}function w5(r,e){const t=new Date;return new Ir(r,e,t).serialize()}const tH=290,nH=54,rH=55,sH=56,iH=4,oH=41;function aH(r){const e=r.stringTuples();for(const t of e)if(t[0]===tH)return!1;if(e[0][0]===nH||e[0][0]===rH||e[0][0]===sH)return!0;if(e[0][0]===iH||e[0][0]===oH){const t=Ho(`${e[0][1]}`);return t==null||!t}return!1}function u_(r){const e=r.toString().split("/"),t=e.pop(),n=e.pop();if(t==null||n==null)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:nt.createV1(MS,Gn(Ge(n,"base32"))),peerId:Vn(t)}}function j0(r,e,t){const n=typeof e=="string"?e:Le(e.multihash.bytes,"base32"),s=[r,n];return t!=null&&s.push(t.toString()),new En(s.join("/"))}function f_(r){return new Date(mc(r))}function aa(r,e,t){return async function*(...n){const s=e.queryTime?.timer(t),i=e.errorTime?.timer(t);let o=!1;try{e.queries?.increment({[t]:!0}),yield*r(...n)}catch(a){throw o=!0,i?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),o||s?.()}}}function d_(r,e,t){return async function(...n){const s=e?.queryTime?.timer(t),i=e?.errorTime?.timer(t);let o=!1;try{return e.queries?.increment({[t]:!0}),await r(...n)}catch(a){throw o=!0,i?.(),e.errors?.increment({[t]:!0}),a}finally{e.queries?.decrement({[t]:!0}),o||s?.()}}}class cH{log;components;validators;selectors;peerRouting;queryManager;network;datastorePrefix;constructor(e,t){const{validators:n,selectors:s,peerRouting:i,queryManager:o,network:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-fetching`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n,this.selectors=s,this.peerRouting=i,this.queryManager=o,this.network=a,this.get=e.metrics?.traceFunction("libp2p.kadDHT.get",this.get.bind(this),{optionsIndex:1})??this.get,this.put=e.metrics?.traceFunction("libp2p.kadDHT.put",this.put.bind(this),{optionsIndex:2})??this.put}async getLocal(e,t){this.log("getLocal %b",e);const n=rl(this.datastorePrefix,e);this.log("fetching record for key %k",n);const s=await this.components.datastore.get(n,t);this.log("found %k in local datastore",n);const i=Ir.deserialize(s);return await Ng(this.validators,i,t),i}async*sendCorrectionRecord(e,t,n,s){this.log("sendCorrection for %b",e);const i=w5(e,n);for(const{value:o,from:a}of t){if(at(o,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{const h=rl(this.datastorePrefix,e);this.log(`Storing corrected record for key ${h.toString()}`),await this.components.datastore.put(h,i.subarray(),s)}catch(h){this.log.error("Failed error correcting self",h)}continue}let c=!1;const l={type:Ht.PUT_VALUE,key:e,record:i};for await(const h of this.network.sendRequest(a,l,s))h.name==="PEER_RESPONSE"&&h.record!=null&&at(h.record.value,Ir.deserialize(i).value)&&(c=!0),yield h;if(!c)throw new Vd("Could not send correction");this.log.error("Failed error correcting entry")}}async*put(e,t,n){this.log("put key %b value %b",e,t);const s=w5(e,t),i=rl(this.datastorePrefix,e);this.log(`storing record for key ${i.toString()}`),await this.components.datastore.put(i,s.subarray(),n),yield*Ar(this.peerRouting.getClosestPeers(e,{...n,signal:n.signal}),o=>to(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[],l={type:Ht.PUT_VALUE,key:e,record:s};this.log("send put to %p",a.peer.id);for await(const h of this.network.sendRequest(a.peer.id,l,{...n,path:a.path}))c.push(h),h.name==="PEER_RESPONSE"&&(h.record!=null&&at(h.record.value,Ir.deserialize(s).value)||c.push(rc({from:a.peer.id,error:new Vd("Value not put correctly"),path:h.path},n)));return c}),o=>kg(o,{ordered:!1,concurrency:jh}),async function*(o){for await(const a of o)yield*a})}async*get(e,t){this.log("get %b",e);const n=[];for await(const a of this.getMany(e,t)){if(a.name==="VALUE"){n.push(a);continue}yield a}if(n.length===0)return;const s=n.map(a=>a.value);let i=0;try{i=XN(this.selectors,e,s)}catch(a){if(a.name!=="InvalidParametersError")throw a}const o=s[i];if(this.log("GetValue %b %b",e,o),o==null)throw new qi("Best value was not found");yield*this.sendCorrectionRecord(e,n,o,{...t,path:{index:-1,queued:0,running:0,total:0}}),yield n[i]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const i=await this.getLocal(e,t);yield I3({value:i.value,from:this.components.peerId,path:{index:-1,running:0,queued:0,total:0}},t)}catch(i){this.log("error getting local value for %b",e,i)}const n=this,s=async function*({peer:i,signal:o,path:a}){for await(const c of n.peerRouting.getValueOrPeers(i.id,e,{...t,signal:o,path:a}))yield c,c.name==="PEER_RESPONSE"&&c.record!=null&&(yield I3({from:i.id,value:c.record.value,path:a},t))};yield*this.queryManager.run(e,s,t)}}function lH(r,e){return{id:r.id.toMultihash().bytes,multiaddrs:(r.multiaddrs??[]).map(n=>n.bytes),connection:e}}function Af(r){if(r.id==null)throw new Error("Invalid peer in message");const e=Gn(r.id);return{id:mr(e),multiaddrs:(r.multiaddrs??[]).map(t=>lt(t))}}class uH{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){const{network:n,peerRouting:s,queryManager:i,routingTable:o,providers:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-routing`),this.network=n,this.peerRouting=s,this.queryManager=i,this.routingTable=o,this.providers=a,this.findProviders=e.metrics?.traceFunction("libp2p.kadDHT.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,h)=>(l.name==="PROVIDER"&&(h.providers??=[],h.providers.push(...l.providers.map(f=>f.id.toString()))),h)})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.kadDHT.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(l,h)=>(l.name==="PEER_RESPONSE"&&l.messageName==="ADD_PROVIDER"&&(h.providers??=[],h.providers.push(l.from.toString())),h)})??this.provide}async*provide(e,t,n={}){this.log("provide %s",e);const s=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId,n);const i={type:Ht.ADD_PROVIDER,key:s,providers:[lH({id:this.components.peerId,multiaddrs:t})]};let o=0;const a=this;async function*c(f){try{a.log("sending provider record for %s to %p",e,f.peer.id);for await(const p of a.network.sendMessage(f.peer.id,i,{...n,path:f.path}))p.name==="PEER_RESPONSE"&&(a.log("sent provider record for %s to %p",e,f.peer.id),o++),yield p}catch(p){a.log.error("error sending provide record to peer %p",f.peer.id,p),yield rc({from:f.peer.id,error:p,path:f.path},n)}}const l=Or({objectMode:!0}),h=new _u({concurrency:jh});h.addEventListener("idle",()=>{l.end()}),h.addEventListener("failure",f=>{this.log.error("error publishing provider record to peer - %e",f.detail.error)}),h.add(async()=>{const f=[];for await(const p of this.peerRouting.getClosestPeers(s,n))l.push(p),p.name==="FINAL_PEER"&&f.push(p);f.forEach(p=>{h.add(async()=>{for await(const m of c(p))l.push(m)}).catch(m=>{this.log.error("error publishing provider record to peer - %e",m)})})}).catch(f=>{l.end(f)}),yield*l,this.log("sent provider records to %d peers",o)}async*findProviders(e,t){const n=this.routingTable.kBucketSize;let s=0;const i=e.multihash.bytes,o=this;this.log("findProviders %c",e);const a=await this.providers.getProviders(e,t);if(a.length>0){const h=[];for(const f of a.slice(0,n))try{const p=await this.components.peerStore.get(f,t);h.push({id:f,multiaddrs:p.addresses.map(({multiaddr:m})=>m)})}catch(p){if(p.name!=="NotFoundError")throw p;this.log("no peer store entry for %p",f)}if(yield A3({from:this.components.peerId,messageType:Ht.GET_PROVIDERS,providers:h,path:{index:-1,queued:0,running:0,total:0}},t),yield t5({from:this.components.peerId,providers:h,path:{index:-1,queued:0,running:0,total:0}},t),s+=h.length,s>=n)return}const c=async function*({peer:h,signal:f,path:p}){const m={type:Ht.GET_PROVIDERS,key:i};yield*o.network.sendRequest(h.id,m,{...t,signal:f,path:p})},l=new rs(a);for await(const h of this.queryManager.run(i,c,t))if(yield h,h.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",h.providers.length,e,h.closer.length);const f=[];for(const p of h.providers)l.has(p.id)||(l.add(p.id),f.push(p));if(f.length>0&&(yield t5({from:h.from,providers:f,path:h.path},t),s+=f.length,s>=n))return}}}class fH extends Cn{log;protocol;running;components;timeout;metrics;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:network`),this.running=!1,this.protocol=t.protocol,this.timeout=new Ll({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_network_message_send_times_milliseconds`}),this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_errors_total`)},this.sendRequest=e.metrics?.traceFunction("libp2p.kadDHT.sendRequest",this.sendRequest.bind(this),{optionsIndex:2,getAttributesFromArgs([n,s],i){return{...i,to:n.toString(),"message type":`${s.type}`}},getAttributesFromYieldedValue:(n,s)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((i,o)=>{s[`providers-${o}`]=i.id.toString()}),n.closer.length>0&&n.closer.forEach((i,o)=>{s[`closer-${o}`]=i.id.toString()})),s)})??this.sendRequest,this.sendMessage=e.metrics?.traceFunction("libp2p.kadDHT.sendMessage",this.sendMessage.bind(this),{optionsIndex:2,getAttributesFromArgs([n,s],i){return{...i,to:n.toString(),"message type":`${s.type}`}},getAttributesFromYieldedValue:(n,s)=>(n.name==="PEER_RESPONSE"&&(n.providers.length>0&&n.providers.forEach((i,o)=>{s[`providers-${o}`]=i.id.toString()}),n.closer.length>0&&n.closer.forEach((i,o)=>{s[`closer-${o}`]=i.id.toString()})),s)})??this.sendMessage}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n){if(!this.running)return;const s=t.type;if(s==null)throw new ot("Message type was missing");let i;const o=this.timeout.getTimeoutSignal(n);n={...n,signal:o};try{this.metrics.operations?.increment({[s]:!0}),this.log("dialling %p",e),yield n5({peer:e,path:n.path},n),i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),this.log("sending %s to %p",t.type,e),yield e5({to:e,type:s,path:n.path},n);const c=await this._writeReadMessage(i,t,n);i.close(n).catch(l=>{this.log.error("error closing stream to %p",e,l),i?.abort(l)}),yield A3({from:e,messageType:c.type,closer:c.closer.map(Af),providers:c.providers.map(Af),record:c.record==null?void 0:Ir.deserialize(c.record),path:n.path},n)}catch(a){this.metrics.errors?.increment({[s]:!0}),i?.abort(a),n.signal?.aborted!==!0&&this.log.error("could not send %s to %p - %e",t.type,e,a),yield rc({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(o)}}async*sendMessage(e,t,n){if(!this.running)return;const s=t.type;if(s==null)throw new ot("Message type was missing");let i;const o=this.timeout.getTimeoutSignal(n);n={...n,signal:o};try{this.metrics.operations?.increment({[s]:!0}),this.log("dialling %p",e),yield n5({peer:e,path:n.path},n),i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),this.log("sending %s to %p",t.type,e),yield e5({to:e,type:s,path:n.path},n),await this._writeMessage(i,t,n),i.close(n).catch(c=>{this.log.error("error closing stream to %p",e,c),i?.abort(c)}),yield A3({from:e,messageType:s,path:n.path},n)}catch(a){this.metrics.errors?.increment({[s]:!0}),i?.abort(a),yield rc({from:e,error:a,path:n.path},n)}finally{this.timeout.cleanUp(o)}}async _writeMessage(e,t,n){await gr(e).write(t,Ra,n)}async _writeReadMessage(e,t,n){const s=gr(e);await s.write(t,Ra,n);const i=await s.read(Ra,n);return i.closer.forEach(o=>{this.safeDispatchEvent("peer",{detail:Af(o)})}),i.providers.forEach(o=>{this.safeDispatchEvent("peer",{detail:Af(o)})}),i}}function oc(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");const t=Tr(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return t}function sl(r,e){if(r.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}class Ug{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return[...this.peerDistances]}async add(e,t={index:-1,queued:0,running:0,total:0},n){const s=await Ls(e.id,n);this.addWithKadId(e,s,t)}addWithKadId(e,t,n={index:-1,queued:0,running:0,total:0}){if(this.peerDistances.find(o=>o.peer.id.equals(e.id))!=null)return;const s={peer:e,distance:oc(this.originDhtKey,t),path:n};if(this.peerDistances.length===this.capacity){const o=this.peerDistances[this.peerDistances.length-1];if(o!=null&&sl(s.distance,o.distance)!==-1)return}let i=!1;for(let o=0;o<this.peerDistances.length;o++){const a=sl(this.peerDistances[o].distance,s.distance);if(a===0||a===1){i=!0,this.peerDistances.splice(o,0,s);break}}i||this.peerDistances.push(s),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e,t){if(this.length===0)return!0;const n=await Ls(e,t),s=oc(n,this.originDhtKey),i=this.peerDistances[this.peerDistances.length-1].distance;return sl(s,i)===-1}async anyCloser(e,t){return e.length===0?!1:Promise.any(e.map(async n=>this.isCloser(n,t)))}}class dH{log;routingTable;network;validators;queryManager;components;constructor(e,t){this.routingTable=t.routingTable,this.network=t.network,this.validators=t.validators,this.queryManager=t.queryManager,this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:peer-routing`),this.findPeer=e.metrics?.traceFunction("libp2p.kadDHT.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.kadDHT.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async findPeerLocal(e,t){let n;const s=await this.routingTable.find(e,t);if(s!=null){this.log("findPeerLocal found %p in routing table",e);try{n=await this.components.peerStore.get(s,t)}catch(i){if(i.name!=="NotFoundError")throw i}}if(n==null)try{n=await this.components.peerStore.get(e,t)}catch(i){if(i.name!=="NotFoundError")throw i}if(n!=null)return this.log("findPeerLocal found %p in peer store",e),{id:n.id,multiaddrs:n.addresses.map(i=>i.multiaddr)}}async*_getValueSingle(e,t,n){const s={type:Ht.GET_VALUE,key:t};yield*this.network.sendRequest(e,s,n)}async*getPublicKeyFromNode(e,t={}){const n=XF(e),s={index:-1,queued:0,running:0,total:0};for await(const i of this._getValueSingle(e,n,{...t,path:s}))if(yield i,i.name==="PEER_RESPONSE"&&i.record!=null){const o=l_(i.record.value),a=Ua(o);if(!a.equals(e))throw new md("public key does not match id");if(a.publicKey==null)throw new md("public key missing");yield I3({from:e,value:i.record.value,path:s},t)}throw new Vd(`Node not responding with its public key: ${e.toString()}`)}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){const s=await this.findPeerLocal(e,t);if(s!=null){this.log("found local"),yield $0({from:this.components.peerId,peer:s,path:{index:-1,queued:0,running:0,total:0}},t);return}}let n=!1;if(t.useNetwork!==!1){const s=this,i=async function*({peer:o,signal:a,path:c}){const l={type:Ht.FIND_NODE,key:e.toMultihash().bytes};for await(const h of s.network.sendRequest(o.id,l,{...t,signal:a,path:c}))if(yield h,h.name==="PEER_RESPONSE"){const f=h.closer.find(p=>p.id.equals(e));f!=null&&(yield $0({from:h.from,peer:f,path:h.path},t))}};for await(const o of this.queryManager.run(e.toMultihash().bytes,i,t))o.name==="FINAL_PEER"&&(n=!0),yield o}if(!n)throw new qi("Not found")}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const n=await Hl(e,t),s=new Ug(n,this.routingTable.kBucketSize),i=this,o=async function*({peer:a,path:c,peerKadId:l,signal:h}){i.log("getClosestPeers asking %p",a.id);const f={type:Ht.FIND_NODE,key:e};yield*i.network.sendRequest(a.id,f,{...t,signal:h,path:c}),s.addWithKadId(a,l,c)};yield*this.queryManager.run(e,o,t),this.log("found %d peers close to %b",s.length,e);for(let{peer:a,path:c}of s.peers)try{if(a.multiaddrs.length===0&&(a=await i.components.peerStore.getInfo(a.id,t)),a.multiaddrs.length===0)continue;yield $0({from:this.components.peerId,peer:await i.components.peerStore.getInfo(a.id,t),path:{index:c.index,queued:0,running:0,total:0}},t)}catch{continue}}async*getValueOrPeers(e,t,n){for await(const s of this._getValueSingle(e,t,n)){if(s.name==="PEER_RESPONSE"&&s.record!=null)try{await this._verifyRecordOnline(s.record,n)}catch{const o="invalid record received, discarded";this.log(o),yield rc({from:s.from,error:new Vd(o),path:n.path},n);continue}yield s}}async _verifyRecordOnline(e,t){if(e.timeReceived==null)throw new jN("invalid record received");await Ng(this.validators,new Ir(e.key,e.value,e.timeReceived),t)}async getClosestPeersOffline(e,t){const n=[];try{const o=Gn(e),a=mr(o),c=await this.components.peerStore.get(a,t);n.push({id:c.id,multiaddrs:c.addresses.map(({multiaddr:l})=>l)})}catch{}const s=await Hl(e,t),i=this.routingTable.closestPeers(s,t);for(const o of i)try{n.push(await this.components.peerStore.getInfo(o,t))}catch(a){if(a.name!=="NotFoundError")throw a}return n.length>0?this.log("getClosestPeersOffline returning the %d closest peer(s) %b we know",n.length,e):this.log("getClosestPeersOffline could not any peers close to %b with %d peers in the routing table",e,this.routingTable.size),n}}class hH{log;datastore;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:providers`),this.datastorePrefix=`${t.datastorePrefix}/provider`,this.datastore=e.datastore}async addProvider(e,t,n){this.log.trace("%p provides %s",t,e),await this.writeProviderEntry(e,t,n)}async removeProvider(e,t,n){const s=j0(this.datastorePrefix,e,t);this.log.trace("%p no longer provides %s",t,e),await this.datastore.delete(s,n)}async getProviders(e,t){this.log.trace("get providers for %c",e);const n=await this.loadProviders(e,t);return this.log.trace("got %d providers for %c",n.size,e),[...n.keys()]}async writeProviderEntry(e,t,n){const s=j0(this.datastorePrefix,e,t),i=Ri(n?.time?.getTime()??Date.now());await this.datastore.put(s,i,n)}async loadProviders(e,t){const n=new Fo,s=j0(this.datastorePrefix,e);for await(const i of this.datastore.query({prefix:s.toString()},t)){const{peerId:o}=u_(i.key);n.set(o,f_(i.value))}return n}}class pH extends Error{constructor(e){super(e),this.name="TimeoutError"}}let gH=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const _5=r=>globalThis.DOMException===void 0?new gH(r):new DOMException(r),E5=r=>{const e=r.reason===void 0?_5("This operation was aborted."):r.reason;return e instanceof Error?e:_5(e)};function mH(r,e){const{milliseconds:t,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout}}=e;let o,a;const l=new Promise((h,f)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:m}=e;m.aborted&&f(E5(m)),a=()=>{f(E5(m))},m.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(h,f);return}const p=new pH;o=i.setTimeout.call(void 0,()=>{if(n){try{h(n())}catch(m){f(m)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?h():s instanceof Error?f(s):(p.message=s??`Promise timed out after ${t} milliseconds`,f(p))},t),(async()=>{try{h(await r)}catch(m){f(m)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},l}const yH=r=>{const e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function bH(r,e,t){let n;const s=new Promise((i,o)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();const a=[e].flat(),c=[],{addListener:l,removeListener:h}=yH(r),f=(...m)=>{const _=t.multiArgs?m:m[0];t.filter&&!t.filter(_)||(c.push(_),t.count===c.length&&(n(),i(c)))},p=m=>{n(),o(m)};n=()=>{for(const m of a)h(m,f);for(const m of t.rejectionEvents)h(m,p)};for(const m of a)l(m,f);for(const m of t.rejectionEvents)l(m,p);t.signal&&t.signal.addEventListener("abort",()=>{p(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(s.cancel=n,typeof t.timeout=="number"){const i=mH(s,{milliseconds:t.timeout});return i.cancel=n,i}return s}function wH(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const n=bH(r,e,t),s=n.then(i=>i[0]);return s.cancel=n.cancel,s}async function*_H(r){const{key:e,startingPeers:t,ourPeerId:n,query:s,alpha:i,path:o,numPaths:a,log:c,peersSeen:l,connectionManager:h,signal:f}=r,p=Or({objectMode:!0}),m=new _u({concurrency:i,sort:(R,T)=>sl(R.options.distance,T.options.distance)});m.addEventListener("idle",()=>{p.push(QN({path:{index:o,queued:m.queued,running:m.running,total:m.size}},r)),p.end()}),m.addEventListener("failure",R=>{c.error("error during query - %e",R.detail.error)});const _=()=>{m.abort(),p.end(new Di)};f.addEventListener("abort",_);try{let T=function(A,D){if(A==null)return;l.add(A.id.toMultihash().bytes);const I=oc(D,R);m.add(async()=>{try{for await(const q of s({...r,key:e,peer:A,path:{index:o,queued:m.queued,running:m.running,total:m.size},numPaths:a,peerKadId:D,signal:f})){if(q.name==="PEER_RESPONSE")for(const L of q.closer){if(l.has(L.id.toMultihash().bytes)){c("already seen %p in query",L.id);continue}if(n.equals(L.id)){c("not querying ourselves");continue}if(!await h.isDialable(L.multiaddrs)){c("not querying undialable peer");continue}const z=await Ls(L.id,{signal:f}),Y=oc(z,R);if(sl(Y,I)!==-1){c("skipping %p as they are not closer to %b than %p",L.id,e,A);continue}c("querying closer peer %p",L.id),T(L,z)}p.push({...q,path:{index:o,queued:m.queued,running:m.running,total:m.size}})}}catch(q){p.push(rc({from:A.id,error:q,path:{index:o,queued:m.queued,running:m.running-1,total:m.size-1}},r))}},{distance:I}).catch(q=>{c.error("error during query - %e",q)})};const R=await Hl(e,{signal:f});await Promise.all(t.map(async A=>{T({id:A,multiaddrs:[]},await Ls(A,{signal:f}))})),yield*p}finally{f.removeEventListener("abort",_)}}class EH{disjointPaths;alpha;shutDownController;running;logger;peerId;connectionManager;routingTable;initialQuerySelfHasRun;logPrefix;allowQueryWithZeroPeers;constructor(e,t){this.logPrefix=t.logPrefix,this.disjointPaths=t.disjointPaths??Tw,this.alpha=t.alpha??jh,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.allowQueryWithZeroPeers=t.allowQueryWithZeroPeers??!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.running=!1}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal,void 0)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");if(n.signal==null){const c=AbortSignal.timeout(WN);n={...n,signal:c}}const s=new AbortController,i=zn([this.shutDownController.signal,s.signal,n.signal]);s.signal;const o=this.logger.forComponent(`${this.logPrefix}:query:`+Le(e,"base58btc"));let a=!1;try{this.routingTable.size===0&&!this.allowQueryWithZeroPeers&&(o("routing table was empty, waiting for some peers before running%s query",n.isSelfQuery===!0?" self":""),await wH(this.routingTable,"peer:add",{signal:i,filter:m=>!this.peerId.equals(m.detail)}),o("routing table has peers, continuing with%s query",n.isSelfQuery===!0?" self":"")),n.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(o("waiting for initial self query before continuing"),await wr(this.initialQuerySelfHasRun.promise,i),this.initialQuerySelfHasRun=void 0),o("query:start");const c=await Hl(e,{signal:i}),l=this.routingTable.closestPeers(c,{count:this.routingTable.kBucketSize}),h=l.sort(()=>Math.random()>.5?1:-1).reduce((m,_,R)=>(m[R%this.disjointPaths].push(_),m),new Array(this.disjointPaths).fill(0).map(()=>[])).filter(m=>m.length>0);if(l.length===0){o.error("running query with no peers");return}const f=xo(1024),p=h.map((m,_)=>_H({...n,key:e,startingPeers:m,ourPeerId:this.peerId,signal:i,query:t,path:_,numPaths:h.length,alpha:this.alpha,log:o,peersSeen:f,onProgress:n.onProgress,connectionManager:this.connectionManager}));for await(const m of Ol(...p)){if(m.name==="QUERY_ERROR"&&o.error("query error",m.error),m.name==="PEER_RESPONSE")for(const _ of[...m.closer,...m.providers])await this.connectionManager.isDialable(_.multiaddrs,{signal:i})&&await this.routingTable.add(_.id,{signal:i});i.throwIfAborted(),yield m}a=!0}catch(c){if(this.running)throw c}finally{a||(o("query exited early"),s.abort()),i.clear(),o("query finished")}}}function vH(r){return r[Symbol.asyncIterator]!=null}function h_(r){if(vH(r))return(async()=>{let e=0;for await(const t of r)e++;return e})();{let e=0;for(const t of r)e++;return e}}class xH{log;peerId;peerRouting;events;count;interval;initialInterval;queryTimeout;running;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:query-self`),this.events=e.events,this.running=!1,this.peerRouting=t.peerRouting,this.count=t.count??Tw,this.interval=t.interval??FN,this.initialInterval=t.initialInterval??HN,this.queryTimeout=t.queryTimeout??VN,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.querySelf=d_(this.querySelf.bind(this),t.operationMetrics,"SELF_QUERY")}isStarted(){return this.running}start(){this.running||(this.running=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.running){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=en(),this.running){this.controller=new AbortController;const e=[this.controller.signal];if(this.initialQuerySelfHasRun==null){const n=AbortSignal.timeout(this.queryTimeout);e.push(n)}const t=zn(e);this.controller.signal;try{this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);const n=Date.now(),s=await Ar(this.peerRouting.getClosestPeers(this.peerId.toMultihash().bytes,{signal:t,isSelfQuery:!0}),o=>b3(o,this.count),async o=>h_(o));t?.throwIfAborted();const i=Date.now()-n;this.log("self-query found %d peers in %dms",s,i),this.events.dispatchEvent(new CustomEvent("kad-dht:query:self",{detail:{peers:s,duration:i}}))}catch(n){this.log.error("self-query error",n)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.running&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}}class SH extends Cn{log;reprovideQueue;maxQueueSize;datastore;timeout;reprovideTimeout;running;shutdownController;reprovideThreshold;contentRouting;datastorePrefix;addressManager;validity;interval;peerId;constructor(e,t){super(),this.log=e.logger.forComponent(`${t.logPrefix}:reprovider`),this.peerId=e.peerId,this.reprovideQueue=new _u({concurrency:t.concurrency??$N,metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_queue`}),this.reprovideTimeout=new Ll({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_timeout_milliseconds`}),this.datastore=e.datastore,this.addressManager=e.addressManager,this.datastorePrefix=`${t.datastorePrefix}/provider`,this.reprovideThreshold=t.threshold??ON,this.maxQueueSize=t.maxQueueSize??MN,this.validity=t.validity??Iw,this.interval=t.interval??NN,this.contentRouting=t.contentRouting,this.running=!1,this.reprovide=d_(this.reprovide.bind(this),t.operationMetrics,"PROVIDE")}start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,this.timeout=setTimeout(()=>{this.processRecords({signal:AbortSignal.timeout(Q4)}).catch(e=>{this.log.error("error running process to reprovide/cleanup - %e",e)})},this.interval))}stop(){this.running=!1,this.reprovideQueue.clear(),clearTimeout(this.timeout),this.shutdownController?.abort()}async processRecords(e){try{this.safeDispatchEvent("reprovide:start"),this.log("starting reprovide/cleanup");for await(const t of this.datastore.query({prefix:this.datastorePrefix},e))try{const{cid:n,peerId:s}=u_(t.key),o=f_(t.value).getTime()+this.validity,a=Date.now(),c=a>o,l=this.peerId.equals(s);this.log.trace("comparing: %d (now) < %d (expires) = %s %s",a,o,c,c?"(expired)":"(valid)"),c&&!l&&await this.datastore.delete(t.key,e),this.shouldReprovide(l,o)&&(this.log("reproviding %c as it is within the reprovide threshold (%d)",n,this.reprovideThreshold),this.queueReprovide(n).catch(h=>{this.log.error("could not reprovide %c - %e",n,h)}))}catch(n){this.log.error("error processing datastore key %s - %e",t.key,n.message)}this.log("reprovide/cleanup successful")}finally{this.safeDispatchEvent("reprovide:end"),this.running&&(this.log("queuing next re-provide/cleanup run in %d ms",this.interval),this.timeout=setTimeout(()=>{this.processRecords({signal:AbortSignal.timeout(Q4)}).catch(t=>{this.log.error("error running re-provide - %e",t)})},this.interval))}}shouldReprovide(e,t){if(!e)return!1;const n=Date.now();return t<n?!0:t-n<this.reprovideThreshold}async queueReprovide(e,t){if(!this.running)return;this.log.trace("waiting for queue capacity before adding %c to re-provide queue",e),await this.reprovideQueue.onSizeLessThan(this.maxQueueSize,t);const n=this.reprovideQueue.queue.find(s=>s.options.cid.equals(e));if(n!=null)return this.log.trace("not adding %c to re-provide queue - already in queue",e),n.join();this.log.trace("adding %c to re-provide queue",e),this.reprovideQueue.add(async s=>{if(s.signal?.throwIfAborted(),!this.running)return;this.log.trace("re-providing %c",e);const i=this.reprovideTimeout.getTimeoutSignal(s);try{await this.reprovide(s.cid,s)}finally{this.reprovideTimeout.cleanUp(i)}this.log.trace("re-provided %c",e)},{signal:this.shutdownController?.signal,cid:e}).catch(s=>{this.log.error("could not re-provide key %c - %e",e,s)})}async reprovide(e,t){await Ja(this.contentRouting.provide(e,this.addressManager.getAddresses(),t))}}const AH=20,IH=5e3,TH="kad-close",kH=50;class CH{routingTable;components;closestPeers;newPeers;refreshInterval;peerSetSize;timeout;closeTagName;closeTagValue;log;running;constructor(e,t){this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.routingTable=t.routingTable,this.refreshInterval=t.refreshInterval??IH,this.peerSetSize=t.peerSetSize??AH,this.closeTagName=t.closeTagName??TH,this.closeTagValue=t.closeTagValue??kH,this.closestPeers=new rs,this.onPeerPing=this.onPeerPing.bind(this),this.running=!1}async start(){if(this.running)return;this.running=!0;const e=await Ls(this.components.peerId);this.newPeers=new Ug(e,this.peerSetSize),this.routingTable.addEventListener("peer:ping",this.onPeerPing),this.timeout=setInterval(()=>{this.updatePeerTags().catch(t=>{this.log.error("error updating peer tags - %e",t)})},this.refreshInterval)}stop(){this.running=!1,this.routingTable.removeEventListener("peer:ping",this.onPeerPing),clearTimeout(this.timeout)}onPeerPing(e){this.newPeers?.add({id:e.detail,multiaddrs:[]}).catch(t=>{this.log.error("error adding peer to distance list - %e",t)})}async updatePeerTags(){const e=new rs(this.newPeers?.peers.map(({peer:s})=>s.id)),t=e.difference(this.closestPeers),n=this.closestPeers.difference(e);this.closestPeers=e,await Promise.all([...[...t].map(async s=>{await this.components.peerStore.merge(s,{tags:{[this.closeTagName]:{value:this.closeTagValue},[X4]:{value:1}}})}),...[...n].map(async s=>{await this.components.peerStore.merge(s,{tags:{[this.closeTagName]:void 0,[X4]:void 0}})})])}}function jf(r){return Array.isArray(r?.peers)}class RH{peerId;root;localPeer;prefixLength;splitThreshold;kBucketSize;numberOfNodesToPing;lastPingThreshold;ping;verify;onAdd;onRemove;onMove;addingPeerMap;constructor(e,t){this.peerId=e.peerId,this.prefixLength=t.prefixLength??qH,this.kBucketSize=t.kBucketSize??Fg,this.splitThreshold=t.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=t.numberOfOldContactsToPing??OH,this.lastPingThreshold=t.lastPingThreshold??UH,this.ping=t.ping,this.verify=t.verify,this.onAdd=t.onAdd,this.onRemove=t.onRemove,this.addingPeerMap=ig({name:`${t.metricsPrefix}_adding_peer_map`,metrics:e.metrics}),this.root={prefix:"",depth:0,peers:[]}}async start(){await this.addSelfPeer(this.peerId)}stop(){this.addingPeerMap.clear(),this.root={prefix:"",depth:0,peers:[]}}async addSelfPeer(e,t){this.localPeer={peerId:e,kadId:await Ls(e,t),lastPing:Date.now()}}async add(e,t){const n={peerId:e,kadId:await Ls(e,t),lastPing:0},s=this.addingPeerMap.get(e);if(s!=null)return s;try{const i=this._add(n,t);this.addingPeerMap.set(e,i),await i}finally{this.addingPeerMap.delete(e)}}async _add(e,t){const n=this._determineBucket(e.kadId);if(this._indexOf(n,e.kadId)>-1)return;if(n.peers.length===this.splitThreshold&&n.depth<this.prefixLength){await this._split(n,t),await this._add(e,t);return}if(n.peers.length<this.kBucketSize){if(!DH(e,this.lastPingThreshold)){n.peers.push(e),await this.onAdd?.(e,n,t);return}await this.verify(e,t)&&(e.lastPing=Date.now(),await this._add(e,t));return}const s=n.peers.filter(o=>!(o.peerId.equals(this.localPeer?.peerId)||o.lastPing>Date.now()-this.lastPingThreshold)).sort((o,a)=>o.lastPing<a.lastPing?-1:o.lastPing>a.lastPing?1:0).slice(0,this.numberOfNodesToPing);let i=!1;for await(const o of this.ping(s,t))i=!0,await this.remove(o.kadId,t);i&&await this._add(e,t)}*closest(e,t){const n=new Ug(e,t?.count??this.kBucketSize);for(const s of this.toIterable())t?.exclude?.some(i=>i.equals(s.peerId))!==!0&&n.addWithKadId({id:s.peerId,multiaddrs:[]},s.kadId);yield*to(n.peers,({peer:s})=>s.id)}count(){function e(t){if(jf(t))return t.peers.length;let n=0;return t.left!=null&&(n+=e(t.left)),t.right!=null&&(n+=e(t.right)),n}return e(this.root)}get(e){const t=this._determineBucket(e),n=this._indexOf(t,e);return t.peers[n]}async remove(e,t){const n=this._determineBucket(e),s=this._indexOf(n,e);if(s>-1){const i=n.peers.splice(s,1)[0];await this.onRemove?.(i,n,t)}}*toIterable(){function*e(t){if(jf(t)){yield*t.peers;return}yield*e(t.left),yield*e(t.right)}yield*e(this.root)}distance(e,t){return BigInt("0x"+Le(oc(e,t),"base16"))}_determineBucket(e){const t=Le(e,"base2");function n(s,i=0){return jf(s)?s:t[i]==="0"?n(s.left,i+1):n(s.right,i+1)}return n(this.root)}_indexOf(e,t){return e.peers.findIndex(n=>at(n.kadId,t))}async _split(e,t){const n={prefix:"0",depth:e.depth+1,peers:[]},s={prefix:"1",depth:e.depth+1,peers:[]};for(const i of e.peers)Le(i.kadId,"base2")[e.depth]==="0"?(n.peers.push(i),await this.onMove?.(i,e,n,t)):(s.peers.push(i),await this.onMove?.(i,e,s,t));PH(e,n,s)}}function PH(r,e,t){return delete r.peers,r.left=e,r.right=t,r.prefix===""&&(delete r.depth,delete r.prefix),!0}function DH(r,e){return r.lastPing<Date.now()-e}const Fg=20,qH=6,BH=20,LH=100,OH=3,$H=20,MH=100,v5="kad-peer",NH=1,UH=6e5,FH=!0,HH=1e3;class VH extends Cn{kBucketSize;kb;network;closestPeerTagger;log;components;running;pingNewContactTimeout;pingNewContactQueue;pingOldContactTimeout;pingOldContactQueue;populateFromDatastoreOnStart;populateFromDatastoreLimit;protocol;peerTagName;peerTagValue;metrics;shutdownController;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.kBucketSize=t.kBucketSize??Fg,this.running=!1,this.protocol=t.protocol,this.network=t.network,this.peerTagName=t.peerTagName??v5,this.peerTagValue=t.peerTagValue??NH,this.pingOldContacts=this.pingOldContacts.bind(this),this.verifyNewContact=this.verifyNewContact.bind(this),this.peerAdded=this.peerAdded.bind(this),this.peerRemoved=this.peerRemoved.bind(this),this.populateFromDatastoreOnStart=t.populateFromDatastoreOnStart??FH,this.populateFromDatastoreLimit=t.populateFromDatastoreLimit??HH,this.shutdownController=new AbortController,this.shutdownController.signal,this.pingOldContactQueue=new ec({concurrency:t.pingOldContactConcurrency??$H,metricName:`${t.metricsPrefix}_ping_old_contact_queue`,metrics:this.components.metrics,maxSize:t.pingOldContactMaxQueueSize??MH}),this.pingOldContactTimeout=new Ll({...t.pingOldContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_old_contact_time_milliseconds`}),this.pingNewContactQueue=new ec({concurrency:t.pingNewContactConcurrency??BH,metricName:`${t.metricsPrefix}_ping_new_contact_queue`,metrics:this.components.metrics,maxSize:t.pingNewContactMaxQueueSize??LH}),this.pingNewContactTimeout=new Ll({...t.pingNewContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_new_contact_time_milliseconds`}),this.kb=new RH(e,{kBucketSize:t.kBucketSize,prefixLength:t.prefixLength,splitThreshold:t.splitThreshold,numberOfOldContactsToPing:t.numberOfOldContactsToPing,lastPingThreshold:t.lastPingThreshold,ping:this.pingOldContacts,verify:this.verifyNewContact,onAdd:this.peerAdded,onRemove:this.peerRemoved,metricsPrefix:t.metricsPrefix}),this.closestPeerTagger=new CH(this.components,{logPrefix:t.logPrefix,routingTable:this,peerSetSize:t.closestPeerSetSize,refreshInterval:t.closestPeerSetRefreshInterval,closeTagName:t.closeTagName,closeTagValue:t.closeTagValue}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMinOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_min_occupancy`),routingTableKadBucketMaxOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_depth`),kadBucketEvents:this.components.metrics.registerCounterGroup(`${t.metricsPrefix}_kad_bucket_events_total`)})}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,await wl(this.closestPeerTagger,this.kb))}async afterStart(){let e=0;Promise.resolve().then(async()=>{if(!this.populateFromDatastoreOnStart)return;const t=zn([this.shutdownController.signal,AbortSignal.timeout(2e4)]);try{for(const n of await this.components.peerStore.all({filters:[s=>s.protocols.includes(this.protocol)&&s.tags.has(v5)],limit:this.populateFromDatastoreLimit,signal:t})){if(!this.running)return;try{await this.add(n.id,{signal:t}),e++}catch{this.log("failed to add peer %p to routing table, removing kad-dht peer tags - %e"),await this.components.peerStore.merge(n.id,{tags:{[this.peerTagName]:void 0}})}}}finally{t.clear()}this.log("added %d peer store peers to the routing table",e)}).catch(t=>{this.log.error("error adding %d, peer store peers to the routing table - %e",e,t)})}async stop(){this.running=!1,await Th(this.closestPeerTagger,this.kb),this.pingOldContactQueue.abort(),this.pingNewContactQueue.abort(),this.shutdownController.abort()}async peerAdded(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:{value:this.peerTagValue}}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_added:!0}),this.safeDispatchEvent("peer:add",{detail:e.peerId})}async peerRemoved(e,t,n){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:void 0}},n),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_removed:!0}),this.safeDispatchEvent("peer:remove",{detail:e.peerId})}async*pingOldContacts(e,t){if(!this.running)return;const n=[];for(const s of e){if(this.kb.get(s.kadId)==null){this.log("asked to ping contact %p that was not in routing table",s.peerId);continue}this.metrics?.kadBucketEvents.increment({ping_old_contact:!0}),n.push(async()=>{const i=this.pingOldContactQueue.find(s.peerId);if(i!=null)return this.log("asked to ping contact %p was already being pinged",s.peerId),await i.join(t)?void 0:s;if(!await this.pingOldContactQueue.add(async a=>{const c=this.pingOldContactTimeout.getTimeoutSignal(),l=zn([c,this.shutdownController.signal,a?.signal]);try{return await this.pingContact(s,a)}catch{return this.metrics?.kadBucketEvents.increment({ping_old_contact_error:!0}),!0}finally{this.pingOldContactTimeout.cleanUp(c),l.clear()}},{peerId:s.peerId,signal:t?.signal}))return s})}for await(const s of kg(n))s!=null&&(yield s)}async verifyNewContact(e,t){const n=this.pingNewContactTimeout.getTimeoutSignal(),s=zn([n,this.shutdownController.signal,t?.signal]);try{const i=this.pingNewContactQueue.find(e.peerId);return i!=null?(this.log("joining existing ping to add new peer %p to routing table",e.peerId),await i.join({signal:s})):await this.pingNewContactQueue.add(async o=>(this.metrics?.kadBucketEvents.increment({ping_new_contact:!0}),this.log("pinging new peer %p before adding to routing table",e.peerId),this.pingContact(e,o)),{peerId:e.peerId,signal:s})}catch{return this.log.trace("tried to add peer %p but they were not online",e.peerId),this.metrics?.kadBucketEvents.increment({ping_new_contact_error:!0}),!1}finally{this.pingNewContactTimeout.cleanUp(n),s.clear()}}async pingContact(e,t){try{return this.log("pinging contact %p",e.peerId),await this.components.ping.ping(e.peerId,t),this.log("contact %p ping ok",e.peerId),this.safeDispatchEvent("peer:ping",{detail:e.peerId}),!0}catch(n){return this.log("error pinging old contact %p - %e",e.peerId,n),!1}}get size(){return this.kb==null?0:this.kb.count()}async find(e,t){const n=await Ls(e,t);return this.kb.get(n)?.peerId}closestPeer(e){const t=this.closestPeers(e,{count:1});if(t.length>0)return t[0]}closestPeers(e,t){return this.kb==null?[]:[...this.kb.closest(e,t)]}async add(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");await this.kb.add(e,t)}async remove(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");const n=await Ls(e,t);await this.kb.remove(n,t)}updateMetrics(){if(this.metrics==null||this.kb==null)return;let e=0,t=0,n=0,s=20,i=0;function o(a){if(jf(a)){a.depth>n&&(n=a.depth),t++,e+=a.peers.length,a.peers.length<s&&(s=a.peers.length),a.peers.length>i&&(i=a.peers.length);return}o(a.left),o(a.right)}o(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(t),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/t)),this.metrics.routingTableKadBucketMinOccupancy.update(s),this.metrics.routingTableKadBucketMaxOccupancy.update(i),this.metrics.routingTableKadBucketMaxDepth.update(n)}}var KH=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782];const If=15;class zH{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e,t){const{peerRouting:n,routingTable:s,refreshInterval:i,refreshQueryTimeout:o,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=n,this.routingTable=s,this.refreshInterval=i??KN,this.refreshQueryTimeout=o??zN,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1,t){this.log("refreshing routing table");const n=this._maxCommonPrefix(),s=this._getTrackedCommonPrefixLengthsForRefresh(n);this.log(`max common prefix length ${n}`),this.log(`tracked CPLs [ ${s.map(i=>i.toISOString()).join(", ")} ]`),Promise.all(s.map(async(i,o)=>{try{if(await this._refreshCommonPrefixLength(o,i,e,t),this._numPeersForCpl(n)===0){const a=Math.min(2*(o+1),s.length-1);for(let c=o+1;c<a+1;c++)try{await this._refreshCommonPrefixLength(c,i,e,t)}catch(l){this.log.error(l)}}}catch(a){this.log.error(a)}})).catch(i=>{this.log.error(i)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(i=>{this.log.error(i)})}async _refreshCommonPrefixLength(e,t,n,s){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}const i=this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,i,this.routingTable.size);const o=zn([s?.signal,AbortSignal.timeout(this.refreshQueryTimeout)]);try{const a=await h_(this.peerRouting.getClosestPeers(i.toMultihash().bytes,{signal:o}));this.log(`found ${a} peers that were close to imaginary peer %p`,i),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,i,this.routingTable.size)}finally{o.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>If&&(e=If);const t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}_generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");if(this.routingTable.kb.localPeer==null)throw new Error("Local peer not set");const t=SF(2),n=(t[1]<<8)+t[0],s=this._makePeerId(this.routingTable.kb.localPeer.kadId,n,e),i=Gn(s);return mr(i)}_makePeerId(e,t,n){if(n>If)throw new Error(`Cannot generate peer ID for common prefix length greater than ${If}`);const o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=o&a|t&~a,l=KH[c],h=new ArrayBuffer(34),f=new DataView(h,0,h.byteLength);return f.setUint8(0,$r.code),f.setUint8(1,32),f.setUint32(2,l,!1),new Uint8Array(f.buffer,f.byteOffset,f.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb?.localPeer!=null)for(const{kadId:e}of this.routingTable.kb.toIterable()){const t=oc(this.routingTable.kb.localPeer.kadId,e);let n=0;for(const s of t)if(s===0)n++;else break;yield n}}}class WH{peerId;providers;peerStore;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.peerId=e.peerId,this.providers=t.providers,this.peerStore=e.peerStore}async handle(e,t){if(t.key==null||t.key.length===0)throw new Jt("Missing key");let n;try{n=nt.decode(t.key)}catch{throw new Jt("Invalid CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),this.log("%p asked us, %p to store provider record for for %c",e,this.peerId,n),await Promise.all(t.providers.map(async s=>{const i=Gn(s.id),o=mr(i),a=s.multiaddrs.map(c=>lt(c));if(!e.equals(o)){this.log("invalid provider peer %p from %p",s.id,e);return}if(s.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log.trace("received provider %p for %s (addrs %s)",e,n,a),await this.providers.addProvider(n,o),await this.peerStore.merge(o,{multiaddrs:a})}))}}class GH{peerRouting;peerInfoMapper;peerId;addressManager;log;constructor(e,t){const{peerRouting:n,logPrefix:s}=t;this.log=e.logger.forComponent(`${s}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=n,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){this.log("incoming request from %p for peers close to %b",e,t.key);try{if(t.key==null)throw new Jt("Invalid FIND_NODE message received - key was missing");const n=await this.peerRouting.getClosestPeersOffline(t.key,{exclude:[e,this.peerId]});at(this.peerId.toMultihash().bytes,t.key)&&n.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(i=>i.decapsulateCode(du("p2p").code))});const s={type:Ht.FIND_NODE,clusterLevel:t.clusterLevel,closer:n.map(this.peerInfoMapper).filter(({multiaddrs:i})=>i.length).map(i=>({id:i.id.toMultihash().bytes,multiaddrs:i.multiaddrs.map(o=>o.bytes)})),providers:[]};return s.closer.length===0?this.log("could not find any peers closer to %b for %p",t.key,e):this.log("found %d peers close to %b for %p",s.closer.length,t.key,e),s}catch(n){throw this.log("error during finding peers closer to %b for %p - %e",t.key,e,n),n}}}class ZH{peerId;peerRouting;providers;peerStore;peerInfoMapper;log;constructor(e,t){const{peerRouting:n,providers:s,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:get-providers`),this.peerId=e.peerId,this.peerStore=e.peerStore,this.peerRouting=n,this.providers=s,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new Jt("Invalid GET_PROVIDERS message received - key was missing");let n;try{n=nt.decode(t.key)}catch{throw new Jt("Invalid CID")}this.log("%p asking for providers for %s",e,n);const[s,i]=await Promise.all([kd(to(await this.providers.getProviders(n),async a=>{const c=await this.peerStore.get(a);return{id:c.id,multiaddrs:c.addresses.map(({multiaddr:h})=>h)}})),this.peerRouting.getClosestPeersOffline(t.key)]),o={type:Ht.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:i.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)})),providers:s.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))};return this.log("got %s providers %s closerPeers",o.providers.length,o.closer.length),o}async _getAddresses(e){return[]}}class jH{peerStore;datastore;peerRouting;log;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){const n=t.key;if(this.log("%p asked for key %b",e,n),n==null||n.length===0)throw new Jt("Invalid key");const s={type:Ht.GET_VALUE,key:n,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(JF(n)){this.log("is public key");const a=eH(n);let c;try{const l=await this.peerStore.get(a);if(l.id.publicKey==null)throw new qi("No public key found in key book");c=t1(l.id.publicKey)}catch(l){if(l.name!=="NotFoundError")throw l}if(c!=null)return this.log("returning found public key"),s.record=new Ir(n,c,new Date).serialize(),s}const[i,o]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getClosestPeersOffline(n)]);return i!=null&&(this.log("had record for %b in local datastore",n),s.record=i.serialize()),o.length>0&&(this.log("had %s closer peers in routing table",o.length),s.closer=o.map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),s}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);const t=rl(this.datastorePrefix,e);let n;try{n=await this.datastore.get(t)}catch(i){if(i.name==="NotFoundError")return;throw i}const s=Ir.deserialize(n);if(s.timeReceived==null||Date.now()-s.timeReceived.getTime()>Iw){await this.datastore.delete(t);return}return s}}class YH{log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}}class QH{components;validators;log;datastorePrefix;constructor(e,t){const{validators:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n}async handle(e,t){const n=t.key;if(this.log("%p asked us to store value for key %b",e,n),t.record==null){const s=`Empty record from: ${e.toString()}`;throw this.log.error(s),new Jt(s)}try{const s=Ir.deserialize(t.record);await Ng(this.validators,s),s.timeReceived=new Date;const i=rl(this.datastorePrefix,s.key);await this.components.datastore.put(i,s.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,i)}catch(s){this.log("did not put record for key %b into datastore %o",n,s)}return t}}let XH=class{handlers;log;metrics;incomingMessageTimeout;constructor(e,t){this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_errors_total`),rpcTime:e.metrics?.registerMetricGroup(`${t.metricsPrefix}_inbound_rpc_time_seconds`,{label:"operation"})},this.log=e.logger.forComponent(`${t.logPrefix}:rpc`),this.incomingMessageTimeout=t.incomingMessageTimeout??1e4,this.handlers={[Ht.GET_VALUE.toString()]:new jH(e,t),[Ht.PUT_VALUE.toString()]:new QH(e,t),[Ht.FIND_NODE.toString()]:new GH(e,t),[Ht.ADD_PROVIDER.toString()]:new WH(e,t),[Ht.GET_PROVIDERS.toString()]:new ZH(e,t),[Ht.PING.toString()]:new YH(e,t)}}async handleMessage(e,t){const n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}try{return this.metrics.operations?.increment({[t.type]:!0}),await n.handle(e,t)}catch{this.metrics.errors?.increment({[t.type]:!0})}}onIncomingStream(e){const t="unknown";Promise.resolve().then(async()=>{const{stream:n,connection:s}=e,i=()=>{n.abort(new Qp)};let o=AbortSignal.timeout(this.incomingMessageTimeout);o.addEventListener("abort",i);const a=gr(n).pb(Ra);try{for(;;){const c=await a.read({signal:o}),l=this.metrics?.rpcTime?.timer(c.type.toString()),h=this.metrics?.rpcTime?.timer(c.type.toString());let f=!1;try{this.log("incoming %s from %p",c.type,s.remotePeer);const p=await this.handleMessage(s.remotePeer,c);p!=null&&await a.write(p,{signal:o})}catch(p){throw f=!0,h?.(),p}finally{f||l?.()}o.removeEventListener("abort",i),o=AbortSignal.timeout(this.incomingMessageTimeout),o.addEventListener("abort",i)}}catch(c){n.abort(c)}}).catch(n=>{this.log.error("error handling %s RPC message from %p - %e",t,e.connection.remotePeer,n)})}};class JH extends Cn{log;components;protocol;running;registrarId;constructor(e,t){super();const{protocol:n,logPrefix:s}=t;this.components=e,this.log=e.logger.forComponent(`${s}:topology-listener`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new CustomEvent("peer",{detail:e}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class eV{dht;constructor(e){this.dht=e}async provide(e,t={}){await Ja(this.dht.provide(e,t))}async cancelReprovide(e){await this.dht.cancelReprovide(e)}async*findProviders(e,t={}){for await(const n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers)}async put(e,t,n){await Ja(this.dht.put(e,t,n))}async get(e,t){for await(const n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw new qi("Could not find value for key")}}class tV{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(const n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw new qi("Peer not found")}async*getClosestPeers(e,t={}){for await(const n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}}const nV=32,rV=64;class sV extends Cn{k;a;d;protocol;routingTable;providers;network;peerRouting;components;log;running;clientMode;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;dhtContentRouting;dhtPeerRouting;peerInfoMapper;reprovider;onPeerConnectTimeout;constructor(e,t={}){super();const n=t.logPrefix??"libp2p:kad-dht",s=t.datastorePrefix??"/dht",i=t.metricsPrefix??"libp2p_kad_dht",o={queries:e.metrics?.registerMetricGroup(`${i}_operations_total`,{label:"operation"}),errors:e.metrics?.registerCounterGroup(`${i}_operation_errors_total`,{label:"operation"}),queryTime:e.metrics?.registerMetricGroup(`${i}_operation_time_seconds`,{label:"operation"}),errorTime:e.metrics?.registerMetricGroup(`${i}_operation_error_time_seconds`,{label:"operation"})};this.running=!1,this.components=e,this.log=e.logger.forComponent(n),this.k=t.kBucketSize??Fg,this.a=t.alpha??jh,this.d=t.disjointPaths??this.a,this.protocol=t.protocol??LN,this.clientMode=t.clientMode??!0,this.maxInboundStreams=t.maxInboundStreams??nV,this.maxOutboundStreams=t.maxOutboundStreams??rV,this.peerInfoMapper=t.peerInfoMapper??QF,this.onPeerConnectTimeout=t.onPeerConnectTimeout??UN,this.providers=new hH(e,{...t.providers,logPrefix:n,datastorePrefix:s}),this.validators={...jF,...t.validators},this.selectors={...eU,...t.selectors},this.network=new fH(e,{protocol:this.protocol,logPrefix:n,metricsPrefix:i}),this.routingTable=new VH(e,{kBucketSize:this.k,pingOldContactTimeout:t.pingOldContactTimeout,pingOldContactConcurrency:t.pingOldContactConcurrency,pingOldContactMaxQueueSize:t.pingOldContactMaxQueueSize,pingNewContactTimeout:t.pingNewContactTimeout,pingNewContactConcurrency:t.pingNewContactConcurrency,pingNewContactMaxQueueSize:t.pingNewContactMaxQueueSize,protocol:this.protocol,logPrefix:n,metricsPrefix:i,prefixLength:t.prefixLength,splitThreshold:t.kBucketSplitThreshold,network:this.network});const a=en();t.allowQueryWithZeroPeers===!0&&a.resolve(),this.queryManager=new EH(e,{disjointPaths:this.d,alpha:this.a,logPrefix:n,metricsPrefix:i,initialQuerySelfHasRun:a,routingTable:this.routingTable,allowQueryWithZeroPeers:t.allowQueryWithZeroPeers}),this.peerRouting=new dH(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:n}),this.contentFetching=new cH(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:n,datastorePrefix:s}),this.contentRouting=new uH(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:n}),this.routingTableRefresh=new zH(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:n}),this.rpc=new XH(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:n,metricsPrefix:i,datastorePrefix:s,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new JH(e,{protocol:this.protocol,logPrefix:n}),this.querySelf=new xH(e,{peerRouting:this.peerRouting,interval:t.querySelfInterval,initialInterval:t.initialQuerySelfInterval,logPrefix:n,initialQuerySelfHasRun:a,operationMetrics:o}),this.reprovider=new SH(e,{...t.reprovide,logPrefix:n,metricsPrefix:i,datastorePrefix:s,contentRouting:this.contentRouting,operationMetrics:o}),this.network.addEventListener("peer",c=>{const l=c.detail;this.onPeerConnect(l).catch(h=>{this.log.error("could not add %p to routing table",l.id,h)}),this.dispatchEvent(new CustomEvent("peer",{detail:l}))}),this.topologyListener.addEventListener("peer",c=>{const l=c.detail;Promise.resolve().then(async()=>{const h=await this.components.peerStore.get(l),f={id:l,multiaddrs:h.addresses.map(({multiaddr:p})=>p),protocols:h.protocols};await this.onPeerConnect(f)}).catch(h=>{this.log.error("could not add %p to routing table - %e - %e",l,h)})}),this.dhtPeerRouting=new tV(this),this.dhtContentRouting=new eV(this),t.clientMode==null&&e.events.addEventListener("self:peer:update",c=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{const l=c.detail.peer.addresses.some(({multiaddr:f})=>aH(f)),h=this.getMode();l&&h==="client"?await this.setMode("server"):h==="server"&&!l&&await this.setMode("client")}).catch(l=>{this.log.error("error setting dht server mode",l)})}),this.get=aa(this.get.bind(this),o,"GET_VALUE"),this.findProviders=aa(this.findProviders.bind(this),o,"FIND_PROVIDERS"),this.findPeer=aa(this.findPeer.bind(this),o,"FIND_PEER"),this.getClosestPeers=aa(this.getClosestPeers.bind(this),o,"GET_CLOSEST_PEERS"),this.provide=aa(this.provide.bind(this),o,"PROVIDE"),this.put=aa(this.put.bind(this),o,"PUT_VALUE")}[Symbol.toStringTag]="@libp2p/kad-dht";[pr]=["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery","@libp2p/kad-dht"];[_o]=["@libp2p/identify","@libp2p/ping"];get[Y2](){return this.dhtContentRouting}get[Q2](){return this.dhtPeerRouting}get[pd](){return this}async onPeerConnect(e){if(this.log.trace("peer %p connected",e.id),e=this.peerInfoMapper(e),e.multiaddrs.length===0){this.log.trace("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map(n=>n.toString()));return}const t=AbortSignal.timeout(this.onPeerConnectTimeout);try{await this.routingTable.add(e.id,{signal:t})}catch(n){this.log.error("could not add %p to routing table",e.id,n)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e,t){if(e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}if(await this.components.registrar.unhandle(this.protocol,t),e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}e==="client"?(this.log("enabling client mode while in %s mode",this.getMode()),this.clientMode=!0):(this.log("enabling server mode while in %s mode",this.getMode()),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{signal:t?.signal,maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running||(this.running=!0,await this.setMode(this.clientMode?"client":"server",{force:!0}),await wl(this.routingTable,this.queryManager,this.network,this.topologyListener,this.routingTableRefresh,this.reprovider),await wl(this.querySelf))}async stop(){this.running=!1,await Th(this.querySelf,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener,this.reprovider)}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async cancelReprovide(e,t){await this.providers.removeProvider(e,this.components.peerId,t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(e){this.routingTableRefresh.refreshTable(!0,e)}}var x5;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER",r[r.PATH_ENDED=8]="PATH_ENDED"})(x5||(x5={}));function iV(r={}){return e=>new sV(e,r)}let oV=class{constructor(){throw new Error("TCP connections are not possible in browsers")}[Zp]=!0;[Symbol.toStringTag]="@libp2p/tcp";[pr]=["@libp2p/transport"];async dial(){throw new Error("TCP connections are not possible in browsers")}createListener(){throw new Error("TCP connections are not possible in browsers")}listenFilter(){return[]}dialFilter(){return[]}};function aV(r={}){return e=>new oV(e,r)}var Os;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(Os||(Os={}));var L3;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(L3||(L3={}));(function(r){r.codec=()=>Rn(L3)})(Os||(Os={}));var O3;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Os.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=Os.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(O3||(O3={}));var S5;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Os.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=Os.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(S5||(S5={}));function cV(r){return O3.encode({Type:Os[r.type],Data:r.raw})}const p_=1e3,g_=60*p_,m_=290,lV=15,uV=120*g_,fV=1,y_=2e3,dV=100,A5="circuit-relay-source",Tf=`${au}-circuit-relay`,I5=`${au}-circuit-relay-source`,hV=2*g_,pV=BigInt(1<<17),ac="/libp2p/circuit/relay/0.2.0/hop",$3="/libp2p/circuit/relay/0.2.0/stop",gV=30*p_,M3=300,mV=4096,yV=.001;var Lt;(function(r){(function(n){n.RESERVE="RESERVE",n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.RESERVE=0]="RESERVE",n[n.CONNECT=1]="CONNECT",n[n.STATUS=2]="STATUS"})(e||(e={})),(function(n){n.codec=()=>Rn(e)})(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=tt((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.peer!=null&&(s.uint32(18),cc.codec().encode(n.peer,s)),n.reservation!=null&&(s.uint32(26),jd.codec().encode(n.reservation,s)),n.limit!=null&&(s.uint32(34),lc.codec().encode(n.limit,s)),n.status!=null&&(s.uint32(40),yt.codec().encode(n.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=cc.codec().decode(n,n.uint32(),{limits:i.limits?.peer});break}case 3:{o.reservation=jd.codec().decode(n,n.uint32(),{limits:i.limits?.reservation});break}case 4:{o.limit=lc.codec().decode(n,n.uint32(),{limits:i.limits?.limit});break}case 5:{o.status=yt.codec().decode(n);break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>et(n,r.codec()),r.decode=(n,s)=>Je(n,r.codec(),s)})(Lt||(Lt={}));var Rr;(function(r){(function(n){n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.CONNECT=0]="CONNECT",n[n.STATUS=1]="STATUS"})(e||(e={})),(function(n){n.codec=()=>Rn(e)})(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=tt((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.peer!=null&&(s.uint32(18),cc.codec().encode(n.peer,s)),n.limit!=null&&(s.uint32(26),lc.codec().encode(n.limit,s)),n.status!=null&&(s.uint32(32),yt.codec().encode(n.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},a=s==null?n.len:n.pos+s;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=cc.codec().decode(n,n.uint32(),{limits:i.limits?.peer});break}case 3:{o.limit=lc.codec().decode(n,n.uint32(),{limits:i.limits?.limit});break}case 4:{o.status=yt.codec().decode(n);break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>et(n,r.codec()),r.decode=(n,s)=>Je(n,r.codec(),s)})(Rr||(Rr={}));var cc;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={id:St(0),addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.id=t.bytes();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new Mt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(cc||(cc={}));var jd;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);t.voucher!=null&&(n.uint32(26),Yd.codec().encode(t.voucher,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={expire:0n,addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.expire=t.uint64();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new Mt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}case 3:{i.voucher=Yd.codec().decode(t,t.uint32(),{limits:s.limits?.voucher});break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(jd||(jd={}));var lc;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.duration=t.uint32();break}case 2:{i.data=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(lc||(lc={}));var yt;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(yt||(yt={}));var N3;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(N3||(N3={}));(function(r){r.codec=()=>Rn(N3)})(yt||(yt={}));var Vl;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={relay:St(0),peer:St(0),expiration:0n},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.relay=t.bytes();break}case 2:{i.peer=t.bytes();break}case 3:{i.expiration=t.uint64();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(Vl||(Vl={}));var Yd;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&(n.uint32(26),Vl.codec().encode(t.payload,n)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:St(0),payloadType:St(0),signature:St(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=Vl.codec().decode(t,t.uint32(),{limits:s.limits?.payload});break}case 5:{i.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(Yd||(Yd={}));class bV extends Error{constructor(e="Transfer limit error"){super(e),this.name="TransferLimitError"}}class T5 extends Error{constructor(e="Duration limit error"){super(e),this.name="DurationLimitError"}}class k5 extends Error{static name="HadEnoughRelaysError";name="HadEnoughRelaysError"}class wV extends Error{static name="DoubleRelayError";name="DoubleRelayError"}class _V extends Error{static name="RelayQueueFullError";name="RelayQueueFullError"}async function*C5(r,e,t){const n=e.remaining;for await(const s of r){const i=BigInt(s.byteLength);if(e.remaining-i<0){const o=Number(e.remaining);e.remaining=0n;try{o!==0&&(yield s.subarray(0,o))}catch(a){t.log.error(a)}throw new bV(`data limit of ${n} bytes exceeded`)}e.remaining-=i,yield s}}function EV(r,e,t,n,s){function i(f){r.abort(f),e.abort(f)}const o=[t,n.signal];n.limit?.duration!=null&&(s.log("limiting relayed connection duration to %dms",n.limit.duration),o.push(AbortSignal.timeout(n.limit.duration)));const a=zn(o);let c=!1,l=!1,h;n.limit?.data!=null&&(h={remaining:n.limit.data}),queueMicrotask(()=>{const f=()=>{s.log("relayed connection reached time limit"),e.abort(new T5(`duration limit of ${n.limit?.duration} ms exceeded`))};a.addEventListener("abort",f,{once:!0}),e.sink(h==null?r.source:C5(r.source,h,s)).catch(p=>{s.log.error("error while relaying streams src -> dst",p),i(p)}).finally(()=>{c=!0,l&&(a.removeEventListener("abort",f),a.clear())})}),queueMicrotask(()=>{const f=()=>{s.log("relayed connection reached time limit"),r.abort(new T5(`duration limit of ${n.limit?.duration} ms exceeded`))};a.addEventListener("abort",f,{once:!0}),r.sink(h==null?e.source:C5(e.source,h,s)).catch(p=>{s.log.error("error while relaying streams dst -> src",p),i(p)}).finally(()=>{l=!0,c&&(a.removeEventListener("abort",f),a.clear())})})}function R5(r){const e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}class P5{expires;bytes;constructor(e){e?.duration!=null&&e?.duration!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;const e={};if(this.bytes!=null){const t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){const t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}}const b_=Ot(Tt(hO.matchers[0],Nt(wc))),w_=Ot(Nt(wc));class vV extends Error{type;code;constructor(e,t,n){super(e??"The operation was aborted"),this.type="aborted",this.name=n??"AbortError",this.code=t??"ABORT_ERR"}}function xV(r,e){const t=new vV(e?.errorMessage,e?.errorCode,e?.errorName),n=new AbortController,s=()=>{n.abort(t)};let i=AbortSignal.timeout(r);i.addEventListener("abort",s);const o=n.signal;return o.reset=a=>{i?.removeEventListener("abort",s),i=AbortSignal.timeout(a??r),i.addEventListener("abort",()=>{n.abort(t)})},o.clear=()=>{i?.removeEventListener("abort",s),i=void 0},o}let SV=class{reservations;maxReservations;applyDefaultLimit;reservationTtl;defaultDurationLimit;defaultDataLimit;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:circuit-relay:server:reservation-store"),this.maxReservations=t.maxReservations??lV,this.applyDefaultLimit=t.applyDefaultLimit!==!1,this.reservationTtl=t.reservationTtl??uV,this.defaultDurationLimit=t.defaultDurationLimit??hV,this.defaultDataLimit=t.defaultDataLimit??pV,this.reservations=ig({metrics:e.metrics,name:"libp2p_circuit_relay_server_reservations_total"})}reserve(e,t,n){let s=this.reservations.get(e);if(this.reservations.size>=this.maxReservations&&s==null)return{status:yt.RESERVATION_REFUSED};const i=new Date(Date.now()+this.reservationTtl);let o;return this.applyDefaultLimit&&(o=n??{data:this.defaultDataLimit,duration:this.defaultDurationLimit}),s!=null?(this.log("refreshing reservation for client %p",e),s.signal.reset(this.reservationTtl)):(this.log("creating new reservation for client %p",e),s={addr:t,expiry:i,limit:o,signal:xV(this.reservationTtl)}),this.reservations.set(e,s),s.signal.addEventListener("abort",()=>{this.reservations.delete(e)}),{status:yt.OK,expire:Math.round(i.getTime()/1e3)}}removeReservation(e){this.reservations.delete(e)}get(e){return this.reservations.get(e)}clear(){this.reservations.clear()}};class Hg{domain="libp2p-relay-rsvp";codec=new Uint8Array([3,2]);relay;peer;expiration;constructor({relay:e,peer:t,expiration:n}){this.relay=e,this.peer=t,this.expiration=n}marshal(){return Vl.encode({relay:this.relay.toMultihash().bytes,peer:this.peer.toMultihash().bytes,expiration:BigInt(this.expiration)})}equals(e){return!(!(e instanceof Hg)||!this.peer.equals(e.peer)||!this.relay.equals(e.relay)||this.expiration!==e.expiration)}}const D5=r=>r.protoCodes().includes(m_),AV={maxOutboundStopStreams:M3};class IV extends Cn{registrar;peerStore;addressManager;peerId;privateKey;connectionManager;connectionGater;reservationStore;started;hopTimeout;shutdownController;maxInboundHopStreams;maxOutboundHopStreams;maxOutboundStopStreams;log;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:server"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.addressManager=e.addressManager,this.peerId=e.peerId,this.privateKey=e.privateKey,this.connectionManager=e.connectionManager,this.connectionGater=e.connectionGater,this.started=!1,this.hopTimeout=t?.hopTimeout??gV,this.maxInboundHopStreams=t.maxInboundHopStreams,this.maxOutboundHopStreams=t.maxOutboundHopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??AV.maxOutboundStopStreams,this.reservationStore=new SV(e,t.reservations),this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-server";isStarted(){return this.started}async start(){this.started||(await this.registrar.handle(ac,e=>{this.onHop(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxInboundHopStreams,maxOutboundStreams:this.maxOutboundHopStreams,runOnLimitedConnection:!0}),this.started=!0)}async stop(){this.reservationStore.clear(),this.shutdownController.abort(),await this.registrar.unhandle(ac),this.started=!1}async onHop({connection:e,stream:t}){this.log("received circuit v2 hop protocol stream from %p",e.remotePeer);const n={signal:AbortSignal.timeout(this.hopTimeout)},s=gr(t);try{const i=await s.pb(Lt).read(n);if(i?.type==null)throw new Error("request was invalid, could not read from stream");this.log("received",i.type),await this.handleHopProtocol({connection:e,stream:s,request:i},n)}catch(i){this.log.error("error while handling hop",i),await s.pb(Lt).write({type:Lt.Type.STATUS,status:yt.MALFORMED_MESSAGE},n),t.abort(i)}}async handleHopProtocol({stream:e,request:t,connection:n},s){switch(this.log("received hop message"),t.type){case Lt.Type.RESERVE:await this.handleReserve({stream:e,request:t,connection:n},s);break;case Lt.Type.CONNECT:await this.handleConnect({stream:e,request:t,connection:n},s);break;default:this.log.error("invalid hop request type %s via peer %p",t.type,n.remotePeer),await e.pb(Lt).write({type:Lt.Type.STATUS,status:yt.UNEXPECTED_MESSAGE})}}async handleReserve({stream:e,connection:t},n){const s=e.pb(Lt);if(this.log("hop reserve request from %p",t.remotePeer),D5(t.remoteAddr)){this.log.error("relay reservation over circuit connection denied for peer: %p",t.remotePeer),await s.write({type:Lt.Type.STATUS,status:yt.PERMISSION_DENIED},n);return}if(await this.connectionGater.denyInboundRelayReservation?.(t.remotePeer)===!0){this.log.error("reservation for %p denied by connection gater",t.remotePeer),await s.write({type:Lt.Type.STATUS,status:yt.PERMISSION_DENIED},n);return}const i=this.reservationStore.reserve(t.remotePeer,t.remoteAddr);try{if(i.status!==yt.OK){await s.write({type:Lt.Type.STATUS,status:i.status},n);return}if(i.expire!=null){const o=i.expire*1e3-Date.now();await this.peerStore.merge(t.remotePeer,{tags:{[A5]:{value:1,ttl:o},[I5]:{value:1,ttl:o}}})}await s.write({type:Lt.Type.STATUS,status:yt.OK,reservation:await this.makeReservation(t.remotePeer,BigInt(i.expire??0)),limit:this.reservationStore.get(t.remotePeer)?.limit},n),this.log("sent confirmation response to %s",t.remotePeer)}catch(o){this.log.error("failed to send confirmation response to %p - %e",t.remotePeer,o),this.reservationStore.removeReservation(t.remotePeer);try{await this.peerStore.merge(t.remotePeer,{tags:{[A5]:void 0,[I5]:void 0}})}catch(a){this.log.error("failed to untag relay source peer %p - %e",t.remotePeer,a)}}}async makeReservation(e,t){const n=[];for(const i of this.addressManager.getAddresses())i.toString().includes("/p2p-circuit")||n.push(i.bytes);const s=await ss.seal(new Hg({peer:e,relay:this.peerId,expiration:t}),this.privateKey);return{addrs:n,expire:t,voucher:{publicKey:cV(s.publicKey),payloadType:s.payloadType,payload:{peer:e.toMultihash().bytes,relay:this.peerId.toMultihash().bytes,expiration:t},signature:s.signature}}}async handleConnect({stream:e,request:t,connection:n},s){const i=e.pb(Lt);if(D5(n.remoteAddr)){this.log.error("relay reservation over circuit connection denied for peer: %p",n.remotePeer),await i.write({type:Lt.Type.STATUS,status:yt.PERMISSION_DENIED},s);return}this.log("hop connect request from %p",n.remotePeer);let o;try{if(t.peer==null)throw this.log.error("no peer info in hop connect request"),new Error("no peer info in request");t.peer.addrs.forEach(lt),o=mr(Gn(t.peer.id))}catch(p){this.log.error("invalid hop connect request via peer %p %s",n.remotePeer,p),await i.write({type:Lt.Type.STATUS,status:yt.MALFORMED_MESSAGE},s);return}const a=this.reservationStore.get(o);if(a==null){this.log.error("hop connect denied for destination peer %p not having a reservation for %p with status %s",o,n.remotePeer,yt.NO_RESERVATION),await i.write({type:Lt.Type.STATUS,status:yt.NO_RESERVATION},s);return}if(await this.connectionGater.denyOutboundRelayedConnection?.(n.remotePeer,o)===!0){this.log.error("hop connect for %p to %p denied by connection gater",n.remotePeer,o),await i.write({type:Lt.Type.STATUS,status:yt.PERMISSION_DENIED},s);return}const c=this.connectionManager.getConnections(o);if(c.length===0){this.log("hop connect denied for destination peer %p not having a connection for %p as there is no destination connection",o,n.remotePeer),await i.write({type:Lt.Type.STATUS,status:yt.NO_RESERVATION},s);return}const l=c[0],h=await this.stopHop({connection:l,request:{type:Rr.Type.CONNECT,peer:{id:n.remotePeer.toMultihash().bytes,addrs:[]},limit:a?.limit}},s);if(h==null){this.log.error("failed to open stream to destination peer %p",l?.remotePeer),await i.write({type:Lt.Type.STATUS,status:yt.CONNECTION_FAILED},s);return}await i.write({type:Lt.Type.STATUS,status:yt.OK,limit:a?.limit},s);const f=e.unwrap();this.log("connection from %p to %p established - merging streams",n.remotePeer,o),EV(f,h,this.shutdownController.signal,a,{log:this.log})}async stopHop({connection:e,request:t},n){this.log("starting circuit relay v2 stop request to %s",e.remotePeer);const s=await e.newStream([$3],{maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0,...n}),i=gr(s),o=i.pb(Rr);await o.write(t,n);let a;try{a=await o.read(n)}catch{this.log.error("error parsing stop message response from %p",e.remotePeer)}if(a==null){this.log.error("could not read response from %p",e.remotePeer),await s.close(n);return}if(a.status===yt.OK)return this.log("stop request to %p was successful",e.remotePeer),i.unwrap();this.log("stop request failed with code %d",a.status),await s.close(n)}get reservations(){return this.reservationStore.reservations}}function TV(r={}){return e=>new IV(e,r)}function kV(r){return r[Symbol.asyncIterator]!=null}function q5(r){return r?.then!=null}function __(r,e){let t=0;if(kV(r))return(async function*(){for await(const c of r){const l=e(c,t++);q5(l)&&await l,yield c}})();const n=vg(r),{value:s,done:i}=n.next();if(i===!0)return(function*(){})();const o=e(s,t++);if(typeof o?.then=="function")return(async function*(){await o,yield s;for(const c of n){const l=e(c,t++);q5(l)&&await l,yield c}})();const a=e;return(function*(){yield s;for(const c of n)a(c,t++),yield c})()}function B5(r){const{stream:e,remoteAddr:t,log:n,onDataRead:s,onDataWrite:i}=r;let o=!1,a=!1;const c=e.close.bind(e);e.close=async m=>{await c(m),p(!0)};const l=e.abort.bind(e);e.abort=m=>{l(m),p(!0)};const h=e.sink.bind(e);e.sink=async m=>{try{await h(Ar(m,_=>__(_,R=>i?.(R))))}catch(_){f.log.error("errored - %e",_),_.type!=="aborted"&&f.log.error("%s error in sink - %e",t,_)}finally{a=!0,p()}};const f={log:n.newScope("stream-to-maconn"),sink:e.sink,source:(async function*(){try{for await(const m of e.source)s?.(m),yield m}finally{o=!0,p()}})(),remoteAddr:t,timeline:{open:Date.now(),close:void 0},close:e.close,abort:e.abort};function p(m){m===!0&&(o=!0,a=!0),o&&a&&f.timeline.close==null&&(f.timeline.close=Date.now())}return f}class CV extends Cn{components;started;running;topologyId;log;discoveryController;filter;queue;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.components=e,this.started=!1,this.running=!1,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal,this.dialPeer=this.dialPeer.bind(this),this.onPeer=this.onPeer.bind(this)}isStarted(){return this.started}async start(){this.topologyId=await this.components.registrar.register(ac,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.components.registrar.unregister(this.topologyId),this.running&&this.stopDiscovery(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,this.components.events.addEventListener("peer:discovery",this.onPeer),Promise.resolve().then(async()=>{this.log("searching peer store for relays");const e=await this.components.peerStore.all({filters:[n=>n.protocols.includes(ac)],orders:[()=>Math.random()<.5?1:-1,(n,s)=>{const i=L5(n),o=L5(s);return i>o?-1:o>i?1:0}]});for(const n of e)this.log.trace("found relay peer %p in peer store",n.id),this.safeDispatchEvent("relay:discover",{detail:n.id});this.log("found %d relay peers in peer store",e.length);const t=this.queue=new ec({concurrency:5});this.log("start random walk");for await(const n of this.components.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",n.id),t.has(n.id)){this.log.trace("random peer %p was already in queue",n.id);continue}if(this.components.connectionManager.getConnections(n.id)?.length>0){this.log.trace("random peer %p was already connected",n.id);continue}if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable",n.id,n.multiaddrs.map(s=>s.toString()));continue}t.queued>10&&(this.log.trace("wait for space in queue for %p",n.id),await t.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",n.id,t.size,t.running),t.add(this.dialPeer,{peerId:n.id,signal:this.discoveryController.signal}).catch(s=>{this.log.error("error opening connection to random peer %p",n.id,s)})}this.log("stop random walk"),await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort(),this.queue?.clear(),this.components.events.removeEventListener("peer:discovery",this.onPeer)}onPeer(e){this.log.trace("maybe dialing discovered peer %p - %e",e.detail.id),this.maybeDialPeer(e).catch(t=>{this.log.trace("error dialing discovered peer %p - %e",e.detail.id,t)})}async maybeDialPeer(e){if(this.queue==null)return;const t=e.detail.id,n=e.detail.multiaddrs;if(this.queue.has(t)){this.log.trace("random peer %p was already in queue",t);return}if(this.components.connectionManager.getConnections(t)?.length>0){this.log.trace("random peer %p was already connected",t);return}if(!await this.components.connectionManager.isDialable(n)){this.log.trace("random peer %p was not dialable",t);return}this.queue?.add(this.dialPeer,{peerId:e.detail.id,signal:this.discoveryController.signal}).catch(s=>{this.log.error("error opening connection to discovered peer %p",e.detail.id,s)})}async dialPeer({peerId:e,signal:t}){const n=zn([AbortSignal.timeout(5e3),t]);try{await this.components.connectionManager.openConnection(e,{signal:n})}finally{n.clear()}}}function L5(r){const e=r.metadata.get("last-dial-success");return e==null?0:new Date(Le(e)).getTime()}class RV extends Cn{connectionManager;addressManager;reservationStore;listeningAddrs;log;listenTimeout;reservationId;relay;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=t.listenTimeout??y_,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}_onRemoveRelayPeer=e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(t=>{this.addressManager.removeObservedAddr(t)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))};_onAddRelayPeer=e=>{const{details:t}=e.detail;t.type!=="configured"&&t.id===this.reservationId&&this.addedRelay(e.detail)};async listen(e){if(w_.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(b_.exactMatch(e)){this.log("listen on specific relay server %a",e);const t=AbortSignal.timeout(this.listenTimeout),n=e.decapsulate("/p2p-circuit"),s=await this.connectionManager.openConnection(n,{signal:t});if(!this.reservationStore.hasReservation(s.remotePeer)){this.log("making reservation on peer %p",s.remotePeer);const i=await this.reservationStore.addRelay(s.remotePeer,"configured");this.addedRelay(i)}}else throw new X2(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(t=>lt(t).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(t=>{this.addressManager.confirmObservedAddr(t,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}}function PV(r){return new RV(r)}const DV="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let qV=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r|=0));for(;r--;)e+=DV[t[r]&63];return e};const BV=60*1e3*10,LV=60*1e3*5,OV=30*1e3;class $V extends Cn{peerId;connectionManager;peerStore;events;reserveQueue;reservations;pendingReservations;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new Fo,this.pendingReservations=[],this.maxReservationQueueLength=t?.maxReservationQueueLength??dV,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??y_,this.started=!1,this.relayFilter=xo(100),this.reserveQueue=new ec({concurrency:t?.reservationConcurrency??fV,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",n=>{[...this.reservations.values()].find(i=>i.connection===n.detail.id)!=null&&this.#t(n.detail.remotePeer).catch(i=>{this.log("could not remove relay %p - %e",n.detail,i)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>t.tags.has(Tf)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async t=>{await this.peerStore.merge(t.id,{tags:{[Tf]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async t=>this.addRelay(t.id,"discovered"))),this.#n()}).catch(e=>{this.log.error(e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){const e=qV();return this.pendingReservations.push(e),this.#n(),e}async addRelay(e,t){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new X2("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new _V("The reservation queue is full");const n=this.reserveQueue.find(e);if(n!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),n.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new X2("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{const s=Date.now();try{const i=this.reservations.get(e);if(i!=null){const _=this.connectionManager.getConnections(e);let R=!1;if(_.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),_.map(T=>T.id).includes(i.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),R=!0),R&&R5(i.reservation.expire)>BV)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:i};await this.#t(e)}if(t==="discovered"&&this.pendingReservations.length===0)throw new k5("Not making reservation on discovered relay because we do not need any more relays");const o=AbortSignal.timeout(this.reservationCompletionTimeout);const a=await this.connectionManager.openConnection(e,{signal:o});if(Li.matches(a.remoteAddr))throw new wV("not creating reservation over relayed connection");const c=await this.#e(a,{signal:o}),l=R5(c.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+l).toString());const h=Math.min(Math.max(l-LV,OV),Math.pow(2,31)-1),f=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,t).catch(async _=>{this.log.error("could not refresh reservation to relay %p - %e",e,_),await this.#t(e)}).catch(_=>{this.log.error("could not remove expired reservation to relay %p - %e",e,_)})},h);let p;if(t==="discovered"){const _=this.pendingReservations.pop();if(_==null)throw new k5("Made reservation on relay but did not need any more discovered relays");p={timeout:f,reservation:c,type:t,connection:a.id,id:_}}else p={timeout:f,reservation:c,type:t,connection:a.id};this.reservations.set(e,p),await this.peerStore.merge(e,{tags:{[Tf]:{value:1,ttl:l}}}),this.#n();const m={relay:e,details:p};return this.safeDispatchEvent("relay:created-reservation",{detail:m}),m}catch(i){throw t==="discovered"&&i.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-s,i),(i.name==="DialError"||i.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),this.#t(e).catch(o=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,o)}),i}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((t,n)=>(n.type===e&&t++,t),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const n=await e.newStream(ac,t),i=gr(n).pb(Lt);this.log.trace("send RESERVE to %p",e.remotePeer),await i.write({type:Lt.Type.RESERVE},t);let o;try{this.log.trace("reading response from %p",e.remotePeer),o=await i.read(t)}catch(c){throw n.abort(c),c}finally{n.status!=="closed"&&await n.close(t)}if(this.log.trace("read response %o",o),o.status===yt.OK&&o.reservation!=null){const c=new Set;c.add(e.remoteAddr.toString());for(const l of o.reservation.addrs){let h=lt(l);h.getPeerId()==null&&(h=h.encapsulate(`/p2p/${e.remotePeer}`)),h=lt(h.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),c.add(h.toString())}return o.reservation.addrs=[...c].map(l=>lt(l).bytes),o.reservation}const a=`reservation failed with status ${o.status??"undefined"}`;throw this.log.error(a),new Error(a)}async#t(e){const t=this.reservations.get(e);t!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),t.type==="discovered"&&this.pendingReservations.push(t.id),await this.peerStore.merge(e,{tags:{[Tf]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:t}}),this.#n())}#n(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=xo(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")}}const MV=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(lt)}catch{return!1}return!0},O5={maxInboundStopStreams:M3,maxOutboundStopStreams:M3};class NV{discovery;registrar;peerStore;connectionManager;transportManager;peerId;upgrader;addressManager;connectionGater;reservationStore;logger;maxInboundStopStreams;maxOutboundStopStreams;started;log;shutdownController;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??O5.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??O5.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new CV(e,{filter:t.discoveryFilter??yP(mV,yV)}),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(s=>{s.name!=="HadEnoughRelaysError"&&s.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p",n.detail,s)})}),this.reservationStore=new $V(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[pr]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[_o](){return this.discovery!=null?["@libp2p/identify"]:[]}[Zp]=!0;isStarted(){return this.started}async start(){this.shutdownController=new AbortController,this.shutdownController.signal,await this.registrar.handle($3,e=>{const t=this.upgrader.createInboundAbortSignal(this.shutdownController.signal);this.onStop(e,t).catch(n=>{this.log.error("error while handling STOP protocol",n),e.stream.abort(n)}).finally(()=>{t.clear()})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await wl(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await Th(this.discovery,this.reservationStore),await this.registrar.unhandle($3),this.started=!1}async dial(e,t){if(e.protoCodes().filter(m=>m===m_).length!==1){const m="Invalid circuit relay address";throw this.log.error(m,e),new jc(m)}const n=e.toString().split("/p2p-circuit"),s=lt(n[0]),i=lt(n[n.length-1]),o=s.getPeerId(),a=i.getPeerId();if(o==null||a==null){const m=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${m}`),new jc(`C${m}`)}const c=Vn(o),l=Vn(a);let f=this.connectionManager.getConnections(c)[0];f==null?(await this.peerStore.merge(c,{multiaddrs:[s]}),t.onProgress?.(new fn("circuit-relay:open-connection")),f=await this.connectionManager.openConnection(c,t)):t.onProgress?.(new fn("circuit-relay:reuse-connection"));let p;try{t.onProgress?.(new fn("circuit-relay:open-hop-stream")),p=await f.newStream(ac,t);const m=gr(p),_=m.pb(Lt);t.onProgress?.(new fn("circuit-relay:write-connect-message")),await _.write({type:Lt.Type.CONNECT,peer:{id:l.toMultihash().bytes,addrs:[lt(i).bytes]}},t),t.onProgress?.(new fn("circuit-relay:read-connect-response"));const R=await _.read(t);if(R.status!==yt.OK)throw new Jt(`failed to connect via relay with status ${R?.status?.toString()??"undefined"}`);const T=new P5(R.limit),A=B5({stream:m.unwrap(),remoteAddr:e,localAddr:s.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),log:this.log,onDataRead:T.onData,onDataWrite:T.onData}),D=await this.upgrader.upgradeOutbound(A,{...t,limits:T.getLimits()});return D.log("outbound relayed connection established to %p with limits %o, over connection %s",D.remotePeer,R.limit??"none",f.id),D}catch(m){throw this.log.error("circuit relay dial to destination %p via relay %p failed",l,c,m),p?.abort(m),m}}createListener(e){return PV({peerId:this.peerId,connectionManager:this.connectionManager,addressManager:this.addressManager,reservationStore:this.reservationStore,logger:this.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>b_.exactMatch(t)||w_.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>Li.exactMatch(t))}async onStop({connection:e,stream:t},n){if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(h){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",h)}const s=gr(t).pb(Rr),i=await s.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,i.type),i?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await s.write({type:Rr.Type.STATUS,status:yt.MALFORMED_MESSAGE},{signal:n}),await t.close();return}if(i.type!==Rr.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await s.write({type:Rr.Type.STATUS,status:yt.UNEXPECTED_MESSAGE},{signal:n}),await t.close();return}if(!MV(i)){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await s.write({type:Rr.Type.STATUS,status:yt.MALFORMED_MESSAGE},{signal:n}),await t.close({signal:n});return}const o=mr(Gn(i.peer.id));if(await this.connectionGater.denyInboundRelayedConnection?.(e.remotePeer,o)===!0){this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await s.write({type:Rr.Type.STATUS,status:yt.PERMISSION_DENIED},{signal:n}),await t.close({signal:n});return}this.log.trace("sending success response to %p",e.remotePeer),await s.write({type:Rr.Type.STATUS,status:yt.OK},{signal:n});const a=new P5(i.limit),c=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`);this.addressManager.getAddresses()[0];const l=B5({stream:s.unwrap().unwrap(),remoteAddr:c,log:this.log,onDataRead:a.onData,onDataWrite:a.onData});await this.upgrader.upgradeInbound(l,{limits:a.getLimits(),signal:n}),l.log("inbound relayed connection established to %p with limits %o, over connection %s",o,i.limit??"none",e.id)}}function UV(r={}){return e=>new NV(e,r)}const FV=parseInt("11111",2),U3=parseInt("10000000",2),HV=parseInt("01111111",2),$5={0:$c,1:$c,2:VV,3:WV,4:GV,5:zV,6:KV,16:$c,22:$c,48:$c};function n1(r,e={offset:0}){const t=r[e.offset]&FV;if(e.offset++,$5[t]!=null)return $5[t](r,e);throw new Error("No decoder for tag "+t)}function Iu(r,e){let t=0;if((r[e.offset]&U3)===U3){const n=r[e.offset]&HV;let s="0x";e.offset++;for(let i=0;i<n;i++,e.offset++)s+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=r[e.offset],e.offset++;return t}function $c(r,e){Iu(r,e);const t=[];for(;!(e.offset>=r.byteLength);){const n=n1(r,e);if(n===null)break;t.push(n)}return t}function VV(r,e){const t=Iu(r,e),n=e.offset,s=e.offset+t,i=[];for(let o=n;o<s;o++)o===n&&r[o]===0||i.push(r[o]);return e.offset+=t,Uint8Array.from(i)}function KV(r,e){const t=Iu(r,e),n=e.offset+t,s=r[e.offset];e.offset++;let i=0,o=0;s<40?(i=0,o=s):s<80?(i=1,o=s-40):(i=2,o=s-80);let a=`${i}.${o}`,c=[];for(;e.offset<n;){const l=r[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let h=0;for(let f=0;f<c.length;f++)h+=c[f]<<f*7;a+=`.${h}`,c=[]}}return a}function zV(r,e){return e.offset++,null}function WV(r,e){const t=Iu(r,e),n=r[e.offset];e.offset++;const s=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function GV(r,e){const t=Iu(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function ZV(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);const t=new Ue;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function Vg(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);const e=ZV(r.byteLength);return new Ue(Uint8Array.from([e.byteLength|U3]),e)}function F3(r){const e=new Ue,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Ue(Uint8Array.from([2]),Vg(e),e)}function E_(r){const e=Uint8Array.from([0]),t=new Ue(e,r);return new Ue(Uint8Array.from([3]),Vg(t),t)}function il(r,e=48){const t=new Ue;for(const n of r)t.append(n);return new Ue(Uint8Array.from([e]),Vg(t),t)}async function jV(r,e,t,n){const s=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();const i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return n?.signal?.throwIfAborted(),i}const YV=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),QV=Uint8Array.from([6,5,43,129,4,0,34]),XV=Uint8Array.from([6,5,43,129,4,0,35]),JV={ext:!0,kty:"EC",crv:"P-256"},eK={ext:!0,kty:"EC",crv:"P-384"},tK={ext:!0,kty:"EC",crv:"P-521"},Y0=32,Q0=48,X0=66;function nK(r){const e=n1(r);return rK(e)}function rK(r){const e=r[1][1][0],t=1;let n,s;if(e.byteLength===Y0*2+1)return n=Le(e.subarray(t,t+Y0),"base64url"),s=Le(e.subarray(t+Y0),"base64url"),new J0({...JV,key_ops:["verify"],x:n,y:s});if(e.byteLength===Q0*2+1)return n=Le(e.subarray(t,t+Q0),"base64url"),s=Le(e.subarray(t+Q0),"base64url"),new J0({...eK,key_ops:["verify"],x:n,y:s});if(e.byteLength===X0*2+1)return n=Le(e.subarray(t,t+X0),"base64url"),s=Le(e.subarray(t+X0),"base64url"),new J0({...tK,key_ops:["verify"],x:n,y:s});throw new ot(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function sK(r){return il([F3(Uint8Array.from([1])),il([iK(r.crv)],160),il([E_(new Ue(Uint8Array.from([4]),Ge(r.x??"","base64url"),Ge(r.y??"","base64url")))],161)]).subarray()}function iK(r){if(r==="P-256")return YV;if(r==="P-384")return QV;if(r==="P-521")return XV;throw new ot(`Invalid curve ${r}`)}let J0=class{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=sK(this.jwk)),this._raw}toMultihash(){return Kt.digest(Ru(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}async verify(e,t,n){return jV(this.jwk,t,e,n)}};const ca=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;function Tu(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Qd(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function Oi(r,...e){if(!Tu(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function r1(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");Qd(r.outputLen),Qd(r.blockLen)}function Xd(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function oK(r,e){Oi(r);const t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Do(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function e2(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function Kr(r,e){return r<<32-e|r>>>e}const v_=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",aK=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function fo(r){if(Oi(r),v_)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=aK[r[t]];return e}const bs={_0:48,_9:57,A:65,F:70,a:97,f:102};function M5(r){if(r>=bs._0&&r<=bs._9)return r-bs._0;if(r>=bs.A&&r<=bs.F)return r-(bs.A-10);if(r>=bs.a&&r<=bs.f)return r-(bs.a-10)}function Jd(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(v_)return Uint8Array.fromHex(r);const e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(t);for(let s=0,i=0;s<t;s++,i+=2){const o=M5(r.charCodeAt(i)),a=M5(r.charCodeAt(i+1));if(o===void 0||a===void 0){const c=r[i]+r[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[s]=o*16+a}return n}function cK(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function Kl(r){return typeof r=="string"&&(r=cK(r)),Oi(r),r}function jr(...r){let e=0;for(let n=0;n<r.length;n++){const s=r[n];Oi(s),e+=s.length}const t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){const i=r[n];t.set(i,s),s+=i.length}return t}class x_{}function S_(r){const e=n=>r().update(Kl(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function ku(r=32){if(ca&&typeof ca.getRandomValues=="function")return ca.getRandomValues(new Uint8Array(r));if(ca&&typeof ca.randomBytes=="function")return Uint8Array.from(ca.randomBytes(r));throw new Error("crypto.getRandomValues must be defined")}function lK(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const s=BigInt(32),i=BigInt(4294967295),o=Number(t>>s&i),a=Number(t&i),c=n?4:0,l=n?0:4;r.setUint32(e+c,o,n),r.setUint32(e+l,a,n)}function uK(r,e,t){return r&e^~r&t}function fK(r,e,t){return r&e^r&t^e&t}let A_=class extends x_{constructor(e,t,n,s){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=e2(this.buffer)}update(e){Xd(this),e=Kl(e),Oi(e);const{view:t,buffer:n,blockLen:s}=this,i=e.length;for(let o=0;o<i;){const a=Math.min(s-this.pos,i-o);if(a===s){const c=e2(e);for(;s<=i-o;o+=s)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Xd(this),oK(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:s,isLE:i}=this;let{pos:o}=this;t[o++]=128,Do(this.buffer.subarray(o)),this.padOffset>s-o&&(this.process(n,0),o=0);for(let f=o;f<s;f++)t[f]=0;lK(n,s-8,BigInt(this.length*8),i),this.process(n,0);const a=e2(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=c/4,h=this.get();if(l>h.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<l;f++)a.setUint32(4*f,h[f],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:n,length:s,finished:i,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=i,e.length=s,e.pos=a,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}};const fi=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),$n=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),kf=BigInt(2**32-1),N5=BigInt(32);function dK(r,e=!1){return e?{h:Number(r&kf),l:Number(r>>N5&kf)}:{h:Number(r>>N5&kf)|0,l:Number(r&kf)|0}}function hK(r,e=!1){const t=r.length;let n=new Uint32Array(t),s=new Uint32Array(t);for(let i=0;i<t;i++){const{h:o,l:a}=dK(r[i],e);[n[i],s[i]]=[o,a]}return[n,s]}const U5=(r,e,t)=>r>>>t,F5=(r,e,t)=>r<<32-t|e>>>t,la=(r,e,t)=>r>>>t|e<<32-t,ua=(r,e,t)=>r<<32-t|e>>>t,Cf=(r,e,t)=>r<<64-t|e>>>t-32,Rf=(r,e,t)=>r>>>t-32|e<<64-t;function ws(r,e,t,n){const s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}const pK=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),gK=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,mK=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),yK=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,bK=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),wK=(r,e,t,n,s,i)=>e+t+n+s+i+(r/2**32|0)|0,_K=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),di=new Uint32Array(64);class EK extends A_{constructor(e=32){super(64,e,8,!1),this.A=fi[0]|0,this.B=fi[1]|0,this.C=fi[2]|0,this.D=fi[3]|0,this.E=fi[4]|0,this.F=fi[5]|0,this.G=fi[6]|0,this.H=fi[7]|0}get(){const{A:e,B:t,C:n,D:s,E:i,F:o,G:a,H:c}=this;return[e,t,n,s,i,o,a,c]}set(e,t,n,s,i,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let f=0;f<16;f++,t+=4)di[f]=e.getUint32(t,!1);for(let f=16;f<64;f++){const p=di[f-15],m=di[f-2],_=Kr(p,7)^Kr(p,18)^p>>>3,R=Kr(m,17)^Kr(m,19)^m>>>10;di[f]=R+di[f-7]+_+di[f-16]|0}let{A:n,B:s,C:i,D:o,E:a,F:c,G:l,H:h}=this;for(let f=0;f<64;f++){const p=Kr(a,6)^Kr(a,11)^Kr(a,25),m=h+p+uK(a,c,l)+_K[f]+di[f]|0,R=(Kr(n,2)^Kr(n,13)^Kr(n,22))+fK(n,s,i)|0;h=l,l=c,c=a,a=o+m|0,o=i,i=s,s=n,n=m+R|0}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,h=h+this.H|0,this.set(n,s,i,o,a,c,l,h)}roundClean(){Do(di)}destroy(){this.set(0,0,0,0,0,0,0,0),Do(this.buffer)}}const I_=hK(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),vK=I_[0],xK=I_[1],hi=new Uint32Array(80),pi=new Uint32Array(80);class SK extends A_{constructor(e=64){super(128,e,16,!1),this.Ah=$n[0]|0,this.Al=$n[1]|0,this.Bh=$n[2]|0,this.Bl=$n[3]|0,this.Ch=$n[4]|0,this.Cl=$n[5]|0,this.Dh=$n[6]|0,this.Dl=$n[7]|0,this.Eh=$n[8]|0,this.El=$n[9]|0,this.Fh=$n[10]|0,this.Fl=$n[11]|0,this.Gh=$n[12]|0,this.Gl=$n[13]|0,this.Hh=$n[14]|0,this.Hl=$n[15]|0}get(){const{Ah:e,Al:t,Bh:n,Bl:s,Ch:i,Cl:o,Dh:a,Dl:c,Eh:l,El:h,Fh:f,Fl:p,Gh:m,Gl:_,Hh:R,Hl:T}=this;return[e,t,n,s,i,o,a,c,l,h,f,p,m,_,R,T]}set(e,t,n,s,i,o,a,c,l,h,f,p,m,_,R,T){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=h|0,this.Fh=f|0,this.Fl=p|0,this.Gh=m|0,this.Gl=_|0,this.Hh=R|0,this.Hl=T|0}process(e,t){for(let I=0;I<16;I++,t+=4)hi[I]=e.getUint32(t),pi[I]=e.getUint32(t+=4);for(let I=16;I<80;I++){const q=hi[I-15]|0,L=pi[I-15]|0,z=la(q,L,1)^la(q,L,8)^U5(q,L,7),Y=ua(q,L,1)^ua(q,L,8)^F5(q,L,7),k=hi[I-2]|0,x=pi[I-2]|0,F=la(k,x,19)^Cf(k,x,61)^U5(k,x,6),j=ua(k,x,19)^Rf(k,x,61)^F5(k,x,6),U=mK(Y,j,pi[I-7],pi[I-16]),y=yK(U,z,F,hi[I-7],hi[I-16]);hi[I]=y|0,pi[I]=U|0}let{Ah:n,Al:s,Bh:i,Bl:o,Ch:a,Cl:c,Dh:l,Dl:h,Eh:f,El:p,Fh:m,Fl:_,Gh:R,Gl:T,Hh:A,Hl:D}=this;for(let I=0;I<80;I++){const q=la(f,p,14)^la(f,p,18)^Cf(f,p,41),L=ua(f,p,14)^ua(f,p,18)^Rf(f,p,41),z=f&m^~f&R,Y=p&_^~p&T,k=bK(D,L,Y,xK[I],pi[I]),x=wK(k,A,q,z,vK[I],hi[I]),F=k|0,j=la(n,s,28)^Cf(n,s,34)^Cf(n,s,39),U=ua(n,s,28)^Rf(n,s,34)^Rf(n,s,39),y=n&i^n&a^i&a,b=s&o^s&c^o&c;A=R|0,D=T|0,R=m|0,T=_|0,m=f|0,_=p|0,{h:f,l:p}=ws(l|0,h|0,x|0,F|0),l=a|0,h=c|0,a=i|0,c=o|0,i=n|0,o=s|0;const g=pK(F,U,b);n=gK(g,x,j,y),s=g|0}({h:n,l:s}=ws(this.Ah|0,this.Al|0,n|0,s|0)),{h:i,l:o}=ws(this.Bh|0,this.Bl|0,i|0,o|0),{h:a,l:c}=ws(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:h}=ws(this.Dh|0,this.Dl|0,l|0,h|0),{h:f,l:p}=ws(this.Eh|0,this.El|0,f|0,p|0),{h:m,l:_}=ws(this.Fh|0,this.Fl|0,m|0,_|0),{h:R,l:T}=ws(this.Gh|0,this.Gl|0,R|0,T|0),{h:A,l:D}=ws(this.Hh|0,this.Hl|0,A|0,D|0),this.set(n,s,i,o,a,c,l,h,f,p,m,_,R,T,A,D)}roundClean(){Do(hi,pi)}destroy(){Do(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const T_=S_(()=>new EK),AK=S_(()=>new SK);const Kg=BigInt(0),H3=BigInt(1);function qo(r,e=""){if(typeof r!="boolean"){const t=e&&`"${e}"`;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function qr(r,e,t=""){const n=Tu(r),s=r?.length,i=e!==void 0;if(!n||i&&s!==e){const o=t&&`"${t}" `,a=i?` of length ${e}`:"",c=n?`length=${s}`:`type=${typeof r}`;throw new Error(o+"expected Uint8Array"+a+", got "+c)}return r}function Pf(r){const e=r.toString(16);return e.length&1?"0"+e:e}function k_(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?Kg:BigInt("0x"+r)}function s1(r){return k_(fo(r))}function Bo(r){return Oi(r),k_(fo(Uint8Array.from(r).reverse()))}function zg(r,e){return Jd(r.toString(16).padStart(e*2,"0"))}function Wg(r,e){return zg(r,e).reverse()}function Ft(r,e,t){let n;if(typeof e=="string")try{n=Jd(e)}catch(i){throw new Error(r+" must be hex string or Uint8Array, cause: "+i)}else if(Tu(e))n=Uint8Array.from(e);else throw new Error(r+" must be hex string or Uint8Array");const s=n.length;if(typeof t=="number"&&s!==t)throw new Error(r+" of length "+t+" expected, got "+s);return n}function H5(r){return Uint8Array.from(r)}const t2=r=>typeof r=="bigint"&&Kg<=r;function IK(r,e,t){return t2(r)&&t2(e)&&t2(t)&&e<=r&&r<t}function zl(r,e,t,n){if(!IK(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function C_(r){let e;for(e=0;r>Kg;r>>=H3,e+=1);return e}const Cu=r=>(H3<<BigInt(r))-H3;function TK(r,e,t){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");const n=m=>new Uint8Array(m),s=m=>Uint8Array.of(m);let i=n(r),o=n(r),a=0;const c=()=>{i.fill(1),o.fill(0),a=0},l=(...m)=>t(o,i,...m),h=(m=n(0))=>{o=l(s(0),m),i=l(),m.length!==0&&(o=l(s(1),m),i=l())},f=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let m=0;const _=[];for(;m<e;){i=l();const R=i.slice();_.push(R),m+=i.length}return jr(..._)};return(m,_)=>{c(),h(m);let R;for(;!(R=_(f()));)h();return c(),R}}function Ec(r,e,t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(s,i,o){const a=r[s];if(o&&a===void 0)return;const c=typeof a;if(c!==i||a===null)throw new Error(`param "${s}" is invalid: expected ${i}, got ${c}`)}Object.entries(e).forEach(([s,i])=>n(s,i,!1)),Object.entries(t).forEach(([s,i])=>n(s,i,!0))}function eh(r){const e=new WeakMap;return(t,...n)=>{const s=e.get(t);if(s!==void 0)return s;const i=r(t,...n);return e.set(t,i),i}}const lr=BigInt(0),Tn=BigInt(1),so=BigInt(2),R_=BigInt(3),P_=BigInt(4),D_=BigInt(5),kK=BigInt(7),q_=BigInt(8),CK=BigInt(9),B_=BigInt(16);function Xt(r,e){const t=r%e;return t>=lr?t:e+t}function Vt(r,e,t){let n=r;for(;e-- >lr;)n*=n,n%=t;return n}function V5(r,e){if(r===lr)throw new Error("invert: expected non-zero number");if(e<=lr)throw new Error("invert: expected positive modulus, got "+e);let t=Xt(r,e),n=e,s=lr,i=Tn;for(;t!==lr;){const a=n/t,c=n%t,l=s-i*a;n=t,t=c,s=i,i=l}if(n!==Tn)throw new Error("invert: does not exist");return Xt(s,e)}function Gg(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function L_(r,e){const t=(r.ORDER+Tn)/P_,n=r.pow(e,t);return Gg(r,n,e),n}function RK(r,e){const t=(r.ORDER-D_)/q_,n=r.mul(e,so),s=r.pow(n,t),i=r.mul(e,s),o=r.mul(r.mul(i,so),s),a=r.mul(i,r.sub(o,r.ONE));return Gg(r,a,e),a}function PK(r){const e=Vo(r),t=O_(r),n=t(e,e.neg(e.ONE)),s=t(e,n),i=t(e,e.neg(n)),o=(r+kK)/B_;return(a,c)=>{let l=a.pow(c,o),h=a.mul(l,n);const f=a.mul(l,s),p=a.mul(l,i),m=a.eql(a.sqr(h),c),_=a.eql(a.sqr(f),c);l=a.cmov(l,h,m),h=a.cmov(p,f,_);const R=a.eql(a.sqr(h),c),T=a.cmov(l,h,R);return Gg(a,T,c),T}}function O_(r){if(r<R_)throw new Error("sqrt is not defined for small field");let e=r-Tn,t=0;for(;e%so===lr;)e/=so,t++;let n=so;const s=Vo(r);for(;K5(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return L_;let i=s.pow(n,e);const o=(e+Tn)/so;return function(c,l){if(c.is0(l))return l;if(K5(c,l)!==1)throw new Error("Cannot find square root");let h=t,f=c.mul(c.ONE,i),p=c.pow(l,e),m=c.pow(l,o);for(;!c.eql(p,c.ONE);){if(c.is0(p))return c.ZERO;let _=1,R=c.sqr(p);for(;!c.eql(R,c.ONE);)if(_++,R=c.sqr(R),_===h)throw new Error("Cannot find square root");const T=Tn<<BigInt(h-_-1),A=c.pow(f,T);h=_,f=c.sqr(A),p=c.mul(p,f),m=c.mul(m,A)}return m}}function DK(r){return r%P_===R_?L_:r%q_===D_?RK:r%B_===CK?PK(r):O_(r)}const qK=(r,e)=>(Xt(r,e)&Tn)===Tn,BK=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function LK(r){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},t=BK.reduce((n,s)=>(n[s]="function",n),e);return Ec(r,t),r}function OK(r,e,t){if(t<lr)throw new Error("invalid exponent, negatives unsupported");if(t===lr)return r.ONE;if(t===Tn)return e;let n=r.ONE,s=e;for(;t>lr;)t&Tn&&(n=r.mul(n,s)),s=r.sqr(s),t>>=Tn;return n}function $_(r,e,t=!1){const n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((o,a,c)=>r.is0(a)?o:(n[c]=o,r.mul(o,a)),r.ONE),i=r.inv(s);return e.reduceRight((o,a,c)=>r.is0(a)?o:(n[c]=r.mul(o,n[c]),r.mul(o,a)),i),n}function K5(r,e){const t=(r.ORDER-Tn)/so,n=r.pow(e,t),s=r.eql(n,r.ONE),i=r.eql(n,r.ZERO),o=r.eql(n,r.neg(r.ONE));if(!s&&!i&&!o)throw new Error("invalid Legendre symbol result");return s?1:i?0:-1}function M_(r,e){e!==void 0&&Qd(e);const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}function Vo(r,e,t=!1,n={}){if(r<=lr)throw new Error("invalid field: expected ORDER > 0, got "+r);let s,i,o=!1,a;if(typeof e=="object"&&e!=null){if(n.sqrt||t)throw new Error("cannot specify opts in two arguments");const p=e;p.BITS&&(s=p.BITS),p.sqrt&&(i=p.sqrt),typeof p.isLE=="boolean"&&(t=p.isLE),typeof p.modFromBytes=="boolean"&&(o=p.modFromBytes),a=p.allowedLengths}else typeof e=="number"&&(s=e),n.sqrt&&(i=n.sqrt);const{nBitLength:c,nByteLength:l}=M_(r,s);if(l>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let h;const f=Object.freeze({ORDER:r,isLE:t,BITS:c,BYTES:l,MASK:Cu(c),ZERO:lr,ONE:Tn,allowedLengths:a,create:p=>Xt(p,r),isValid:p=>{if(typeof p!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof p);return lr<=p&&p<r},is0:p=>p===lr,isValidNot0:p=>!f.is0(p)&&f.isValid(p),isOdd:p=>(p&Tn)===Tn,neg:p=>Xt(-p,r),eql:(p,m)=>p===m,sqr:p=>Xt(p*p,r),add:(p,m)=>Xt(p+m,r),sub:(p,m)=>Xt(p-m,r),mul:(p,m)=>Xt(p*m,r),pow:(p,m)=>OK(f,p,m),div:(p,m)=>Xt(p*V5(m,r),r),sqrN:p=>p*p,addN:(p,m)=>p+m,subN:(p,m)=>p-m,mulN:(p,m)=>p*m,inv:p=>V5(p,r),sqrt:i||(p=>(h||(h=DK(r)),h(f,p))),toBytes:p=>t?Wg(p,l):zg(p,l),fromBytes:(p,m=!0)=>{if(a){if(!a.includes(p.length)||p.length>l)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+p.length);const R=new Uint8Array(l);R.set(p,t?0:R.length-p.length),p=R}if(p.length!==l)throw new Error("Field.fromBytes: expected "+l+" bytes, got "+p.length);let _=t?Bo(p):s1(p);if(o&&(_=Xt(_,r)),!m&&!f.isValid(_))throw new Error("invalid field element: outside of range 0..ORDER");return _},invertBatch:p=>$_(f,p),cmov:(p,m,_)=>_?m:p});return Object.freeze(f)}function N_(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function U_(r){const e=N_(r);return e+Math.ceil(e/2)}function $K(r,e,t=!1){const n=r.length,s=N_(e),i=U_(e);if(n<16||n<i||n>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+n);const o=t?Bo(r):s1(r),a=Xt(o,e-Tn)+Tn;return t?Wg(a,s):zg(a,s)}const uc=BigInt(0),io=BigInt(1);function th(r,e){const t=e.negate();return r?t:e}function oo(r,e){const t=$_(r.Fp,e.map(n=>n.Z));return e.map((n,s)=>r.fromAffine(n.toAffine(t[s])))}function F_(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function n2(r,e){F_(r,e);const t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,i=Cu(r),o=BigInt(r);return{windows:t,windowSize:n,mask:i,maxNumber:s,shiftBy:o}}function z5(r,e,t){const{windowSize:n,mask:s,maxNumber:i,shiftBy:o}=t;let a=Number(r&s),c=r>>o;a>n&&(a-=i,c+=io);const l=e*n,h=l+Math.abs(a)-1,f=a===0,p=a<0,m=e%2!==0;return{nextN:c,offset:h,isZero:f,isNeg:p,isNegF:m,offsetF:l}}function MK(r,e){if(!Array.isArray(r))throw new Error("array expected");r.forEach((t,n)=>{if(!(t instanceof e))throw new Error("invalid point at index "+n)})}function NK(r,e){if(!Array.isArray(r))throw new Error("array of scalars expected");r.forEach((t,n)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+n)})}const r2=new WeakMap,H_=new WeakMap;function s2(r){return H_.get(r)||1}function W5(r){if(r!==uc)throw new Error("invalid wNAF")}let V_=class{constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let s=e;for(;t>uc;)t&io&&(n=n.add(s)),s=s.double(),t>>=io;return n}precomputeWindow(e,t){const{windows:n,windowSize:s}=n2(t,this.bits),i=[];let o=e,a=o;for(let c=0;c<n;c++){a=o,i.push(a);for(let l=1;l<s;l++)a=a.add(o),i.push(a);o=a.double()}return i}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,i=this.BASE;const o=n2(e,this.bits);for(let a=0;a<o.windows;a++){const{nextN:c,offset:l,isZero:h,isNeg:f,isNegF:p,offsetF:m}=z5(n,a,o);n=c,h?i=i.add(th(p,t[m])):s=s.add(th(f,t[l]))}return W5(n),{p:s,f:i}}wNAFUnsafe(e,t,n,s=this.ZERO){const i=n2(e,this.bits);for(let o=0;o<i.windows&&n!==uc;o++){const{nextN:a,offset:c,isZero:l,isNeg:h}=z5(n,o,i);if(n=a,!l){const f=t[c];s=s.add(h?f.negate():f)}}return W5(n),s}getPrecomputes(e,t,n){let s=r2.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(s=n(s)),r2.set(t,s))),s}cached(e,t,n){const s=s2(e);return this.wNAF(s,this.getPrecomputes(s,e,n),t)}unsafe(e,t,n,s){const i=s2(e);return i===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(i,this.getPrecomputes(i,e,n),t,s)}createCache(e,t){F_(t,this.bits),H_.set(e,t),r2.delete(e)}hasCache(e){return s2(e)!==1}};function UK(r,e,t,n){let s=e,i=r.ZERO,o=r.ZERO;for(;t>uc||n>uc;)t&io&&(i=i.add(s)),n&io&&(o=o.add(s)),s=s.double(),t>>=io,n>>=io;return{p1:i,p2:o}}function K_(r,e,t,n){MK(t,r),NK(n,e);const s=t.length,i=n.length;if(s!==i)throw new Error("arrays of points and scalars must have equal length");const o=r.ZERO,a=C_(BigInt(s));let c=1;a>12?c=a-3:a>4?c=a-2:a>0&&(c=2);const l=Cu(c),h=new Array(Number(l)+1).fill(o),f=Math.floor((e.BITS-1)/c)*c;let p=o;for(let m=f;m>=0;m-=c){h.fill(o);for(let R=0;R<i;R++){const T=n[R],A=Number(T>>BigInt(m)&l);h[A]=h[A].add(t[R])}let _=o;for(let R=h.length-1,T=o;R>0;R--)T=T.add(h[R]),_=_.add(T);if(p=p.add(_),m!==0)for(let R=0;R<c;R++)p=p.double()}return p}function G5(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return LK(e),e}else return Vo(r,{isLE:t})}function z_(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(const c of["p","n","h"]){const l=e[c];if(!(typeof l=="bigint"&&l>uc))throw new Error(`CURVE.${c} must be positive bigint`)}const s=G5(e.p,t.Fp,n),i=G5(e.n,t.Fn,n),a=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(const c of a)if(!s.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:i}}const gi=BigInt(0),yn=BigInt(1),i2=BigInt(2),FK=BigInt(8);function HK(r,e,t,n){const s=r.sqr(t),i=r.sqr(n),o=r.add(r.mul(e.a,s),i),a=r.add(r.ONE,r.mul(e.d,r.mul(s,i)));return r.eql(o,a)}function VK(r,e={}){const t=z_("edwards",r,e,e.FpFnLE),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o}=i;Ec(e,{},{uvRatio:"function"});const a=i2<<BigInt(s.BYTES*8)-yn,c=T=>n.create(T),l=e.uvRatio||((T,A)=>{try{return{isValid:!0,value:n.sqrt(n.div(T,A))}}catch{return{isValid:!1,value:gi}}});if(!HK(n,i,i.Gx,i.Gy))throw new Error("bad curve params: generator point");function h(T,A,D=!1){const I=D?yn:gi;return zl("coordinate "+T,A,I,a),A}function f(T){if(!(T instanceof _))throw new Error("ExtendedPoint expected")}const p=eh((T,A)=>{const{X:D,Y:I,Z:q}=T,L=T.is0();A==null&&(A=L?FK:n.inv(q));const z=c(D*A),Y=c(I*A),k=n.mul(q,A);if(L)return{x:gi,y:yn};if(k!==yn)throw new Error("invZ was invalid");return{x:z,y:Y}}),m=eh(T=>{const{a:A,d:D}=i;if(T.is0())throw new Error("bad point: ZERO");const{X:I,Y:q,Z:L,T:z}=T,Y=c(I*I),k=c(q*q),x=c(L*L),F=c(x*x),j=c(Y*A),U=c(x*c(j+k)),y=c(F+c(D*c(Y*k)));if(U!==y)throw new Error("bad point: equation left != right (1)");const b=c(I*q),g=c(L*z);if(b!==g)throw new Error("bad point: equation left != right (2)");return!0});class _{constructor(A,D,I,q){this.X=h("x",A),this.Y=h("y",D),this.Z=h("z",I,!0),this.T=h("t",q),Object.freeze(this)}static CURVE(){return i}static fromAffine(A){if(A instanceof _)throw new Error("extended point not allowed");const{x:D,y:I}=A||{};return h("x",D),h("y",I),new _(D,I,yn,c(D*I))}static fromBytes(A,D=!1){const I=n.BYTES,{a:q,d:L}=i;A=H5(qr(A,I,"point")),qo(D,"zip215");const z=H5(A),Y=A[I-1];z[I-1]=Y&-129;const k=Bo(z),x=D?a:n.ORDER;zl("point.y",k,gi,x);const F=c(k*k),j=c(F-yn),U=c(L*F-q);let{isValid:y,value:b}=l(j,U);if(!y)throw new Error("bad point: invalid y coordinate");const g=(b&yn)===yn,C=(Y&128)!==0;if(!D&&b===gi&&C)throw new Error("bad point: x=0 and x_0=1");return C!==g&&(b=c(-b)),_.fromAffine({x:b,y:k})}static fromHex(A,D=!1){return _.fromBytes(Ft("point",A),D)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(A=8,D=!0){return R.createCache(this,A),D||this.multiply(i2),this}assertValidity(){m(this)}equals(A){f(A);const{X:D,Y:I,Z:q}=this,{X:L,Y:z,Z:Y}=A,k=c(D*Y),x=c(L*q),F=c(I*Y),j=c(z*q);return k===x&&F===j}is0(){return this.equals(_.ZERO)}negate(){return new _(c(-this.X),this.Y,this.Z,c(-this.T))}double(){const{a:A}=i,{X:D,Y:I,Z:q}=this,L=c(D*D),z=c(I*I),Y=c(i2*c(q*q)),k=c(A*L),x=D+I,F=c(c(x*x)-L-z),j=k+z,U=j-Y,y=k-z,b=c(F*U),g=c(j*y),C=c(F*y),B=c(U*j);return new _(b,g,B,C)}add(A){f(A);const{a:D,d:I}=i,{X:q,Y:L,Z:z,T:Y}=this,{X:k,Y:x,Z:F,T:j}=A,U=c(q*k),y=c(L*x),b=c(Y*I*j),g=c(z*F),C=c((q+L)*(k+x)-U-y),B=g-b,M=g+b,O=c(y-D*U),$=c(C*B),V=c(M*O),G=c(C*O),de=c(B*M);return new _($,V,de,G)}subtract(A){return this.add(A.negate())}multiply(A){if(!s.isValidNot0(A))throw new Error("invalid scalar: expected 1 <= sc < curve.n");const{p:D,f:I}=R.cached(this,A,q=>oo(_,q));return oo(_,[D,I])[0]}multiplyUnsafe(A,D=_.ZERO){if(!s.isValid(A))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return A===gi?_.ZERO:this.is0()||A===yn?this:R.unsafe(this,A,I=>oo(_,I),D)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}isTorsionFree(){return R.unsafe(this,i.n).is0()}toAffine(A){return p(this,A)}clearCofactor(){return o===yn?this:this.multiplyUnsafe(o)}toBytes(){const{x:A,y:D}=this.toAffine(),I=n.toBytes(D);return I[I.length-1]|=A&yn?128:0,I}toHex(){return fo(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get ex(){return this.X}get ey(){return this.Y}get ez(){return this.Z}get et(){return this.T}static normalizeZ(A){return oo(_,A)}static msm(A,D){return K_(_,s,A,D)}_setWindowSize(A){this.precompute(A)}toRawBytes(){return this.toBytes()}}_.BASE=new _(i.Gx,i.Gy,yn,c(i.Gx*i.Gy)),_.ZERO=new _(gi,yn,yn,gi),_.Fp=n,_.Fn=s;const R=new V_(_,s.BITS);return _.BASE.precompute(8),_}function KK(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');Ec(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:n}=t,{BASE:s,Fp:i,Fn:o}=r,a=t.randomBytes||ku,c=t.adjustScalarBytes||(x=>x),l=t.domain||((x,F,j)=>{if(qo(j,"phflag"),F.length||j)throw new Error("Contexts/pre-hash are not supported");return x});function h(x){return o.create(Bo(x))}function f(x){const F=I.secretKey;x=Ft("private key",x,F);const j=Ft("hashed private key",e(x),2*F),U=c(j.slice(0,F)),y=j.slice(F,2*F),b=h(U);return{head:U,prefix:y,scalar:b}}function p(x){const{head:F,prefix:j,scalar:U}=f(x),y=s.multiply(U),b=y.toBytes();return{head:F,prefix:j,scalar:U,point:y,pointBytes:b}}function m(x){return p(x).pointBytes}function _(x=Uint8Array.of(),...F){const j=jr(...F);return h(e(l(j,Ft("context",x),!!n)))}function R(x,F,j={}){x=Ft("message",x),n&&(x=n(x));const{prefix:U,scalar:y,pointBytes:b}=p(F),g=_(j.context,U,x),C=s.multiply(g).toBytes(),B=_(j.context,C,b,x),M=o.create(g+B*y);if(!o.isValid(M))throw new Error("sign failed: invalid s");const O=jr(C,o.toBytes(M));return qr(O,I.signature,"result")}const T={zip215:!0};function A(x,F,j,U=T){const{context:y,zip215:b}=U,g=I.signature;x=Ft("signature",x,g),F=Ft("message",F),j=Ft("publicKey",j,I.publicKey),b!==void 0&&qo(b,"zip215"),n&&(F=n(F));const C=g/2,B=x.subarray(0,C),M=Bo(x.subarray(C,g));let O,$,V;try{O=r.fromBytes(j,b),$=r.fromBytes(B,b),V=s.multiplyUnsafe(M)}catch{return!1}if(!b&&O.isSmallOrder())return!1;const G=_(y,$.toBytes(),O.toBytes(),F);return $.add(O.multiplyUnsafe(G)).subtract(V).clearCofactor().is0()}const D=i.BYTES,I={secretKey:D,publicKey:D,signature:2*D,seed:D};function q(x=a(I.seed)){return qr(x,I.seed,"seed")}function L(x){const F=k.randomSecretKey(x);return{secretKey:F,publicKey:m(F)}}function z(x){return Tu(x)&&x.length===o.BYTES}function Y(x,F){try{return!!r.fromBytes(x,F)}catch{return!1}}const k={getExtendedPublicKey:p,randomSecretKey:q,isValidSecretKey:z,isValidPublicKey:Y,toMontgomery(x){const{y:F}=r.fromBytes(x),j=I.publicKey,U=j===32;if(!U&&j!==57)throw new Error("only defined for 25519 and 448");const y=U?i.div(yn+F,yn-F):i.div(F-yn,F+yn);return i.toBytes(y)},toMontgomerySecret(x){const F=I.secretKey;qr(x,F);const j=e(x.subarray(0,F));return c(j).subarray(0,F)},randomPrivateKey:q,precompute(x=8,F=r.BASE){return F.precompute(x,!1)}};return Object.freeze({keygen:L,getPublicKey:m,sign:R,verify:A,utils:k,Point:r,lengths:I})}function zK(r){const e={a:r.a,d:r.d,p:r.Fp.ORDER,n:r.n,h:r.h,Gx:r.Gx,Gy:r.Gy},t=r.Fp,n=Vo(e.n,r.nBitLength,!0),s={Fp:t,Fn:n,uvRatio:r.uvRatio},i={randomBytes:r.randomBytes,adjustScalarBytes:r.adjustScalarBytes,domain:r.domain,prehash:r.prehash,mapToCurve:r.mapToCurve};return{CURVE:e,curveOpts:s,hash:r.hash,eddsaOpts:i}}function WK(r,e){const t=e.Point;return Object.assign({},e,{ExtendedPoint:t,CURVE:r,nBitLength:t.Fn.BITS,nByteLength:t.Fn.BYTES})}function GK(r){const{CURVE:e,curveOpts:t,hash:n,eddsaOpts:s}=zK(r),i=VK(e,t),o=KK(i,n,s);return WK(r,o)}const Mc=BigInt(0),fa=BigInt(1),Df=BigInt(2);function ZK(r){return Ec(r,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...r})}function jK(r){const e=ZK(r),{P:t,type:n,adjustScalarBytes:s,powPminus2:i,randomBytes:o}=e,a=n==="x25519";if(!a&&n!=="x448")throw new Error("invalid type");const c=o||ku,l=a?255:448,h=a?32:56,f=BigInt(a?9:5),p=BigInt(a?121665:39081),m=a?Df**BigInt(254):Df**BigInt(447),_=a?BigInt(8)*Df**BigInt(251)-fa:BigInt(4)*Df**BigInt(445)-fa,R=m+_+fa,T=y=>Xt(y,t),A=D(f);function D(y){return Wg(T(y),h)}function I(y){const b=Ft("u coordinate",y,h);return a&&(b[31]&=127),T(Bo(b))}function q(y){return Bo(s(Ft("scalar",y,h)))}function L(y,b){const g=k(I(b),q(y));if(g===Mc)throw new Error("invalid private or public key received");return D(g)}function z(y){return L(y,A)}function Y(y,b,g){const C=T(y*(b-g));return b=T(b-C),g=T(g+C),{x_2:b,x_3:g}}function k(y,b){zl("u",y,Mc,t),zl("scalar",b,m,R);const g=b,C=y;let B=fa,M=Mc,O=y,$=fa,V=Mc;for(let de=BigInt(l-1);de>=Mc;de--){const ce=g>>de&fa;V^=ce,{x_2:B,x_3:O}=Y(V,B,O),{x_2:M,x_3:$}=Y(V,M,$),V=ce;const re=B+M,pe=T(re*re),_e=B-M,$e=T(_e*_e),ge=pe-$e,ke=O+$,ht=O-$,qt=T(ht*re),$t=T(ke*_e),xc=qt+$t,Lu=qt-$t;O=T(xc*xc),$=T(C*T(Lu*Lu)),B=T(pe*$e),M=T(ge*(pe+T(p*ge)))}({x_2:B,x_3:O}=Y(V,B,O)),{x_2:M,x_3:$}=Y(V,M,$);const G=i(M);return T(B*G)}const x={secretKey:h,publicKey:h,seed:h},F=(y=c(h))=>(Oi(y,x.seed),y);function j(y){const b=F(y);return{secretKey:b,publicKey:z(b)}}return{keygen:j,getSharedSecret:(y,b)=>L(y,b),getPublicKey:y=>z(y),scalarMult:L,scalarMultBase:z,utils:{randomSecretKey:F,randomPrivateKey:F},GuBytes:A.slice(),lengths:x}}const YK=BigInt(1),Z5=BigInt(2),QK=BigInt(3),XK=BigInt(5),JK=BigInt(8),Zg=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),W_={p:Zg,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:JK,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function G_(r){const e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),i=Zg,a=r*r%i*r%i,c=Vt(a,Z5,i)*a%i,l=Vt(c,YK,i)*r%i,h=Vt(l,XK,i)*l%i,f=Vt(h,e,i)*h%i,p=Vt(f,t,i)*f%i,m=Vt(p,n,i)*p%i,_=Vt(m,s,i)*m%i,R=Vt(_,s,i)*m%i,T=Vt(R,e,i)*h%i;return{pow_p_5_8:Vt(T,Z5,i)*r%i,b2:a}}function Z_(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}const j5=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function ez(r,e){const t=Zg,n=Xt(e*e*e,t),s=Xt(n*n*e,t),i=G_(r*s).pow_p_5_8;let o=Xt(r*n*i,t);const a=Xt(e*o*o,t),c=o,l=Xt(o*j5,t),h=a===r,f=a===Xt(-r,t),p=a===Xt(-r*j5,t);return h&&(o=c),(f||p)&&(o=l),qK(o,t)&&(o=Xt(-o,t)),{isValid:h||f,value:o}}const j_=Vo(W_.p,{isLE:!0}),tz={...W_,Fp:j_,hash:AK,adjustScalarBytes:Z_,uvRatio:ez},jg=GK(tz),qf=(()=>{const r=j_.ORDER;return jK({P:r,type:"x25519",powPminus2:e=>{const{pow_p_5_8:t,b2:n}=G_(e);return Xt(Vt(t,QK,r)*n,r)},adjustScalarBytes:Z_})})();let Y5=class extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}},nz=class extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}};var Lo={get(r=globalThis){const e=r.crypto;if(e?.subtle==null)throw new nz("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};const Y_=32,Yg=64,nh=32;let Da;const Q_=(async()=>{try{return await Lo.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function rz(r){if(r.length!==nh)throw new TypeError('"seed" must be 32 bytes in length.');if(!(r instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const e=r,t=jg.getPublicKey(e);return{privateKey:uz(e,t),publicKey:t}}async function sz(r,e){let t;r.length===Yg?t=r.subarray(0,32):t=r;const n={crv:"Ed25519",kty:"OKP",x:Le(r.subarray(32),"base64url"),d:Le(t,"base64url"),ext:!0,key_ops:["sign"]},s=await Lo.get().subtle.importKey("jwk",n,{name:"Ed25519"},!0,["sign"]),i=await Lo.get().subtle.sign({name:"Ed25519"},s,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(i,0,i.byteLength)}function iz(r,e){const t=r.subarray(0,nh);return jg.sign(e instanceof Uint8Array?e:e.subarray(),t)}async function oz(r,e){return Da==null&&(Da=await Q_),Da?sz(r,e):iz(r,e)}async function az(r,e,t){if(r.buffer instanceof ArrayBuffer){const n=await Lo.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await Lo.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function cz(r,e,t){return jg.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function lz(r,e,t){return Da==null&&(Da=await Q_),Da?az(r,e,t):cz(r,e,t)}function uz(r,e){const t=new Uint8Array(Yg);for(let n=0;n<nh;n++)t[n]=r[n],t[nh+n]=e[n];return t}function Qg(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}let X_=class{type="Ed25519";raw;constructor(e){this.raw=Xg(e,Y_)}toMultihash(){return Kt.digest(Ru(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();const s=lz(this.raw,t,e);return Qg(s)?s.then(i=>(n?.signal?.throwIfAborted(),i)):s}};class fz{type="Ed25519";raw;publicKey;constructor(e,t){this.raw=Xg(e,Yg),this.publicKey=new X_(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}sign(e,t){t?.signal?.throwIfAborted();const n=oz(this.raw,e);return Qg(n)?n.then(s=>(t?.signal?.throwIfAborted(),s)):(t?.signal?.throwIfAborted(),n)}}function dz(r){return r=Xg(r,Y_),new X_(r)}async function hz(r){const{privateKey:e,publicKey:t}=rz(r);return new fz(e,t)}function Xg(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new ot(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}var ur;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(ur||(ur={}));var V3;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(V3||(V3={}));(function(r){r.codec=()=>Rn(V3)})(ur||(ur={}));var Wl;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),ur.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=ur.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(Wl||(Wl={}));var Q5;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),ur.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=ur.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(Q5||(Q5={}));function pz(r){if(isNaN(r)||r<=0)throw new ot("random bytes length must be a Number bigger than 0");return ku(r)}const Yf=T_;let gz=class{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=_z(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return nt.createV1(114,this._multihash)}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){return xz(this.jwk,t,e,n)}};const mz=18,yz=1062,bz=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function wz(r){const e=n1(r[1],{offset:0});return{kty:"RSA",n:Le(e[0],"base64url"),e:Le(e[1],"base64url")}}function _z(r){if(r.n==null||r.e==null)throw new ot("JWK was missing components");return il([bz,E_(il([F3(Ge(r.n,"base64url")),F3(Ge(r.e,"base64url"))]))]).subarray()}function Ez(r,e){if(r.byteLength>=yz)throw new md("Key size is too large");const t=n1(r,{offset:0});return vz(t,r,e)}function vz(r,e,t){const n=wz(r);if(t==null){const s=Yf(Wl.encode({Type:ur.RSA,Data:e}));t=Ms(mz,s)}return new gz(n,t)}async function xz(r,e,t,n){const s=await Lo.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();const i=await Lo.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),i}class J_ extends x_{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,r1(e);const n=Kl(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,i=new Uint8Array(s);i.set(n.length>s?e.create().update(n).digest():n);for(let o=0;o<i.length;o++)i[o]^=54;this.iHash.update(i),this.oHash=e.create();for(let o=0;o<i.length;o++)i[o]^=106;this.oHash.update(i),Do(i)}update(e){return Xd(this),this.iHash.update(e),this}digestInto(e){Xd(this),Oi(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:n,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const i1=(r,e,t)=>new J_(r,e).update(t).digest();i1.create=(r,e)=>new J_(r,e);const X5=(r,e)=>(r+(r>=0?e:-e)/eE)/e;function Sz(r,e,t){const[[n,s],[i,o]]=e,a=X5(o*r,t),c=X5(-s*r,t);let l=r-a*n-c*i,h=-a*s-c*o;const f=l<Ds,p=h<Ds;f&&(l=-l),p&&(h=-h);const m=Cu(Math.ceil(C_(t)/2))+qa;if(l<Ds||l>=m||h<Ds||h>=m)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:f,k1:l,k2neg:p,k2:h}}function K3(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function o2(r,e){const t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return qo(t.lowS,"lowS"),qo(t.prehash,"prehash"),t.format!==void 0&&K3(t.format),t}let Az=class extends Error{constructor(e=""){super(e)}};const Is={Err:Az,_tlv:{encode:(r,e)=>{const{Err:t}=Is;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const n=e.length/2,s=Pf(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");const i=n>127?Pf(s.length/2|128):"";return Pf(r)+i+s+e},decode(r,e){const{Err:t}=Is;let n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");const s=e[n++],i=!!(s&128);let o=0;if(!i)o=s;else{const c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const l=e.subarray(n,n+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const h of l)o=o<<8|h;if(n+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const a=e.subarray(n,n+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+o)}}},_int:{encode(r){const{Err:e}=Is;if(r<Ds)throw new e("integer: negative integers are not allowed");let t=Pf(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){const{Err:e}=Is;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return s1(r)}},toSig(r){const{Err:e,_int:t,_tlv:n}=Is,s=Ft("signature",r),{v:i,l:o}=n.decode(48,s);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=n.decode(2,i),{v:l,l:h}=n.decode(2,c);if(h.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(r){const{_tlv:e,_int:t}=Is,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),i=n+s;return e.encode(48,i)}},Ds=BigInt(0),qa=BigInt(1),eE=BigInt(2),Bf=BigInt(3),Iz=BigInt(4);function ba(r,e){const{BYTES:t}=r;let n;if(typeof e=="bigint")n=e;else{let s=Ft("private key",e);try{n=r.fromBytes(s)}catch{throw new Error(`invalid private key: expected ui8a of size ${t}, got ${typeof e}`)}}if(!r.isValidNot0(n))throw new Error("invalid private key: out of range [1..N-1]");return n}function Tz(r,e={}){const t=z_("weierstrass",r,e),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o,n:a}=i;Ec(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:c}=e;if(c&&(!n.is0(i.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const l=nE(n,s);function h(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function f(U,y,b){const{x:g,y:C}=y.toAffine(),B=n.toBytes(g);if(qo(b,"isCompressed"),b){h();const M=!n.isOdd(C);return jr(tE(M),B)}else return jr(Uint8Array.of(4),B,n.toBytes(C))}function p(U){qr(U,void 0,"Point");const{publicKey:y,publicKeyUncompressed:b}=l,g=U.length,C=U[0],B=U.subarray(1);if(g===y&&(C===2||C===3)){const M=n.fromBytes(B);if(!n.isValid(M))throw new Error("bad point: is not on curve, wrong x");const O=R(M);let $;try{$=n.sqrt(O)}catch(de){const ce=de instanceof Error?": "+de.message:"";throw new Error("bad point: is not on curve, sqrt error"+ce)}h();const V=n.isOdd($);return(C&1)===1!==V&&($=n.neg($)),{x:M,y:$}}else if(g===b&&C===4){const M=n.BYTES,O=n.fromBytes(B.subarray(0,M)),$=n.fromBytes(B.subarray(M,M*2));if(!T(O,$))throw new Error("bad point: is not on curve");return{x:O,y:$}}else throw new Error(`bad point: got length ${g}, expected compressed=${y} or uncompressed=${b}`)}const m=e.toBytes||f,_=e.fromBytes||p;function R(U){const y=n.sqr(U),b=n.mul(y,U);return n.add(n.add(b,n.mul(U,i.a)),i.b)}function T(U,y){const b=n.sqr(y),g=R(U);return n.eql(b,g)}if(!T(i.Gx,i.Gy))throw new Error("bad curve params: generator point");const A=n.mul(n.pow(i.a,Bf),Iz),D=n.mul(n.sqr(i.b),BigInt(27));if(n.is0(n.add(A,D)))throw new Error("bad curve params: a or b");function I(U,y,b=!1){if(!n.isValid(y)||b&&n.is0(y))throw new Error(`bad point coordinate ${U}`);return y}function q(U){if(!(U instanceof x))throw new Error("ProjectivePoint expected")}function L(U){if(!c||!c.basises)throw new Error("no endo");return Sz(U,c.basises,s.ORDER)}const z=eh((U,y)=>{const{X:b,Y:g,Z:C}=U;if(n.eql(C,n.ONE))return{x:b,y:g};const B=U.is0();y==null&&(y=B?n.ONE:n.inv(C));const M=n.mul(b,y),O=n.mul(g,y),$=n.mul(C,y);if(B)return{x:n.ZERO,y:n.ZERO};if(!n.eql($,n.ONE))throw new Error("invZ was invalid");return{x:M,y:O}}),Y=eh(U=>{if(U.is0()){if(e.allowInfinityPoint&&!n.is0(U.Y))return;throw new Error("bad point: ZERO")}const{x:y,y:b}=U.toAffine();if(!n.isValid(y)||!n.isValid(b))throw new Error("bad point: x or y not field elements");if(!T(y,b))throw new Error("bad point: equation left != right");if(!U.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function k(U,y,b,g,C){return b=new x(n.mul(b.X,U),b.Y,b.Z),y=th(g,y),b=th(C,b),y.add(b)}class x{constructor(y,b,g){this.X=I("x",y),this.Y=I("y",b,!0),this.Z=I("z",g),Object.freeze(this)}static CURVE(){return i}static fromAffine(y){const{x:b,y:g}=y||{};if(!y||!n.isValid(b)||!n.isValid(g))throw new Error("invalid affine point");if(y instanceof x)throw new Error("projective point not allowed");return n.is0(b)&&n.is0(g)?x.ZERO:new x(b,g,n.ONE)}static fromBytes(y){const b=x.fromAffine(_(qr(y,void 0,"point")));return b.assertValidity(),b}static fromHex(y){return x.fromBytes(Ft("pointHex",y))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(y=8,b=!0){return j.createCache(this,y),b||this.multiply(Bf),this}assertValidity(){Y(this)}hasEvenY(){const{y}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(y)}equals(y){q(y);const{X:b,Y:g,Z:C}=this,{X:B,Y:M,Z:O}=y,$=n.eql(n.mul(b,O),n.mul(B,C)),V=n.eql(n.mul(g,O),n.mul(M,C));return $&&V}negate(){return new x(this.X,n.neg(this.Y),this.Z)}double(){const{a:y,b}=i,g=n.mul(b,Bf),{X:C,Y:B,Z:M}=this;let O=n.ZERO,$=n.ZERO,V=n.ZERO,G=n.mul(C,C),de=n.mul(B,B),ce=n.mul(M,M),re=n.mul(C,B);return re=n.add(re,re),V=n.mul(C,M),V=n.add(V,V),O=n.mul(y,V),$=n.mul(g,ce),$=n.add(O,$),O=n.sub(de,$),$=n.add(de,$),$=n.mul(O,$),O=n.mul(re,O),V=n.mul(g,V),ce=n.mul(y,ce),re=n.sub(G,ce),re=n.mul(y,re),re=n.add(re,V),V=n.add(G,G),G=n.add(V,G),G=n.add(G,ce),G=n.mul(G,re),$=n.add($,G),ce=n.mul(B,M),ce=n.add(ce,ce),G=n.mul(ce,re),O=n.sub(O,G),V=n.mul(ce,de),V=n.add(V,V),V=n.add(V,V),new x(O,$,V)}add(y){q(y);const{X:b,Y:g,Z:C}=this,{X:B,Y:M,Z:O}=y;let $=n.ZERO,V=n.ZERO,G=n.ZERO;const de=i.a,ce=n.mul(i.b,Bf);let re=n.mul(b,B),pe=n.mul(g,M),_e=n.mul(C,O),$e=n.add(b,g),ge=n.add(B,M);$e=n.mul($e,ge),ge=n.add(re,pe),$e=n.sub($e,ge),ge=n.add(b,C);let ke=n.add(B,O);return ge=n.mul(ge,ke),ke=n.add(re,_e),ge=n.sub(ge,ke),ke=n.add(g,C),$=n.add(M,O),ke=n.mul(ke,$),$=n.add(pe,_e),ke=n.sub(ke,$),G=n.mul(de,ge),$=n.mul(ce,_e),G=n.add($,G),$=n.sub(pe,G),G=n.add(pe,G),V=n.mul($,G),pe=n.add(re,re),pe=n.add(pe,re),_e=n.mul(de,_e),ge=n.mul(ce,ge),pe=n.add(pe,_e),_e=n.sub(re,_e),_e=n.mul(de,_e),ge=n.add(ge,_e),re=n.mul(pe,ge),V=n.add(V,re),re=n.mul(ke,ge),$=n.mul($e,$),$=n.sub($,re),re=n.mul($e,pe),G=n.mul(ke,G),G=n.add(G,re),new x($,V,G)}subtract(y){return this.add(y.negate())}is0(){return this.equals(x.ZERO)}multiply(y){const{endo:b}=e;if(!s.isValidNot0(y))throw new Error("invalid scalar: out of range");let g,C;const B=M=>j.cached(this,M,O=>oo(x,O));if(b){const{k1neg:M,k1:O,k2neg:$,k2:V}=L(y),{p:G,f:de}=B(O),{p:ce,f:re}=B(V);C=de.add(re),g=k(b.beta,G,ce,M,$)}else{const{p:M,f:O}=B(y);g=M,C=O}return oo(x,[g,C])[0]}multiplyUnsafe(y){const{endo:b}=e,g=this;if(!s.isValid(y))throw new Error("invalid scalar: out of range");if(y===Ds||g.is0())return x.ZERO;if(y===qa)return g;if(j.hasCache(this))return this.multiply(y);if(b){const{k1neg:C,k1:B,k2neg:M,k2:O}=L(y),{p1:$,p2:V}=UK(x,g,B,O);return k(b.beta,$,V,C,M)}else return j.unsafe(g,y)}multiplyAndAddUnsafe(y,b,g){const C=this.multiplyUnsafe(b).add(y.multiplyUnsafe(g));return C.is0()?void 0:C}toAffine(y){return z(this,y)}isTorsionFree(){const{isTorsionFree:y}=e;return o===qa?!0:y?y(x,this):j.unsafe(this,a).is0()}clearCofactor(){const{clearCofactor:y}=e;return o===qa?this:y?y(x,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(y=!0){return qo(y,"isCompressed"),this.assertValidity(),m(x,this,y)}toHex(y=!0){return fo(this.toBytes(y))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(y=!0){return this.toBytes(y)}_setWindowSize(y){this.precompute(y)}static normalizeZ(y){return oo(x,y)}static msm(y,b){return K_(x,s,y,b)}static fromPrivateKey(y){return x.BASE.multiply(ba(s,y))}}x.BASE=new x(i.Gx,i.Gy,n.ONE),x.ZERO=new x(n.ZERO,n.ONE,n.ZERO),x.Fp=n,x.Fn=s;const F=s.BITS,j=new V_(x,e.endo?Math.ceil(F/2):F);return x.BASE.precompute(8),x}function tE(r){return Uint8Array.of(r?2:3)}function nE(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function kz(r,e={}){const{Fn:t}=r,n=e.randomBytes||ku,s=Object.assign(nE(r.Fp,t),{seed:U_(t.ORDER)});function i(m){try{return!!ba(t,m)}catch{return!1}}function o(m,_){const{publicKey:R,publicKeyUncompressed:T}=s;try{const A=m.length;return _===!0&&A!==R||_===!1&&A!==T?!1:!!r.fromBytes(m)}catch{return!1}}function a(m=n(s.seed)){return $K(qr(m,s.seed,"seed"),t.ORDER)}function c(m,_=!0){return r.BASE.multiply(ba(t,m)).toBytes(_)}function l(m){const _=a(m);return{secretKey:_,publicKey:c(_)}}function h(m){if(typeof m=="bigint")return!1;if(m instanceof r)return!0;const{secretKey:_,publicKey:R,publicKeyUncompressed:T}=s;if(t.allowedLengths||_===R)return;const A=Ft("key",m).length;return A===R||A===T}function f(m,_,R=!0){if(h(m)===!0)throw new Error("first arg must be private key");if(h(_)===!1)throw new Error("second arg must be public key");const T=ba(t,m);return r.fromHex(_).multiply(T).toBytes(R)}return Object.freeze({getPublicKey:c,getSharedSecret:f,keygen:l,Point:r,utils:{isValidSecretKey:i,isValidPublicKey:o,randomSecretKey:a,isValidPrivateKey:i,randomPrivateKey:a,normPrivateKeyToScalar:m=>ba(t,m),precompute(m=8,_=r.BASE){return _.precompute(m,!1)}},lengths:s})}function Cz(r,e,t={}){r1(e),Ec(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const n=t.randomBytes||ku,s=t.hmac||((b,...g)=>i1(e,b,jr(...g))),{Fp:i,Fn:o}=r,{ORDER:a,BITS:c}=o,{keygen:l,getPublicKey:h,getSharedSecret:f,utils:p,lengths:m}=kz(r,t),_={prehash:!1,lowS:typeof t.lowS=="boolean"?t.lowS:!1,format:void 0,extraEntropy:!1},R="compact";function T(b){const g=a>>qa;return b>g}function A(b,g){if(!o.isValidNot0(g))throw new Error(`invalid signature ${b}: out of range 1..Point.Fn.ORDER`);return g}function D(b,g){K3(g);const C=m.signature,B=g==="compact"?C:g==="recovered"?C+1:void 0;return qr(b,B,`${g} signature`)}class I{constructor(g,C,B){this.r=A("r",g),this.s=A("s",C),B!=null&&(this.recovery=B),Object.freeze(this)}static fromBytes(g,C=R){D(g,C);let B;if(C==="der"){const{r:V,s:G}=Is.toSig(qr(g));return new I(V,G)}C==="recovered"&&(B=g[0],C="compact",g=g.subarray(1));const M=o.BYTES,O=g.subarray(0,M),$=g.subarray(M,M*2);return new I(o.fromBytes(O),o.fromBytes($),B)}static fromHex(g,C){return this.fromBytes(Jd(g),C)}addRecoveryBit(g){return new I(this.r,this.s,g)}recoverPublicKey(g){const C=i.ORDER,{r:B,s:M,recovery:O}=this;if(O==null||![0,1,2,3].includes(O))throw new Error("recovery id invalid");if(a*eE<C&&O>1)throw new Error("recovery id is ambiguous for h>1 curve");const V=O===2||O===3?B+a:B;if(!i.isValid(V))throw new Error("recovery id 2 or 3 invalid");const G=i.toBytes(V),de=r.fromBytes(jr(tE((O&1)===0),G)),ce=o.inv(V),re=L(Ft("msgHash",g)),pe=o.create(-re*ce),_e=o.create(M*ce),$e=r.BASE.multiplyUnsafe(pe).add(de.multiplyUnsafe(_e));if($e.is0())throw new Error("point at infinify");return $e.assertValidity(),$e}hasHighS(){return T(this.s)}toBytes(g=R){if(K3(g),g==="der")return Jd(Is.hexFromSig(this));const C=o.toBytes(this.r),B=o.toBytes(this.s);if(g==="recovered"){if(this.recovery==null)throw new Error("recovery bit must be present");return jr(Uint8Array.of(this.recovery),C,B)}return jr(C,B)}toHex(g){return fo(this.toBytes(g))}assertValidity(){}static fromCompact(g){return I.fromBytes(Ft("sig",g),"compact")}static fromDER(g){return I.fromBytes(Ft("sig",g),"der")}normalizeS(){return this.hasHighS()?new I(this.r,o.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return fo(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return fo(this.toBytes("compact"))}}const q=t.bits2int||function(g){if(g.length>8192)throw new Error("input is too large");const C=s1(g),B=g.length*8-c;return B>0?C>>BigInt(B):C},L=t.bits2int_modN||function(g){return o.create(q(g))},z=Cu(c);function Y(b){return zl("num < 2^"+c,b,Ds,z),o.toBytes(b)}function k(b,g){return qr(b,void 0,"message"),g?qr(e(b),void 0,"prehashed message"):b}function x(b,g,C){if(["recovered","canonical"].some(pe=>pe in C))throw new Error("sign() legacy options not supported");const{lowS:B,prehash:M,extraEntropy:O}=o2(C,_);b=k(b,M);const $=L(b),V=ba(o,g),G=[Y(V),Y($)];if(O!=null&&O!==!1){const pe=O===!0?n(m.secretKey):O;G.push(Ft("extraEntropy",pe))}const de=jr(...G),ce=$;function re(pe){const _e=q(pe);if(!o.isValidNot0(_e))return;const $e=o.inv(_e),ge=r.BASE.multiply(_e).toAffine(),ke=o.create(ge.x);if(ke===Ds)return;const ht=o.create($e*o.create(ce+ke*V));if(ht===Ds)return;let qt=(ge.x===ke?0:2)|Number(ge.y&qa),$t=ht;return B&&T(ht)&&($t=o.neg(ht),qt^=1),new I(ke,$t,qt)}return{seed:de,k2sig:re}}function F(b,g,C={}){b=Ft("message",b);const{seed:B,k2sig:M}=x(b,g,C);return TK(e.outputLen,o.BYTES,s)(B,M)}function j(b){let g;const C=typeof b=="string"||Tu(b),B=!C&&b!==null&&typeof b=="object"&&typeof b.r=="bigint"&&typeof b.s=="bigint";if(!C&&!B)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(B)g=new I(b.r,b.s);else if(C){try{g=I.fromBytes(Ft("sig",b),"der")}catch(M){if(!(M instanceof Is.Err))throw M}if(!g)try{g=I.fromBytes(Ft("sig",b),"compact")}catch{return!1}}return g||!1}function U(b,g,C,B={}){const{lowS:M,prehash:O,format:$}=o2(B,_);if(C=Ft("publicKey",C),g=k(Ft("message",g),O),"strict"in B)throw new Error("options.strict was renamed to lowS");const V=$===void 0?j(b):I.fromBytes(Ft("sig",b),$);if(V===!1)return!1;try{const G=r.fromBytes(C);if(M&&V.hasHighS())return!1;const{r:de,s:ce}=V,re=L(g),pe=o.inv(ce),_e=o.create(re*pe),$e=o.create(de*pe),ge=r.BASE.multiplyUnsafe(_e).add(G.multiplyUnsafe($e));return ge.is0()?!1:o.create(ge.x)===de}catch{return!1}}function y(b,g,C={}){const{prehash:B}=o2(C,_);return g=k(g,B),I.fromBytes(b,"recovered").recoverPublicKey(g).toBytes()}return Object.freeze({keygen:l,getPublicKey:h,getSharedSecret:f,utils:p,lengths:m,Point:r,sign:F,verify:U,recoverPublicKey:y,Signature:I,hash:e})}function Rz(r){const e={a:r.a,b:r.b,p:r.Fp.ORDER,n:r.n,h:r.h,Gx:r.Gx,Gy:r.Gy},t=r.Fp;let n=r.allowedPrivateKeyLengths?Array.from(new Set(r.allowedPrivateKeyLengths.map(o=>Math.ceil(o/2)))):void 0;const s=Vo(e.n,{BITS:r.nBitLength,allowedLengths:n,modFromBytes:r.wrapPrivateKey}),i={Fp:t,Fn:s,allowInfinityPoint:r.allowInfinityPoint,endo:r.endo,isTorsionFree:r.isTorsionFree,clearCofactor:r.clearCofactor,fromBytes:r.fromBytes,toBytes:r.toBytes};return{CURVE:e,curveOpts:i}}function Pz(r){const{CURVE:e,curveOpts:t}=Rz(r),n={hmac:r.hmac,randomBytes:r.randomBytes,lowS:r.lowS,bits2int:r.bits2int,bits2int_modN:r.bits2int_modN};return{CURVE:e,curveOpts:t,hash:r.hash,ecdsaOpts:n}}function Dz(r,e){const t=e.Point;return Object.assign({},e,{ProjectivePoint:t,CURVE:Object.assign({},r,M_(t.Fn.ORDER,t.Fn.BITS))})}function qz(r){const{CURVE:e,curveOpts:t,hash:n,ecdsaOpts:s}=Pz(r),i=Tz(e,t),o=Cz(i,n,s);return Dz(r,o)}function Bz(r,e){const t=n=>qz({...r,hash:n});return{...t(e),create:t}}const Jg={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},Lz={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},J5=BigInt(2);function Oz(r){const e=Jg.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,h=l*l*r%e,f=Vt(h,t,e)*h%e,p=Vt(f,t,e)*h%e,m=Vt(p,J5,e)*l%e,_=Vt(m,s,e)*m%e,R=Vt(_,i,e)*_%e,T=Vt(R,a,e)*R%e,A=Vt(T,c,e)*T%e,D=Vt(A,a,e)*R%e,I=Vt(D,t,e)*h%e,q=Vt(I,o,e)*_%e,L=Vt(q,n,e)*l%e,z=Vt(L,J5,e);if(!z3.eql(z3.sqr(z),r))throw new Error("Cannot find square root");return z}const z3=Vo(Jg.p,{sqrt:Oz}),rh=Bz({...Jg,Fp:z3,lowS:!0,endo:Lz},T_);function $z(r,e,t,n){const s=$r.digest(t instanceof Uint8Array?t:t.subarray());if(Qg(s))return s.then(({digest:i})=>(n?.signal?.throwIfAborted(),rh.verify(e,i,r))).catch(i=>{throw i.name==="AbortError"?i:new Y5(String(i))});try{return n?.signal?.throwIfAborted(),rh.verify(e,s.digest,r)}catch(i){throw new Y5(String(i))}}let Mz=class{type="secp256k1";raw;_key;constructor(e){this._key=Fz(e),this.raw=Uz(this._key)}toMultihash(){return Kt.digest(Ru(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){return $z(this._key,t,e,n)}};function Nz(r){return new Mz(r)}function Uz(r){return rh.ProjectivePoint.fromHex(r).toRawBytes(!0)}function Fz(r){try{return rh.ProjectivePoint.fromHex(r),r}catch(e){throw new md(String(e))}}async function Hz(r,e){return hz(e)}function Gl(r,e){const{Type:t,Data:n}=Wl.decode(r),s=n??new Uint8Array;switch(t){case ur.RSA:return Ez(s,e);case ur.Ed25519:return dz(s);case ur.secp256k1:return Nz(s);case ur.ECDSA:return nK(s);default:throw new Pb}}function Ru(r){return Wl.encode({Type:ur[r.type],Data:r.raw})}const Vz=8,Kz=1024*1024*4;class zz extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"}class Wz extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"}class Gz extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"}class e8 extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"}function Zz(r){return r[Symbol.asyncIterator]!=null}var Hi;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(Hi||(Hi={}));const em=r=>{const e=mc(r);return em.bytes=hr(e),e};em.bytes=0;function W3(r,e){const t=new Ue;let n=Hi.LENGTH,s=-1;const i=e?.lengthDecoder??em,o=e?.maxLengthLength??Vz,a=e?.maxDataLength??Kz;function*c(){for(;t.byteLength>0;){if(n===Hi.LENGTH)try{if(s=i(t),s<0)throw new zz("Invalid message length");if(s>a)throw new Wz("Message length too long");const l=i.bytes;t.consume(l),e?.onLength!=null&&e.onLength(s),n=Hi.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>o)throw new Gz("Message length length too long");break}throw l}if(n===Hi.DATA){if(t.byteLength<s)break;const l=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(l),yield l,n=Hi.LENGTH}}}return Zz(r)?(async function*(){for await(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new e8("Unexpected end of input")})():(function*(){for(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new e8("Unexpected end of input")})()}W3.fromReader=(r,e)=>{let t=1;const n=(async function*(){for(;;)try{const{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}})();return W3(n,{...e??{},onLength:i=>{t=i}})};function t8(){const r=en();let e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,r.resolve(t)},source:(async function*(){yield*await r.promise})()}}function jz(){const r=t8(),e=t8();return[{source:r.source,sink:e.sink},{source:e.source,sink:r.sink}]}var Yz={};const Zl=65535,n8=Zl-16,Pu=!!Yz?.DUMP_SESSION_KEYS;function rE(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function G3(r){if(typeof r!="boolean")throw new Error(`boolean expected, not ${r}`)}function a2(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function Xn(r,...e){if(!rE(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function r8(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function Qz(r,e){Xn(r);const t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Pi(r){return new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4))}function fc(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function Xz(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}const Jz=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function eW(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function Z3(r){if(typeof r=="string")r=eW(r);else if(rE(r))r=j3(r);else throw new Error("Uint8Array expected, got "+typeof r);return r}function tW(r,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(r,e)}function nW(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}const rW=(r,e)=>{function t(n,...s){if(Xn(n),!Jz)throw new Error("Non little-endian hardware is not yet supported");if(r.nonceLength!==void 0){const h=s[0];if(!h)throw new Error("nonce / iv required");r.varSizeNonce?Xn(h):Xn(h,r.nonceLength)}const i=r.tagLength;i&&s[1]!==void 0&&Xn(s[1]);const o=e(n,...s),a=(h,f)=>{if(f!==void 0){if(h!==2)throw new Error("cipher output not supported");Xn(f)}};let c=!1;return{encrypt(h,f){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,Xn(h),a(o.encrypt.length,f),o.encrypt(h,f)},decrypt(h,f){if(Xn(h),i&&h.length<i)throw new Error("invalid ciphertext length: smaller than tagLength="+i);return a(o.decrypt.length,f),o.decrypt(h,f)}}}return Object.assign(t,r),t};function s8(r,e,t=!0){if(e===void 0)return new Uint8Array(r);if(e.length!==r)throw new Error("invalid output length, expected "+r+", got: "+e.length);if(t&&!iW(e))throw new Error("invalid output, must be aligned");return e}function i8(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const s=BigInt(32),i=BigInt(4294967295),o=Number(t>>s&i),a=Number(t&i),c=4,l=0;r.setUint32(e+c,o,n),r.setUint32(e+l,a,n)}function sW(r,e,t){G3(t);const n=new Uint8Array(16),s=Xz(n);return i8(s,0,BigInt(e),t),i8(s,8,BigInt(r),t),n}function iW(r){return r.byteOffset%4===0}function j3(r){return Uint8Array.from(r)}const sE=r=>Uint8Array.from(r.split("").map(e=>e.charCodeAt(0))),oW=sE("expand 16-byte k"),aW=sE("expand 32-byte k"),cW=Pi(oW),lW=Pi(aW);function mt(r,e){return r<<e|r>>>32-e}function Y3(r){return r.byteOffset%4===0}const Lf=64,uW=16,iE=2**32-1,o8=new Uint32Array;function fW(r,e,t,n,s,i,o,a){const c=s.length,l=new Uint8Array(Lf),h=Pi(l),f=Y3(s)&&Y3(i),p=f?Pi(s):o8,m=f?Pi(i):o8;for(let _=0;_<c;o++){if(r(e,t,n,h,o,a),o>=iE)throw new Error("arx: counter overflow");const R=Math.min(Lf,c-_);if(f&&R===Lf){const T=_/4;if(_%4!==0)throw new Error("arx: invalid block position");for(let A=0,D;A<uW;A++)D=T+A,m[D]=p[D]^h[A];_+=Lf;continue}for(let T=0,A;T<R;T++)A=_+T,i[A]=s[A]^l[T];_+=R}}function dW(r,e){const{allowShortKeys:t,extendNonceFn:n,counterLength:s,counterRight:i,rounds:o}=tW({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return a2(s),a2(o),G3(i),G3(t),(a,c,l,h,f=0)=>{Xn(a),Xn(c),Xn(l);const p=l.length;if(h===void 0&&(h=new Uint8Array(p)),Xn(h),a2(f),f<0||f>=iE)throw new Error("arx: counter overflow");if(h.length<p)throw new Error(`arx: output (${h.length}) is shorter than data (${p})`);const m=[];let _=a.length,R,T;if(_===32)m.push(R=j3(a)),T=lW;else if(_===16&&t)R=new Uint8Array(32),R.set(a),R.set(a,16),T=cW,m.push(R);else throw new Error(`arx: invalid 32-byte key, got length=${_}`);Y3(c)||m.push(c=j3(c));const A=Pi(R);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(T,A,Pi(c.subarray(0,16)),A),c=c.subarray(16)}const D=16-s;if(D!==c.length)throw new Error(`arx: nonce must be ${D} or 16 bytes`);if(D!==12){const q=new Uint8Array(12);q.set(c,i?0:12-c.length),c=q,m.push(c)}const I=Pi(c);return fW(r,T,A,I,l,h,f,o),fc(...m),h}}const wn=(r,e)=>r[e++]&255|(r[e++]&255)<<8;class hW{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=Z3(e),Xn(e,32);const t=wn(e,0),n=wn(e,2),s=wn(e,4),i=wn(e,6),o=wn(e,8),a=wn(e,10),c=wn(e,12),l=wn(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|s<<6)&7939,this.r[3]=(s>>>7|i<<9)&8191,this.r[4]=(i>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let h=0;h<8;h++)this.pad[h]=wn(e,16+2*h)}process(e,t,n=!1){const s=n?0:2048,{h:i,r:o}=this,a=o[0],c=o[1],l=o[2],h=o[3],f=o[4],p=o[5],m=o[6],_=o[7],R=o[8],T=o[9],A=wn(e,t+0),D=wn(e,t+2),I=wn(e,t+4),q=wn(e,t+6),L=wn(e,t+8),z=wn(e,t+10),Y=wn(e,t+12),k=wn(e,t+14);let x=i[0]+(A&8191),F=i[1]+((A>>>13|D<<3)&8191),j=i[2]+((D>>>10|I<<6)&8191),U=i[3]+((I>>>7|q<<9)&8191),y=i[4]+((q>>>4|L<<12)&8191),b=i[5]+(L>>>1&8191),g=i[6]+((L>>>14|z<<2)&8191),C=i[7]+((z>>>11|Y<<5)&8191),B=i[8]+((Y>>>8|k<<8)&8191),M=i[9]+(k>>>5|s),O=0,$=O+x*a+F*(5*T)+j*(5*R)+U*(5*_)+y*(5*m);O=$>>>13,$&=8191,$+=b*(5*p)+g*(5*f)+C*(5*h)+B*(5*l)+M*(5*c),O+=$>>>13,$&=8191;let V=O+x*c+F*a+j*(5*T)+U*(5*R)+y*(5*_);O=V>>>13,V&=8191,V+=b*(5*m)+g*(5*p)+C*(5*f)+B*(5*h)+M*(5*l),O+=V>>>13,V&=8191;let G=O+x*l+F*c+j*a+U*(5*T)+y*(5*R);O=G>>>13,G&=8191,G+=b*(5*_)+g*(5*m)+C*(5*p)+B*(5*f)+M*(5*h),O+=G>>>13,G&=8191;let de=O+x*h+F*l+j*c+U*a+y*(5*T);O=de>>>13,de&=8191,de+=b*(5*R)+g*(5*_)+C*(5*m)+B*(5*p)+M*(5*f),O+=de>>>13,de&=8191;let ce=O+x*f+F*h+j*l+U*c+y*a;O=ce>>>13,ce&=8191,ce+=b*(5*T)+g*(5*R)+C*(5*_)+B*(5*m)+M*(5*p),O+=ce>>>13,ce&=8191;let re=O+x*p+F*f+j*h+U*l+y*c;O=re>>>13,re&=8191,re+=b*a+g*(5*T)+C*(5*R)+B*(5*_)+M*(5*m),O+=re>>>13,re&=8191;let pe=O+x*m+F*p+j*f+U*h+y*l;O=pe>>>13,pe&=8191,pe+=b*c+g*a+C*(5*T)+B*(5*R)+M*(5*_),O+=pe>>>13,pe&=8191;let _e=O+x*_+F*m+j*p+U*f+y*h;O=_e>>>13,_e&=8191,_e+=b*l+g*c+C*a+B*(5*T)+M*(5*R),O+=_e>>>13,_e&=8191;let $e=O+x*R+F*_+j*m+U*p+y*f;O=$e>>>13,$e&=8191,$e+=b*h+g*l+C*c+B*a+M*(5*T),O+=$e>>>13,$e&=8191;let ge=O+x*T+F*R+j*_+U*m+y*p;O=ge>>>13,ge&=8191,ge+=b*f+g*h+C*l+B*c+M*a,O+=ge>>>13,ge&=8191,O=(O<<2)+O|0,O=O+$|0,$=O&8191,O=O>>>13,V+=O,i[0]=$,i[1]=V,i[2]=G,i[3]=de,i[4]=ce,i[5]=re,i[6]=pe,i[7]=_e,i[8]=$e,i[9]=ge}finalize(){const{h:e,pad:t}=this,n=new Uint16Array(10);let s=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=s,s=e[a]>>>13,e[a]&=8191;e[0]+=s*5,s=e[0]>>>13,e[0]&=8191,e[1]+=s,s=e[1]>>>13,e[1]&=8191,e[2]+=s,n[0]=e[0]+5,s=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+s,s=n[a]>>>13,n[a]&=8191;n[9]-=8192;let i=(s^1)-1;for(let a=0;a<10;a++)n[a]&=i;i=~i;for(let a=0;a<10;a++)e[a]=e[a]&i|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535;fc(n)}update(e){r8(this),e=Z3(e),Xn(e);const{buffer:t,blockLen:n}=this,s=e.length;for(let i=0;i<s;){const o=Math.min(n-this.pos,s-i);if(o===n){for(;n<=s-i;i+=n)this.process(e,i);continue}t.set(e.subarray(i,i+o),this.pos),this.pos+=o,i+=o,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){fc(this.h,this.r,this.buffer,this.pad)}digestInto(e){r8(this),Qz(e,this),this.finished=!0;const{buffer:t,h:n}=this;let{pos:s}=this;if(s){for(t[s++]=1;s<16;s++)t[s]=0;this.process(t,0,!0)}this.finalize();let i=0;for(let o=0;o<8;o++)e[i++]=n[o]>>>0,e[i++]=n[o]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}}function pW(r){const e=(n,s)=>r(s).update(Z3(n)).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}const gW=pW(r=>new hW(r));function mW(r,e,t,n,s,i=20){let o=r[0],a=r[1],c=r[2],l=r[3],h=e[0],f=e[1],p=e[2],m=e[3],_=e[4],R=e[5],T=e[6],A=e[7],D=s,I=t[0],q=t[1],L=t[2],z=o,Y=a,k=c,x=l,F=h,j=f,U=p,y=m,b=_,g=R,C=T,B=A,M=D,O=I,$=q,V=L;for(let de=0;de<i;de+=2)z=z+F|0,M=mt(M^z,16),b=b+M|0,F=mt(F^b,12),z=z+F|0,M=mt(M^z,8),b=b+M|0,F=mt(F^b,7),Y=Y+j|0,O=mt(O^Y,16),g=g+O|0,j=mt(j^g,12),Y=Y+j|0,O=mt(O^Y,8),g=g+O|0,j=mt(j^g,7),k=k+U|0,$=mt($^k,16),C=C+$|0,U=mt(U^C,12),k=k+U|0,$=mt($^k,8),C=C+$|0,U=mt(U^C,7),x=x+y|0,V=mt(V^x,16),B=B+V|0,y=mt(y^B,12),x=x+y|0,V=mt(V^x,8),B=B+V|0,y=mt(y^B,7),z=z+j|0,V=mt(V^z,16),C=C+V|0,j=mt(j^C,12),z=z+j|0,V=mt(V^z,8),C=C+V|0,j=mt(j^C,7),Y=Y+U|0,M=mt(M^Y,16),B=B+M|0,U=mt(U^B,12),Y=Y+U|0,M=mt(M^Y,8),B=B+M|0,U=mt(U^B,7),k=k+y|0,O=mt(O^k,16),b=b+O|0,y=mt(y^b,12),k=k+y|0,O=mt(O^k,8),b=b+O|0,y=mt(y^b,7),x=x+F|0,$=mt($^x,16),g=g+$|0,F=mt(F^g,12),x=x+F|0,$=mt($^x,8),g=g+$|0,F=mt(F^g,7);let G=0;n[G++]=o+z|0,n[G++]=a+Y|0,n[G++]=c+k|0,n[G++]=l+x|0,n[G++]=h+F|0,n[G++]=f+j|0,n[G++]=p+U|0,n[G++]=m+y|0,n[G++]=_+b|0,n[G++]=R+g|0,n[G++]=T+C|0,n[G++]=A+B|0,n[G++]=D+M|0,n[G++]=I+O|0,n[G++]=q+$|0,n[G++]=L+V|0}const yW=dW(mW,{counterRight:!1,counterLength:4,allowShortKeys:!1}),bW=new Uint8Array(16),a8=(r,e)=>{r.update(e);const t=e.length%16;t&&r.update(bW.subarray(t))},wW=new Uint8Array(32);function c8(r,e,t,n,s){const i=r(e,t,wW),o=gW.create(i);s&&a8(o,s),a8(o,n);const a=sW(n.length,s?s.length:0,!0);o.update(a);const c=o.digest();return fc(i,a),c}const _W=r=>(e,t,n)=>({encrypt(i,o){const a=i.length;o=s8(a+16,o,!1),o.set(i);const c=o.subarray(0,-16);r(e,t,c,c,1);const l=c8(r,e,t,c,n);return o.set(l,a),fc(l),o},decrypt(i,o){o=s8(i.length-16,o,!1);const a=i.subarray(0,-16),c=i.subarray(-16),l=c8(r,e,t,a,n);if(!nW(c,l))throw new Error("invalid tag");return o.set(i.subarray(0,-16)),r(e,t,o,o,1),fc(l),o}}),l8=rW({blockSize:64,nonceLength:12,tagLength:16},_W(yW));function EW(r,e,t){return r1(r),t===void 0&&(t=new Uint8Array(r.outputLen)),i1(r,Kl(t),Kl(e))}const c2=Uint8Array.from([0]),u8=Uint8Array.of();function vW(r,e,t,n=32){r1(r),Qd(n);const s=r.outputLen;if(n>255*s)throw new Error("Length should be <= 255*HashLen");const i=Math.ceil(n/s);t===void 0&&(t=u8);const o=new Uint8Array(i*s),a=i1.create(r,e),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let h=0;h<i;h++)c2[0]=h+1,c.update(h===0?u8:l).update(t).update(c2).digestInto(l),o.set(l,s*h),a._cloneInto(c);return a.destroy(),c.destroy(),Do(l,c2),o.slice(0,n)}const xW={hashSHA256(r){return Yf(r.subarray())},getHKDF(r,e){const t=EW(Yf,e,r),s=vW(Yf,t,void 0,96),i=s.subarray(0,32),o=s.subarray(32,64),a=s.subarray(64,96);return[i,o,a]},generateX25519KeyPair(){const r=qf.utils.randomPrivateKey();return{publicKey:qf.getPublicKey(r),privateKey:r}},generateX25519KeyPairFromSeed(r){return{publicKey:qf.getPublicKey(r),privateKey:r}},generateX25519SharedKey(r,e){return qf.getSharedSecret(r.subarray(),e.subarray())},chaCha20Poly1305Encrypt(r,e,t,n){return l8(n,e,t).encrypt(r.subarray())},chaCha20Poly1305Decrypt(r,e,t,n,s){return l8(n,e,t).decrypt(r.subarray(),s)}},SW=xW;function AW(r){return{generateKeypair:r.generateX25519KeyPair,dh:(e,t)=>r.generateX25519SharedKey(e.privateKey,t).subarray(0,32),encrypt:r.chaCha20Poly1305Encrypt,decrypt:r.chaCha20Poly1305Decrypt,hash:r.hashSHA256,hkdf:r.getHKDF}}const sh=r=>{const e=Tr(2);return e[0]=r>>8,e[1]=r,e};sh.bytes=2;const Qf=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");if(r instanceof Uint8Array){let e=0;return e+=r[0]<<8,e+=r[1],e}return r.getUint16(0)};Qf.bytes=2;function IW(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function oE(r,e){!e.enabled||!Pu||(r?(e(`LOCAL_STATIC_PUBLIC_KEY ${Le(r.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${Le(r.privateKey,"hex")}`)):e("Missing local static keys."))}function aE(r,e){!e.enabled||!Pu||(r?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${Le(r.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${Le(r.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function TW(r,e){!e.enabled||!Pu||e(r?`REMOTE_STATIC_PUBLIC_KEY ${Le(r.subarray(),"hex")}`:"Missing remote static public key.")}function cE(r,e){!e.enabled||!Pu||e(r?`REMOTE_EPHEMERAL_PUBLIC_KEY ${Le(r.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function lE(r,e,t){!t.enabled||!Pu||(t(`CIPHER_STATE_1 ${r.n.getUint64()} ${r.k&&Le(r.k,"hex")}`),t(`CIPHER_STATE_2 ${e.n.getUint64()} ${e.k&&Le(e.k,"hex")}`))}class ol extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=ol.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"}const kW=0,CW=4294967295,RW="Cipherstate has reached maximum n, a new handshake must be performed";class PW{n;bytes;view;constructor(e=kW){this.n=e,this.bytes=St(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>CW)throw new Error(RW)}}const Ba=St(0);class Of{k;n;crypto;constructor(e,t=void 0,n=0){this.crypto=e,this.k=t,this.n=new PW(n)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();const n=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),n}decryptWithAd(e,t,n){if(!this.hasKey())return t;this.n.assertValue();const s=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,n);return this.n.increment(),s}}class DW{cs;ck;h;crypto;constructor(e,t){this.crypto=e;const n=Ge(t,"utf-8");this.h=BW(e,n),this.ck=this.h,this.cs=new Of(e)}mixKey(e){const[t,n]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new Of(this.crypto,n)}mixHash(e){this.h=this.crypto.hash(new Ue(this.h,e))}encryptAndHash(e){const t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){const t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){const[e,t]=this.crypto.hkdf(this.ck,Ba);return[new Of(this.crypto,e),new Of(this.crypto,t)]}}class qW{ss;s;e;rs;re;initiator;crypto;constructor(e){const{crypto:t,protocolName:n,prologue:s,initiator:i,s:o,e:a,rs:c,re:l}=e;this.crypto=t,this.ss=new DW(t,n),this.ss.mixHash(s),this.initiator=i,this.s=o,this.e=a,this.rs=c,this.re=l}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");const e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");const n=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+n)throw new Error("message is not long enough");const s=e.sublist(t,t+n);return this.rs=this.ss.decryptAndHash(s),n}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}}class uE extends qW{writeMessageA(e){return new Ue(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){const t=this.writeE();this.writeEE();const n=this.writeS();return this.writeES(),new Ue(t,n,this.ss.encryptAndHash(e))}writeMessageC(e){const t=this.writeS();return this.writeSE(),new Ue(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(t){throw new ol(`handshake stage 0 validation fail: ${t.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();const t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(t){throw new ol(`handshake stage 1 validation fail: ${t.message}`)}}readMessageC(e){try{const t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(t){throw new ol(`handshake stage 2 validation fail: ${t.message}`)}}}function BW(r,e){if(e.length<=32){const t=St(32);return t.set(e),t}else return r.hash(e)}var ih;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(const i of t.webtransportCerthashes)n.uint32(10),n.bytes(i);if(t.streamMuxers!=null)for(const i of t.streamMuxers)n.uint32(18),n.string(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={webtransportCerthashes:[],streamMuxers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(s.limits?.webtransportCerthashes!=null&&i.webtransportCerthashes.length===s.limits.webtransportCerthashes)throw new Mt('Decode error - map field "webtransportCerthashes" had too many elements');i.webtransportCerthashes.push(t.bytes());break}case 2:{if(s.limits?.streamMuxers!=null&&i.streamMuxers.length===s.limits.streamMuxers)throw new Mt('Decode error - map field "streamMuxers" had too many elements');i.streamMuxers.push(t.string());break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(ih||(ih={}));var oh;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(n.uint32(10),n.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(n.uint32(18),n.bytes(t.identitySig)),t.extensions!=null&&(n.uint32(34),ih.codec().encode(t.extensions,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={identityKey:St(0),identitySig:St(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.identityKey=t.bytes();break}case 2:{i.identitySig=t.bytes();break}case 4:{i.extensions=ih.codec().decode(t,t.uint32(),{limits:s.limits?.extensions});break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(oh||(oh={}));async function fE(r,e,t){const n=await r.sign(hE(e));return oh.encode({identityKey:Ru(r.publicKey),identitySig:n,extensions:t})}async function dE(r,e,t){try{const n=oh.decode(r),s=Gl(n.identityKey);if(t?.equals(s)===!1)throw new Error(`Payload identity key ${s} does not match expected remote identity key ${t}`);if(!e)throw new Error("Remote static does not exist");const i=hE(e);if(!await s.verify(i,n.identitySig))throw new Error("Invalid payload signature");return n}catch(n){throw new eC(n.message)}}function hE(r){const e=Ge("noise-libp2p-static-key:");return r instanceof Uint8Array?is([e,r],e.length+r.length):(r.prepend(e),r)}async function LW(r,e){const{log:t,connection:n,crypto:s,privateKey:i,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=r,h=await fE(i,a.publicKey,l),f=new uE({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:o,s:a});oE(f.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await n.write(f.writeMessageA(Ba),e),t.trace("Stage 0 - Initiator finished sending first message."),aE(f.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");const p=f.readMessageB(await n.read(e));t.trace("Stage 1 - Initiator received the message."),cE(f.re,t),TW(f.rs,t),t.trace("Initiator going to check remote's signature...");const m=await dE(p,f.rs,c);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await n.write(f.writeMessageC(h),e),t.trace("Stage 2 - Initiator sent message with signed payload.");const[_,R]=f.ss.split();return lE(_,R,t),{payload:m,encrypt:T=>_.encryptWithAd(Ba,T),decrypt:(T,A)=>R.decryptWithAd(Ba,T,A)}}async function OW(r,e){const{log:t,connection:n,crypto:s,privateKey:i,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=r,h=await fE(i,a.publicKey,l),f=new uE({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:o,s:a});oE(f.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),f.readMessageA(await n.read(e)),t.trace("Stage 0 - Responder received first message."),cE(f.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await n.write(f.writeMessageB(h),e),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),aE(f.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");const p=f.readMessageC(await n.read(e));t.trace("Stage 2 - Responder received the message, finished handshake.");const m=await dE(p,f.rs,c),[_,R]=f.ss.split();return lE(_,R,t),{payload:m,encrypt:T=>R.encryptWithAd(Ba,T),decrypt:(T,A)=>_.decryptWithAd(Ba,T,A)}}const f8=16;function $W(r,e){return async function*(t){for await(const n of t)for(let s=0;s<n.length;s+=n8){let i=s+n8;i>n.length&&(i=n.length);let o;n instanceof Uint8Array?o=r.encrypt(n.subarray(s,i)):o=r.encrypt(n.sublist(s,i)),e?.encryptedPackets.increment(),yield new Ue(sh(o.byteLength),o)}}}function MW(r,e){return async function*(t){for await(const n of t)for(let s=0;s<n.length;s+=Zl){let i=s+Zl;if(i>n.length&&(i=n.length),i-f8<s)throw new Error("Invalid chunk");const o=n.sublist(s,i),a=n.subarray(s,i-f8);try{const c=r.decrypt(o,a);e?.decryptedPackets.increment(),yield c}catch(c){throw e?.decryptErrors.increment(),c}}}}class NW{protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;constructor(e,t={}){const{staticNoiseKey:n,extensions:s,crypto:i,prologueBytes:o}=t,{metrics:a}=e;this.components=e;const c=i??SW;this.crypto=AW(c),this.extensions={webtransportCerthashes:[],...s},this.metrics=a?IW(a):void 0,n?this.staticKey=c.generateX25519KeyPairFromSeed(n):this.staticKey=c.generateX25519KeyPair(),this.prologue=o??St(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[pr]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(e,t){const n=tc(e,{lengthEncoder:sh,lengthDecoder:Qf,maxDataLength:Zl}),s=await this.performHandshakeInitiator(n,this.components.privateKey,t?.remotePeer?.publicKey,t),i=await this.createSecureConnection(n,s);e.source=i.source,e.sink=i.sink;const o=Gl(s.payload.identityKey);return{conn:e,remoteExtensions:s.payload.extensions,remotePeer:Ua(o),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(s.payload.extensions?.streamMuxers)}}getStreamMuxer(e){if(e==null||e.length===0)return;const t=this.components.upgrader.getStreamMuxers();if(t!=null)for(const n of e){const s=t.get(n);if(s!=null)return s}if(e.length)throw new tC("Early muxer negotiation was requested but the initiator and responder had no common muxers")}async secureInbound(e,t){const n=tc(e,{lengthEncoder:sh,lengthDecoder:Qf,maxDataLength:Zl}),s=await this.performHandshakeResponder(n,this.components.privateKey,t?.remotePeer?.publicKey,t),i=await this.createSecureConnection(n,s);e.source=i.source,e.sink=i.sink;const o=Gl(s.payload.identityKey);return{conn:e,remoteExtensions:s.payload.extensions,remotePeer:Ua(o),streamMuxer:t?.skipStreamMuxerNegotiation===!0?void 0:this.getStreamMuxer(s.payload.extensions?.streamMuxers)}}async performHandshakeInitiator(e,t,n,s){let i;const o=s?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{i=await LW({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:o,webtransportCerthashes:[],...this.extensions}},s),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return i}async performHandshakeResponder(e,t,n,s){let i;const o=s?.skipStreamMuxerNegotiation===!0?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{i=await OW({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:o,webtransportCerthashes:[],...this.extensions}},s),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return i}async createSecureConnection(e,t){const[n,s]=jz(),i=e.unwrap();return await Ar(n,$W(t,this.metrics),i,o=>W3(o,{lengthDecoder:Qf}),MW(t,this.metrics),n),s}}function UW(r={}){return e=>new NW(e,r)}function pE(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}class wa extends Error{static name="InvalidFrameError";constructor(e="The frame was invalid"){super(e),this.name="InvalidFrameError"}}class gE extends Error{static name="UnrequestedPingError";constructor(e="Unrequested ping error"){super(e),this.name="UnrequestedPingError"}}class mE extends Error{static name="NotMatchingPingError";constructor(e="Unrequested ping error"){super(e),this.name="NotMatchingPingError"}}class FW extends Error{static name="InvalidStateError";constructor(e="Invalid state"){super(e),this.name="InvalidStateError"}}class HW extends Error{static name="StreamAlreadyExistsError";constructor(e="Strean already exists"){super(e),this.name="StreamAlreadyExistsError"}}class VW extends Error{static name="DecodeInvalidVersionError";constructor(e="Decode invalid version"){super(e),this.name="DecodeInvalidVersionError"}}class KW extends Error{static name="BothClientsError";constructor(e="Both clients"){super(e),this.name="BothClientsError"}}class yE extends Error{static name="ReceiveWindowExceededError";constructor(e="Receive window exceeded"){super(e),this.name="ReceiveWindowExceededError"}}const zW=new Set([wa.name,gE.name,mE.name,HW.name,VW.name,KW.name,yE.name]),tm=256*1024,WW=16*1024*1024,GW={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:tm,maxStreamWindowSize:WW,maxMessageSize:64*1024};function ZW(r){if(r.keepAliveInterval<=0)throw new ot("keep-alive interval must be positive");if(r.maxInboundStreams<0)throw new ot("max inbound streams must be larger or equal 0");if(r.maxOutboundStreams<0)throw new ot("max outbound streams must be larger or equal 0");if(r.initialStreamWindowSize<tm)throw new ot("InitialStreamWindowSize must be larger or equal 256 kB");if(r.maxStreamWindowSize<r.initialStreamWindowSize)throw new ot("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(r.maxStreamWindowSize>2**32-1)throw new ot("MaxStreamWindowSize must be less than equal MAX_UINT32");if(r.maxMessageSize<1024)throw new ot("MaxMessageSize must be greater than a kilobyte")}var un;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(un||(un={}));var Qt;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(Qt||(Qt={}));Object.values(Qt).filter(r=>typeof r!="string");const jW=0;var Zr;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(Zr||(Zr={}));const al=12,d8=2**24;function YW(r){if(r[0]!==jW)throw new wa("Invalid frame version");return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*d8+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*d8+(r[9]<<16)+(r[10]<<8)+r[11]}}class QW{source;buffer;frameInProgress;constructor(e){this.source=XW(e),this.buffer=new Ue,this.frameInProgress=!1}async*emitFrames(){for await(const e of this.source)for(this.buffer.append(e);;){const t=this.readHeader();if(t===void 0)break;const{type:n,length:s}=t;n===un.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,s)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new FW("decoding frame already in progress");if(this.buffer.length<al)return;const e=YW(this.buffer.subarray(0,al));return this.buffer.consume(al),e}async readBytes(e){if(this.buffer.length<e){for await(const n of this.source)if(this.buffer.append(n),this.buffer.length>=e)break}const t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}}function XW(r){if(r[Symbol.iterator]!==void 0){const e=r[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(r[Symbol.asyncIterator]!==void 0){const e=r[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function h8(r){const e=new Uint8Array(al);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}function JW(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}function eG(r,e){const t=pE(r).return?.();JW(t)&&t.catch(n=>{e.error("could not cause iterator to return",n)})}const tG=5e3;function l2(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class nG{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;log;sinkController;sinkEnd;closed;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;sendCloseWriteTimeout;sendingData;constructor(e){this.sinkController=new AbortController,this.sinkEnd=en(),this.closed=en(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??tG,this.onEnd=e.onEnd,this.onCloseRead=e.onCloseRead,this.onCloseWrite=e.onCloseWrite,this.onReset=e.onReset,this.onAbort=e.onAbort,this.source=this.streamSource=Or({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new sC(`writable end state is "${this.writeStatus}" not "ready"`);try{this.writeStatus="writing";const t={signal:this.sinkController.signal};if(this.direction==="outbound"){const s=this.sendNewStream(t);l2(s)&&await s}const n=()=>{eG(e,this.log)};try{this.sinkController.signal.addEventListener("abort",n),this.log.trace("sink reading from source");for await(let s of e){s=s instanceof Uint8Array?new Ue(s):s;const i=this.sendData(s,t);l2(i)&&(this.sendingData=en(),await i,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",n)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.status==="open"&&(this.log.trace("closing gracefully"),this.status="closing",await wr(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e?.signal),this.status="closed",this.log.trace("closed gracefully"))}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await wr(this.sink([]),e.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await wr(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await wr(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");const t=this.sendReset();l2(t)&&t.catch(n=>{this.log.error("error sending reset message",n)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;const e=new rC("stream reset");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}}var Pr;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished"})(Pr||(Pr={}));class rG extends nG{name;state;config;_id;sendWindowCapacity;sendWindowCapacityUpdate;recvWindow;recvWindowCapacity;epochStart;getRTT;sendFrame;constructor(e){super({...e,onEnd:t=>{this.state=Pr.Finished,e.onEnd?.(t)}}),this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=tm,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=__(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,t={}){for(e=e.sublist();e.byteLength!==0;){if(this.sendWindowCapacity===0&&(this.log?.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(t),this.status==="closed"||this.status==="aborted"||this.status==="reset")){this.log?.trace("%s while waiting for send window capacity",this.status);return}const n=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-al,e.length),s=this.getSendFlags();this.sendFrame({type:un.Data,flag:s,streamID:this._id,length:n},e.sublist(0,n)),this.sendWindowCapacity-=n,e.consume(n)}}async sendReset(){this.sendFrame({type:un.WindowUpdate,flag:Qt.RST,streamID:this._id,length:0})}async sendCloseWrite(){const e=this.getSendFlags()|Qt.FIN;this.sendFrame({type:un.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let t,n;const s=()=>{this.status==="open"||this.status==="closing"?n(new Di("Stream aborted")):t()};e.signal?.addEventListener("abort",s);try{await new Promise((i,o)=>{this.sendWindowCapacityUpdate=()=>{i()},n=o,t=i})}finally{e.signal?.removeEventListener("abort",s)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);const t=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,t===0&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,t){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new yE("Receive window exceeded");const n=await t();this.recvWindowCapacity-=e.length,this.sourcePush(n)}processFlags(e){(e&Qt.ACK)===Qt.ACK&&this.state===Pr.SYNSent&&(this.state=Pr.Established),(e&Qt.FIN)===Qt.FIN&&this.remoteCloseWrite(),(e&Qt.RST)===Qt.RST&&this.reset()}getSendFlags(){switch(this.state){case Pr.Init:return this.state=Pr.SYNSent,Qt.SYN;case Pr.SYNReceived:return this.state=Pr.Established,Qt.ACK;default:return 0}}sendWindowUpdate(){const e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>-1&&t-this.epochStart<n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;const s=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:un.WindowUpdate,flag:e,streamID:this._id,length:s})}}const bE="/yamux/1.0.0",sG=500;class iG{protocol=bE;_components;_init;constructor(e,t={}){this._components=e,this._init=t}[Symbol.toStringTag]="@chainsafe/libp2p-yamux";[pr]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new oG(this._components,{...this._init,...e})}}class oG{protocol=bE;source;sink;config;log;logger;closeController;nextStreamID;_streams;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;onIncomingStream;onStreamEnd;constructor(e,t){this.client=t.direction==="outbound",this.config={...GW,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),ZW(this.config),this.closeController=new AbortController,this.closeController.signal,this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=Or({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach(n=>{n.destroy()})}}),this.sink=async n=>{const s=()=>{const a=pE(n);if(a.return!=null){const c=a.return();aG(c)&&c.catch(l=>{this.log?.("could not cause sink source to return",l)})}};let i,o;try{const a=new QW(n);try{this.closeController.signal.addEventListener("abort",s);for await(const c of a.emitFrames())await this.handleFrame(c.header,c.readData)}finally{this.closeController.signal.removeEventListener("abort",s)}i=Zr.NormalTermination}catch(a){zW.has(a.name)?(this.log?.error("protocol error in sink",a),i=Zr.ProtocolError):(this.log?.error("internal error in sink",a),i=Zr.InternalError),o=a}this.log?.trace("muxer sink ended"),o!=null?this.abort(o,i):await this.close({reason:i})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(n=>this.log?.error("keepalive error: %s",n)),this.ping().catch(n=>this.log?.error("ping error: %s",n))}get streams(){return Array.from(this._streams.values())}newStream(e){if(this.remoteGoAway!==void 0)throw new Rc("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Rc("Muxer closed locally");const t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new Rb("max outbound streams exceeded");this.log?.trace("new outgoing stream id=%s",t);const n=this._newStream(t,e,Pr.Init,"outbound");return this._streams.set(t,n),this.numOutboundStreams++,n.sendWindowUpdate(),n}async ping(){if(this.remoteGoAway!==void 0)throw new Rc("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Rc("Muxer closed locally");if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((s,i)=>{const o=()=>{i(new Rc("Muxer closed locally"))};this.closeController.signal.addEventListener("abort",o,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",o),s()}}),resolve:e};const t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}const n=Date.now();this.rtt=n-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.closeController.signal.aborted)return;const t=e?.reason??Zr.NormalTermination;if(this.log?.trace("muxer close reason=%s",t),e.signal==null){const n=AbortSignal.timeout(sG);e={...e,signal:n}}try{await Promise.all([...this._streams.values()].map(async n=>n.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(n){this.abort(n)}}abort(e,t){if(!this.closeController.signal.aborted){t=t??Zr.InternalError,this.log?.error("muxer abort reason=%s error=%s",t,e);for(const n of this._streams.values())n.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,n,s){if(this._streams.get(e)!=null)throw new ot("Stream already exists with that id");const i=new rG({id:e.toString(),name:t,state:n,direction:s,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(e),this.onStreamEnd?.(i)},log:this.logger.forComponent(`libp2p:yamux:${s}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return i}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let e;try{await wr(new Promise(t=>{e=setTimeout(t,this.config.keepAliveInterval)}),this.closeController.signal),this.ping().catch(t=>this.log?.error("ping error: %s",t))}catch{clearInterval(e);return}}}async handleFrame(e,t){const{streamID:n,type:s,length:i}=e;if(this.log?.trace("received frame %o",e),n===0)switch(s){case un.Ping:{this.handlePing(e);return}case un.GoAway:{this.handleGoAway(i);return}default:throw new wa("Invalid frame type")}else switch(e.type){case un.Data:case un.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new wa("Invalid frame type")}}handlePing(e){if(e.flag===Qt.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,Qt.ACK);else if(e.flag===Qt.ACK)this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new wa("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new gE("ping not requested");if(this.activePing.id!==e)throw new mE("ping doesn't match our id");this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",Zr[e]??"unknown"),this.remoteGoAway=e;for(const t of this._streams.values())t.reset();this._closeMuxer()}async handleStreamMessage(e,t){const{streamID:n,flag:s,type:i}=e;(s&Qt.SYN)===Qt.SYN&&this.incomingStream(n);const o=this._streams.get(n);if(o===void 0){if(i===un.Data){if(this.log?.("discarding data for stream id=%s",n),t===void 0)throw new Error("unreachable");await t()}else this.log?.trace("frame for missing stream id=%s",n);return}switch(i){case un.WindowUpdate:{o.handleWindowUpdate(e);return}case un.Data:{if(t===void 0)throw new Error("unreachable");await o.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new ot("Both endpoints are clients");if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:un.WindowUpdate,flag:Qt.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){this.log?.("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:un.WindowUpdate,flag:Qt.RST,streamID:e,length:0});return}const t=this._newStream(e,void 0,Pr.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %o",e),e.type===un.Data){if(t===void 0)throw new wa("Invalid frame");this.source.push(new Ue(h8(e),t))}else this.source.push(h8(e))}sendPing(e,t=Qt.SYN){t===Qt.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:un.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=Zr.NormalTermination){this.log?.("sending GoAway reason=%s",Zr[e]),this.localGoAway=e,this.sendFrame({type:un.GoAway,flag:0,streamID:0,length:e})}}function aG(r){return r!=null&&typeof r.then=="function"}function cG(r={}){return e=>new iG(e,r)}const lG="0.1.0",uG="id",fG="1.0.0",dG=1024*8;var ah;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(const i of t.listenAddrs)n.uint32(18),n.bytes(i);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(const i of t.protocols)n.uint32(26),n.string(i);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={listenAddrs:[],protocols:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 5:{i.protocolVersion=t.string();break}case 6:{i.agentVersion=t.string();break}case 1:{i.publicKey=t.bytes();break}case 2:{if(s.limits?.listenAddrs!=null&&i.listenAddrs.length===s.limits.listenAddrs)throw new Mt('Decode error - map field "listenAddrs" had too many elements');i.listenAddrs.push(t.bytes());break}case 4:{i.observedAddr=t.bytes();break}case 3:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new Mt('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 8:{i.signedPeerRecord=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(ah||(ah={}));class o1 extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}}class wE extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}}class hG extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}}const pG=parseInt("11111",2),Q3=parseInt("10000000",2),gG=parseInt("01111111",2),p8={0:Nc,1:Nc,2:mG,3:wG,4:_G,5:bG,6:yG,16:Nc,22:Nc,48:Nc};function a1(r,e={offset:0}){const t=r[e.offset]&pG;if(e.offset++,p8[t]!=null)return p8[t](r,e);throw new Error("No decoder for tag "+t)}function Du(r,e){let t=0;if((r[e.offset]&Q3)===Q3){const n=r[e.offset]&gG;let s="0x";e.offset++;for(let i=0;i<n;i++,e.offset++)s+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=r[e.offset],e.offset++;return t}function Nc(r,e){Du(r,e);const t=[];for(;!(e.offset>=r.byteLength);){const n=a1(r,e);if(n===null)break;t.push(n)}return t}function mG(r,e){const t=Du(r,e),n=e.offset,s=e.offset+t,i=[];for(let o=n;o<s;o++)o===n&&r[o]===0||i.push(r[o]);return e.offset+=t,Uint8Array.from(i)}function yG(r,e){const t=Du(r,e),n=e.offset+t,s=r[e.offset];e.offset++;let i=0,o=0;s<40?(i=0,o=s):s<80?(i=1,o=s-40):(i=2,o=s-80);let a=`${i}.${o}`,c=[];for(;e.offset<n;){const l=r[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let h=0;for(let f=0;f<c.length;f++)h+=c[f]<<f*7;a+=`.${h}`,c=[]}}return a}function bG(r,e){return e.offset++,null}function wG(r,e){const t=Du(r,e),n=r[e.offset];e.offset++;const s=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function _G(r,e){const t=Du(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function EG(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);const t=new Ue;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function nm(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);const e=EG(r.byteLength);return new Ue(Uint8Array.from([e.byteLength|Q3]),e)}function X3(r){const e=new Ue,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Ue(Uint8Array.from([2]),nm(e),e)}function _E(r){const e=Uint8Array.from([0]),t=new Ue(e,r);return new Ue(Uint8Array.from([3]),nm(t),t)}function cl(r,e=48){const t=new Ue;for(const n of r)t.append(n);return new Ue(Uint8Array.from([e]),nm(t),t)}async function vG(r,e,t,n){const s=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();const i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return n?.signal?.throwIfAborted(),i}const xG=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),SG=Uint8Array.from([6,5,43,129,4,0,34]),AG=Uint8Array.from([6,5,43,129,4,0,35]),IG={ext:!0,kty:"EC",crv:"P-256"},TG={ext:!0,kty:"EC",crv:"P-384"},kG={ext:!0,kty:"EC",crv:"P-521"},u2=32,f2=48,d2=66;function CG(r){const e=a1(r);return RG(e)}function RG(r){const e=r[1][1][0],t=1;let n,s;if(e.byteLength===u2*2+1)return n=Le(e.subarray(t,t+u2),"base64url"),s=Le(e.subarray(t+u2),"base64url"),new h2({...IG,key_ops:["verify"],x:n,y:s});if(e.byteLength===f2*2+1)return n=Le(e.subarray(t,t+f2),"base64url"),s=Le(e.subarray(t+f2),"base64url"),new h2({...TG,key_ops:["verify"],x:n,y:s});if(e.byteLength===d2*2+1)return n=Le(e.subarray(t,t+d2),"base64url"),s=Le(e.subarray(t+d2),"base64url"),new h2({...kG,key_ops:["verify"],x:n,y:s});throw new o1(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function PG(r){return cl([X3(Uint8Array.from([1])),cl([DG(r.crv)],160),cl([_E(new Ue(Uint8Array.from([4]),Ge(r.x??"","base64url"),Ge(r.y??"","base64url")))],161)]).subarray()}function DG(r){if(r==="P-256")return xG;if(r==="P-384")return SG;if(r==="P-521")return AG;throw new o1(`Invalid curve ${r}`)}class h2{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=PG(this.jwk)),this._raw}toMultihash(){return Kt.digest(f1(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}async verify(e,t,n){return vG(this.jwk,t,e,n)}}function c1(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Oo(r,e=""){if(!Number.isSafeInteger(r)||r<0){const t=e&&`"${e}" `;throw new Error(`${t}expected integer >= 0, got ${r}`)}}function xt(r,e,t=""){const n=c1(r),s=r?.length,i=e!==void 0;if(!n||i&&s!==e){const o=t&&`"${t}" `,a=i?` of length ${e}`:"",c=n?`length=${s}`:`type=${typeof r}`;throw new Error(o+"expected Uint8Array"+a+", got "+c)}return r}function EE(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash must wrapped by utils.createHasher");Oo(r.outputLen),Oo(r.blockLen)}function ch(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function qG(r,e){xt(r,void 0,"digestInto() output");const t=e.outputLen;if(r.length<t)throw new Error('"digestInto() output" expected to be of length >='+t)}function dc(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function p2(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function zr(r,e){return r<<32-e|r>>>e}const vE=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",BG=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function qu(r){if(xt(r),vE)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=BG[r[t]];return e}const _s={_0:48,_9:57,A:65,F:70,a:97,f:102};function g8(r){if(r>=_s._0&&r<=_s._9)return r-_s._0;if(r>=_s.A&&r<=_s.F)return r-(_s.A-10);if(r>=_s.a&&r<=_s.f)return r-(_s.a-10)}function jl(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(vE)return Uint8Array.fromHex(r);const e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(t);for(let s=0,i=0;s<t;s++,i+=2){const o=g8(r.charCodeAt(i)),a=g8(r.charCodeAt(i+1));if(o===void 0||a===void 0){const c=r[i]+r[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[s]=o*16+a}return n}function ts(...r){let e=0;for(let n=0;n<r.length;n++){const s=r[n];xt(s),e+=s.length}const t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){const i=r[n];t.set(i,s),s+=i.length}return t}function xE(r,e={}){const t=(s,i)=>r(i).update(s).digest(),n=r(void 0);return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=s=>r(s),Object.assign(t,e),Object.freeze(t)}function rm(r=32){const e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}const SE=r=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,r])});function LG(r,e,t){return r&e^~r&t}function OG(r,e,t){return r&e^r&t^e&t}class AE{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(e,t,n,s){this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=p2(this.buffer)}update(e){ch(this),xt(e);const{view:t,buffer:n,blockLen:s}=this,i=e.length;for(let o=0;o<i;){const a=Math.min(s-this.pos,i-o);if(a===s){const c=p2(e);for(;s<=i-o;o+=s)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){ch(this),qG(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:s,isLE:i}=this;let{pos:o}=this;t[o++]=128,dc(this.buffer.subarray(o)),this.padOffset>s-o&&(this.process(n,0),o=0);for(let f=o;f<s;f++)t[f]=0;n.setBigUint64(s-8,BigInt(this.length*8),i),this.process(n,0);const a=p2(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");const l=c/4,h=this.get();if(l>h.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<l;f++)a.setUint32(4*f,h[f],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||=new this.constructor,e.set(...this.get());const{blockLen:t,buffer:n,length:s,finished:i,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=i,e.length=s,e.pos=a,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}}const mi=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Mn=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),$f=BigInt(2**32-1),m8=BigInt(32);function $G(r,e=!1){return e?{h:Number(r&$f),l:Number(r>>m8&$f)}:{h:Number(r>>m8&$f)|0,l:Number(r&$f)|0}}function MG(r,e=!1){const t=r.length;let n=new Uint32Array(t),s=new Uint32Array(t);for(let i=0;i<t;i++){const{h:o,l:a}=$G(r[i],e);[n[i],s[i]]=[o,a]}return[n,s]}const y8=(r,e,t)=>r>>>t,b8=(r,e,t)=>r<<32-t|e>>>t,da=(r,e,t)=>r>>>t|e<<32-t,ha=(r,e,t)=>r<<32-t|e>>>t,Mf=(r,e,t)=>r<<64-t|e>>>t-32,Nf=(r,e,t)=>r>>>t-32|e<<64-t;function Es(r,e,t,n){const s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}const NG=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),UG=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,FG=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),HG=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,VG=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),KG=(r,e,t,n,s,i)=>e+t+n+s+i+(r/2**32|0)|0,zG=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),yi=new Uint32Array(64);class WG extends AE{constructor(e){super(64,e,8,!1)}get(){const{A:e,B:t,C:n,D:s,E:i,F:o,G:a,H:c}=this;return[e,t,n,s,i,o,a,c]}set(e,t,n,s,i,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let f=0;f<16;f++,t+=4)yi[f]=e.getUint32(t,!1);for(let f=16;f<64;f++){const p=yi[f-15],m=yi[f-2],_=zr(p,7)^zr(p,18)^p>>>3,R=zr(m,17)^zr(m,19)^m>>>10;yi[f]=R+yi[f-7]+_+yi[f-16]|0}let{A:n,B:s,C:i,D:o,E:a,F:c,G:l,H:h}=this;for(let f=0;f<64;f++){const p=zr(a,6)^zr(a,11)^zr(a,25),m=h+p+LG(a,c,l)+zG[f]+yi[f]|0,R=(zr(n,2)^zr(n,13)^zr(n,22))+OG(n,s,i)|0;h=l,l=c,c=a,a=o+m|0,o=i,i=s,s=n,n=m+R|0}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,h=h+this.H|0,this.set(n,s,i,o,a,c,l,h)}roundClean(){dc(yi)}destroy(){this.set(0,0,0,0,0,0,0,0),dc(this.buffer)}}class GG extends WG{A=mi[0]|0;B=mi[1]|0;C=mi[2]|0;D=mi[3]|0;E=mi[4]|0;F=mi[5]|0;G=mi[6]|0;H=mi[7]|0;constructor(){super(32)}}const IE=MG(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),ZG=IE[0],jG=IE[1],bi=new Uint32Array(80),wi=new Uint32Array(80);class YG extends AE{constructor(e){super(128,e,16,!1)}get(){const{Ah:e,Al:t,Bh:n,Bl:s,Ch:i,Cl:o,Dh:a,Dl:c,Eh:l,El:h,Fh:f,Fl:p,Gh:m,Gl:_,Hh:R,Hl:T}=this;return[e,t,n,s,i,o,a,c,l,h,f,p,m,_,R,T]}set(e,t,n,s,i,o,a,c,l,h,f,p,m,_,R,T){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=h|0,this.Fh=f|0,this.Fl=p|0,this.Gh=m|0,this.Gl=_|0,this.Hh=R|0,this.Hl=T|0}process(e,t){for(let I=0;I<16;I++,t+=4)bi[I]=e.getUint32(t),wi[I]=e.getUint32(t+=4);for(let I=16;I<80;I++){const q=bi[I-15]|0,L=wi[I-15]|0,z=da(q,L,1)^da(q,L,8)^y8(q,L,7),Y=ha(q,L,1)^ha(q,L,8)^b8(q,L,7),k=bi[I-2]|0,x=wi[I-2]|0,F=da(k,x,19)^Mf(k,x,61)^y8(k,x,6),j=ha(k,x,19)^Nf(k,x,61)^b8(k,x,6),U=FG(Y,j,wi[I-7],wi[I-16]),y=HG(U,z,F,bi[I-7],bi[I-16]);bi[I]=y|0,wi[I]=U|0}let{Ah:n,Al:s,Bh:i,Bl:o,Ch:a,Cl:c,Dh:l,Dl:h,Eh:f,El:p,Fh:m,Fl:_,Gh:R,Gl:T,Hh:A,Hl:D}=this;for(let I=0;I<80;I++){const q=da(f,p,14)^da(f,p,18)^Mf(f,p,41),L=ha(f,p,14)^ha(f,p,18)^Nf(f,p,41),z=f&m^~f&R,Y=p&_^~p&T,k=VG(D,L,Y,jG[I],wi[I]),x=KG(k,A,q,z,ZG[I],bi[I]),F=k|0,j=da(n,s,28)^Mf(n,s,34)^Mf(n,s,39),U=ha(n,s,28)^Nf(n,s,34)^Nf(n,s,39),y=n&i^n&a^i&a,b=s&o^s&c^o&c;A=R|0,D=T|0,R=m|0,T=_|0,m=f|0,_=p|0,{h:f,l:p}=Es(l|0,h|0,x|0,F|0),l=a|0,h=c|0,a=i|0,c=o|0,i=n|0,o=s|0;const g=NG(F,U,b);n=UG(g,x,j,y),s=g|0}({h:n,l:s}=Es(this.Ah|0,this.Al|0,n|0,s|0)),{h:i,l:o}=Es(this.Bh|0,this.Bl|0,i|0,o|0),{h:a,l:c}=Es(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:h}=Es(this.Dh|0,this.Dl|0,l|0,h|0),{h:f,l:p}=Es(this.Eh|0,this.El|0,f|0,p|0),{h:m,l:_}=Es(this.Fh|0,this.Fl|0,m|0,_|0),{h:R,l:T}=Es(this.Gh|0,this.Gl|0,R|0,T|0),{h:A,l:D}=Es(this.Hh|0,this.Hl|0,A|0,D|0),this.set(n,s,i,o,a,c,l,h,f,p,m,_,R,T,A,D)}roundClean(){dc(bi,wi)}destroy(){dc(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}class QG extends YG{Ah=Mn[0]|0;Al=Mn[1]|0;Bh=Mn[2]|0;Bl=Mn[3]|0;Ch=Mn[4]|0;Cl=Mn[5]|0;Dh=Mn[6]|0;Dl=Mn[7]|0;Eh=Mn[8]|0;El=Mn[9]|0;Fh=Mn[10]|0;Fl=Mn[11]|0;Gh=Mn[12]|0;Gl=Mn[13]|0;Hh=Mn[14]|0;Hl=Mn[15]|0;constructor(){super(64)}}const TE=xE(()=>new GG,SE(1)),XG=xE(()=>new QG,SE(3));const sm=BigInt(0),J3=BigInt(1);function $o(r,e=""){if(typeof r!="boolean"){const t=e&&`"${e}" `;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function kE(r){if(typeof r=="bigint"){if(!Xf(r))throw new Error("positive bigint expected, got "+r)}else Oo(r);return r}function Uf(r){const e=kE(r).toString(16);return e.length&1?"0"+e:e}function CE(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?sm:BigInt("0x"+r)}function l1(r){return CE(qu(r))}function Yl(r){return CE(qu(ep(xt(r)).reverse()))}function im(r,e){Oo(e),r=kE(r);const t=jl(r.toString(16).padStart(e*2,"0"));if(t.length!==e)throw new Error("number too large");return t}function RE(r,e){return im(r,e).reverse()}function ep(r){return Uint8Array.from(r)}const Xf=r=>typeof r=="bigint"&&sm<=r;function JG(r,e,t){return Xf(r)&&Xf(e)&&Xf(t)&&e<=r&&r<t}function tp(r,e,t,n){if(!JG(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function eZ(r){let e;for(e=0;r>sm;r>>=J3,e+=1);return e}const om=r=>(J3<<BigInt(r))-J3;function tZ(r,e,t){if(Oo(r,"hashLen"),Oo(e,"qByteLen"),typeof t!="function")throw new Error("hmacFn must be a function");const n=T=>new Uint8Array(T),s=Uint8Array.of(),i=Uint8Array.of(0),o=Uint8Array.of(1),a=1e3;let c=n(r),l=n(r),h=0;const f=()=>{c.fill(1),l.fill(0),h=0},p=(...T)=>t(l,ts(c,...T)),m=(T=s)=>{l=p(i,T),c=p(),T.length!==0&&(l=p(o,T),c=p())},_=()=>{if(h++>=a)throw new Error("drbg: tried max amount of iterations");let T=0;const A=[];for(;T<e;){c=p();const D=c.slice();A.push(D),T+=c.length}return ts(...A)};return(T,A)=>{f(),m(T);let D;for(;!(D=A(_()));)m();return f(),D}}function Bu(r,e={},t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(i,o,a){const c=r[i];if(a&&c===void 0)return;const l=typeof c;if(l!==o||c===null)throw new Error(`param "${i}" is invalid: expected ${o}, got ${l}`)}const s=(i,o)=>Object.entries(i).forEach(([a,c])=>n(a,c,o));s(e,!1),s(t,!0)}function lh(r){const e=new WeakMap;return(t,...n)=>{const s=e.get(t);if(s!==void 0)return s;const i=r(t,...n);return e.set(t,i),i}}const fr=BigInt(0),kn=BigInt(1),ao=BigInt(2),PE=BigInt(3),DE=BigInt(4),qE=BigInt(5),nZ=BigInt(7),BE=BigInt(8),rZ=BigInt(9),LE=BigInt(16);function ln(r,e){const t=r%e;return t>=fr?t:e+t}function Yt(r,e,t){let n=r;for(;e-- >fr;)n*=n,n%=t;return n}function w8(r,e){if(r===fr)throw new Error("invert: expected non-zero number");if(e<=fr)throw new Error("invert: expected positive modulus, got "+e);let t=ln(r,e),n=e,s=fr,i=kn;for(;t!==fr;){const a=n/t,c=n%t,l=s-i*a;n=t,t=c,s=i,i=l}if(n!==kn)throw new Error("invert: does not exist");return ln(s,e)}function am(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function OE(r,e){const t=(r.ORDER+kn)/DE,n=r.pow(e,t);return am(r,n,e),n}function sZ(r,e){const t=(r.ORDER-qE)/BE,n=r.mul(e,ao),s=r.pow(n,t),i=r.mul(e,s),o=r.mul(r.mul(i,ao),s),a=r.mul(i,r.sub(o,r.ONE));return am(r,a,e),a}function iZ(r){const e=u1(r),t=$E(r),n=t(e,e.neg(e.ONE)),s=t(e,n),i=t(e,e.neg(n)),o=(r+nZ)/LE;return(a,c)=>{let l=a.pow(c,o),h=a.mul(l,n);const f=a.mul(l,s),p=a.mul(l,i),m=a.eql(a.sqr(h),c),_=a.eql(a.sqr(f),c);l=a.cmov(l,h,m),h=a.cmov(p,f,_);const R=a.eql(a.sqr(h),c),T=a.cmov(l,h,R);return am(a,T,c),T}}function $E(r){if(r<PE)throw new Error("sqrt is not defined for small field");let e=r-kn,t=0;for(;e%ao===fr;)e/=ao,t++;let n=ao;const s=u1(r);for(;_8(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return OE;let i=s.pow(n,e);const o=(e+kn)/ao;return function(c,l){if(c.is0(l))return l;if(_8(c,l)!==1)throw new Error("Cannot find square root");let h=t,f=c.mul(c.ONE,i),p=c.pow(l,e),m=c.pow(l,o);for(;!c.eql(p,c.ONE);){if(c.is0(p))return c.ZERO;let _=1,R=c.sqr(p);for(;!c.eql(R,c.ONE);)if(_++,R=c.sqr(R),_===h)throw new Error("Cannot find square root");const T=kn<<BigInt(h-_-1),A=c.pow(f,T);h=_,f=c.sqr(A),p=c.mul(p,f),m=c.mul(m,A)}return m}}function oZ(r){return r%DE===PE?OE:r%BE===qE?sZ:r%LE===rZ?iZ(r):$E(r)}const aZ=(r,e)=>(ln(r,e)&kn)===kn,cZ=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function lZ(r){const e={ORDER:"bigint",BYTES:"number",BITS:"number"},t=cZ.reduce((n,s)=>(n[s]="function",n),e);return Bu(r,t),r}function uZ(r,e,t){if(t<fr)throw new Error("invalid exponent, negatives unsupported");if(t===fr)return r.ONE;if(t===kn)return e;let n=r.ONE,s=e;for(;t>fr;)t&kn&&(n=r.mul(n,s)),s=r.sqr(s),t>>=kn;return n}function ME(r,e,t=!1){const n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((o,a,c)=>r.is0(a)?o:(n[c]=o,r.mul(o,a)),r.ONE),i=r.inv(s);return e.reduceRight((o,a,c)=>r.is0(a)?o:(n[c]=r.mul(o,n[c]),r.mul(o,a)),i),n}function _8(r,e){const t=(r.ORDER-kn)/ao,n=r.pow(e,t),s=r.eql(n,r.ONE),i=r.eql(n,r.ZERO),o=r.eql(n,r.neg(r.ONE));if(!s&&!i&&!o)throw new Error("invalid Legendre symbol result");return s?1:i?0:-1}function fZ(r,e){e!==void 0&&Oo(e);const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}class dZ{ORDER;BITS;BYTES;isLE;ZERO=fr;ONE=kn;_lengths;_sqrt;_mod;constructor(e,t={}){if(e<=fr)throw new Error("invalid field: expected ORDER > 0, got "+e);let n;this.isLE=!1,t!=null&&typeof t=="object"&&(typeof t.BITS=="number"&&(n=t.BITS),typeof t.sqrt=="function"&&(this.sqrt=t.sqrt),typeof t.isLE=="boolean"&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),typeof t.modFromBytes=="boolean"&&(this._mod=t.modFromBytes));const{nBitLength:s,nByteLength:i}=fZ(e,n);if(i>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=s,this.BYTES=i,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return ln(e,this.ORDER)}isValid(e){if(typeof e!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof e);return fr<=e&&e<this.ORDER}is0(e){return e===fr}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&kn)===kn}neg(e){return ln(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return ln(e*e,this.ORDER)}add(e,t){return ln(e+t,this.ORDER)}sub(e,t){return ln(e-t,this.ORDER)}mul(e,t){return ln(e*t,this.ORDER)}pow(e,t){return uZ(this,e,t)}div(e,t){return ln(e*w8(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return w8(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=oZ(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?RE(e,this.BYTES):im(e,this.BYTES)}fromBytes(e,t=!1){xt(e);const{_lengths:n,BYTES:s,isLE:i,ORDER:o,_mod:a}=this;if(n){if(!n.includes(e.length)||e.length>s)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+e.length);const l=new Uint8Array(s);l.set(e,i?0:l.length-e.length),e=l}if(e.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+e.length);let c=i?Yl(e):l1(e);if(a&&(c=ln(c,o)),!t&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(e){return ME(this,e)}cmov(e,t,n){return n?t:e}}function u1(r,e={}){return new dZ(r,e)}function NE(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function UE(r){const e=NE(r);return e+Math.ceil(e/2)}function hZ(r,e,t=!1){xt(r);const n=r.length,s=NE(e),i=UE(e);if(n<16||n<i||n>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+n);const o=t?Yl(r):l1(r),a=ln(o,e-kn)+kn;return t?RE(a,s):im(a,s)}const hc=BigInt(0),co=BigInt(1);function uh(r,e){const t=e.negate();return r?t:e}function ll(r,e){const t=ME(r.Fp,e.map(n=>n.Z));return e.map((n,s)=>r.fromAffine(n.toAffine(t[s])))}function FE(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function g2(r,e){FE(r,e);const t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,i=om(r),o=BigInt(r);return{windows:t,windowSize:n,mask:i,maxNumber:s,shiftBy:o}}function E8(r,e,t){const{windowSize:n,mask:s,maxNumber:i,shiftBy:o}=t;let a=Number(r&s),c=r>>o;a>n&&(a-=i,c+=co);const l=e*n,h=l+Math.abs(a)-1,f=a===0,p=a<0,m=e%2!==0;return{nextN:c,offset:h,isZero:f,isNeg:p,isNegF:m,offsetF:l}}const m2=new WeakMap,HE=new WeakMap;function y2(r){return HE.get(r)||1}function v8(r){if(r!==hc)throw new Error("invalid wNAF")}class VE{BASE;ZERO;Fn;bits;constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let s=e;for(;t>hc;)t&co&&(n=n.add(s)),s=s.double(),t>>=co;return n}precomputeWindow(e,t){const{windows:n,windowSize:s}=g2(t,this.bits),i=[];let o=e,a=o;for(let c=0;c<n;c++){a=o,i.push(a);for(let l=1;l<s;l++)a=a.add(o),i.push(a);o=a.double()}return i}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,i=this.BASE;const o=g2(e,this.bits);for(let a=0;a<o.windows;a++){const{nextN:c,offset:l,isZero:h,isNeg:f,isNegF:p,offsetF:m}=E8(n,a,o);n=c,h?i=i.add(uh(p,t[m])):s=s.add(uh(f,t[l]))}return v8(n),{p:s,f:i}}wNAFUnsafe(e,t,n,s=this.ZERO){const i=g2(e,this.bits);for(let o=0;o<i.windows&&n!==hc;o++){const{nextN:a,offset:c,isZero:l,isNeg:h}=E8(n,o,i);if(n=a,!l){const f=t[c];s=s.add(h?f.negate():f)}}return v8(n),s}getPrecomputes(e,t,n){let s=m2.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(s=n(s)),m2.set(t,s))),s}cached(e,t,n){const s=y2(e);return this.wNAF(s,this.getPrecomputes(s,e,n),t)}unsafe(e,t,n,s){const i=y2(e);return i===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(i,this.getPrecomputes(i,e,n),t,s)}createCache(e,t){FE(t,this.bits),HE.set(e,t),m2.delete(e)}hasCache(e){return y2(e)!==1}}function pZ(r,e,t,n){let s=e,i=r.ZERO,o=r.ZERO;for(;t>hc||n>hc;)t&co&&(i=i.add(s)),n&co&&(o=o.add(s)),s=s.double(),t>>=co,n>>=co;return{p1:i,p2:o}}function x8(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return lZ(e),e}else return u1(r,{isLE:t})}function KE(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(const c of["p","n","h"]){const l=e[c];if(!(typeof l=="bigint"&&l>hc))throw new Error(`CURVE.${c} must be positive bigint`)}const s=x8(e.p,t.Fp,n),i=x8(e.n,t.Fn,n),a=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(const c of a)if(!s.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:i}}function zE(r,e){return function(n){const s=r(n);return{secretKey:s,publicKey:e(s)}}}const _i=BigInt(0),bn=BigInt(1),b2=BigInt(2),gZ=BigInt(8);function mZ(r,e,t,n){const s=r.sqr(t),i=r.sqr(n),o=r.add(r.mul(e.a,s),i),a=r.add(r.ONE,r.mul(e.d,r.mul(s,i)));return r.eql(o,a)}function yZ(r,e={}){const t=KE("edwards",r,e,e.FpFnLE),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o}=i;Bu(e,{},{uvRatio:"function"});const a=b2<<BigInt(s.BYTES*8)-bn,c=T=>n.create(T),l=e.uvRatio||((T,A)=>{try{return{isValid:!0,value:n.sqrt(n.div(T,A))}}catch{return{isValid:!1,value:_i}}});if(!mZ(n,i,i.Gx,i.Gy))throw new Error("bad curve params: generator point");function h(T,A,D=!1){const I=D?bn:_i;return tp("coordinate "+T,A,I,a),A}function f(T){if(!(T instanceof _))throw new Error("EdwardsPoint expected")}const p=lh((T,A)=>{const{X:D,Y:I,Z:q}=T,L=T.is0();A==null&&(A=L?gZ:n.inv(q));const z=c(D*A),Y=c(I*A),k=n.mul(q,A);if(L)return{x:_i,y:bn};if(k!==bn)throw new Error("invZ was invalid");return{x:z,y:Y}}),m=lh(T=>{const{a:A,d:D}=i;if(T.is0())throw new Error("bad point: ZERO");const{X:I,Y:q,Z:L,T:z}=T,Y=c(I*I),k=c(q*q),x=c(L*L),F=c(x*x),j=c(Y*A),U=c(x*c(j+k)),y=c(F+c(D*c(Y*k)));if(U!==y)throw new Error("bad point: equation left != right (1)");const b=c(I*q),g=c(L*z);if(b!==g)throw new Error("bad point: equation left != right (2)");return!0});class _{static BASE=new _(i.Gx,i.Gy,bn,c(i.Gx*i.Gy));static ZERO=new _(_i,bn,bn,_i);static Fp=n;static Fn=s;X;Y;Z;T;constructor(A,D,I,q){this.X=h("x",A),this.Y=h("y",D),this.Z=h("z",I,!0),this.T=h("t",q),Object.freeze(this)}static CURVE(){return i}static fromAffine(A){if(A instanceof _)throw new Error("extended point not allowed");const{x:D,y:I}=A||{};return h("x",D),h("y",I),new _(D,I,bn,c(D*I))}static fromBytes(A,D=!1){const I=n.BYTES,{a:q,d:L}=i;A=ep(xt(A,I,"point")),$o(D,"zip215");const z=ep(A),Y=A[I-1];z[I-1]=Y&-129;const k=Yl(z),x=D?a:n.ORDER;tp("point.y",k,_i,x);const F=c(k*k),j=c(F-bn),U=c(L*F-q);let{isValid:y,value:b}=l(j,U);if(!y)throw new Error("bad point: invalid y coordinate");const g=(b&bn)===bn,C=(Y&128)!==0;if(!D&&b===_i&&C)throw new Error("bad point: x=0 and x_0=1");return C!==g&&(b=c(-b)),_.fromAffine({x:b,y:k})}static fromHex(A,D=!1){return _.fromBytes(jl(A),D)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(A=8,D=!0){return R.createCache(this,A),D||this.multiply(b2),this}assertValidity(){m(this)}equals(A){f(A);const{X:D,Y:I,Z:q}=this,{X:L,Y:z,Z:Y}=A,k=c(D*Y),x=c(L*q),F=c(I*Y),j=c(z*q);return k===x&&F===j}is0(){return this.equals(_.ZERO)}negate(){return new _(c(-this.X),this.Y,this.Z,c(-this.T))}double(){const{a:A}=i,{X:D,Y:I,Z:q}=this,L=c(D*D),z=c(I*I),Y=c(b2*c(q*q)),k=c(A*L),x=D+I,F=c(c(x*x)-L-z),j=k+z,U=j-Y,y=k-z,b=c(F*U),g=c(j*y),C=c(F*y),B=c(U*j);return new _(b,g,B,C)}add(A){f(A);const{a:D,d:I}=i,{X:q,Y:L,Z:z,T:Y}=this,{X:k,Y:x,Z:F,T:j}=A,U=c(q*k),y=c(L*x),b=c(Y*I*j),g=c(z*F),C=c((q+L)*(k+x)-U-y),B=g-b,M=g+b,O=c(y-D*U),$=c(C*B),V=c(M*O),G=c(C*O),de=c(B*M);return new _($,V,de,G)}subtract(A){return this.add(A.negate())}multiply(A){if(!s.isValidNot0(A))throw new Error("invalid scalar: expected 1 <= sc < curve.n");const{p:D,f:I}=R.cached(this,A,q=>ll(_,q));return ll(_,[D,I])[0]}multiplyUnsafe(A,D=_.ZERO){if(!s.isValid(A))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return A===_i?_.ZERO:this.is0()||A===bn?this:R.unsafe(this,A,I=>ll(_,I),D)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}isTorsionFree(){return R.unsafe(this,i.n).is0()}toAffine(A){return p(this,A)}clearCofactor(){return o===bn?this:this.multiplyUnsafe(o)}toBytes(){const{x:A,y:D}=this.toAffine(),I=n.toBytes(D);return I[I.length-1]|=A&bn?128:0,I}toHex(){return qu(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const R=new VE(_,s.BITS);return _.BASE.precompute(8),_}function bZ(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');Bu(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:n}=t,{BASE:s,Fp:i,Fn:o}=r,a=t.randomBytes||rm,c=t.adjustScalarBytes||(k=>k),l=t.domain||((k,x,F)=>{if($o(F,"phflag"),x.length||F)throw new Error("Contexts/pre-hash are not supported");return k});function h(k){return o.create(Yl(k))}function f(k){const x=I.secretKey;xt(k,I.secretKey,"secretKey");const F=xt(e(k),2*x,"hashedSecretKey"),j=c(F.slice(0,x)),U=F.slice(x,2*x),y=h(j);return{head:j,prefix:U,scalar:y}}function p(k){const{head:x,prefix:F,scalar:j}=f(k),U=s.multiply(j),y=U.toBytes();return{head:x,prefix:F,scalar:j,point:U,pointBytes:y}}function m(k){return p(k).pointBytes}function _(k=Uint8Array.of(),...x){const F=ts(...x);return h(e(l(F,xt(k,void 0,"context"),!!n)))}function R(k,x,F={}){k=xt(k,void 0,"message"),n&&(k=n(k));const{prefix:j,scalar:U,pointBytes:y}=p(x),b=_(F.context,j,k),g=s.multiply(b).toBytes(),C=_(F.context,g,y,k),B=o.create(b+C*U);if(!o.isValid(B))throw new Error("sign failed: invalid s");const M=ts(g,o.toBytes(B));return xt(M,I.signature,"result")}const T={zip215:!0};function A(k,x,F,j=T){const{context:U,zip215:y}=j,b=I.signature;k=xt(k,b,"signature"),x=xt(x,void 0,"message"),F=xt(F,I.publicKey,"publicKey"),y!==void 0&&$o(y,"zip215"),n&&(x=n(x));const g=b/2,C=k.subarray(0,g),B=Yl(k.subarray(g,b));let M,O,$;try{M=r.fromBytes(F,y),O=r.fromBytes(C,y),$=s.multiplyUnsafe(B)}catch{return!1}if(!y&&M.isSmallOrder())return!1;const V=_(U,O.toBytes(),M.toBytes(),x);return O.add(M.multiplyUnsafe(V)).subtract($).clearCofactor().is0()}const D=i.BYTES,I={secretKey:D,publicKey:D,signature:2*D,seed:D};function q(k=a(I.seed)){return xt(k,I.seed,"seed")}function L(k){return c1(k)&&k.length===o.BYTES}function z(k,x){try{return!!r.fromBytes(k,x)}catch{return!1}}const Y={getExtendedPublicKey:p,randomSecretKey:q,isValidSecretKey:L,isValidPublicKey:z,toMontgomery(k){const{y:x}=r.fromBytes(k),F=I.publicKey,j=F===32;if(!j&&F!==57)throw new Error("only defined for 25519 and 448");const U=j?i.div(bn+x,bn-x):i.div(x-bn,x+bn);return i.toBytes(U)},toMontgomerySecret(k){const x=I.secretKey;xt(k,x);const F=e(k.subarray(0,x));return c(F).subarray(0,x)}};return Object.freeze({keygen:zE(q,m),getPublicKey:m,sign:R,verify:A,utils:Y,Point:r,lengths:I})}const wZ=BigInt(1),S8=BigInt(2),_Z=BigInt(5),EZ=BigInt(8),cm=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),vZ={p:cm,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:EZ,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function xZ(r){const e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),i=cm,a=r*r%i*r%i,c=Yt(a,S8,i)*a%i,l=Yt(c,wZ,i)*r%i,h=Yt(l,_Z,i)*l%i,f=Yt(h,e,i)*h%i,p=Yt(f,t,i)*f%i,m=Yt(p,n,i)*p%i,_=Yt(m,s,i)*m%i,R=Yt(_,s,i)*m%i,T=Yt(R,e,i)*h%i;return{pow_p_5_8:Yt(T,S8,i)*r%i,b2:a}}function SZ(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}const A8=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function AZ(r,e){const t=cm,n=ln(e*e*e,t),s=ln(n*n*e,t),i=xZ(r*s).pow_p_5_8;let o=ln(r*n*i,t);const a=ln(e*o*o,t),c=o,l=ln(o*A8,t),h=a===r,f=a===ln(-r,t),p=a===ln(-r*A8,t);return h&&(o=c),(f||p)&&(o=l),aZ(o,t)&&(o=ln(-o,t)),{isValid:h||f,value:o}}const IZ=yZ(vZ,{uvRatio:AZ});function TZ(r){return bZ(IZ,XG,Object.assign({adjustScalarBytes:SZ},r))}const kZ=TZ({});class I8 extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}}class CZ extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}}var Ql={get(r=globalThis){const e=r.crypto;if(e?.subtle==null)throw new CZ("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};const WE=32;let w2;const RZ=(async()=>{try{return await Ql.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();async function PZ(r,e,t){if(r.buffer instanceof ArrayBuffer){const n=await Ql.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await Ql.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function DZ(r,e,t){return kZ.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function qZ(r,e,t){return w2==null&&(w2=await RZ),w2?PZ(r,e,t):DZ(r,e,t)}function GE(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class BZ{type="Ed25519";raw;constructor(e){this.raw=ZE(e,WE)}toMultihash(){return Kt.digest(f1(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();const s=qZ(this.raw,t,e);return GE(s)?s.then(i=>(n?.signal?.throwIfAborted(),i)):s}}function LZ(r){return r=ZE(r,WE),new BZ(r)}function ZE(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new o1(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}var dr;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(dr||(dr={}));var np;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(np||(np={}));(function(r){r.codec=()=>Rn(np)})(dr||(dr={}));var Xl;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),dr.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=dr.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(Xl||(Xl={}));var T8;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),dr.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=dr.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(T8||(T8={}));class OZ{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=FZ(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return nt.createV1(114,this._multihash)}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){return KZ(this.jwk,t,e,n)}}const $Z=18,MZ=1062,NZ=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function UZ(r){const e=a1(r[1],{offset:0});return{kty:"RSA",n:Le(e[0],"base64url"),e:Le(e[1],"base64url")}}function FZ(r){if(r.n==null||r.e==null)throw new o1("JWK was missing components");return cl([NZ,_E(cl([X3(Ge(r.n,"base64url")),X3(Ge(r.e,"base64url"))]))]).subarray()}function HZ(r,e){if(r.byteLength>=MZ)throw new wE("Key size is too large");const t=a1(r,{offset:0});return VZ(t,r,e)}function VZ(r,e,t){const n=UZ(r);if(t==null){const s=TE(Xl.encode({Type:dr.RSA,Data:e}));t=Ms($Z,s)}return new OZ(n,t)}async function KZ(r,e,t,n){const s=await Ql.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();const i=await Ql.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),i}class jE{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(e,t){if(EE(e),xt(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const n=this.blockLen,s=new Uint8Array(n);s.set(t.length>n?e.create().update(t).digest():t);for(let i=0;i<s.length;i++)s[i]^=54;this.iHash.update(s),this.oHash=e.create();for(let i=0;i<s.length;i++)s[i]^=106;this.oHash.update(s),dc(s)}update(e){return ch(this),this.iHash.update(e),this}digestInto(e){ch(this),xt(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||=Object.create(Object.getPrototypeOf(this),{});const{oHash:t,iHash:n,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const YE=(r,e,t)=>new jE(r,e).update(t).digest();YE.create=(r,e)=>new jE(r,e);const k8=(r,e)=>(r+(r>=0?e:-e)/QE)/e;function zZ(r,e,t){const[[n,s],[i,o]]=e,a=k8(o*r,t),c=k8(-s*r,t);let l=r-a*n-c*i,h=-a*s-c*o;const f=l<qs,p=h<qs;f&&(l=-l),p&&(h=-h);const m=om(Math.ceil(eZ(t)/2))+La;if(l<qs||l>=m||h<qs||h>=m)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:f,k1:l,k2neg:p,k2:h}}function rp(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function _2(r,e){const t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return $o(t.lowS,"lowS"),$o(t.prehash,"prehash"),t.format!==void 0&&rp(t.format),t}class WZ extends Error{constructor(e=""){super(e)}}const Ii={Err:WZ,_tlv:{encode:(r,e)=>{const{Err:t}=Ii;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const n=e.length/2,s=Uf(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");const i=n>127?Uf(s.length/2|128):"";return Uf(r)+i+s+e},decode(r,e){const{Err:t}=Ii;let n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");const s=e[n++],i=!!(s&128);let o=0;if(!i)o=s;else{const c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const l=e.subarray(n,n+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const h of l)o=o<<8|h;if(n+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const a=e.subarray(n,n+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+o)}}},_int:{encode(r){const{Err:e}=Ii;if(r<qs)throw new e("integer: negative integers are not allowed");let t=Uf(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){const{Err:e}=Ii;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return l1(r)}},toSig(r){const{Err:e,_int:t,_tlv:n}=Ii,s=xt(r,void 0,"signature"),{v:i,l:o}=n.decode(48,s);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=n.decode(2,i),{v:l,l:h}=n.decode(2,c);if(h.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(r){const{_tlv:e,_int:t}=Ii,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),i=n+s;return e.encode(48,i)}},qs=BigInt(0),La=BigInt(1),QE=BigInt(2),Ff=BigInt(3),GZ=BigInt(4);function ZZ(r,e={}){const t=KE("weierstrass",r,e),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o,n:a}=i;Bu(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});const{endo:c}=e;if(c&&(!n.is0(i.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const l=JE(n,s);function h(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function f(U,y,b){const{x:g,y:C}=y.toAffine(),B=n.toBytes(g);if($o(b,"isCompressed"),b){h();const M=!n.isOdd(C);return ts(XE(M),B)}else return ts(Uint8Array.of(4),B,n.toBytes(C))}function p(U){xt(U,void 0,"Point");const{publicKey:y,publicKeyUncompressed:b}=l,g=U.length,C=U[0],B=U.subarray(1);if(g===y&&(C===2||C===3)){const M=n.fromBytes(B);if(!n.isValid(M))throw new Error("bad point: is not on curve, wrong x");const O=R(M);let $;try{$=n.sqrt(O)}catch(de){const ce=de instanceof Error?": "+de.message:"";throw new Error("bad point: is not on curve, sqrt error"+ce)}h();const V=n.isOdd($);return(C&1)===1!==V&&($=n.neg($)),{x:M,y:$}}else if(g===b&&C===4){const M=n.BYTES,O=n.fromBytes(B.subarray(0,M)),$=n.fromBytes(B.subarray(M,M*2));if(!T(O,$))throw new Error("bad point: is not on curve");return{x:O,y:$}}else throw new Error(`bad point: got length ${g}, expected compressed=${y} or uncompressed=${b}`)}const m=e.toBytes||f,_=e.fromBytes||p;function R(U){const y=n.sqr(U),b=n.mul(y,U);return n.add(n.add(b,n.mul(U,i.a)),i.b)}function T(U,y){const b=n.sqr(y),g=R(U);return n.eql(b,g)}if(!T(i.Gx,i.Gy))throw new Error("bad curve params: generator point");const A=n.mul(n.pow(i.a,Ff),GZ),D=n.mul(n.sqr(i.b),BigInt(27));if(n.is0(n.add(A,D)))throw new Error("bad curve params: a or b");function I(U,y,b=!1){if(!n.isValid(y)||b&&n.is0(y))throw new Error(`bad point coordinate ${U}`);return y}function q(U){if(!(U instanceof x))throw new Error("Weierstrass Point expected")}function L(U){if(!c||!c.basises)throw new Error("no endo");return zZ(U,c.basises,s.ORDER)}const z=lh((U,y)=>{const{X:b,Y:g,Z:C}=U;if(n.eql(C,n.ONE))return{x:b,y:g};const B=U.is0();y==null&&(y=B?n.ONE:n.inv(C));const M=n.mul(b,y),O=n.mul(g,y),$=n.mul(C,y);if(B)return{x:n.ZERO,y:n.ZERO};if(!n.eql($,n.ONE))throw new Error("invZ was invalid");return{x:M,y:O}}),Y=lh(U=>{if(U.is0()){if(e.allowInfinityPoint&&!n.is0(U.Y))return;throw new Error("bad point: ZERO")}const{x:y,y:b}=U.toAffine();if(!n.isValid(y)||!n.isValid(b))throw new Error("bad point: x or y not field elements");if(!T(y,b))throw new Error("bad point: equation left != right");if(!U.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function k(U,y,b,g,C){return b=new x(n.mul(b.X,U),b.Y,b.Z),y=uh(g,y),b=uh(C,b),y.add(b)}class x{static BASE=new x(i.Gx,i.Gy,n.ONE);static ZERO=new x(n.ZERO,n.ONE,n.ZERO);static Fp=n;static Fn=s;X;Y;Z;constructor(y,b,g){this.X=I("x",y),this.Y=I("y",b,!0),this.Z=I("z",g),Object.freeze(this)}static CURVE(){return i}static fromAffine(y){const{x:b,y:g}=y||{};if(!y||!n.isValid(b)||!n.isValid(g))throw new Error("invalid affine point");if(y instanceof x)throw new Error("projective point not allowed");return n.is0(b)&&n.is0(g)?x.ZERO:new x(b,g,n.ONE)}static fromBytes(y){const b=x.fromAffine(_(xt(y,void 0,"point")));return b.assertValidity(),b}static fromHex(y){return x.fromBytes(jl(y))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(y=8,b=!0){return j.createCache(this,y),b||this.multiply(Ff),this}assertValidity(){Y(this)}hasEvenY(){const{y}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(y)}equals(y){q(y);const{X:b,Y:g,Z:C}=this,{X:B,Y:M,Z:O}=y,$=n.eql(n.mul(b,O),n.mul(B,C)),V=n.eql(n.mul(g,O),n.mul(M,C));return $&&V}negate(){return new x(this.X,n.neg(this.Y),this.Z)}double(){const{a:y,b}=i,g=n.mul(b,Ff),{X:C,Y:B,Z:M}=this;let O=n.ZERO,$=n.ZERO,V=n.ZERO,G=n.mul(C,C),de=n.mul(B,B),ce=n.mul(M,M),re=n.mul(C,B);return re=n.add(re,re),V=n.mul(C,M),V=n.add(V,V),O=n.mul(y,V),$=n.mul(g,ce),$=n.add(O,$),O=n.sub(de,$),$=n.add(de,$),$=n.mul(O,$),O=n.mul(re,O),V=n.mul(g,V),ce=n.mul(y,ce),re=n.sub(G,ce),re=n.mul(y,re),re=n.add(re,V),V=n.add(G,G),G=n.add(V,G),G=n.add(G,ce),G=n.mul(G,re),$=n.add($,G),ce=n.mul(B,M),ce=n.add(ce,ce),G=n.mul(ce,re),O=n.sub(O,G),V=n.mul(ce,de),V=n.add(V,V),V=n.add(V,V),new x(O,$,V)}add(y){q(y);const{X:b,Y:g,Z:C}=this,{X:B,Y:M,Z:O}=y;let $=n.ZERO,V=n.ZERO,G=n.ZERO;const de=i.a,ce=n.mul(i.b,Ff);let re=n.mul(b,B),pe=n.mul(g,M),_e=n.mul(C,O),$e=n.add(b,g),ge=n.add(B,M);$e=n.mul($e,ge),ge=n.add(re,pe),$e=n.sub($e,ge),ge=n.add(b,C);let ke=n.add(B,O);return ge=n.mul(ge,ke),ke=n.add(re,_e),ge=n.sub(ge,ke),ke=n.add(g,C),$=n.add(M,O),ke=n.mul(ke,$),$=n.add(pe,_e),ke=n.sub(ke,$),G=n.mul(de,ge),$=n.mul(ce,_e),G=n.add($,G),$=n.sub(pe,G),G=n.add(pe,G),V=n.mul($,G),pe=n.add(re,re),pe=n.add(pe,re),_e=n.mul(de,_e),ge=n.mul(ce,ge),pe=n.add(pe,_e),_e=n.sub(re,_e),_e=n.mul(de,_e),ge=n.add(ge,_e),re=n.mul(pe,ge),V=n.add(V,re),re=n.mul(ke,ge),$=n.mul($e,$),$=n.sub($,re),re=n.mul($e,pe),G=n.mul(ke,G),G=n.add(G,re),new x($,V,G)}subtract(y){return this.add(y.negate())}is0(){return this.equals(x.ZERO)}multiply(y){const{endo:b}=e;if(!s.isValidNot0(y))throw new Error("invalid scalar: out of range");let g,C;const B=M=>j.cached(this,M,O=>ll(x,O));if(b){const{k1neg:M,k1:O,k2neg:$,k2:V}=L(y),{p:G,f:de}=B(O),{p:ce,f:re}=B(V);C=de.add(re),g=k(b.beta,G,ce,M,$)}else{const{p:M,f:O}=B(y);g=M,C=O}return ll(x,[g,C])[0]}multiplyUnsafe(y){const{endo:b}=e,g=this;if(!s.isValid(y))throw new Error("invalid scalar: out of range");if(y===qs||g.is0())return x.ZERO;if(y===La)return g;if(j.hasCache(this))return this.multiply(y);if(b){const{k1neg:C,k1:B,k2neg:M,k2:O}=L(y),{p1:$,p2:V}=pZ(x,g,B,O);return k(b.beta,$,V,C,M)}else return j.unsafe(g,y)}toAffine(y){return z(this,y)}isTorsionFree(){const{isTorsionFree:y}=e;return o===La?!0:y?y(x,this):j.unsafe(this,a).is0()}clearCofactor(){const{clearCofactor:y}=e;return o===La?this:y?y(x,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(y=!0){return $o(y,"isCompressed"),this.assertValidity(),m(x,this,y)}toHex(y=!0){return qu(this.toBytes(y))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const F=s.BITS,j=new VE(x,e.endo?Math.ceil(F/2):F);return x.BASE.precompute(8),x}function XE(r){return Uint8Array.of(r?2:3)}function JE(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function jZ(r,e={}){const{Fn:t}=r,n=e.randomBytes||rm,s=Object.assign(JE(r.Fp,t),{seed:UE(t.ORDER)});function i(m){try{const _=t.fromBytes(m);return t.isValidNot0(_)}catch{return!1}}function o(m,_){const{publicKey:R,publicKeyUncompressed:T}=s;try{const A=m.length;return _===!0&&A!==R||_===!1&&A!==T?!1:!!r.fromBytes(m)}catch{return!1}}function a(m=n(s.seed)){return hZ(xt(m,s.seed,"seed"),t.ORDER)}function c(m,_=!0){return r.BASE.multiply(t.fromBytes(m)).toBytes(_)}function l(m){const{secretKey:_,publicKey:R,publicKeyUncompressed:T}=s;if(!c1(m)||"_lengths"in t&&t._lengths||_===R)return;const A=xt(m,void 0,"key").length;return A===R||A===T}function h(m,_,R=!0){if(l(m)===!0)throw new Error("first arg must be private key");if(l(_)===!1)throw new Error("second arg must be public key");const T=t.fromBytes(m);return r.fromBytes(_).multiply(T).toBytes(R)}const f={isValidSecretKey:i,isValidPublicKey:o,randomSecretKey:a},p=zE(a,c);return Object.freeze({getPublicKey:c,getSharedSecret:h,keygen:p,Point:r,utils:f,lengths:s})}function YZ(r,e,t={}){EE(e),Bu(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),t=Object.assign({},t);const n=t.randomBytes||rm,s=t.hmac||((b,g)=>YE(e,b,g)),{Fp:i,Fn:o}=r,{ORDER:a,BITS:c}=o,{keygen:l,getPublicKey:h,getSharedSecret:f,utils:p,lengths:m}=jZ(r,t),_={prehash:!0,lowS:typeof t.lowS=="boolean"?t.lowS:!0,format:"compact",extraEntropy:!1},R=a*QE<i.ORDER;function T(b){const g=a>>La;return b>g}function A(b,g){if(!o.isValidNot0(g))throw new Error(`invalid signature ${b}: out of range 1..Point.Fn.ORDER`);return g}function D(){if(R)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function I(b,g){rp(g);const C=m.signature,B=g==="compact"?C:g==="recovered"?C+1:void 0;return xt(b,B)}class q{r;s;recovery;constructor(g,C,B){if(this.r=A("r",g),this.s=A("s",C),B!=null){if(D(),![0,1,2,3].includes(B))throw new Error("invalid recovery id");this.recovery=B}Object.freeze(this)}static fromBytes(g,C=_.format){I(g,C);let B;if(C==="der"){const{r:V,s:G}=Ii.toSig(xt(g));return new q(V,G)}C==="recovered"&&(B=g[0],C="compact",g=g.subarray(1));const M=m.signature/2,O=g.subarray(0,M),$=g.subarray(M,M*2);return new q(o.fromBytes(O),o.fromBytes($),B)}static fromHex(g,C){return this.fromBytes(jl(g),C)}assertRecovery(){const{recovery:g}=this;if(g==null)throw new Error("invalid recovery id: must be present");return g}addRecoveryBit(g){return new q(this.r,this.s,g)}recoverPublicKey(g){const{r:C,s:B}=this,M=this.assertRecovery(),O=M===2||M===3?C+a:C;if(!i.isValid(O))throw new Error("invalid recovery id: sig.r+curve.n != R.x");const $=i.toBytes(O),V=r.fromBytes(ts(XE((M&1)===0),$)),G=o.inv(O),de=z(xt(g,void 0,"msgHash")),ce=o.create(-de*G),re=o.create(B*G),pe=r.BASE.multiplyUnsafe(ce).add(V.multiplyUnsafe(re));if(pe.is0())throw new Error("invalid recovery: point at infinify");return pe.assertValidity(),pe}hasHighS(){return T(this.s)}toBytes(g=_.format){if(rp(g),g==="der")return jl(Ii.hexFromSig(this));const{r:C,s:B}=this,M=o.toBytes(C),O=o.toBytes(B);return g==="recovered"?(D(),ts(Uint8Array.of(this.assertRecovery()),M,O)):ts(M,O)}toHex(g){return qu(this.toBytes(g))}}const L=t.bits2int||function(g){if(g.length>8192)throw new Error("input is too large");const C=l1(g),B=g.length*8-c;return B>0?C>>BigInt(B):C},z=t.bits2int_modN||function(g){return o.create(L(g))},Y=om(c);function k(b){return tp("num < 2^"+c,b,qs,Y),o.toBytes(b)}function x(b,g){return xt(b,void 0,"message"),g?xt(e(b),void 0,"prehashed message"):b}function F(b,g,C){const{lowS:B,prehash:M,extraEntropy:O}=_2(C,_);b=x(b,M);const $=z(b),V=o.fromBytes(g);if(!o.isValidNot0(V))throw new Error("invalid private key");const G=[k(V),k($)];if(O!=null&&O!==!1){const pe=O===!0?n(m.secretKey):O;G.push(xt(pe,void 0,"extraEntropy"))}const de=ts(...G),ce=$;function re(pe){const _e=L(pe);if(!o.isValidNot0(_e))return;const $e=o.inv(_e),ge=r.BASE.multiply(_e).toAffine(),ke=o.create(ge.x);if(ke===qs)return;const ht=o.create($e*o.create(ce+ke*V));if(ht===qs)return;let qt=(ge.x===ke?0:2)|Number(ge.y&La),$t=ht;return B&&T(ht)&&($t=o.neg(ht),qt^=1),new q(ke,$t,R?void 0:qt)}return{seed:de,k2sig:re}}function j(b,g,C={}){const{seed:B,k2sig:M}=F(b,g,C);return tZ(e.outputLen,o.BYTES,s)(B,M).toBytes(C.format)}function U(b,g,C,B={}){const{lowS:M,prehash:O,format:$}=_2(B,_);if(C=xt(C,void 0,"publicKey"),g=x(g,O),!c1(b)){const V=b instanceof q?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+V)}I(b,$);try{const V=q.fromBytes(b,$),G=r.fromBytes(C);if(M&&V.hasHighS())return!1;const{r:de,s:ce}=V,re=z(g),pe=o.inv(ce),_e=o.create(re*pe),$e=o.create(de*pe),ge=r.BASE.multiplyUnsafe(_e).add(G.multiplyUnsafe($e));return ge.is0()?!1:o.create(ge.x)===de}catch{return!1}}function y(b,g,C={}){const{prehash:B}=_2(C,_);return g=x(g,B),q.fromBytes(b,"recovered").recoverPublicKey(g).toBytes()}return Object.freeze({keygen:l,getPublicKey:h,getSharedSecret:f,utils:p,lengths:m,Point:r,sign:j,verify:U,recoverPublicKey:y,Signature:q,hash:e})}const lm={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},QZ={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},C8=BigInt(2);function XZ(r){const e=lm.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,h=l*l*r%e,f=Yt(h,t,e)*h%e,p=Yt(f,t,e)*h%e,m=Yt(p,C8,e)*l%e,_=Yt(m,s,e)*m%e,R=Yt(_,i,e)*_%e,T=Yt(R,a,e)*R%e,A=Yt(T,c,e)*T%e,D=Yt(A,a,e)*R%e,I=Yt(D,t,e)*h%e,q=Yt(I,o,e)*_%e,L=Yt(q,n,e)*l%e,z=Yt(L,C8,e);if(!sp.eql(sp.sqr(z),r))throw new Error("Cannot find square root");return z}const sp=u1(lm.p,{sqrt:XZ}),JZ=ZZ(lm,{Fp:sp,endo:QZ}),fh=YZ(JZ,TE);function ej(r,e,t,n){const s=$r.digest(t instanceof Uint8Array?t:t.subarray());if(GE(s))return s.then(({digest:i})=>(n?.signal?.throwIfAborted(),fh.verify(e,i,r,{prehash:!1,format:"der"}))).catch(i=>{throw i.name==="AbortError"?i:new I8(String(i))});try{return n?.signal?.throwIfAborted(),fh.verify(e,s.digest,r,{prehash:!1,format:"der"})}catch(i){throw new I8(String(i))}}class tj{type="secp256k1";raw;_key;constructor(e){this._key=sj(e),this.raw=rj(this._key)}toMultihash(){return Kt.digest(f1(this))}toCID(){return nt.createV1(114,this.toMultihash())}toString(){return dt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:at(this.raw,e.raw)}verify(e,t,n){return ej(this._key,t,e,n)}}function nj(r){return new tj(r)}function rj(r){return fh.Point.fromBytes(r).toBytes()}function sj(r){try{return fh.Point.fromBytes(r),r}catch(e){throw new wE(String(e))}}function ev(r,e){const{Type:t,Data:n}=Xl.decode(r),s=n??new Uint8Array;switch(t){case dr.RSA:return HZ(s,e);case dr.Ed25519:return LZ(s);case dr.secp256k1:return nj(s);case dr.ECDSA:return CG(s);default:throw new hG}}function f1(r){return Xl.encode({Type:dr[r.type],Data:r.raw})}const As={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:dG,runOnConnectionOpen:!0,runOnLimitedConnection:!0};function ij(r){if(r!=null&&r.length>0)try{return lt(r)}catch{}}function oj(r,e){return e??r.userAgent}async function aj(r,e,t,n,s){if(t("received identify from %p",n.remotePeer),s==null)throw new Jt("message was null or undefined");const i={};if(s.listenAddrs.length>0&&(i.addresses=s.listenAddrs.map(c=>({isCertified:!1,multiaddr:lt(c)}))),s.protocols.length>0&&(i.protocols=s.protocols),s.publicKey!=null){const c=ev(s.publicKey);if(!Ua(c).equals(n.remotePeer))throw new Jt("public key did not match remote PeerId");i.publicKey=c}let o;if(s.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",n.remotePeer);let c=s.signedPeerRecord;const l=await ss.openAndCertify(c,vr.DOMAIN);let h=vr.createFromProtobuf(l.payload);const f=cu(l.publicKey.toCID());if(!h.peerId.equals(f))throw new Jt("signing key does not match PeerId in the PeerRecord");if(!n.remotePeer.equals(h.peerId))throw new Jt("signing key does not match remote PeerId");let p;try{p=await r.get(h.peerId)}catch(m){if(m.name!=="NotFoundError")throw m}if(p!=null&&(i.metadata=p.metadata,p.peerRecordEnvelope!=null)){const m=ss.createFromProtobuf(p.peerRecordEnvelope),_=vr.createFromProtobuf(m.payload);_.seqNumber>=h.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",_.seqNumber,h.seqNumber),h=_,c=p.peerRecordEnvelope)}i.peerRecordEnvelope=c,i.addresses=h.multiaddrs.map(m=>({isCertified:!0,multiaddr:m})),o={seq:h.seqNumber,addresses:h.multiaddrs}}else t("%p did not send a signed peer record",n.remotePeer);if(t.trace("patching %p with",n.remotePeer,i),await r.patch(n.remotePeer,i),s.agentVersion!=null||s.protocolVersion!=null){const c={};s.agentVersion!=null&&(c.AgentVersion=Ge(s.agentVersion)),s.protocolVersion!=null&&(c.ProtocolVersion=Ge(s.protocolVersion)),t.trace("merging %p metadata",n.remotePeer,c),await r.merge(n.remotePeer,{metadata:c})}const a={peerId:n.remotePeer,protocolVersion:s.protocolVersion,agentVersion:s.agentVersion,publicKey:s.publicKey,listenAddrs:s.listenAddrs.map(c=>lt(c)),observedAddr:s.observedAddr==null?void 0:lt(s.observedAddr),protocols:s.protocols,signedPeerRecord:o,connection:n};return e.safeDispatchEvent("peer:identify",{detail:a}),a}class cj{host;protocol;started;timeout;peerId;privateKey;peerStore;registrar;addressManager;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;events;runOnLimitedConnection;log;constructor(e,t){this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.privateKey=e.privateKey,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??As.timeout,this.maxInboundStreams=t.maxInboundStreams??As.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??As.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??As.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??As.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??As.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??As.protocolPrefix}/${lG}`,agentVersion:oj(e.nodeInfo,t.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:Ge(this.host.agentVersion),ProtocolVersion:Ge(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,e=>{this.handleProtocol(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}class lj extends cj{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??As.protocolPrefix}/${uG}/${fG}`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??As.runOnConnectionOpen)&&e.events.addEventListener("connection:open",n=>{const s=n.detail;this.identify(s).catch(i=>{i.name!==Yp.name&&this.log.error("error during identify trigged by connection:open",i)})})}[pr]=["@libp2p/identify"];async _identify(e,t={}){let n;if(t.signal==null){const s=AbortSignal.timeout(this.timeout);t={...t,signal:s}}try{n=await e.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const i=await gr(n,{maxDataLength:this.maxMessageSize}).pb(ah).read(t);return await n.close(t),i}catch(s){throw n?.abort(s),s}}async identify(e,t={}){const n=await this._identify(e,t),{publicKey:s,protocols:i,observedAddr:o}=n;if(s==null)throw new Jt("Public key was missing from identify message");const a=ev(s),c=cu(a.toCID()),l=e.log.newScope("identify");if(!e.remotePeer.equals(c))throw new Jt("Identified peer does not match the expected peer");if(this.peerId.equals(c))throw new Jt("Identified peer is our own peer id?");return this.maybeAddObservedAddress(o,l),l("completed for peer %p and protocols %o",c,i),aj(this.peerStore,this.events,l,e,n)}maybeAddObservedAddress(e,t){const n=ij(e);if(n==null)return;if(t.trace("our observed address was %a",n),Co(n)){this.log.trace("our observed address was private");return}const s=n.getComponents();if((s[0].code===Sr||s[0].code===Uo&&s[1].code===Sr)&&!Aw(n)){t.trace("our observed address was IPv6 but not a global unicast address");return}$d.exactMatch(n)||(t.trace("storing the observed address"),this.addressManager.addObservedAddr(n))}async handleProtocol(e){const{connection:t,stream:n}=e,s=t.log.newScope("identify"),i=AbortSignal.timeout(this.timeout);try{const o=await this.peerStore.get(this.peerId),a=this.addressManager.getAddresses().map(f=>f.decapsulateCode(du("p2p").code));let c=o.peerRecordEnvelope;if(a.length>0&&c==null){const f=new vr({peerId:this.peerId,multiaddrs:a});c=(await ss.seal(f,this.privateKey)).marshal().subarray()}let l=t.remoteAddr.bytes;lO.matches(t.remoteAddr)||(l=void 0),await gr(n).pb(ah).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:f1(this.privateKey.publicKey),listenAddrs:a.map(f=>f.bytes),signedPeerRecord:c,observedAddr:l,protocols:o.protocols},{signal:i}),await n.close({signal:i})}catch(o){s.error("could not respond to identify request",o),n.abort(o)}}}function uj(r={}){return e=>new lj(e,r)}const fj=We("dns4"),dj=We("dns6"),hj=We("dnsaddr"),Mo=tn(We("dns"),hj,fj,dj),d1=tn(We("ip4"),We("ip6")),pc=tn(rt(d1,We("tcp")),rt(Mo,We("tcp"))),h1=rt(d1,We("udp")),pj=rt(h1,We("utp")),gj=rt(h1,We("quic")),mj=rt(h1,We("quic-v1")),ip=tn(rt(pc,We("ws")),rt(Mo,We("ws"))),dh=tn(rt(ip,We("p2p")),ip),op=tn(rt(pc,We("wss")),rt(Mo,We("wss")),rt(pc,We("tls"),We("ws")),rt(Mo,We("tls"),We("ws"))),hh=tn(rt(op,We("p2p")),op),ap=tn(rt(pc,We("http")),rt(d1,We("http")),rt(Mo,We("http"))),cp=tn(rt(pc,We("https")),rt(d1,We("https")),rt(Mo,We("https"))),R8=rt(h1,We("webrtc-direct"),We("certhash")),tv=tn(rt(R8,We("p2p")),R8),P8=rt(mj,We("webtransport"),We("certhash"),We("certhash")),nv=tn(rt(P8,We("p2p")),P8),rv=tn(rt(dh,We("p2p-webrtc-star"),We("p2p")),rt(hh,We("p2p-webrtc-star"),We("p2p")),rt(dh,We("p2p-webrtc-star")),rt(hh,We("p2p-webrtc-star")));tn(rt(dh,We("p2p-websocket-star"),We("p2p")),rt(hh,We("p2p-websocket-star"),We("p2p")),rt(dh,We("p2p-websocket-star")),rt(hh,We("p2p-websocket-star")));const sv=tn(rt(ap,We("p2p-webrtc-direct"),We("p2p")),rt(cp,We("p2p-webrtc-direct"),We("p2p")),rt(ap,We("p2p-webrtc-direct")),rt(cp,We("p2p-webrtc-direct"))),No=tn(ip,op,ap,cp,rv,sv,pc,pj,gj,Mo,tv,nv);tn(rt(No,We("p2p-stardust"),We("p2p")),rt(No,We("p2p-stardust")));const ki=tn(rt(No,We("p2p")),rv,sv,tv,nv,We("p2p")),D8=tn(rt(ki,We("p2p-circuit"),ki),rt(ki,We("p2p-circuit")),rt(We("p2p-circuit"),ki),rt(No,We("p2p-circuit")),rt(We("p2p-circuit"),No),We("p2p-circuit")),iv=()=>tn(rt(D8,iv),D8),Vi=iv(),yj=tn(rt(Vi,ki,Vi),rt(ki,Vi),rt(Vi,ki),Vi,ki);tn(rt(Vi,We("webrtc"),We("p2p")),rt(Vi,We("webrtc")),rt(No,We("webrtc"),We("p2p")),rt(No,We("webrtc")),We("webrtc"));function ov(r){function e(t){let n;try{n=lt(t)}catch{return!1}const s=r(n.protoNames());return s===null?!1:s===!0||s===!1?s:s.length===0}return e}function rt(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(s=>(n=typeof s=="function"?s().partialMatch(t):s.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:ov(e),partialMatch:e}}function tn(...r){function e(n){let s=null;return r.some(i=>{const o=typeof i=="function"?i().partialMatch(n):i.partialMatch(n);return o!=null?(s=o,!0):!1}),s}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:ov(e),partialMatch:e}}function We(r){const e=r;function t(s){let i;try{i=lt(s)}catch{return!1}const o=i.protoNames();return o.length===1&&o[0]===e}function n(s){return s.length===0?null:s[0]===e?s.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}const bj="bootstrap",wj=50,_j=1e3;class Ej extends Cn{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??_j,this.list=[];for(const n of t.list){if(!yj.matches(n)){this.log.error("Invalid multiaddr");continue}const s=lt(n),i=s.getPeerId();if(i==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}const o={id:Vn(i),multiaddrs:[s]};this.list.push(o)}this._init=t}[pd]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[pr]=["@libp2p/peer-discovery"];isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??bj]:{value:this._init.tagValue??wj,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(t=>{this.log.error("could not dial bootstrap peer %p",e.id,t)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}function vj(r){return e=>new Ej(e,r)}const vc=1e3,um=60*vc,q8="/floodsub/1.0.0",B8="/meshsub/1.0.0",xj="/meshsub/1.1.0",E2="/meshsub/1.2.0",Sj=6,Aj=4,Ij=12,Tj=4,kj=2,Cj=5,Rj=3,Pj=6,Dj=.25,qj=3,L8=100,Bj=vc,Lj=um,Oj=16,$j=um,Mj=10*vc,Nj=15,Uj=300,Fj=vc,Hj=60,Vj=2,Kj=10*vc,pa=5e3,zj=10,Wj=3*vc,Gj=2*um,Zj=120*1e3,jj="ERR_TOPIC_VALIDATOR_REJECT",Yj="ERR_TOPIC_VALIDATOR_IGNORE",Qj=0,Xj=128,Jj=1e3,eY=1e3,tY=1,nY=512,rY=512,sY={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxIdontwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};var ho;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=tt((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.subscribe!=null&&(i.uint32(8),i.bool(s.subscribe)),s.topic!=null&&(i.uint32(18),i.string(s.topic)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.subscribe=s.bool();break}case 2:{a.topic=s.string();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>et(s,t.codec()),t.decode=(s,i)=>Je(s,t.codec(),i)})(r.SubOpts||(r.SubOpts={})),(function(t){let n;t.codec=()=>(n==null&&(n=tt((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.from!=null&&(i.uint32(10),i.bytes(s.from)),s.data!=null&&(i.uint32(18),i.bytes(s.data)),s.seqno!=null&&(i.uint32(26),i.bytes(s.seqno)),s.topic!=null&&s.topic!==""&&(i.uint32(34),i.string(s.topic)),s.signature!=null&&(i.uint32(42),i.bytes(s.signature)),s.key!=null&&(i.uint32(50),i.bytes(s.key)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={topic:""},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.from=s.bytes();break}case 2:{a.data=s.bytes();break}case 3:{a.seqno=s.bytes();break}case 4:{a.topic=s.string();break}case 5:{a.signature=s.bytes();break}case 6:{a.key=s.bytes();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>et(s,t.codec()),t.decode=(s,i)=>Je(s,t.codec(),i)})(r.Message||(r.Message={})),(function(t){let n;t.codec=()=>(n==null&&(n=tt((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.ihave!=null)for(const a of s.ihave)i.uint32(10),r.ControlIHave.codec().encode(a,i);if(s.iwant!=null)for(const a of s.iwant)i.uint32(18),r.ControlIWant.codec().encode(a,i);if(s.graft!=null)for(const a of s.graft)i.uint32(26),r.ControlGraft.codec().encode(a,i);if(s.prune!=null)for(const a of s.prune)i.uint32(34),r.ControlPrune.codec().encode(a,i);if(s.idontwant!=null)for(const a of s.idontwant)i.uint32(42),r.ControlIDontWant.codec().encode(a,i);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={ihave:[],iwant:[],graft:[],prune:[],idontwant:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{if(o.limits?.ihave!=null&&a.ihave.length===o.limits.ihave)throw new Mt('Decode error - map field "ihave" had too many elements');a.ihave.push(r.ControlIHave.codec().decode(s,s.uint32(),{limits:o.limits?.ihave$}));break}case 2:{if(o.limits?.iwant!=null&&a.iwant.length===o.limits.iwant)throw new Mt('Decode error - map field "iwant" had too many elements');a.iwant.push(r.ControlIWant.codec().decode(s,s.uint32(),{limits:o.limits?.iwant$}));break}case 3:{if(o.limits?.graft!=null&&a.graft.length===o.limits.graft)throw new Mt('Decode error - map field "graft" had too many elements');a.graft.push(r.ControlGraft.codec().decode(s,s.uint32(),{limits:o.limits?.graft$}));break}case 4:{if(o.limits?.prune!=null&&a.prune.length===o.limits.prune)throw new Mt('Decode error - map field "prune" had too many elements');a.prune.push(r.ControlPrune.codec().decode(s,s.uint32(),{limits:o.limits?.prune$}));break}case 5:{if(o.limits?.idontwant!=null&&a.idontwant.length===o.limits.idontwant)throw new Mt('Decode error - map field "idontwant" had too many elements');a.idontwant.push(r.ControlIDontWant.codec().decode(s,s.uint32(),{limits:o.limits?.idontwant$}));break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>et(s,t.codec()),t.decode=(s,i)=>Je(s,t.codec(),i)})(r.ControlMessage||(r.ControlMessage={})),(function(t){let n;t.codec=()=>(n==null&&(n=tt((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),s.messageIDs!=null)for(const a of s.messageIDs)i.uint32(18),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={messageIDs:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.topicID=s.string();break}case 2:{if(o.limits?.messageIDs!=null&&a.messageIDs.length===o.limits.messageIDs)throw new Mt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(s.bytes());break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>et(s,t.codec()),t.decode=(s,i)=>Je(s,t.codec(),i)})(r.ControlIHave||(r.ControlIHave={})),(function(t){let n;t.codec=()=>(n==null&&(n=tt((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.messageIDs!=null)for(const a of s.messageIDs)i.uint32(10),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={messageIDs:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{if(o.limits?.messageIDs!=null&&a.messageIDs.length===o.limits.messageIDs)throw new Mt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(s.bytes());break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>et(s,t.codec()),t.decode=(s,i)=>Je(s,t.codec(),i)})(r.ControlIWant||(r.ControlIWant={})),(function(t){let n;t.codec=()=>(n==null&&(n=tt((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();l>>>3===1?a.topicID=s.string():s.skipType(l&7)}return a})),n),t.encode=s=>et(s,t.codec()),t.decode=(s,i)=>Je(s,t.codec(),i)})(r.ControlGraft||(r.ControlGraft={})),(function(t){let n;t.codec=()=>(n==null&&(n=tt((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),s.peers!=null)for(const a of s.peers)i.uint32(18),r.PeerInfo.codec().encode(a,i);s.backoff!=null&&(i.uint32(24),i.uint64Number(s.backoff)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={peers:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.topicID=s.string();break}case 2:{if(o.limits?.peers!=null&&a.peers.length===o.limits.peers)throw new Mt('Decode error - map field "peers" had too many elements');a.peers.push(r.PeerInfo.codec().decode(s,s.uint32(),{limits:o.limits?.peers$}));break}case 3:{a.backoff=s.uint64Number();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>et(s,t.codec()),t.decode=(s,i)=>Je(s,t.codec(),i)})(r.ControlPrune||(r.ControlPrune={})),(function(t){let n;t.codec=()=>(n==null&&(n=tt((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.peerID!=null&&(i.uint32(10),i.bytes(s.peerID)),s.signedPeerRecord!=null&&(i.uint32(18),i.bytes(s.signedPeerRecord)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.peerID=s.bytes();break}case 2:{a.signedPeerRecord=s.bytes();break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>et(s,t.codec()),t.decode=(s,i)=>Je(s,t.codec(),i)})(r.PeerInfo||(r.PeerInfo={})),(function(t){let n;t.codec=()=>(n==null&&(n=tt((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.messageIDs!=null)for(const a of s.messageIDs)i.uint32(10),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={messageIDs:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{if(o.limits?.messageIDs!=null&&a.messageIDs.length===o.limits.messageIDs)throw new Mt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(s.bytes());break}default:{s.skipType(l&7);break}}}return a})),n),t.encode=s=>et(s,t.codec()),t.decode=(s,i)=>Je(s,t.codec(),i)})(r.ControlIDontWant||(r.ControlIDontWant={}));let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.subscriptions!=null)for(const i of t.subscriptions)n.uint32(10),r.SubOpts.codec().encode(i,n);if(t.messages!=null)for(const i of t.messages)n.uint32(18),r.Message.codec().encode(i,n);t.control!=null&&(n.uint32(26),r.ControlMessage.codec().encode(t.control,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={subscriptions:[],messages:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{if(s.limits?.subscriptions!=null&&i.subscriptions.length===s.limits.subscriptions)throw new Mt('Decode error - map field "subscriptions" had too many elements');i.subscriptions.push(r.SubOpts.codec().decode(t,t.uint32(),{limits:s.limits?.subscriptions$}));break}case 2:{if(s.limits?.messages!=null&&i.messages.length===s.limits.messages)throw new Mt('Decode error - map field "messages" had too many elements');i.messages.push(r.Message.codec().decode(t,t.uint32(),{limits:s.limits?.messages$}));break}case 3:{i.control=r.ControlMessage.codec().decode(t,t.uint32(),{limits:s.limits?.control});break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(ho||(ho={}));class iY{gossip;msgs=new Map;msgIdToStrFn;history=[];notValidatedCount=0;constructor(e,t,n){this.gossip=e,this.msgIdToStrFn=n;for(let s=0;s<t;s++)this.history[s]=[]}get size(){return this.msgs.size}put(e,t,n=!1){const{msgIdStr:s}=e;return this.msgs.has(s)?!1:(this.msgs.set(s,{message:t,validated:n,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...e,topic:t.topic}),n||this.notValidatedCount++,!0)}observeDuplicate(e,t){const n=this.msgs.get(e);n!=null&&!n.validated&&n.originatingPeers.add(t)}get(e){return this.msgs.get(this.msgIdToStrFn(e))?.message}getWithIWantCount(e,t){const n=this.msgs.get(e);if(n==null)return null;const s=(n.iwantCounts.get(t)??0)+1;return n.iwantCounts.set(t,s),{msg:n.message,count:s}}getGossipIDs(e){const t=new Map;for(let n=0;n<this.gossip;n++)this.history[n].forEach(s=>{if((this.msgs.get(s.msgIdStr)?.validated??!1)&&e.has(s.topic)){let o=t.get(s.topic);o==null&&(o=[],t.set(s.topic,o)),o.push(s.msgId)}});return t}validate(e){const t=this.msgs.get(e);if(t==null)return null;t.validated||this.notValidatedCount--;const{message:n,originatingPeers:s}=t;return t.validated=!0,t.originatingPeers=new Set,{message:n,originatingPeers:s}}shift(){this.history[this.history.length-1].forEach(t=>{const n=this.msgs.get(t.msgIdStr);n!=null&&(this.msgs.delete(t.msgIdStr),n.validated||this.notValidatedCount--)}),this.history.pop(),this.history.unshift([])}remove(e){const t=this.msgs.get(e);return t==null?null:(this.msgs.delete(e),t)}}var O8;(function(r){r.StrictSign="StrictSign",r.StrictNoSign="StrictNoSign"})(O8||(O8={}));var gc;(function(r){r[r.Signing=0]="Signing",r[r.Anonymous=1]="Anonymous"})(gc||(gc={}));var Lr;(function(r){r.Error="error",r.Ignore="ignore",r.Reject="reject",r.Blacklisted="blacklisted"})(Lr||(Lr={}));var Zn;(function(r){r.InvalidSignature="invalid_signature",r.InvalidSeqno="invalid_seqno",r.InvalidPeerId="invalid_peerid",r.SignaturePresent="signature_present",r.SeqnoPresent="seqno_present",r.FromPresent="from_present",r.TransformFailed="transform_failed"})(Zn||(Zn={}));var Yn;(function(r){r.duplicate="duplicate",r.invalid="invalid",r.valid="valid"})(Yn||(Yn={}));function $8(r){switch(r){case _r.Ignore:return Lr.Ignore;case _r.Reject:return Lr.Reject;default:throw new Error("Unreachable")}}var M8;(function(r){r.forward="forward",r.publish="publish"})(M8||(M8={}));var Jn;(function(r){r.Fanout="fanout",r.Random="random",r.Subscribed="subscribed",r.Outbound="outbound",r.NotEnough="not_enough",r.Opportunistic="opportunistic"})(Jn||(Jn={}));var ns;(function(r){r.Dc="disconnected",r.BadScore="bad_score",r.Prune="prune",r.Excess="excess"})(ns||(ns={}));var ul;(function(r){r.GraftBackoff="graft_backoff",r.BrokenPromise="broken_promise",r.MessageDeficit="message_deficit",r.IPColocation="IP_colocation"})(ul||(ul={}));var fl;(function(r){r.LowScore="low_score",r.MaxIhave="max_ihave",r.MaxIasked="max_iasked"})(fl||(fl={}));var _a;(function(r){r.graylist="graylist",r.publish="publish",r.gossip="gossip",r.mesh="mesh"})(_a||(_a={}));function oY(r,e,t){return{protocolsEnabled:r.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:r.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:r.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:r.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEventsFanout:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_fanout_total",help:"Number of times we include peers in a topic mesh for fanout reasons",labelNames:["topic"]}),meshPeerInclusionEventsRandom:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_random_total",help:"Number of times we include peers in a topic mesh for random reasons",labelNames:["topic"]}),meshPeerInclusionEventsSubscribed:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_subscribed_total",help:"Number of times we include peers in a topic mesh for subscribed reasons",labelNames:["topic"]}),meshPeerInclusionEventsOutbound:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_outbound_total",help:"Number of times we include peers in a topic mesh for outbound reasons",labelNames:["topic"]}),meshPeerInclusionEventsNotEnough:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_not_enough_total",help:"Number of times we include peers in a topic mesh for not_enough reasons",labelNames:["topic"]}),meshPeerInclusionEventsOpportunistic:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_opportunistic_total",help:"Number of times we include peers in a topic mesh for opportunistic reasons",labelNames:["topic"]}),meshPeerInclusionEventsUnknown:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_unknown_total",help:"Number of times we include peers in a topic mesh for unknown reasons",labelNames:["topic"]}),meshPeerChurnEventsDisconnected:r.gauge({name:"gossipsub_peer_churn_events_disconnected_total",help:"Number of times we remove peers in a topic mesh for disconnected reasons",labelNames:["topic"]}),meshPeerChurnEventsBadScore:r.gauge({name:"gossipsub_peer_churn_events_bad_score_total",help:"Number of times we remove peers in a topic mesh for bad_score reasons",labelNames:["topic"]}),meshPeerChurnEventsPrune:r.gauge({name:"gossipsub_peer_churn_events_prune_total",help:"Number of times we remove peers in a topic mesh for prune reasons",labelNames:["topic"]}),meshPeerChurnEventsExcess:r.gauge({name:"gossipsub_peer_churn_events_excess_total",help:"Number of times we remove peers in a topic mesh for excess reasons",labelNames:["topic"]}),meshPeerChurnEventsUnknown:r.gauge({name:"gossipsub_peer_churn_events_unknown_total",help:"Number of times we remove peers in a topic mesh for unknown reasons",labelNames:["topic"]}),peersPerProtocol:r.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:r.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:r.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),acceptedMessagesTotal:r.gauge({name:"gossipsub_accepted_messages_total",help:"Total accepted messages for each topic",labelNames:["topic"]}),ignoredMessagesTotal:r.gauge({name:"gossipsub_ignored_messages_total",help:"Total ignored messages for each topic",labelNames:["topic"]}),rejectedMessagesTotal:r.gauge({name:"gossipsub_rejected_messages_total",help:"Total rejected messages for each topic",labelNames:["topic"]}),unknownValidationResultsTotal:r.gauge({name:"gossipsub_unknown_validation_results_total",help:"Total unknown validation results for each topic",labelNames:["topic"]}),asyncValidationMcacheHit:r.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),asyncValidationDelayFromFirstSeenSec:r.histogram({name:"gossipsub_async_validation_delay_from_first_seen",help:"Async validation report delay from first seen in second",buckets:[.01,.03,.1,.3,1,3,10]}),asyncValidationUnknownFirstSeen:r.gauge({name:"gossipsub_async_validation_unknown_first_seen_count_total",help:"Async validation report unknown first seen value for message"}),peerReadStreamError:r.gauge({name:"gossipsub_peer_read_stream_err_count_total",help:"Peer read stream error"}),rpcRecvBytes:r.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:r.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:r.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:r.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:r.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:r.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:r.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:r.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:r.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcDataError:r.gauge({name:"gossipsub_rpc_data_err_count_total",help:"RPC data error"}),rpcRecvError:r.gauge({name:"gossipsub_rpc_recv_err_count_total",help:"RPC recv error"}),rpcRecvNotAccepted:r.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:r.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:r.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:r.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:r.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:r.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:r.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:r.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:r.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:r.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),rpcSentIDontWant:r.gauge({name:"gossipsub_rpc_sent_idontwant_total",help:"RPC sent"}),msgPublishCount:r.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeersByTopic:r.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),directPeersPublishedTotal:r.gauge({name:"gossipsub_direct_peers_published_total",help:"Total direct peers that we publish a msg to",labelNames:["topic"]}),floodsubPeersPublishedTotal:r.gauge({name:"gossipsub_floodsub_peers_published_total",help:"Total floodsub peers that we publish a msg to",labelNames:["topic"]}),meshPeersPublishedTotal:r.gauge({name:"gossipsub_mesh_peers_published_total",help:"Total mesh peers that we publish a msg to",labelNames:["topic"]}),fanoutPeersPublishedTotal:r.gauge({name:"gossipsub_fanout_peers_published_total",help:"Total fanout peers that we publish a msg to",labelNames:["topic"]}),msgPublishBytes:r.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgPublishTime:r.histogram({name:"gossipsub_msg_publish_seconds",help:"Total time in seconds to publish a message",buckets:[.001,.002,.005,.01,.1,.5,1],labelNames:["topic"]}),msgForwardCount:r.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:r.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:r.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedError:r.gauge({name:"gossipsub_msg_received_error_total",help:"Total count of recv msgs error",labelNames:["topic"]}),prevalidationInvalidTotal:r.gauge({name:"gossipsub_pre_validation_invalid_total",help:"Total count of invalid messages received",labelNames:["topic"]}),prevalidationValidTotal:r.gauge({name:"gossipsub_pre_validation_valid_total",help:"Total count of valid messages received",labelNames:["topic"]}),prevalidationDuplicateTotal:r.gauge({name:"gossipsub_pre_validation_duplicate_total",help:"Total count of duplicate messages received",labelNames:["topic"]}),prevalidationUnknownTotal:r.gauge({name:"gossipsub_pre_validation_unknown_status_total",help:"Total count of unknown_status messages received",labelNames:["topic"]}),msgReceivedInvalid:r.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["error"]}),msgReceivedInvalidByTopic:r.gauge({name:"gossipsub_msg_received_invalid_by_topic_total",help:"Tracks specific invalid message by topic",labelNames:["topic"]}),duplicateMsgDeliveryDelay:r.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*t.maxMeshMessageDeliveriesWindowSec,.5*t.maxMeshMessageDeliveriesWindowSec,Number(t.maxMeshMessageDeliveriesWindowSec),2*t.maxMeshMessageDeliveriesWindowSec,4*t.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:r.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:r.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:r.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:r.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:r.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:r.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:r.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores"}),scoreWeights:r.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:r.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:r.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:r.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*t.behaviourPenaltyThreshold,.5*t.behaviourPenaltyThreshold,Number(t.behaviourPenaltyThreshold),2*t.behaviourPenaltyThreshold,4*t.behaviourPenaltyThreshold]}),ihaveRcvIgnored:r.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:r.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:r.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:r.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:r.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),idontwantRcvMsgids:r.gauge({name:"gossipsub_idontwant_rcv_msgids_total",help:"Total received IDONTWANT messages"}),idontwantRcvDonthaveMsgids:r.gauge({name:"gossipsub_idontwant_rcv_dont_have_msgids_total",help:"Total received IDONTWANT messageIDs that we do not have in mcache"}),iwantPromiseStarted:r.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:r.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:r.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:r.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:r.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:r.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:r.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*t.gossipPromiseExpireSec,Number(t.gossipPromiseExpireSec),2*t.gossipPromiseExpireSec,4*t.gossipPromiseExpireSec]}),iwantPromiseUntracked:r.gauge({name:"gossip_iwant_promise_untracked",help:"Total count of untracked IWANT promise"}),connectedPeersBackoffSec:r.histogram({name:"gossipsub_connected_peers_backoff_seconds",help:"Backoff time in seconds",buckets:[1,2,4,10,20,60,120]}),cacheSize:r.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:r.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:r.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:r.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:r.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:e,toTopic(n){return this.topicStrToLabel.get(n)??n},onJoin(n){this.topicSubscriptionStatus.set({topicStr:n},1),this.meshPeerCounts.set({topicStr:n},0)},onLeave(n){this.topicSubscriptionStatus.set({topicStr:n},0),this.meshPeerCounts.set({topicStr:n},0)},onAddToMesh(n,s,i){const o=this.toTopic(n);switch(s){case Jn.Fanout:this.meshPeerInclusionEventsFanout.inc({topic:o},i);break;case Jn.Random:this.meshPeerInclusionEventsRandom.inc({topic:o},i);break;case Jn.Subscribed:this.meshPeerInclusionEventsSubscribed.inc({topic:o},i);break;case Jn.Outbound:this.meshPeerInclusionEventsOutbound.inc({topic:o},i);break;case Jn.NotEnough:this.meshPeerInclusionEventsNotEnough.inc({topic:o},i);break;case Jn.Opportunistic:this.meshPeerInclusionEventsOpportunistic.inc({topic:o},i);break;default:this.meshPeerInclusionEventsUnknown.inc({topic:o},i);break}},onRemoveFromMesh(n,s,i){const o=this.toTopic(n);switch(s){case ns.Dc:this.meshPeerChurnEventsDisconnected.inc({topic:o},i);break;case ns.BadScore:this.meshPeerChurnEventsBadScore.inc({topic:o},i);break;case ns.Prune:this.meshPeerChurnEventsPrune.inc({topic:o},i);break;case ns.Excess:this.meshPeerChurnEventsExcess.inc({topic:o},i);break;default:this.meshPeerChurnEventsUnknown.inc({topic:o},i);break}},onReportValidation(n,s,i){if(this.asyncValidationMcacheHit.inc({hit:n!=null?"hit":"miss"}),n!=null){const o=this.toTopic(n.message.topic);switch(s){case _r.Accept:this.acceptedMessagesTotal.inc({topic:o});break;case _r.Ignore:this.ignoredMessagesTotal.inc({topic:o});break;case _r.Reject:this.rejectedMessagesTotal.inc({topic:o});break;default:this.unknownValidationResultsTotal.inc({topic:o});break}}i!=null?this.asyncValidationDelayFromFirstSeenSec.observe((Date.now()-i)/1e3):this.asyncValidationUnknownFirstSeen.inc()},onScorePenalty(n){this.scoringPenalties.inc({penalty:n},1)},onIhaveRcv(n,s,i){const o=this.toTopic(n);this.ihaveRcvMsgids.inc({topic:o},s),this.ihaveRcvNotSeenMsgids.inc({topic:o},i)},onIwantRcv(n,s){for(const[i,o]of n){const a=this.toTopic(i);this.iwantRcvMsgids.inc({topic:a},o)}this.iwantRcvDonthaveMsgids.inc(s)},onIdontwantRcv(n,s){this.idontwantRcvMsgids.inc(n),this.idontwantRcvDonthaveMsgids.inc(s)},onForwardMsg(n,s){const i=this.toTopic(n);this.msgForwardCount.inc({topic:i},1),this.msgForwardPeers.inc({topic:i},s)},onPublishMsg(n,s,i,o,a){const c=this.toTopic(n);this.msgPublishCount.inc({topic:c},1),this.msgPublishBytes.inc({topic:c},i*o),this.msgPublishPeersByTopic.inc({topic:c},i),this.directPeersPublishedTotal.inc({topic:c},s.direct),this.floodsubPeersPublishedTotal.inc({topic:c},s.floodsub),this.meshPeersPublishedTotal.inc({topic:c},s.mesh),this.fanoutPeersPublishedTotal.inc({topic:c},s.fanout),this.msgPublishTime.observe({topic:c},a/1e3)},onMsgRecvPreValidation(n){const s=this.toTopic(n);this.msgReceivedPreValidation.inc({topic:s},1)},onMsgRecvError(n){const s=this.toTopic(n);this.msgReceivedError.inc({topic:s},1)},onPrevalidationResult(n,s){const i=this.toTopic(n);switch(s){case Yn.duplicate:this.prevalidationDuplicateTotal.inc({topic:i});break;case Yn.invalid:this.prevalidationInvalidTotal.inc({topic:i});break;case Yn.valid:this.prevalidationValidTotal.inc({topic:i});break;default:this.prevalidationUnknownTotal.inc({topic:i});break}},onMsgRecvInvalid(n,s){const i=this.toTopic(n),o=s.reason===Lr.Error?s.error:s.reason;this.msgReceivedInvalid.inc({error:o},1),this.msgReceivedInvalidByTopic.inc({topic:i},1)},onDuplicateMsgDelivery(n,s,i){const o=this.toTopic(n);this.duplicateMsgDeliveryDelay.observe({topic:o},s/1e3),i&&this.duplicateMsgLateDelivery.inc({topic:o},1)},onPublishDuplicateMsg(n){const s=this.toTopic(n);this.duplicateMsgIgnored.inc({topic:s},1)},onPeerReadStreamError(){this.peerReadStreamError.inc(1)},onRpcRecvError(){this.rpcRecvError.inc(1)},onRpcDataError(){this.rpcDataError.inc(1)},onRpcRecv(n,s){this.rpcRecvBytes.inc(s),this.rpcRecvCount.inc(1),n.subscriptions!=null&&this.rpcRecvSubscription.inc(n.subscriptions.length),n.messages!=null&&this.rpcRecvMessage.inc(n.messages.length),n.control!=null&&(this.rpcRecvControl.inc(1),n.control.ihave!=null&&this.rpcRecvIHave.inc(n.control.ihave.length),n.control.iwant!=null&&this.rpcRecvIWant.inc(n.control.iwant.length),n.control.graft!=null&&this.rpcRecvGraft.inc(n.control.graft.length),n.control.prune!=null&&this.rpcRecvPrune.inc(n.control.prune.length))},onRpcSent(n,s){if(this.rpcSentBytes.inc(s),this.rpcSentCount.inc(1),n.subscriptions!=null&&this.rpcSentSubscription.inc(n.subscriptions.length),n.messages!=null&&this.rpcSentMessage.inc(n.messages.length),n.control!=null){const i=n.control.ihave?.length??0,o=n.control.iwant?.length??0,a=n.control.graft?.length??0,c=n.control.prune?.length??0,l=n.control.idontwant?.length??0;i>0&&this.rpcSentIHave.inc(i),o>0&&this.rpcSentIWant.inc(o),a>0&&this.rpcSentGraft.inc(a),c>0&&this.rpcSentPrune.inc(c),l>0&&this.rpcSentIDontWant.inc(l),(i>0||o>0||a>0||c>0||l>0)&&this.rpcSentControl.inc(1)}},registerScores(n,s){let i=0,o=0,a=0,c=0;for(const l of n)l>=s.graylistThreshold&&i++,l>=s.publishThreshold&&o++,l>=s.gossipThreshold&&a++,l>=0&&c++;this.peersByScoreThreshold.set({threshold:_a.graylist},i),this.peersByScoreThreshold.set({threshold:_a.publish},o),this.peersByScoreThreshold.set({threshold:_a.gossip},a),this.peersByScoreThreshold.set({threshold:_a.mesh},c),this.score.set(n)},registerScoreWeights(n){for(const[s,i]of n.byTopic)this.scoreWeights.set({topic:s,p:"p1"},i.p1w),this.scoreWeights.set({topic:s,p:"p2"},i.p2w),this.scoreWeights.set({topic:s,p:"p3"},i.p3w),this.scoreWeights.set({topic:s,p:"p3b"},i.p3bw),this.scoreWeights.set({topic:s,p:"p4"},i.p4w);this.scoreWeights.set({p:"p5"},n.p5w),this.scoreWeights.set({p:"p6"},n.p6w),this.scoreWeights.set({p:"p7"},n.p7w)},registerScorePerMesh(n,s){const i=new Map;n.forEach((o,a)=>{const c=this.topicStrToLabel.get(a)??"unknown";let l=i.get(c);l==null&&(l=new Set,i.set(c,l)),o.forEach(h=>l?.add(h))});for(const[o,a]of i){const c=[];a.forEach(l=>{c.push(s.get(l)??0)}),this.scorePerMesh.set({topic:o},c)}}}}class Dt extends Error{static name="InvalidPeerScoreParamsError";constructor(e="Invalid peer score params"){super(e),this.name="InvalidPeerScoreParamsError"}}const aY={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:3600*1e3},cY={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function lY(r={}){return{...aY,...r,topics:r.topics!=null?Object.entries(r.topics).reduce((e,[t,n])=>(e[t]=uY(n),e),{}):{}}}function uY(r={}){return{...cY,...r}}function fY(r){for(const[e,t]of Object.entries(r.topics))try{dY(t)}catch(n){throw new Dt(`invalid score parameters for topic ${e}: ${n.message}`)}if(r.topicScoreCap<0)throw new Dt("invalid topic score cap; must be positive (or 0 for no cap)");if(r.appSpecificScore===null||r.appSpecificScore===void 0)throw new Dt("missing application specific score function");if(r.IPColocationFactorWeight>0)throw new Dt("invalid IPColocationFactorWeight; must be negative (or 0 to disable)");if(r.IPColocationFactorWeight!==0&&r.IPColocationFactorThreshold<1)throw new Dt("invalid IPColocationFactorThreshold; must be at least 1");if(r.behaviourPenaltyWeight>0)throw new Dt("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)");if(r.behaviourPenaltyWeight!==0&&(r.behaviourPenaltyDecay<=0||r.behaviourPenaltyDecay>=1))throw new Dt("invalid BehaviourPenaltyDecay; must be between 0 and 1");if(r.decayInterval<1e3)throw new Dt("invalid DecayInterval; must be at least 1s");if(r.decayToZero<=0||r.decayToZero>=1)throw new Dt("invalid DecayToZero; must be between 0 and 1")}function dY(r){if(r.topicWeight<0)throw new Dt("invalid topic weight; must be >= 0");if(r.timeInMeshQuantum===0)throw new Dt("invalid TimeInMeshQuantum; must be non zero");if(r.timeInMeshWeight<0)throw new Dt("invalid TimeInMeshWeight; must be positive (or 0 to disable)");if(r.timeInMeshWeight!==0&&r.timeInMeshQuantum<=0)throw new Dt("invalid TimeInMeshQuantum; must be positive");if(r.timeInMeshWeight!==0&&r.timeInMeshCap<=0)throw new Dt("invalid TimeInMeshCap; must be positive");if(r.firstMessageDeliveriesWeight<0)throw new Dt("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)");if(r.firstMessageDeliveriesWeight!==0&&(r.firstMessageDeliveriesDecay<=0||r.firstMessageDeliveriesDecay>=1))throw new Dt("invalid FirstMessageDeliveriesDecay; must be between 0 and 1");if(r.firstMessageDeliveriesWeight!==0&&r.firstMessageDeliveriesCap<=0)throw new Dt("invalid FirstMessageDeliveriesCap; must be positive");if(r.meshMessageDeliveriesWeight>0)throw new Dt("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)");if(r.meshMessageDeliveriesWeight!==0&&(r.meshMessageDeliveriesDecay<=0||r.meshMessageDeliveriesDecay>=1))throw new Dt("invalid MeshMessageDeliveriesDecay; must be between 0 and 1");if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesCap<=0)throw new Dt("invalid MeshMessageDeliveriesCap; must be positive");if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesThreshold<=0)throw new Dt("invalid MeshMessageDeliveriesThreshold; must be positive");if(r.meshMessageDeliveriesWindow<0)throw new Dt("invalid MeshMessageDeliveriesWindow; must be non-negative");if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesActivation<1e3)throw new Dt("invalid MeshMessageDeliveriesActivation; must be at least 1s");if(r.meshFailurePenaltyWeight>0)throw new Dt("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)");if(r.meshFailurePenaltyWeight!==0&&(r.meshFailurePenaltyDecay<=0||r.meshFailurePenaltyDecay>=1))throw new Dt("invalid MeshFailurePenaltyDecay; must be between 0 and 1");if(r.invalidMessageDeliveriesWeight>0)throw new Dt("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)");if(r.invalidMessageDeliveriesDecay<=0||r.invalidMessageDeliveriesDecay>=1)throw new Dt("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1")}const hY={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function pY(r={}){return{...hY,...r}}function lp(r,e,t=()=>!0){const n=new Set;if(e<=0)return n;for(const s of r){if(n.size>=e)break;t(s)&&(n.add(s),r.delete(s))}return n}function gY(r,e){return lp(r,e,()=>!0)}class mY extends Map{getDefault;constructor(e){super(),this.getDefault=e}getOrDefault(e){let t=super.get(e);return t===void 0&&(t=this.getDefault(),this.set(e,t)),t}}function yY(r,e,t,n){let s=0;Object.entries(e.topics).forEach(([o,a])=>{const c=t.topics[o];if(c===void 0)return;let l=0;if(a.inMesh){let m=a.meshTime/c.timeInMeshQuantum;m>c.timeInMeshCap&&(m=c.timeInMeshCap),l+=m*c.timeInMeshWeight}let h=a.firstMessageDeliveries;if(h>c.firstMessageDeliveriesCap&&(h=c.firstMessageDeliveriesCap),l+=h*c.firstMessageDeliveriesWeight,a.meshMessageDeliveriesActive&&a.meshMessageDeliveries<c.meshMessageDeliveriesThreshold){const m=c.meshMessageDeliveriesThreshold-a.meshMessageDeliveries,_=m*m;l+=_*c.meshMessageDeliveriesWeight}const f=a.meshFailurePenalty;l+=f*c.meshFailurePenaltyWeight;const p=a.invalidMessageDeliveries*a.invalidMessageDeliveries;l+=p*c.invalidMessageDeliveriesWeight,s+=l*c.topicWeight}),t.topicScoreCap>0&&s>t.topicScoreCap&&(s=t.topicScoreCap);const i=t.appSpecificScore(r);if(s+=i*t.appSpecificWeight,e.knownIPs.forEach(o=>{if(t.IPColocationFactorWhitelist.has(o))return;const a=n.get(o),c=a!=null?a.size:0;if(c>t.IPColocationFactorThreshold){const l=c-t.IPColocationFactorThreshold,h=l*l;s+=h*t.IPColocationFactorWeight}}),e.behaviourPenalty>t.behaviourPenaltyThreshold){const o=e.behaviourPenalty-t.behaviourPenaltyThreshold,a=o*o;s+=a*t.behaviourPenaltyWeight}return s}var v2,N8;function bY(){if(N8)return v2;N8=1;function r(e,n){var n=n||{};this._capacity=n.capacity,this._head=0,this._tail=0,Array.isArray(e)?this._fromArray(e):(this._capacityMask=3,this._list=new Array(4))}return r.prototype.peekAt=function(t){var n=t;if(n===(n|0)){var s=this.size();if(!(n>=s||n<-s))return n<0&&(n+=s),n=this._head+n&this._capacityMask,this._list[n]}},r.prototype.get=function(t){return this.peekAt(t)},r.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]},r.prototype.peekFront=function(){return this.peek()},r.prototype.peekBack=function(){return this.peekAt(-1)},Object.defineProperty(r.prototype,"length",{get:function(){return this.size()}}),r.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},r.prototype.unshift=function(t){if(arguments.length===0)return this.size();var n=this._list.length;return this._head=this._head-1+n&this._capacityMask,this._list[this._head]=t,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},r.prototype.shift=function(){var t=this._head;if(t!==this._tail){var n=this._list[t];return this._list[t]=void 0,this._head=t+1&this._capacityMask,t<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),n}},r.prototype.push=function(t){if(arguments.length===0)return this.size();var n=this._tail;return this._list[n]=t,this._tail=n+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},r.prototype.pop=function(){var t=this._tail;if(t!==this._head){var n=this._list.length;this._tail=t-1+n&this._capacityMask;var s=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&t>1e4&&t<=n>>>2&&this._shrinkArray(),s}},r.prototype.removeOne=function(t){var n=t;if(n===(n|0)&&this._head!==this._tail){var s=this.size(),i=this._list.length;if(!(n>=s||n<-s)){n<0&&(n+=s),n=this._head+n&this._capacityMask;var o=this._list[n],a;if(t<s/2){for(a=t;a>0;a--)this._list[n]=this._list[n=n-1+i&this._capacityMask];this._list[n]=void 0,this._head=this._head+1+i&this._capacityMask}else{for(a=s-1-t;a>0;a--)this._list[n]=this._list[n=n+1+i&this._capacityMask];this._list[n]=void 0,this._tail=this._tail-1+i&this._capacityMask}return o}}},r.prototype.remove=function(t,n){var s=t,i,o=n;if(s===(s|0)&&this._head!==this._tail){var a=this.size(),c=this._list.length;if(!(s>=a||s<-a||n<1)){if(s<0&&(s+=a),n===1||!n)return i=new Array(1),i[0]=this.removeOne(s),i;if(s===0&&s+n>=a)return i=this.toArray(),this.clear(),i;s+n>a&&(n=a-s);var l;for(i=new Array(n),l=0;l<n;l++)i[l]=this._list[this._head+s+l&this._capacityMask];if(s=this._head+s&this._capacityMask,t+n===a){for(this._tail=this._tail-n+c&this._capacityMask,l=n;l>0;l--)this._list[s=s+1+c&this._capacityMask]=void 0;return i}if(t===0){for(this._head=this._head+n+c&this._capacityMask,l=n-1;l>0;l--)this._list[s=s+1+c&this._capacityMask]=void 0;return i}if(s<a/2){for(this._head=this._head+t+n+c&this._capacityMask,l=t;l>0;l--)this.unshift(this._list[s=s-1+c&this._capacityMask]);for(s=this._head-1+c&this._capacityMask;o>0;)this._list[s=s-1+c&this._capacityMask]=void 0,o--;t<0&&(this._tail=s)}else{for(this._tail=s,s=s+n+c&this._capacityMask,l=a-(n+t);l>0;l--)this.push(this._list[s++]);for(s=this._tail;o>0;)this._list[s=s+1+c&this._capacityMask]=void 0,o--}return this._head<2&&this._tail>1e4&&this._tail<=c>>>2&&this._shrinkArray(),i}}},r.prototype.splice=function(t,n){var s=t;if(s===(s|0)){var i=this.size();if(s<0&&(s+=i),!(s>i))if(arguments.length>2){var o,a,c,l=arguments.length,h=this._list.length,f=2;if(!i||s<i/2){for(a=new Array(s),o=0;o<s;o++)a[o]=this._list[this._head+o&this._capacityMask];for(n===0?(c=[],s>0&&(this._head=this._head+s+h&this._capacityMask)):(c=this.remove(s,n),this._head=this._head+s+h&this._capacityMask);l>f;)this.unshift(arguments[--l]);for(o=s;o>0;o--)this.unshift(a[o-1])}else{a=new Array(i-(s+n));var p=a.length;for(o=0;o<p;o++)a[o]=this._list[this._head+s+n+o&this._capacityMask];for(n===0?(c=[],s!=i&&(this._tail=this._head+s+h&this._capacityMask)):(c=this.remove(s,n),this._tail=this._tail-p+h&this._capacityMask);f<l;)this.push(arguments[f++]);for(o=0;o<p;o++)this.push(a[o])}return c}else return this.remove(s,n)}},r.prototype.clear=function(){this._list=new Array(this._list.length),this._head=0,this._tail=0},r.prototype.isEmpty=function(){return this._head===this._tail},r.prototype.toArray=function(){return this._copyArray(!1)},r.prototype._fromArray=function(t){var n=t.length,s=this._nextPowerOf2(n);this._list=new Array(s),this._capacityMask=s-1,this._tail=n;for(var i=0;i<n;i++)this._list[i]=t[i]},r.prototype._copyArray=function(t,n){var s=this._list,i=s.length,o=this.length;if(n=n|o,n==o&&this._head<this._tail)return this._list.slice(this._head,this._tail);var a=new Array(n),c=0,l;if(t||this._head>this._tail){for(l=this._head;l<i;l++)a[c++]=s[l];for(l=0;l<this._tail;l++)a[c++]=s[l]}else for(l=this._head;l<this._tail;l++)a[c++]=s[l];return a},r.prototype._growArray=function(){if(this._head!=0){var t=this._copyArray(!0,this._list.length<<1);this._tail=this._list.length,this._head=0,this._list=t}else this._tail=this._list.length,this._list.length<<=1;this._capacityMask=this._capacityMask<<1|1},r.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1},r.prototype._nextPowerOf2=function(t){var n=Math.log(t)/Math.log(2),s=1<<n+1;return Math.max(s,4)},v2=r,v2}var wY=bY(),_Y=Ch(wY),jn;(function(r){r[r.unknown=0]="unknown",r[r.valid=1]="valid",r[r.invalid=2]="invalid",r[r.ignored=3]="ignored"})(jn||(jn={}));class EY{records;queue;constructor(){this.records=new Map,this.queue=new _Y}getRecord(e){return this.records.get(e)}ensureRecord(e){let t=this.records.get(e);if(t!=null)return t;t={status:jn.unknown,firstSeenTsMs:Date.now(),validated:0,peers:new Set},this.records.set(e,t);const n={msgId:e,expire:Date.now()+Zj};return this.queue.push(n),t}gc(){const e=Date.now();let t=this.queue.peekFront();for(;t!=null&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}}class vY{params;metrics;peerStats=new Map;peerIPs=new mY(()=>new Set);scoreCache=new Map;deliveryRecords=new EY;_backgroundInterval;scoreCacheValidityMs;computeScore;log;constructor(e,t,n,s){this.params=e,this.metrics=t,fY(e),this.scoreCacheValidityMs=s.scoreCacheValidityMs,this.computeScore=s.computeScore??yY,this.log=n.forComponent("libp2p:gossipsub:score")}get size(){return this.peerStats.size}start(){if(this._backgroundInterval!=null){this.log("Peer score already running");return}this._backgroundInterval=setInterval(()=>{this.background()},this.params.decayInterval),this.log("started")}stop(){if(this._backgroundInterval==null){this.log("Peer score already stopped");return}clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),this.log("stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map(([e,t])=>[e,t]))}messageFirstSeenTimestampMs(e){const t=this.deliveryRecords.getRecord(e);return t!=null?t.firstSeenTsMs:null}refreshScores(){const e=Date.now(),t=this.params.decayToZero;this.peerStats.forEach((n,s)=>{if(!n.connected){e>n.expire&&(this.removeIPsForPeer(s,n.knownIPs),this.peerStats.delete(s),this.scoreCache.delete(s));return}Object.entries(n.topics).forEach(([i,o])=>{const a=this.params.topics[i];a!==void 0&&(o.firstMessageDeliveries*=a.firstMessageDeliveriesDecay,o.firstMessageDeliveries<t&&(o.firstMessageDeliveries=0),o.meshMessageDeliveries*=a.meshMessageDeliveriesDecay,o.meshMessageDeliveries<t&&(o.meshMessageDeliveries=0),o.meshFailurePenalty*=a.meshFailurePenaltyDecay,o.meshFailurePenalty<t&&(o.meshFailurePenalty=0),o.invalidMessageDeliveries*=a.invalidMessageDeliveriesDecay,o.invalidMessageDeliveries<t&&(o.invalidMessageDeliveries=0),o.inMesh&&(o.meshTime=e-o.graftTime,o.meshTime>a.meshMessageDeliveriesActivation&&(o.meshMessageDeliveriesActive=!0)))}),n.behaviourPenalty*=this.params.behaviourPenaltyDecay,n.behaviourPenalty<t&&(n.behaviourPenalty=0)})}score(e){this.metrics?.scoreFnCalls.inc();const t=this.peerStats.get(e);if(t==null)return 0;const n=Date.now(),s=this.scoreCache.get(e);if(s!=null&&s.cacheUntil>n)return s.score;this.metrics?.scoreFnRuns.inc();const i=this.computeScore(e,t,this.params,this.peerIPs),o=n+this.scoreCacheValidityMs;return s!=null?(this.metrics?.scoreCachedDelta.observe(Math.abs(i-s.score)),s.score=i,s.cacheUntil=o):this.scoreCache.set(e,{score:i,cacheUntil:o}),i}addPenalty(e,t,n){const s=this.peerStats.get(e);s!=null&&(s.behaviourPenalty+=t,this.metrics?.onScorePenalty(n))}addPeer(e){const t={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(e,t)}addIP(e,t){const n=this.peerStats.get(e);n?.knownIPs.add(t),this.peerIPs.getOrDefault(t).add(e)}removeIP(e,t){const n=this.peerStats.get(e);n?.knownIPs.delete(t);const s=this.peerIPs.get(t);s!=null&&(s.delete(e),s.size===0&&this.peerIPs.delete(t))}removePeer(e){const t=this.peerStats.get(e);if(t!=null){if(this.score(e)>0){this.removeIPsForPeer(e,t.knownIPs),this.peerStats.delete(e);return}Object.entries(t.topics).forEach(([n,s])=>{s.firstMessageDeliveries=0;const i=this.params.topics[n].meshMessageDeliveriesThreshold;if(s.inMesh&&s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.inMesh=!1,s.meshMessageDeliveriesActive=!1}),t.connected=!1,t.expire=Date.now()+this.params.retainScore}}graft(e,t){const n=this.peerStats.get(e);if(n!=null){const s=this.getPtopicStats(n,t);s!=null&&(s.inMesh=!0,s.graftTime=Date.now(),s.meshTime=0,s.meshMessageDeliveriesActive=!1)}}prune(e,t){const n=this.peerStats.get(e);if(n!=null){const s=this.getPtopicStats(n,t);if(s!=null){const i=this.params.topics[t].meshMessageDeliveriesThreshold;if(s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.meshMessageDeliveriesActive=!1,s.inMesh=!1}}}validateMessage(e){this.deliveryRecords.ensureRecord(e)}deliverMessage(e,t,n){this.markFirstMessageDelivery(e,n);const s=this.deliveryRecords.ensureRecord(t),i=Date.now();if(s.status!==jn.unknown){this.log("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,i-s.firstSeenTsMs,jn[s.status]);return}s.status=jn.valid,s.validated=i,s.peers.forEach(o=>{o!==e.toString()&&this.markDuplicateMessageDelivery(o,n)})}rejectInvalidMessage(e,t){this.markInvalidMessageDelivery(e,t)}rejectMessage(e,t,n,s){switch(s){case Lr.Error:this.markInvalidMessageDelivery(e,n);return;case Lr.Blacklisted:return}const i=this.deliveryRecords.ensureRecord(t);if(i.status!==jn.unknown){this.log("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-i.firstSeenTsMs,jn[i.status]);return}if(s===Lr.Ignore){i.status=jn.ignored,i.peers.clear();return}i.status=jn.invalid,this.markInvalidMessageDelivery(e,n),i.peers.forEach(o=>{this.markInvalidMessageDelivery(o,n)}),i.peers.clear()}duplicateMessage(e,t,n){const s=this.deliveryRecords.ensureRecord(t);if(!s.peers.has(e))switch(s.status){case jn.unknown:s.peers.add(e);break;case jn.valid:s.peers.add(e),this.markDuplicateMessageDelivery(e,n,s.validated);break;case jn.invalid:this.markInvalidMessageDelivery(e,n);break;case jn.ignored:break}}markInvalidMessageDelivery(e,t){const n=this.peerStats.get(e);if(n!=null){const s=this.getPtopicStats(n,t);s!=null&&(s.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(e,t){const n=this.peerStats.get(e);if(n!=null){const s=this.getPtopicStats(n,t);if(s!=null){let i=this.params.topics[t].firstMessageDeliveriesCap;s.firstMessageDeliveries=Math.min(i,s.firstMessageDeliveries+1),s.inMesh&&(i=this.params.topics[t].meshMessageDeliveriesCap,s.meshMessageDeliveries=Math.min(i,s.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(e,t,n){const s=this.peerStats.get(e);if(s!=null){const i=n!==void 0?Date.now():0,o=this.getPtopicStats(s,t);if(o!=null&&o.inMesh){const a=this.params.topics[t];if(n!==void 0){const l=i-n,h=l>a.meshMessageDeliveriesWindow;if(this.metrics?.onDuplicateMsgDelivery(t,l,h),h)return}const c=a.meshMessageDeliveriesCap;o.meshMessageDeliveries=Math.min(c,o.meshMessageDeliveries+1)}}}removeIPsForPeer(e,t){for(const n of t){const s=this.peerIPs.get(n);s!=null&&(s.delete(e),s.size===0&&this.peerIPs.delete(n))}}getPtopicStats(e,t){let n=e.topics[t];return n!==void 0?n:this.params.topics[t]!==void 0?(n={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=n,n):null}}function xY(r,e,t,n,s){let i=0;const o=new Map;if(Object.entries(e.topics).forEach(([p,m])=>{const _=s.get(p)??"unknown",R=t.topics[p];if(R===void 0)return;let T=o.get(_);T==null&&(T={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},o.set(_,T));let A=0,D=0,I=0,q=0,L=0;if(m.inMesh){const x=Math.max(m.meshTime/R.timeInMeshQuantum,R.timeInMeshCap);A+=x*R.timeInMeshWeight}let z=m.firstMessageDeliveries;if(z>R.firstMessageDeliveriesCap&&(z=R.firstMessageDeliveriesCap),D+=z*R.firstMessageDeliveriesWeight,m.meshMessageDeliveriesActive&&m.meshMessageDeliveries<R.meshMessageDeliveriesThreshold){const x=R.meshMessageDeliveriesThreshold-m.meshMessageDeliveries,F=x*x;I+=F*R.meshMessageDeliveriesWeight}const Y=m.meshFailurePenalty;q+=Y*R.meshFailurePenaltyWeight;const k=m.invalidMessageDeliveries*m.invalidMessageDeliveries;L+=k*R.invalidMessageDeliveriesWeight,i+=(A+D+I+q+L)*R.topicWeight,T.p1w+=A,T.p2w+=D,T.p3w+=I,T.p3bw+=q,T.p4w+=L}),t.topicScoreCap>0&&i>t.topicScoreCap){i=t.topicScoreCap;const p=t.topicScoreCap/i;for(const m of o.values())m.p1w*=p,m.p2w*=p,m.p3w*=p,m.p3bw*=p,m.p4w*=p}let a=0,c=0,l=0;const h=t.appSpecificScore(r);a+=h*t.appSpecificWeight,e.knownIPs.forEach(p=>{if(t.IPColocationFactorWhitelist.has(p))return;const m=n.get(p),_=m!=null?m.size:0;if(_>t.IPColocationFactorThreshold){const R=_-t.IPColocationFactorThreshold,T=R*R;c+=T*t.IPColocationFactorWeight}});const f=e.behaviourPenalty*e.behaviourPenalty;return l+=f*t.behaviourPenaltyWeight,i+=a+c+l,{byTopic:o,p5w:a,p6w:c,p7w:l,score:i}}function SY(r,e,t,n,s){const i={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(const o of r){const a=e.get(o);if(a!=null){const c=xY(o,a,t,n,s);for(const[l,h]of c.byTopic){let f=i.byTopic.get(l);f==null&&(f={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},i.byTopic.set(l,f)),f.p1w.push(h.p1w),f.p2w.push(h.p2w),f.p3w.push(h.p3w),f.p3bw.push(h.p3bw),f.p4w.push(h.p4w)}i.p5w.push(c.p5w),i.p6w.push(c.p6w),i.p7w.push(c.p7w),i.score.push(c.score)}else i.p5w.push(0),i.p6w.push(0),i.p7w.push(0),i.score.push(0)}return i}class AY{rawStream;pushable;closeController;maxBufferSize;constructor(e,t,n){this.rawStream=e,this.pushable=Or(),this.closeController=new AbortController,this.maxBufferSize=n.maxBufferSize??1/0,this.closeController.signal.addEventListener("abort",()=>{e.close().catch(s=>{e.abort(s)})}),Ar(this.pushable,this.rawStream).catch(t)}get protocol(){return this.rawStream.protocol}push(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(Eu.single(e))}pushPrefixed(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(e)}async close(){this.closeController.abort(),await this.pushable.return()}}class IY{source;rawStream;closeController;constructor(e,t={}){this.rawStream=e,this.closeController=new AbortController,this.closeController.signal.addEventListener("abort",()=>{e.close().catch(n=>{e.abort(n)})}),this.source=Ar(this.rawStream,n=>$l(n,t))}async close(){this.closeController.abort()}}class TY{gossipsubIWantFollowupMs;msgIdToStrFn;metrics;promises=new Map;requestMsByMsg=new Map;requestMsByMsgExpire;constructor(e,t,n){this.gossipsubIWantFollowupMs=e,this.msgIdToStrFn=t,this.metrics=n,this.requestMsByMsgExpire=10*e}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(e,t){const n=Math.floor(Math.random()*t.length),s=t[n],i=this.msgIdToStrFn(s);let o=this.promises.get(i);o==null&&(o=new Map,this.promises.set(i,o));const a=Date.now();o.has(e)||(o.set(e,a+this.gossipsubIWantFollowupMs),this.metrics!=null&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(i)||this.requestMsByMsg.set(i,a)))}getBrokenPromises(){const e=Date.now(),t=new Map;let n=0;return this.promises.forEach((s,i)=>{s.forEach((o,a)=>{o<e&&(t.set(a,(t.get(a)??0)+1),s.delete(a),n++)}),s.size===0&&this.promises.delete(i)}),this.metrics?.iwantPromiseBroken.inc(n),t}deliverMessage(e,t=!1){this.trackMessage(e);const n=this.promises.get(e);n!=null&&(this.promises.delete(e),this.metrics!=null&&(this.metrics.iwantPromiseResolved.inc(1),t&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(n.size)))}rejectMessage(e,t){this.trackMessage(e),t!==Lr.Error&&this.promises.delete(e)}clear(){this.promises.clear()}prune(){const e=Date.now()-this.requestMsByMsgExpire;let t=0;for(const[n,s]of this.requestMsByMsg.entries())if(s<e)this.requestMsByMsg.delete(n),t++;else break;this.metrics?.iwantMessagePruned.inc(t)}trackMessage(e){if(this.metrics!=null){const t=this.requestMsByMsg.get(e);t!==void 0&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}}const av=Ge("libp2p-pubsub:");async function kY(r,e,t,n){switch(r.type){case gc.Signing:{const s={from:r.author.toMultihash().bytes,data:n,seqno:pz(8),topic:e,signature:void 0,key:void 0},i=is([av,ho.Message.encode(s)]);s.signature=await r.privateKey.sign(i),s.key=r.key;const o={type:"signed",from:r.author,data:t,sequenceNumber:BigInt(`0x${Le(s.seqno??new Uint8Array(0),"base16")}`),topic:e,signature:s.signature,key:Gl(s.key)};return{raw:s,msg:o}}case gc.Anonymous:return{raw:{from:void 0,data:n,seqno:void 0,topic:e,signature:void 0,key:void 0},msg:{type:"unsigned",data:t,topic:e}};default:throw new Error("Unreachable")}}async function CY(r,e){switch(r){case Gp:return e.signature!=null?{valid:!1,error:Zn.SignaturePresent}:e.seqno!=null?{valid:!1,error:Zn.SeqnoPresent}:e.from!=null?{valid:!1,error:Zn.FromPresent}:{valid:!0,message:{type:"unsigned",topic:e.topic,data:e.data??new Uint8Array(0)}};case gd:{if(e.seqno==null)return{valid:!1,error:Zn.InvalidSeqno};if(e.seqno.length!==8)return{valid:!1,error:Zn.InvalidSeqno};if(e.signature==null)return{valid:!1,error:Zn.InvalidSignature};if(e.from==null)return{valid:!1,error:Zn.InvalidPeerId};let t;try{t=mr(Gn(e.from))}catch{return{valid:!1,error:Zn.InvalidPeerId}}let n;if(e.key!=null){if(n=Gl(e.key),t.publicKey!==void 0&&!n.equals(t.publicKey))return{valid:!1,error:Zn.InvalidPeerId}}else{if(t.publicKey==null)return{valid:!1,error:Zn.InvalidPeerId};n=t.publicKey}const s={from:e.from,data:e.data,seqno:e.seqno,topic:e.topic,signature:void 0,key:void 0},i=is([av,ho.Message.encode(s)]);return await n.verify(i,e.signature)?{valid:!0,message:{type:"signed",from:t,data:e.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${Le(e.seqno,"base16")}`),topic:e.topic,signature:e.signature,key:n}}:{valid:!1,error:Zn.InvalidSignature}}default:throw new Error("Unreachable")}}function Wr(r=[],e){return{subscriptions:[],messages:r,control:e!==void 0?{graft:e.graft??[],prune:e.prune??[],ihave:e.ihave??[],iwant:e.iwant??[],idontwant:e.idontwant??[]}:void 0}}function U8(r){return r.control===void 0&&(r.control={graft:[],prune:[],ihave:[],iwant:[],idontwant:[]}),r}function vs(r){if(r.length<=1)return r;const e=()=>Math.floor(Math.random()*Math.floor(r.length));for(let t=0;t<r.length;t++){const n=e(),s=r[t];r[t]=r[n],r[n]=s}return r}function RY(r){return Le(r,"base64")}function PY(r,e,t){switch(r){case gd:return{type:gc.Signing,author:e,key:Ru(t.publicKey),privateKey:t};case Gp:return{type:gc.Anonymous};default:throw new Error(`Unknown signature policy "${r}"`)}}var $s;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})($s||($s={}));var up;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(up||(up={}));(function(r){r.codec=()=>Rn(up)})($s||($s={}));var fp;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),$s.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=$s.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(fp||(fp={}));var F8;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),$s.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{i.Type=$s.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return i})),e),r.encode=t=>et(t,r.codec()),r.decode=(t,n)=>Je(t,r.codec(),n)})(F8||(F8={}));function DY(r){return fp.encode({Type:$s[r.type],Data:r.raw})}const qY=(r,e)=>{const t=Ge(e.toString(16).padStart(16,"0"),"base16"),n=DY(r),s=new Uint8Array(n.byteLength+t.length);return s.set(n,0),s.set(t,n.byteLength),s};function BY(r){if(r.type!=="signed")throw new Error("expected signed message type");if(r.sequenceNumber==null)throw Error("missing seqno field");return qY(r.from.publicKey??r.key,r.sequenceNumber)}async function LY(r){return $r.encode(r.data)}var ph;(function(r){r[r.ip4=4]="ip4",r[r.ip6=41]="ip6"})(ph||(ph={}));function OY(r){for(const e of r.tuples())switch(e[0]){case ph.ip4:case ph.ip6:return MR(e[0],e[1])}return null}class x2{entries=new Map;validityMs;constructor(e){this.validityMs=e.validityMs}get size(){return this.entries.size}put(e,t){return this.entries.has(e)?!0:(this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){const e=Date.now();for(const[t,n]of this.entries.entries())if(n.validUntilMs<e)this.entries.delete(t);else break}has(e){return this.entries.has(e)}get(e){const t=this.entries.get(e);return t!=null&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries.clear()}}var yr;(function(r){r[r.started=0]="started",r[r.stopped=1]="stopped"})(yr||(yr={}));class $Y extends Cn{globalSignaturePolicy;multicodecs=[E2,xj,B8];publishConfig;dataTransform;peers=new Map;streamsInbound=new Map;streamsOutbound=new Map;outboundInflightQueue=Or({objectMode:!0});direct=new Set;floodsubPeers=new Set;seenCache;acceptFromWhitelist=new Map;topics=new Map;subscriptions=new Set;mesh=new Map;fanout=new Map;fanoutLastpub=new Map;gossip=new Map;control=new Map;peerhave=new Map;iasked=new Map;backoff=new Map;outbound=new Map;msgIdFn;fastMsgIdFn;msgIdToStrFn;fastMsgIdCache;publishedMessageIds;mcache;score;topicValidators=new Map;log;heartbeatTicks=0;gossipTracer;idontwantCounts=new Map;idontwants=new Map;components;directPeerInitial=null;static multicodec=E2;opts;decodeRpcLimits;metrics;status={code:yr.stopped};maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;allowedTopics;heartbeatTimer=null;constructor(e,t={}){super();const n={fallbackToFloodsub:!0,floodPublish:!0,batchPublish:!1,tagMeshPeers:!0,doPX:!1,directPeers:[],D:Sj,Dlo:Aj,Dhi:Ij,Dscore:Tj,Dout:kj,Dlazy:Pj,heartbeatInterval:Bj,fanoutTTL:Lj,mcacheLength:Cj,mcacheGossip:Rj,seenTTL:Gj,gossipsubIWantFollowupMs:Wj,prunePeers:Oj,pruneBackoff:$j,unsubcribeBackoff:Mj,graftFloodThreshold:Kj,opportunisticGraftPeers:Vj,opportunisticGraftTicks:Hj,directConnectTicks:Uj,gossipFactor:Dj,idontwantMinDataSize:nY,idontwantMaxMessages:rY,...t,scoreParams:lY(t.scoreParams),scoreThresholds:pY(t.scoreThresholds)};if(this.components=e,this.decodeRpcLimits=n.decodeRpcLimits??sY,this.globalSignaturePolicy=n.globalSignaturePolicy??gd,n.fallbackToFloodsub&&this.multicodecs.push(q8),this.log=e.logger.forComponent(n.debugName??"libp2p:gossipsub"),this.opts=n,this.direct=new Set(n.directPeers.map(s=>s.id.toString())),this.seenCache=new x2({validityMs:n.seenTTL}),this.publishedMessageIds=new x2({validityMs:n.seenTTL}),t.msgIdFn!=null)this.msgIdFn=t.msgIdFn;else switch(this.globalSignaturePolicy){case gd:this.msgIdFn=BY;break;case Gp:this.msgIdFn=LY;break;default:throw new Error(`Invalid globalSignaturePolicy: ${this.globalSignaturePolicy}`)}if(t.fastMsgIdFn!=null&&(this.fastMsgIdFn=t.fastMsgIdFn,this.fastMsgIdCache=new x2({validityMs:n.seenTTL})),this.msgIdToStrFn=t.msgIdToStrFn??RY,this.mcache=t.messageCache??new iY(n.mcacheGossip,n.mcacheLength,this.msgIdToStrFn),t.dataTransform!=null&&(this.dataTransform=t.dataTransform),t.metricsRegister!=null){if(t.metricsTopicStrToLabel==null)throw Error("Must set metricsTopicStrToLabel with metrics");const s=Math.max(...Object.values(n.scoreParams.topics).map(o=>o.meshMessageDeliveriesWindow),eY),i=oY(t.metricsRegister,t.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:n.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:s/1e3});i.mcacheSize.addCollect(()=>{this.onScrapeMetrics(i)});for(const o of this.multicodecs)i.protocolsEnabled.set({protocol:o},1);this.metrics=i}else this.metrics=null;this.gossipTracer=new TY(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new vY(this.opts.scoreParams,this.metrics,this.components.logger,{scoreCacheValidityMs:n.heartbeatInterval}),this.maxInboundStreams=t.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams,this.runOnLimitedConnection=t.runOnLimitedConnection,this.allowedTopics=n.allowedTopics!=null?new Set(n.allowedTopics):null}[Symbol.toStringTag]="@chainsafe/libp2p-gossipsub";[pr]=["@libp2p/pubsub"];[_o]=["@libp2p/identify"];getPeers(){return[...this.peers.values()]}isStarted(){return this.status.code===yr.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=PY(this.globalSignaturePolicy,this.components.peerId,this.components.privateKey),this.outboundInflightQueue=Or({objectMode:!0}),Ar(this.outboundInflightQueue,async i=>{for await(const{peerId:o,connection:a}of i)await this.createOutboundStream(o,a)}).catch(i=>{this.log.error("outbound inflight queue error",i)}),await Promise.all(this.opts.directPeers.map(async i=>{await this.components.peerStore.merge(i.id,{multiaddrs:i.addrs})}));const e=this.components.registrar;await Promise.all(this.multicodecs.map(async i=>e.handle(i,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection})));const t={onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this),notifyOnLimitedConnection:this.runOnLimitedConnection},n=await Promise.all(this.multicodecs.map(async i=>e.register(i,t))),s=setTimeout(this.runHeartbeat,L8);this.status={code:yr.started,registrarTopologyIds:n,heartbeatTimeout:s,hearbeatStartMs:Date.now()+L8},this.score.start(),this.directPeerInitial=setTimeout(()=>{Promise.resolve().then(async()=>{await Promise.all(Array.from(this.direct).map(async i=>this.connect(i)))}).catch(i=>{this.log(i)})},Fj),this.opts.tagMeshPeers&&(this.addEventListener("gossipsub:graft",this.tagMeshPeer),this.addEventListener("gossipsub:prune",this.untagMeshPeer)),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==yr.started)return;const{registrarTopologyIds:e}=this.status;this.status={code:yr.stopped},this.opts.tagMeshPeers&&(this.removeEventListener("gossipsub:graft",this.tagMeshPeer),this.removeEventListener("gossipsub:prune",this.untagMeshPeer));const t=this.components.registrar;await Promise.all(this.multicodecs.map(async s=>t.unhandle(s))),e.forEach(s=>{t.unregister(s)}),this.outboundInflightQueue.end();const n=[];for(const s of this.streamsOutbound.values())n.push(s.close());this.streamsOutbound.clear();for(const s of this.streamsInbound.values())n.push(s.close());this.streamsInbound.clear(),await Promise.all(n),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer!=null&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache!=null&&this.fastMsgIdCache.clear(),this.directPeerInitial!=null&&clearTimeout(this.directPeerInitial),this.idontwantCounts.clear(),this.idontwants.clear(),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream({stream:e,connection:t}){if(!this.isStarted())return;const n=t.remotePeer;this.addPeer(n,t.direction,t.remoteAddr),this.createInboundStream(n,e),this.outboundInflightQueue.push({peerId:n,connection:t})}onPeerConnected(e,t){this.metrics?.newConnectionCount.inc({status:t.status}),!(!this.isStarted()||t.status!=="open")&&(this.addPeer(e,t.direction,t.remoteAddr),this.outboundInflightQueue.push({peerId:e,connection:t}))}onPeerDisconnected(e){this.log("connection ended %p",e),this.removePeer(e)}async createOutboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(this.peers.has(n)&&!this.streamsOutbound.has(n))try{const s=new AY(await t.newStream(this.multicodecs,{runOnLimitedConnection:this.runOnLimitedConnection}),o=>{this.log.error("outbound pipe error",o)},{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",e),this.streamsOutbound.set(n,s);const i=s.protocol;i===q8&&this.floodsubPeers.add(n),this.metrics?.peersPerProtocol.inc({protocol:i},1),this.subscriptions.size>0&&(this.log("send subscriptions to",n),this.sendSubscriptions(n,Array.from(this.subscriptions),!0))}catch(s){this.log.error("createOutboundStream error",s)}}createInboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(!this.peers.has(n))return;const s=this.streamsInbound.get(n);s!==void 0&&(this.log("replacing existing inbound steam %s",n),s.close().catch(o=>{this.log.error(o)})),this.log("create inbound stream %s",n);const i=new IY(t,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(n,i),this.pipePeerReadStream(e,i.source).catch(o=>{this.log(o)})}addPeer(e,t,n){const s=e.toString();if(!this.peers.has(s)){this.log("new peer %p",e),this.peers.set(s,e),this.score.addPeer(s);const i=OY(n);i!==null?this.score.addIP(s,i):this.log("Added peer has no IP in current address %s %s",s,n.toString()),this.outbound.has(s)||this.outbound.set(s,t==="outbound")}}removePeer(e){const t=e.toString();if(!this.peers.has(t))return;this.log("delete peer %p",e),this.peers.delete(t);const n=this.streamsOutbound.get(t),s=this.streamsInbound.get(t);n!=null&&this.metrics?.peersPerProtocol.inc({protocol:n.protocol},-1),n?.close().catch(i=>{this.log.error(i)}),s?.close().catch(i=>{this.log.error(i)}),this.streamsOutbound.delete(t),this.streamsInbound.delete(t);for(const i of this.topics.values())i.delete(t);for(const[i,o]of this.mesh)o.delete(t)&&this.metrics?.onRemoveFromMesh(i,ns.Dc,1);for(const i of this.fanout.values())i.delete(t);this.floodsubPeers.delete(t),this.gossip.delete(t),this.control.delete(t),this.outbound.delete(t),this.idontwantCounts.delete(t),this.idontwants.delete(t),this.score.removePeer(t),this.acceptFromWhitelist.delete(t)}get started(){return this.status.code===yr.started}getMeshPeers(e){const t=this.mesh.get(e);return t!=null?Array.from(t):[]}getSubscribers(e){const t=this.topics.get(e);return(t!=null?Array.from(t):[]).map(n=>this.peers.get(n)??Vn(n))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(e,t){try{await Ar(t,async n=>{for await(const s of n)try{const i=s.subarray(),o=ho.decode(i,{limits:{subscriptions:this.decodeRpcLimits.maxSubscriptions,messages:this.decodeRpcLimits.maxMessages,control$:{ihave:this.decodeRpcLimits.maxIhaveMessageIDs,iwant:this.decodeRpcLimits.maxIwantMessageIDs,graft:this.decodeRpcLimits.maxControlMessages,prune:this.decodeRpcLimits.maxControlMessages,prune$:{peers:this.decodeRpcLimits.maxPeerInfos},idontwant:this.decodeRpcLimits.maxControlMessages,idontwant$:{messageIDs:this.decodeRpcLimits.maxIdontwantMessageIDs}}}});if(this.metrics?.onRpcRecv(o,i.length),this.opts.awaitRpcHandler)try{await this.handleReceivedRpc(e,o)}catch(a){this.metrics?.onRpcRecvError(),this.log(a)}else this.handleReceivedRpc(e,o).catch(a=>{this.metrics?.onRpcRecvError(),this.log(a)})}catch(i){this.metrics?.onRpcDataError(),this.log(i)}})}catch(n){this.metrics?.onPeerReadStreamError(),this.handlePeerReadStreamError(n,e)}}handlePeerReadStreamError(e,t){this.log.error(e),this.onPeerDisconnected(t)}async handleReceivedRpc(e,t){if(!this.acceptFrom(e.toString())){this.log("received message from unacceptable peer %p",e),this.metrics?.rpcRecvNotAccepted.inc();return}const n=t.subscriptions!=null?t.subscriptions.length:0,s=t.messages!=null?t.messages.length:0;let i=0,o=0,a=0,c=0;if(t.control!=null&&(t.control.ihave!=null&&(i=t.control.ihave.length),t.control.iwant!=null&&(o=t.control.iwant.length),t.control.graft!=null&&(a=t.control.graft.length),t.control.prune!=null&&(c=t.control.prune.length)),this.log(`rpc.from ${e.toString()} subscriptions ${n} messages ${s} ihave ${i} iwant ${o} graft ${a} prune ${c}`),t.subscriptions!=null&&t.subscriptions.length>0){const l=[];t.subscriptions.forEach(h=>{const f=h.topic,p=h.subscribe===!0;if(f!=null){if(this.allowedTopics!=null&&!this.allowedTopics.has(f))return;this.handleReceivedSubscription(e,f,p),l.push({topic:f,subscribe:p})}}),this.safeDispatchEvent("subscription-change",{detail:{peerId:e,subscriptions:l}})}for(const l of t.messages){if(this.allowedTopics!=null&&!this.allowedTopics.has(l.topic))continue;const h=this.handleReceivedMessage(e,l).catch(f=>{this.metrics?.onMsgRecvError(l.topic),this.log(f)});this.opts.awaitRpcMessageHandler&&await h}t.control!=null&&await this.handleControlMessage(e.toString(),t.control)}handleReceivedSubscription(e,t,n){this.log("subscription update from %p topic %s",e,t);let s=this.topics.get(t);s==null&&(s=new Set,this.topics.set(t,s)),n?s.add(e.toString()):s.delete(e.toString())}async handleReceivedMessage(e,t){this.metrics?.onMsgRecvPreValidation(t.topic);const n=await this.validateReceivedMessage(e,t);this.metrics?.onPrevalidationResult(t.topic,n.code);const s=n.code;switch(s){case Yn.duplicate:this.score.duplicateMessage(e.toString(),n.msgIdStr,t.topic),this.gossipTracer.deliverMessage(n.msgIdStr,!0),this.mcache.observeDuplicate(n.msgIdStr,e.toString());return;case Yn.invalid:if(n.msgIdStr!=null){const i=n.msgIdStr;this.score.rejectMessage(e.toString(),i,t.topic,n.reason),this.gossipTracer.rejectMessage(i,n.reason)}else this.score.rejectInvalidMessage(e.toString(),t.topic);this.metrics?.onMsgRecvInvalid(t.topic,n);return;case Yn.valid:this.score.validateMessage(n.messageId.msgIdStr),this.gossipTracer.deliverMessage(n.messageId.msgIdStr),this.mcache.put(n.messageId,t,!this.opts.asyncValidation),this.subscriptions.has(t.topic)&&(!this.components.peerId.equals(e)||this.opts.emitSelf)&&(super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:e,msgId:n.messageId.msgIdStr,msg:n.msg}})),super.dispatchEvent(new CustomEvent("message",{detail:n.msg}))),this.opts.asyncValidation||this.forwardMessage(n.messageId.msgIdStr,t,e.toString());break;default:throw new Error(`Invalid validation result: ${s}`)}}async validateReceivedMessage(e,t){const n=this.fastMsgIdFn?.(t),s=n!==void 0?this.fastMsgIdCache?.get(n):void 0;if(s!=null)return{code:Yn.duplicate,msgIdStr:s};const i=await CY(this.globalSignaturePolicy,t);if(!i.valid)return{code:Yn.invalid,reason:Lr.Error,error:i.error};const o=i.message;try{this.dataTransform!=null&&(o.data=this.dataTransform.inboundTransform(t.topic,o.data))}catch(f){return this.log("Invalid message, transform failed",f),{code:Yn.invalid,reason:Lr.Error,error:Zn.TransformFailed}}const a=await this.msgIdFn(o),c=this.msgIdToStrFn(a),l={msgId:a,msgIdStr:c};if(n!==void 0&&this.fastMsgIdCache!=null&&this.fastMsgIdCache.put(n,c)&&this.metrics?.fastMsgIdCacheCollision.inc(),this.seenCache.has(c))return{code:Yn.duplicate,msgIdStr:c};this.seenCache.put(c),(t.data?.length??0)>=this.opts.idontwantMinDataSize&&this.sendIDontWants(a,t.topic,e.toString());const h=this.topicValidators.get(t.topic);if(h!=null){let f;try{f=await h(e,o)}catch(p){const m=p.code;m===Yj&&(f=_r.Ignore),m===jj?f=_r.Reject:f=_r.Ignore}if(f!==_r.Accept)return{code:Yn.invalid,reason:$8(f),msgIdStr:c}}return{code:Yn.valid,messageId:l,msg:o}}getScore(e){return this.score.score(e)}sendSubscriptions(e,t,n){this.sendRpc(e,{subscriptions:t.map(s=>({topic:s,subscribe:n})),messages:[]})}async handleControlMessage(e,t){if(t===void 0)return;const n=t.ihave?.length>0?this.handleIHave(e,t.ihave):[],s=t.iwant?.length>0?this.handleIWant(e,t.iwant):[],i=t.graft?.length>0?await this.handleGraft(e,t.graft):[];if(t.prune?.length>0&&await this.handlePrune(e,t.prune),t.idontwant?.length>0&&this.handleIdontwant(e,t.idontwant),n.length===0&&s.length===0&&i.length===0)return;const o=this.sendRpc(e,Wr(s,{iwant:n,prune:i})),a=n[0]?.messageIDs;a!=null&&(o?this.gossipTracer.addPromise(e,a):this.metrics?.iwantPromiseUntracked.inc(1))}acceptFrom(e){if(this.direct.has(e))return!0;const t=Date.now(),n=this.acceptFromWhitelist.get(e);if(n!=null&&n.messagesAccepted<Xj&&n.acceptUntil>=t)return n.messagesAccepted+=1,!0;const s=this.score.score(e);return s>=Qj?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:t+Jj}):this.acceptFromWhitelist.delete(e),s>=this.opts.scoreThresholds.graylistThreshold}handleIHave(e,t){if(t.length===0)return[];const n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,n),this.metrics?.ihaveRcvIgnored.inc({reason:fl.LowScore}),[];const s=(this.peerhave.get(e)??0)+1;if(this.peerhave.set(e,s),s>zj)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,s),this.metrics?.ihaveRcvIgnored.inc({reason:fl.MaxIhave}),[];const i=this.iasked.get(e)??0;if(i>=pa)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,i),this.metrics?.ihaveRcvIgnored.inc({reason:fl.MaxIasked}),[];const o=new Map;if(t.forEach(({topicID:l,messageIDs:h})=>{if(l==null||h==null||!this.mesh.has(l))return;let f=0;h.forEach(p=>{const m=this.msgIdToStrFn(p);this.seenCache.has(m)||(o.set(m,p),f++)}),this.metrics?.onIhaveRcv(l,h.length,f)}),o.size===0)return[];let a=o.size;a+i>pa&&(a=pa-i),this.log("IHAVE: Asking for %d out of %d messages from %s",a,o.size,e);let c=Array.from(o.values());return vs(c),c=c.slice(0,a),this.iasked.set(e,i+a),[{messageIDs:c}]}handleIWant(e,t){if(t.length===0)return[];const n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,n),[];const s=new Map,i=new Map;let o=0;return t.forEach(({messageIDs:a})=>{a?.forEach(c=>{const l=this.msgIdToStrFn(c),h=this.mcache.getWithIWantCount(l,e);if(h==null){o++;return}if(i.set(h.msg.topic,1+(i.get(h.msg.topic)??0)),h.count>qj){this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,c);return}s.set(l,h.msg)})}),this.metrics?.onIwantRcv(i,o),s.size===0?(this.log("IWANT: Could not provide any wanted messages to %s",e),[]):(this.log("IWANT: Sending %d messages to %s",s.size,e),Array.from(s.values()))}async handleGraft(e,t){const n=[],s=this.score.score(e),i=Date.now();let o=this.opts.doPX;if(t.forEach(({topicID:c})=>{if(c==null)return;const l=this.mesh.get(c);if(l==null){o=!1;return}if(l.has(e))return;const h=this.backoff.get(c)?.get(e);if(this.direct.has(e))this.log("GRAFT: ignoring request from direct peer %s",e),n.push(c),o=!1;else if(typeof h=="number"&&i<h){this.log("GRAFT: ignoring backed off peer %s",e),this.score.addPenalty(e,1,ul.GraftBackoff),o=!1;const f=h+this.opts.graftFloodThreshold-this.opts.pruneBackoff;i<f&&this.score.addPenalty(e,1,ul.GraftBackoff),this.addBackoff(e,c),n.push(c)}else s<0?(this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",e,s,c),n.push(c),o=!1,this.addBackoff(e,c)):l.size>=this.opts.Dhi&&!(this.outbound.get(e)??!1)?(n.push(c),this.addBackoff(e,c)):(this.log("GRAFT: Add mesh link from %s in %s",e,c),this.score.graft(e,c),l.add(e),this.metrics?.onAddToMesh(c,Jn.Subscribed,1));this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:e,topic:c,direction:"inbound"}})}),n.length===0)return[];const a=!1;return Promise.all(n.map(async c=>this.makePrune(e,c,o,a)))}async handlePrune(e,t){const n=this.score.score(e);for(const{topicID:s,backoff:i,peers:o}of t){if(s==null)continue;const a=this.mesh.get(s);if(a==null)return;this.log("PRUNE: Remove mesh link to %s in %s",e,s),this.score.prune(e,s),a.has(e)&&(a.delete(e),this.metrics?.onRemoveFromMesh(s,ns.Prune,1)),typeof i=="number"&&i>0?this.doAddBackoff(e,s,i*1e3):this.addBackoff(e,s),o!=null&&o.length>0&&(n<this.opts.scoreThresholds.acceptPXThreshold?this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",e,n,s):await this.pxConnect(o)),this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:e,topic:s,direction:"inbound"}})}}handleIdontwant(e,t){let n=this.idontwantCounts.get(e)??0;if(n>=this.opts.idontwantMaxMessages)return;const s=n;let i=this.idontwants.get(e);i==null&&(i=new Map,this.idontwants.set(e,i));let o=0;e:for(const{messageIDs:c}of t)for(const l of c){if(n>=this.opts.idontwantMaxMessages)break e;n++;const h=this.msgIdToStrFn(l);i.set(h,this.heartbeatTicks),this.mcache.msgs.has(h)||o++}this.idontwantCounts.set(e,n);const a=n-s;this.metrics?.onIdontwantRcv(a,o)}addBackoff(e,t){this.doAddBackoff(e,t,this.opts.pruneBackoff)}doAddBackoff(e,t,n){let s=this.backoff.get(t);s==null&&(s=new Map,this.backoff.set(t,s));const i=Date.now()+n;(s.get(e)??0)<i&&s.set(e,i)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach((e,t)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",t,e),this.score.addPenalty(t,e,ul.BrokenPromise)})}clearBackoff(){if(this.heartbeatTicks%Nj!==0)return;const e=Date.now();this.backoff.forEach((t,n)=>{t.forEach((s,i)=>{s+tY*this.opts.heartbeatInterval<e&&t.delete(i)}),t.size===0&&this.backoff.delete(n)})}async directConnect(){const e=[];this.direct.forEach(t=>{this.streamsOutbound.has(t)||e.push(t)}),await Promise.all(e.map(async t=>this.connect(t)))}async pxConnect(e){e.length>this.opts.prunePeers&&(vs(e),e=e.slice(0,this.opts.prunePeers));const t=[];await Promise.all(e.map(async n=>{if(n.peerID==null)return;const s=mr(Gn(n.peerID)),i=s.toString();if(!this.peers.has(i)){if(n.signedPeerRecord==null){t.push(i);return}try{if(!await this.components.peerStore.consumePeerRecord(n.signedPeerRecord,s)){this.log("bogus peer record obtained through px: could not add peer record to address book");return}t.push(i)}catch{this.log("bogus peer record obtained through px: invalid signature or not a peer record")}}})),t.length!==0&&await Promise.all(t.map(async n=>this.connect(n)))}async connect(e){this.log("Initiating connection with %s",e);const t=Vn(e),n=await this.components.connectionManager.openConnection(t);for(const s of this.multicodecs)for(const i of this.components.registrar.getTopologies(s))i.onConnect?.(t,n)}subscribe(e){if(this.status.code!==yr.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);for(const t of this.peers.keys())this.sendSubscriptions(t,[e],!0)}this.join(e)}unsubscribe(e){if(this.status.code!==yr.started)throw new Error("Pubsub is not started");const t=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,t),t)for(const n of this.peers.keys())this.sendSubscriptions(n,[e],!1);this.leave(e)}join(e){if(this.status.code!==yr.started)throw new Error("Gossipsub has not started");if(this.mesh.has(e))return;this.log("JOIN %s",e),this.metrics?.onJoin(e);const t=new Set,n=this.backoff.get(e),s=this.fanout.get(e);if(s!=null&&(this.fanout.delete(e),this.fanoutLastpub.delete(e),s.forEach(i=>{!this.direct.has(i)&&this.score.score(i)>=0&&n?.has(i)!==!0&&t.add(i)}),this.metrics?.onAddToMesh(e,Jn.Fanout,t.size)),t.size<this.opts.D){const i=t.size;this.getRandomGossipPeers(e,this.opts.D,a=>!t.has(a)&&!this.direct.has(a)&&this.score.score(a)>=0&&n?.has(a)!==!0).forEach(a=>{t.add(a)}),this.metrics?.onAddToMesh(e,Jn.Random,t.size-i)}this.mesh.set(e,t),t.forEach(i=>{this.log("JOIN: Add mesh link to %s in %s",i,e),this.sendGraft(i,e)})}leave(e){if(this.status.code!==yr.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),this.metrics?.onLeave(e);const t=this.mesh.get(e);t!=null&&(Promise.all(Array.from(t).map(async n=>{this.log("LEAVE: Remove mesh link to %s in %s",n,e),await this.sendPrune(n,e)})).catch(n=>{this.log("Error sending prunes to mesh peers",n)}),this.mesh.delete(e))}selectPeersToForward(e,t,n){const s=new Set,i=this.topics.get(e);i!=null&&(this.direct.forEach(a=>{i.has(a)&&t!==a&&!(n?.has(a)??!1)&&s.add(a)}),this.floodsubPeers.forEach(a=>{i.has(a)&&t!==a&&!(n?.has(a)??!1)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold&&s.add(a)}));const o=this.mesh.get(e);return o!=null&&o.size>0&&o.forEach(a=>{t!==a&&!(n?.has(a)??!1)&&s.add(a)}),s}selectPeersToPublish(e){const t=new Set,n={direct:0,floodsub:0,mesh:0,fanout:0},s=this.topics.get(e);if(s!=null)if(this.opts.floodPublish)s.forEach(i=>{this.direct.has(i)?(t.add(i),n.direct++):this.score.score(i)>=this.opts.scoreThresholds.publishThreshold&&(t.add(i),n.floodsub++)});else{this.direct.forEach(o=>{s.has(o)&&(t.add(o),n.direct++)}),this.floodsubPeers.forEach(o=>{s.has(o)&&this.score.score(o)>=this.opts.scoreThresholds.publishThreshold&&(t.add(o),n.floodsub++)});const i=this.mesh.get(e);if(i!=null&&i.size>0)i.forEach(o=>{t.add(o),n.mesh++}),i.size<this.opts.D&&this.getRandomGossipPeers(e,this.opts.D-i.size,a=>!i.has(a)&&!this.direct.has(a)&&!this.floodsubPeers.has(a)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold).forEach(a=>{t.add(a),n.mesh++});else{const o=this.fanout.get(e);if(o!=null&&o.size>0)o.forEach(a=>{t.add(a),n.fanout++});else{const a=this.getRandomGossipPeers(e,this.opts.D,c=>this.score.score(c)>=this.opts.scoreThresholds.publishThreshold);a.size>0&&(this.fanout.set(e,a),a.forEach(c=>{t.add(c),n.fanout++}))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:t,tosendCount:n}}forwardMessage(e,t,n,s){n!=null&&this.score.deliverMessage(n,e,t.topic);const i=this.selectPeersToForward(t.topic,n,s);i.forEach(o=>{this.sendRpc(o,Wr([t]))}),this.metrics?.onForwardMsg(t.topic,i.size)}async publish(e,t,n){const s=Date.now(),i=this.dataTransform!=null?this.dataTransform.outboundTransform(e,t):t;if(this.publishConfig==null)throw Error("PublishError.Uninitialized");const{raw:o,msg:a}=await kY(this.publishConfig,e,t,i),c=await this.msgIdFn(a),l=this.msgIdToStrFn(c),h=n?.ignoreDuplicatePublishError??this.opts.ignoreDuplicatePublishError;if(this.seenCache.has(l)){if(h)return this.metrics?.onPublishDuplicateMsg(e),{recipients:[]};throw Error("PublishError.Duplicate")}const{tosend:f,tosendCount:p}=this.selectPeersToPublish(e),m=this.opts.emitSelf&&this.subscriptions.has(e),_=n?.allowPublishToZeroTopicPeers??this.opts.allowPublishToZeroTopicPeers;if(f.size===0&&!_&&!m)throw Error("PublishError.NoPeersSubscribedToTopic");this.seenCache.put(l),this.mcache.put({msgId:c,msgIdStr:l},o,!0),this.gossipTracer.deliverMessage(l),this.publishedMessageIds.put(l);const R=n?.batchPublish??this.opts.batchPublish,T=Wr([o]);if(R)this.sendRpcInBatch(f,T);else for(const D of f)this.sendRpc(D,T)||f.delete(D);const A=Date.now()-s;return this.metrics?.onPublishMsg(e,p,f.size,o.data!=null?o.data.length:0,A),m&&(f.add(this.components.peerId.toString()),super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:this.components.peerId,msgId:l,msg:a}})),super.dispatchEvent(new CustomEvent("message",{detail:a}))),{recipients:Array.from(f.values()).map(D=>this.peers.get(D)??Vn(D))}}sendRpcInBatch(e,t){const n=ho.encode(t),s=Eu.single(n);for(const i of e){const o=this.streamsOutbound.get(i);if(o==null){this.log(`Cannot send RPC to ${i} as there is no open stream to it available`),e.delete(i);continue}try{o.pushPrefixed(s)}catch(a){e.delete(i),this.log.error(`Cannot send rpc to ${i}`,a)}this.metrics?.onRpcSent(t,n.length)}}reportMessageValidationResult(e,t,n){let s;if(n===_r.Accept){if(s=this.mcache.validate(e),s!=null){const{message:o,originatingPeers:a}=s;this.score.deliverMessage(t,e,o.topic),this.forwardMessage(e,s.message,t,a)}}else if(s=this.mcache.remove(e),s!=null){const o=$8(n),{message:a,originatingPeers:c}=s;this.score.rejectMessage(t,e,a.topic,o);for(const l of c)this.score.rejectMessage(l,e,a.topic,o)}const i=this.score.messageFirstSeenTimestampMs(e);this.metrics?.onReportValidation(s,n,i)}sendGraft(e,t){const s=Wr([],{graft:[{topicID:t}]});this.sendRpc(e,s)}async sendPrune(e,t){const s=[await this.makePrune(e,t,this.opts.doPX,!0)],i=Wr([],{prune:s});this.sendRpc(e,i)}sendIDontWants(e,t,n){const s=this.mesh.get(t);if(s==null)return;const i=new Set(s);i.delete(n);for(const a of i)this.streamsOutbound.get(a)?.protocol!==E2&&i.delete(a);const o=Wr([],{idontwant:[{messageIDs:[e]}]});this.sendRpcInBatch(i,o)}sendRpc(e,t){const n=this.streamsOutbound.get(e);if(n==null)return this.log(`Cannot send RPC to ${e} as there is no open stream to it available`),!1;const s=this.control.get(e);s!=null&&(this.piggybackControl(e,t,s),this.control.delete(e));const i=this.gossip.get(e);i!=null&&(this.piggybackGossip(e,t,i),this.gossip.delete(e));const o=ho.encode(t);try{n.push(o)}catch(a){return this.log.error(`Cannot send rpc to ${e}`,a),s!=null&&this.control.set(e,s),i!=null&&this.gossip.set(e,i),!1}if(this.metrics?.onRpcSent(t,o.length),t.control?.graft!=null)for(const a of t.control?.graft)a.topicID!=null&&this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:e,topic:a.topicID,direction:"outbound"}});if(t.control?.prune!=null)for(const a of t.control?.prune)a.topicID!=null&&this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:e,topic:a.topicID,direction:"outbound"}});return!0}piggybackControl(e,t,n){const s=U8(t);for(const i of n.graft)i.topicID!=null&&(this.mesh.get(i.topicID)?.has(e)??!1)&&s.control.graft.push(i);for(const i of n.prune)i.topicID!=null&&!(this.mesh.get(i.topicID)?.has(e)??!1)&&s.control.prune.push(i)}piggybackGossip(e,t,n){const s=U8(t);s.control.ihave=n}async sendGraftPrune(e,t,n){const s=this.opts.doPX,i=!1;for(const[o,a]of e){const c=a.map(f=>({topicID:f}));let l=[];const h=t.get(o);h!=null&&(l=await Promise.all(h.map(async f=>this.makePrune(o,f,s&&!(n.get(o)??!1),i))),t.delete(o)),this.sendRpc(o,Wr([],{graft:c,prune:l}))}for(const[o,a]of t){const c=await Promise.all(a.map(async l=>this.makePrune(o,l,s&&!(n.get(o)??!1),i)));this.sendRpc(o,Wr([],{prune:c}))}}emitGossip(e){const t=this.mcache.getGossipIDs(new Set(e.keys()));for(const[n,s]of e)this.doEmitGossip(n,s,t.get(n)??[])}doEmitGossip(e,t,n){if(n.length===0||(vs(n),n.length>pa&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",n.length),t.size===0))return;let s=this.opts.Dlazy;const o=this.opts.gossipFactor*t.size;let a=t;o>s&&(s=o),s>a.size?s=a.size:a=vs(Array.from(a)).slice(0,s),a.forEach(c=>{let l=n;n.length>pa&&(l=vs(l.slice()).slice(0,pa)),this.pushGossip(c,{topicID:e,messageIDs:l})})}flush(){for(const[e,t]of this.gossip.entries())this.gossip.delete(e),this.sendRpc(e,Wr([],{ihave:t}));for(const[e,t]of this.control.entries()){this.control.delete(e);const n=Wr([],{graft:t.graft,prune:t.prune});this.sendRpc(e,n)}}pushGossip(e,t){this.log("Add gossip to %s",e);const n=this.gossip.get(e)??[];this.gossip.set(e,n.concat(t))}async makePrune(e,t,n,s){if(this.score.prune(e,t),this.streamsOutbound.get(e)?.protocol===B8)return{topicID:t,peers:[]};const i=s?this.opts.unsubcribeBackoff:this.opts.pruneBackoff,o=i/1e3;if(this.doAddBackoff(e,t,i),!n)return{topicID:t,peers:[],backoff:o};const a=this.getRandomGossipPeers(t,this.opts.prunePeers,l=>l!==e&&this.score.score(l)>=0),c=await Promise.all(Array.from(a).map(async l=>{const h=this.peers.get(l)??Vn(l);let f;try{f=await this.components.peerStore.get(h)}catch(p){if(p.name!=="NotFoundError")throw p}return{peerID:h.toMultihash().bytes,signedPeerRecord:f?.peerRecordEnvelope}}));return{topicID:t,peers:c,backoff:o}}runHeartbeat=()=>{const e=this.metrics?.heartbeatDuration.startTimer();this.heartbeat().catch(t=>{this.log("Error running heartbeat",t)}).finally(()=>{if(e?.(),this.status.code===yr.started){clearTimeout(this.status.heartbeatTimeout);let t=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;t<this.opts.heartbeatInterval*.25&&(t+=this.opts.heartbeatInterval,this.metrics?.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,t)}})};async heartbeat(){const{D:e,Dlo:t,Dhi:n,Dscore:s,Dout:i,fanoutTTL:o}=this.opts;this.heartbeatTicks++;const a=new Map,c=_=>{let R=a.get(_);return R===void 0&&(R=this.score.score(_),a.set(_,R)),R},l=new Map,h=new Map,f=new Map;this.clearBackoff(),this.peerhave.clear(),this.metrics?.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.idontwantCounts.clear();for(const _ of this.idontwants.values())for(const[R,T]of _)this.heartbeatTicks-T>=this.opts.mcacheLength&&_.delete(R);this.heartbeatTicks%this.opts.directConnectTicks===0&&await this.directConnect(),this.fastMsgIdCache?.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();const p=new Map;this.mesh.forEach((_,R)=>{const T=this.topics.get(R),A=new Set,D=new Set;if(p.set(R,D),T!=null){const L=vs(Array.from(T)),z=this.backoff.get(R);for(const Y of L){const k=this.streamsOutbound.get(Y);if(k!=null&&this.multicodecs.includes(k.protocol)&&!_.has(Y)&&!this.direct.has(Y)){const x=c(Y);z?.has(Y)!==!0&&x>=0&&A.add(Y),x>=this.opts.scoreThresholds.gossipThreshold&&D.add(Y)}}}const I=(L,z)=>{this.log("HEARTBEAT: Remove mesh link to %s in %s",L,R),this.addBackoff(L,R),_.delete(L),c(L)>=this.opts.scoreThresholds.gossipThreshold&&D.add(L),this.metrics?.onRemoveFromMesh(R,z,1);const Y=h.get(L);Y==null?h.set(L,[R]):Y.push(R)},q=(L,z)=>{this.log("HEARTBEAT: Add mesh link to %s in %s",L,R),this.score.graft(L,R),_.add(L),D.delete(L),this.metrics?.onAddToMesh(R,z,1);const Y=l.get(L);Y==null?l.set(L,[R]):Y.push(R)};if(_.forEach(L=>{const z=c(L);z<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",L,z,R),I(L,ns.BadScore),f.set(L,!0))}),_.size<t){const L=e-_.size;gY(A,L).forEach(Y=>{q(Y,Jn.NotEnough)})}if(_.size>n){let L=Array.from(_);L.sort((Y,k)=>c(k)-c(Y)),L=L.slice(0,s).concat(vs(L.slice(s)));let z=0;if(L.slice(0,e).forEach(Y=>{(this.outbound.get(Y)??!1)&&z++}),z<i){const Y=x=>{const F=L[x];for(let j=x;j>0;j--)L[j]=L[j-1];L[0]=F};if(z>0){let x=z;for(let F=1;F<e&&x>0;F++)(this.outbound.get(L[F])??!1)&&(Y(F),x--)}let k=e-z;for(let x=e;x<L.length&&k>0;x++)(this.outbound.get(L[x])??!1)&&(Y(x),k--)}L.slice(e).forEach(Y=>{I(Y,ns.Excess)})}if(_.size>=t){let L=0;if(_.forEach(z=>{(this.outbound.get(z)??!1)&&L++}),L<i){const z=i-L;lp(A,z,k=>this.outbound.get(k)===!0).forEach(k=>{q(k,Jn.Outbound)})}}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks===0&&_.size>1){const L=Array.from(_).sort((k,x)=>c(k)-c(x)),z=Math.floor(_.size/2),Y=c(L[z]);if(Y<this.opts.scoreThresholds.opportunisticGraftThreshold){const k=this.opts.opportunisticGraftPeers,x=lp(A,k,F=>c(F)>Y);for(const F of x)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",F,R),q(F,Jn.Opportunistic)}}});const m=Date.now();this.fanoutLastpub.forEach((_,R)=>{_+o<m&&(this.fanout.delete(R),this.fanoutLastpub.delete(R))}),this.fanout.forEach((_,R)=>{const T=this.topics.get(R);_.forEach(q=>{(!(T?.has(q)??!1)||c(q)<this.opts.scoreThresholds.publishThreshold)&&_.delete(q)});const A=this.topics.get(R),D=[],I=new Set;if(p.set(R,I),A!=null){const q=vs(Array.from(A));for(const L of q){const z=this.streamsOutbound.get(L);if(z!=null&&this.multicodecs.includes(z.protocol)&&!_.has(L)&&!this.direct.has(L)){const Y=c(L);Y>=this.opts.scoreThresholds.publishThreshold&&D.push(L),Y>=this.opts.scoreThresholds.gossipThreshold&&I.add(L)}}}if(_.size<e){const q=e-_.size;D.slice(0,q).forEach(L=>{_.add(L),I?.delete(L)})}}),this.emitGossip(p),await this.sendGraftPrune(l,h,f),this.flush(),this.mcache.shift(),this.dispatchEvent(new CustomEvent("gossipsub:heartbeat"))}getRandomGossipPeers(e,t,n=()=>!0){const s=this.topics.get(e);if(s==null)return new Set;let i=[];return s.forEach(o=>{const a=this.streamsOutbound.get(o);a!=null&&this.multicodecs.includes(a.protocol)&&n(o)&&i.push(o)}),i=vs(i),t>0&&i.length>t&&(i=i.slice(0,t)),new Set(i)}onScrapeMetrics(e){e.mcacheSize.set(this.mcache.size),e.mcacheNotValidatedCount.set(this.mcache.notValidatedCount),e.cacheSize.set({cache:"direct"},this.direct.size),e.cacheSize.set({cache:"seenCache"},this.seenCache.size),e.cacheSize.set({cache:"fastMsgIdCache"},this.fastMsgIdCache?.size??0),e.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),e.cacheSize.set({cache:"mcache"},this.mcache.size),e.cacheSize.set({cache:"score"},this.score.size),e.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),e.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),e.cacheSize.set({cache:"topics"},this.topics.size),e.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),e.cacheSize.set({cache:"mesh"},this.mesh.size),e.cacheSize.set({cache:"fanout"},this.fanout.size),e.cacheSize.set({cache:"peers"},this.peers.size),e.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),e.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),e.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),e.cacheSize.set({cache:"gossip"},this.gossip.size),e.cacheSize.set({cache:"control"},this.control.size),e.cacheSize.set({cache:"peerhave"},this.peerhave.size),e.cacheSize.set({cache:"outbound"},this.outbound.size);let t=0;const n=Date.now();e.connectedPeersBackoffSec.reset();for(const c of this.backoff.values()){t+=c.size;for(const[l,h]of c.entries())this.peers.has(l)&&e.connectedPeersBackoffSec.observe(Math.max(0,h-n)/1e3)}e.cacheSize.set({cache:"backoff"},t);let s=0;for(const c of this.idontwants.values())s+=c.size;e.cacheSize.set({cache:"idontwants"},s);for(const[c,l]of this.topics)e.topicPeersCount.set({topicStr:c},l.size);for(const[c,l]of this.mesh)e.meshPeerCounts.set({topicStr:c},l.size);const i=[],o=new Map;e.behaviourPenalty.reset();for(const c of this.peers.keys()){const l=this.score.score(c);i.push(l),o.set(c,l),e.behaviourPenalty.observe(this.score.peerStats.get(c)?.behaviourPenalty??0)}e.registerScores(i,this.opts.scoreThresholds),e.registerScorePerMesh(this.mesh,o);const a=SY(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,e.topicStrToLabel);e.registerScoreWeights(a)}tagMeshPeer=e=>{const{peerId:t,topic:n}=e.detail;this.components.peerStore.merge(this.peers.get(t)??Vn(t),{tags:{[n]:{value:100}}}).catch(s=>{this.log.error("Error tagging peer %s with topic %s",t,n,s)})};untagMeshPeer=e=>{const{peerId:t,topic:n}=e.detail;this.components.peerStore.merge(this.peers.get(t)??Vn(t),{tags:{[n]:void 0}}).catch(s=>{this.log.error("Error untagging peer %s with topic %s",t,n,s)})}}function cv(r={}){return e=>new $Y(e,r)}const H8={connectionEncrypters:[UW()],streamMuxers:[cG()],services:{pubsub:cv(),ping:tN(),dht:iV(),identify:uj(),autoNAT:DN(),dcutr:BN()}};function MY(r){return{addresses:{listen:["/p2p-circuit"]},transports:[Sw(),UV()],peerDiscovery:[vj({list:[r]})]}}function NY(r){return{addresses:{listen:["/ip4/0.0.0.0/tcp/4001","/ip4/0.0.0.0/tcp/4002/ws"],announce:[`/dns4/${r}/tcp/4001`,`/dns4/${r}/tcp/443/wss`]},transports:[aV(),Sw()],services:{relay:TV({reservations:{applyDefaultLimit:!1}}),pubsub:cv({doPX:!0})}}}async function V8(r,e){const t=r.mode==="CLIENT"?MY(r.relayAddr??""):NY(r.publicDns??"");return{...H8,...t,services:{...H8.services,...t.services},privateKey:e,start:!1}}class UY{stream;messagePusher;constructor(e){this.stream=e,this.setupPipe()}setupPipe(){this.messagePusher=Or(),Ar(this.messagePusher,e=>Eu(e),this.stream.sink)}sendMessage(e){const t=JSON.stringify(e);this.messagePusher.push(Ge(t))}close(){this.messagePusher.end()}}let dp;const lv=new bw.EventEmitter;function FY(r){dp=r}function Ns(){if(!dp)throw new Error("Database not initialized. Call init() first.");return dp}async function HY(){await Ns().run(`
    CREATE TABLE IF NOT EXISTS profiles (
      id TEXT PRIMARY KEY,
      name TEXT,
      avatar TEXT
    );

    CREATE TABLE IF NOT EXISTS chats (
      id TEXT PRIMARY KEY,
      name TEXT,
      avatar TEXT,
      type TEXT NOT NULL CHECK(type IN ('private', 'group'))
    );

    CREATE TABLE IF NOT EXISTS messages (
      uuid TEXT PRIMARY KEY,
      chat_id TEXT NOT NULL,
      from_id TEXT,
      content TEXT NOT NULL
    );

    CREATE TABLE IF NOT EXISTS group_members (
      chat_id TEXT NOT NULL,
      profile_id TEXT
    )
  `)}async function VY(){const r=Ns();["profiles","chats","messages","group_members"].forEach(t=>{r.run(`DROP TABLE IF EXISTS ${t};`)}),r.run("VACUUM;")}async function KY(r){const e=Ns();return r.type==="group"?await e.run("INSERT INTO chats (id, name, avatar, type) VALUES (?, ?, ?, ?) ON CONFLICT(id) DO UPDATE SET name = excluded.name, avatar = excluded.avatar",[r.id,r.name,r.avatar,r.type]):await e.run("INSERT INTO chats (id, type) VALUES (?, ?)",[r.id,r.type])}async function K8(r){const e=Ns(),t=await zY(r),n=WY(t);try{await e.run("INSERT INTO chats (id, type) VALUES (?, ?)",[t,n]);const s={id:t,type:n};lv.emit("chat:spawn",s)}catch{}await e.run("INSERT INTO messages (uuid, chat_id, from_id, content) VALUES (?, ?, ?, ?)",[r.uuid,t,r.from,r.content])}async function zY(r){if(r.chatId.includes("group-"))return r.chatId;const e=await ZY();return r.chatId===e?r.from:r.chatId}function WY(r){return r.includes("group-")?"group":"private"}async function dl(){const e=await Ns().get("SELECT id, name, avatar FROM profiles LIMIT 1");if(!e||e.id==="")throw new Error("Profile not found in the database.");return e}async function z8(r,e,t){await Ns().run("INSERT OR REPLACE INTO profiles (id, name, avatar) VALUES (?, ?, ?) ON CONFLICT(id) DO UPDATE SET name = excluded.name, avatar = excluded.avatar",[r,e,t])}async function GY(r,e){const t=Ns(),n=20,s=(Math.max(1,e)-1)*n;return t.all("SELECT uuid, content, from_id as 'from', chat_id as 'chat' FROM messages WHERE chat_id = ? ORDER BY uuid DESC LIMIT ? OFFSET ?",[r,n,s])}async function W8(){return Ns().all("SELECT id, name, avatar, type FROM chats ORDER BY id")}async function ZY(){return(await dl()).id}const uv=typeof self<"u",hp=(r,e)=>e.some(t=>r instanceof t);let G8,Z8;function jY(){return G8||(G8=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function YY(){return Z8||(Z8=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const pp=new WeakMap,S2=new WeakMap,p1=new WeakMap;function QY(r){const e=new Promise((t,n)=>{const s=()=>{r.removeEventListener("success",i),r.removeEventListener("error",o)},i=()=>{t(po(r.result)),s()},o=()=>{n(r.error),s()};r.addEventListener("success",i),r.addEventListener("error",o)});return p1.set(e,r),e}function XY(r){if(pp.has(r))return;const e=new Promise((t,n)=>{const s=()=>{r.removeEventListener("complete",i),r.removeEventListener("error",o),r.removeEventListener("abort",o)},i=()=>{t(),s()},o=()=>{n(r.error||new DOMException("AbortError","AbortError")),s()};r.addEventListener("complete",i),r.addEventListener("error",o),r.addEventListener("abort",o)});pp.set(r,e)}let gp={get(r,e,t){if(r instanceof IDBTransaction){if(e==="done")return pp.get(r);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return po(r[e])},set(r,e,t){return r[e]=t,!0},has(r,e){return r instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in r}};function fv(r){gp=r(gp)}function JY(r){return YY().includes(r)?function(...e){return r.apply(mp(this),e),po(this.request)}:function(...e){return po(r.apply(mp(this),e))}}function eQ(r){return typeof r=="function"?JY(r):(r instanceof IDBTransaction&&XY(r),hp(r,jY())?new Proxy(r,gp):r)}function po(r){if(r instanceof IDBRequest)return QY(r);if(S2.has(r))return S2.get(r);const e=eQ(r);return e!==r&&(S2.set(r,e),p1.set(e,r)),e}const mp=r=>p1.get(r);function tQ(r,e,{blocked:t,upgrade:n,blocking:s,terminated:i}={}){const o=indexedDB.open(r,e),a=po(o);return n&&o.addEventListener("upgradeneeded",c=>{n(po(o.result),c.oldVersion,c.newVersion,po(o.transaction),c)}),t&&o.addEventListener("blocked",c=>t(c.oldVersion,c.newVersion,c)),a.then(c=>{i&&c.addEventListener("close",()=>i()),s&&c.addEventListener("versionchange",l=>s(l.oldVersion,l.newVersion,l))}).catch(()=>{}),a}const nQ=["get","getKey","getAll","getAllKeys","count"],rQ=["put","add","delete","clear"],A2=new Map;function j8(r,e){if(!(r instanceof IDBDatabase&&!(e in r)&&typeof e=="string"))return;if(A2.get(e))return A2.get(e);const t=e.replace(/FromIndex$/,""),n=e!==t,s=rQ.includes(t);if(!(t in(n?IDBIndex:IDBObjectStore).prototype)||!(s||nQ.includes(t)))return;const i=async function(o,...a){const c=this.transaction(o,s?"readwrite":"readonly");let l=c.store;return n&&(l=l.index(a.shift())),(await Promise.all([l[t](...a),s&&c.done]))[0]};return A2.set(e,i),i}fv(r=>({...r,get:(e,t,n)=>j8(e,t)||r.get(e,t,n),has:(e,t)=>!!j8(e,t)||r.has(e,t)}));const sQ=["continue","continuePrimaryKey","advance"],Y8={},yp=new WeakMap,dv=new WeakMap,iQ={get(r,e){if(!sQ.includes(e))return r[e];let t=Y8[e];return t||(t=Y8[e]=function(...n){yp.set(this,dv.get(this)[e](...n))}),t}};async function*oQ(...r){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...r)),!e)return;e=e;const t=new Proxy(e,iQ);for(dv.set(t,e),p1.set(t,mp(e));e;)yield t,e=await(yp.get(t)||e.continue()),yp.delete(t)}function Q8(r,e){return e===Symbol.asyncIterator&&hp(r,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&hp(r,[IDBIndex,IDBObjectStore])}fv(r=>({...r,get(e,t,n){return Q8(e,t)?oQ:r.get(e,t,n)},has(e,t){return Q8(e,t)||r.has(e,t)}}));let gh;if(uv){const r=tQ("key-storage",1,{upgrade(e){e.createObjectStore("keys")}});gh={async get(e){return(await r).get("keys",e)},async put(e,t){await(await r).put("keys",t,e)},async clear(){await(await r).clear("keys")}}}else{const r=await import("./__vite-browser-external-9wXp6ZBx.js"),e=await import("./__vite-browser-external-9wXp6ZBx.js"),n=(await import("./__vite-browser-external-9wXp6ZBx.js")).homedir(),s=e.join(n,".basilisk","keys.json");async function i(){try{await r.mkdir(e.dirname(s),{recursive:!0});const a=await r.readFile(s,"utf-8");return JSON.parse(a)}catch{return{}}}async function o(a){await r.mkdir(e.dirname(s),{recursive:!0}),await r.writeFile(s,JSON.stringify(a,null,2))}gh={async get(a){return(await i())[a]},async put(a,c){const l=await i();l[a]=c,await o(l)},async clear(){await o({})}}}async function X8(){let r=await gh.get("appKeySeed");return r||(console.debug("Generating new seed..."),uv?r=crypto.getRandomValues(new Uint8Array(32)):r=(await import("./__vite-browser-external-9wXp6ZBx.js")).randomBytes(32),await gh.put("appKeySeed",r)),typeof r=="object"&&"data"in r&&(r=Uint8Array.from(r.data)),await Hz("Ed25519",r)}const Dr=new bw.EventEmitter;let Ni;class mh{node;chatListeners=new Set;constructor(e){this.node=e,this.node.services.pubsub.addEventListener("message",t=>{const n=JSON.parse(new TextDecoder().decode(t.detail.data));Dr.emit("message:receive",n)}),Ni&&(this.node.addEventListener("peer:connect",t=>{t.detail.toString()===yf(Ni)?Dr.emit("relay:connect"):this.chatListeners.has(t.detail.toString())&&Dr.emit("peer:connect",t.detail.toString())}),this.node.addEventListener("peer:disconnect",t=>{t.detail.toString()===yf(Ni)?Dr.emit("relay:disconnect"):this.chatListeners.has(t.detail.toString())&&Dr.emit("peer:disconnect",t.detail.toString())}))}static async init(e){if(e.mode==="RELAY"){console.debug("Initializing relay node...");const i=await X8(),o=await $4(await V8(e,i)),a=new mh(o);return await o.start(),console.debug("Relay node initialized."),a}console.debug("[libp2p] Initializing libp2p node"),Ni=e.relayAddr??"";const t=await X8(),n=await $4(await V8(e,t)),s=new mh(n);return await n.handle("/chat/1.0.0",async({stream:i,connection:o})=>{await s.retrieveMessageFromStream(i,yf(o.remoteAddr.toString()))}),await n.handle("/info/1.0.0",async({stream:i,connection:o})=>{await s.sendInfoToStream(i,yf(o.remoteAddr.toString()))}),s}async start(){console.debug("[libp2p] Starting node..."),await this.node.start()}async stop(){console.debug("[libp2p] Stopping node..."),await this.node.stop()}async addPeerListener(e){this.chatListeners.add(e)}getMultiaddrs(){return this.node.getMultiaddrs()}async pingRelay(){try{return await this.node.services.ping.ping(lt(Ni))}catch(e){throw new Error("Error when pinging relay server",e)}}getPeerId(){return this.node.peerId.toString()}subscribe(e){this.node.services.pubsub.subscribe(e)}async createChatConn(e){try{const t=U4(Ni,e),n=await this.node.dialProtocol(t,"/chat/1.0.0");return new UY(n)}catch(t){return console.warn("[libp2p] Failed to create chat connection: "+t.message),null}}async getPeerProfile(e){const t=U4(Ni,e),n=await this.node.dialProtocol(t,"/info/1.0.0");return await Ar(n.source,i=>$l(i),i=>to(i,o=>Le(o.subarray())),async function(i){for await(const o of i)return JSON.parse(o);throw new Error("[libp2p] Stream ended without a response")})}async sendMessage(e){if(e.chatId.includes("group-"))this.node.services.pubsub.publish(e.chatId,new TextEncoder().encode(JSON.stringify(e)));else{const t=await this.createChatConn(e.chatId);if(!t)throw new Error(`Failed to create chat connection for ${e.chatId}`);t.sendMessage(e),t.close()}console.debug(`[libp2p] Message sent to ${e.chatId}`)}async retrieveMessageFromStream(e,t){try{await Ar(e.source,n=>$l(n),n=>to(n,s=>Le(s.subarray())),n=>to(n,s=>JSON.parse(s)),n=>to(n,s=>{s.from!==t?console.warn("[libp2p] Message does not match specified sender",{messageSenderId:s.from,streamSenderId:t}):Dr.emit("message:receive",s)}),Ja)}catch(n){console.warn(`[libp2p] Error processing stream from ${t}: ${n.message}`)}finally{e.close()}}async sendInfoToStream(e,t){try{const n=await dl();await Ar([Ge(JSON.stringify(n))],s=>Eu(s),e.sink),console.debug(`[libp2p] Profile sent to ${t}: ${JSON.stringify(n)}`)}catch(n){console.warn(`[libp2p] Error sending profile to ${t}: ${n.message}`)}finally{e.close()}}}const _n=[];for(let r=0;r<256;++r)_n.push((r+256).toString(16).slice(1));function aQ(r,e=0){return(_n[r[e+0]]+_n[r[e+1]]+_n[r[e+2]]+_n[r[e+3]]+"-"+_n[r[e+4]]+_n[r[e+5]]+"-"+_n[r[e+6]]+_n[r[e+7]]+"-"+_n[r[e+8]]+_n[r[e+9]]+"-"+_n[r[e+10]]+_n[r[e+11]]+_n[r[e+12]]+_n[r[e+13]]+_n[r[e+14]]+_n[r[e+15]]).toLowerCase()}let I2;const cQ=new Uint8Array(16);function lQ(){if(!I2){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");I2=crypto.getRandomValues.bind(crypto)}return I2(cQ)}const T2={};function Ui(r,e,t){let n;{const s=Date.now(),i=lQ();uQ(T2,s,i),n=fQ(i,T2.msecs,T2.seq,e,t)}return e??aQ(n)}function uQ(r,e,t){return r.msecs??=-1/0,r.seq??=0,e>r.msecs?(r.seq=t[6]<<23|t[7]<<16|t[8]<<8|t[9],r.msecs=e):(r.seq=r.seq+1|0,r.seq===0&&r.msecs++),r}function fQ(r,e,t,n,s=0){if(r.length<16)throw new Error("Random bytes length must be >= 16");if(!n)n=new Uint8Array(16),s=0;else if(s<0||s+16>n.length)throw new RangeError(`UUID byte range ${s}:${s+15} is out of buffer bounds`);return e??=Date.now(),t??=r[6]*127<<24|r[7]<<16|r[8]<<8|r[9],n[s++]=e/1099511627776&255,n[s++]=e/4294967296&255,n[s++]=e/16777216&255,n[s++]=e/65536&255,n[s++]=e/256&255,n[s++]=e&255,n[s++]=112|t>>>28&15,n[s++]=t>>>20&255,n[s++]=128|t>>>14&63,n[s++]=t>>>6&255,n[s++]=t<<2&255|r[10]&3,n[s++]=r[11],n[s++]=r[12],n[s++]=r[13],n[s++]=r[14],n[s++]=r[15],n}class fm{node;uiCallBack;constructor(e,t,n){this.node=e,this.uiCallBack=n,FY(t),HY(),Dr.on("message:receive",async s=>{await K8(s),this.uiCallBack({type:"message-received",payload:{message:s},id:Ui()})}),Dr.on("relay:connect",()=>{this.uiCallBack({type:"relay-found",id:Ui()})}),Dr.on("relay:disconnect",()=>{this.uiCallBack({type:"relay-lost",id:Ui()})}),Dr.on("peer:connect",s=>{this.uiCallBack({type:"peer-found",payload:{peerId:s},id:Ui()})}),Dr.on("peer:disconnect",s=>{this.uiCallBack({type:"peer-lost",payload:{peerId:s},id:Ui()})}),lv.on("chat:spawn",async s=>{this.uiCallBack({type:"chat-spawned",payload:{chat:s},id:Ui()})})}static async init(e,t,n){const s=await mh.init({mode:"CLIENT",relayAddr:n});return new fm(s,e,t)}async startNode(){await this.node.start(),await z8(this.node.getPeerId()),(await W8()).filter(e=>e.type==="group").map(e=>e.id).forEach(e=>this.node.subscribe(e)),this.uiCallBack({type:"node-started",payload:{profile:await dl()},id:Ui()})}async handleUiCommand(e){switch(e.type){case"ping-relay":{try{const t=await this.node.pingRelay();this.uiCallBack({type:"pong-relay",payload:{latency:t},id:e.id})}catch(t){this.uiCallBack({type:"pong-relay",id:e.id,error:t.toString()})}break}case"send-message":{try{await this.sendMessage(e.payload.message),this.uiCallBack({type:"message-sent",id:e.id})}catch(t){this.uiCallBack({type:"message-sent",id:e.id,error:t.toString()})}break}case"get-profile-user":{const t=await dl();this.uiCallBack({type:"profile-retrieved-user",payload:{profile:t},id:e.id});break}case"patch-profile-self":{await z8(this.node.getPeerId(),e.payload.name,e.payload.avatar),this.uiCallBack({type:"profile-updated-self",payload:{profile:await dl()},id:e.id});break}case"get-profile":{try{const t=await this.getProfile(e.payload.peerId);this.uiCallBack({type:"profile-retrieved",payload:{profile:t},id:e.id})}catch(t){this.uiCallBack({type:"profile-retrieved",id:e.id,error:t.toString()})}break}case"get-messages":{const t=await this.getMessages(e.payload.chatId,e.payload.page);this.uiCallBack({type:"messages-retrieved",payload:{messages:t},id:e.id});break}case"get-chats":{this.uiCallBack({type:"chats-retrieved",payload:{chats:await W8()},id:e.id});break}case"create-chat":{await this.createChat(e.payload.chat),this.uiCallBack({type:"chat-created",payload:{chat:e.payload.chat},id:e.id});break}case"close-database":{await Ns().close(),this.uiCallBack({type:"database-closed",id:e.id});break}case"wipe-database":{await VY(),this.uiCallBack({type:"database-wiped",id:e.id});break}case"subscribe-to-peer":{await this.subscribeToPeer(e.payload.peerId),this.uiCallBack({type:"subscribed-to-peer",id:e.id});break}}}async sendMessage(e){await this.node.sendMessage(e),await K8(e)}async getMessages(e,t){return await GY(e,t)}async getProfile(e){return await this.node.getPeerProfile(e)}async createChat(e){await KY(e),e.type==="group"&&this.node.subscribe(e.id)}async subscribeToPeer(e){await this.node.addPeerListener(e)}}var dm=(()=>{var r=import.meta.url;return function(e={}){var t,n=e,s,i,o=new Promise((u,d)=>{s=u,i=d}),a=typeof window=="object",c=typeof importScripts=="function";typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"&&process.type!="renderer";const l=globalThis.sqlite3InitModuleState||Object.assign(Object.create(null),{debugModule:()=>{}});delete globalThis.sqlite3InitModuleState,l.debugModule("globalThis.location =",globalThis.location);var h=Object.assign({},n),f="./this.program",p="";function m(u){return n.locateFile?n.locateFile(u,p):p+u}var _,R;(a||c)&&(c?p=self.location.href:typeof document<"u"&&document.currentScript&&(p=document.currentScript.src),r&&(p=r),p.startsWith("blob:")?p="":p=p.substr(0,p.replace(/[?#].*/,"").lastIndexOf("/")+1),c&&(R=u=>{var d=new XMLHttpRequest;return d.open("GET",u,!1),d.responseType="arraybuffer",d.send(null),new Uint8Array(d.response)}),_=u=>fetch(u,{credentials:"same-origin"}).then(d=>d.ok?d.arrayBuffer():Promise.reject(new Error(d.status+" : "+d.url))));var T=n.print||console.log.bind(console),A=n.printErr||console.error.bind(console);Object.assign(n,h),h=null,n.arguments&&n.arguments,n.thisProgram&&(f=n.thisProgram);var D=n.wasmBinary,I,q=!1,L,z,Y,k,x,F;function j(){var u=I.buffer;n.HEAP8=L=new Int8Array(u),n.HEAP16=Y=new Int16Array(u),n.HEAPU8=z=new Uint8Array(u),n.HEAPU16=new Uint16Array(u),n.HEAP32=k=new Int32Array(u),n.HEAPU32=x=new Uint32Array(u),n.HEAPF32=new Float32Array(u),n.HEAPF64=new Float64Array(u),n.HEAP64=F=new BigInt64Array(u),n.HEAPU64=new BigUint64Array(u)}if(n.wasmMemory)I=n.wasmMemory;else{var U=n.INITIAL_MEMORY||16777216;I=new WebAssembly.Memory({initial:U/65536,maximum:32768})}j();var y=[],b=[],g=[];function C(){var u=n.preRun;u&&(typeof u=="function"&&(u=[u]),u.forEach(O)),g1(y)}function B(){!n.noFSInit&&!H.initialized&&H.init(),H.ignorePermissions=!1,g1(b)}function M(){var u=n.postRun;u&&(typeof u=="function"&&(u=[u]),u.forEach(V)),g1(g)}function O(u){y.unshift(u)}function $(u){b.unshift(u)}function V(u){g.unshift(u)}var G=0,de=null;function ce(u){return u}function re(u){G++,n.monitorRunDependencies?.(G)}function pe(u){if(G--,n.monitorRunDependencies?.(G),G==0&&de){var d=de;de=null,d()}}function _e(u){n.onAbort?.(u),u="Aborted("+u+")",A(u),q=!0,u+=". Build with -sASSERTIONS for more info.";var d=new WebAssembly.RuntimeError(u);throw i(d),d}var $e="data:application/octet-stream;base64,",ge=u=>u.startsWith($e);function ke(){if(n.locateFile){var u="sqlite3.wasm";return ge(u)?u:m(u)}return new URL(""+new URL("sqlite3-DBpDb1lf.wasm",import.meta.url).href,import.meta.url).href}var ht;function qt(u){if(u==ht&&D)return new Uint8Array(D);if(R)return R(u);throw"both async and sync fetching of the wasm failed"}function $t(u){return D?Promise.resolve().then(()=>qt(u)):_(u).then(d=>new Uint8Array(d),()=>qt(u))}function xc(u,d,w){return $t(u).then(E=>WebAssembly.instantiate(E,d)).then(w,E=>{A(`failed to asynchronously prepare wasm: ${E}`),_e(E)})}function Lu(u,d,w,E){return!u&&typeof WebAssembly.instantiateStreaming=="function"&&!ge(d)&&typeof fetch=="function"?fetch(d,{credentials:"same-origin"}).then(S=>{var P=WebAssembly.instantiateStreaming(S,w);return P.then(E,function(J){return A(`wasm streaming compile failed: ${J}`),A("falling back to ArrayBuffer instantiation"),xc(d,w,E)})}):xc(d,w,E)}function hv(){return{env:_m,wasi_snapshot_preview1:_m}}function pv(){var u=hv();function d(E,S){return ee=E.exports,$(ee.__wasm_call_ctors),pe(),ee}re();function w(E){d(E.instance)}if(n.instantiateWasm)try{return n.instantiateWasm(u,d)}catch(E){A(`Module.instantiateWasm callback failed with error: ${E}`),i(E)}return ht??=ke(),Lu(D,ht,u,w).catch(i),{}}var g1=u=>{u.forEach(d=>d(n))};n.noExitRuntime;var Ct={isAbs:u=>u.charAt(0)==="/",splitPath:u=>{var d=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/;return d.exec(u).slice(1)},normalizeArray:(u,d)=>{for(var w=0,E=u.length-1;E>=0;E--){var S=u[E];S==="."?u.splice(E,1):S===".."?(u.splice(E,1),w++):w&&(u.splice(E,1),w--)}if(d)for(;w;w--)u.unshift("..");return u},normalize:u=>{var d=Ct.isAbs(u),w=u.substr(-1)==="/";return u=Ct.normalizeArray(u.split("/").filter(E=>!!E),!d).join("/"),!u&&!d&&(u="."),u&&w&&(u+="/"),(d?"/":"")+u},dirname:u=>{var d=Ct.splitPath(u),w=d[0],E=d[1];return!w&&!E?".":(E&&(E=E.substr(0,E.length-1)),w+E)},basename:u=>{if(u==="/")return"/";u=Ct.normalize(u),u=u.replace(/\/$/,"");var d=u.lastIndexOf("/");return d===-1?u:u.substr(d+1)},join:(...u)=>Ct.normalize(u.join("/")),join2:(u,d)=>Ct.normalize(u+"/"+d)},gv=()=>{if(typeof crypto=="object"&&typeof crypto.getRandomValues=="function")return u=>crypto.getRandomValues(u);_e("initRandomDevice")},pm=u=>(pm=gv())(u),as={resolve:(...u)=>{for(var d="",w=!1,E=u.length-1;E>=-1&&!w;E--){var S=E>=0?u[E]:H.cwd();if(typeof S!="string")throw new TypeError("Arguments to path.resolve must be strings");if(!S)return"";d=S+"/"+d,w=Ct.isAbs(S)}return d=Ct.normalizeArray(d.split("/").filter(P=>!!P),!w).join("/"),(w?"/":"")+d||"."},relative:(u,d)=>{u=as.resolve(u).substr(1),d=as.resolve(d).substr(1);function w(Ie){for(var qe=0;qe<Ie.length&&Ie[qe]==="";qe++);for(var Oe=Ie.length-1;Oe>=0&&Ie[Oe]==="";Oe--);return qe>Oe?[]:Ie.slice(qe,Oe-qe+1)}for(var E=w(u.split("/")),S=w(d.split("/")),P=Math.min(E.length,S.length),J=P,ne=0;ne<P;ne++)if(E[ne]!==S[ne]){J=ne;break}for(var Ee=[],ne=J;ne<E.length;ne++)Ee.push("..");return Ee=Ee.concat(S.slice(J)),Ee.join("/")}},gm=typeof TextDecoder<"u"?new TextDecoder:void 0,Ko=(u,d=0,w=NaN)=>{for(var E=d+w,S=d;u[S]&&!(S>=E);)++S;if(S-d>16&&u.buffer&&gm)return gm.decode(u.subarray(d,S));for(var P="";d<S;){var J=u[d++];if(!(J&128)){P+=String.fromCharCode(J);continue}var ne=u[d++]&63;if((J&224)==192){P+=String.fromCharCode((J&31)<<6|ne);continue}var Ee=u[d++]&63;if((J&240)==224?J=(J&15)<<12|ne<<6|Ee:J=(J&7)<<18|ne<<12|Ee<<6|u[d++]&63,J<65536)P+=String.fromCharCode(J);else{var Ie=J-65536;P+=String.fromCharCode(55296|Ie>>10,56320|Ie&1023)}}return P},m1=[],Ou=u=>{for(var d=0,w=0;w<u.length;++w){var E=u.charCodeAt(w);E<=127?d++:E<=2047?d+=2:E>=55296&&E<=57343?(d+=4,++w):d+=3}return d},y1=(u,d,w,E)=>{if(!(E>0))return 0;for(var S=w,P=w+E-1,J=0;J<u.length;++J){var ne=u.charCodeAt(J);if(ne>=55296&&ne<=57343){var Ee=u.charCodeAt(++J);ne=65536+((ne&1023)<<10)|Ee&1023}if(ne<=127){if(w>=P)break;d[w++]=ne}else if(ne<=2047){if(w+1>=P)break;d[w++]=192|ne>>6,d[w++]=128|ne&63}else if(ne<=65535){if(w+2>=P)break;d[w++]=224|ne>>12,d[w++]=128|ne>>6&63,d[w++]=128|ne&63}else{if(w+3>=P)break;d[w++]=240|ne>>18,d[w++]=128|ne>>12&63,d[w++]=128|ne>>6&63,d[w++]=128|ne&63}}return d[w]=0,w-S};function mm(u,d,w){var E=Ou(u)+1,S=new Array(E),P=y1(u,S,0,S.length);return S.length=P,S}var mv=()=>{if(!m1.length){var u=null;if(typeof window<"u"&&typeof window.prompt=="function"&&(u=window.prompt("Input: "),u!==null&&(u+=`
`)),!u)return null;m1=mm(u)}return m1.shift()},$i={ttys:[],init(){},shutdown(){},register(u,d){$i.ttys[u]={input:[],output:[],ops:d},H.registerDevice(u,$i.stream_ops)},stream_ops:{open(u){var d=$i.ttys[u.node.rdev];if(!d)throw new H.ErrnoError(43);u.tty=d,u.seekable=!1},close(u){u.tty.ops.fsync(u.tty)},fsync(u){u.tty.ops.fsync(u.tty)},read(u,d,w,E,S){if(!u.tty||!u.tty.ops.get_char)throw new H.ErrnoError(60);for(var P=0,J=0;J<E;J++){var ne;try{ne=u.tty.ops.get_char(u.tty)}catch{throw new H.ErrnoError(29)}if(ne===void 0&&P===0)throw new H.ErrnoError(6);if(ne==null)break;P++,d[w+J]=ne}return P&&(u.node.timestamp=Date.now()),P},write(u,d,w,E,S){if(!u.tty||!u.tty.ops.put_char)throw new H.ErrnoError(60);try{for(var P=0;P<E;P++)u.tty.ops.put_char(u.tty,d[w+P])}catch{throw new H.ErrnoError(29)}return E&&(u.node.timestamp=Date.now()),P}},default_tty_ops:{get_char(u){return mv()},put_char(u,d){d===null||d===10?(T(Ko(u.output)),u.output=[]):d!=0&&u.output.push(d)},fsync(u){u.output&&u.output.length>0&&(T(Ko(u.output)),u.output=[])},ioctl_tcgets(u){return{c_iflag:25856,c_oflag:5,c_cflag:191,c_lflag:35387,c_cc:[3,28,127,21,4,0,1,0,17,19,26,0,18,15,23,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},ioctl_tcsets(u,d,w){return 0},ioctl_tiocgwinsz(u){return[24,80]}},default_tty1_ops:{put_char(u,d){d===null||d===10?(A(Ko(u.output)),u.output=[]):d!=0&&u.output.push(d)},fsync(u){u.output&&u.output.length>0&&(A(Ko(u.output)),u.output=[])}}},yv=(u,d)=>{z.fill(0,u,u+d)},ym=(u,d)=>Math.ceil(u/d)*d,bm=u=>{u=ym(u,65536);var d=Em(65536,u);return d&&yv(d,u),d},ut={ops_table:null,mount(u){return ut.createNode(null,"/",16895,0)},createNode(u,d,w,E){if(H.isBlkdev(w)||H.isFIFO(w))throw new H.ErrnoError(63);ut.ops_table||={dir:{node:{getattr:ut.node_ops.getattr,setattr:ut.node_ops.setattr,lookup:ut.node_ops.lookup,mknod:ut.node_ops.mknod,rename:ut.node_ops.rename,unlink:ut.node_ops.unlink,rmdir:ut.node_ops.rmdir,readdir:ut.node_ops.readdir,symlink:ut.node_ops.symlink},stream:{llseek:ut.stream_ops.llseek}},file:{node:{getattr:ut.node_ops.getattr,setattr:ut.node_ops.setattr},stream:{llseek:ut.stream_ops.llseek,read:ut.stream_ops.read,write:ut.stream_ops.write,allocate:ut.stream_ops.allocate,mmap:ut.stream_ops.mmap,msync:ut.stream_ops.msync}},link:{node:{getattr:ut.node_ops.getattr,setattr:ut.node_ops.setattr,readlink:ut.node_ops.readlink},stream:{}},chrdev:{node:{getattr:ut.node_ops.getattr,setattr:ut.node_ops.setattr},stream:H.chrdev_stream_ops}};var S=H.createNode(u,d,w,E);return H.isDir(S.mode)?(S.node_ops=ut.ops_table.dir.node,S.stream_ops=ut.ops_table.dir.stream,S.contents={}):H.isFile(S.mode)?(S.node_ops=ut.ops_table.file.node,S.stream_ops=ut.ops_table.file.stream,S.usedBytes=0,S.contents=null):H.isLink(S.mode)?(S.node_ops=ut.ops_table.link.node,S.stream_ops=ut.ops_table.link.stream):H.isChrdev(S.mode)&&(S.node_ops=ut.ops_table.chrdev.node,S.stream_ops=ut.ops_table.chrdev.stream),S.timestamp=Date.now(),u&&(u.contents[d]=S,u.timestamp=S.timestamp),S},getFileDataAsTypedArray(u){return u.contents?u.contents.subarray?u.contents.subarray(0,u.usedBytes):new Uint8Array(u.contents):new Uint8Array(0)},expandFileStorage(u,d){var w=u.contents?u.contents.length:0;if(!(w>=d)){var E=1024*1024;d=Math.max(d,w*(w<E?2:1.125)>>>0),w!=0&&(d=Math.max(d,256));var S=u.contents;u.contents=new Uint8Array(d),u.usedBytes>0&&u.contents.set(S.subarray(0,u.usedBytes),0)}},resizeFileStorage(u,d){if(u.usedBytes!=d)if(d==0)u.contents=null,u.usedBytes=0;else{var w=u.contents;u.contents=new Uint8Array(d),w&&u.contents.set(w.subarray(0,Math.min(d,u.usedBytes))),u.usedBytes=d}},node_ops:{getattr(u){var d={};return d.dev=H.isChrdev(u.mode)?u.id:1,d.ino=u.id,d.mode=u.mode,d.nlink=1,d.uid=0,d.gid=0,d.rdev=u.rdev,H.isDir(u.mode)?d.size=4096:H.isFile(u.mode)?d.size=u.usedBytes:H.isLink(u.mode)?d.size=u.link.length:d.size=0,d.atime=new Date(u.timestamp),d.mtime=new Date(u.timestamp),d.ctime=new Date(u.timestamp),d.blksize=4096,d.blocks=Math.ceil(d.size/d.blksize),d},setattr(u,d){d.mode!==void 0&&(u.mode=d.mode),d.timestamp!==void 0&&(u.timestamp=d.timestamp),d.size!==void 0&&ut.resizeFileStorage(u,d.size)},lookup(u,d){throw H.genericErrors[44]},mknod(u,d,w,E){return ut.createNode(u,d,w,E)},rename(u,d,w){if(H.isDir(u.mode)){var E;try{E=H.lookupNode(d,w)}catch{}if(E)for(var S in E.contents)throw new H.ErrnoError(55)}delete u.parent.contents[u.name],u.parent.timestamp=Date.now(),u.name=w,d.contents[w]=u,d.timestamp=u.parent.timestamp},unlink(u,d){delete u.contents[d],u.timestamp=Date.now()},rmdir(u,d){var w=H.lookupNode(u,d);for(var E in w.contents)throw new H.ErrnoError(55);delete u.contents[d],u.timestamp=Date.now()},readdir(u){var d=[".",".."];for(var w of Object.keys(u.contents))d.push(w);return d},symlink(u,d,w){var E=ut.createNode(u,d,41471,0);return E.link=w,E},readlink(u){if(!H.isLink(u.mode))throw new H.ErrnoError(28);return u.link}},stream_ops:{read(u,d,w,E,S){var P=u.node.contents;if(S>=u.node.usedBytes)return 0;var J=Math.min(u.node.usedBytes-S,E);if(J>8&&P.subarray)d.set(P.subarray(S,S+J),w);else for(var ne=0;ne<J;ne++)d[w+ne]=P[S+ne];return J},write(u,d,w,E,S,P){if(d.buffer===L.buffer&&(P=!1),!E)return 0;var J=u.node;if(J.timestamp=Date.now(),d.subarray&&(!J.contents||J.contents.subarray)){if(P)return J.contents=d.subarray(w,w+E),J.usedBytes=E,E;if(J.usedBytes===0&&S===0)return J.contents=d.slice(w,w+E),J.usedBytes=E,E;if(S+E<=J.usedBytes)return J.contents.set(d.subarray(w,w+E),S),E}if(ut.expandFileStorage(J,S+E),J.contents.subarray&&d.subarray)J.contents.set(d.subarray(w,w+E),S);else for(var ne=0;ne<E;ne++)J.contents[S+ne]=d[w+ne];return J.usedBytes=Math.max(J.usedBytes,S+E),E},llseek(u,d,w){var E=d;if(w===1?E+=u.position:w===2&&H.isFile(u.node.mode)&&(E+=u.node.usedBytes),E<0)throw new H.ErrnoError(28);return E},allocate(u,d,w){ut.expandFileStorage(u.node,d+w),u.node.usedBytes=Math.max(u.node.usedBytes,d+w)},mmap(u,d,w,E,S){if(!H.isFile(u.node.mode))throw new H.ErrnoError(43);var P,J,ne=u.node.contents;if(!(S&2)&&ne&&ne.buffer===L.buffer)J=!1,P=ne.byteOffset;else{if(J=!0,P=bm(d),!P)throw new H.ErrnoError(48);ne&&((w>0||w+d<ne.length)&&(ne.subarray?ne=ne.subarray(w,w+d):ne=Array.prototype.slice.call(ne,w,w+d)),L.set(ne,P))}return{ptr:P,allocated:J}},msync(u,d,w,E,S){return ut.stream_ops.write(u,d,0,E,w,!1),0}}},bv=(u,d,w,E)=>{var S=`al ${u}`;_(u).then(P=>{d(new Uint8Array(P)),S&&pe()},P=>{if(w)w();else throw`Loading data file "${u}" failed.`}),S&&re()},wv=(u,d,w,E,S,P)=>{H.createDataFile(u,d,w,E,S,P)},_v=n.preloadPlugins||[],Ev=(u,d,w,E)=>{typeof Browser<"u"&&Browser.init();var S=!1;return _v.forEach(P=>{S||P.canHandle(d)&&(P.handle(u,d,w,E),S=!0)}),S},vv=(u,d,w,E,S,P,J,ne,Ee,Ie)=>{var qe=d?as.resolve(Ct.join2(u,d)):u;function Oe(be){function he(Ae){Ie?.(),ne||wv(u,d,Ae,E,S,Ee),P?.(),pe()}Ev(be,qe,he,()=>{J?.(),pe()})||he(be)}re(),typeof w=="string"?bv(w,Oe,J):Oe(w)},xv=u=>{var d={r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090},w=d[u];if(typeof w>"u")throw new Error(`Unknown file open mode: ${u}`);return w},b1=(u,d)=>{var w=0;return u&&(w|=365),d&&(w|=146),w},H={root:null,mounts:[],devices:{},streams:[],nextInode:1,nameTable:null,currentPath:"/",initialized:!1,ignorePermissions:!0,ErrnoError:class{constructor(u){this.name="ErrnoError",this.errno=u}},genericErrors:{},filesystems:null,syncFSRequests:0,readFiles:{},FSStream:class{constructor(){this.shared={}}get object(){return this.node}set object(u){this.node=u}get isRead(){return(this.flags&2097155)!==1}get isWrite(){return(this.flags&2097155)!==0}get isAppend(){return this.flags&1024}get flags(){return this.shared.flags}set flags(u){this.shared.flags=u}get position(){return this.shared.position}set position(u){this.shared.position=u}},FSNode:class{constructor(u,d,w,E){u||(u=this),this.parent=u,this.mount=u.mount,this.mounted=null,this.id=H.nextInode++,this.name=d,this.mode=w,this.node_ops={},this.stream_ops={},this.rdev=E,this.readMode=365,this.writeMode=146}get read(){return(this.mode&this.readMode)===this.readMode}set read(u){u?this.mode|=this.readMode:this.mode&=~this.readMode}get write(){return(this.mode&this.writeMode)===this.writeMode}set write(u){u?this.mode|=this.writeMode:this.mode&=~this.writeMode}get isFolder(){return H.isDir(this.mode)}get isDevice(){return H.isChrdev(this.mode)}},lookupPath(u,d={}){if(u=as.resolve(u),!u)return{path:"",node:null};var w={follow_mount:!0,recurse_count:0};if(d=Object.assign(w,d),d.recurse_count>8)throw new H.ErrnoError(32);for(var E=u.split("/").filter(Oe=>!!Oe),S=H.root,P="/",J=0;J<E.length;J++){var ne=J===E.length-1;if(ne&&d.parent)break;if(S=H.lookupNode(S,E[J]),P=Ct.join2(P,E[J]),H.isMountpoint(S)&&(!ne||ne&&d.follow_mount)&&(S=S.mounted.root),!ne||d.follow)for(var Ee=0;H.isLink(S.mode);){var Ie=H.readlink(P);P=as.resolve(Ct.dirname(P),Ie);var qe=H.lookupPath(P,{recurse_count:d.recurse_count+1});if(S=qe.node,Ee++>40)throw new H.ErrnoError(32)}}return{path:P,node:S}},getPath(u){for(var d;;){if(H.isRoot(u)){var w=u.mount.mountpoint;return d?w[w.length-1]!=="/"?`${w}/${d}`:w+d:w}d=d?`${u.name}/${d}`:u.name,u=u.parent}},hashName(u,d){for(var w=0,E=0;E<d.length;E++)w=(w<<5)-w+d.charCodeAt(E)|0;return(u+w>>>0)%H.nameTable.length},hashAddNode(u){var d=H.hashName(u.parent.id,u.name);u.name_next=H.nameTable[d],H.nameTable[d]=u},hashRemoveNode(u){var d=H.hashName(u.parent.id,u.name);if(H.nameTable[d]===u)H.nameTable[d]=u.name_next;else for(var w=H.nameTable[d];w;){if(w.name_next===u){w.name_next=u.name_next;break}w=w.name_next}},lookupNode(u,d){var w=H.mayLookup(u);if(w)throw new H.ErrnoError(w);for(var E=H.hashName(u.id,d),S=H.nameTable[E];S;S=S.name_next){var P=S.name;if(S.parent.id===u.id&&P===d)return S}return H.lookup(u,d)},createNode(u,d,w,E){var S=new H.FSNode(u,d,w,E);return H.hashAddNode(S),S},destroyNode(u){H.hashRemoveNode(u)},isRoot(u){return u===u.parent},isMountpoint(u){return!!u.mounted},isFile(u){return(u&61440)===32768},isDir(u){return(u&61440)===16384},isLink(u){return(u&61440)===40960},isChrdev(u){return(u&61440)===8192},isBlkdev(u){return(u&61440)===24576},isFIFO(u){return(u&61440)===4096},isSocket(u){return(u&49152)===49152},flagsToPermissionString(u){var d=["r","w","rw"][u&3];return u&512&&(d+="w"),d},nodePermissions(u,d){return H.ignorePermissions?0:d.includes("r")&&!(u.mode&292)||d.includes("w")&&!(u.mode&146)||d.includes("x")&&!(u.mode&73)?2:0},mayLookup(u){if(!H.isDir(u.mode))return 54;var d=H.nodePermissions(u,"x");return d||(u.node_ops.lookup?0:2)},mayCreate(u,d){try{var w=H.lookupNode(u,d);return 20}catch{}return H.nodePermissions(u,"wx")},mayDelete(u,d,w){var E;try{E=H.lookupNode(u,d)}catch(P){return P.errno}var S=H.nodePermissions(u,"wx");if(S)return S;if(w){if(!H.isDir(E.mode))return 54;if(H.isRoot(E)||H.getPath(E)===H.cwd())return 10}else if(H.isDir(E.mode))return 31;return 0},mayOpen(u,d){return u?H.isLink(u.mode)?32:H.isDir(u.mode)&&(H.flagsToPermissionString(d)!=="r"||d&512)?31:H.nodePermissions(u,H.flagsToPermissionString(d)):44},MAX_OPEN_FDS:4096,nextfd(){for(var u=0;u<=H.MAX_OPEN_FDS;u++)if(!H.streams[u])return u;throw new H.ErrnoError(33)},getStreamChecked(u){var d=H.getStream(u);if(!d)throw new H.ErrnoError(8);return d},getStream:u=>H.streams[u],createStream(u,d=-1){return u=Object.assign(new H.FSStream,u),d==-1&&(d=H.nextfd()),u.fd=d,H.streams[d]=u,u},closeStream(u){H.streams[u]=null},dupStream(u,d=-1){var w=H.createStream(u,d);return w.stream_ops?.dup?.(w),w},chrdev_stream_ops:{open(u){var d=H.getDevice(u.node.rdev);u.stream_ops=d.stream_ops,u.stream_ops.open?.(u)},llseek(){throw new H.ErrnoError(70)}},major:u=>u>>8,minor:u=>u&255,makedev:(u,d)=>u<<8|d,registerDevice(u,d){H.devices[u]={stream_ops:d}},getDevice:u=>H.devices[u],getMounts(u){for(var d=[],w=[u];w.length;){var E=w.pop();d.push(E),w.push(...E.mounts)}return d},syncfs(u,d){typeof u=="function"&&(d=u,u=!1),H.syncFSRequests++,H.syncFSRequests>1&&A(`warning: ${H.syncFSRequests} FS.syncfs operations in flight at once, probably just doing extra work`);var w=H.getMounts(H.root.mount),E=0;function S(J){return H.syncFSRequests--,d(J)}function P(J){if(J)return P.errored?void 0:(P.errored=!0,S(J));++E>=w.length&&S(null)}w.forEach(J=>{if(!J.type.syncfs)return P(null);J.type.syncfs(J,u,P)})},mount(u,d,w){var E=w==="/",S=!w,P;if(E&&H.root)throw new H.ErrnoError(10);if(!E&&!S){var J=H.lookupPath(w,{follow_mount:!1});if(w=J.path,P=J.node,H.isMountpoint(P))throw new H.ErrnoError(10);if(!H.isDir(P.mode))throw new H.ErrnoError(54)}var ne={type:u,opts:d,mountpoint:w,mounts:[]},Ee=u.mount(ne);return Ee.mount=ne,ne.root=Ee,E?H.root=Ee:P&&(P.mounted=ne,P.mount&&P.mount.mounts.push(ne)),Ee},unmount(u){var d=H.lookupPath(u,{follow_mount:!1});if(!H.isMountpoint(d.node))throw new H.ErrnoError(28);var w=d.node,E=w.mounted,S=H.getMounts(E);Object.keys(H.nameTable).forEach(J=>{for(var ne=H.nameTable[J];ne;){var Ee=ne.name_next;S.includes(ne.mount)&&H.destroyNode(ne),ne=Ee}}),w.mounted=null;var P=w.mount.mounts.indexOf(E);w.mount.mounts.splice(P,1)},lookup(u,d){return u.node_ops.lookup(u,d)},mknod(u,d,w){var E=H.lookupPath(u,{parent:!0}),S=E.node,P=Ct.basename(u);if(!P||P==="."||P==="..")throw new H.ErrnoError(28);var J=H.mayCreate(S,P);if(J)throw new H.ErrnoError(J);if(!S.node_ops.mknod)throw new H.ErrnoError(63);return S.node_ops.mknod(S,P,d,w)},create(u,d){return d=d!==void 0?d:438,d&=4095,d|=32768,H.mknod(u,d,0)},mkdir(u,d){return d=d!==void 0?d:511,d&=1023,d|=16384,H.mknod(u,d,0)},mkdirTree(u,d){for(var w=u.split("/"),E="",S=0;S<w.length;++S)if(w[S]){E+="/"+w[S];try{H.mkdir(E,d)}catch(P){if(P.errno!=20)throw P}}},mkdev(u,d,w){return typeof w>"u"&&(w=d,d=438),d|=8192,H.mknod(u,d,w)},symlink(u,d){if(!as.resolve(u))throw new H.ErrnoError(44);var w=H.lookupPath(d,{parent:!0}),E=w.node;if(!E)throw new H.ErrnoError(44);var S=Ct.basename(d),P=H.mayCreate(E,S);if(P)throw new H.ErrnoError(P);if(!E.node_ops.symlink)throw new H.ErrnoError(63);return E.node_ops.symlink(E,S,u)},rename(u,d){var w=Ct.dirname(u),E=Ct.dirname(d),S=Ct.basename(u),P=Ct.basename(d),J,ne,Ee;if(J=H.lookupPath(u,{parent:!0}),ne=J.node,J=H.lookupPath(d,{parent:!0}),Ee=J.node,!ne||!Ee)throw new H.ErrnoError(44);if(ne.mount!==Ee.mount)throw new H.ErrnoError(75);var Ie=H.lookupNode(ne,S),qe=as.relative(u,E);if(qe.charAt(0)!==".")throw new H.ErrnoError(28);if(qe=as.relative(d,w),qe.charAt(0)!==".")throw new H.ErrnoError(55);var Oe;try{Oe=H.lookupNode(Ee,P)}catch{}if(Ie!==Oe){var be=H.isDir(Ie.mode),he=H.mayDelete(ne,S,be);if(he)throw new H.ErrnoError(he);if(he=Oe?H.mayDelete(Ee,P,be):H.mayCreate(Ee,P),he)throw new H.ErrnoError(he);if(!ne.node_ops.rename)throw new H.ErrnoError(63);if(H.isMountpoint(Ie)||Oe&&H.isMountpoint(Oe))throw new H.ErrnoError(10);if(Ee!==ne&&(he=H.nodePermissions(ne,"w"),he))throw new H.ErrnoError(he);H.hashRemoveNode(Ie);try{ne.node_ops.rename(Ie,Ee,P),Ie.parent=Ee}catch(Ae){throw Ae}finally{H.hashAddNode(Ie)}}},rmdir(u){var d=H.lookupPath(u,{parent:!0}),w=d.node,E=Ct.basename(u),S=H.lookupNode(w,E),P=H.mayDelete(w,E,!0);if(P)throw new H.ErrnoError(P);if(!w.node_ops.rmdir)throw new H.ErrnoError(63);if(H.isMountpoint(S))throw new H.ErrnoError(10);w.node_ops.rmdir(w,E),H.destroyNode(S)},readdir(u){var d=H.lookupPath(u,{follow:!0}),w=d.node;if(!w.node_ops.readdir)throw new H.ErrnoError(54);return w.node_ops.readdir(w)},unlink(u){var d=H.lookupPath(u,{parent:!0}),w=d.node;if(!w)throw new H.ErrnoError(44);var E=Ct.basename(u),S=H.lookupNode(w,E),P=H.mayDelete(w,E,!1);if(P)throw new H.ErrnoError(P);if(!w.node_ops.unlink)throw new H.ErrnoError(63);if(H.isMountpoint(S))throw new H.ErrnoError(10);w.node_ops.unlink(w,E),H.destroyNode(S)},readlink(u){var d=H.lookupPath(u),w=d.node;if(!w)throw new H.ErrnoError(44);if(!w.node_ops.readlink)throw new H.ErrnoError(28);return as.resolve(H.getPath(w.parent),w.node_ops.readlink(w))},stat(u,d){var w=H.lookupPath(u,{follow:!d}),E=w.node;if(!E)throw new H.ErrnoError(44);if(!E.node_ops.getattr)throw new H.ErrnoError(63);return E.node_ops.getattr(E)},lstat(u){return H.stat(u,!0)},chmod(u,d,w){var E;if(typeof u=="string"){var S=H.lookupPath(u,{follow:!w});E=S.node}else E=u;if(!E.node_ops.setattr)throw new H.ErrnoError(63);E.node_ops.setattr(E,{mode:d&4095|E.mode&-4096,timestamp:Date.now()})},lchmod(u,d){H.chmod(u,d,!0)},fchmod(u,d){var w=H.getStreamChecked(u);H.chmod(w.node,d)},chown(u,d,w,E){var S;if(typeof u=="string"){var P=H.lookupPath(u,{follow:!E});S=P.node}else S=u;if(!S.node_ops.setattr)throw new H.ErrnoError(63);S.node_ops.setattr(S,{timestamp:Date.now()})},lchown(u,d,w){H.chown(u,d,w,!0)},fchown(u,d,w){var E=H.getStreamChecked(u);H.chown(E.node,d,w)},truncate(u,d){if(d<0)throw new H.ErrnoError(28);var w;if(typeof u=="string"){var E=H.lookupPath(u,{follow:!0});w=E.node}else w=u;if(!w.node_ops.setattr)throw new H.ErrnoError(63);if(H.isDir(w.mode))throw new H.ErrnoError(31);if(!H.isFile(w.mode))throw new H.ErrnoError(28);var S=H.nodePermissions(w,"w");if(S)throw new H.ErrnoError(S);w.node_ops.setattr(w,{size:d,timestamp:Date.now()})},ftruncate(u,d){var w=H.getStreamChecked(u);if((w.flags&2097155)===0)throw new H.ErrnoError(28);H.truncate(w.node,d)},utime(u,d,w){var E=H.lookupPath(u,{follow:!0}),S=E.node;S.node_ops.setattr(S,{timestamp:Math.max(d,w)})},open(u,d,w){if(u==="")throw new H.ErrnoError(44);d=typeof d=="string"?xv(d):d,d&64?(w=typeof w>"u"?438:w,w=w&4095|32768):w=0;var E;if(typeof u=="object")E=u;else{u=Ct.normalize(u);try{var S=H.lookupPath(u,{follow:!(d&131072)});E=S.node}catch{}}var P=!1;if(d&64)if(E){if(d&128)throw new H.ErrnoError(20)}else E=H.mknod(u,w,0),P=!0;if(!E)throw new H.ErrnoError(44);if(H.isChrdev(E.mode)&&(d&=-513),d&65536&&!H.isDir(E.mode))throw new H.ErrnoError(54);if(!P){var J=H.mayOpen(E,d);if(J)throw new H.ErrnoError(J)}d&512&&!P&&H.truncate(E,0),d&=-131713;var ne=H.createStream({node:E,path:H.getPath(E),flags:d,seekable:!0,position:0,stream_ops:E.stream_ops,ungotten:[],error:!1});return ne.stream_ops.open&&ne.stream_ops.open(ne),n.logReadFiles&&!(d&1)&&(u in H.readFiles||(H.readFiles[u]=1)),ne},close(u){if(H.isClosed(u))throw new H.ErrnoError(8);u.getdents&&(u.getdents=null);try{u.stream_ops.close&&u.stream_ops.close(u)}catch(d){throw d}finally{H.closeStream(u.fd)}u.fd=null},isClosed(u){return u.fd===null},llseek(u,d,w){if(H.isClosed(u))throw new H.ErrnoError(8);if(!u.seekable||!u.stream_ops.llseek)throw new H.ErrnoError(70);if(w!=0&&w!=1&&w!=2)throw new H.ErrnoError(28);return u.position=u.stream_ops.llseek(u,d,w),u.ungotten=[],u.position},read(u,d,w,E,S){if(E<0||S<0)throw new H.ErrnoError(28);if(H.isClosed(u))throw new H.ErrnoError(8);if((u.flags&2097155)===1)throw new H.ErrnoError(8);if(H.isDir(u.node.mode))throw new H.ErrnoError(31);if(!u.stream_ops.read)throw new H.ErrnoError(28);var P=typeof S<"u";if(!P)S=u.position;else if(!u.seekable)throw new H.ErrnoError(70);var J=u.stream_ops.read(u,d,w,E,S);return P||(u.position+=J),J},write(u,d,w,E,S,P){if(E<0||S<0)throw new H.ErrnoError(28);if(H.isClosed(u))throw new H.ErrnoError(8);if((u.flags&2097155)===0)throw new H.ErrnoError(8);if(H.isDir(u.node.mode))throw new H.ErrnoError(31);if(!u.stream_ops.write)throw new H.ErrnoError(28);u.seekable&&u.flags&1024&&H.llseek(u,0,2);var J=typeof S<"u";if(!J)S=u.position;else if(!u.seekable)throw new H.ErrnoError(70);var ne=u.stream_ops.write(u,d,w,E,S,P);return J||(u.position+=ne),ne},allocate(u,d,w){if(H.isClosed(u))throw new H.ErrnoError(8);if(d<0||w<=0)throw new H.ErrnoError(28);if((u.flags&2097155)===0)throw new H.ErrnoError(8);if(!H.isFile(u.node.mode)&&!H.isDir(u.node.mode))throw new H.ErrnoError(43);if(!u.stream_ops.allocate)throw new H.ErrnoError(138);u.stream_ops.allocate(u,d,w)},mmap(u,d,w,E,S){if((E&2)!==0&&(S&2)===0&&(u.flags&2097155)!==2)throw new H.ErrnoError(2);if((u.flags&2097155)===1)throw new H.ErrnoError(2);if(!u.stream_ops.mmap)throw new H.ErrnoError(43);if(!d)throw new H.ErrnoError(28);return u.stream_ops.mmap(u,d,w,E,S)},msync(u,d,w,E,S){return u.stream_ops.msync?u.stream_ops.msync(u,d,w,E,S):0},ioctl(u,d,w){if(!u.stream_ops.ioctl)throw new H.ErrnoError(59);return u.stream_ops.ioctl(u,d,w)},readFile(u,d={}){if(d.flags=d.flags||0,d.encoding=d.encoding||"binary",d.encoding!=="utf8"&&d.encoding!=="binary")throw new Error(`Invalid encoding type "${d.encoding}"`);var w,E=H.open(u,d.flags),S=H.stat(u),P=S.size,J=new Uint8Array(P);return H.read(E,J,0,P,0),d.encoding==="utf8"?w=Ko(J):d.encoding==="binary"&&(w=J),H.close(E),w},writeFile(u,d,w={}){w.flags=w.flags||577;var E=H.open(u,w.flags,w.mode);if(typeof d=="string"){var S=new Uint8Array(Ou(d)+1),P=y1(d,S,0,S.length);H.write(E,S,0,P,void 0,w.canOwn)}else if(ArrayBuffer.isView(d))H.write(E,d,0,d.byteLength,void 0,w.canOwn);else throw new Error("Unsupported data type");H.close(E)},cwd:()=>H.currentPath,chdir(u){var d=H.lookupPath(u,{follow:!0});if(d.node===null)throw new H.ErrnoError(44);if(!H.isDir(d.node.mode))throw new H.ErrnoError(54);var w=H.nodePermissions(d.node,"x");if(w)throw new H.ErrnoError(w);H.currentPath=d.path},createDefaultDirectories(){H.mkdir("/tmp"),H.mkdir("/home"),H.mkdir("/home/web_user")},createDefaultDevices(){H.mkdir("/dev"),H.registerDevice(H.makedev(1,3),{read:()=>0,write:(E,S,P,J,ne)=>J}),H.mkdev("/dev/null",H.makedev(1,3)),$i.register(H.makedev(5,0),$i.default_tty_ops),$i.register(H.makedev(6,0),$i.default_tty1_ops),H.mkdev("/dev/tty",H.makedev(5,0)),H.mkdev("/dev/tty1",H.makedev(6,0));var u=new Uint8Array(1024),d=0,w=()=>(d===0&&(d=pm(u).byteLength),u[--d]);H.createDevice("/dev","random",w),H.createDevice("/dev","urandom",w),H.mkdir("/dev/shm"),H.mkdir("/dev/shm/tmp")},createSpecialDirectories(){H.mkdir("/proc");var u=H.mkdir("/proc/self");H.mkdir("/proc/self/fd"),H.mount({mount(){var d=H.createNode(u,"fd",16895,73);return d.node_ops={lookup(w,E){var S=+E,P=H.getStreamChecked(S),J={parent:null,mount:{mountpoint:"fake"},node_ops:{readlink:()=>P.path}};return J.parent=J,J}},d}},{},"/proc/self/fd")},createStandardStreams(u,d,w){u?H.createDevice("/dev","stdin",u):H.symlink("/dev/tty","/dev/stdin"),d?H.createDevice("/dev","stdout",null,d):H.symlink("/dev/tty","/dev/stdout"),w?H.createDevice("/dev","stderr",null,w):H.symlink("/dev/tty1","/dev/stderr"),H.open("/dev/stdin",0),H.open("/dev/stdout",1),H.open("/dev/stderr",1)},staticInit(){[44].forEach(u=>{H.genericErrors[u]=new H.ErrnoError(u),H.genericErrors[u].stack="<generic error, no stack>"}),H.nameTable=new Array(4096),H.mount(ut,{},"/"),H.createDefaultDirectories(),H.createDefaultDevices(),H.createSpecialDirectories(),H.filesystems={MEMFS:ut}},init(u,d,w){H.initialized=!0,u??=n.stdin,d??=n.stdout,w??=n.stderr,H.createStandardStreams(u,d,w)},quit(){H.initialized=!1;for(var u=0;u<H.streams.length;u++){var d=H.streams[u];d&&H.close(d)}},findObject(u,d){var w=H.analyzePath(u,d);return w.exists?w.object:null},analyzePath(u,d){try{var w=H.lookupPath(u,{follow:!d});u=w.path}catch{}var E={isRoot:!1,exists:!1,error:0,name:null,path:null,object:null,parentExists:!1,parentPath:null,parentObject:null};try{var w=H.lookupPath(u,{parent:!0});E.parentExists=!0,E.parentPath=w.path,E.parentObject=w.node,E.name=Ct.basename(u),w=H.lookupPath(u,{follow:!d}),E.exists=!0,E.path=w.path,E.object=w.node,E.name=w.node.name,E.isRoot=w.path==="/"}catch(S){E.error=S.errno}return E},createPath(u,d,w,E){u=typeof u=="string"?u:H.getPath(u);for(var S=d.split("/").reverse();S.length;){var P=S.pop();if(P){var J=Ct.join2(u,P);try{H.mkdir(J)}catch{}u=J}}return J},createFile(u,d,w,E,S){var P=Ct.join2(typeof u=="string"?u:H.getPath(u),d),J=b1(E,S);return H.create(P,J)},createDataFile(u,d,w,E,S,P){var J=d;u&&(u=typeof u=="string"?u:H.getPath(u),J=d?Ct.join2(u,d):u);var ne=b1(E,S),Ee=H.create(J,ne);if(w){if(typeof w=="string"){for(var Ie=new Array(w.length),qe=0,Oe=w.length;qe<Oe;++qe)Ie[qe]=w.charCodeAt(qe);w=Ie}H.chmod(Ee,ne|146);var be=H.open(Ee,577);H.write(be,w,0,w.length,0,P),H.close(be),H.chmod(Ee,ne)}},createDevice(u,d,w,E){var S=Ct.join2(typeof u=="string"?u:H.getPath(u),d),P=b1(!!w,!!E);H.createDevice.major??=64;var J=H.makedev(H.createDevice.major++,0);return H.registerDevice(J,{open(ne){ne.seekable=!1},close(ne){E?.buffer?.length&&E(10)},read(ne,Ee,Ie,qe,Oe){for(var be=0,he=0;he<qe;he++){var Ae;try{Ae=w()}catch{throw new H.ErrnoError(29)}if(Ae===void 0&&be===0)throw new H.ErrnoError(6);if(Ae==null)break;be++,Ee[Ie+he]=Ae}return be&&(ne.node.timestamp=Date.now()),be},write(ne,Ee,Ie,qe,Oe){for(var be=0;be<qe;be++)try{E(Ee[Ie+be])}catch{throw new H.ErrnoError(29)}return qe&&(ne.node.timestamp=Date.now()),be}}),H.mkdev(S,P,J)},forceLoadFile(u){if(u.isDevice||u.isFolder||u.link||u.contents)return!0;if(typeof XMLHttpRequest<"u")throw new Error("Lazy loading should have been performed (contents set) in createLazyFile, but it was not. Lazy loading only works in web workers. Use --embed-file or --preload-file in emcc on the main thread.");try{u.contents=R(u.url),u.usedBytes=u.contents.length}catch{throw new H.ErrnoError(29)}},createLazyFile(u,d,w,E,S){class P{constructor(){this.lengthKnown=!1,this.chunks=[]}get(he){if(!(he>this.length-1||he<0)){var Ae=he%this.chunkSize,se=he/this.chunkSize|0;return this.getter(se)[Ae]}}setDataGetter(he){this.getter=he}cacheLength(){var he=new XMLHttpRequest;if(he.open("HEAD",w,!1),he.send(null),!(he.status>=200&&he.status<300||he.status===304))throw new Error("Couldn't load "+w+". Status: "+he.status);var Ae=Number(he.getResponseHeader("Content-length")),se,ae=(se=he.getResponseHeader("Accept-Ranges"))&&se==="bytes",ue=(se=he.getResponseHeader("Content-Encoding"))&&se==="gzip",Te=1024*1024;ae||(Te=Ae);var ve=(xe,He)=>{if(xe>He)throw new Error("invalid range ("+xe+", "+He+") or no bytes requested!");if(He>Ae-1)throw new Error("only "+Ae+" bytes available! programmer error!");var K=new XMLHttpRequest;if(K.open("GET",w,!1),Ae!==Te&&K.setRequestHeader("Range","bytes="+xe+"-"+He),K.responseType="arraybuffer",K.overrideMimeType&&K.overrideMimeType("text/plain; charset=x-user-defined"),K.send(null),!(K.status>=200&&K.status<300||K.status===304))throw new Error("Couldn't load "+w+". Status: "+K.status);return K.response!==void 0?new Uint8Array(K.response||[]):mm(K.responseText||"")},fe=this;fe.setDataGetter(xe=>{var He=xe*Te,K=(xe+1)*Te-1;if(K=Math.min(K,Ae-1),typeof fe.chunks[xe]>"u"&&(fe.chunks[xe]=ve(He,K)),typeof fe.chunks[xe]>"u")throw new Error("doXHR failed!");return fe.chunks[xe]}),(ue||!Ae)&&(Te=Ae=1,Ae=this.getter(0).length,Te=Ae,T("LazyFiles on gzip forces download of the whole file when length is accessed")),this._length=Ae,this._chunkSize=Te,this.lengthKnown=!0}get length(){return this.lengthKnown||this.cacheLength(),this._length}get chunkSize(){return this.lengthKnown||this.cacheLength(),this._chunkSize}}if(typeof XMLHttpRequest<"u"){if(!c)throw"Cannot do synchronous binary XHRs outside webworkers in modern browsers. Use --embed-file or --preload-file in emcc";var J=new P,ne={isDevice:!1,contents:J}}else var ne={isDevice:!1,url:w};var Ee=H.createFile(u,d,ne,E,S);ne.contents?Ee.contents=ne.contents:ne.url&&(Ee.contents=null,Ee.url=ne.url),Object.defineProperties(Ee,{usedBytes:{get:function(){return this.contents.length}}});var Ie={},qe=Object.keys(Ee.stream_ops);qe.forEach(be=>{var he=Ee.stream_ops[be];Ie[be]=(...Ae)=>(H.forceLoadFile(Ee),he(...Ae))});function Oe(be,he,Ae,se,ae){var ue=be.node.contents;if(ae>=ue.length)return 0;var Te=Math.min(ue.length-ae,se);if(ue.slice)for(var ve=0;ve<Te;ve++)he[Ae+ve]=ue[ae+ve];else for(var ve=0;ve<Te;ve++)he[Ae+ve]=ue.get(ae+ve);return Te}return Ie.read=(be,he,Ae,se,ae)=>(H.forceLoadFile(Ee),Oe(be,he,Ae,se,ae)),Ie.mmap=(be,he,Ae,se,ae)=>{H.forceLoadFile(Ee);var ue=bm(he);if(!ue)throw new H.ErrnoError(48);return Oe(be,L,ue,he,Ae),{ptr:ue,allocated:!0}},Ee.stream_ops=Ie,Ee}},Sv=(u,d)=>u?Ko(z,u,d):"",pt={DEFAULT_POLLMASK:5,calculateAt(u,d,w){if(Ct.isAbs(d))return d;var E;if(u===-100)E=H.cwd();else{var S=pt.getStreamFromFD(u);E=S.path}if(d.length==0){if(!w)throw new H.ErrnoError(44);return E}return Ct.join2(E,d)},doStat(u,d,w){var E=u(d);k[w>>2]=E.dev,k[w+4>>2]=E.mode,x[w+8>>2]=E.nlink,k[w+12>>2]=E.uid,k[w+16>>2]=E.gid,k[w+20>>2]=E.rdev,F[w+24>>3]=BigInt(E.size),k[w+32>>2]=4096,k[w+36>>2]=E.blocks;var S=E.atime.getTime(),P=E.mtime.getTime(),J=E.ctime.getTime();return F[w+40>>3]=BigInt(Math.floor(S/1e3)),x[w+48>>2]=S%1e3*1e3*1e3,F[w+56>>3]=BigInt(Math.floor(P/1e3)),x[w+64>>2]=P%1e3*1e3*1e3,F[w+72>>3]=BigInt(Math.floor(J/1e3)),x[w+80>>2]=J%1e3*1e3*1e3,F[w+88>>3]=BigInt(E.ino),0},doMsync(u,d,w,E,S){if(!H.isFile(d.node.mode))throw new H.ErrnoError(43);if(E&2)return 0;var P=z.slice(u,u+w);H.msync(d,P,S,w,E)},getStreamFromFD(u){var d=H.getStreamChecked(u);return d},varargs:void 0,getStr(u){var d=Sv(u);return d}};function Av(u,d){try{return u=pt.getStr(u),H.chmod(u,d),0}catch(w){if(typeof H>"u"||w.name!=="ErrnoError")throw w;return-w.errno}}function Iv(u,d,w,E){try{if(d=pt.getStr(d),d=pt.calculateAt(u,d),w&-8)return-28;var S=H.lookupPath(d,{follow:!0}),P=S.node;if(!P)return-44;var J="";return w&4&&(J+="r"),w&2&&(J+="w"),w&1&&(J+="x"),J&&H.nodePermissions(P,J)?-2:0}catch(ne){if(typeof H>"u"||ne.name!=="ErrnoError")throw ne;return-ne.errno}}function Tv(u,d){try{return H.fchmod(u,d),0}catch(w){if(typeof H>"u"||w.name!=="ErrnoError")throw w;return-w.errno}}function kv(u,d,w){try{return H.fchown(u,d,w),0}catch(E){if(typeof H>"u"||E.name!=="ErrnoError")throw E;return-E.errno}}function $u(){var u=k[+pt.varargs>>2];return pt.varargs+=4,u}var zo=$u;function Cv(u,d,w){pt.varargs=w;try{var E=pt.getStreamFromFD(u);switch(d){case 0:{var S=$u();if(S<0)return-28;for(;H.streams[S];)S++;var P;return P=H.dupStream(E,S),P.fd}case 1:case 2:return 0;case 3:return E.flags;case 4:{var S=$u();return E.flags|=S,0}case 12:{var S=zo(),J=0;return Y[S+J>>1]=2,0}case 13:case 14:return 0}return-28}catch(ne){if(typeof H>"u"||ne.name!=="ErrnoError")throw ne;return-ne.errno}}function Rv(u,d){try{var w=pt.getStreamFromFD(u);return pt.doStat(H.stat,w.path,d)}catch(E){if(typeof H>"u"||E.name!=="ErrnoError")throw E;return-E.errno}}var Pv=9007199254740992,Dv=-9007199254740992,Sc=u=>u<Dv||u>Pv?NaN:Number(u);function qv(u,d){d=Sc(d);try{return isNaN(d)?61:(H.ftruncate(u,d),0)}catch(w){if(typeof H>"u"||w.name!=="ErrnoError")throw w;return-w.errno}}var Wo=(u,d,w)=>y1(u,z,d,w);function Bv(u,d){try{if(d===0)return-28;var w=H.cwd(),E=Ou(w)+1;return d<E?-68:(Wo(w,u,d),E)}catch(S){if(typeof H>"u"||S.name!=="ErrnoError")throw S;return-S.errno}}function Lv(u,d,w){pt.varargs=w;try{var E=pt.getStreamFromFD(u);switch(d){case 21509:return E.tty?0:-59;case 21505:{if(!E.tty)return-59;if(E.tty.ops.ioctl_tcgets){var S=E.tty.ops.ioctl_tcgets(E),P=zo();k[P>>2]=S.c_iflag||0,k[P+4>>2]=S.c_oflag||0,k[P+8>>2]=S.c_cflag||0,k[P+12>>2]=S.c_lflag||0;for(var J=0;J<32;J++)L[P+J+17]=S.c_cc[J]||0;return 0}return 0}case 21510:case 21511:case 21512:return E.tty?0:-59;case 21506:case 21507:case 21508:{if(!E.tty)return-59;if(E.tty.ops.ioctl_tcsets){for(var P=zo(),ne=k[P>>2],Ee=k[P+4>>2],Ie=k[P+8>>2],qe=k[P+12>>2],Oe=[],J=0;J<32;J++)Oe.push(L[P+J+17]);return E.tty.ops.ioctl_tcsets(E.tty,d,{c_iflag:ne,c_oflag:Ee,c_cflag:Ie,c_lflag:qe,c_cc:Oe})}return 0}case 21519:{if(!E.tty)return-59;var P=zo();return k[P>>2]=0,0}case 21520:return E.tty?-28:-59;case 21531:{var P=zo();return H.ioctl(E,d,P)}case 21523:{if(!E.tty)return-59;if(E.tty.ops.ioctl_tiocgwinsz){var be=E.tty.ops.ioctl_tiocgwinsz(E.tty),P=zo();Y[P>>1]=be[0],Y[P+2>>1]=be[1]}return 0}case 21524:return E.tty?0:-59;case 21515:return E.tty?0:-59;default:return-28}}catch(he){if(typeof H>"u"||he.name!=="ErrnoError")throw he;return-he.errno}}function Ov(u,d){try{return u=pt.getStr(u),pt.doStat(H.lstat,u,d)}catch(w){if(typeof H>"u"||w.name!=="ErrnoError")throw w;return-w.errno}}function $v(u,d,w){try{return d=pt.getStr(d),d=pt.calculateAt(u,d),d=Ct.normalize(d),d[d.length-1]==="/"&&(d=d.substr(0,d.length-1)),H.mkdir(d,w,0),0}catch(E){if(typeof H>"u"||E.name!=="ErrnoError")throw E;return-E.errno}}function Mv(u,d,w,E){try{d=pt.getStr(d);var S=E&256,P=E&4096;return E=E&-6401,d=pt.calculateAt(u,d,P),pt.doStat(S?H.lstat:H.stat,d,w)}catch(J){if(typeof H>"u"||J.name!=="ErrnoError")throw J;return-J.errno}}function Nv(u,d,w,E){pt.varargs=E;try{d=pt.getStr(d),d=pt.calculateAt(u,d);var S=E?$u():0;return H.open(d,w,S).fd}catch(P){if(typeof H>"u"||P.name!=="ErrnoError")throw P;return-P.errno}}function Uv(u,d,w,E){try{if(d=pt.getStr(d),d=pt.calculateAt(u,d),E<=0)return-28;var S=H.readlink(d),P=Math.min(E,Ou(S)),J=L[w+P];return Wo(S,w,E+1),L[w+P]=J,P}catch(ne){if(typeof H>"u"||ne.name!=="ErrnoError")throw ne;return-ne.errno}}function Fv(u){try{return u=pt.getStr(u),H.rmdir(u),0}catch(d){if(typeof H>"u"||d.name!=="ErrnoError")throw d;return-d.errno}}function Hv(u,d){try{return u=pt.getStr(u),pt.doStat(H.stat,u,d)}catch(w){if(typeof H>"u"||w.name!=="ErrnoError")throw w;return-w.errno}}function Vv(u,d,w){try{return d=pt.getStr(d),d=pt.calculateAt(u,d),w===0?H.unlink(d):w===512?H.rmdir(d):_e("Invalid flags passed to unlinkat"),0}catch(E){if(typeof H>"u"||E.name!=="ErrnoError")throw E;return-E.errno}}var wm=u=>x[u>>2]+k[u+4>>2]*4294967296;function Kv(u,d,w,E){try{d=pt.getStr(d),d=pt.calculateAt(u,d,!0);var S=Date.now(),P,J;if(!w)P=S,J=S;else{var ne=wm(w),Ee=k[w+8>>2];Ee==1073741823?P=S:Ee==1073741822?P=-1:P=ne*1e3+Ee/(1e3*1e3),w+=16,ne=wm(w),Ee=k[w+8>>2],Ee==1073741823?J=S:Ee==1073741822?J=-1:J=ne*1e3+Ee/(1e3*1e3)}return(J!=-1||P!=-1)&&H.utime(d,P,J),0}catch(Ie){if(typeof H>"u"||Ie.name!=="ErrnoError")throw Ie;return-Ie.errno}}var zv=1,Wv=()=>zv,Gv=u=>u%4===0&&(u%100!==0||u%400===0),Zv=[0,31,60,91,121,152,182,213,244,274,305,335],jv=[0,31,59,90,120,151,181,212,243,273,304,334],Yv=u=>{var d=Gv(u.getFullYear()),w=d?Zv:jv,E=w[u.getMonth()]+u.getDate()-1;return E};function Qv(u,d){u=Sc(u);var w=new Date(u*1e3);k[d>>2]=w.getSeconds(),k[d+4>>2]=w.getMinutes(),k[d+8>>2]=w.getHours(),k[d+12>>2]=w.getDate(),k[d+16>>2]=w.getMonth(),k[d+20>>2]=w.getFullYear()-1900,k[d+24>>2]=w.getDay();var E=Yv(w)|0;k[d+28>>2]=E,k[d+36>>2]=-(w.getTimezoneOffset()*60);var S=new Date(w.getFullYear(),0,1),P=new Date(w.getFullYear(),6,1).getTimezoneOffset(),J=S.getTimezoneOffset(),ne=(P!=J&&w.getTimezoneOffset()==Math.min(J,P))|0;k[d+32>>2]=ne}function Xv(u,d,w,E,S,P,J){S=Sc(S);try{if(isNaN(S))return 61;var ne=pt.getStreamFromFD(E),Ee=H.mmap(ne,u,S,d,w),Ie=Ee.ptr;return k[P>>2]=Ee.allocated,x[J>>2]=Ie,0}catch(qe){if(typeof H>"u"||qe.name!=="ErrnoError")throw qe;return-qe.errno}}function Jv(u,d,w,E,S,P){P=Sc(P);try{var J=pt.getStreamFromFD(S);w&2&&pt.doMsync(u,J,d,E,P)}catch(ne){if(typeof H>"u"||ne.name!=="ErrnoError")throw ne;return-ne.errno}}var ex=(u,d,w,E)=>{var S=new Date().getFullYear(),P=new Date(S,0,1),J=new Date(S,6,1),ne=P.getTimezoneOffset(),Ee=J.getTimezoneOffset(),Ie=Math.max(ne,Ee);x[u>>2]=Ie*60,k[d>>2]=+(ne!=Ee);var qe=he=>{var Ae=he>=0?"-":"+",se=Math.abs(he),ae=String(Math.floor(se/60)).padStart(2,"0"),ue=String(se%60).padStart(2,"0");return`UTC${Ae}${ae}${ue}`},Oe=qe(ne),be=qe(Ee);Ee<ne?(Wo(Oe,w,17),Wo(be,E,17)):(Wo(Oe,E,17),Wo(be,w,17))},tx=()=>Date.now(),nx=()=>performance.now(),rx=()=>2147483648,sx=u=>{var d=I.buffer,w=(u-d.byteLength+65535)/65536|0;try{return I.grow(w),j(),1}catch{}},ix=u=>{var d=z.length;u>>>=0;var w=rx();if(u>w)return!1;for(var E=1;E<=4;E*=2){var S=d*(1+.2/E);S=Math.min(S,u+100663296);var P=Math.min(w,ym(Math.max(u,S),65536)),J=sx(P);if(J)return!0}return!1},w1={},ox=()=>f||"./this.program",Ac=()=>{if(!Ac.strings){var u=(typeof navigator=="object"&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",d={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:u,_:ox()};for(var w in w1)w1[w]===void 0?delete d[w]:d[w]=w1[w];var E=[];for(var w in d)E.push(`${w}=${d[w]}`);Ac.strings=E}return Ac.strings},ax=(u,d)=>{for(var w=0;w<u.length;++w)L[d++]=u.charCodeAt(w);L[d]=0},cx=(u,d)=>{var w=0;return Ac().forEach((E,S)=>{var P=d+w;x[u+S*4>>2]=P,ax(E,P),w+=E.length+1}),0},lx=(u,d)=>{var w=Ac();x[u>>2]=w.length;var E=0;return w.forEach(S=>E+=S.length+1),x[d>>2]=E,0};function ux(u){try{var d=pt.getStreamFromFD(u);return H.close(d),0}catch(w){if(typeof H>"u"||w.name!=="ErrnoError")throw w;return w.errno}}function fx(u,d){try{var w=0,E=0,S=0,P=pt.getStreamFromFD(u),J=P.tty?2:H.isDir(P.mode)?3:H.isLink(P.mode)?7:4;return L[d]=J,Y[d+2>>1]=S,F[d+8>>3]=BigInt(w),F[d+16>>3]=BigInt(E),0}catch(ne){if(typeof H>"u"||ne.name!=="ErrnoError")throw ne;return ne.errno}}var dx=(u,d,w,E)=>{for(var S=0,P=0;P<w;P++){var J=x[d>>2],ne=x[d+4>>2];d+=8;var Ee=H.read(u,L,J,ne,E);if(Ee<0)return-1;if(S+=Ee,Ee<ne)break}return S};function hx(u,d,w,E){try{var S=pt.getStreamFromFD(u),P=dx(S,d,w);return x[E>>2]=P,0}catch(J){if(typeof H>"u"||J.name!=="ErrnoError")throw J;return J.errno}}function px(u,d,w,E){d=Sc(d);try{if(isNaN(d))return 61;var S=pt.getStreamFromFD(u);return H.llseek(S,d,w),F[E>>3]=BigInt(S.position),S.getdents&&d===0&&w===0&&(S.getdents=null),0}catch(P){if(typeof H>"u"||P.name!=="ErrnoError")throw P;return P.errno}}function gx(u){try{var d=pt.getStreamFromFD(u);return d.stream_ops?.fsync?d.stream_ops.fsync(d):0}catch(w){if(typeof H>"u"||w.name!=="ErrnoError")throw w;return w.errno}}var mx=(u,d,w,E)=>{for(var S=0,P=0;P<w;P++){var J=x[d>>2],ne=x[d+4>>2];d+=8;var Ee=H.write(u,L,J,ne,E);if(Ee<0)return-1;if(S+=Ee,Ee<ne)break}return S};function yx(u,d,w,E){try{var S=pt.getStreamFromFD(u),P=mx(S,d,w);return x[E>>2]=P,0}catch(J){if(typeof H>"u"||J.name!=="ErrnoError")throw J;return J.errno}}H.createPreloadedFile=vv,H.staticInit();var _m={__syscall_chmod:Av,__syscall_faccessat:Iv,__syscall_fchmod:Tv,__syscall_fchown32:kv,__syscall_fcntl64:Cv,__syscall_fstat64:Rv,__syscall_ftruncate64:qv,__syscall_getcwd:Bv,__syscall_ioctl:Lv,__syscall_lstat64:Ov,__syscall_mkdirat:$v,__syscall_newfstatat:Mv,__syscall_openat:Nv,__syscall_readlinkat:Uv,__syscall_rmdir:Fv,__syscall_stat64:Hv,__syscall_unlinkat:Vv,__syscall_utimensat:Kv,_emscripten_get_now_is_monotonic:Wv,_localtime_js:Qv,_mmap_js:Xv,_munmap_js:Jv,_tzset_js:ex,emscripten_date_now:tx,emscripten_get_now:nx,emscripten_resize_heap:ix,environ_get:cx,environ_sizes_get:lx,fd_close:ux,fd_fdstat_get:fx,fd_read:hx,fd_seek:px,fd_sync:gx,fd_write:yx,memory:I},ee=pv();n._sqlite3_status64=(u,d,w,E)=>(n._sqlite3_status64=ee.sqlite3_status64)(u,d,w,E),n._sqlite3_status=(u,d,w,E)=>(n._sqlite3_status=ee.sqlite3_status)(u,d,w,E),n._sqlite3_db_status=(u,d,w,E,S)=>(n._sqlite3_db_status=ee.sqlite3_db_status)(u,d,w,E,S),n._sqlite3_msize=u=>(n._sqlite3_msize=ee.sqlite3_msize)(u),n._sqlite3_vfs_find=u=>(n._sqlite3_vfs_find=ee.sqlite3_vfs_find)(u),n._sqlite3_initialize=()=>(n._sqlite3_initialize=ee.sqlite3_initialize)(),n._sqlite3_malloc=u=>(n._sqlite3_malloc=ee.sqlite3_malloc)(u),n._sqlite3_free=u=>(n._sqlite3_free=ee.sqlite3_free)(u),n._sqlite3_vfs_register=(u,d)=>(n._sqlite3_vfs_register=ee.sqlite3_vfs_register)(u,d),n._sqlite3_vfs_unregister=u=>(n._sqlite3_vfs_unregister=ee.sqlite3_vfs_unregister)(u),n._sqlite3_malloc64=u=>(n._sqlite3_malloc64=ee.sqlite3_malloc64)(u),n._sqlite3_realloc=(u,d)=>(n._sqlite3_realloc=ee.sqlite3_realloc)(u,d),n._sqlite3_realloc64=(u,d)=>(n._sqlite3_realloc64=ee.sqlite3_realloc64)(u,d),n._sqlite3_value_text=u=>(n._sqlite3_value_text=ee.sqlite3_value_text)(u),n._sqlite3_randomness=(u,d)=>(n._sqlite3_randomness=ee.sqlite3_randomness)(u,d),n._sqlite3_stricmp=(u,d)=>(n._sqlite3_stricmp=ee.sqlite3_stricmp)(u,d),n._sqlite3_strnicmp=(u,d,w)=>(n._sqlite3_strnicmp=ee.sqlite3_strnicmp)(u,d,w),n._sqlite3_uri_parameter=(u,d)=>(n._sqlite3_uri_parameter=ee.sqlite3_uri_parameter)(u,d),n._sqlite3_uri_boolean=(u,d,w)=>(n._sqlite3_uri_boolean=ee.sqlite3_uri_boolean)(u,d,w),n._sqlite3_serialize=(u,d,w,E)=>(n._sqlite3_serialize=ee.sqlite3_serialize)(u,d,w,E),n._sqlite3_prepare_v2=(u,d,w,E,S)=>(n._sqlite3_prepare_v2=ee.sqlite3_prepare_v2)(u,d,w,E,S),n._sqlite3_step=u=>(n._sqlite3_step=ee.sqlite3_step)(u),n._sqlite3_column_int64=(u,d)=>(n._sqlite3_column_int64=ee.sqlite3_column_int64)(u,d),n._sqlite3_reset=u=>(n._sqlite3_reset=ee.sqlite3_reset)(u),n._sqlite3_exec=(u,d,w,E,S)=>(n._sqlite3_exec=ee.sqlite3_exec)(u,d,w,E,S),n._sqlite3_column_int=(u,d)=>(n._sqlite3_column_int=ee.sqlite3_column_int)(u,d),n._sqlite3_finalize=u=>(n._sqlite3_finalize=ee.sqlite3_finalize)(u),n._sqlite3_file_control=(u,d,w,E)=>(n._sqlite3_file_control=ee.sqlite3_file_control)(u,d,w,E),n._sqlite3_column_name=(u,d)=>(n._sqlite3_column_name=ee.sqlite3_column_name)(u,d),n._sqlite3_column_text=(u,d)=>(n._sqlite3_column_text=ee.sqlite3_column_text)(u,d),n._sqlite3_column_type=(u,d)=>(n._sqlite3_column_type=ee.sqlite3_column_type)(u,d),n._sqlite3_errmsg=u=>(n._sqlite3_errmsg=ee.sqlite3_errmsg)(u),n._sqlite3_deserialize=(u,d,w,E,S,P)=>(n._sqlite3_deserialize=ee.sqlite3_deserialize)(u,d,w,E,S,P),n._sqlite3_clear_bindings=u=>(n._sqlite3_clear_bindings=ee.sqlite3_clear_bindings)(u),n._sqlite3_value_blob=u=>(n._sqlite3_value_blob=ee.sqlite3_value_blob)(u),n._sqlite3_value_bytes=u=>(n._sqlite3_value_bytes=ee.sqlite3_value_bytes)(u),n._sqlite3_value_double=u=>(n._sqlite3_value_double=ee.sqlite3_value_double)(u),n._sqlite3_value_int=u=>(n._sqlite3_value_int=ee.sqlite3_value_int)(u),n._sqlite3_value_int64=u=>(n._sqlite3_value_int64=ee.sqlite3_value_int64)(u),n._sqlite3_value_subtype=u=>(n._sqlite3_value_subtype=ee.sqlite3_value_subtype)(u),n._sqlite3_value_pointer=(u,d)=>(n._sqlite3_value_pointer=ee.sqlite3_value_pointer)(u,d),n._sqlite3_value_type=u=>(n._sqlite3_value_type=ee.sqlite3_value_type)(u),n._sqlite3_value_nochange=u=>(n._sqlite3_value_nochange=ee.sqlite3_value_nochange)(u),n._sqlite3_value_frombind=u=>(n._sqlite3_value_frombind=ee.sqlite3_value_frombind)(u),n._sqlite3_value_dup=u=>(n._sqlite3_value_dup=ee.sqlite3_value_dup)(u),n._sqlite3_value_free=u=>(n._sqlite3_value_free=ee.sqlite3_value_free)(u),n._sqlite3_result_blob=(u,d,w,E)=>(n._sqlite3_result_blob=ee.sqlite3_result_blob)(u,d,w,E),n._sqlite3_result_error_toobig=u=>(n._sqlite3_result_error_toobig=ee.sqlite3_result_error_toobig)(u),n._sqlite3_result_error_nomem=u=>(n._sqlite3_result_error_nomem=ee.sqlite3_result_error_nomem)(u),n._sqlite3_result_double=(u,d)=>(n._sqlite3_result_double=ee.sqlite3_result_double)(u,d),n._sqlite3_result_error=(u,d,w)=>(n._sqlite3_result_error=ee.sqlite3_result_error)(u,d,w),n._sqlite3_result_int=(u,d)=>(n._sqlite3_result_int=ee.sqlite3_result_int)(u,d),n._sqlite3_result_int64=(u,d)=>(n._sqlite3_result_int64=ee.sqlite3_result_int64)(u,d),n._sqlite3_result_null=u=>(n._sqlite3_result_null=ee.sqlite3_result_null)(u),n._sqlite3_result_pointer=(u,d,w,E)=>(n._sqlite3_result_pointer=ee.sqlite3_result_pointer)(u,d,w,E),n._sqlite3_result_subtype=(u,d)=>(n._sqlite3_result_subtype=ee.sqlite3_result_subtype)(u,d),n._sqlite3_result_text=(u,d,w,E)=>(n._sqlite3_result_text=ee.sqlite3_result_text)(u,d,w,E),n._sqlite3_result_zeroblob=(u,d)=>(n._sqlite3_result_zeroblob=ee.sqlite3_result_zeroblob)(u,d),n._sqlite3_result_zeroblob64=(u,d)=>(n._sqlite3_result_zeroblob64=ee.sqlite3_result_zeroblob64)(u,d),n._sqlite3_result_error_code=(u,d)=>(n._sqlite3_result_error_code=ee.sqlite3_result_error_code)(u,d),n._sqlite3_user_data=u=>(n._sqlite3_user_data=ee.sqlite3_user_data)(u),n._sqlite3_context_db_handle=u=>(n._sqlite3_context_db_handle=ee.sqlite3_context_db_handle)(u),n._sqlite3_vtab_nochange=u=>(n._sqlite3_vtab_nochange=ee.sqlite3_vtab_nochange)(u),n._sqlite3_vtab_in_first=(u,d)=>(n._sqlite3_vtab_in_first=ee.sqlite3_vtab_in_first)(u,d),n._sqlite3_vtab_in_next=(u,d)=>(n._sqlite3_vtab_in_next=ee.sqlite3_vtab_in_next)(u,d),n._sqlite3_aggregate_context=(u,d)=>(n._sqlite3_aggregate_context=ee.sqlite3_aggregate_context)(u,d),n._sqlite3_get_auxdata=(u,d)=>(n._sqlite3_get_auxdata=ee.sqlite3_get_auxdata)(u,d),n._sqlite3_set_auxdata=(u,d,w,E)=>(n._sqlite3_set_auxdata=ee.sqlite3_set_auxdata)(u,d,w,E),n._sqlite3_column_count=u=>(n._sqlite3_column_count=ee.sqlite3_column_count)(u),n._sqlite3_data_count=u=>(n._sqlite3_data_count=ee.sqlite3_data_count)(u),n._sqlite3_column_blob=(u,d)=>(n._sqlite3_column_blob=ee.sqlite3_column_blob)(u,d),n._sqlite3_column_bytes=(u,d)=>(n._sqlite3_column_bytes=ee.sqlite3_column_bytes)(u,d),n._sqlite3_column_double=(u,d)=>(n._sqlite3_column_double=ee.sqlite3_column_double)(u,d),n._sqlite3_column_value=(u,d)=>(n._sqlite3_column_value=ee.sqlite3_column_value)(u,d),n._sqlite3_column_decltype=(u,d)=>(n._sqlite3_column_decltype=ee.sqlite3_column_decltype)(u,d),n._sqlite3_bind_blob=(u,d,w,E,S)=>(n._sqlite3_bind_blob=ee.sqlite3_bind_blob)(u,d,w,E,S),n._sqlite3_bind_double=(u,d,w)=>(n._sqlite3_bind_double=ee.sqlite3_bind_double)(u,d,w),n._sqlite3_bind_int=(u,d,w)=>(n._sqlite3_bind_int=ee.sqlite3_bind_int)(u,d,w),n._sqlite3_bind_int64=(u,d,w)=>(n._sqlite3_bind_int64=ee.sqlite3_bind_int64)(u,d,w),n._sqlite3_bind_null=(u,d)=>(n._sqlite3_bind_null=ee.sqlite3_bind_null)(u,d),n._sqlite3_bind_pointer=(u,d,w,E,S)=>(n._sqlite3_bind_pointer=ee.sqlite3_bind_pointer)(u,d,w,E,S),n._sqlite3_bind_text=(u,d,w,E,S)=>(n._sqlite3_bind_text=ee.sqlite3_bind_text)(u,d,w,E,S),n._sqlite3_bind_parameter_count=u=>(n._sqlite3_bind_parameter_count=ee.sqlite3_bind_parameter_count)(u),n._sqlite3_bind_parameter_name=(u,d)=>(n._sqlite3_bind_parameter_name=ee.sqlite3_bind_parameter_name)(u,d),n._sqlite3_bind_parameter_index=(u,d)=>(n._sqlite3_bind_parameter_index=ee.sqlite3_bind_parameter_index)(u,d),n._sqlite3_db_handle=u=>(n._sqlite3_db_handle=ee.sqlite3_db_handle)(u),n._sqlite3_stmt_readonly=u=>(n._sqlite3_stmt_readonly=ee.sqlite3_stmt_readonly)(u),n._sqlite3_stmt_isexplain=u=>(n._sqlite3_stmt_isexplain=ee.sqlite3_stmt_isexplain)(u),n._sqlite3_stmt_explain=(u,d)=>(n._sqlite3_stmt_explain=ee.sqlite3_stmt_explain)(u,d),n._sqlite3_stmt_busy=u=>(n._sqlite3_stmt_busy=ee.sqlite3_stmt_busy)(u),n._sqlite3_stmt_status=(u,d,w)=>(n._sqlite3_stmt_status=ee.sqlite3_stmt_status)(u,d,w),n._sqlite3_sql=u=>(n._sqlite3_sql=ee.sqlite3_sql)(u),n._sqlite3_expanded_sql=u=>(n._sqlite3_expanded_sql=ee.sqlite3_expanded_sql)(u),n._sqlite3_preupdate_old=(u,d,w)=>(n._sqlite3_preupdate_old=ee.sqlite3_preupdate_old)(u,d,w),n._sqlite3_preupdate_count=u=>(n._sqlite3_preupdate_count=ee.sqlite3_preupdate_count)(u),n._sqlite3_preupdate_depth=u=>(n._sqlite3_preupdate_depth=ee.sqlite3_preupdate_depth)(u),n._sqlite3_preupdate_blobwrite=u=>(n._sqlite3_preupdate_blobwrite=ee.sqlite3_preupdate_blobwrite)(u),n._sqlite3_preupdate_new=(u,d,w)=>(n._sqlite3_preupdate_new=ee.sqlite3_preupdate_new)(u,d,w),n._sqlite3_value_numeric_type=u=>(n._sqlite3_value_numeric_type=ee.sqlite3_value_numeric_type)(u),n._sqlite3_set_authorizer=(u,d,w)=>(n._sqlite3_set_authorizer=ee.sqlite3_set_authorizer)(u,d,w),n._sqlite3_strglob=(u,d)=>(n._sqlite3_strglob=ee.sqlite3_strglob)(u,d),n._sqlite3_strlike=(u,d,w)=>(n._sqlite3_strlike=ee.sqlite3_strlike)(u,d,w),n._sqlite3_auto_extension=u=>(n._sqlite3_auto_extension=ee.sqlite3_auto_extension)(u),n._sqlite3_cancel_auto_extension=u=>(n._sqlite3_cancel_auto_extension=ee.sqlite3_cancel_auto_extension)(u),n._sqlite3_reset_auto_extension=()=>(n._sqlite3_reset_auto_extension=ee.sqlite3_reset_auto_extension)(),n._sqlite3_prepare_v3=(u,d,w,E,S,P)=>(n._sqlite3_prepare_v3=ee.sqlite3_prepare_v3)(u,d,w,E,S,P),n._sqlite3_create_module=(u,d,w,E)=>(n._sqlite3_create_module=ee.sqlite3_create_module)(u,d,w,E),n._sqlite3_create_module_v2=(u,d,w,E,S)=>(n._sqlite3_create_module_v2=ee.sqlite3_create_module_v2)(u,d,w,E,S),n._sqlite3_drop_modules=(u,d)=>(n._sqlite3_drop_modules=ee.sqlite3_drop_modules)(u,d),n._sqlite3_declare_vtab=(u,d)=>(n._sqlite3_declare_vtab=ee.sqlite3_declare_vtab)(u,d),n._sqlite3_vtab_on_conflict=u=>(n._sqlite3_vtab_on_conflict=ee.sqlite3_vtab_on_conflict)(u),n._sqlite3_vtab_collation=(u,d)=>(n._sqlite3_vtab_collation=ee.sqlite3_vtab_collation)(u,d),n._sqlite3_vtab_in=(u,d,w)=>(n._sqlite3_vtab_in=ee.sqlite3_vtab_in)(u,d,w),n._sqlite3_vtab_rhs_value=(u,d,w)=>(n._sqlite3_vtab_rhs_value=ee.sqlite3_vtab_rhs_value)(u,d,w),n._sqlite3_vtab_distinct=u=>(n._sqlite3_vtab_distinct=ee.sqlite3_vtab_distinct)(u),n._sqlite3_keyword_name=(u,d,w)=>(n._sqlite3_keyword_name=ee.sqlite3_keyword_name)(u,d,w),n._sqlite3_keyword_count=()=>(n._sqlite3_keyword_count=ee.sqlite3_keyword_count)(),n._sqlite3_keyword_check=(u,d)=>(n._sqlite3_keyword_check=ee.sqlite3_keyword_check)(u,d),n._sqlite3_complete=u=>(n._sqlite3_complete=ee.sqlite3_complete)(u),n._sqlite3_libversion=()=>(n._sqlite3_libversion=ee.sqlite3_libversion)(),n._sqlite3_libversion_number=()=>(n._sqlite3_libversion_number=ee.sqlite3_libversion_number)(),n._sqlite3_shutdown=()=>(n._sqlite3_shutdown=ee.sqlite3_shutdown)(),n._sqlite3_last_insert_rowid=u=>(n._sqlite3_last_insert_rowid=ee.sqlite3_last_insert_rowid)(u),n._sqlite3_set_last_insert_rowid=(u,d)=>(n._sqlite3_set_last_insert_rowid=ee.sqlite3_set_last_insert_rowid)(u,d),n._sqlite3_changes64=u=>(n._sqlite3_changes64=ee.sqlite3_changes64)(u),n._sqlite3_changes=u=>(n._sqlite3_changes=ee.sqlite3_changes)(u),n._sqlite3_total_changes64=u=>(n._sqlite3_total_changes64=ee.sqlite3_total_changes64)(u),n._sqlite3_total_changes=u=>(n._sqlite3_total_changes=ee.sqlite3_total_changes)(u),n._sqlite3_txn_state=(u,d)=>(n._sqlite3_txn_state=ee.sqlite3_txn_state)(u,d),n._sqlite3_close_v2=u=>(n._sqlite3_close_v2=ee.sqlite3_close_v2)(u),n._sqlite3_busy_handler=(u,d,w)=>(n._sqlite3_busy_handler=ee.sqlite3_busy_handler)(u,d,w),n._sqlite3_progress_handler=(u,d,w,E)=>(n._sqlite3_progress_handler=ee.sqlite3_progress_handler)(u,d,w,E),n._sqlite3_busy_timeout=(u,d)=>(n._sqlite3_busy_timeout=ee.sqlite3_busy_timeout)(u,d),n._sqlite3_interrupt=u=>(n._sqlite3_interrupt=ee.sqlite3_interrupt)(u),n._sqlite3_is_interrupted=u=>(n._sqlite3_is_interrupted=ee.sqlite3_is_interrupted)(u),n._sqlite3_create_function=(u,d,w,E,S,P,J,ne)=>(n._sqlite3_create_function=ee.sqlite3_create_function)(u,d,w,E,S,P,J,ne),n._sqlite3_create_function_v2=(u,d,w,E,S,P,J,ne,Ee)=>(n._sqlite3_create_function_v2=ee.sqlite3_create_function_v2)(u,d,w,E,S,P,J,ne,Ee),n._sqlite3_create_window_function=(u,d,w,E,S,P,J,ne,Ee,Ie)=>(n._sqlite3_create_window_function=ee.sqlite3_create_window_function)(u,d,w,E,S,P,J,ne,Ee,Ie),n._sqlite3_overload_function=(u,d,w)=>(n._sqlite3_overload_function=ee.sqlite3_overload_function)(u,d,w),n._sqlite3_trace_v2=(u,d,w,E)=>(n._sqlite3_trace_v2=ee.sqlite3_trace_v2)(u,d,w,E),n._sqlite3_commit_hook=(u,d,w)=>(n._sqlite3_commit_hook=ee.sqlite3_commit_hook)(u,d,w),n._sqlite3_update_hook=(u,d,w)=>(n._sqlite3_update_hook=ee.sqlite3_update_hook)(u,d,w),n._sqlite3_rollback_hook=(u,d,w)=>(n._sqlite3_rollback_hook=ee.sqlite3_rollback_hook)(u,d,w),n._sqlite3_preupdate_hook=(u,d,w)=>(n._sqlite3_preupdate_hook=ee.sqlite3_preupdate_hook)(u,d,w),n._sqlite3_error_offset=u=>(n._sqlite3_error_offset=ee.sqlite3_error_offset)(u),n._sqlite3_errcode=u=>(n._sqlite3_errcode=ee.sqlite3_errcode)(u),n._sqlite3_extended_errcode=u=>(n._sqlite3_extended_errcode=ee.sqlite3_extended_errcode)(u),n._sqlite3_errstr=u=>(n._sqlite3_errstr=ee.sqlite3_errstr)(u),n._sqlite3_limit=(u,d,w)=>(n._sqlite3_limit=ee.sqlite3_limit)(u,d,w),n._sqlite3_open=(u,d)=>(n._sqlite3_open=ee.sqlite3_open)(u,d),n._sqlite3_open_v2=(u,d,w,E)=>(n._sqlite3_open_v2=ee.sqlite3_open_v2)(u,d,w,E),n._sqlite3_create_collation=(u,d,w,E,S)=>(n._sqlite3_create_collation=ee.sqlite3_create_collation)(u,d,w,E,S),n._sqlite3_create_collation_v2=(u,d,w,E,S,P)=>(n._sqlite3_create_collation_v2=ee.sqlite3_create_collation_v2)(u,d,w,E,S,P),n._sqlite3_collation_needed=(u,d,w)=>(n._sqlite3_collation_needed=ee.sqlite3_collation_needed)(u,d,w),n._sqlite3_get_autocommit=u=>(n._sqlite3_get_autocommit=ee.sqlite3_get_autocommit)(u),n._sqlite3_table_column_metadata=(u,d,w,E,S,P,J,ne,Ee)=>(n._sqlite3_table_column_metadata=ee.sqlite3_table_column_metadata)(u,d,w,E,S,P,J,ne,Ee),n._sqlite3_extended_result_codes=(u,d)=>(n._sqlite3_extended_result_codes=ee.sqlite3_extended_result_codes)(u,d),n._sqlite3_uri_key=(u,d)=>(n._sqlite3_uri_key=ee.sqlite3_uri_key)(u,d),n._sqlite3_uri_int64=(u,d,w)=>(n._sqlite3_uri_int64=ee.sqlite3_uri_int64)(u,d,w),n._sqlite3_db_name=(u,d)=>(n._sqlite3_db_name=ee.sqlite3_db_name)(u,d),n._sqlite3_db_filename=(u,d)=>(n._sqlite3_db_filename=ee.sqlite3_db_filename)(u,d),n._sqlite3_db_readonly=(u,d)=>(n._sqlite3_db_readonly=ee.sqlite3_db_readonly)(u,d),n._sqlite3_compileoption_used=u=>(n._sqlite3_compileoption_used=ee.sqlite3_compileoption_used)(u),n._sqlite3_compileoption_get=u=>(n._sqlite3_compileoption_get=ee.sqlite3_compileoption_get)(u),n._sqlite3session_diff=(u,d,w,E)=>(n._sqlite3session_diff=ee.sqlite3session_diff)(u,d,w,E),n._sqlite3session_attach=(u,d)=>(n._sqlite3session_attach=ee.sqlite3session_attach)(u,d),n._sqlite3session_create=(u,d,w)=>(n._sqlite3session_create=ee.sqlite3session_create)(u,d,w),n._sqlite3session_delete=u=>(n._sqlite3session_delete=ee.sqlite3session_delete)(u),n._sqlite3session_table_filter=(u,d,w)=>(n._sqlite3session_table_filter=ee.sqlite3session_table_filter)(u,d,w),n._sqlite3session_changeset=(u,d,w)=>(n._sqlite3session_changeset=ee.sqlite3session_changeset)(u,d,w),n._sqlite3session_changeset_strm=(u,d,w)=>(n._sqlite3session_changeset_strm=ee.sqlite3session_changeset_strm)(u,d,w),n._sqlite3session_patchset_strm=(u,d,w)=>(n._sqlite3session_patchset_strm=ee.sqlite3session_patchset_strm)(u,d,w),n._sqlite3session_patchset=(u,d,w)=>(n._sqlite3session_patchset=ee.sqlite3session_patchset)(u,d,w),n._sqlite3session_enable=(u,d)=>(n._sqlite3session_enable=ee.sqlite3session_enable)(u,d),n._sqlite3session_indirect=(u,d)=>(n._sqlite3session_indirect=ee.sqlite3session_indirect)(u,d),n._sqlite3session_isempty=u=>(n._sqlite3session_isempty=ee.sqlite3session_isempty)(u),n._sqlite3session_memory_used=u=>(n._sqlite3session_memory_used=ee.sqlite3session_memory_used)(u),n._sqlite3session_object_config=(u,d,w)=>(n._sqlite3session_object_config=ee.sqlite3session_object_config)(u,d,w),n._sqlite3session_changeset_size=u=>(n._sqlite3session_changeset_size=ee.sqlite3session_changeset_size)(u),n._sqlite3changeset_start=(u,d,w)=>(n._sqlite3changeset_start=ee.sqlite3changeset_start)(u,d,w),n._sqlite3changeset_start_v2=(u,d,w,E)=>(n._sqlite3changeset_start_v2=ee.sqlite3changeset_start_v2)(u,d,w,E),n._sqlite3changeset_start_strm=(u,d,w)=>(n._sqlite3changeset_start_strm=ee.sqlite3changeset_start_strm)(u,d,w),n._sqlite3changeset_start_v2_strm=(u,d,w,E)=>(n._sqlite3changeset_start_v2_strm=ee.sqlite3changeset_start_v2_strm)(u,d,w,E),n._sqlite3changeset_next=u=>(n._sqlite3changeset_next=ee.sqlite3changeset_next)(u),n._sqlite3changeset_op=(u,d,w,E,S)=>(n._sqlite3changeset_op=ee.sqlite3changeset_op)(u,d,w,E,S),n._sqlite3changeset_pk=(u,d,w)=>(n._sqlite3changeset_pk=ee.sqlite3changeset_pk)(u,d,w),n._sqlite3changeset_old=(u,d,w)=>(n._sqlite3changeset_old=ee.sqlite3changeset_old)(u,d,w),n._sqlite3changeset_new=(u,d,w)=>(n._sqlite3changeset_new=ee.sqlite3changeset_new)(u,d,w),n._sqlite3changeset_conflict=(u,d,w)=>(n._sqlite3changeset_conflict=ee.sqlite3changeset_conflict)(u,d,w),n._sqlite3changeset_fk_conflicts=(u,d)=>(n._sqlite3changeset_fk_conflicts=ee.sqlite3changeset_fk_conflicts)(u,d),n._sqlite3changeset_finalize=u=>(n._sqlite3changeset_finalize=ee.sqlite3changeset_finalize)(u),n._sqlite3changeset_invert=(u,d,w,E)=>(n._sqlite3changeset_invert=ee.sqlite3changeset_invert)(u,d,w,E),n._sqlite3changeset_invert_strm=(u,d,w,E)=>(n._sqlite3changeset_invert_strm=ee.sqlite3changeset_invert_strm)(u,d,w,E),n._sqlite3changeset_apply_v2=(u,d,w,E,S,P,J,ne,Ee)=>(n._sqlite3changeset_apply_v2=ee.sqlite3changeset_apply_v2)(u,d,w,E,S,P,J,ne,Ee),n._sqlite3changeset_apply=(u,d,w,E,S,P)=>(n._sqlite3changeset_apply=ee.sqlite3changeset_apply)(u,d,w,E,S,P),n._sqlite3changeset_apply_v2_strm=(u,d,w,E,S,P,J,ne,Ee)=>(n._sqlite3changeset_apply_v2_strm=ee.sqlite3changeset_apply_v2_strm)(u,d,w,E,S,P,J,ne,Ee),n._sqlite3changeset_apply_strm=(u,d,w,E,S,P)=>(n._sqlite3changeset_apply_strm=ee.sqlite3changeset_apply_strm)(u,d,w,E,S,P),n._sqlite3changegroup_new=u=>(n._sqlite3changegroup_new=ee.sqlite3changegroup_new)(u),n._sqlite3changegroup_add=(u,d,w)=>(n._sqlite3changegroup_add=ee.sqlite3changegroup_add)(u,d,w),n._sqlite3changegroup_output=(u,d,w)=>(n._sqlite3changegroup_output=ee.sqlite3changegroup_output)(u,d,w),n._sqlite3changegroup_add_strm=(u,d,w)=>(n._sqlite3changegroup_add_strm=ee.sqlite3changegroup_add_strm)(u,d,w),n._sqlite3changegroup_output_strm=(u,d,w)=>(n._sqlite3changegroup_output_strm=ee.sqlite3changegroup_output_strm)(u,d,w),n._sqlite3changegroup_delete=u=>(n._sqlite3changegroup_delete=ee.sqlite3changegroup_delete)(u),n._sqlite3changeset_concat=(u,d,w,E,S,P)=>(n._sqlite3changeset_concat=ee.sqlite3changeset_concat)(u,d,w,E,S,P),n._sqlite3changeset_concat_strm=(u,d,w,E,S,P)=>(n._sqlite3changeset_concat_strm=ee.sqlite3changeset_concat_strm)(u,d,w,E,S,P),n._sqlite3session_config=(u,d)=>(n._sqlite3session_config=ee.sqlite3session_config)(u,d),n._sqlite3_sourceid=()=>(n._sqlite3_sourceid=ee.sqlite3_sourceid)(),n._sqlite3__wasm_pstack_ptr=()=>(n._sqlite3__wasm_pstack_ptr=ee.sqlite3__wasm_pstack_ptr)(),n._sqlite3__wasm_pstack_restore=u=>(n._sqlite3__wasm_pstack_restore=ee.sqlite3__wasm_pstack_restore)(u),n._sqlite3__wasm_pstack_alloc=u=>(n._sqlite3__wasm_pstack_alloc=ee.sqlite3__wasm_pstack_alloc)(u),n._sqlite3__wasm_pstack_remaining=()=>(n._sqlite3__wasm_pstack_remaining=ee.sqlite3__wasm_pstack_remaining)(),n._sqlite3__wasm_pstack_quota=()=>(n._sqlite3__wasm_pstack_quota=ee.sqlite3__wasm_pstack_quota)(),n._sqlite3__wasm_db_error=(u,d,w)=>(n._sqlite3__wasm_db_error=ee.sqlite3__wasm_db_error)(u,d,w),n._sqlite3__wasm_test_struct=u=>(n._sqlite3__wasm_test_struct=ee.sqlite3__wasm_test_struct)(u),n._sqlite3__wasm_enum_json=()=>(n._sqlite3__wasm_enum_json=ee.sqlite3__wasm_enum_json)(),n._sqlite3__wasm_vfs_unlink=(u,d)=>(n._sqlite3__wasm_vfs_unlink=ee.sqlite3__wasm_vfs_unlink)(u,d),n._sqlite3__wasm_db_vfs=(u,d)=>(n._sqlite3__wasm_db_vfs=ee.sqlite3__wasm_db_vfs)(u,d),n._sqlite3__wasm_db_reset=u=>(n._sqlite3__wasm_db_reset=ee.sqlite3__wasm_db_reset)(u),n._sqlite3__wasm_db_export_chunked=(u,d)=>(n._sqlite3__wasm_db_export_chunked=ee.sqlite3__wasm_db_export_chunked)(u,d),n._sqlite3__wasm_db_serialize=(u,d,w,E,S)=>(n._sqlite3__wasm_db_serialize=ee.sqlite3__wasm_db_serialize)(u,d,w,E,S),n._sqlite3__wasm_vfs_create_file=(u,d,w,E)=>(n._sqlite3__wasm_vfs_create_file=ee.sqlite3__wasm_vfs_create_file)(u,d,w,E),n._sqlite3__wasm_posix_create_file=(u,d,w)=>(n._sqlite3__wasm_posix_create_file=ee.sqlite3__wasm_posix_create_file)(u,d,w),n._sqlite3__wasm_kvvfsMakeKeyOnPstack=(u,d)=>(n._sqlite3__wasm_kvvfsMakeKeyOnPstack=ee.sqlite3__wasm_kvvfsMakeKeyOnPstack)(u,d),n._sqlite3__wasm_kvvfs_methods=()=>(n._sqlite3__wasm_kvvfs_methods=ee.sqlite3__wasm_kvvfs_methods)(),n._sqlite3__wasm_vtab_config=(u,d,w)=>(n._sqlite3__wasm_vtab_config=ee.sqlite3__wasm_vtab_config)(u,d,w),n._sqlite3__wasm_db_config_ip=(u,d,w,E)=>(n._sqlite3__wasm_db_config_ip=ee.sqlite3__wasm_db_config_ip)(u,d,w,E),n._sqlite3__wasm_db_config_pii=(u,d,w,E,S)=>(n._sqlite3__wasm_db_config_pii=ee.sqlite3__wasm_db_config_pii)(u,d,w,E,S),n._sqlite3__wasm_db_config_s=(u,d,w)=>(n._sqlite3__wasm_db_config_s=ee.sqlite3__wasm_db_config_s)(u,d,w),n._sqlite3__wasm_config_i=(u,d)=>(n._sqlite3__wasm_config_i=ee.sqlite3__wasm_config_i)(u,d),n._sqlite3__wasm_config_ii=(u,d,w)=>(n._sqlite3__wasm_config_ii=ee.sqlite3__wasm_config_ii)(u,d,w),n._sqlite3__wasm_config_j=(u,d)=>(n._sqlite3__wasm_config_j=ee.sqlite3__wasm_config_j)(u,d),n._sqlite3__wasm_qfmt_token=(u,d)=>(n._sqlite3__wasm_qfmt_token=ee.sqlite3__wasm_qfmt_token)(u,d),n._sqlite3__wasm_init_wasmfs=u=>(n._sqlite3__wasm_init_wasmfs=ee.sqlite3__wasm_init_wasmfs)(u),n._sqlite3__wasm_test_intptr=u=>(n._sqlite3__wasm_test_intptr=ee.sqlite3__wasm_test_intptr)(u),n._sqlite3__wasm_test_voidptr=u=>(n._sqlite3__wasm_test_voidptr=ee.sqlite3__wasm_test_voidptr)(u),n._sqlite3__wasm_test_int64_max=()=>(n._sqlite3__wasm_test_int64_max=ee.sqlite3__wasm_test_int64_max)(),n._sqlite3__wasm_test_int64_min=()=>(n._sqlite3__wasm_test_int64_min=ee.sqlite3__wasm_test_int64_min)(),n._sqlite3__wasm_test_int64_times2=u=>(n._sqlite3__wasm_test_int64_times2=ee.sqlite3__wasm_test_int64_times2)(u),n._sqlite3__wasm_test_int64_minmax=(u,d)=>(n._sqlite3__wasm_test_int64_minmax=ee.sqlite3__wasm_test_int64_minmax)(u,d),n._sqlite3__wasm_test_int64ptr=u=>(n._sqlite3__wasm_test_int64ptr=ee.sqlite3__wasm_test_int64ptr)(u),n._sqlite3__wasm_test_stack_overflow=u=>(n._sqlite3__wasm_test_stack_overflow=ee.sqlite3__wasm_test_stack_overflow)(u),n._sqlite3__wasm_test_str_hello=u=>(n._sqlite3__wasm_test_str_hello=ee.sqlite3__wasm_test_str_hello)(u),n._sqlite3__wasm_SQLTester_strglob=(u,d)=>(n._sqlite3__wasm_SQLTester_strglob=ee.sqlite3__wasm_SQLTester_strglob)(u,d),n._malloc=u=>(n._malloc=ee.malloc)(u),n._free=u=>(n._free=ee.free)(u),n._realloc=(u,d)=>(n._realloc=ee.realloc)(u,d);var Em=(u,d)=>(Em=ee.emscripten_builtin_memalign)(u,d);n.wasmMemory=I;var Mu,vm;de=function u(){Mu||xm(),Mu||(de=u)};function xm(){if(G>0||!vm&&(vm=1,C(),G>0))return;function u(){Mu||(Mu=1,n.calledRun=1,!q&&(B(),s(n),n.onRuntimeInitialized?.(),M()))}n.setStatus?(n.setStatus("Running..."),setTimeout(()=>{setTimeout(()=>n.setStatus(""),1),u()},1)):u()}if(n.preInit)for(typeof n.preInit=="function"&&(n.preInit=[n.preInit]);n.preInit.length>0;)n.preInit.pop()();return xm(),n.runSQLite3PostLoadInit=function(u){if(globalThis.sqlite3ApiBootstrap=function d(w=globalThis.sqlite3ApiConfig||d.defaultConfig){if(d.sqlite3)return(d.sqlite3.config||console).warn("sqlite3ApiBootstrap() called multiple times.","Config and external initializers are ignored on calls after the first."),d.sqlite3;const E=Object.assign(Object.create(null),{exports:void 0,memory:void 0,bigIntEnabled:typeof n<"u"&&n.HEAPU64?!0:!!globalThis.BigInt64Array,debug:console.debug.bind(console),warn:console.warn.bind(console),error:console.error.bind(console),log:console.log.bind(console),wasmfsOpfsDir:"/opfs",useStdAlloc:!1},w||{});Object.assign(E,{allocExportName:E.useStdAlloc?"malloc":"sqlite3_malloc",deallocExportName:E.useStdAlloc?"free":"sqlite3_free",reallocExportName:E.useStdAlloc?"realloc":"sqlite3_realloc"},E),["exports","memory","wasmfsOpfsDir"].forEach(N=>{typeof E[N]=="function"&&(E[N]=E[N]())}),delete globalThis.sqlite3ApiConfig,delete d.defaultConfig;const S=Object.create(null),P=Object.create(null),J=N=>S.sqlite3_js_rc_str&&S.sqlite3_js_rc_str(N)||"Unknown result code #"+N,ne=N=>typeof N=="number"&&N===(N|0);class Ee extends Error{constructor(...W){let Z;if(W.length)if(ne(W[0]))if(Z=W[0],W.length===1)super(J(W[0]));else{const me=J(Z);typeof W[1]=="object"?super(me,W[1]):(W[0]=me+":",super(W.join(" ")))}else W.length===2&&typeof W[1]=="object"?super(...W):super(W.join(" "));this.resultCode=Z||S.SQLITE_ERROR,this.name="SQLite3Error"}}Ee.toss=(...N)=>{throw new Ee(...N)};const Ie=Ee.toss;E.wasmfsOpfsDir&&!/^\/[^/]+$/.test(E.wasmfsOpfsDir)&&Ie("config.wasmfsOpfsDir must be falsy or in the form '/dir-name'.");const qe=N=>typeof N!="bigint"&&N===(N|0)&&N<=2147483647&&N>=-2147483648,Oe=function N(W){return N._max||(N._max=BigInt("0x7fffffffffffffff"),N._min=~N._max),W>=N._min&&W<=N._max},be=N=>N>=-0x7fffffffn-1n&&N<=0x7fffffffn,he=function N(W){return N._min||(N._min=Number.MIN_SAFE_INTEGER,N._max=Number.MAX_SAFE_INTEGER),W>=N._min&&W<=N._max},Ae=N=>N&&N.constructor&&qe(N.constructor.BYTES_PER_ELEMENT)?N:!1,se=typeof SharedArrayBuffer>"u"?function(){}:SharedArrayBuffer,ae=N=>N.buffer instanceof se,ue=(N,W,Z)=>ae(N)?N.slice(W,Z):N.subarray(W,Z),Te=N=>N&&(N instanceof Uint8Array||N instanceof Int8Array||N instanceof ArrayBuffer),ve=N=>N&&(N instanceof Uint8Array||N instanceof Int8Array||N instanceof ArrayBuffer),fe=N=>Te(N)||Ie("Value is not of a supported TypedArray type."),xe=new TextDecoder("utf-8"),He=function(N,W,Z){return xe.decode(ue(N,W,Z))},K=function(N){return ve(N)?He(N instanceof ArrayBuffer?new Uint8Array(N):N):Array.isArray(N)?N.join(""):(P.isPtr(N)&&(N=P.cstrToJs(N)),N)};class X extends Error{constructor(...W){W.length===2&&typeof W[1]=="object"?super(...W):W.length?super(W.join(" ")):super("Allocation failed."),this.resultCode=S.SQLITE_NOMEM,this.name="WasmAllocError"}}X.toss=(...N)=>{throw new X(...N)},Object.assign(S,{sqlite3_bind_blob:void 0,sqlite3_bind_text:void 0,sqlite3_create_function_v2:(N,W,Z,me,De,Ye,Xe,it,ct)=>{},sqlite3_create_function:(N,W,Z,me,De,Ye,Xe,it)=>{},sqlite3_create_window_function:(N,W,Z,me,De,Ye,Xe,it,ct,Re)=>{},sqlite3_prepare_v3:(N,W,Z,me,De,Ye)=>{},sqlite3_prepare_v2:(N,W,Z,me,De)=>{},sqlite3_exec:(N,W,Z,me,De)=>{},sqlite3_randomness:(N,W)=>{}});const oe={affirmBindableTypedArray:fe,flexibleString:K,bigIntFits32:be,bigIntFits64:Oe,bigIntFitsDouble:he,isBindableTypedArray:Te,isInt32:qe,isSQLableTypedArray:ve,isTypedArray:Ae,typedArrayToString:He,isUIThread:()=>globalThis.window===globalThis&&!!globalThis.document,isSharedTypedArray:ae,toss:function(...N){throw new Error(N.join(" "))},toss3:Ie,typedArrayPart:ue,affirmDbHeader:function(N){N instanceof ArrayBuffer&&(N=new Uint8Array(N));const W="SQLite format 3";W.length>N.byteLength&&Ie("Input does not contain an SQLite3 database header.");for(let Z=0;Z<W.length;++Z)W.charCodeAt(Z)!==N[Z]&&Ie("Input does not contain an SQLite3 database header.")},affirmIsDb:function(N){N instanceof ArrayBuffer&&(N=new Uint8Array(N));const W=N.byteLength;(W<512||W%512!==0)&&Ie("Byte array size",W,"is invalid for an SQLite3 db."),oe.affirmDbHeader(N)}};Object.assign(P,{ptrSizeof:E.wasmPtrSizeof||4,ptrIR:E.wasmPtrIR||"i32",bigIntEnabled:!!E.bigIntEnabled,exports:E.exports||Ie("Missing API config.exports (WASM module exports)."),memory:E.memory||E.exports.memory||Ie("API config object requires a WebAssembly.Memory object","in either config.exports.memory (exported)","or config.memory (imported)."),alloc:void 0,realloc:void 0,dealloc:void 0}),P.allocFromTypedArray=function(N){N instanceof ArrayBuffer&&(N=new Uint8Array(N)),fe(N);const W=P.alloc(N.byteLength||1);return P.heapForSize(N.constructor).set(N.byteLength?N:[0],W),W};{const N=E.allocExportName,W=E.deallocExportName,Z=E.reallocExportName;for(const me of[N,W,Z])P.exports[me]instanceof Function||Ie("Missing required exports[",me,"] function.");P.alloc=function me(De){return me.impl(De)||X.toss("Failed to allocate",De," bytes.")},P.alloc.impl=P.exports[N],P.realloc=function me(De,Ye){const Xe=me.impl(De,Ye);return Ye?Xe||X.toss("Failed to reallocate",Ye," bytes."):0},P.realloc.impl=P.exports[Z],P.dealloc=P.exports[W]}P.compileOptionUsed=function N(W){if(arguments.length){if(Array.isArray(W)){const Z={};return W.forEach(me=>{Z[me]=S.sqlite3_compileoption_used(me)}),Z}else if(typeof W=="object")return Object.keys(W).forEach(Z=>{W[Z]=S.sqlite3_compileoption_used(Z)}),W}else{if(N._result)return N._result;N._opt||(N._rx=/^([^=]+)=(.+)/,N._rxInt=/^-?\d+$/,N._opt=function(Xe,it){const ct=N._rx.exec(Xe);it[0]=ct?ct[1]:Xe,it[1]=ct?N._rxInt.test(ct[2])?+ct[2]:ct[2]:!0});const Z={},me=[0,0];let De=0,Ye;for(;Ye=S.sqlite3_compileoption_get(De++);)N._opt(Ye,me),Z[me[0]]=me[1];return N._result=Z}return typeof W=="string"?!!S.sqlite3_compileoption_used(W):!1},P.pstack=Object.assign(Object.create(null),{restore:P.exports.sqlite3__wasm_pstack_restore,alloc:function(N){return typeof N=="string"&&!(N=P.sizeofIR(N))&&X.toss("Invalid value for pstack.alloc(",arguments[0],")"),P.exports.sqlite3__wasm_pstack_alloc(N)||X.toss("Could not allocate",N,"bytes from the pstack.")},allocChunks:function(N,W){typeof W=="string"&&!(W=P.sizeofIR(W))&&X.toss("Invalid size value for allocChunks(",arguments[1],")");const Z=P.pstack.alloc(N*W),me=[];let De=0,Ye=0;for(;De<N;++De,Ye+=W)me.push(Z+Ye);return me},allocPtr:(N=1,W=!0)=>N===1?P.pstack.alloc(W?8:P.ptrSizeof):P.pstack.allocChunks(N,W?8:P.ptrSizeof),call:function(N){const W=P.pstack.pointer;try{return N(te)}finally{P.pstack.restore(W)}}}),Object.defineProperties(P.pstack,{pointer:{configurable:!1,iterable:!0,writeable:!1,get:P.exports.sqlite3__wasm_pstack_ptr},quota:{configurable:!1,iterable:!0,writeable:!1,get:P.exports.sqlite3__wasm_pstack_quota},remaining:{configurable:!1,iterable:!0,writeable:!1,get:P.exports.sqlite3__wasm_pstack_remaining}}),S.sqlite3_randomness=(...N)=>{if(N.length===1&&oe.isTypedArray(N[0])&&N[0].BYTES_PER_ELEMENT===1){const W=N[0];if(W.byteLength===0)return P.exports.sqlite3_randomness(0,0),W;const Z=P.pstack.pointer;try{let me=W.byteLength,De=0;const Ye=P.exports.sqlite3_randomness,Xe=P.heap8u(),it=me<512?me:512,ct=P.pstack.alloc(it);do{const Re=me>it?it:me;Ye(Re,ct),W.set(ue(Xe,ct,ct+Re),De),me-=Re,De+=Re}while(me>0)}catch(me){console.error("Highly unexpected (and ignored!) exception in sqlite3_randomness():",me)}finally{P.pstack.restore(Z)}return W}P.exports.sqlite3_randomness(...N)};let Pe;if(S.sqlite3_wasmfs_opfs_dir=function(){if(Pe!==void 0)return Pe;const N=E.wasmfsOpfsDir;if(!N||!globalThis.FileSystemHandle||!globalThis.FileSystemDirectoryHandle||!globalThis.FileSystemFileHandle)return Pe="";try{return N&&P.xCallWrapped("sqlite3__wasm_init_wasmfs","i32",["string"],N)===0?Pe=N:Pe=""}catch{return Pe=""}},S.sqlite3_wasmfs_filename_is_persistent=function(N){const W=S.sqlite3_wasmfs_opfs_dir();return W&&N?N.startsWith(W+"/"):!1},S.sqlite3_js_db_uses_vfs=function(N,W,Z=0){try{const me=S.sqlite3_vfs_find(W);return me?N?me===S.sqlite3_js_db_vfs(N,Z)?me:!1:me===S.sqlite3_vfs_find(0)?me:!1:!1}catch{return!1}},S.sqlite3_js_vfs_list=function(){const N=[];let W=S.sqlite3_vfs_find(0);for(;W;){const Z=new S.sqlite3_vfs(W);N.push(P.cstrToJs(Z.$zName)),W=Z.$pNext,Z.dispose()}return N},S.sqlite3_js_db_export=function(N,W=0){N=P.xWrap.testConvertArg("sqlite3*",N),N||Ie("Invalid sqlite3* argument."),P.bigIntEnabled||Ie("BigInt64 support is not enabled.");const Z=P.scopedAllocPush();let me;try{const De=P.scopedAlloc(8+P.ptrSizeof),Ye=De+8,Xe=W?P.isPtr(W)?W:P.scopedAllocCString(""+W):0;let it=P.exports.sqlite3__wasm_db_serialize(N,Xe,Ye,De,0);it&&Ie("Database serialization failed with code",te.capi.sqlite3_js_rc_str(it)),me=P.peekPtr(Ye);const ct=P.peek(De,"i64");return it=ct?P.heap8u().slice(me,me+Number(ct)):new Uint8Array,it}finally{me&&P.exports.sqlite3_free(me),P.scopedAllocPop(Z)}},S.sqlite3_js_db_vfs=(N,W=0)=>oe.sqlite3__wasm_db_vfs(N,W),S.sqlite3_js_aggregate_context=(N,W)=>S.sqlite3_aggregate_context(N,W)||(W?X.toss("Cannot allocate",W,"bytes for sqlite3_aggregate_context()"):0),S.sqlite3_js_posix_create_file=function(N,W,Z){let me;W&&P.isPtr(W)?me=W:W instanceof ArrayBuffer||W instanceof Uint8Array?(me=P.allocFromTypedArray(W),(arguments.length<3||!oe.isInt32(Z)||Z<0)&&(Z=W.byteLength)):Ee.toss("Invalid 2nd argument for sqlite3_js_posix_create_file().");try{(!oe.isInt32(Z)||Z<0)&&Ee.toss("Invalid 3rd argument for sqlite3_js_posix_create_file().");const De=oe.sqlite3__wasm_posix_create_file(N,me,Z);De&&Ee.toss("Creation of file failed with sqlite3 result code",S.sqlite3_js_rc_str(De))}finally{P.dealloc(me)}},S.sqlite3_js_vfs_create_file=function(N,W,Z,me){E.warn("sqlite3_js_vfs_create_file() is deprecated and","should be avoided because it can lead to C-level crashes.","See its documentation for alternative options.");let De;Z?(P.isPtr(Z)?De=Z:Z instanceof ArrayBuffer&&(Z=new Uint8Array(Z)),Z instanceof Uint8Array?(De=P.allocFromTypedArray(Z),(arguments.length<4||!oe.isInt32(me)||me<0)&&(me=Z.byteLength)):Ee.toss("Invalid 3rd argument type for sqlite3_js_vfs_create_file().")):De=0,(!oe.isInt32(me)||me<0)&&(P.dealloc(De),Ee.toss("Invalid 4th argument for sqlite3_js_vfs_create_file()."));try{const Ye=oe.sqlite3__wasm_vfs_create_file(N,W,De,me);Ye&&Ee.toss("Creation of file failed with sqlite3 result code",S.sqlite3_js_rc_str(Ye))}finally{P.dealloc(De)}},S.sqlite3_js_sql_to_string=N=>{if(typeof N=="string")return N;const W=K(v);return W===v?void 0:W},oe.isUIThread()){const N=function(W){const Z=Object.create(null);return Z.prefix="kvvfs-"+W,Z.stores=[],(W==="session"||W==="")&&Z.stores.push(globalThis.sessionStorage),(W==="local"||W==="")&&Z.stores.push(globalThis.localStorage),Z};S.sqlite3_js_kvvfs_clear=function(W=""){let Z=0;const me=N(W);return me.stores.forEach(De=>{const Ye=[];let Xe;for(Xe=0;Xe<De.length;++Xe){const it=De.key(Xe);it.startsWith(me.prefix)&&Ye.push(it)}Ye.forEach(it=>De.removeItem(it)),Z+=Ye.length}),Z},S.sqlite3_js_kvvfs_size=function(W=""){let Z=0;const me=N(W);return me.stores.forEach(De=>{let Ye;for(Ye=0;Ye<De.length;++Ye){const Xe=De.key(Ye);Xe.startsWith(me.prefix)&&(Z+=Xe.length,Z+=De.getItem(Xe).length)}}),Z*2}}S.sqlite3_db_config=(function(N,W,...Z){switch(W){case S.SQLITE_DBCONFIG_ENABLE_FKEY:case S.SQLITE_DBCONFIG_ENABLE_TRIGGER:case S.SQLITE_DBCONFIG_ENABLE_FTS3_TOKENIZER:case S.SQLITE_DBCONFIG_ENABLE_LOAD_EXTENSION:case S.SQLITE_DBCONFIG_NO_CKPT_ON_CLOSE:case S.SQLITE_DBCONFIG_ENABLE_QPSG:case S.SQLITE_DBCONFIG_TRIGGER_EQP:case S.SQLITE_DBCONFIG_RESET_DATABASE:case S.SQLITE_DBCONFIG_DEFENSIVE:case S.SQLITE_DBCONFIG_WRITABLE_SCHEMA:case S.SQLITE_DBCONFIG_LEGACY_ALTER_TABLE:case S.SQLITE_DBCONFIG_DQS_DML:case S.SQLITE_DBCONFIG_DQS_DDL:case S.SQLITE_DBCONFIG_ENABLE_VIEW:case S.SQLITE_DBCONFIG_LEGACY_FILE_FORMAT:case S.SQLITE_DBCONFIG_TRUSTED_SCHEMA:case S.SQLITE_DBCONFIG_STMT_SCANSTATUS:case S.SQLITE_DBCONFIG_REVERSE_SCANORDER:case S.SQLITE_DBCONFIG_ENABLE_ATTACH_CREATE:case S.SQLITE_DBCONFIG_ENABLE_ATTACH_WRITE:case S.SQLITE_DBCONFIG_ENABLE_COMMENTS:return this.ip||(this.ip=P.xWrap("sqlite3__wasm_db_config_ip","int",["sqlite3*","int","int","*"])),this.ip(N,W,Z[0],Z[1]||0);case S.SQLITE_DBCONFIG_LOOKASIDE:return this.pii||(this.pii=P.xWrap("sqlite3__wasm_db_config_pii","int",["sqlite3*","int","*","int","int"])),this.pii(N,W,Z[0],Z[1],Z[2]);case S.SQLITE_DBCONFIG_MAINDBNAME:return this.s||(this.s=P.xWrap("sqlite3__wasm_db_config_s","int",["sqlite3*","int","string:static"])),this.s(N,W,Z[0]);default:return S.SQLITE_MISUSE}}).bind(Object.create(null)),S.sqlite3_value_to_js=function(N,W=!0){let Z;const me=S.sqlite3_value_type(N);switch(me){case S.SQLITE_INTEGER:P.bigIntEnabled?(Z=S.sqlite3_value_int64(N),oe.bigIntFitsDouble(Z)&&(Z=Number(Z))):Z=S.sqlite3_value_double(N);break;case S.SQLITE_FLOAT:Z=S.sqlite3_value_double(N);break;case S.SQLITE_TEXT:Z=S.sqlite3_value_text(N);break;case S.SQLITE_BLOB:{const De=S.sqlite3_value_bytes(N),Ye=S.sqlite3_value_blob(N);De&&!Ye&&te.WasmAllocError.toss("Cannot allocate memory for blob argument of",De,"byte(s)"),Z=De?P.heap8u().slice(Ye,Ye+Number(De)):null;break}case S.SQLITE_NULL:Z=null;break;default:W&&Ie(S.SQLITE_MISMATCH,"Unhandled sqlite3_value_type():",me),Z=void 0}return Z},S.sqlite3_values_to_js=function(N,W,Z=!0){let me;const De=[];for(me=0;me<N;++me)De.push(S.sqlite3_value_to_js(P.peekPtr(W+P.ptrSizeof*me),Z));return De},S.sqlite3_result_error_js=function(N,W){W instanceof X?S.sqlite3_result_error_nomem(N):S.sqlite3_result_error(N,""+W,-1)},S.sqlite3_result_js=function(N,W){if(W instanceof Error){S.sqlite3_result_error_js(N,W);return}try{switch(typeof W){case"undefined":break;case"boolean":S.sqlite3_result_int(N,W?1:0);break;case"bigint":oe.bigIntFits32(W)?S.sqlite3_result_int(N,Number(W)):oe.bigIntFitsDouble(W)?S.sqlite3_result_double(N,Number(W)):P.bigIntEnabled?oe.bigIntFits64(W)?S.sqlite3_result_int64(N,W):Ie("BigInt value",W.toString(),"is too BigInt for int64."):Ie("BigInt value",W.toString(),"is too BigInt.");break;case"number":{let Z;oe.isInt32(W)?Z=S.sqlite3_result_int:P.bigIntEnabled&&Number.isInteger(W)&&oe.bigIntFits64(BigInt(W))?Z=S.sqlite3_result_int64:Z=S.sqlite3_result_double,Z(N,W);break}case"string":{const[Z,me]=P.allocCString(W,!0);S.sqlite3_result_text(N,Z,me,S.SQLITE_WASM_DEALLOC);break}case"object":if(W===null){S.sqlite3_result_null(N);break}else if(oe.isBindableTypedArray(W)){const Z=P.allocFromTypedArray(W);S.sqlite3_result_blob(N,Z,W.byteLength,S.SQLITE_WASM_DEALLOC);break}default:Ie("Don't not how to handle this UDF result value:",typeof W,W)}}catch(Z){S.sqlite3_result_error_js(N,Z)}},S.sqlite3_column_js=function(N,W,Z=!0){const me=S.sqlite3_column_value(N,W);return me===0?void 0:S.sqlite3_value_to_js(me,Z)};const Q=(function(N,W,Z){Z=S[Z],this.ptr?P.pokePtr(this.ptr,0):this.ptr=P.allocPtr();const me=Z(N,W,this.ptr);if(me)return Ee.toss(me,arguments[2]+"() failed with code "+me);const De=P.peekPtr(this.ptr);return De?S.sqlite3_value_to_js(De,!0):void 0}).bind(Object.create(null));S.sqlite3_preupdate_new_js=(N,W)=>Q(N,W,"sqlite3_preupdate_new"),S.sqlite3_preupdate_old_js=(N,W)=>Q(N,W,"sqlite3_preupdate_old"),S.sqlite3changeset_new_js=(N,W)=>Q(N,W,"sqlite3changeset_new"),S.sqlite3changeset_old_js=(N,W)=>Q(N,W,"sqlite3changeset_old");const te={WasmAllocError:X,SQLite3Error:Ee,capi:S,util:oe,wasm:P,config:E,version:Object.create(null),client:void 0,asyncPostInit:async function N(){if(N.isReady instanceof Promise)return N.isReady;let W=d.initializersAsync;delete d.initializersAsync;const Z=async()=>(te.__isUnderTest||(delete te.util,delete te.StructBinder),te),me=Ye=>{throw E.error("an async sqlite3 initializer failed:",Ye),Ye};if(!W||!W.length)return N.isReady=Z().catch(me);W=W.map(Ye=>Ye instanceof Function?async Xe=>Ye(te):Ye),W.push(Z);let De=Promise.resolve(te);for(;W.length;)De=De.then(W.shift());return N.isReady=De.catch(me)},scriptInfo:void 0};try{d.initializers.forEach(N=>{N(te)})}catch(N){throw console.error("sqlite3 bootstrap initializer threw:",N),N}return delete d.initializers,d.sqlite3=te,te},globalThis.sqlite3ApiBootstrap.initializers=[],globalThis.sqlite3ApiBootstrap.initializersAsync=[],globalThis.sqlite3ApiBootstrap.defaultConfig=Object.create(null),globalThis.sqlite3ApiBootstrap.sqlite3=void 0,globalThis.WhWasmUtilInstaller=function(d){d.bigIntEnabled===void 0&&(d.bigIntEnabled=!!globalThis.BigInt64Array);const w=(...K)=>{throw new Error(K.join(" "))};d.exports||Object.defineProperty(d,"exports",{enumerable:!0,configurable:!0,get:()=>d.instance&&d.instance.exports});const E=d.pointerIR||"i32",S=d.ptrSizeof=E==="i32"?4:E==="i64"?8:w("Unhandled ptrSizeof:",E),P=Object.create(null);P.heapSize=0,P.memory=null,P.freeFuncIndexes=[],P.scopedAlloc=[],P.utf8Decoder=new TextDecoder,P.utf8Encoder=new TextEncoder("utf-8"),d.sizeofIR=K=>{switch(K){case"i8":return 1;case"i16":return 2;case"i32":case"f32":case"float":return 4;case"i64":case"f64":case"double":return 8;case"*":return S;default:return(""+K).endsWith("*")?S:void 0}};const J=function(){if(!P.memory)P.memory=d.memory instanceof WebAssembly.Memory?d.memory:d.exports.memory;else if(P.heapSize===P.memory.buffer.byteLength)return P;const K=P.memory.buffer;return P.HEAP8=new Int8Array(K),P.HEAP8U=new Uint8Array(K),P.HEAP16=new Int16Array(K),P.HEAP16U=new Uint16Array(K),P.HEAP32=new Int32Array(K),P.HEAP32U=new Uint32Array(K),d.bigIntEnabled&&(P.HEAP64=new BigInt64Array(K),P.HEAP64U=new BigUint64Array(K)),P.HEAP32F=new Float32Array(K),P.HEAP64F=new Float64Array(K),P.heapSize=K.byteLength,P};d.heap8=()=>J().HEAP8,d.heap8u=()=>J().HEAP8U,d.heap16=()=>J().HEAP16,d.heap16u=()=>J().HEAP16U,d.heap32=()=>J().HEAP32,d.heap32u=()=>J().HEAP32U,d.heapForSize=function(K,X=!0){const oe=P.memory&&P.heapSize===P.memory.buffer.byteLength?P:J();switch(K){case Int8Array:return oe.HEAP8;case Uint8Array:return oe.HEAP8U;case Int16Array:return oe.HEAP16;case Uint16Array:return oe.HEAP16U;case Int32Array:return oe.HEAP32;case Uint32Array:return oe.HEAP32U;case 8:return X?oe.HEAP8U:oe.HEAP8;case 16:return X?oe.HEAP16U:oe.HEAP16;case 32:return X?oe.HEAP32U:oe.HEAP32;case 64:if(oe.HEAP64)return X?oe.HEAP64U:oe.HEAP64;break;default:if(d.bigIntEnabled){if(K===globalThis.BigUint64Array)return oe.HEAP64U;if(K===globalThis.BigInt64Array)return oe.HEAP64;break}}w("Invalid heapForSize() size: expecting 8, 16, 32,","or (if BigInt is enabled) 64.")},d.functionTable=function(){return d.exports.__indirect_function_table},d.functionEntry=function(K){const X=d.functionTable();return K<X.length?X.get(K):void 0},d.jsFuncToWasm=function K(X,oe){if(K._||(K._={sigTypes:Object.assign(Object.create(null),{i:"i32",p:"i32",P:"i32",s:"i32",j:"i64",f:"f32",d:"f64"}),typeCodes:Object.assign(Object.create(null),{f64:124,f32:125,i64:126,i32:127}),uleb128Encode:function(te,N,W){W<128?te[N](W):te[N](W%128|128,W>>7)},rxJSig:/^(\w)\((\w*)\)$/,sigParams:function(te){const N=K._.rxJSig.exec(te);return N?N[2]:te.substr(1)},letterType:te=>K._.sigTypes[te]||w("Invalid signature letter:",te),pushSigType:(te,N)=>te.push(K._.typeCodes[K._.letterType(N)])}),typeof X=="string"){const te=oe;oe=X,X=te}const Pe=K._.sigParams(oe),Q=[1,96];K._.uleb128Encode(Q,"push",Pe.length);for(const te of Pe)K._.pushSigType(Q,te);return oe[0]==="v"?Q.push(0):(Q.push(1),K._.pushSigType(Q,oe[0])),K._.uleb128Encode(Q,"unshift",Q.length),Q.unshift(0,97,115,109,1,0,0,0,1),Q.push(2,7,1,1,101,1,102,0,0,7,5,1,1,102,0,0),new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array(Q)),{e:{f:X}}).exports.f};const ne=function(X,oe,Pe){if(Pe&&!P.scopedAlloc.length&&w("No scopedAllocPush() scope is active."),typeof X=="string"){const W=oe;oe=X,X=W}(typeof oe!="string"||!(X instanceof Function))&&w("Invalid arguments: expecting (function,signature) or (signature,function).");const Q=d.functionTable(),te=Q.length;let N;for(;P.freeFuncIndexes.length&&(N=P.freeFuncIndexes.pop(),Q.get(N));){N=null;continue}N||(N=te,Q.grow(1));try{return Q.set(N,X),Pe&&P.scopedAlloc[P.scopedAlloc.length-1].push(N),N}catch(W){if(!(W instanceof TypeError))throw N===te&&P.freeFuncIndexes.push(te),W}try{const W=d.jsFuncToWasm(X,oe);Q.set(N,W),Pe&&P.scopedAlloc[P.scopedAlloc.length-1].push(N)}catch(W){throw N===te&&P.freeFuncIndexes.push(te),W}return N};d.installFunction=(K,X)=>ne(K,X,!1),d.scopedInstallFunction=(K,X)=>ne(K,X,!0),d.uninstallFunction=function(K){if(!K&&K!==0)return;const X=P.freeFuncIndexes,oe=d.functionTable();X.push(K);const Pe=oe.get(K);return oe.set(K,null),Pe},d.peek=function(X,oe="i8"){oe.endsWith("*")&&(oe=E);const Pe=P.memory&&P.heapSize===P.memory.buffer.byteLength?P:J(),Q=Array.isArray(X)?[]:void 0;let te;do{switch(Q&&(X=arguments[0].shift()),oe){case"i1":case"i8":te=Pe.HEAP8[X>>0];break;case"i16":te=Pe.HEAP16[X>>1];break;case"i32":te=Pe.HEAP32[X>>2];break;case"float":case"f32":te=Pe.HEAP32F[X>>2];break;case"double":case"f64":te=Number(Pe.HEAP64F[X>>3]);break;case"i64":if(d.bigIntEnabled){te=BigInt(Pe.HEAP64[X>>3]);break}default:w("Invalid type for peek():",oe)}Q&&Q.push(te)}while(Q&&arguments[0].length);return Q||te},d.poke=function(K,X,oe="i8"){oe.endsWith("*")&&(oe=E);const Pe=P.memory&&P.heapSize===P.memory.buffer.byteLength?P:J();for(const Q of Array.isArray(K)?K:[K])switch(oe){case"i1":case"i8":Pe.HEAP8[Q>>0]=X;continue;case"i16":Pe.HEAP16[Q>>1]=X;continue;case"i32":Pe.HEAP32[Q>>2]=X;continue;case"float":case"f32":Pe.HEAP32F[Q>>2]=X;continue;case"double":case"f64":Pe.HEAP64F[Q>>3]=X;continue;case"i64":if(Pe.HEAP64){Pe.HEAP64[Q>>3]=BigInt(X);continue}default:w("Invalid type for poke(): "+oe)}return this},d.peekPtr=(...K)=>d.peek(K.length===1?K[0]:K,E),d.pokePtr=(K,X=0)=>d.poke(K,X,E),d.peek8=(...K)=>d.peek(K.length===1?K[0]:K,"i8"),d.poke8=(K,X)=>d.poke(K,X,"i8"),d.peek16=(...K)=>d.peek(K.length===1?K[0]:K,"i16"),d.poke16=(K,X)=>d.poke(K,X,"i16"),d.peek32=(...K)=>d.peek(K.length===1?K[0]:K,"i32"),d.poke32=(K,X)=>d.poke(K,X,"i32"),d.peek64=(...K)=>d.peek(K.length===1?K[0]:K,"i64"),d.poke64=(K,X)=>d.poke(K,X,"i64"),d.peek32f=(...K)=>d.peek(K.length===1?K[0]:K,"f32"),d.poke32f=(K,X)=>d.poke(K,X,"f32"),d.peek64f=(...K)=>d.peek(K.length===1?K[0]:K,"f64"),d.poke64f=(K,X)=>d.poke(K,X,"f64"),d.getMemValue=d.peek,d.getPtrValue=d.peekPtr,d.setMemValue=d.poke,d.setPtrValue=d.pokePtr,d.isPtr32=K=>typeof K=="number"&&K===(K|0)&&K>=0,d.isPtr=d.isPtr32,d.cstrlen=function(K){if(!K||!d.isPtr(K))return null;const X=J().HEAP8U;let oe=K;for(;X[oe]!==0;++oe);return oe-K};const Ee=typeof SharedArrayBuffer>"u"?function(){}:SharedArrayBuffer,Ie=function(K,X,oe){return P.utf8Decoder.decode(K.buffer instanceof Ee?K.slice(X,oe):K.subarray(X,oe))};d.cstrToJs=function(K){const X=d.cstrlen(K);return X?Ie(J().HEAP8U,K,K+X):X===null?X:""},d.jstrlen=function(K){if(typeof K!="string")return null;const X=K.length;let oe=0;for(let Pe=0;Pe<X;++Pe){let Q=K.charCodeAt(Pe);Q>=55296&&Q<=57343&&(Q=65536+((Q&1023)<<10)|K.charCodeAt(++Pe)&1023),Q<=127?++oe:Q<=2047?oe+=2:Q<=65535?oe+=3:oe+=4}return oe},d.jstrcpy=function(K,X,oe=0,Pe=-1,Q=!0){if((!X||!(X instanceof Int8Array)&&!(X instanceof Uint8Array))&&w("jstrcpy() target must be an Int8Array or Uint8Array."),Pe<0&&(Pe=X.length-oe),!(Pe>0)||!(oe>=0))return 0;let te=0,N=K.length;const W=oe,Z=oe+Pe-(Q?1:0);for(;te<N&&oe<Z;++te){let me=K.charCodeAt(te);if(me>=55296&&me<=57343&&(me=65536+((me&1023)<<10)|K.charCodeAt(++te)&1023),me<=127){if(oe>=Z)break;X[oe++]=me}else if(me<=2047){if(oe+1>=Z)break;X[oe++]=192|me>>6,X[oe++]=128|me&63}else if(me<=65535){if(oe+2>=Z)break;X[oe++]=224|me>>12,X[oe++]=128|me>>6&63,X[oe++]=128|me&63}else{if(oe+3>=Z)break;X[oe++]=240|me>>18,X[oe++]=128|me>>12&63,X[oe++]=128|me>>6&63,X[oe++]=128|me&63}}return Q&&(X[oe++]=0),oe-W},d.cstrncpy=function(K,X,oe){if((!K||!X)&&w("cstrncpy() does not accept NULL strings."),oe<0)oe=d.cstrlen(strPtr)+1;else if(!(oe>0))return 0;const Pe=d.heap8u();let Q=0,te;for(;Q<oe&&(te=Pe[X+Q]);++Q)Pe[K+Q]=te;return Q<oe&&(Pe[K+Q++]=0),Q},d.jstrToUintArray=(K,X=!1)=>P.utf8Encoder.encode(X?K+"\0":K);const qe=(K,X)=>{(!(K.alloc instanceof Function)||!(K.dealloc instanceof Function))&&w("Object is missing alloc() and/or dealloc() function(s)","required by",X+"().")},Oe=function(K,X,oe,Pe){if(qe(d,Pe),typeof K!="string")return null;{const Q=P.utf8Encoder.encode(K),te=oe(Q.length+1),N=J().HEAP8U;return N.set(Q,te),N[te+Q.length]=0,X?[te,Q.length]:te}};d.allocCString=(K,X=!1)=>Oe(K,X,d.alloc,"allocCString()"),d.scopedAllocPush=function(){qe(d,"scopedAllocPush");const K=[];return P.scopedAlloc.push(K),K},d.scopedAllocPop=function(K){qe(d,"scopedAllocPop");const X=arguments.length?P.scopedAlloc.indexOf(K):P.scopedAlloc.length-1;X<0&&w("Invalid state object for scopedAllocPop()."),arguments.length===0&&(K=P.scopedAlloc[X]),P.scopedAlloc.splice(X,1);for(let oe;oe=K.pop();)d.functionEntry(oe)?d.uninstallFunction(oe):d.dealloc(oe)},d.scopedAlloc=function(K){P.scopedAlloc.length||w("No scopedAllocPush() scope is active.");const X=d.alloc(K);return P.scopedAlloc[P.scopedAlloc.length-1].push(X),X},Object.defineProperty(d.scopedAlloc,"level",{configurable:!1,enumerable:!1,get:()=>P.scopedAlloc.length,set:()=>w("The 'active' property is read-only.")}),d.scopedAllocCString=(K,X=!1)=>Oe(K,X,d.scopedAlloc,"scopedAllocCString()");const be=function(K,X){const oe=d[K?"scopedAlloc":"alloc"]((X.length+1)*d.ptrSizeof);let Pe=0;return X.forEach(Q=>{d.pokePtr(oe+d.ptrSizeof*Pe++,d[K?"scopedAllocCString":"allocCString"](""+Q))}),d.pokePtr(oe+d.ptrSizeof*Pe,0),oe};d.scopedAllocMainArgv=K=>be(!0,K),d.allocMainArgv=K=>be(!1,K),d.cArgvToJs=(K,X)=>{const oe=[];for(let Pe=0;Pe<K;++Pe){const Q=d.peekPtr(X+d.ptrSizeof*Pe);oe.push(Q?d.cstrToJs(Q):null)}return oe},d.scopedAllocCall=function(K){d.scopedAllocPush();try{return K()}finally{d.scopedAllocPop()}};const he=function(K,X,oe){qe(d,oe);const Pe=X?"i64":E;let Q=d[oe](K*(X?8:S));if(d.poke(Q,0,Pe),K===1)return Q;const te=[Q];for(let N=1;N<K;++N)Q+=X?8:S,te[N]=Q,d.poke(Q,0,Pe);return te};d.allocPtr=(K=1,X=!0)=>he(K,X,"alloc"),d.scopedAllocPtr=(K=1,X=!0)=>he(K,X,"scopedAlloc"),d.xGet=function(K){return d.exports[K]||w("Cannot find exported symbol:",K)};const Ae=(K,X)=>w(K+"() requires",X,"argument(s).");d.xCall=function(K,...X){const oe=K instanceof Function?K:d.xGet(K);return oe instanceof Function||w("Exported symbol",K,"is not a function."),oe.length!==X.length&&Ae(oe===K?oe.name:K,oe.length),arguments.length===2&&Array.isArray(arguments[1])?oe.apply(null,arguments[1]):oe.apply(null,X)},P.xWrap=Object.create(null),P.xWrap.convert=Object.create(null),P.xWrap.convert.arg=new Map,P.xWrap.convert.result=new Map;const se=P.xWrap.convert.arg,ae=P.xWrap.convert.result;d.bigIntEnabled&&se.set("i64",K=>BigInt(K));const ue=E==="i32"?K=>K|0:K=>BigInt(K)|BigInt(0);se.set("i32",ue).set("i16",K=>(K|0)&65535).set("i8",K=>(K|0)&255).set("f32",K=>Number(K).valueOf()).set("float",se.get("f32")).set("f64",se.get("f32")).set("double",se.get("f64")).set("int",se.get("i32")).set("null",K=>K).set(null,se.get("null")).set("**",ue).set("*",ue),ae.set("*",ue).set("pointer",ue).set("number",K=>Number(K)).set("void",K=>{}).set("null",K=>K).set(null,ae.get("null"));{const K=["i8","i16","i32","int","f32","float","f64","double"];d.bigIntEnabled&&K.push("i64");const X=se.get(E);for(const oe of K)se.set(oe+"*",X),ae.set(oe+"*",X),ae.set(oe,se.get(oe)||w("Missing arg converter:",oe))}const Te=function(K){return typeof K=="string"?d.scopedAllocCString(K):K?ue(K):null};se.set("string",Te).set("utf8",Te).set("pointer",Te),ae.set("string",K=>d.cstrToJs(K)).set("utf8",ae.get("string")).set("string:dealloc",K=>{try{return K?d.cstrToJs(K):null}finally{d.dealloc(K)}}).set("utf8:dealloc",ae.get("string:dealloc")).set("json",K=>JSON.parse(d.cstrToJs(K))).set("json:dealloc",K=>{try{return K?JSON.parse(d.cstrToJs(K)):null}finally{d.dealloc(K)}});const ve=class{constructor(K){this.name=K.name||"unnamed adapter"}convertArg(K,X,oe){w("AbstractArgAdapter must be subclassed.")}};se.FuncPtrAdapter=class Ss extends ve{constructor(X){super(X),se.FuncPtrAdapter.warnOnUse&&console.warn("xArg.FuncPtrAdapter is an internal-only API","and is not intended to be invoked from","client-level code. Invoked with:",X),this.name=X.name||"unnamed",this.signature=X.signature,X.contextKey instanceof Function&&(this.contextKey=X.contextKey,X.bindScope||(X.bindScope="context")),this.bindScope=X.bindScope||w("FuncPtrAdapter options requires a bindScope (explicit or implied)."),Ss.bindScopes.indexOf(X.bindScope)<0&&w("Invalid options.bindScope ("+X.bindMod+") for FuncPtrAdapter. Expecting one of: ("+Ss.bindScopes.join(", ")+")"),this.isTransient=this.bindScope==="transient",this.isContext=this.bindScope==="context",this.isPermanent=this.bindScope==="permanent",this.singleton=this.bindScope==="singleton"?[]:void 0,this.callProxy=X.callProxy instanceof Function?X.callProxy:void 0}contextKey(X,oe){return this}contextMap(X){const oe=this.__cmap||(this.__cmap=new Map);let Pe=oe.get(X);return Pe===void 0&&oe.set(X,Pe=[]),Pe}convertArg(X,oe,Pe){let Q=this.singleton;if(!Q&&this.isContext&&(Q=this.contextMap(this.contextKey(oe,Pe))),Q&&Q[0]===X)return Q[1];if(X instanceof Function){this.callProxy&&(X=this.callProxy(X));const te=ne(X,this.signature,this.isTransient);if(Ss.debugFuncInstall&&Ss.debugOut("FuncPtrAdapter installed",this,this.contextKey(oe,Pe),"@"+te,X),Q){if(Q[1]){Ss.debugFuncInstall&&Ss.debugOut("FuncPtrAdapter uninstalling",this,this.contextKey(oe,Pe),"@"+Q[1],X);try{P.scopedAlloc[P.scopedAlloc.length-1].push(Q[1])}catch{}}Q[0]=X,Q[1]=te}return te}else if(d.isPtr(X)||X===null||X===void 0){if(Q&&Q[1]&&Q[1]!==X){Ss.debugFuncInstall&&Ss.debugOut("FuncPtrAdapter uninstalling",this,this.contextKey(oe,Pe),"@"+Q[1],X);try{P.scopedAlloc[P.scopedAlloc.length-1].push(Q[1])}catch{}Q[0]=Q[1]=X|0}return X||0}else throw new TypeError("Invalid FuncPtrAdapter argument type. Expecting a function pointer or a "+(this.name?this.name+" ":"")+"function matching signature "+this.signature+".")}},se.FuncPtrAdapter.warnOnUse=!1,se.FuncPtrAdapter.debugFuncInstall=!1,se.FuncPtrAdapter.debugOut=console.debug.bind(console),se.FuncPtrAdapter.bindScopes=["transient","context","singleton","permanent"];const fe=K=>se.get(K)||w("Argument adapter not found:",K),xe=K=>ae.get(K)||w("Result adapter not found:",K);P.xWrap.convertArg=(K,...X)=>fe(K)(...X),P.xWrap.convertArgNoCheck=(K,...X)=>se.get(K)(...X),P.xWrap.convertResult=(K,X)=>K===null?X:K?xe(K)(X):void 0,P.xWrap.convertResultNoCheck=(K,X)=>K===null?X:K?ae.get(K)(X):void 0,d.xWrap=function(K,X,...oe){arguments.length===3&&Array.isArray(arguments[2])&&(oe=arguments[2]),d.isPtr(K)&&(K=d.functionEntry(K)||w("Function pointer not found in WASM function table."));const Pe=K instanceof Function,Q=Pe?K:d.xGet(K);if(Pe&&(K=Q.name||"unnamed function"),oe.length!==Q.length&&Ae(K,Q.length),X===null&&Q.length===0)return Q;X!=null&&xe(X);for(const N of oe)N instanceof ve?se.set(N,(...W)=>N.convertArg(...W)):fe(N);const te=P.xWrap;return Q.length===0?(...N)=>N.length?Ae(K,Q.length):te.convertResult(X,Q.call(null)):function(...N){N.length!==Q.length&&Ae(K,Q.length);const W=d.scopedAllocPush();try{let Z=0;for(;Z<N.length;++Z)N[Z]=te.convertArgNoCheck(oe[Z],N[Z],N,Z);return te.convertResultNoCheck(X,Q.apply(null,N))}finally{d.scopedAllocPop(W)}}};const He=function(K,X,oe,Pe,Q,te){if(typeof oe=="string"){if(X===1)return te.get(oe);if(X===2){if(Pe)Pe instanceof Function||w(Q,"requires a function argument.");else return te.delete(oe),K;return te.set(oe,Pe),K}}w("Invalid arguments to",Q)};return d.xWrap.resultAdapter=function K(X,oe){return He(K,arguments.length,X,oe,"resultAdapter()",ae)},d.xWrap.argAdapter=function K(X,oe){return He(K,arguments.length,X,oe,"argAdapter()",se)},d.xWrap.FuncPtrAdapter=se.FuncPtrAdapter,d.xCallWrapped=function(K,X,oe,...Pe){return Array.isArray(arguments[3])&&(Pe=arguments[3]),d.xWrap(K,X,oe||[]).apply(null,Pe||[])},d.xWrap.testConvertArg=P.xWrap.convertArg,d.xWrap.testConvertResult=P.xWrap.convertResult,d},globalThis.WhWasmUtilInstaller.yawl=(function(d){const w=()=>fetch(d.uri,{credentials:"same-origin"}),E=this,S=function(J){if(d.wasmUtilTarget){const ne=(...Ie)=>{throw new Error(Ie.join(" "))},Ee=d.wasmUtilTarget;if(Ee.module=J.module,Ee.instance=J.instance,Ee.instance.exports.memory||(Ee.memory=d.imports&&d.imports.env&&d.imports.env.memory||ne("Missing 'memory' object!")),!Ee.alloc&&J.instance.exports.malloc){const Ie=J.instance.exports;Ee.alloc=function(qe){return Ie.malloc(qe)||ne("Allocation of",qe,"bytes failed.")},Ee.dealloc=function(qe){Ie.free(qe)}}E(Ee)}return d.onload&&d.onload(J,d),J};return WebAssembly.instantiateStreaming?function(){return WebAssembly.instantiateStreaming(w(),d.imports||{}).then(S)}:function(){return w().then(ne=>ne.arrayBuffer()).then(ne=>WebAssembly.instantiate(ne,d.imports||{})).then(S)}}).bind(globalThis.WhWasmUtilInstaller),globalThis.Jaccwabyt=function d(w){const E=(...we)=>{throw new Error(we.join(" "))};!(w.heap instanceof WebAssembly.Memory)&&!(w.heap instanceof Function)&&E("config.heap must be WebAssembly.Memory instance or a function."),["alloc","dealloc"].forEach(function(we){w[we]instanceof Function||E("Config option '"+we+"' must be a function.")});const S=d,P=w.heap instanceof Function?w.heap:()=>new Uint8Array(w.heap.buffer),J=w.alloc,ne=w.dealloc,Ee=w.log||console.log.bind(console),Ie=w.memberPrefix||"",qe=w.memberSuffix||"",Oe=w.bigIntEnabled===void 0?!!globalThis.BigInt64Array:!!w.bigIntEnabled,be=globalThis.BigInt,he=globalThis.BigInt64Array,Ae=w.ptrSizeof||4,se=w.ptrIR||"i32";S.debugFlags||(S.__makeDebugFlags=function(we=null){we&&we.__flags&&(we=we.__flags);const Ne=function Ve(ze){return arguments.length===0?Ve.__flags:(ze<0?(delete Ve.__flags.getter,delete Ve.__flags.setter,delete Ve.__flags.alloc,delete Ve.__flags.dealloc):(Ve.__flags.getter=(1&ze)!==0,Ve.__flags.setter=(2&ze)!==0,Ve.__flags.alloc=(4&ze)!==0,Ve.__flags.dealloc=(8&ze)!==0),Ve._flags)};return Object.defineProperty(Ne,"__flags",{iterable:!1,writable:!1,value:Object.create(we)}),we||Ne(0),Ne},S.debugFlags=S.__makeDebugFlags());const ae=(function(){const we=new ArrayBuffer(2);return new DataView(we).setInt16(0,256,!0),new Int16Array(we)[0]===256})(),ue=we=>we[1]==="(",Te=we=>we==="P",ve=we=>ue(we)?"p":we[0],fe=function(we){switch(ve(we)){case"c":case"C":return"i8";case"i":return"i32";case"p":case"P":case"s":return se;case"j":return"i64";case"f":return"float";case"d":return"double"}E("Unhandled signature IR:",we)},xe=he?()=>!0:()=>E("BigInt64Array is not available."),He=function(we){switch(ve(we)){case"p":case"P":case"s":{switch(Ae){case 4:return"getInt32";case 8:return xe()&&"getBigInt64"}break}case"i":return"getInt32";case"c":return"getInt8";case"C":return"getUint8";case"j":return xe()&&"getBigInt64";case"f":return"getFloat32";case"d":return"getFloat64"}E("Unhandled DataView getter for signature:",we)},K=function(we){switch(ve(we)){case"p":case"P":case"s":{switch(Ae){case 4:return"setInt32";case 8:return xe()&&"setBigInt64"}break}case"i":return"setInt32";case"c":return"setInt8";case"C":return"setUint8";case"j":return xe()&&"setBigInt64";case"f":return"setFloat32";case"d":return"setFloat64"}E("Unhandled DataView setter for signature:",we)},X=function(we){switch(ve(we)){case"i":case"f":case"c":case"C":case"d":return Number;case"j":return xe()&&be;case"p":case"P":case"s":switch(Ae){case 4:return Number;case 8:return xe()&&be}break}E("Unhandled DataView set wrapper for signature:",we)},oe=(we,Ne)=>we+"::"+Ne,Pe=function(we,Ne){return()=>E(oe(we,Ne),"is read-only.")},Q=new WeakMap,te="(pointer-is-external)",N=function(we,Ne,Ve){if(Ve||(Ve=Q.get(Ne)),Ve){if(Q.delete(Ne),Array.isArray(Ne.ondispose)){let ze;for(;ze=Ne.ondispose.shift();)try{ze instanceof Function?ze.call(Ne):ze instanceof Qe?ze.dispose():typeof ze=="number"&&ne(ze)}catch(gt){console.warn("ondispose() for",we.structName,"@",Ve,"threw. NOT propagating it.",gt)}}else if(Ne.ondispose instanceof Function)try{Ne.ondispose()}catch(ze){console.warn("ondispose() for",we.structName,"@",Ve,"threw. NOT propagating it.",ze)}delete Ne.ondispose,we.debugFlags.__flags.dealloc&&Ee("debug.dealloc:",Ne[te]?"EXTERNAL":"",we.structName,"instance:",we.structInfo.sizeof,"bytes @"+Ve),Ne[te]||ne(Ve)}},W=we=>({configurable:!1,writable:!1,iterable:!1,value:we}),Z=function(we,Ne,Ve){let ze=!Ve;Ve?Object.defineProperty(Ne,te,W(Ve)):(Ve=J(we.structInfo.sizeof),Ve||E("Allocation of",we.structName,"structure failed."));try{we.debugFlags.__flags.alloc&&Ee("debug.alloc:",ze?"":"EXTERNAL",we.structName,"instance:",we.structInfo.sizeof,"bytes @"+Ve),ze&&P().fill(0,Ve,Ve+we.structInfo.sizeof),Q.set(Ne,Ve)}catch(gt){throw N(we,Ne,Ve),gt}},me=function(){const we=this.pointer;return we?new Uint8Array(P().slice(we,we+this.structInfo.sizeof)):null},Ye=W(we=>Ie+we+qe),Xe=function(we,Ne,Ve=!0){let ze=we.members[Ne];if(!ze&&(Ie||qe)){for(const gt of Object.values(we.members))if(gt.key===Ne){ze=gt;break}!ze&&Ve&&E(oe(we.name,Ne),"is not a mapped struct member.")}return ze},it=function we(Ne,Ve,ze=!1){we._||(we._=Bt=>Bt.replace(/[^vipPsjrdcC]/g,"").replace(/[pPscC]/g,"i"));const gt=Xe(Ne.structInfo,Ve,!0);return ze?we._(gt.signature):gt.signature},ct={configurable:!1,enumerable:!1,get:function(){return Q.get(this)},set:()=>E("Cannot assign the 'pointer' property of a struct.")},Re=W(function(){const we=[];for(const Ne of Object.keys(this.structInfo.members))we.push(this.memberKey(Ne));return we}),ie=new TextDecoder("utf-8"),ye=new TextEncoder,Be=typeof SharedArrayBuffer>"u"?function(){}:SharedArrayBuffer,Me=function(we,Ne,Ve){return ie.decode(we.buffer instanceof Be?we.slice(Ne,Ve):we.subarray(Ne,Ve))},je=function(we,Ne,Ve=!1){const ze=Xe(we.structInfo,Ne,Ve);return ze&&ze.signature.length===1&&ze.signature[0]==="s"?ze:!1},le=function(we){we.signature!=="s"&&E("Invalid member type signature for C-string value:",JSON.stringify(we))},Se=function(Ne,Ve){const ze=Xe(Ne.structInfo,Ve,!0);le(ze);const gt=Ne[ze.key];if(!gt)return null;let Bt=gt;const Rt=P();for(;Rt[Bt]!==0;++Bt);return gt===Bt?"":Me(Rt,gt,Bt)},Ce=function(we,...Ne){we.ondispose?Array.isArray(we.ondispose)||(we.ondispose=[we.ondispose]):we.ondispose=[],we.ondispose.push(...Ne)},Ke=function(we){const Ne=ye.encode(we),Ve=J(Ne.length+1);Ve||E("Allocation error while duplicating string:",we);const ze=P();return ze.set(Ne,Ve),ze[Ve+Ne.length]=0,Ve},Fe=function(we,Ne,Ve){const ze=Xe(we.structInfo,Ne,!0);le(ze);const gt=Ke(Ve);return we[ze.key]=gt,Ce(we,gt),we},Qe=function(Ne,Ve){arguments[2]!==W&&E("Do not call the StructType constructor","from client-level code."),Object.defineProperties(this,{structName:W(Ne),structInfo:W(Ve)})};Qe.prototype=Object.create(null,{dispose:W(function(){N(this.constructor,this)}),lookupMember:W(function(we,Ne=!0){return Xe(this.structInfo,we,Ne)}),memberToJsString:W(function(we){return Se(this,we)}),memberIsString:W(function(we,Ne=!0){return je(this,we,Ne)}),memberKey:Ye,memberKeys:Re,memberSignature:W(function(we,Ne=!1){return it(this,we,Ne)}),memoryDump:W(me),pointer:ct,setMemberCString:W(function(we,Ne){return Fe(this,we,Ne)})}),Object.assign(Qe.prototype,{addOnDispose:function(...we){return Ce(this,...we),this}}),Object.defineProperties(Qe,{allocCString:W(Ke),isA:W(we=>we instanceof Qe),hasExternalPointer:W(we=>we instanceof Qe&&!!we[te]),memberKey:Ye});const ft=we=>Number.isFinite(we)||we instanceof(be||Number),Ze=function we(Ne,Ve,ze){if(!we._){we._={getters:{},setters:{},sw:{}};const Kn=["i","c","C","p","P","s","f","d","v()"];Oe&&Kn.push("j"),Kn.forEach(function(Mr){we._.getters[Mr]=He(Mr),we._.setters[Mr]=K(Mr),we._.sw[Mr]=X(Mr)});const bx=/^[ipPsjfdcC]$/,wx=/^[vipPsjfdcC]\([ipPsjfdcC]*\)$/;we.sigCheck=function(Mr,_x,Sm,_1){Object.prototype.hasOwnProperty.call(Mr,Sm)&&E(Mr.structName,"already has a property named",Sm+"."),bx.test(_1)||wx.test(_1)||E("Malformed signature for",oe(Mr.structName,_x)+":",_1)}}const gt=Ne.memberKey(Ve);we.sigCheck(Ne.prototype,Ve,gt,ze.signature),ze.key=gt,ze.name=Ve;const Bt=ve(ze.signature),Rt=oe(Ne.prototype.structName,gt),Pt=Ne.prototype.debugFlags.__flags,Go=Object.create(null);Go.configurable=!1,Go.enumerable=!1,Go.get=function(){Pt.getter&&Ee("debug.getter:",we._.getters[Bt],"for",fe(Bt),Rt,"@",this.pointer,"+",ze.offset,"sz",ze.sizeof);let Kn=new DataView(P().buffer,this.pointer+ze.offset,ze.sizeof)[we._.getters[Bt]](0,ae);return Pt.getter&&Ee("debug.getter:",Rt,"result =",Kn),Kn},ze.readOnly?Go.set=Pe(Ne.prototype.structName,gt):Go.set=function(Kn){if(Pt.setter&&Ee("debug.setter:",we._.setters[Bt],"for",fe(Bt),Rt,"@",this.pointer,"+",ze.offset,"sz",ze.sizeof,Kn),this.pointer||E("Cannot set struct property on disposed instance."),Kn===null)Kn=0;else for(;!ft(Kn);){if(Te(ze.signature)&&Kn instanceof Qe){Kn=Kn.pointer||0,Pt.setter&&Ee("debug.setter:",Rt,"resolved to",Kn);break}E("Invalid value for pointer-type",Rt+".")}new DataView(P().buffer,this.pointer+ze.offset,ze.sizeof)[we._.setters[Bt]](0,we._.sw[Bt](Kn),ae)},Object.defineProperty(Ne.prototype,gt,Go)},nn=function we(Ne,Ve){arguments.length===1?(Ve=Ne,Ne=Ve.name):Ve.name||(Ve.name=Ne),Ne||E("Struct name is required.");let ze=!1;Object.keys(Ve.members).forEach(Rt=>{const Pt=Ve.members[Rt];Pt.sizeof?Pt.sizeof===1?Pt.signature==="c"||Pt.signature==="C"||E("Unexpected sizeof==1 member",oe(Ve.name,Rt),"with signature",Pt.signature):(Pt.sizeof%4!==0&&(console.warn("Invalid struct member description =",Pt,"from",Ve),E(Ne,"member",Rt,"sizeof is not aligned. sizeof="+Pt.sizeof)),Pt.offset%4!==0&&(console.warn("Invalid struct member description =",Pt,"from",Ve),E(Ne,"member",Rt,"offset is not aligned. offset="+Pt.offset))):E(Ne,"member",Rt,"is missing sizeof."),(!ze||ze.offset<Pt.offset)&&(ze=Pt)}),ze?Ve.sizeof<ze.offset+ze.sizeof&&E("Invalid struct config:",Ne,"max member offset ("+ze.offset+") ","extends past end of struct (sizeof="+Ve.sizeof+")."):E("No member property descriptions found.");const gt=W(S.__makeDebugFlags(we.debugFlags)),Bt=function Rt(Pt){this instanceof Rt?arguments.length?((Pt!==(Pt|0)||Pt<=0)&&E("Invalid pointer value for",Ne,"constructor."),Z(Rt,this,Pt)):Z(Rt,this):E("The",Ne,"constructor may only be called via 'new'.")};return Object.defineProperties(Bt,{debugFlags:gt,isA:W(Rt=>Rt instanceof Bt),memberKey:Ye,memberKeys:Re,methodInfoForKey:W(function(Rt){}),structInfo:W(Ve),structName:W(Ne)}),Bt.prototype=new Qe(Ne,Ve,W),Object.defineProperties(Bt.prototype,{debugFlags:gt,constructor:W(Bt)}),Object.keys(Ve.members).forEach(Rt=>Ze(Bt,Rt,Ve.members[Rt])),Bt};return nn.StructType=Qe,nn.config=w,nn.allocCString=Ke,nn.debugFlags||(nn.debugFlags=S.__makeDebugFlags(S.debugFlags)),nn},globalThis.sqlite3ApiBootstrap.initializers.push(function(d){const w=(...se)=>{throw new Error(se.join(" "))};d.SQLite3Error.toss;const E=d.capi,S=d.wasm,P=d.util;if(globalThis.WhWasmUtilInstaller(S),delete globalThis.WhWasmUtilInstaller,S.bindingSignatures=[["sqlite3_aggregate_context","void*","sqlite3_context*","int"],["sqlite3_bind_double","int","sqlite3_stmt*","int","f64"],["sqlite3_bind_int","int","sqlite3_stmt*","int","int"],["sqlite3_bind_null",void 0,"sqlite3_stmt*","int"],["sqlite3_bind_parameter_count","int","sqlite3_stmt*"],["sqlite3_bind_parameter_index","int","sqlite3_stmt*","string"],["sqlite3_bind_parameter_name","string","sqlite3_stmt*","int"],["sqlite3_bind_pointer","int","sqlite3_stmt*","int","*","string:static","*"],["sqlite3_busy_handler","int",["sqlite3*",new S.xWrap.FuncPtrAdapter({signature:"i(pi)",contextKey:(se,ae)=>se[0]}),"*"]],["sqlite3_busy_timeout","int","sqlite3*","int"],["sqlite3_changes","int","sqlite3*"],["sqlite3_clear_bindings","int","sqlite3_stmt*"],["sqlite3_collation_needed","int","sqlite3*","*","*"],["sqlite3_column_blob","*","sqlite3_stmt*","int"],["sqlite3_column_bytes","int","sqlite3_stmt*","int"],["sqlite3_column_count","int","sqlite3_stmt*"],["sqlite3_column_decltype","string","sqlite3_stmt*","int"],["sqlite3_column_double","f64","sqlite3_stmt*","int"],["sqlite3_column_int","int","sqlite3_stmt*","int"],["sqlite3_column_name","string","sqlite3_stmt*","int"],["sqlite3_column_text","string","sqlite3_stmt*","int"],["sqlite3_column_type","int","sqlite3_stmt*","int"],["sqlite3_column_value","sqlite3_value*","sqlite3_stmt*","int"],["sqlite3_commit_hook","void*",["sqlite3*",new S.xWrap.FuncPtrAdapter({name:"sqlite3_commit_hook",signature:"i(p)",contextKey:se=>se[0]}),"*"]],["sqlite3_compileoption_get","string","int"],["sqlite3_compileoption_used","int","string"],["sqlite3_complete","int","string:flexible"],["sqlite3_context_db_handle","sqlite3*","sqlite3_context*"],["sqlite3_data_count","int","sqlite3_stmt*"],["sqlite3_db_filename","string","sqlite3*","string"],["sqlite3_db_handle","sqlite3*","sqlite3_stmt*"],["sqlite3_db_name","string","sqlite3*","int"],["sqlite3_db_readonly","int","sqlite3*","string"],["sqlite3_db_status","int","sqlite3*","int","*","*","int"],["sqlite3_errcode","int","sqlite3*"],["sqlite3_errmsg","string","sqlite3*"],["sqlite3_error_offset","int","sqlite3*"],["sqlite3_errstr","string","int"],["sqlite3_exec","int",["sqlite3*","string:flexible",new S.xWrap.FuncPtrAdapter({signature:"i(pipp)",bindScope:"transient",callProxy:se=>{let ae;return(ue,Te,ve,fe)=>{try{const xe=S.cArgvToJs(Te,ve);return ae||(ae=S.cArgvToJs(Te,fe)),se(xe,ae)|0}catch(xe){return xe.resultCode||E.SQLITE_ERROR}}}}),"*","**"]],["sqlite3_expanded_sql","string","sqlite3_stmt*"],["sqlite3_extended_errcode","int","sqlite3*"],["sqlite3_extended_result_codes","int","sqlite3*","int"],["sqlite3_file_control","int","sqlite3*","string","int","*"],["sqlite3_finalize","int","sqlite3_stmt*"],["sqlite3_free",void 0,"*"],["sqlite3_get_autocommit","int","sqlite3*"],["sqlite3_get_auxdata","*","sqlite3_context*","int"],["sqlite3_initialize",void 0],["sqlite3_interrupt",void 0,"sqlite3*"],["sqlite3_is_interrupted","int","sqlite3*"],["sqlite3_keyword_count","int"],["sqlite3_keyword_name","int",["int","**","*"]],["sqlite3_keyword_check","int",["string","int"]],["sqlite3_libversion","string"],["sqlite3_libversion_number","int"],["sqlite3_limit","int",["sqlite3*","int","int"]],["sqlite3_malloc","*","int"],["sqlite3_open","int","string","*"],["sqlite3_open_v2","int","string","*","int","string"],["sqlite3_realloc","*","*","int"],["sqlite3_reset","int","sqlite3_stmt*"],["sqlite3_result_blob",void 0,"sqlite3_context*","*","int","*"],["sqlite3_result_double",void 0,"sqlite3_context*","f64"],["sqlite3_result_error",void 0,"sqlite3_context*","string","int"],["sqlite3_result_error_code",void 0,"sqlite3_context*","int"],["sqlite3_result_error_nomem",void 0,"sqlite3_context*"],["sqlite3_result_error_toobig",void 0,"sqlite3_context*"],["sqlite3_result_int",void 0,"sqlite3_context*","int"],["sqlite3_result_null",void 0,"sqlite3_context*"],["sqlite3_result_pointer",void 0,"sqlite3_context*","*","string:static","*"],["sqlite3_result_subtype",void 0,"sqlite3_value*","int"],["sqlite3_result_text",void 0,"sqlite3_context*","string","int","*"],["sqlite3_result_zeroblob",void 0,"sqlite3_context*","int"],["sqlite3_rollback_hook","void*",["sqlite3*",new S.xWrap.FuncPtrAdapter({name:"sqlite3_rollback_hook",signature:"v(p)",contextKey:se=>se[0]}),"*"]],["sqlite3_set_auxdata",void 0,["sqlite3_context*","int","*","*"]],["sqlite3_shutdown",void 0],["sqlite3_sourceid","string"],["sqlite3_sql","string","sqlite3_stmt*"],["sqlite3_status","int","int","*","*","int"],["sqlite3_step","int","sqlite3_stmt*"],["sqlite3_stmt_busy","int","sqlite3_stmt*"],["sqlite3_stmt_readonly","int","sqlite3_stmt*"],["sqlite3_stmt_status","int","sqlite3_stmt*","int","int"],["sqlite3_strglob","int","string","string"],["sqlite3_stricmp","int","string","string"],["sqlite3_strlike","int","string","string","int"],["sqlite3_strnicmp","int","string","string","int"],["sqlite3_table_column_metadata","int","sqlite3*","string","string","string","**","**","*","*","*"],["sqlite3_total_changes","int","sqlite3*"],["sqlite3_trace_v2","int",["sqlite3*","int",new S.xWrap.FuncPtrAdapter({name:"sqlite3_trace_v2::callback",signature:"i(ippp)",contextKey:(se,ae)=>se[0]}),"*"]],["sqlite3_txn_state","int",["sqlite3*","string"]],["sqlite3_uri_boolean","int","sqlite3_filename","string","int"],["sqlite3_uri_key","string","sqlite3_filename","int"],["sqlite3_uri_parameter","string","sqlite3_filename","string"],["sqlite3_user_data","void*","sqlite3_context*"],["sqlite3_value_blob","*","sqlite3_value*"],["sqlite3_value_bytes","int","sqlite3_value*"],["sqlite3_value_double","f64","sqlite3_value*"],["sqlite3_value_dup","sqlite3_value*","sqlite3_value*"],["sqlite3_value_free",void 0,"sqlite3_value*"],["sqlite3_value_frombind","int","sqlite3_value*"],["sqlite3_value_int","int","sqlite3_value*"],["sqlite3_value_nochange","int","sqlite3_value*"],["sqlite3_value_numeric_type","int","sqlite3_value*"],["sqlite3_value_pointer","*","sqlite3_value*","string:static"],["sqlite3_value_subtype","int","sqlite3_value*"],["sqlite3_value_text","string","sqlite3_value*"],["sqlite3_value_type","int","sqlite3_value*"],["sqlite3_vfs_find","*","string"],["sqlite3_vfs_register","int","sqlite3_vfs*","int"],["sqlite3_vfs_unregister","int","sqlite3_vfs*"]],S.exports.sqlite3_progress_handler&&S.bindingSignatures.push(["sqlite3_progress_handler",void 0,["sqlite3*","int",new S.xWrap.FuncPtrAdapter({name:"xProgressHandler",signature:"i(p)",bindScope:"context",contextKey:(se,ae)=>se[0]}),"*"]]),S.exports.sqlite3_stmt_explain&&S.bindingSignatures.push(["sqlite3_stmt_explain","int","sqlite3_stmt*","int"],["sqlite3_stmt_isexplain","int","sqlite3_stmt*"]),S.exports.sqlite3_set_authorizer&&S.bindingSignatures.push(["sqlite3_set_authorizer","int",["sqlite3*",new S.xWrap.FuncPtrAdapter({name:"sqlite3_set_authorizer::xAuth",signature:"i(pissss)",contextKey:(se,ae)=>se[0],callProxy:se=>(ae,ue,Te,ve,fe,xe)=>{try{return Te=Te&&S.cstrToJs(Te),ve=ve&&S.cstrToJs(ve),fe=fe&&S.cstrToJs(fe),xe=xe&&S.cstrToJs(xe),se(ae,ue,Te,ve,fe,xe)||0}catch(He){return He.resultCode||E.SQLITE_ERROR}}}),"*"]]),S.bindingSignatures.int64=[["sqlite3_bind_int64","int",["sqlite3_stmt*","int","i64"]],["sqlite3_changes64","i64",["sqlite3*"]],["sqlite3_column_int64","i64",["sqlite3_stmt*","int"]],["sqlite3_deserialize","int","sqlite3*","string","*","i64","i64","int"],["sqlite3_last_insert_rowid","i64",["sqlite3*"]],["sqlite3_malloc64","*","i64"],["sqlite3_msize","i64","*"],["sqlite3_overload_function","int",["sqlite3*","string","int"]],["sqlite3_realloc64","*","*","i64"],["sqlite3_result_int64",void 0,"*","i64"],["sqlite3_result_zeroblob64","int","*","i64"],["sqlite3_serialize","*","sqlite3*","string","*","int"],["sqlite3_set_last_insert_rowid",void 0,["sqlite3*","i64"]],["sqlite3_status64","int","int","*","*","int"],["sqlite3_total_changes64","i64",["sqlite3*"]],["sqlite3_update_hook","*",["sqlite3*",new S.xWrap.FuncPtrAdapter({name:"sqlite3_update_hook",signature:"v(iippj)",contextKey:se=>se[0],callProxy:se=>(ae,ue,Te,ve,fe)=>{se(ae,ue,S.cstrToJs(Te),S.cstrToJs(ve),fe)}}),"*"]],["sqlite3_uri_int64","i64",["sqlite3_filename","string","i64"]],["sqlite3_value_int64","i64","sqlite3_value*"]],S.bigIntEnabled&&S.exports.sqlite3_declare_vtab&&S.bindingSignatures.int64.push(["sqlite3_create_module","int",["sqlite3*","string","sqlite3_module*","*"]],["sqlite3_create_module_v2","int",["sqlite3*","string","sqlite3_module*","*","*"]],["sqlite3_declare_vtab","int",["sqlite3*","string:flexible"]],["sqlite3_drop_modules","int",["sqlite3*","**"]],["sqlite3_vtab_collation","string","sqlite3_index_info*","int"],["sqlite3_vtab_distinct","int","sqlite3_index_info*"],["sqlite3_vtab_in","int","sqlite3_index_info*","int","int"],["sqlite3_vtab_in_first","int","sqlite3_value*","**"],["sqlite3_vtab_in_next","int","sqlite3_value*","**"],["sqlite3_vtab_nochange","int","sqlite3_context*"],["sqlite3_vtab_on_conflict","int","sqlite3*"],["sqlite3_vtab_rhs_value","int","sqlite3_index_info*","int","**"]),S.bigIntEnabled&&S.exports.sqlite3_preupdate_hook&&S.bindingSignatures.int64.push(["sqlite3_preupdate_blobwrite","int","sqlite3*"],["sqlite3_preupdate_count","int","sqlite3*"],["sqlite3_preupdate_depth","int","sqlite3*"],["sqlite3_preupdate_hook","*",["sqlite3*",new S.xWrap.FuncPtrAdapter({name:"sqlite3_preupdate_hook",signature:"v(ppippjj)",contextKey:se=>se[0],callProxy:se=>(ae,ue,Te,ve,fe,xe,He)=>{se(ae,ue,Te,S.cstrToJs(ve),S.cstrToJs(fe),xe,He)}}),"*"]],["sqlite3_preupdate_new","int",["sqlite3*","int","**"]],["sqlite3_preupdate_old","int",["sqlite3*","int","**"]]),S.bigIntEnabled&&S.exports.sqlite3changegroup_add&&S.exports.sqlite3session_create&&S.exports.sqlite3_preupdate_hook){const se={signature:"i(ps)",callProxy:ae=>(ue,Te)=>{try{return ae(ue,S.cstrToJs(Te))|0}catch(ve){return ve.resultCode||E.SQLITE_ERROR}}};S.bindingSignatures.int64.push(["sqlite3changegroup_add","int",["sqlite3_changegroup*","int","void*"]],["sqlite3changegroup_add_strm","int",["sqlite3_changegroup*",new S.xWrap.FuncPtrAdapter({name:"xInput",signature:"i(ppp)",bindScope:"transient"}),"void*"]],["sqlite3changegroup_delete",void 0,["sqlite3_changegroup*"]],["sqlite3changegroup_new","int",["**"]],["sqlite3changegroup_output","int",["sqlite3_changegroup*","int*","**"]],["sqlite3changegroup_output_strm","int",["sqlite3_changegroup*",new S.xWrap.FuncPtrAdapter({name:"xOutput",signature:"i(ppi)",bindScope:"transient"}),"void*"]],["sqlite3changeset_apply","int",["sqlite3*","int","void*",new S.xWrap.FuncPtrAdapter({name:"xFilter",bindScope:"transient",...se}),new S.xWrap.FuncPtrAdapter({name:"xConflict",signature:"i(pip)",bindScope:"transient"}),"void*"]],["sqlite3changeset_apply_strm","int",["sqlite3*",new S.xWrap.FuncPtrAdapter({name:"xInput",signature:"i(ppp)",bindScope:"transient"}),"void*",new S.xWrap.FuncPtrAdapter({name:"xFilter",bindScope:"transient",...se}),new S.xWrap.FuncPtrAdapter({name:"xConflict",signature:"i(pip)",bindScope:"transient"}),"void*"]],["sqlite3changeset_apply_v2","int",["sqlite3*","int","void*",new S.xWrap.FuncPtrAdapter({name:"xFilter",bindScope:"transient",...se}),new S.xWrap.FuncPtrAdapter({name:"xConflict",signature:"i(pip)",bindScope:"transient"}),"void*","**","int*","int"]],["sqlite3changeset_apply_v2_strm","int",["sqlite3*",new S.xWrap.FuncPtrAdapter({name:"xInput",signature:"i(ppp)",bindScope:"transient"}),"void*",new S.xWrap.FuncPtrAdapter({name:"xFilter",bindScope:"transient",...se}),new S.xWrap.FuncPtrAdapter({name:"xConflict",signature:"i(pip)",bindScope:"transient"}),"void*","**","int*","int"]],["sqlite3changeset_concat","int",["int","void*","int","void*","int*","**"]],["sqlite3changeset_concat_strm","int",[new S.xWrap.FuncPtrAdapter({name:"xInputA",signature:"i(ppp)",bindScope:"transient"}),"void*",new S.xWrap.FuncPtrAdapter({name:"xInputB",signature:"i(ppp)",bindScope:"transient"}),"void*",new S.xWrap.FuncPtrAdapter({name:"xOutput",signature:"i(ppi)",bindScope:"transient"}),"void*"]],["sqlite3changeset_conflict","int",["sqlite3_changeset_iter*","int","**"]],["sqlite3changeset_finalize","int",["sqlite3_changeset_iter*"]],["sqlite3changeset_fk_conflicts","int",["sqlite3_changeset_iter*","int*"]],["sqlite3changeset_invert","int",["int","void*","int*","**"]],["sqlite3changeset_invert_strm","int",[new S.xWrap.FuncPtrAdapter({name:"xInput",signature:"i(ppp)",bindScope:"transient"}),"void*",new S.xWrap.FuncPtrAdapter({name:"xOutput",signature:"i(ppi)",bindScope:"transient"}),"void*"]],["sqlite3changeset_new","int",["sqlite3_changeset_iter*","int","**"]],["sqlite3changeset_next","int",["sqlite3_changeset_iter*"]],["sqlite3changeset_old","int",["sqlite3_changeset_iter*","int","**"]],["sqlite3changeset_op","int",["sqlite3_changeset_iter*","**","int*","int*","int*"]],["sqlite3changeset_pk","int",["sqlite3_changeset_iter*","**","int*"]],["sqlite3changeset_start","int",["**","int","*"]],["sqlite3changeset_start_strm","int",["**",new S.xWrap.FuncPtrAdapter({name:"xInput",signature:"i(ppp)",bindScope:"transient"}),"void*"]],["sqlite3changeset_start_v2","int",["**","int","*","int"]],["sqlite3changeset_start_v2_strm","int",["**",new S.xWrap.FuncPtrAdapter({name:"xInput",signature:"i(ppp)",bindScope:"transient"}),"void*","int"]],["sqlite3session_attach","int",["sqlite3_session*","string"]],["sqlite3session_changeset","int",["sqlite3_session*","int*","**"]],["sqlite3session_changeset_size","i64",["sqlite3_session*"]],["sqlite3session_changeset_strm","int",["sqlite3_session*",new S.xWrap.FuncPtrAdapter({name:"xOutput",signature:"i(ppp)",bindScope:"transient"}),"void*"]],["sqlite3session_config","int",["int","void*"]],["sqlite3session_create","int",["sqlite3*","string","**"]],["sqlite3session_diff","int",["sqlite3_session*","string","string","**"]],["sqlite3session_enable","int",["sqlite3_session*","int"]],["sqlite3session_indirect","int",["sqlite3_session*","int"]],["sqlite3session_isempty","int",["sqlite3_session*"]],["sqlite3session_memory_used","i64",["sqlite3_session*"]],["sqlite3session_object_config","int",["sqlite3_session*","int","void*"]],["sqlite3session_patchset","int",["sqlite3_session*","*","**"]],["sqlite3session_patchset_strm","int",["sqlite3_session*",new S.xWrap.FuncPtrAdapter({name:"xOutput",signature:"i(ppp)",bindScope:"transient"}),"void*"]],["sqlite3session_table_filter",void 0,["sqlite3_session*",new S.xWrap.FuncPtrAdapter({name:"xFilter",...se,contextKey:(ae,ue)=>ae[0]}),"*"]])}S.bindingSignatures.wasmInternal=[["sqlite3__wasm_db_reset","int","sqlite3*"],["sqlite3__wasm_db_vfs","sqlite3_vfs*","sqlite3*","string"],["sqlite3__wasm_vfs_create_file","int","sqlite3_vfs*","string","*","int"],["sqlite3__wasm_posix_create_file","int","string","*","int"],["sqlite3__wasm_vfs_unlink","int","sqlite3_vfs*","string"],["sqlite3__wasm_qfmt_token","string:dealloc","string","int"]],d.StructBinder=globalThis.Jaccwabyt({heap:S.heap8u,alloc:S.alloc,dealloc:S.dealloc,bigIntEnabled:S.bigIntEnabled,memberPrefix:"$"}),delete globalThis.Jaccwabyt;{const se=S.xWrap.argAdapter("string");S.xWrap.argAdapter("string:flexible",fe=>se(P.flexibleString(fe))),S.xWrap.argAdapter("string:static",(function(fe){return S.isPtr(fe)?fe:(fe=""+fe,this[fe]||(this[fe]=S.allocCString(fe)))}).bind(Object.create(null)));const ae=S.xWrap.argAdapter("*"),ue=function(){};S.xWrap.argAdapter("sqlite3_filename",ae)("sqlite3_context*",ae)("sqlite3_value*",ae)("void*",ae)("sqlite3_changegroup*",ae)("sqlite3_changeset_iter*",ae)("sqlite3_session*",ae)("sqlite3_stmt*",fe=>ae(fe instanceof(d?.oo1?.Stmt||ue)?fe.pointer:fe))("sqlite3*",fe=>ae(fe instanceof(d?.oo1?.DB||ue)?fe.pointer:fe))("sqlite3_vfs*",fe=>typeof fe=="string"?E.sqlite3_vfs_find(fe)||d.SQLite3Error.toss(E.SQLITE_NOTFOUND,"Unknown sqlite3_vfs name:",fe):ae(fe instanceof(E.sqlite3_vfs||ue)?fe.pointer:fe)),S.exports.sqlite3_declare_vtab&&S.xWrap.argAdapter("sqlite3_index_info*",fe=>ae(fe instanceof(E.sqlite3_index_info||ue)?fe.pointer:fe))("sqlite3_module*",fe=>ae(fe instanceof(E.sqlite3_module||ue)?fe.pointer:fe));const Te=S.xWrap.resultAdapter("*");S.xWrap.resultAdapter("sqlite3*",Te)("sqlite3_context*",Te)("sqlite3_stmt*",Te)("sqlite3_value*",Te)("sqlite3_vfs*",Te)("void*",Te),S.exports.sqlite3_step.length===0&&(S.xWrap.doArgcCheck=!1,d.config.warn("Disabling sqlite3.wasm.xWrap.doArgcCheck due to environmental quirks."));for(const fe of S.bindingSignatures)E[fe[0]]=S.xWrap.apply(null,fe);for(const fe of S.bindingSignatures.wasmInternal)P[fe[0]]=S.xWrap.apply(null,fe);const ve=function(fe){return()=>w(fe+"() is unavailable due to lack","of BigInt support in this build.")};for(const fe of S.bindingSignatures.int64)E[fe[0]]=S.bigIntEnabled?S.xWrap.apply(null,fe):ve(fe[0]);if(delete S.bindingSignatures,S.exports.sqlite3__wasm_db_error){const fe=S.xWrap("sqlite3__wasm_db_error","int","sqlite3*","int","string");P.sqlite3__wasm_db_error=function(xe,He,K){return He instanceof d.WasmAllocError?(He=E.SQLITE_NOMEM,K=0):He instanceof Error&&(K=K||""+He,He=He.resultCode||E.SQLITE_ERROR),xe?fe(xe,He,K):He}}else P.sqlite3__wasm_db_error=function(fe,xe,He){return console.warn("sqlite3__wasm_db_error() is not exported.",arguments),xe}}{const se=S.xCall("sqlite3__wasm_enum_json");se||w("Maintenance required: increase sqlite3__wasm_enum_json()'s","static buffer size!"),S.ctype=JSON.parse(S.cstrToJs(se));const ae=["access","authorizer","blobFinalizers","changeset","config","dataTypes","dbConfig","dbStatus","encodings","fcntl","flock","ioCap","limits","openFlags","prepareFlags","resultCodes","sqlite3Status","stmtStatus","syncFlags","trace","txnState","udfFlags","version"];S.bigIntEnabled&&ae.push("serialize","session","vtab");for(const ve of ae)for(const fe of Object.entries(S.ctype[ve]))E[fe[0]]=fe[1];S.functionEntry(E.SQLITE_WASM_DEALLOC)||w("Internal error: cannot resolve exported function","entry SQLITE_WASM_DEALLOC (=="+E.SQLITE_WASM_DEALLOC+").");const ue=Object.create(null);for(const ve of["resultCodes"])for(const fe of Object.entries(S.ctype[ve]))ue[fe[1]]=fe[0];E.sqlite3_js_rc_str=ve=>ue[ve];const Te=Object.assign(Object.create(null),{WasmTestStruct:!0,sqlite3_kvvfs_methods:!P.isUIThread(),sqlite3_index_info:!S.bigIntEnabled,sqlite3_index_constraint:!S.bigIntEnabled,sqlite3_index_orderby:!S.bigIntEnabled,sqlite3_index_constraint_usage:!S.bigIntEnabled});for(const ve of S.ctype.structs)Te[ve.name]||(E[ve.name]=d.StructBinder(ve));if(E.sqlite3_index_info){for(const ve of["sqlite3_index_constraint","sqlite3_index_orderby","sqlite3_index_constraint_usage"])E.sqlite3_index_info[ve]=E[ve],delete E[ve];E.sqlite3_vtab_config=S.xWrap("sqlite3__wasm_vtab_config","int",["sqlite3*","int","int"])}}const J=(se,ae,ue)=>P.sqlite3__wasm_db_error(se,E.SQLITE_MISUSE,ae+"() requires "+ue+" argument"+(ue===1?"":"s")+"."),ne=se=>P.sqlite3__wasm_db_error(se,E.SQLITE_FORMAT,"SQLITE_UTF8 is the only supported encoding."),Ee=se=>S.xWrap.argAdapter("sqlite3*")(se),Ie=se=>S.isPtr(se)?S.cstrToJs(se):se,qe=(function(se,ae){se=Ee(se);let ue=this.dbMap.get(se);if(ae)!ue&&ae>0&&this.dbMap.set(se,ue=Object.create(null));else return this.dbMap.delete(se),ue;return ue}).bind(Object.assign(Object.create(null),{dbMap:new Map}));qe.addCollation=function(se,ae){const ue=qe(se,1);ue.collation||(ue.collation=new Set),ue.collation.add(Ie(ae).toLowerCase())},qe._addUDF=function(se,ae,ue,Te){ae=Ie(ae).toLowerCase();let ve=Te.get(ae);ve||Te.set(ae,ve=new Set),ve.add(ue<0?-1:ue)},qe.addFunction=function(se,ae,ue){const Te=qe(se,1);Te.udf||(Te.udf=new Map),this._addUDF(se,ae,ue,Te.udf)},S.exports.sqlite3_create_window_function&&(qe.addWindowFunc=function(se,ae,ue){const Te=qe(se,1);Te.wudf||(Te.wudf=new Map),this._addUDF(se,ae,ue,Te.wudf)}),qe.cleanup=function(se){se=Ee(se);const ae=[se];for(const ve of["sqlite3_busy_handler","sqlite3_commit_hook","sqlite3_preupdate_hook","sqlite3_progress_handler","sqlite3_rollback_hook","sqlite3_set_authorizer","sqlite3_trace_v2","sqlite3_update_hook"]){const fe=S.exports[ve];if(fe){ae.length=fe.length;try{E[ve](...ae)}catch(xe){d.config.warn("close-time call of",ve+"(",ae,") threw:",xe)}}}const ue=qe(se,0);if(!ue)return;if(ue.collation){for(const ve of ue.collation)try{E.sqlite3_create_collation_v2(se,ve,E.SQLITE_UTF8,0,0,0)}catch{}delete ue.collation}let Te;for(Te=0;Te<2;++Te){const ve=Te?ue.wudf:ue.udf;if(!ve)continue;const fe=Te?E.sqlite3_create_window_function:E.sqlite3_create_function_v2;for(const xe of ve){const He=xe[0],K=xe[1],X=[se,He,0,E.SQLITE_UTF8,0,0,0,0,0];Te&&X.push(0);for(const oe of K)try{X[2]=oe,fe.apply(null,X)}catch{}K.clear()}ve.clear()}delete ue.udf,delete ue.wudf};{const se=S.xWrap("sqlite3_close_v2","int","sqlite3*");E.sqlite3_close_v2=function(ae){if(arguments.length!==1)return J(ae,"sqlite3_close_v2",1);if(ae)try{qe.cleanup(ae)}catch{}return se(ae)}}if(E.sqlite3session_create){const se=S.xWrap("sqlite3session_delete",void 0,["sqlite3_session*"]);E.sqlite3session_delete=function(ae){if(arguments.length!==1)return J(pDb,"sqlite3session_delete",1);ae&&E.sqlite3session_table_filter(ae,0,0),se(ae)}}{const se=(ue,Te)=>"argv["+Te+"]:"+ue[0]+":"+S.cstrToJs(ue[1]).toLowerCase(),ae=S.xWrap("sqlite3_create_collation_v2","int",["sqlite3*","string","int","*",new S.xWrap.FuncPtrAdapter({name:"xCompare",signature:"i(pipip)",contextKey:se}),new S.xWrap.FuncPtrAdapter({name:"xDestroy",signature:"v(p)",contextKey:se})]);E.sqlite3_create_collation_v2=function(ue,Te,ve,fe,xe,He){if(arguments.length!==6)return J(ue,"sqlite3_create_collation_v2",6);if((ve&15)===0)ve|=E.SQLITE_UTF8;else if(E.SQLITE_UTF8!==(ve&15))return ne(ue);try{const K=ae(ue,Te,ve,fe,xe,He);return K===0&&xe instanceof Function&&qe.addCollation(ue,Te),K}catch(K){return P.sqlite3__wasm_db_error(ue,K)}},E.sqlite3_create_collation=(ue,Te,ve,fe,xe)=>arguments.length===5?E.sqlite3_create_collation_v2(ue,Te,ve,fe,xe,0):J(ue,"sqlite3_create_collation",5)}{const se=function(ve,fe){return ve[0]+":"+(ve[2]<0?-1:ve[2])+":"+fe+":"+S.cstrToJs(ve[1]).toLowerCase()},ae=Object.assign(Object.create(null),{xInverseAndStep:{signature:"v(pip)",contextKey:se,callProxy:ve=>(fe,xe,He)=>{try{ve(fe,...E.sqlite3_values_to_js(xe,He))}catch(K){E.sqlite3_result_error_js(fe,K)}}},xFinalAndValue:{signature:"v(p)",contextKey:se,callProxy:ve=>fe=>{try{E.sqlite3_result_js(fe,ve(fe))}catch(xe){E.sqlite3_result_error_js(fe,xe)}}},xFunc:{signature:"v(pip)",contextKey:se,callProxy:ve=>(fe,xe,He)=>{try{E.sqlite3_result_js(fe,ve(fe,...E.sqlite3_values_to_js(xe,He)))}catch(K){E.sqlite3_result_error_js(fe,K)}}},xDestroy:{signature:"v(p)",contextKey:se,callProxy:ve=>fe=>{try{ve(fe)}catch(xe){console.error("UDF xDestroy method threw:",xe)}}}}),ue=S.xWrap("sqlite3_create_function_v2","int",["sqlite3*","string","int","int","*",new S.xWrap.FuncPtrAdapter({name:"xFunc",...ae.xFunc}),new S.xWrap.FuncPtrAdapter({name:"xStep",...ae.xInverseAndStep}),new S.xWrap.FuncPtrAdapter({name:"xFinal",...ae.xFinalAndValue}),new S.xWrap.FuncPtrAdapter({name:"xDestroy",...ae.xDestroy})]),Te=S.exports.sqlite3_create_window_function?S.xWrap("sqlite3_create_window_function","int",["sqlite3*","string","int","int","*",new S.xWrap.FuncPtrAdapter({name:"xStep",...ae.xInverseAndStep}),new S.xWrap.FuncPtrAdapter({name:"xFinal",...ae.xFinalAndValue}),new S.xWrap.FuncPtrAdapter({name:"xValue",...ae.xFinalAndValue}),new S.xWrap.FuncPtrAdapter({name:"xInverse",...ae.xInverseAndStep}),new S.xWrap.FuncPtrAdapter({name:"xDestroy",...ae.xDestroy})]):void 0;E.sqlite3_create_function_v2=function ve(fe,xe,He,K,X,oe,Pe,Q,te){if(ve.length!==arguments.length)return J(fe,"sqlite3_create_function_v2",ve.length);if((K&15)===0)K|=E.SQLITE_UTF8;else if(E.SQLITE_UTF8!==(K&15))return ne(fe);try{const N=ue(fe,xe,He,K,X,oe,Pe,Q,te);return N===0&&(oe instanceof Function||Pe instanceof Function||Q instanceof Function||te instanceof Function)&&qe.addFunction(fe,xe,He),N}catch(N){return console.error("sqlite3_create_function_v2() setup threw:",N),P.sqlite3__wasm_db_error(fe,N,"Creation of UDF threw: "+N)}},E.sqlite3_create_function=function ve(fe,xe,He,K,X,oe,Pe,Q){return ve.length===arguments.length?E.sqlite3_create_function_v2(fe,xe,He,K,X,oe,Pe,Q,0):J(fe,"sqlite3_create_function",ve.length)},Te?E.sqlite3_create_window_function=function ve(fe,xe,He,K,X,oe,Pe,Q,te,N){if(ve.length!==arguments.length)return J(fe,"sqlite3_create_window_function",ve.length);if((K&15)===0)K|=E.SQLITE_UTF8;else if(E.SQLITE_UTF8!==(K&15))return ne(fe);try{const W=Te(fe,xe,He,K,X,oe,Pe,Q,te,N);return W===0&&(oe instanceof Function||Pe instanceof Function||Q instanceof Function||te instanceof Function||N instanceof Function)&&qe.addWindowFunc(fe,xe,He),W}catch(W){return console.error("sqlite3_create_window_function() setup threw:",W),P.sqlite3__wasm_db_error(fe,W,"Creation of UDF threw: "+W)}}:delete E.sqlite3_create_window_function,E.sqlite3_create_function_v2.udfSetResult=E.sqlite3_create_function.udfSetResult=E.sqlite3_result_js,E.sqlite3_create_window_function&&(E.sqlite3_create_window_function.udfSetResult=E.sqlite3_result_js),E.sqlite3_create_function_v2.udfConvertArgs=E.sqlite3_create_function.udfConvertArgs=E.sqlite3_values_to_js,E.sqlite3_create_window_function&&(E.sqlite3_create_window_function.udfConvertArgs=E.sqlite3_values_to_js),E.sqlite3_create_function_v2.udfSetError=E.sqlite3_create_function.udfSetError=E.sqlite3_result_error_js,E.sqlite3_create_window_function&&(E.sqlite3_create_window_function.udfSetError=E.sqlite3_result_error_js)}{const se=(ue,Te)=>(typeof ue=="string"?Te=-1:P.isSQLableTypedArray(ue)?(Te=ue.byteLength,ue=P.typedArrayToString(ue instanceof ArrayBuffer?new Uint8Array(ue):ue)):Array.isArray(ue)&&(ue=ue.join(""),Te=-1),[ue,Te]),ae={basic:S.xWrap("sqlite3_prepare_v3","int",["sqlite3*","string","int","int","**","**"]),full:S.xWrap("sqlite3_prepare_v3","int",["sqlite3*","*","int","int","**","**"])};E.sqlite3_prepare_v3=function ue(Te,ve,fe,xe,He,K){if(ue.length!==arguments.length)return J(Te,"sqlite3_prepare_v3",ue.length);const[X,oe]=se(ve,fe);switch(typeof X){case"string":return ae.basic(Te,X,oe,xe,He,null);case"number":return ae.full(Te,X,oe,xe,He,K);default:return P.sqlite3__wasm_db_error(Te,E.SQLITE_MISUSE,"Invalid SQL argument type for sqlite3_prepare_v2/v3().")}},E.sqlite3_prepare_v2=function ue(Te,ve,fe,xe,He){return ue.length===arguments.length?E.sqlite3_prepare_v3(Te,ve,fe,0,xe,He):J(Te,"sqlite3_prepare_v2",ue.length)}}{const se=S.xWrap("sqlite3_bind_text","int",["sqlite3_stmt*","int","string","int","*"]),ae=S.xWrap("sqlite3_bind_blob","int",["sqlite3_stmt*","int","*","int","*"]);E.sqlite3_bind_text=function ue(Te,ve,fe,xe,He){if(ue.length!==arguments.length)return J(E.sqlite3_db_handle(Te),"sqlite3_bind_text",ue.length);if(S.isPtr(fe)||fe===null)return se(Te,ve,fe,xe,He);fe instanceof ArrayBuffer?fe=new Uint8Array(fe):Array.isArray(pMem)&&(fe=pMem.join(""));let K,X;try{if(P.isSQLableTypedArray(fe))K=S.allocFromTypedArray(fe),X=fe.byteLength;else if(typeof fe=="string")[K,X]=S.allocCString(fe);else return P.sqlite3__wasm_db_error(E.sqlite3_db_handle(Te),E.SQLITE_MISUSE,"Invalid 3rd argument type for sqlite3_bind_text().");return se(Te,ve,K,X,E.SQLITE_WASM_DEALLOC)}catch(oe){return S.dealloc(K),P.sqlite3__wasm_db_error(E.sqlite3_db_handle(Te),oe)}},E.sqlite3_bind_blob=function ue(Te,ve,fe,xe,He){if(ue.length!==arguments.length)return J(E.sqlite3_db_handle(Te),"sqlite3_bind_blob",ue.length);if(S.isPtr(fe)||fe===null)return ae(Te,ve,fe,xe,He);fe instanceof ArrayBuffer?fe=new Uint8Array(fe):Array.isArray(fe)&&(fe=fe.join(""));let K,X;try{if(P.isBindableTypedArray(fe))K=S.allocFromTypedArray(fe),X=xe>=0?xe:fe.byteLength;else if(typeof fe=="string")[K,X]=S.allocCString(fe);else return P.sqlite3__wasm_db_error(E.sqlite3_db_handle(Te),E.SQLITE_MISUSE,"Invalid 3rd argument type for sqlite3_bind_blob().");return ae(Te,ve,K,X,E.SQLITE_WASM_DEALLOC)}catch(oe){return S.dealloc(K),P.sqlite3__wasm_db_error(E.sqlite3_db_handle(Te),oe)}}}E.sqlite3_config=function(se,...ae){if(arguments.length<2)return E.SQLITE_MISUSE;switch(se){case E.SQLITE_CONFIG_COVERING_INDEX_SCAN:case E.SQLITE_CONFIG_MEMSTATUS:case E.SQLITE_CONFIG_SMALL_MALLOC:case E.SQLITE_CONFIG_SORTERREF_SIZE:case E.SQLITE_CONFIG_STMTJRNL_SPILL:case E.SQLITE_CONFIG_URI:return S.exports.sqlite3__wasm_config_i(se,ae[0]);case E.SQLITE_CONFIG_LOOKASIDE:return S.exports.sqlite3__wasm_config_ii(se,ae[0],ae[1]);case E.SQLITE_CONFIG_MEMDB_MAXSIZE:return S.exports.sqlite3__wasm_config_j(se,ae[0]);case E.SQLITE_CONFIG_GETMALLOC:case E.SQLITE_CONFIG_GETMUTEX:case E.SQLITE_CONFIG_GETPCACHE2:case E.SQLITE_CONFIG_GETPCACHE:case E.SQLITE_CONFIG_HEAP:case E.SQLITE_CONFIG_LOG:case E.SQLITE_CONFIG_MALLOC:case E.SQLITE_CONFIG_MMAP_SIZE:case E.SQLITE_CONFIG_MULTITHREAD:case E.SQLITE_CONFIG_MUTEX:case E.SQLITE_CONFIG_PAGECACHE:case E.SQLITE_CONFIG_PCACHE2:case E.SQLITE_CONFIG_PCACHE:case E.SQLITE_CONFIG_PCACHE_HDRSZ:case E.SQLITE_CONFIG_PMASZ:case E.SQLITE_CONFIG_SERIALIZED:case E.SQLITE_CONFIG_SINGLETHREAD:case E.SQLITE_CONFIG_SQLLOG:case E.SQLITE_CONFIG_WIN32_HEAPSIZE:default:return E.SQLITE_NOTFOUND}};{const se=new Set;E.sqlite3_auto_extension=function(ae){if(ae instanceof Function)ae=S.installFunction("i(ppp)",ae);else if(arguments.length!==1||!S.isPtr(ae))return E.SQLITE_MISUSE;const ue=S.exports.sqlite3_auto_extension(ae);return ae!==arguments[0]&&(ue===0?se.add(ae):S.uninstallFunction(ae)),ue},E.sqlite3_cancel_auto_extension=function(ae){return!ae||arguments.length!==1||!S.isPtr(ae)?0:S.exports.sqlite3_cancel_auto_extension(ae)},E.sqlite3_reset_auto_extension=function(){S.exports.sqlite3_reset_auto_extension();for(const ae of se)S.uninstallFunction(ae);se.clear()}}const Oe=E.sqlite3_vfs_find("kvvfs");if(Oe)if(P.isUIThread()){const se=new E.sqlite3_kvvfs_methods(S.exports.sqlite3__wasm_kvvfs_methods());delete E.sqlite3_kvvfs_methods;const ae=S.exports.sqlite3__wasm_kvvfsMakeKeyOnPstack,ue=S.pstack,Te=fe=>S.peek(fe)===115?sessionStorage:localStorage,ve={xRead:(fe,xe,He,K)=>{const X=ue.pointer,oe=S.scopedAllocPush();try{const Pe=ae(fe,xe);if(!Pe)return-3;const Q=S.cstrToJs(Pe),te=Te(fe).getItem(Q);if(!te)return-1;const N=te.length;if(K<=0)return N;if(K===1)return S.poke(He,0),N;const W=S.scopedAllocCString(te);return K>N+1&&(K=N+1),S.heap8u().copyWithin(He,W,W+K-1),S.poke(He+K-1,0),K-1}catch(Pe){return console.error("kvstorageRead()",Pe),-2}finally{ue.restore(X),S.scopedAllocPop(oe)}},xWrite:(fe,xe,He)=>{const K=ue.pointer;try{const X=ae(fe,xe);if(!X)return 1;const oe=S.cstrToJs(X);return Te(fe).setItem(oe,S.cstrToJs(He)),0}catch(X){return console.error("kvstorageWrite()",X),E.SQLITE_IOERR}finally{ue.restore(K)}},xDelete:(fe,xe)=>{const He=ue.pointer;try{const K=ae(fe,xe);return K?(Te(fe).removeItem(S.cstrToJs(K)),0):1}catch(K){return console.error("kvstorageDelete()",K),E.SQLITE_IOERR}finally{ue.restore(He)}}};for(const fe of Object.keys(ve))se[se.memberKey(fe)]=S.installFunction(se.memberSignature(fe),ve[fe])}else E.sqlite3_vfs_unregister(Oe);S.xWrap.FuncPtrAdapter.warnOnUse=!0;const be=d.StructBinder,he=function se(ae,ue,Te,ve=se.installMethodArgcCheck){if(ae instanceof be.StructType?!(Te instanceof Function)&&!S.isPtr(Te)&&w("Usage error: expecting a Function or WASM pointer to one."):w("Usage error: target object is-not-a StructType."),arguments.length===1)return(K,X)=>se(ae,K,X,ve);se.argcProxy||(se.argcProxy=function(K,X,oe,Pe){return function(...Q){return oe.length!==arguments.length&&w("Argument mismatch for",K.structInfo.name+"::"+X+": Native signature is:",Pe),oe.apply(this,Q)}},se.removeFuncList=function(){this.ondispose.__removeFuncList&&(this.ondispose.__removeFuncList.forEach((K,X)=>{if(typeof K=="number")try{S.uninstallFunction(K)}catch{}}),delete this.ondispose.__removeFuncList)});const fe=ae.memberSignature(ue);fe.length<2&&w("Member",ue,"does not have a function pointer signature:",fe);const xe=ae.memberKey(ue),He=ve&&!S.isPtr(Te)?se.argcProxy(ae,xe,Te,fe):Te;if(S.isPtr(He))He&&!S.functionEntry(He)&&w("Pointer",He,"is not a WASM function table entry."),ae[xe]=He;else{const K=S.installFunction(He,ae.memberSignature(ue,!0));ae[xe]=K,(!ae.ondispose||!ae.ondispose.__removeFuncList)&&(ae.addOnDispose("ondispose.__removeFuncList handler",se.removeFuncList),ae.ondispose.__removeFuncList=[]),ae.ondispose.__removeFuncList.push(xe,K)}return(K,X)=>se(ae,K,X,ve)};he.installMethodArgcCheck=!1;const Ae=function(se,ae,ue=he.installMethodArgcCheck){const Te=new Map;for(const ve of Object.keys(ae)){const fe=ae[ve],xe=Te.get(fe);if(xe){const He=se.memberKey(ve);se[He]=se[se.memberKey(xe)]}else he(se,ve,fe,ue),Te.set(fe,ve)}return se};be.StructType.prototype.installMethod=function(ae,ue,Te=he.installMethodArgcCheck){return arguments.length<3&&ae&&typeof ae=="object"?Ae(this,...arguments):he(this,...arguments)},be.StructType.prototype.installMethods=function(se,ae=he.installMethodArgcCheck){return Ae(this,se,ae)}}),globalThis.sqlite3ApiBootstrap.initializers.push(function(d){d.version={libVersion:"3.50.4",libVersionNumber:3050004,sourceId:"2025-07-30 19:33:53 4d8adfb30e03f9cf27f800a2c1ba3c48fb4ca1b08b0f5ed59a4d5ecbf45e20a3",downloadVersion:3500400}}),globalThis.sqlite3ApiBootstrap.initializers.push(function(d){const w=(...Q)=>{throw new d.SQLite3Error(...Q)},E=d.capi,S=d.wasm,P=d.util,J=new WeakMap,ne=new WeakMap,Ee=(Q,te,N)=>{const W=Object.getOwnPropertyDescriptor(Q,te);return W?W.value:N},Ie=function(Q,te){return te&&(Q instanceof he&&(Q=Q.pointer),w(te,"sqlite3 result code",te+":",Q?E.sqlite3_errmsg(Q):E.sqlite3_errstr(te))),arguments[0]},qe=S.installFunction("i(ippp)",(function(Q,te,N,W){E.SQLITE_TRACE_STMT===Q&&console.log("SQL TRACE #"+ ++this.counter+" via sqlite3@"+te+":",S.cstrToJs(W))}).bind({counter:0})),Oe=Object.create(null),be=function Q(...te){if(!Q._name2vfs){Q._name2vfs=Object.create(null);const Re=typeof importScripts=="function"?ie=>w("The VFS for",ie,"is only available in the main window thread."):!1;Q._name2vfs[":localStorage:"]={vfs:"kvvfs",filename:Re||(()=>"local")},Q._name2vfs[":sessionStorage:"]={vfs:"kvvfs",filename:Re||(()=>"session")}}const N=Q.normalizeArgs(...te);let W=N.filename,Z=N.vfs,me=N.flags;(typeof W!="string"&&typeof W!="number"||typeof me!="string"||Z&&typeof Z!="string"&&typeof Z!="number")&&(d.config.error("Invalid DB ctor args",N,arguments),w("Invalid arguments for DB constructor."));let De=typeof W=="number"?S.cstrToJs(W):W;const Ye=Q._name2vfs[De];Ye&&(Z=Ye.vfs,W=De=Ye.filename(De));let Xe,it=0;me.indexOf("c")>=0&&(it|=E.SQLITE_OPEN_CREATE|E.SQLITE_OPEN_READWRITE),me.indexOf("w")>=0&&(it|=E.SQLITE_OPEN_READWRITE),it===0&&(it|=E.SQLITE_OPEN_READONLY),it|=E.SQLITE_OPEN_EXRESCODE;const ct=S.pstack.pointer;try{const Re=S.pstack.allocPtr();let ie=E.sqlite3_open_v2(W,Re,it,Z||0);Xe=S.peekPtr(Re),Ie(Xe,ie),E.sqlite3_extended_result_codes(Xe,1),me.indexOf("t")>=0&&E.sqlite3_trace_v2(Xe,E.SQLITE_TRACE_STMT,qe,Xe)}catch(Re){throw Xe&&E.sqlite3_close_v2(Xe),Re}finally{S.pstack.restore(ct)}this.filename=De,J.set(this,Xe),ne.set(this,Object.create(null));try{const Re=E.sqlite3_js_db_vfs(Xe)||w("Internal error: cannot get VFS for new db handle."),ie=Oe[Re];ie&&(ie instanceof Function?ie(this,d):Ie(Xe,E.sqlite3_exec(Xe,ie,0,0,0)))}catch(Re){throw this.close(),Re}};be.setVfsPostOpenCallback=function(Q,te){te instanceof Function||w("dbCtorHelper.setVfsPostOpenCallback() should not be used with a non-function argument.",arguments),Oe[Q]=te},be.normalizeArgs=function(Q=":memory:",te="c",N=null){const W={};return arguments.length===1&&arguments[0]&&typeof arguments[0]=="object"?(Object.assign(W,arguments[0]),W.flags===void 0&&(W.flags="c"),W.vfs===void 0&&(W.vfs=null),W.filename===void 0&&(W.filename=":memory:")):(W.filename=Q,W.flags=te,W.vfs=N),W};const he=function(...Q){be.apply(this,Q)};he.dbCtorHelper=be;const Ae={null:1,number:2,string:3,boolean:4,blob:5};Ae.undefined==Ae.null,S.bigIntEnabled&&(Ae.bigint=Ae.number);const se=function(){Ae!==arguments[2]&&w(E.SQLITE_MISUSE,"Do not call the Stmt constructor directly. Use DB.prepare()."),this.db=arguments[0],J.set(this,arguments[1]),this.parameterCount=E.sqlite3_bind_parameter_count(this.pointer)},ae=function(Q){return Q.pointer||w("DB has been closed."),Q},ue=function(Q,te){return(te!==(te|0)||te<0||te>=Q.columnCount)&&w("Column index",te,"is out of range."),Q},Te=function(Q,te){const N=Object.create(null);switch(N.opt=Object.create(null),te.length){case 1:typeof te[0]=="string"||P.isSQLableTypedArray(te[0])||Array.isArray(te[0])?N.sql=te[0]:te[0]&&typeof te[0]=="object"&&(N.opt=te[0],N.sql=N.opt.sql);break;case 2:N.sql=te[0],N.opt=te[1];break;default:w("Invalid argument count for exec().")}N.sql=P.flexibleString(N.sql),typeof N.sql!="string"&&w("Missing SQL argument or unsupported SQL value type.");const W=N.opt;switch(W.returnValue){case"resultRows":W.resultRows||(W.resultRows=[]),N.returnVal=()=>W.resultRows;break;case"saveSql":W.saveSql||(W.saveSql=[]),N.returnVal=()=>W.saveSql;break;case void 0:case"this":N.returnVal=()=>Q;break;default:w("Invalid returnValue value:",W.returnValue)}if(!W.callback&&!W.returnValue&&W.rowMode!==void 0&&(W.resultRows||(W.resultRows=[]),N.returnVal=()=>W.resultRows),W.callback||W.resultRows)switch(W.rowMode===void 0?"array":W.rowMode){case"object":N.cbArg=(Z,me)=>{me.columnNames||(me.columnNames=Z.getColumnNames([]));const De=Z.get([]),Ye=Object.create(null);for(const Xe in me.columnNames)Ye[me.columnNames[Xe]]=De[Xe];return Ye};break;case"array":N.cbArg=Z=>Z.get([]);break;case"stmt":Array.isArray(W.resultRows)&&w("exec(): invalid rowMode for a resultRows array: must","be one of 'array', 'object',","a result column number, or column name reference."),N.cbArg=Z=>Z;break;default:if(P.isInt32(W.rowMode)){N.cbArg=Z=>Z.get(W.rowMode);break}else if(typeof W.rowMode=="string"&&W.rowMode.length>1&&W.rowMode[0]==="$"){const Z=W.rowMode.substr(1);N.cbArg=me=>{const De=me.get(Object.create(null))[Z];return De===void 0?w(E.SQLITE_NOTFOUND,"exec(): unknown result column:",Z):De};break}w("Invalid rowMode:",W.rowMode)}return N},ve=(Q,te,N,...W)=>{const Z=Q.prepare(te);try{const me=Z.bind(N).step()?Z.get(...W):void 0;return Z.reset(),me}finally{Z.finalize()}},fe=(Q,te,N,W)=>Q.exec({sql:te,bind:N,rowMode:W,returnValue:"resultRows"});he.checkRc=(Q,te)=>Ie(Q,te),he.prototype={isOpen:function(){return!!this.pointer},affirmOpen:function(){return ae(this)},close:function(){if(this.pointer){if(this.onclose&&this.onclose.before instanceof Function)try{this.onclose.before(this)}catch{}const Q=this.pointer;if(Object.keys(ne.get(this)).forEach((te,N)=>{if(N&&N.pointer)try{N.finalize()}catch{}}),J.delete(this),ne.delete(this),E.sqlite3_close_v2(Q),this.onclose&&this.onclose.after instanceof Function)try{this.onclose.after(this)}catch{}delete this.filename}},changes:function(Q=!1,te=!1){const N=ae(this).pointer;return Q?te?E.sqlite3_total_changes64(N):E.sqlite3_total_changes(N):te?E.sqlite3_changes64(N):E.sqlite3_changes(N)},dbFilename:function(Q="main"){return E.sqlite3_db_filename(ae(this).pointer,Q)},dbName:function(Q=0){return E.sqlite3_db_name(ae(this).pointer,Q)},dbVfsName:function(Q=0){let te;const N=E.sqlite3_js_db_vfs(ae(this).pointer,Q);if(N){const W=new E.sqlite3_vfs(N);try{te=S.cstrToJs(W.$zName)}finally{W.dispose()}}return te},prepare:function(Q){ae(this);const te=S.pstack.pointer;let N,W;try{N=S.pstack.alloc(8),he.checkRc(this,E.sqlite3_prepare_v2(this.pointer,Q,-1,N,null)),W=S.peekPtr(N)}finally{S.pstack.restore(te)}W||w("Cannot prepare empty SQL.");const Z=new se(this,W,Ae);return ne.get(this)[W]=Z,Z},exec:function(){ae(this);const Q=Te(this,arguments);if(!Q.sql)return w("exec() requires an SQL string.");const te=Q.opt,N=te.callback,W=Array.isArray(te.resultRows)?te.resultRows:void 0;let Z,me=te.bind,De=!!(Q.cbArg||te.columnNames||W);const Ye=S.scopedAllocPush(),Xe=Array.isArray(te.saveSql)?te.saveSql:void 0;try{const it=P.isSQLableTypedArray(Q.sql);let ct=it?Q.sql.byteLength:S.jstrlen(Q.sql);const Re=S.scopedAlloc(2*S.ptrSizeof+(ct+1)),ie=Re+S.ptrSizeof;let ye=ie+S.ptrSizeof;const Be=ye+ct;for(it?S.heap8().set(Q.sql,ye):S.jstrcpy(Q.sql,S.heap8(),ye,ct,!1),S.poke(ye+ct,0);ye&&S.peek(ye,"i8");){S.pokePtr([Re,ie],0),he.checkRc(this,E.sqlite3_prepare_v3(this.pointer,ye,ct,0,Re,ie));const Me=S.peekPtr(Re);if(ye=S.peekPtr(ie),ct=Be-ye,!!Me){if(Xe&&Xe.push(E.sqlite3_sql(Me).trim()),Z=new se(this,Me,Ae),me&&Z.parameterCount&&(Z.bind(me),me=null),De&&Z.columnCount){let je=Array.isArray(te.columnNames)?0:1;if(De=!1,Q.cbArg||W){const le=Object.create(null);for(;Z.step();Z._lockedByExec=!1){je++===0&&Z.getColumnNames(le.columnNames=te.columnNames||[]),Z._lockedByExec=!0;const Se=Q.cbArg(Z,le);if(W&&W.push(Se),N&&N.call(te,Se,Z)===!1)break}Z._lockedByExec=!1}je===0&&Z.getColumnNames(te.columnNames)}else Z.step();Z.reset().finalize(),Z=null}}}finally{S.scopedAllocPop(Ye),Z&&(delete Z._lockedByExec,Z.finalize())}return Q.returnVal()},createFunction:function(te,N,W){const Z=le=>le instanceof Function;switch(arguments.length){case 1:W=te,te=W.name,N=W.xFunc||0;break;case 2:Z(N)||(W=N,N=W.xFunc||0);break}W||(W={}),typeof te!="string"&&w("Invalid arguments: missing function name.");let me=W.xStep||0,De=W.xFinal||0;const Ye=W.xValue||0,Xe=W.xInverse||0;let it;Z(N)?(it=!1,(Z(me)||Z(De))&&w("Ambiguous arguments: scalar or aggregate?"),me=De=null):Z(me)?(Z(De)||w("Missing xFinal() callback for aggregate or window UDF."),N=null):Z(De)?w("Missing xStep() callback for aggregate or window UDF."):w("Missing function-type properties."),it===!1?(Z(Ye)||Z(Xe))&&w("xValue and xInverse are not permitted for non-window UDFs."):Z(Ye)?(Z(Xe)||w("xInverse must be provided if xValue is."),it=!0):Z(Xe)&&w("xValue must be provided if xInverse is.");const ct=W.pApp;ct!=null&&(typeof ct!="number"||!P.isInt32(ct))&&w("Invalid value for pApp property. Must be a legal WASM pointer value.");const Re=W.xDestroy||0;Re&&!Z(Re)&&w("xDestroy property must be a function.");let ie=0;Ee(W,"deterministic")&&(ie|=E.SQLITE_DETERMINISTIC),Ee(W,"directOnly")&&(ie|=E.SQLITE_DIRECTONLY),Ee(W,"innocuous")&&(ie|=E.SQLITE_INNOCUOUS),te=te.toLowerCase();const ye=N||me,Be=Ee(W,"arity"),Me=typeof Be=="number"?Be:ye.length?ye.length-1:0;let je;return it?je=E.sqlite3_create_window_function(this.pointer,te,Me,E.SQLITE_UTF8|ie,ct||0,me,De,Ye,Xe,Re):je=E.sqlite3_create_function_v2(this.pointer,te,Me,E.SQLITE_UTF8|ie,ct||0,N,me,De,Re),he.checkRc(this,je),this},selectValue:function(Q,te,N){return ve(this,Q,te,0,N)},selectValues:function(Q,te,N){const W=this.prepare(Q),Z=[];try{for(W.bind(te);W.step();)Z.push(W.get(0,N));W.reset()}finally{W.finalize()}return Z},selectArray:function(Q,te){return ve(this,Q,te,[])},selectObject:function(Q,te){return ve(this,Q,te,{})},selectArrays:function(Q,te){return fe(this,Q,te,"array")},selectObjects:function(Q,te){return fe(this,Q,te,"object")},openStatementCount:function(){return this.pointer?Object.keys(ne.get(this)).length:0},transaction:function(Q){let te="BEGIN";arguments.length>1&&(/[^a-zA-Z]/.test(arguments[0])&&w(E.SQLITE_MISUSE,"Invalid argument for BEGIN qualifier."),te+=" "+arguments[0],Q=arguments[1]),ae(this).exec(te);try{const N=Q(this);return this.exec("COMMIT"),N}catch(N){throw this.exec("ROLLBACK"),N}},savepoint:function(Q){ae(this).exec("SAVEPOINT oo1");try{const te=Q(this);return this.exec("RELEASE oo1"),te}catch(te){throw this.exec("ROLLBACK to SAVEPOINT oo1; RELEASE SAVEPOINT oo1"),te}},checkRc:function(Q){return Ie(this,Q)}};const xe=function(Q){return Q.pointer||w("Stmt has been closed."),Q},He=function(Q){let te=Ae[Q==null?"null":typeof Q];switch(te){case Ae.boolean:case Ae.null:case Ae.number:case Ae.string:return te;case Ae.bigint:if(S.bigIntEnabled)return te;default:return P.isBindableTypedArray(Q)?Ae.blob:void 0}},K=function(Q){return He(Q)||w("Unsupported bind() argument type:",typeof Q)},X=function(Q,te){const N=typeof te=="number"?te:E.sqlite3_bind_parameter_index(Q.pointer,te);return N===0||!P.isInt32(N)?w("Invalid bind() parameter name: "+te):(N<1||N>Q.parameterCount)&&w("Bind index",te,"is out of range."),N},oe=function(Q,te){return Q._lockedByExec&&w("Operation is illegal when statement is locked:",te),Q},Pe=function Q(te,N,W,Z){oe(xe(te),"bind()"),Q._||(Q._tooBigInt=De=>w("BigInt value is too big to store without precision loss:",De),Q._={string:function(De,Ye,Xe,it){const[ct,Re]=S.allocCString(Xe,!0);return(it?E.sqlite3_bind_blob:E.sqlite3_bind_text)(De.pointer,Ye,ct,Re,E.SQLITE_WASM_DEALLOC)}}),K(Z),N=X(te,N);let me=0;switch(Z==null?Ae.null:W){case Ae.null:me=E.sqlite3_bind_null(te.pointer,N);break;case Ae.string:me=Q._.string(te,N,Z,!1);break;case Ae.number:{let De;P.isInt32(Z)?De=E.sqlite3_bind_int:typeof Z=="bigint"?P.bigIntFits64(Z)?S.bigIntEnabled?De=E.sqlite3_bind_int64:P.bigIntFitsDouble(Z)?(Z=Number(Z),De=E.sqlite3_bind_double):Q._tooBigInt(Z):Q._tooBigInt(Z):(Z=Number(Z),S.bigIntEnabled&&Number.isInteger(Z)?De=E.sqlite3_bind_int64:De=E.sqlite3_bind_double),me=De(te.pointer,N,Z);break}case Ae.boolean:me=E.sqlite3_bind_int(te.pointer,N,Z?1:0);break;case Ae.blob:{if(typeof Z=="string"){me=Q._.string(te,N,Z,!0);break}else Z instanceof ArrayBuffer?Z=new Uint8Array(Z):P.isBindableTypedArray(Z)||w("Binding a value as a blob requires","that it be a string, Uint8Array, Int8Array, or ArrayBuffer.");const De=S.alloc(Z.byteLength||1);S.heap8().set(Z.byteLength?Z:[0],De),me=E.sqlite3_bind_blob(te.pointer,N,De,Z.byteLength,E.SQLITE_WASM_DEALLOC);break}default:d.config.warn("Unsupported bind() argument type:",Z),w("Unsupported bind() argument type: "+typeof Z)}return me&&he.checkRc(te.db.pointer,me),te._mayGet=!1,te};se.prototype={finalize:function(){if(this.pointer){oe(this,"finalize()");const Q=E.sqlite3_finalize(this.pointer);return delete ne.get(this.db)[this.pointer],J.delete(this),delete this._mayGet,delete this.parameterCount,delete this._lockedByExec,delete this.db,Q}},clearBindings:function(){return oe(xe(this),"clearBindings()"),E.sqlite3_clear_bindings(this.pointer),this._mayGet=!1,this},reset:function(Q){oe(this,"reset()"),Q&&this.clearBindings();const te=E.sqlite3_reset(xe(this).pointer);return this._mayGet=!1,Ie(this.db,te),this},bind:function(){xe(this);let Q,te;switch(arguments.length){case 1:Q=1,te=arguments[0];break;case 2:Q=arguments[0],te=arguments[1];break;default:w("Invalid bind() arguments.")}return te===void 0?this:(this.parameterCount||w("This statement has no bindable parameters."),this._mayGet=!1,te===null?Pe(this,Q,Ae.null,te):Array.isArray(te)?(arguments.length!==1&&w("When binding an array, an index argument is not permitted."),te.forEach((N,W)=>Pe(this,W+1,K(N),N)),this):(te instanceof ArrayBuffer&&(te=new Uint8Array(te)),typeof te=="object"&&!P.isBindableTypedArray(te)?(arguments.length!==1&&w("When binding an object, an index argument is not permitted."),Object.keys(te).forEach(N=>Pe(this,N,K(te[N]),te[N])),this):Pe(this,Q,K(te),te)))},bindAsBlob:function(Q,te){xe(this),arguments.length===1&&(te=Q,Q=1);const N=K(te);return Ae.string!==N&&Ae.blob!==N&&Ae.null!==N&&w("Invalid value type for bindAsBlob()"),Pe(this,Q,Ae.blob,te)},step:function(){oe(this,"step()");const Q=E.sqlite3_step(xe(this).pointer);switch(Q){case E.SQLITE_DONE:return this._mayGet=!1;case E.SQLITE_ROW:return this._mayGet=!0;default:this._mayGet=!1,d.config.warn("sqlite3_step() rc=",Q,E.sqlite3_js_rc_str(Q),"SQL =",E.sqlite3_sql(this.pointer)),he.checkRc(this.db.pointer,Q)}},stepReset:function(){return this.step(),this.reset()},stepFinalize:function(){try{const Q=this.step();return this.reset(),Q}finally{try{this.finalize()}catch{}}},get:function(Q,te){if(xe(this)._mayGet||w("Stmt.step() has not (recently) returned true."),Array.isArray(Q)){let N=0;const W=this.columnCount;for(;N<W;)Q[N]=this.get(N++);return Q}else if(Q&&typeof Q=="object"){let N=0;const W=this.columnCount;for(;N<W;)Q[E.sqlite3_column_name(this.pointer,N)]=this.get(N++);return Q}switch(ue(this,Q),te===void 0?E.sqlite3_column_type(this.pointer,Q):te){case E.SQLITE_NULL:return null;case E.SQLITE_INTEGER:if(S.bigIntEnabled){const N=E.sqlite3_column_int64(this.pointer,Q);return N>=Number.MIN_SAFE_INTEGER&&N<=Number.MAX_SAFE_INTEGER?Number(N).valueOf():N}else{const N=E.sqlite3_column_double(this.pointer,Q);return(N>Number.MAX_SAFE_INTEGER||N<Number.MIN_SAFE_INTEGER)&&w("Integer is out of range for JS integer range: "+N),P.isInt32(N)?N|0:N}case E.SQLITE_FLOAT:return E.sqlite3_column_double(this.pointer,Q);case E.SQLITE_TEXT:return E.sqlite3_column_text(this.pointer,Q);case E.SQLITE_BLOB:{const N=E.sqlite3_column_bytes(this.pointer,Q),W=E.sqlite3_column_blob(this.pointer,Q),Z=new Uint8Array(N);return N&&Z.set(S.heap8u().slice(W,W+N),0),N&&this.db._blobXfer instanceof Array&&this.db._blobXfer.push(Z.buffer),Z}default:w("Don't know how to translate","type of result column #"+Q+".")}w("Not reached.")},getInt:function(Q){return this.get(Q,E.SQLITE_INTEGER)},getFloat:function(Q){return this.get(Q,E.SQLITE_FLOAT)},getString:function(Q){return this.get(Q,E.SQLITE_TEXT)},getBlob:function(Q){return this.get(Q,E.SQLITE_BLOB)},getJSON:function(Q){const te=this.get(Q,E.SQLITE_STRING);return te===null?te:JSON.parse(te)},getColumnName:function(Q){return E.sqlite3_column_name(ue(xe(this),Q).pointer,Q)},getColumnNames:function(Q=[]){ue(xe(this),0);const te=this.columnCount;for(let N=0;N<te;++N)Q.push(E.sqlite3_column_name(this.pointer,N));return Q},getParamIndex:function(Q){return xe(this).parameterCount?E.sqlite3_bind_parameter_index(this.pointer,Q):void 0},getParamName:function(Q){return xe(this).parameterCount?E.sqlite3_bind_parameter_name(this.pointer,Q):void 0},isBusy:function(){return E.sqlite3_stmt_busy(xe(this))!==0},isReadOnly:function(){return E.sqlite3_stmt_readonly(xe(this))!==0}};{const Q={enumerable:!0,get:function(){return J.get(this)},set:()=>w("The pointer property is read-only.")};Object.defineProperty(se.prototype,"pointer",Q),Object.defineProperty(he.prototype,"pointer",Q)}if(Object.defineProperty(se.prototype,"columnCount",{enumerable:!1,get:function(){return E.sqlite3_column_count(this.pointer)},set:()=>w("The columnCount property is read-only.")}),d.oo1={DB:he,Stmt:se},P.isUIThread()){d.oo1.JsStorageDb=function(te="session"){const N=be.normalizeArgs(...arguments);te=N.filename,te!=="session"&&te!=="local"&&w("JsStorageDb db name must be one of 'session' or 'local'."),N.vfs="kvvfs",be.call(this,N)};const Q=d.oo1.JsStorageDb;Q.prototype=Object.create(he.prototype),Q.clearStorage=E.sqlite3_js_kvvfs_clear,Q.prototype.clearStorage=function(){return Q.clearStorage(ae(this).filename)},Q.storageSize=E.sqlite3_js_kvvfs_size,Q.prototype.storageSize=function(){return Q.storageSize(ae(this).filename)}}}),globalThis.sqlite3ApiBootstrap.initializers.push(function(d){const w=d.util;d.initWorker1API=(function(){const E=(...be)=>{throw new Error(be.join(" "))};globalThis.WorkerGlobalScope instanceof Function||E("initWorker1API() must be run from a Worker thread.");const S=this.sqlite3||E("Missing this.sqlite3 object."),P=S.oo1.DB,J=function(be){let he=ne.idMap.get(be);return he||(he="db#"+ ++ne.idSeq+"@"+be.pointer,ne.idMap.set(be,he),he)},ne={dbList:[],idSeq:0,idMap:new WeakMap,xfer:[],open:function(be){const he=new P(be);return this.dbs[J(he)]=he,this.dbList.indexOf(he)<0&&this.dbList.push(he),he},close:function(be,he){if(be){delete this.dbs[J(be)];const Ae=be.filename,se=w.sqlite3__wasm_db_vfs(be.pointer,0);be.close();const ae=this.dbList.indexOf(be);ae>=0&&this.dbList.splice(ae,1),he&&Ae&&se&&w.sqlite3__wasm_vfs_unlink(se,Ae)}},post:function(be,he){he&&he.length?(globalThis.postMessage(be,Array.from(he)),he.length=0):globalThis.postMessage(be)},dbs:Object.create(null),getDb:function(be,he=!0){return this.dbs[be]||(he?E("Unknown (or closed) DB ID:",be):void 0)}},Ee=function(be=ne.dbList[0]){return be&&be.pointer?be:E("DB is not opened.")},Ie=function(be,he=!0){const Ae=ne.getDb(be.dbId,!1)||ne.dbList[0];return he?Ee(Ae):Ae},qe=function(){return ne.dbList[0]&&J(ne.dbList[0])},Oe={open:function(be){const he=Object.create(null),Ae=be.args||Object.create(null);Ae.simulateError&&E("Throwing because of simulateError flag.");const se=Object.create(null);he.vfs=Ae.vfs,he.filename=Ae.filename||"";const ae=ne.open(he);return se.filename=ae.filename,se.persistent=!!S.capi.sqlite3_js_db_uses_vfs(ae.pointer,"opfs"),se.dbId=J(ae),se.vfs=ae.dbVfsName(),se},close:function(be){const he=Ie(be,!1),Ae={filename:he&&he.filename};if(he){const se=be.args&&typeof be.args=="object"?!!be.args.unlink:!1;ne.close(he,se)}return Ae},exec:function(be){const he=typeof be.args=="string"?{sql:be.args}:be.args||Object.create(null);he.rowMode==="stmt"?E("Invalid rowMode for 'exec': stmt mode","does not work in the Worker API."):he.sql||E("'exec' requires input SQL.");const Ae=Ie(be);(he.callback||Array.isArray(he.resultRows))&&(Ae._blobXfer=ne.xfer);const se=he.callback;let ae=0;const ue=!!he.columnNames;typeof se=="string"&&(ue||(he.columnNames=[]),he.callback=function(Te,ve){ne.post({type:se,columnNames:he.columnNames,rowNumber:++ae,row:Te},ne.xfer)});try{const Te=he.countChanges?Ae.changes(!0,he.countChanges===64):void 0;Ae.exec(he),Te!==void 0&&(he.changeCount=Ae.changes(!0,he.countChanges===64)-Te);const ve=he.lastInsertRowId?S.capi.sqlite3_last_insert_rowid(Ae):void 0;ve!==void 0&&(he.lastInsertRowId=ve),he.callback instanceof Function&&(he.callback=se,ne.post({type:se,columnNames:he.columnNames,rowNumber:null,row:void 0}))}finally{delete Ae._blobXfer,he.callback&&(he.callback=se)}return he},"config-get":function(){const be=Object.create(null),he=S.config;return["bigIntEnabled"].forEach(function(Ae){Object.getOwnPropertyDescriptor(he,Ae)&&(be[Ae]=he[Ae])}),be.version=S.version,be.vfsList=S.capi.sqlite3_js_vfs_list(),be},export:function(be){const he=Ie(be),Ae={byteArray:S.capi.sqlite3_js_db_export(he.pointer),filename:he.filename,mimetype:"application/x-sqlite3"};return ne.xfer.push(Ae.byteArray.buffer),Ae},toss:function(be){E("Testing worker exception")}};globalThis.onmessage=async function(be){be=be.data;let he,Ae=be.dbId,se=be.type;const ae=performance.now();try{Oe.hasOwnProperty(se)&&Oe[se]instanceof Function?he=await Oe[se](be):E("Unknown db worker message type:",be.type)}catch(ue){se="error",he={operation:be.type,message:ue.message,errorClass:ue.name,input:be},ue.stack&&(he.stack=typeof ue.stack=="string"?ue.stack.split(/\n\s*/):ue.stack)}Ae||(Ae=he.dbId||qe()),ne.post({type:se,dbId:Ae,messageId:be.messageId,workerReceivedTime:ae,workerRespondTime:performance.now(),departureTime:be.departureTime,result:he},ne.xfer)},globalThis.postMessage({type:"sqlite3-api",result:"worker1-ready"})}).bind({sqlite3:d})}),globalThis.sqlite3ApiBootstrap.initializers.push(function(d){const w=d.wasm,E=d.capi,S=d.util.toss3,P=Object.create(null);d.vfs=P,E.sqlite3_vfs.prototype.registerVfs=function(J=!1){this instanceof d.capi.sqlite3_vfs||S("Expecting a sqlite3_vfs-type argument.");const ne=E.sqlite3_vfs_register(this,J?1:0);return ne&&S("sqlite3_vfs_register(",this,") failed with rc",ne),this.pointer!==E.sqlite3_vfs_find(this.$zName)&&S("BUG: sqlite3_vfs_find(vfs.$zName) failed for just-installed VFS",this),this},P.installVfs=function(J){let ne=0;const Ee=["io","vfs"];for(const Ie of Ee){const qe=J[Ie];qe&&(++ne,qe.struct.installMethods(qe.methods,!!qe.applyArgcCheck),Ie==="vfs"&&(!qe.struct.$zName&&typeof qe.name=="string"&&qe.struct.addOnDispose(qe.struct.$zName=w.allocCString(qe.name)),qe.struct.registerVfs(!!qe.asDefault)))}return ne||S("Misuse: installVfs() options object requires at least","one of:",Ee),this}}),globalThis.sqlite3ApiBootstrap.initializers.push(function(d){if(!d.wasm.exports.sqlite3_declare_vtab)return;const w=d.wasm,E=d.capi,S=d.util.toss3,P=Object.create(null);d.vtab=P;const J=E.sqlite3_index_info;J.prototype.nthConstraint=function(Ie,qe=!1){if(Ie<0||Ie>=this.$nConstraint)return!1;const Oe=this.$aConstraint+J.sqlite3_index_constraint.structInfo.sizeof*Ie;return qe?Oe:new J.sqlite3_index_constraint(Oe)},J.prototype.nthConstraintUsage=function(Ie,qe=!1){if(Ie<0||Ie>=this.$nConstraint)return!1;const Oe=this.$aConstraintUsage+J.sqlite3_index_constraint_usage.structInfo.sizeof*Ie;return qe?Oe:new J.sqlite3_index_constraint_usage(Oe)},J.prototype.nthOrderBy=function(Ie,qe=!1){if(Ie<0||Ie>=this.$nOrderBy)return!1;const Oe=this.$aOrderBy+J.sqlite3_index_orderby.structInfo.sizeof*Ie;return qe?Oe:new J.sqlite3_index_orderby(Oe)};const ne=function(Ie,qe){return(function(Oe,be=!1){if(arguments.length===0&&(Oe=new qe),Oe instanceof qe)return this.set(Oe.pointer,Oe),Oe;w.isPtr(Oe)||d.SQLite3Error.toss("Invalid argument to",Ie+"()");let he=this.get(Oe);return be&&this.delete(Oe),he}).bind(new Map)},Ee=function(Ie,qe){const Oe=ne(Ie,qe);return Object.assign(Object.create(null),{StructType:qe,create:be=>{const he=Oe();return w.pokePtr(be,he.pointer),he},get:be=>Oe(be),unget:be=>Oe(be,!0),dispose:be=>{const he=Oe(be,!0);he&&he.dispose()}})};P.xVtab=Ee("xVtab",E.sqlite3_vtab),P.xCursor=Ee("xCursor",E.sqlite3_vtab_cursor),P.xIndexInfo=Ie=>new E.sqlite3_index_info(Ie),P.xError=function Ie(qe,Oe,be){if(Ie.errorReporter instanceof Function)try{Ie.errorReporter("sqlite3_module::"+qe+"(): "+Oe.message)}catch{}let he;return Oe instanceof d.WasmAllocError?he=E.SQLITE_NOMEM:arguments.length>2?he=be:Oe instanceof d.SQLite3Error&&(he=Oe.resultCode),he||E.SQLITE_ERROR},P.xError.errorReporter=console.error.bind(console),P.xRowid=(Ie,qe)=>w.poke(Ie,qe,"i64"),P.setupModule=function(Ie){let qe=!1;const Oe=this instanceof E.sqlite3_module?this:Ie.struct||(qe=new E.sqlite3_module);try{const be=Ie.methods||S("Missing 'methods' object.");for(const he of Object.entries({xConnect:"xCreate",xDisconnect:"xDestroy"})){const Ae=he[0],se=he[1];be[Ae]===!0?be[Ae]=be[se]:be[se]===!0&&(be[se]=be[Ae])}if(Ie.catchExceptions){const he=function(ae,ue){return["xConnect","xCreate"].indexOf(ae)>=0?function(Te,ve,fe,xe,He,K){try{return ue(...arguments)||0}catch(X){return X instanceof d.WasmAllocError||(w.dealloc(w.peekPtr(K)),w.pokePtr(K,w.allocCString(X.message))),P.xError(ae,X)}}:function(...Te){try{return ue(...Te)||0}catch(ve){return P.xError(ae,ve)}}},Ae=["xCreate","xConnect","xBestIndex","xDisconnect","xDestroy","xOpen","xClose","xFilter","xNext","xEof","xColumn","xRowid","xUpdate","xBegin","xSync","xCommit","xRollback","xFindFunction","xRename","xSavepoint","xRelease","xRollbackTo","xShadowName"],se=Object.create(null);for(const ae of Ae){const ue=be[ae];if(ue instanceof Function)ae==="xConnect"&&be.xCreate===ue?se[ae]=be.xCreate:ae==="xCreate"&&be.xConnect===ue?se[ae]=be.xConnect:se[ae]=he(ae,ue);else continue}Oe.installMethods(se,!1)}else Oe.installMethods(be,!!Ie.applyArgcCheck);if(Oe.$iVersion===0){let he;typeof Ie.iVersion=="number"?he=Ie.iVersion:Oe.$xShadowName?he=3:Oe.$xSavePoint||Oe.$xRelease||Oe.$xRollbackTo?he=2:he=1,Oe.$iVersion=he}}catch(be){throw qe&&qe.dispose(),be}return Oe},E.sqlite3_module.prototype.setupModule=function(Ie){return P.setupModule.call(this,Ie)}}),globalThis.sqlite3ApiBootstrap.initializers.push(function(d){const w=function E(S){if(!globalThis.SharedArrayBuffer||!globalThis.Atomics)return Promise.reject(new Error("Cannot install OPFS: Missing SharedArrayBuffer and/or Atomics. The server must emit the COOP/COEP response headers to enable those. See https://sqlite.org/wasm/doc/trunk/persistence.md#coop-coep"));if(typeof WorkerGlobalScope>"u")return Promise.reject(new Error("The OPFS sqlite3_vfs cannot run in the main thread because it requires Atomics.wait()."));if(!globalThis.FileSystemHandle||!globalThis.FileSystemDirectoryHandle||!globalThis.FileSystemFileHandle||!globalThis.FileSystemFileHandle.prototype.createSyncAccessHandle||!navigator?.storage?.getDirectory)return Promise.reject(new Error("Missing required OPFS APIs."));(!S||typeof S!="object")&&(S=Object.create(null));const P=new URL(globalThis.location.href).searchParams;return P.has("opfs-disable")?Promise.resolve(d):(S.verbose===void 0&&(S.verbose=P.has("opfs-verbose")?+P.get("opfs-verbose")||2:1),S.sanityChecks===void 0&&(S.sanityChecks=P.has("opfs-sanity-check")),S.proxyUri===void 0&&(S.proxyUri=E.defaultProxyUri),typeof S.proxyUri=="function"&&(S.proxyUri=S.proxyUri()),new Promise(function(ne,Ee){const Ie=[d.config.error,d.config.warn,d.config.log],qe=(le,...Se)=>{S.verbose>le&&Ie[le]("OPFS syncer:",...Se)},Oe=(...le)=>qe(2,...le),be=(...le)=>qe(1,...le),he=(...le)=>qe(0,...le),Ae=d.util.toss,se=d.capi,ae=d.util,ue=d.wasm,Te=se.sqlite3_vfs,ve=se.sqlite3_file,fe=se.sqlite3_io_methods,xe=Object.create(null),He=()=>globalThis.FileSystemHandle&&globalThis.FileSystemDirectoryHandle&&globalThis.FileSystemFileHandle&&globalThis.FileSystemFileHandle.prototype.createSyncAccessHandle&&navigator?.storage?.getDirectory;xe.metrics={dump:function(){let le,Se=0,Ce=0,Ke=0;for(le in Z.opIds){const Fe=me[le];Se+=Fe.count,Ce+=Fe.time,Ke+=Fe.wait,Fe.avgTime=Fe.count&&Fe.time?Fe.time/Fe.count:0,Fe.avgWait=Fe.count&&Fe.wait?Fe.wait/Fe.count:0}d.config.log(globalThis.location.href,"metrics for",globalThis.location.href,":",me,`
Total of`,Se,"op(s) for",Ce,"ms (incl. "+Ke+" ms of waiting on the async side)"),d.config.log("Serialization metrics:",me.s11n),te.postMessage({type:"opfs-async-metrics"})},reset:function(){let le;const Se=Ke=>Ke.count=Ke.time=Ke.wait=0;for(le in Z.opIds)Se(me[le]=Object.create(null));let Ce=me.s11n=Object.create(null);Ce=Ce.serialize=Object.create(null),Ce.count=Ce.time=0,Ce=me.s11n.deserialize=Object.create(null),Ce.count=Ce.time=0}};const K=new fe,X=new Te().addOnDispose(()=>K.dispose());let oe;const Pe=le=>(oe=!0,X.dispose(),Ee(le)),Q=()=>(oe=!1,ne(d)),te=new Worker(new URL(""+new URL("sqlite3-opfs-async-proxy-B_ImRJXp.js",import.meta.url).href,import.meta.url));setTimeout(()=>{oe===void 0&&Pe(new Error("Timeout while waiting for OPFS async proxy worker."))},4e3),te._originalOnError=te.onerror,te.onerror=function(le){he("Error initializing OPFS asyncer:",le),Pe(new Error("Loading OPFS async Worker failed for unknown reasons."))};const N=se.sqlite3_vfs_find(null),W=N?new Te(N):null;K.$iVersion=1,X.$iVersion=2,X.$szOsFile=se.sqlite3_file.structInfo.sizeof,X.$mxPathname=1024,X.$zName=ue.allocCString("opfs"),X.$xDlOpen=X.$xDlError=X.$xDlSym=X.$xDlClose=null,X.addOnDispose("$zName",X.$zName,"cleanup default VFS wrapper",()=>W?W.dispose():null);const Z=Object.create(null);Z.verbose=S.verbose,Z.littleEndian=(()=>{const le=new ArrayBuffer(2);return new DataView(le).setInt16(0,256,!0),new Int16Array(le)[0]===256})(),Z.asyncIdleWaitTime=150,Z.asyncS11nExceptions=1,Z.fileBufferSize=1024*64,Z.sabS11nOffset=Z.fileBufferSize,Z.sabS11nSize=X.$mxPathname*2,Z.sabIO=new SharedArrayBuffer(Z.fileBufferSize+Z.sabS11nSize),Z.opIds=Object.create(null);const me=Object.create(null);{let le=0;Z.opIds.whichOp=le++,Z.opIds.rc=le++,Z.opIds.xAccess=le++,Z.opIds.xClose=le++,Z.opIds.xDelete=le++,Z.opIds.xDeleteNoWait=le++,Z.opIds.xFileSize=le++,Z.opIds.xLock=le++,Z.opIds.xOpen=le++,Z.opIds.xRead=le++,Z.opIds.xSleep=le++,Z.opIds.xSync=le++,Z.opIds.xTruncate=le++,Z.opIds.xUnlock=le++,Z.opIds.xWrite=le++,Z.opIds.mkdir=le++,Z.opIds["opfs-async-metrics"]=le++,Z.opIds["opfs-async-shutdown"]=le++,Z.opIds.retry=le++,Z.sabOP=new SharedArrayBuffer(le*4),xe.metrics.reset()}Z.sq3Codes=Object.create(null),["SQLITE_ACCESS_EXISTS","SQLITE_ACCESS_READWRITE","SQLITE_BUSY","SQLITE_CANTOPEN","SQLITE_ERROR","SQLITE_IOERR","SQLITE_IOERR_ACCESS","SQLITE_IOERR_CLOSE","SQLITE_IOERR_DELETE","SQLITE_IOERR_FSYNC","SQLITE_IOERR_LOCK","SQLITE_IOERR_READ","SQLITE_IOERR_SHORT_READ","SQLITE_IOERR_TRUNCATE","SQLITE_IOERR_UNLOCK","SQLITE_IOERR_WRITE","SQLITE_LOCK_EXCLUSIVE","SQLITE_LOCK_NONE","SQLITE_LOCK_PENDING","SQLITE_LOCK_RESERVED","SQLITE_LOCK_SHARED","SQLITE_LOCKED","SQLITE_MISUSE","SQLITE_NOTFOUND","SQLITE_OPEN_CREATE","SQLITE_OPEN_DELETEONCLOSE","SQLITE_OPEN_MAIN_DB","SQLITE_OPEN_READONLY"].forEach(le=>{(Z.sq3Codes[le]=se[le])===void 0&&Ae("Maintenance required: not found:",le)}),Z.opfsFlags=Object.assign(Object.create(null),{OPFS_UNLOCK_ASAP:1,OPFS_UNLINK_BEFORE_OPEN:2,defaultUnlockAsap:!1});const De=(le,...Se)=>{const Ce=Z.opIds[le]||Ae("Invalid op ID:",le);Z.s11n.serialize(...Se),Atomics.store(Z.sabOPView,Z.opIds.rc,-1),Atomics.store(Z.sabOPView,Z.opIds.whichOp,Ce),Atomics.notify(Z.sabOPView,Z.opIds.whichOp);const Ke=performance.now();for(;Atomics.wait(Z.sabOPView,Z.opIds.rc,-1)!=="not-equal";);const Fe=Atomics.load(Z.sabOPView,Z.opIds.rc);if(me[le].wait+=performance.now()-Ke,Fe&&Z.asyncS11nExceptions){const Qe=Z.s11n.deserialize();Qe&&he(le+"() async error:",...Qe)}return Fe};xe.debug={asyncShutdown:()=>{be("Shutting down OPFS async listener. The OPFS VFS will no longer work."),De("opfs-async-shutdown")},asyncRestart:()=>{be("Attempting to restart OPFS VFS async listener. Might work, might not."),te.postMessage({type:"opfs-async-restart"})}};const Ye=()=>{if(Z.s11n)return Z.s11n;const le=new TextDecoder,Se=new TextEncoder("utf-8"),Ce=new Uint8Array(Z.sabIO,Z.sabS11nOffset,Z.sabS11nSize),Ke=new DataView(Z.sabIO,Z.sabS11nOffset,Z.sabS11nSize);Z.s11n=Object.create(null);const Fe=Object.create(null);Fe.number={id:1,size:8,getter:"getFloat64",setter:"setFloat64"},Fe.bigint={id:2,size:8,getter:"getBigInt64",setter:"setBigInt64"},Fe.boolean={id:3,size:4,getter:"getInt32",setter:"setInt32"},Fe.string={id:4};const Qe=Ze=>Fe[typeof Ze]||Ae("Maintenance required: this value type cannot be serialized.",Ze),ft=Ze=>{switch(Ze){case Fe.number.id:return Fe.number;case Fe.bigint.id:return Fe.bigint;case Fe.boolean.id:return Fe.boolean;case Fe.string.id:return Fe.string;default:Ae("Invalid type ID:",Ze)}};return Z.s11n.deserialize=function(Ze=!1){++me.s11n.deserialize.count;const nn=performance.now(),we=Ce[0],Ne=we?[]:null;if(we){const Ve=[];let ze=1,gt,Bt,Rt;for(gt=0;gt<we;++gt,++ze)Ve.push(ft(Ce[ze]));for(gt=0;gt<we;++gt){const Pt=Ve[gt];Pt.getter?(Rt=Ke[Pt.getter](ze,Z.littleEndian),ze+=Pt.size):(Bt=Ke.getInt32(ze,Z.littleEndian),ze+=4,Rt=le.decode(Ce.slice(ze,ze+Bt)),ze+=Bt),Ne.push(Rt)}}return Ze&&(Ce[0]=0),me.s11n.deserialize.time+=performance.now()-nn,Ne},Z.s11n.serialize=function(...Ze){const nn=performance.now();if(++me.s11n.serialize.count,Ze.length){const we=[];let Ne=0,Ve=1;for(Ce[0]=Ze.length&255;Ne<Ze.length;++Ne,++Ve)we.push(Qe(Ze[Ne])),Ce[Ve]=we[Ne].id;for(Ne=0;Ne<Ze.length;++Ne){const ze=we[Ne];if(ze.setter)Ke[ze.setter](Ve,Ze[Ne],Z.littleEndian),Ve+=ze.size;else{const gt=Se.encode(Ze[Ne]);Ke.setInt32(Ve,gt.byteLength,Z.littleEndian),Ve+=4,Ce.set(gt,Ve),Ve+=gt.byteLength}}}else Ce[0]=0;me.s11n.serialize.time+=performance.now()-nn},Z.s11n},Xe=function le(Se=16){le._chars||(le._chars="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ012346789",le._n=le._chars.length);const Ce=[];let Ke=0;for(;Ke<Se;++Ke){const Fe=Math.random()*(le._n*64)%le._n|0;Ce[Ke]=le._chars[Fe]}return Ce.join("")},it=Object.create(null),ct=Object.create(null);ct.op=void 0,ct.start=void 0;const Re=le=>{ct.start=performance.now(),ct.op=le,++me[le].count},ie=()=>me[ct.op].time+=performance.now()-ct.start,ye={xCheckReservedLock:function(le,Se){return ue.poke(Se,0,"i32"),0},xClose:function(le){Re("xClose");let Se=0;const Ce=it[le];return Ce&&(delete it[le],Se=De("xClose",le),Ce.sq3File&&Ce.sq3File.dispose()),ie(),Se},xDeviceCharacteristics:function(le){return se.SQLITE_IOCAP_UNDELETABLE_WHEN_OPEN},xFileControl:function(le,Se,Ce){return se.SQLITE_NOTFOUND},xFileSize:function(le,Se){Re("xFileSize");let Ce=De("xFileSize",le);if(Ce==0)try{const Ke=Z.s11n.deserialize()[0];ue.poke(Se,Ke,"i64")}catch(Ke){he("Unexpected error reading xFileSize() result:",Ke),Ce=Z.sq3Codes.SQLITE_IOERR}return ie(),Ce},xLock:function(le,Se){Re("xLock");const Ce=it[le];let Ke=0;return Ce.lockType?Ce.lockType=Se:(Ke=De("xLock",le,Se),Ke===0&&(Ce.lockType=Se)),ie(),Ke},xRead:function(le,Se,Ce,Ke){Re("xRead");const Fe=it[le];let Qe;try{Qe=De("xRead",le,Ce,Number(Ke)),(Qe===0||se.SQLITE_IOERR_SHORT_READ===Qe)&&ue.heap8u().set(Fe.sabView.subarray(0,Ce),Se)}catch(ft){he("xRead(",arguments,") failed:",ft,Fe),Qe=se.SQLITE_IOERR_READ}return ie(),Qe},xSync:function(le,Se){Re("xSync"),++me.xSync.count;const Ce=De("xSync",le,Se);return ie(),Ce},xTruncate:function(le,Se){Re("xTruncate");const Ce=De("xTruncate",le,Number(Se));return ie(),Ce},xUnlock:function(le,Se){Re("xUnlock");const Ce=it[le];let Ke=0;return se.SQLITE_LOCK_NONE===Se&&Ce.lockType&&(Ke=De("xUnlock",le,Se)),Ke===0&&(Ce.lockType=Se),ie(),Ke},xWrite:function(le,Se,Ce,Ke){Re("xWrite");const Fe=it[le];let Qe;try{Fe.sabView.set(ue.heap8u().subarray(Se,Se+Ce)),Qe=De("xWrite",le,Ce,Number(Ke))}catch(ft){he("xWrite(",arguments,") failed:",ft,Fe),Qe=se.SQLITE_IOERR_WRITE}return ie(),Qe}},Be={xAccess:function(le,Se,Ce,Ke){Re("xAccess");const Fe=De("xAccess",ue.cstrToJs(Se));return ue.poke(Ke,Fe?0:1,"i32"),ie(),0},xCurrentTime:function(le,Se){return ue.poke(Se,24405875e-1+new Date().getTime()/864e5,"double"),0},xCurrentTimeInt64:function(le,Se){return ue.poke(Se,24405875e-1*864e5+new Date().getTime(),"i64"),0},xDelete:function(le,Se,Ce){Re("xDelete");const Ke=De("xDelete",ue.cstrToJs(Se),Ce,!1);return ie(),Ke},xFullPathname:function(le,Se,Ce,Ke){return ue.cstrncpy(Ke,Se,Ce)<Ce?0:se.SQLITE_CANTOPEN},xGetLastError:function(le,Se,Ce){return be("OPFS xGetLastError() has nothing sensible to return."),0},xOpen:function(Se,Ce,Ke,Fe,Qe){Re("xOpen");let ft=0;Ce===0?Ce=Xe():ue.isPtr(Ce)&&(se.sqlite3_uri_boolean(Ce,"opfs-unlock-asap",0)&&(ft|=Z.opfsFlags.OPFS_UNLOCK_ASAP),se.sqlite3_uri_boolean(Ce,"delete-before-open",0)&&(ft|=Z.opfsFlags.OPFS_UNLINK_BEFORE_OPEN),Ce=ue.cstrToJs(Ce));const Ze=Object.create(null);Ze.fid=Ke,Ze.filename=Ce,Ze.sab=new SharedArrayBuffer(Z.fileBufferSize),Ze.flags=Fe,Ze.readOnly=!(d.SQLITE_OPEN_CREATE&Fe)&&!!(Fe&se.SQLITE_OPEN_READONLY);const nn=De("xOpen",Ke,Ce,Fe,ft);return nn||(Ze.readOnly&&ue.poke(Qe,se.SQLITE_OPEN_READONLY,"i32"),it[Ke]=Ze,Ze.sabView=Z.sabFileBufView,Ze.sq3File=new ve(Ke),Ze.sq3File.$pMethods=K.pointer,Ze.lockType=se.SQLITE_LOCK_NONE),ie(),nn}};W&&(X.$xRandomness=W.$xRandomness,X.$xSleep=W.$xSleep),X.$xRandomness||(Be.xRandomness=function(le,Se,Ce){const Ke=ue.heap8u();let Fe=0;for(;Fe<Se;++Fe)Ke[Ce+Fe]=Math.random()*255e3&255;return Fe}),X.$xSleep||(Be.xSleep=function(le,Se){return Atomics.wait(Z.sabOPView,Z.opIds.xSleep,0,Se),0}),xe.getResolvedPath=function(le,Se){const Ce=new URL(le,"file://irrelevant").pathname;return Se?Ce.split("/").filter(Ke=>!!Ke):Ce},xe.getDirForFilename=async function(Se,Ce=!1){const Ke=xe.getResolvedPath(Se,!0),Fe=Ke.pop();let Qe=xe.rootDirectory;for(const ft of Ke)ft&&(Qe=await Qe.getDirectoryHandle(ft,{create:!!Ce}));return[Qe,Fe]},xe.mkdir=async function(le){try{return await xe.getDirForFilename(le+"/filepart",!0),!0}catch{return!1}},xe.entryExists=async function(le){try{const[Se,Ce]=await xe.getDirForFilename(le);return await Se.getFileHandle(Ce),!0}catch{return!1}},xe.randomFilename=Xe,xe.treeList=async function(){const le=async function Ce(Ke,Fe){Fe.name=Ke.name,Fe.dirs=[],Fe.files=[];for await(const Qe of Ke.values())if(Qe.kind==="directory"){const ft=Object.create(null);Fe.dirs.push(ft),await Ce(Qe,ft)}else Fe.files.push(Qe.name)},Se=Object.create(null);return await le(xe.rootDirectory,Se),Se},xe.rmfr=async function(){const le=xe.rootDirectory,Se={recurse:!0};for await(const Ce of le.values())le.removeEntry(Ce.name,Se)},xe.unlink=async function(le,Se=!1,Ce=!1){try{const[Ke,Fe]=await xe.getDirForFilename(le,!1);return await Ke.removeEntry(Fe,{recursive:Se}),!0}catch(Ke){if(Ce)throw new Error("unlink(",arguments[0],") failed: "+Ke.message,{cause:Ke});return!1}},xe.traverse=async function(le){const Se={recursive:!0,directory:xe.rootDirectory};typeof le=="function"&&(le={callback:le}),le=Object.assign(Se,le||{}),async function Ke(Fe,Qe){for await(const ft of Fe.values()){if(le.callback(ft,Fe,Qe)===!1)return!1;if(le.recursive&&ft.kind==="directory"&&await Ke(ft,Qe+1)===!1)break}}(le.directory,0)};const Me=async function(le,Se){const[Ce,Ke]=await xe.getDirForFilename(le,!0);let Qe=await(await Ce.getFileHandle(Ke,{create:!0})).createSyncAccessHandle(),ft=0,Ze,nn=!1;try{for(Qe.truncate(0);(Ze=await Se())!==void 0;)Ze instanceof ArrayBuffer&&(Ze=new Uint8Array(Ze)),ft===0&&Ze.byteLength>=15&&(ae.affirmDbHeader(Ze),nn=!0),Qe.write(Ze,{at:ft}),ft+=Ze.byteLength;if((ft<512||ft%512!==0)&&Ae("Input size",ft,"is not correct for an SQLite database."),!nn){const we=new Uint8Array(20);Qe.read(we,{at:0}),ae.affirmDbHeader(we)}return Qe.write(new Uint8Array([1,1]),{at:18}),ft}catch(we){throw await Qe.close(),Qe=void 0,await Ce.removeEntry(Ke).catch(()=>{}),we}finally{Qe&&await Qe.close()}};if(xe.importDb=async function(le,Se){if(Se instanceof Function)return Me(le,Se);Se instanceof ArrayBuffer&&(Se=new Uint8Array(Se)),ae.affirmIsDb(Se);const Ce=Se.byteLength,[Ke,Fe]=await xe.getDirForFilename(le,!0);let Qe,ft=0;try{return Qe=await(await Ke.getFileHandle(Fe,{create:!0})).createSyncAccessHandle(),Qe.truncate(0),ft=Qe.write(Se,{at:0}),ft!=Ce&&Ae("Expected to write "+Ce+" bytes but wrote "+ft+"."),Qe.write(new Uint8Array([1,1]),{at:18}),ft}catch(Ze){throw Qe&&(await Qe.close(),Qe=void 0),await Ke.removeEntry(Fe).catch(()=>{}),Ze}finally{Qe&&await Qe.close()}},d.oo1){const le=function(...Se){const Ce=d.oo1.DB.dbCtorHelper.normalizeArgs(...Se);Ce.vfs=X.$zName,d.oo1.DB.dbCtorHelper.call(this,Ce)};le.prototype=Object.create(d.oo1.DB.prototype),d.oo1.OpfsDb=le,le.importDb=xe.importDb,d.oo1.DB.dbCtorHelper.setVfsPostOpenCallback(X.pointer,function(Se,Ce){Ce.capi.sqlite3_busy_timeout(Se,1e4)})}const je=function(){const le=ue.scopedAllocPush(),Se=new ve;try{const Ce=Se.pointer,Ke=se.SQLITE_OPEN_CREATE|se.SQLITE_OPEN_READWRITE|se.SQLITE_OPEN_MAIN_DB,Fe=ue.scopedAlloc(8),Qe="/sanity/check/file"+Xe(8),ft=ue.scopedAllocCString(Qe);let Ze;if(Z.s11n.serialize("This is Ã¤ string."),Ze=Z.s11n.deserialize(),Oe("deserialize() says:",Ze),Ze[0]!=="This is Ã¤ string."&&Ae("String d13n error."),Be.xAccess(X.pointer,ft,0,Fe),Ze=ue.peek(Fe,"i32"),Oe("xAccess(",Qe,") exists ?=",Ze),Ze=Be.xOpen(X.pointer,ft,Ce,Ke,Fe),Oe("open rc =",Ze,"state.sabOPView[xOpen] =",Z.sabOPView[Z.opIds.xOpen]),Ze!==0){he("open failed with code",Ze);return}Be.xAccess(X.pointer,ft,0,Fe),Ze=ue.peek(Fe,"i32"),Ze||Ae("xAccess() failed to detect file."),Ze=ye.xSync(Se.pointer,0),Ze&&Ae("sync failed w/ rc",Ze),Ze=ye.xTruncate(Se.pointer,1024),Ze&&Ae("truncate failed w/ rc",Ze),ue.poke(Fe,0,"i64"),Ze=ye.xFileSize(Se.pointer,Fe),Ze&&Ae("xFileSize failed w/ rc",Ze),Oe("xFileSize says:",ue.peek(Fe,"i64")),Ze=ye.xWrite(Se.pointer,ft,10,1),Ze&&Ae("xWrite() failed!");const nn=ue.scopedAlloc(16);Ze=ye.xRead(Se.pointer,nn,6,2),ue.poke(nn+6,0);let we=ue.cstrToJs(nn);Oe("xRead() got:",we),we!=="sanity"&&Ae("Unexpected xRead() value."),Be.xSleep&&(Oe("xSleep()ing before close()ing..."),Be.xSleep(X.pointer,2e3),Oe("waking up from xSleep()")),Ze=ye.xClose(Ce),Oe("xClose rc =",Ze,"sabOPView =",Z.sabOPView),Oe("Deleting file:",Qe),Be.xDelete(X.pointer,ft,4660),Be.xAccess(X.pointer,ft,0,Fe),Ze=ue.peek(Fe,"i32"),Ze&&Ae("Expecting 0 from xAccess(",Qe,") after xDelete()."),be("End of OPFS sanity checks.")}finally{Se.dispose(),ue.scopedAllocPop(le)}};te.onmessage=function({data:le}){switch(le.type){case"opfs-unavailable":Pe(new Error(le.payload.join(" ")));break;case"opfs-async-loaded":te.postMessage({type:"opfs-async-init",args:Z});break;case"opfs-async-inited":{if(oe===!0)break;try{d.vfs.installVfs({io:{struct:K,methods:ye},vfs:{struct:X,methods:Be}}),Z.sabOPView=new Int32Array(Z.sabOP),Z.sabFileBufView=new Uint8Array(Z.sabIO,0,Z.fileBufferSize),Z.sabS11nView=new Uint8Array(Z.sabIO,Z.sabS11nOffset,Z.sabS11nSize),Ye(),S.sanityChecks&&(be("Running sanity checks because of opfs-sanity-check URL arg..."),je()),He()?navigator.storage.getDirectory().then(Se=>{te.onerror=te._originalOnError,delete te._originalOnError,d.opfs=xe,xe.rootDirectory=Se,Oe("End of OPFS sqlite3_vfs setup.",X),Q()}).catch(Pe):Q()}catch(Se){he(Se),Pe(Se)}break}default:{const Se="Unexpected message from the OPFS async worker: "+JSON.stringify(le);he(Se),Pe(new Error(Se));break}}}}))};w.defaultProxyUri="sqlite3-opfs-async-proxy.js",globalThis.sqlite3ApiBootstrap.initializersAsync.push(async E=>{try{let S=w.defaultProxyUri;return E.scriptInfo.sqlite3Dir&&(w.defaultProxyUri=E.scriptInfo.sqlite3Dir+S),w().catch(P=>{E.config.warn("Ignoring inability to install OPFS sqlite3_vfs:",P.message)})}catch(S){return E.config.error("installOpfsVfs() exception:",S),Promise.reject(S)}})}),globalThis.sqlite3ApiBootstrap.initializers.push(function(d){const w=d.util.toss,E=d.util.toss3,S=Object.create(null),P=d.capi,J=d.util,ne=d.wasm,Ee=4096,Ie=512,qe=4,Oe=8,be=Ie+qe,he=Ie,Ae=be,se=Ee,ae=P.SQLITE_OPEN_MAIN_DB|P.SQLITE_OPEN_MAIN_JOURNAL|P.SQLITE_OPEN_SUPER_JOURNAL|P.SQLITE_OPEN_WAL,ue=P.SQLITE_OPEN_MEMORY,Te=".opaque",ve=()=>Math.random().toString(36).slice(2),fe=new TextDecoder,xe=new TextEncoder,He=Object.assign(Object.create(null),{name:"opfs-sahpool",directory:void 0,initialCapacity:6,clearOnInit:!1,verbosity:2,forceReinitIfPreviouslyFailed:!1}),K=[d.config.error,d.config.warn,d.config.log];d.config.log;const X=d.config.warn;d.config.error;const oe=new Map,Pe=Re=>oe.get(Re),Q=(Re,ie)=>{ie?oe.set(Re,ie):oe.delete(Re)},te=new Map,N=Re=>te.get(Re),W=(Re,ie)=>{ie?te.set(Re,ie):te.delete(Re)},Z={xCheckReservedLock:function(Re,ie){const ye=N(Re);return ye.log("xCheckReservedLock"),ye.storeErr(),ne.poke32(ie,1),0},xClose:function(Re){const ie=N(Re);ie.storeErr();const ye=ie.getOFileForS3File(Re);if(ye)try{ie.log(`xClose ${ye.path}`),ie.mapS3FileToOFile(Re,!1),ye.sah.flush(),ye.flags&P.SQLITE_OPEN_DELETEONCLOSE&&ie.deletePath(ye.path)}catch(Be){return ie.storeErr(Be,P.SQLITE_IOERR)}return 0},xDeviceCharacteristics:function(Re){return P.SQLITE_IOCAP_UNDELETABLE_WHEN_OPEN},xFileControl:function(Re,ie,ye){return P.SQLITE_NOTFOUND},xFileSize:function(Re,ie){const ye=N(Re);ye.log("xFileSize");const Me=ye.getOFileForS3File(Re).sah.getSize()-se;return ne.poke64(ie,BigInt(Me)),0},xLock:function(Re,ie){const ye=N(Re);ye.log(`xLock ${ie}`),ye.storeErr();const Be=ye.getOFileForS3File(Re);return Be.lockType=ie,0},xRead:function(Re,ie,ye,Be){const Me=N(Re);Me.storeErr();const je=Me.getOFileForS3File(Re);Me.log(`xRead ${je.path} ${ye} @ ${Be}`);try{const le=je.sah.read(ne.heap8u().subarray(ie,ie+ye),{at:se+Number(Be)});return le<ye?(ne.heap8u().fill(0,ie+le,ie+ye),P.SQLITE_IOERR_SHORT_READ):0}catch(le){return Me.storeErr(le,P.SQLITE_IOERR)}},xSectorSize:function(Re){return Ee},xSync:function(Re,ie){const ye=N(Re);ye.log(`xSync ${ie}`),ye.storeErr();const Be=ye.getOFileForS3File(Re);try{return Be.sah.flush(),0}catch(Me){return ye.storeErr(Me,P.SQLITE_IOERR)}},xTruncate:function(Re,ie){const ye=N(Re);ye.log(`xTruncate ${ie}`),ye.storeErr();const Be=ye.getOFileForS3File(Re);try{return Be.sah.truncate(se+Number(ie)),0}catch(Me){return ye.storeErr(Me,P.SQLITE_IOERR)}},xUnlock:function(Re,ie){const ye=N(Re);ye.log("xUnlock");const Be=ye.getOFileForS3File(Re);return Be.lockType=ie,0},xWrite:function(Re,ie,ye,Be){const Me=N(Re);Me.storeErr();const je=Me.getOFileForS3File(Re);Me.log(`xWrite ${je.path} ${ye} ${Be}`);try{const le=je.sah.write(ne.heap8u().subarray(ie,ie+ye),{at:se+Number(Be)});return ye===le?0:w("Unknown write() failure.")}catch(le){return Me.storeErr(le,P.SQLITE_IOERR)}}},me=new P.sqlite3_io_methods;me.$iVersion=1,d.vfs.installVfs({io:{struct:me,methods:Z}});const De={xAccess:function(Re,ie,ye,Be){const Me=Pe(Re);Me.storeErr();try{const je=Me.getPath(ie);ne.poke32(Be,Me.hasFilename(je)?1:0)}catch{ne.poke32(Be,0)}return 0},xCurrentTime:function(Re,ie){return ne.poke(ie,24405875e-1+new Date().getTime()/864e5,"double"),0},xCurrentTimeInt64:function(Re,ie){return ne.poke(ie,24405875e-1*864e5+new Date().getTime(),"i64"),0},xDelete:function(Re,ie,ye){const Be=Pe(Re);Be.log(`xDelete ${ne.cstrToJs(ie)}`),Be.storeErr();try{return Be.deletePath(Be.getPath(ie)),0}catch(Me){return Be.storeErr(Me),P.SQLITE_IOERR_DELETE}},xFullPathname:function(Re,ie,ye,Be){return ne.cstrncpy(Be,ie,ye)<ye?0:P.SQLITE_CANTOPEN},xGetLastError:function(Re,ie,ye){const Be=Pe(Re),Me=Be.popErr();if(Be.log(`xGetLastError ${ie} e =`,Me),Me){const je=ne.scopedAllocPush();try{const[le,Se]=ne.scopedAllocCString(Me.message,!0);ne.cstrncpy(ye,le,ie),Se>ie&&ne.poke8(ye+ie-1,0)}catch{return P.SQLITE_NOMEM}finally{ne.scopedAllocPop(je)}}return Me?Me.sqlite3Rc||P.SQLITE_IOERR:0},xOpen:function(ie,ye,Be,Me,je){const le=Pe(ie);try{Me&=~ue,le.log(`xOpen ${ne.cstrToJs(ye)} ${Me}`);const Se=ye&&ne.peek8(ye)?le.getPath(ye):ve();let Ce=le.getSAHForPath(Se);!Ce&&Me&P.SQLITE_OPEN_CREATE&&(le.getFileCount()<le.getCapacity()?(Ce=le.nextAvailableSAH(),le.setAssociatedPath(Ce,Se,Me)):w("SAH pool is full. Cannot create file",Se)),Ce||w("file not found:",Se);const Ke={path:Se,flags:Me,sah:Ce};le.mapS3FileToOFile(Be,Ke),Ke.lockType=P.SQLITE_LOCK_NONE;const Fe=new P.sqlite3_file(Be);return Fe.$pMethods=me.pointer,Fe.dispose(),ne.poke32(je,Me),0}catch(Se){return le.storeErr(Se),P.SQLITE_CANTOPEN}}},Ye=function(Re){d.capi.sqlite3_vfs_find(Re)&&E("VFS name is already registered:",Re);const ie=new P.sqlite3_vfs,ye=P.sqlite3_vfs_find(null),Be=ye?new P.sqlite3_vfs(ye):null;return ie.$iVersion=2,ie.$szOsFile=P.sqlite3_file.structInfo.sizeof,ie.$mxPathname=Ie,ie.addOnDispose(ie.$zName=ne.allocCString(Re),()=>Q(ie.pointer,0)),Be&&(ie.$xRandomness=Be.$xRandomness,ie.$xSleep=Be.$xSleep,Be.dispose()),!ie.$xRandomness&&!De.xRandomness&&(De.xRandomness=function(Me,je,le){const Se=ne.heap8u();let Ce=0;for(;Ce<je;++Ce)Se[le+Ce]=Math.random()*255e3&255;return Ce}),!ie.$xSleep&&!De.xSleep&&(De.xSleep=(Me,je)=>0),d.vfs.installVfs({vfs:{struct:ie,methods:De}}),ie};class Xe{vfsDir;#e;#t;#n;#i=new Map;#r=new Map;#d=new Set;#u=new Map;#o=new Uint8Array(be);#g;#a;#p;constructor(ie=Object.create(null)){this.#p=ie.verbosity??He.verbosity,this.vfsName=ie.name||He.name,this.#a=Ye(this.vfsName),Q(this.#a.pointer,this),this.vfsDir=ie.directory||"."+this.vfsName,this.#g=new DataView(this.#o.buffer,this.#o.byteOffset),this.isReady=this.reset(!!(ie.clearOnInit??He.clearOnInit)).then(()=>{if(this.$error)throw this.$error;return this.getCapacity()?Promise.resolve(void 0):this.addCapacity(ie.initialCapacity||He.initialCapacity)})}#l(ie,...ye){this.#p>ie&&K[ie](this.vfsName+":",...ye)}log(...ie){this.#l(2,...ie)}warn(...ie){this.#l(1,...ie)}error(...ie){this.#l(0,...ie)}getVfs(){return this.#a}getCapacity(){return this.#i.size}getFileCount(){return this.#r.size}getFileNames(){const ie=[];for(const ye of this.#r.keys())ie.push(ye);return ie}async addCapacity(ie){for(let ye=0;ye<ie;++ye){const Be=ve(),je=await(await this.#t.getFileHandle(Be,{create:!0})).createSyncAccessHandle();this.#i.set(je,Be),this.setAssociatedPath(je,"",0)}return this.getCapacity()}async reduceCapacity(ie){let ye=0;for(const Be of Array.from(this.#d)){if(ye===ie||this.getFileCount()===this.getCapacity())break;const Me=this.#i.get(Be);Be.close(),await this.#t.removeEntry(Me),this.#i.delete(Be),this.#d.delete(Be),++ye}return ye}releaseAccessHandles(){for(const ie of this.#i.keys())ie.close();this.#i.clear(),this.#r.clear(),this.#d.clear()}async acquireAccessHandles(ie=!1){const ye=[];for await(const[Be,Me]of this.#t)Me.kind==="file"&&ye.push([Be,Me]);return Promise.all(ye.map(async([Be,Me])=>{try{const je=await Me.createSyncAccessHandle();if(this.#i.set(je,Be),ie)je.truncate(se),this.setAssociatedPath(je,"",0);else{const le=this.getAssociatedPath(je);le?this.#r.set(le,je):this.#d.add(je)}}catch(je){throw this.storeErr(je),this.releaseAccessHandles(),je}}))}getAssociatedPath(ie){ie.read(this.#o,{at:0});const ye=this.#g.getUint32(he);if(this.#o[0]&&(ye&P.SQLITE_OPEN_DELETEONCLOSE||(ye&ae)===0))return X(`Removing file with unexpected flags ${ye.toString(16)}`,this.#o),this.setAssociatedPath(ie,"",0),"";const Be=new Uint32Array(Oe/4);ie.read(Be,{at:Ae});const Me=this.computeDigest(this.#o,ye);if(Be.every((je,le)=>je===Me[le])){const je=this.#o.findIndex(le=>le===0);return je===0&&ie.truncate(se),je?fe.decode(this.#o.subarray(0,je)):""}else return X("Disassociating file with bad digest."),this.setAssociatedPath(ie,"",0),""}setAssociatedPath(ie,ye,Be){const Me=xe.encodeInto(ye,this.#o);Ie<=Me.written+1&&w("Path too long:",ye),ye&&Be&&(Be|=ue),this.#o.fill(0,Me.written,Ie),this.#g.setUint32(he,Be);const je=this.computeDigest(this.#o,Be);ie.write(this.#o,{at:0}),ie.write(je,{at:Ae}),ie.flush(),ye?(this.#r.set(ye,ie),this.#d.delete(ie)):(ie.truncate(se),this.#d.add(ie))}computeDigest(ie,ye){if(ye&ue){let Be=3735928559,Me=1103547991;for(const je of ie)Be=Math.imul(Be^je,2654435761),Me=Math.imul(Me^je,104729);return new Uint32Array([Be>>>0,Me>>>0])}else return new Uint32Array([0,0])}async reset(ie){await this.isReady;let ye=await navigator.storage.getDirectory(),Be;for(const Me of this.vfsDir.split("/"))Me&&(Be=ye,ye=await ye.getDirectoryHandle(Me,{create:!0}));return this.#e=ye,this.#n=Be,this.#t=await this.#e.getDirectoryHandle(Te,{create:!0}),this.releaseAccessHandles(),this.acquireAccessHandles(ie)}getPath(ie){return ne.isPtr(ie)&&(ie=ne.cstrToJs(ie)),(ie instanceof URL?ie:new URL(ie,"file://localhost/")).pathname}deletePath(ie){const ye=this.#r.get(ie);return ye&&(this.#r.delete(ie),this.setAssociatedPath(ye,"",0)),!!ye}storeErr(ie,ye){return ie&&(ie.sqlite3Rc=ye||P.SQLITE_IOERR,this.error(ie)),this.$error=ie,ye}popErr(){const ie=this.$error;return this.$error=void 0,ie}nextAvailableSAH(){const[ie]=this.#d.keys();return ie}getOFileForS3File(ie){return this.#u.get(ie)}mapS3FileToOFile(ie,ye){ye?(this.#u.set(ie,ye),W(ie,this)):(this.#u.delete(ie),W(ie,!1))}hasFilename(ie){return this.#r.has(ie)}getSAHForPath(ie){return this.#r.get(ie)}async removeVfs(){if(!this.#a.pointer||!this.#t)return!1;P.sqlite3_vfs_unregister(this.#a.pointer),this.#a.dispose(),delete S[this.vfsName];try{this.releaseAccessHandles(),await this.#e.removeEntry(Te,{recursive:!0}),this.#t=void 0,await this.#n.removeEntry(this.#e.name,{recursive:!0}),this.#e=this.#n=void 0}catch(ie){d.config.error(this.vfsName,"removeVfs() failed with no recovery strategy:",ie)}return!0}pauseVfs(){return this.#u.size>0&&d.SQLite3Error.toss(P.SQLITE_MISUSE,"Cannot pause VFS",this.vfsName,"because it has opened files."),this.#i.size>0&&(P.sqlite3_vfs_unregister(this.vfsName),this.releaseAccessHandles()),this}isPaused(){return this.#i.size===0}async unpauseVfs(){return this.#i.size===0?this.acquireAccessHandles(!1).then(()=>P.sqlite3_vfs_register(this.#a,0),this):this}exportFile(ie){const ye=this.#r.get(ie)||w("File not found:",ie),Be=ye.getSize()-se,Me=new Uint8Array(Be>0?Be:0);if(Be>0){const je=ye.read(Me,{at:se});je!=Be&&w("Expected to read "+Be+" bytes but read "+je+".")}return Me}async importDbChunked(ie,ye){const Be=this.#r.get(ie)||this.nextAvailableSAH()||w("No available handles to import to.");Be.truncate(0);let Me=0,je,le=!1;try{for(;(je=await ye())!==void 0;)je instanceof ArrayBuffer&&(je=new Uint8Array(je)),Me===0&&je.byteLength>=15&&(J.affirmDbHeader(je),le=!0),Be.write(je,{at:se+Me}),Me+=je.byteLength;if((Me<512||Me%512!==0)&&w("Input size",Me,"is not correct for an SQLite database."),!le){const Se=new Uint8Array(20);Be.read(Se,{at:0}),J.affirmDbHeader(Se)}Be.write(new Uint8Array([1,1]),{at:se+18})}catch(Se){throw this.setAssociatedPath(Be,"",0),Se}return this.setAssociatedPath(Be,ie,P.SQLITE_OPEN_MAIN_DB),Me}importDb(ie,ye){if(ye instanceof ArrayBuffer)ye=new Uint8Array(ye);else if(ye instanceof Function)return this.importDbChunked(ie,ye);const Be=this.#r.get(ie)||this.nextAvailableSAH()||w("No available handles to import to."),Me=ye.byteLength;(Me<512||Me%512!=0)&&w("Byte array size is invalid for an SQLite db.");const je="SQLite format 3";for(let Se=0;Se<je.length;++Se)je.charCodeAt(Se)!==ye[Se]&&w("Input does not contain an SQLite database header.");const le=Be.write(ye,{at:se});return le!=Me?(this.setAssociatedPath(Be,"",0),w("Expected to write "+Me+" bytes but wrote "+le+".")):(Be.write(new Uint8Array([1,1]),{at:se+18}),this.setAssociatedPath(Be,ie,P.SQLITE_OPEN_MAIN_DB)),le}}class it{#e;constructor(ie){this.#e=ie,this.vfsName=ie.vfsName}async addCapacity(ie){return this.#e.addCapacity(ie)}async reduceCapacity(ie){return this.#e.reduceCapacity(ie)}getCapacity(){return this.#e.getCapacity(this.#e)}getFileCount(){return this.#e.getFileCount()}getFileNames(){return this.#e.getFileNames()}async reserveMinimumCapacity(ie){const ye=this.#e.getCapacity();return ye<ie?this.#e.addCapacity(ie-ye):ye}exportFile(ie){return this.#e.exportFile(ie)}importDb(ie,ye){return this.#e.importDb(ie,ye)}async wipeFiles(){return this.#e.reset(!0)}unlink(ie){return this.#e.deletePath(ie)}async removeVfs(){return this.#e.removeVfs()}pauseVfs(){return this.#e.pauseVfs(),this}async unpauseVfs(){return this.#e.unpauseVfs().then(()=>this)}isPaused(){return this.#e.isPaused()}}const ct=async()=>{const Re=await navigator.storage.getDirectory(),ie=".opfs-sahpool-sync-check-"+ve(),Me=(await(await Re.getFileHandle(ie,{create:!0})).createSyncAccessHandle()).close();return await Me,await Re.removeEntry(ie),Me?.then&&w("The local OPFS API is too old for opfs-sahpool:","it has an async FileSystemSyncAccessHandle.close() method."),!0};d.installOpfsSAHPoolVfs=async function(Re=Object.create(null)){Re=Object.assign(Object.create(null),He,Re||{});const ie=Re.name;if(Re.$testThrowPhase1)throw Re.$testThrowPhase1;if(S[ie])try{return await S[ie]}catch(ye){if(Re.forceReinitIfPreviouslyFailed)delete S[ie];else throw ye}return!globalThis.FileSystemHandle||!globalThis.FileSystemDirectoryHandle||!globalThis.FileSystemFileHandle||!globalThis.FileSystemFileHandle.prototype.createSyncAccessHandle||!navigator?.storage?.getDirectory?S[ie]=Promise.reject(new Error("Missing required OPFS APIs.")):S[ie]=ct().then(async function(){if(Re.$testThrowPhase2)throw Re.$testThrowPhase2;const ye=new Xe(Re);return ye.isReady.then(async()=>{const Be=new it(ye);if(d.oo1){const Me=d.oo1,je=ye.getVfs(),le=function(...Se){const Ce=Me.DB.dbCtorHelper.normalizeArgs(...Se);Ce.vfs=je.$zName,Me.DB.dbCtorHelper.call(this,Ce)};le.prototype=Object.create(Me.DB.prototype),Be.OpfsSAHPoolDb=le}return ye.log("VFS initialized."),Be}).catch(async Be=>{throw await ye.removeVfs().catch(()=>{}),Be})}).catch(ye=>S[ie]=Promise.reject(ye))}}),typeof n<"u"){const d=Object.assign(Object.create(null),{exports:typeof ee>"u"?n.asm:ee,memory:n.wasmMemory},globalThis.sqlite3ApiConfig||{});globalThis.sqlite3ApiConfig=d;let w;try{w=globalThis.sqlite3ApiBootstrap()}catch(E){throw console.error("sqlite3ApiBootstrap() error:",E),E}finally{delete globalThis.sqlite3ApiBootstrap,delete globalThis.sqlite3ApiConfig}n.sqlite3=w}else console.warn("This is not running in an Emscripten module context, so","globalThis.sqlite3ApiBootstrap() is _not_ being called due to lack","of config info for the WASM environment.","It must be called manually.")},t=o,t}})();const dQ=(function(){const r=dm;if(!r)throw new Error("Expecting globalThis.sqlite3InitModule to be defined by the Emscripten build.");const e=globalThis.sqlite3InitModuleState=Object.assign(Object.create(null),{moduleScript:globalThis?.document?.currentScript,isWorker:typeof WorkerGlobalScope<"u",location:globalThis.location,urlParams:globalThis?.location?.href?new URL(globalThis.location.href).searchParams:new URLSearchParams});if(e.debugModule=e.urlParams.has("sqlite3.debugModule")?(...t)=>console.warn("sqlite3.debugModule:",...t):()=>{},e.urlParams.has("sqlite3.dir"))e.sqlite3Dir=e.urlParams.get("sqlite3.dir")+"/";else if(e.moduleScript){const t=e.moduleScript.src.split("/");t.pop(),e.sqlite3Dir=t.join("/")+"/"}if(globalThis.sqlite3InitModule=function t(...n){return r(...n).then(s=>{s.runSQLite3PostLoadInit(s);const i=s.sqlite3;i.scriptInfo=e,t.__isUnderTest&&(i.__isUnderTest=!0);const o=i.asyncPostInit;return delete i.asyncPostInit,o()}).catch(s=>{throw console.error("Exception loading sqlite3 module:",s),s})},globalThis.sqlite3InitModule.ready=r.ready,globalThis.sqlite3InitModuleState.moduleScript){const t=globalThis.sqlite3InitModuleState;let n=t.moduleScript.src.split("/");n.pop(),t.scriptDir=n.join("/")+"/"}return e.debugModule("sqlite3InitModuleState =",e),globalThis.sqlite3InitModule})();dm=dQ;var hQ=dm;globalThis.sqlite3Worker1Promiser=function r(e=r.defaultConfig){if(arguments.length===1&&typeof arguments[0]=="function"){const f=e;e=Object.assign(Object.create(null),r.defaultConfig),e.onready=f}else e=Object.assign(Object.create(null),r.defaultConfig,e);const t=Object.create(null),n=function(){},s=e.onerror||n,i=e.debug||n,o=e.generateMessageId?void 0:Object.create(null),a=e.generateMessageId||function(f){return f.type+"#"+(o[f.type]=(o[f.type]||0)+1)},c=(...f)=>{throw new Error(f.join(" "))};e.worker||(e.worker=r.defaultConfig.worker),typeof e.worker=="function"&&(e.worker=e.worker());let l,h;return e.worker.onmessage=function(f){f=f.data,i("worker1.onmessage",f);let p=t[f.messageId];if(!p){if(f&&f.type==="sqlite3-api"&&f.result==="worker1-ready"){e.onready&&e.onready(h);return}if(p=t[f.type],p&&p.onrow){p.onrow(f);return}e.onunhandled?e.onunhandled(arguments[0]):s("sqlite3Worker1Promiser() unhandled worker message:",f);return}switch(delete t[f.messageId],f.type){case"error":p.reject(f);return;case"open":l||(l=f.dbId);break;case"close":f.dbId===l&&(l=void 0);break}try{p.resolve(f)}catch(m){p.reject(m)}},h=function(){let f;arguments.length===1?f=arguments[0]:arguments.length===2?(f=Object.create(null),f.type=arguments[0],f.args=arguments[1],f.dbId=f.args.dbId):c("Invalid arguments for sqlite3Worker1Promiser()-created factory."),!f.dbId&&f.type!=="open"&&(f.dbId=l),f.messageId=a(f),f.departureTime=performance.now();const p=Object.create(null);p.message=f;let m;f.type==="exec"&&f.args&&(typeof f.args.callback=="function"?(m=f.messageId+":row",p.onrow=f.args.callback,f.args.callback=m,t[m]=p):typeof f.args.callback=="string"&&c("exec callback may not be a string when using the Promise interface."));let _=new Promise(function(R,T){p.resolve=R,p.reject=T,t[f.messageId]=p,i("Posting",f.type,"message to Worker dbId="+(l||"default")+":",f),e.worker.postMessage(f)});return m&&(_=_.finally(()=>delete t[m])),_}};globalThis.sqlite3Worker1Promiser.defaultConfig={worker:function(){return new Worker(new URL(""+new URL("sqlite3-worker1-bundler-friendly-DFI4ojj0.js",import.meta.url).href,import.meta.url),{type:"module"})},onerror:(...r)=>console.error("worker1 promiser error",...r)};sqlite3Worker1Promiser.v2=(function(r){let e;typeof r=="function"?(e=r,r={}):typeof r?.onready=="function"&&(e=r.onready,delete r.onready);const t=Object.create(null);r=Object.assign(r||Object.create(null),{onready:async function(s){try{e&&await e(s),t.resolve(s)}catch(i){t.reject(i)}}});const n=new Promise(function(s,i){t.resolve=s,t.reject=i});try{this.original(r)}catch(s){t.reject(s)}return n}).bind({original:sqlite3Worker1Promiser});sqlite3Worker1Promiser.v2;class hm{db;constructor(e){this.db=e}static async create(e="basilisk.db"){const t=await hQ();console.debug("[database] Initializing database...");let n,s="unknown";try{console.debug("[database] Trying OPFS SAH..."),await t.installOpfsSAHPoolVfs({name:"opfs-sahpool"}),n=new t.oo1.DB(`file:${e}?vfs=opfs-sahpool`,"cw"),s="[database] OPFS SAH (SharedArrayBuffer)"}catch(i){console.debug("[database] OPFS SAH not available:",i);try{console.debug("[database] Trying default OPFS..."),n=new t.oo1.DB(`file:${e}?vfs=unix-dotfile`,"cw"),s="[database] OPFS (unix-dotfile)"}catch{console.debug("[database] unix-dotfile failed, trying IndexedDB...");try{n=new t.oo1.DB(`:${e}:`,"c"),s="[database] IndexedDB (kvvfs)"}catch(a){console.error("[database] All storage methods failed:",a),n=new t.oo1.DB(":memory:","c"),s="[database] Memory (volatile)",console.warn("[database] âš ï¸ Using in-memory database - data will NOT persist!")}}}return console.debug("[database] Database initialized"),console.debug("[database] Storage type:",s),console.debug("[database] Database path:",n.filename),new hm(n)}async run(e,t){return this.db.exec(e,{bind:t}),this.db.changes()}async get(e,t){return this.db.selectObject(e,t)}async all(e,t){return this.db.selectObjects(e,t)}async close(){this.db.close()}}let Uc;self.onmessage=async r=>{if(console.debug("[worker] Message sent to node:",r.data),r.data.type==="start-node"){if(Uc)return;const e=await hm.create();Uc=await fm.init(e,t=>{console.debug("[worker] Message sent to UI:",t),self.postMessage(t)},"/dns4/basilisk.ddns.net/tcp/443/wss/p2p/12D3KooWSg6rbGzQbYnPCGBoz5JMbLT2AnDNCMWcRWXGvNeYGaLW"),await Uc.startNode()}else Uc&&await Uc.handleUiCommand(r.data)};
